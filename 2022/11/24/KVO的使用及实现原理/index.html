<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"xq-120.github.io","root":"/","scheme":"Pisces","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="KVO使用KVO,观察者与被观察者.被观察者添加某个观察者,观察自身某一属性的变化.当被观察者的属性值发生变化时,被观察者会直接将变化发送给观察者 (通过给观察者发送observeValueForKeyPath:消息),这也是和通知差别比较大的地方. 1.观察者需要实现observeValueForKeyPath:方法,并在该方法中做出相应行为.如果观察者没有实现observeValueForKe">
<meta property="og:type" content="article">
<meta property="og:title" content="KVO的使用及实现原理">
<meta property="og:url" content="https://xq-120.github.io/2022/11/24/KVO%E7%9A%84%E4%BD%BF%E7%94%A8%E5%8F%8A%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/index.html">
<meta property="og:site_name" content="芝士就是力量">
<meta property="og:description" content="KVO使用KVO,观察者与被观察者.被观察者添加某个观察者,观察自身某一属性的变化.当被观察者的属性值发生变化时,被观察者会直接将变化发送给观察者 (通过给观察者发送observeValueForKeyPath:消息),这也是和通知差别比较大的地方. 1.观察者需要实现observeValueForKeyPath:方法,并在该方法中做出相应行为.如果观察者没有实现observeValueForKe">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-11-24T08:32:33.000Z">
<meta property="article:modified_time" content="2024-12-14T07:50:26.474Z">
<meta property="article:author" content="jekyttt">
<meta property="article:tag" content="KVO">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://xq-120.github.io/2022/11/24/KVO%E7%9A%84%E4%BD%BF%E7%94%A8%E5%8F%8A%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>KVO的使用及实现原理 | 芝士就是力量</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="芝士就是力量" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">芝士就是力量</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">像风一样自由</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/xq-120/xq-120.github.io" class="github-corner" title="XQ on GitHub" aria-label="XQ on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://xq-120.github.io/2022/11/24/KVO%E7%9A%84%E4%BD%BF%E7%94%A8%E5%8F%8A%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="jekyttt">
      <meta itemprop="description" content="涉猎的编程语言为Objective-C、Swift、C,主要领域为iOS开发.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="芝士就是力量">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          KVO的使用及实现原理
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-11-24 16:32:33" itemprop="dateCreated datePublished" datetime="2022-11-24T16:32:33+08:00">2022-11-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-12-14 15:50:26" itemprop="dateModified" datetime="2024-12-14T15:50:26+08:00">2024-12-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OC/" itemprop="url" rel="index"><span itemprop="name">OC</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="KVO使用"><a href="#KVO使用" class="headerlink" title="KVO使用"></a>KVO使用</h2><p>KVO,观察者与被观察者.被观察者添加某个观察者,观察自身某一属性的变化.当被观察者的属性值发生变化时,被观察者会直接将变化发送给观察者 (通过给观察者发送observeValueForKeyPath:消息),这也是和通知差别比较大的地方.</p>
<p>1.观察者需要实现observeValueForKeyPath:方法,并在该方法中做出相应行为.如果观察者没有实现observeValueForKeyPath:方法,且其父类也没有实现，那么最终会走到NSObject的实现，而NSObject的默认实现就是崩溃:An -observeValueForKeyPath:ofObject:change:context: message was received but not handled.如果观察者本身没有实现observeValueForKeyPath:…方法,但是其父类实现了,那么执行的就是父类的实现,这也是消息的传递过程.</p>
<p>2.[super observeValueForKeyPath:]</p>
<p>对于网上一种写法:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="type">id</span>)object</span><br><span class="line">change:(<span class="built_in">NSDictionary</span> *)change context:(<span class="type">void</span> *)context</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (object == _tableView &amp;&amp; [keyPath isEqualToString:<span class="string">@&quot;contentOffset&quot;</span>]) &#123;</span><br><span class="line">      [<span class="keyword">self</span> doSomethingWhenContentOffsetChanges];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      [<span class="variable language_">super</span> observeValueForKeyPath:keyPath ofObject:object change:change context:context];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里首先要清楚[super method]的作用,[super method]表示的是去执行父类里的实现,消息的接收者还是子类对象本身.并不是说消息的接收者变成了一个父类对象在执行该方法.完整的写法确实应该在else处添加super调用。但由于这种场景很少出现，所以很少有人特意去调super，一般也不会出问题。</p>
<p>3.KVO的context参数取值</p>
<p>context参数虽然可以传入任意值,但如果传入的是一个对象,则必须保证在KVO期间该对象不会被销毁.否则在observeValueForKeyPath方法中将导致野指针访问崩溃.可以传入一些常量比如字符串常量,或类对象.</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span>.people addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@&quot;age&quot;</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionOld</span> context:(__bridge <span class="type">void</span> * _Nullable)(<span class="keyword">self</span>.class)];</span><br><span class="line"></span><br><span class="line">[<span class="keyword">self</span>.people addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@&quot;age&quot;</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionOld</span> context:<span class="string">@&quot;mycontext&quot;</span>];</span><br></pre></td></tr></table></figure>
<p> 不应该传入一个临时对象比如</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span>.people addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@&quot;age&quot;</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionOld</span> context:(__bridge <span class="type">void</span> * _Nullable)([<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;%@&quot;</span>, <span class="built_in">NSStringFromClass</span>(<span class="keyword">self</span>.class)])];</span><br></pre></td></tr></table></figure>
<p>4.removeObserver:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)removeObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath context:(<span class="keyword">nullable</span> <span class="type">void</span> *)context API_AVAILABLE(macos(<span class="number">10.7</span>), ios(<span class="number">5.0</span>), watchos(<span class="number">2.0</span>), tvos(<span class="number">9.0</span>));</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)removeObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br></pre></td></tr></table></figure>
<p>作用都是移除观察者. 使用带context的移除方法,可以让你精细控制移除指定场景下的观察者.</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)removeObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath context:(<span class="keyword">nullable</span> <span class="type">void</span> *)context <span class="built_in">NS_AVAILABLE</span>(<span class="number">10</span>_7, <span class="number">5</span>_0);</span><br></pre></td></tr></table></figure>
<p>官方说明:<br>You should use -removeObserver:forKeyPath:context: instead of -removeObserver:forKeyPath: whenever possible because it allows you to more precisely specify your intent. When the same observer is registered for the same key path multiple times, but with different context pointers each time, -removeObserver:forKeyPath: has to guess at the context pointer when deciding what exactly to remove, and it can guess wrong.<br>也就是说当一个对象多次注册观察同一个key path但context不同时,那么使用带context的方法可以让你精确的移除某个context下的观察,而另一个继续工作.</p>
<p>5.KVO坑</p>
<p>5.1 KVO的addObserver和removeObserver要配对使用,否则导致崩溃.</p>
<p>5.1.1 添加次数&gt;移除次数。</p>
<p>常见的是添加了而不调用移除.这种情况崩溃需要一定的条件触发：观察者先于被观察者销毁，被观察者的属性再发生改变。<br>A添加了B作为观察者，B先于A销毁，B销毁时需要将B从观察者列表中移除。如果不移除,当被观察者的属性发生改变时,系统依然会给这个已销毁的观察者发送observeValueForKeyPath消息,从而导致野指针崩溃.内部实现估计是unsafe_unretain引用。</p>
<p>5.1.2 添加次数&lt;移除次数。</p>
<p>常见的是没有添加却调用移除.这种情况是马上崩溃。<br>如果B不是A的观察者,那么A就不能去removeObserver:B.否则崩溃:Cannot remove an observer <Student 0x60800001a020> for the key path “highlighted” from <UIButton 0x7fc29341f300> because it is not registered as an observer.<br>看起来是废话,但确实有可能发生,比如B之前是A的观察者,后来A removeObserver:B,此时B就不再是A的观察者,如果后面A又removeObserver:B的话,就会导致崩溃.还有一种场景就是B还没注册成为A的观察者时,B就先销毁了,而B的dealloc里有移除操作，这个更有可能发生.</p>
<p>6.重复注册</p>
<p>子类SecondViewController的viewDidLoad里addObserver：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span>.people addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@&quot;name&quot;</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionOld</span> context:<span class="literal">NULL</span>];</span><br></pre></td></tr></table></figure>
<p>父类BaseViewController的viewDidLoad里也addObserver:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span>.people addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@&quot;name&quot;</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionOld</span> context:<span class="literal">NULL</span>];</span><br></pre></td></tr></table></figure>
<p>因为SecondViewController实例注册了两次.当people的name发生变化,系统会调用SecondViewController实例的observeValueForKeyPath方法两次.由于注册了两次，在不需要观察时也要移除两次。</p>
<h2 id="KVO实现原理"><a href="#KVO实现原理" class="headerlink" title="KVO实现原理"></a>KVO实现原理</h2><p>测试代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Tree</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> age;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)ageVarChanger:(<span class="built_in">NSInteger</span>)age;</span><br><span class="line"></span><br><span class="line">+ (<span class="type">void</span>)someClassMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) Tree *tree;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)addKVO &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;add前，class:%@, superClass:%@, setAge:%p&quot;</span>, object_getClass(<span class="keyword">self</span>.tree), class_getSuperclass(object_getClass(<span class="keyword">self</span>.tree)), [<span class="keyword">self</span>.tree methodForSelector:<span class="keyword">@selector</span>(setAge:)]);</span><br><span class="line">    [<span class="keyword">self</span> printObjectInstanceMethod:object_getClass(<span class="keyword">self</span>.tree)];</span><br><span class="line">    [<span class="keyword">self</span> printObjectClassMethod:object_getClass(<span class="keyword">self</span>.tree)];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.tree addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@&quot;age&quot;</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionOld</span> context:<span class="literal">NULL</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;add后，class:%@, superClass:%@, setAge:%p&quot;</span>, object_getClass(<span class="keyword">self</span>.tree), class_getSuperclass(object_getClass(<span class="keyword">self</span>.tree)), [<span class="keyword">self</span>.tree methodForSelector:<span class="keyword">@selector</span>(setAge:)]);</span><br><span class="line">    [<span class="keyword">self</span> printObjectInstanceMethod:object_getClass(<span class="keyword">self</span>.tree)];</span><br><span class="line">    [<span class="keyword">self</span> printObjectClassMethod:object_getClass(<span class="keyword">self</span>.tree)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打印：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">329809</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] add前，class:Tree, superClass:NSObject, setAge:<span class="number">0</span>x102fa76fc</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">329868</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] 实例方法,ageVarChanger:</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">329908</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] 实例方法,age</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">329947</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] 实例方法,setAge:</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">329977</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] 实例方法,name</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">330008</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] 实例方法,setName:</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">330037</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] 实例方法,.cxx_destruct</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">330076</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] 类方法,someClassMethod</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">330198</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] add后，class:NSKVONotifying_Tree, superClass:Tree, setAge:<span class="number">0</span>x180b5ff00</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">330235</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] 实例方法,setAge:</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">330268</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] 实例方法,class</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">330300</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] 实例方法,dealloc</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">330330</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] 实例方法,_isKVOA</span><br></pre></td></tr></table></figure>
<p>可以看到对象添加观察者后，对象tree的isa指针指向的是类NSKVONotifying_Tree，而不是Tree。并且setAge:方法的实现也变了。NSKVONotifying_Tree是Tree的子类，并且重写了setAge:。</p>
<p>举个运行时创建类的例子：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="variable language_">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    _obj = [ARCPerson new];</span><br><span class="line">    </span><br><span class="line">    Class newClass = objc_allocateClassPair([<span class="built_in">NSString</span> <span class="keyword">class</span>],</span><br><span class="line">    <span class="string">&quot;NSStringSubclass&quot;</span>, <span class="number">0</span>);</span><br><span class="line">     class_addMethod(newClass, <span class="keyword">@selector</span>(report), (IMP)ReportFunction, <span class="string">&quot;v@:&quot;</span>); objc_registerClassPair(newClass);</span><br><span class="line">    <span class="type">id</span> instanceOfNewClass = [[newClass alloc] init];</span><br><span class="line">     [instanceOfNewClass performSelector:<span class="keyword">@selector</span>(report)];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> ReportFunction(<span class="type">id</span> <span class="keyword">self</span>, SEL _cmd) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot; &gt;&gt; This object is %p.&quot;</span>, <span class="keyword">self</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot; &gt;&gt; Class is %@, and super is %@.&quot;</span>, [<span class="keyword">self</span> <span class="keyword">class</span>], [<span class="keyword">self</span> superclass]);</span><br><span class="line">    Class prevClass = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> count = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (Class currentClass = [<span class="keyword">self</span> <span class="keyword">class</span>]; currentClass; ++count) &#123;</span><br><span class="line">        prevClass = currentClass;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot; &gt;&gt; Following the isa pointer %d times gives %p&quot;</span>, count, currentClass);</span><br><span class="line">        currentClass = object_getClass(currentClass);</span><br><span class="line">        <span class="keyword">if</span> (prevClass == currentClass)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot; &gt;&gt; NSObject&#x27;s class is %p&quot;</span>, [<span class="built_in">NSObject</span> <span class="keyword">class</span>]);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot; &gt;&gt; NSObject&#x27;s meta class is %p&quot;</span>, object_getClass([<span class="built_in">NSObject</span> <span class="keyword">class</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="安全的使用KVO"><a href="#安全的使用KVO" class="headerlink" title="安全的使用KVO"></a>安全的使用KVO</h2><p>前面分析了KVO的使用添加和移除次数必须匹配，否则很容易崩溃。但是在日常使用中有时还是会出现不匹配的情况，有没有可能从技术层面完全避免呢？有，答案就是Facebook开源的KVOController。KVOController在我看来有下面几个优势：</p>
<ol>
<li>API更加现代，使用更加方便。提供block和selector，不仅如此竟然还支持在原生方法里处理。</li>
<li>线程安全。</li>
<li>可以避免添加和移除次数不匹配的问题。</li>
<li>观察者销毁时自动被移除（如果需要）。</li>
</ol>
<p>缺点：</p>
<ol>
<li>不支持设置多个context。</li>
<li>其他一些偏门场景可能会有问题。</li>
</ol>
<p>如果你不想用KVOController，也有两个简单的方法：</p>
<ol>
<li>自己定义一个标志位，添加了设置为true，移除时先判断是不是添加了，添加了才移除。</li>
<li>使用try-catch包裹移除方法。</li>
</ol>
<p>相较起来还是KVOController更牛逼。不过封装本身就是越封装使用越方便，但功能细节也丢失得越多。看情况使用吧。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ol>
<li><p>中间类是什么时候生成的？是在编译期间生成还是运行时生成？</p>
<p>运行时生成。</p>
<p>p1对象执行过addObserver操作之后，p1对象的isa指针由之前的指向类对象Person变为指向NSKVONotifyin_Person类对象，而p2对象没有任何改变。也就是说一旦p1对象添加了KVO监听以后，其isa指针就会发生变化，因此set方法的执行效果就不一样了。</p>
<p>当一个对象使用了KVO监听，iOS系统会修改这个对象的isa指针，改为指向一个全新的通过Runtime动态创建的子类，子类拥有自己的set方法实现，set方法实现内部会顺序调用<strong>willChangeValueForKey方法、原来的setter方法实现、didChangeValueForKey方法，而didChangeValueForKey方法内部又会调用监听器的observeValueForKeyPath:ofObject:change:context:监听方法。</strong></p>
</li>
<li><p>中间类和原类的关系？</p>
<p>生成的中间类NSKVONotifyin_Person是原类Person的子类，并且重写了setAge:，class方法。重写class方法，可以让外部以为使用的还是原类，这样就隐藏了实现细节。当给对象发送其他消息时，由于NSKVONotifyin_Person是Person的子类，而NSKVONotifyin_Person又没有重写这些方法，所以会执行到父类的实现，非常的完美。</p>
</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903593925935117">iOS底层原理总结 - 探寻KVO本质</a></p>

    </div>

    
    
    
        <div class="reward-container">
  <div>觉得文章有帮助可以打赏一下哦！</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.jpg" alt="jekyttt 微信支付">
        <p>微信支付</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/KVO/" rel="tag"># KVO</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/10/17/%E5%B7%A6%E7%A7%BB%E4%B8%8E%E5%8F%B3%E7%A7%BB/" rel="prev" title="左移与右移">
      <i class="fa fa-chevron-left"></i> 左移与右移
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/12/17/openssl%E4%BD%BF%E7%94%A8/" rel="next" title="openssl使用">
      openssl使用 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#KVO%E4%BD%BF%E7%94%A8"><span class="nav-text">KVO使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#KVO%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="nav-text">KVO实现原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E7%9A%84%E4%BD%BF%E7%94%A8KVO"><span class="nav-text">安全的使用KVO</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98"><span class="nav-text">问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-text">参考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">jekyttt</p>
  <div class="site-description" itemprop="description">涉猎的编程语言为Objective-C、Swift、C,主要领域为iOS开发.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">176</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">38</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">116</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/xq-120" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xq-120" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/yourname" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;yourname" rel="noopener" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-fw fa-rss"></i></a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jekyttt</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v7.3.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.7.2
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.getAttribute('pjax') !== null) {
      script.setAttribute('pjax', '');
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="/js/local-search.js"></script>













    <div id="pjax">
  

  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'dc6a52837746ef605a70',
      clientSecret: '7a049bac8b7eef61e32ebcbfcc33ea9d670d3274',
      repo        : 'commentForBlog',
      owner       : 'xq-120',
      admin       : ['xq-120'],
      id          : '70394d33e629e16c70bee3f9fc1f9b97',
        language: 'en, zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

    </div>
</body>
</html>
