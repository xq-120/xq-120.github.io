<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Hello World</title>
    <url>/2024/12/14/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
  </entry>
  <entry>
    <title>homebrewä»‹ç»</title>
    <url>/2024/02/09/homebrew%E4%BB%8B%E7%BB%8D/</url>
    <content><![CDATA[<h2 id="homebrewç®€ä»‹"><a href="#homebrewç®€ä»‹" class="headerlink" title="homebrewç®€ä»‹"></a>homebrewç®€ä»‹</h2><p>homebrewç±»ä¼¼äºQQè½¯ä»¶ç®¡å®¶ï¼Œæ–¹ä¾¿æˆ‘ä»¬å®‰è£…å¸è½½ç¬¬ä¸‰æ–¹è½¯ä»¶ã€‚å½“ç„¶è¿™é‡Œçš„è½¯ä»¶æŒ‡çš„æ˜¯å‘½ä»¤è¡Œè½¯ä»¶ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬é€šå¸¸ä½¿ç”¨çš„å›¾å½¢ç•Œé¢åº”ç”¨è½¯ä»¶ã€‚</p>
<h2 id="å®‰è£…homebrew"><a href="#å®‰è£…homebrew" class="headerlink" title="å®‰è£…homebrew"></a>å®‰è£…homebrew</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/bin/bash -c <span class="string">&quot;<span class="subst">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)</span>&quot;</span></span><br></pre></td></tr></table></figure>
<p>Homebrew ä¼šå°†è½¯ä»¶åŒ…å®‰è£…åˆ°ç‹¬ç«‹ç›®å½•ï¼ŒHomebrew ä¸ä¼šå°†æ–‡ä»¶å®‰è£…åˆ°å®ƒæœ¬èº«ç›®å½•ä¹‹å¤–ï¼Œæ‰€ä»¥æ‚¨å¯å°† Homebrew å®‰è£…åˆ°ä»»æ„ä½ç½®ï¼Œé»˜è®¤æ˜¯å®‰è£…åœ¨:</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">/opt/</span>homebrew/Cellar</span><br><span class="line"></span><br><span class="line">eg:</span><br><span class="line"><span class="regexp">/opt/</span>homebrew<span class="regexp">/Cellar/</span>openssl@<span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>ï¼Œå¹¶å°†å…¶æ–‡ä»¶è½¯é“¾æ¥è‡³ <code>/opt/homebrew/opt/</code> ã€‚è¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶åˆ™æ˜¯Cellarä¸‹å¯¹åº”è½¯ä»¶çš„ä¸€ä¸ªè½¯è¿æ¥ã€‚</p>
<h2 id="homebrewä½¿ç”¨"><a href="#homebrewä½¿ç”¨" class="headerlink" title="homebrewä½¿ç”¨"></a>homebrewä½¿ç”¨</h2><h3 id="1-å®‰è£…è½¯ä»¶"><a href="#1-å®‰è£…è½¯ä»¶" class="headerlink" title="1.å®‰è£…è½¯ä»¶"></a>1.å®‰è£…è½¯ä»¶</h3><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line"><span class="keyword">brew </span><span class="keyword">install </span>xxx</span><br></pre></td></tr></table></figure>
<p>eg:</p>
<figure class="highlight clean"><table><tr><td class="code"><pre><span class="line">âœ  ~ brew install wget</span><br><span class="line">==&gt; Downloading https:<span class="comment">//formulae.brew.sh/api/formula.jws.json</span></span><br><span class="line">######################################################################### <span class="number">100.0</span>%</span><br><span class="line">==&gt; Downloading https:<span class="comment">//formulae.brew.sh/api/cask.jws.json</span></span><br><span class="line">######################################################################### <span class="number">100.0</span>%</span><br><span class="line">==&gt; Downloading https:<span class="comment">//ghcr.io/v2/homebrew/core/wget/manifests/1.21.4</span></span><br><span class="line">######################################################################### <span class="number">100.0</span>%</span><br><span class="line">==&gt; Fetching wget</span><br><span class="line">==&gt; Downloading https:<span class="comment">//ghcr.io/v2/homebrew/core/wget/blobs/sha256:3def758612b33</span></span><br><span class="line">######################################################################### <span class="number">100.0</span>%</span><br><span class="line">==&gt; Pouring wget-<span class="number">-1.21</span><span class="number">.4</span>.sonoma.bottle.tar.gz</span><br><span class="line">ğŸº  /usr/local/Cellar/wget/<span class="number">1.21</span><span class="number">.4</span>: <span class="number">91</span> files, <span class="number">4.4</span>MB</span><br><span class="line">==&gt; Running `brew cleanup wget`...</span><br><span class="line">Disable this behaviour by setting HOMEBREW_NO_INSTALL_CLEANUP.</span><br><span class="line">Hide these hints <span class="keyword">with</span> HOMEBREW_NO_ENV_HINTS (see `man brew`).</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">âœ  ~ wget -V</span><br><span class="line">GNU Wget <span class="number">1.21</span><span class="number">.4</span> åœ¨ darwin23<span class="number">.0</span><span class="number">.0</span> ä¸Šç¼–è¯‘ã€‚</span><br></pre></td></tr></table></figure>
<h3 id="2-å¸è½½è½¯ä»¶"><a href="#2-å¸è½½è½¯ä»¶" class="headerlink" title="2.å¸è½½è½¯ä»¶"></a>2.å¸è½½è½¯ä»¶</h3><figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">brew uninstall xxx</span></span><br></pre></td></tr></table></figure>
<h3 id="3-brew-list-æŸ¥çœ‹ä½¿ç”¨homebrewå®‰è£…çš„äºŒè¿›åˆ¶è½¯ä»¶"><a href="#3-brew-list-æŸ¥çœ‹ä½¿ç”¨homebrewå®‰è£…çš„äºŒè¿›åˆ¶è½¯ä»¶" class="headerlink" title="3.brew list-æŸ¥çœ‹ä½¿ç”¨homebrewå®‰è£…çš„äºŒè¿›åˆ¶è½¯ä»¶"></a>3.brew list-æŸ¥çœ‹ä½¿ç”¨homebrewå®‰è£…çš„äºŒè¿›åˆ¶è½¯ä»¶</h3><figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">brew list</span></span><br></pre></td></tr></table></figure>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line">brew list</span><br><span class="line"><span class="operator">=</span><span class="operator">=</span>&gt; Formulae</span><br><span class="line">abseil		gettext		libunistring	openssl<span class="title">@3</span>	sqlite</span><br><span class="line">brotli		icu<span class="number">4</span><span class="keyword">c</span>		libuv		protobuf	swift-protobuf</span><br><span class="line"><span class="keyword">c</span>-ares		inetutils	libyaml		python<span class="title">@3</span>.<span class="number">11</span>	telnet</span><br><span class="line">ca-certificates	libidn<span class="number">2</span>		mpdecimal	readline	wget</span><br><span class="line">cocoapods	libnghttp<span class="number">2</span>	nvm		ruby		xz</span><br></pre></td></tr></table></figure>
<h3 id="4-brew-update-å‡çº§homebrewè‡ªèº«"><a href="#4-brew-update-å‡çº§homebrewè‡ªèº«" class="headerlink" title="4.brew update-å‡çº§homebrewè‡ªèº«"></a>4.brew update-å‡çº§homebrewè‡ªèº«</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">brew <span class="keyword">update</span> <span class="comment">--verbose</span></span><br></pre></td></tr></table></figure>
<h3 id="5-brew-upgrade-å‡çº§å®‰è£…çš„äºŒè¿›åˆ¶è½¯ä»¶"><a href="#5-brew-upgrade-å‡çº§å®‰è£…çš„äºŒè¿›åˆ¶è½¯ä»¶" class="headerlink" title="5.brew upgrade-å‡çº§å®‰è£…çš„äºŒè¿›åˆ¶è½¯ä»¶"></a>5.brew upgrade-å‡çº§å®‰è£…çš„äºŒè¿›åˆ¶è½¯ä»¶</h3><figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">brew upgrade xxx</span></span><br></pre></td></tr></table></figure>
<p>eg:</p>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">brew upgrade cocoapods</span></span><br></pre></td></tr></table></figure>
<h3 id="6-brew-search-æœç´¢åŒ…"><a href="#6-brew-search-æœç´¢åŒ…" class="headerlink" title="6.brew search-æœç´¢åŒ…"></a>6.brew search-æœç´¢åŒ…</h3><p>æœç´¢å¯ä»¥å®‰è£…çš„åŒ…ï¼Œå¯ä»¥å¤§è‡´æŸ¥çœ‹å…¶æœ€æ–°çš„ç‰ˆæœ¬ï¼ˆå¯èƒ½æœ‰å»¶è¿Ÿï¼Œæœ€æ–°çš„åº”è¯¥å»å®˜ç½‘æŸ¥çœ‹ï¼‰ã€‚</p>
<h2 id="å‘"><a href="#å‘" class="headerlink" title="å‘"></a>å‘</h2><h3 id="1-å®‰è£…äº†ä¸¤ä¸ªhomebrew"><a href="#1-å®‰è£…äº†ä¸¤ä¸ªhomebrew" class="headerlink" title="1.å®‰è£…äº†ä¸¤ä¸ªhomebrew"></a>1.å®‰è£…äº†ä¸¤ä¸ªhomebrew</h3><p>ä¸çŸ¥é“ä»€ä¹ˆåŸå› ç”µè„‘é‡Œå®‰è£…äº†ä¸¤ä¸ªhomebrewï¼Œç„¶åæ¯ä¸ªhomebrewä¸‹åˆéƒ½å®‰è£…äº†ä¸€äº›è½¯ä»¶ã€‚</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">/usr/</span>local/Homebrew</span><br><span class="line"><span class="regexp">/opt/</span>homebrew</span><br></pre></td></tr></table></figure>
<p>ç„¶åzshé‡Œé¢ï¼Œä¼˜å…ˆä½¿ç”¨çš„æ˜¯/opt/homebrewçš„homebrewã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Set PATH, MANPATH, etc., for Homebrew.</span></span><br><span class="line"><span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(/opt/homebrew/bin/brew shellenv)</span>&quot;</span></span><br><span class="line"><span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(/usr/local/bin/brew shellenv)</span>&quot;</span></span><br></pre></td></tr></table></figure>
<p>å¯¼è‡´åœ¨å‡çº§ä¸€äº›è½¯ä»¶æ—¶æç¤ºå·²ç»å‡çº§äº†ï¼Œä½†æŸ¥çœ‹ç‰ˆæœ¬æ—¶è¿˜æ˜¯æ—§çš„ï¼ŒåŸå› å°±æ˜¯å‡çº§çš„æ˜¯å¦ä¸€ä¸ªhomebrewä¸‹çš„ï¼Œè€Œ/opt/homebrewä¸‹çš„è¿˜æ˜¯æ—§ç‰ˆæœ¬çš„ã€‚æ‰€ä»¥æ‰“ç®—åˆ é™¤æ‰/optç›®å½•ä¸‹çš„ã€‚</p>
<p><strong>å¸è½½/opt/homebrewä¸‹çš„homebrew</strong></p>
<p>1.å…ˆå¤‡ä»½è¦åˆ é™¤çš„/opt/homebrewã€‚åç»­ç¡®å®šæ²¡é—®é¢˜äº†å†å½»åº•åˆ é™¤ã€‚</p>
<p>2.ä¿®æ”¹<code>.zprofile</code> çš„å†…å®¹ä¸ºï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Set PATH, MANPATH, etc., for Homebrew.</span></span><br><span class="line"><span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(/usr/local/bin/brew shellenv)</span>&quot;</span></span><br></pre></td></tr></table></figure>
<p>å³åˆ é™¤æ‰ä¹‹å‰/opt/homebrewçš„ã€‚</p>
<p>3.æŸ¥çœ‹where brewï¼Œåº”è¯¥åªå‰©ä¸‹ä¸€ä¸ªäº†ã€‚</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="operator">âœ</span>  <span class="operator">~</span> <span class="keyword">where</span> brew</span><br><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>brew</span><br><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>brew</span><br></pre></td></tr></table></figure>
<p>åˆ é™¤åæœ‰ä¸€äº›è½¯ä»¶å¯èƒ½å¾—é‡æ–°å®‰è£…äº†ï¼Œæ¯”å¦‚ä¹‹å‰å®‰è£…çš„hexoå‘½ä»¤æç¤ºæ²¡äº†ã€‚</p>
<p>é‡æ–°å®‰è£…hexoï¼š</p>
<figure class="highlight avrasm"><table><tr><td class="code"><pre><span class="line">npm install -g hexo-<span class="keyword">cli</span></span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://brew.sh/zh-cn/">homebrewå®˜ç½‘</a></p>
<p><a href="https://cherishher.github.io/2018/08/02/%E4%B8%80%E4%BA%9B%E4%BD%BF%E7%94%A8homebrew%E7%9A%84%E7%BB%8F%E9%AA%8C/">ä¸€äº›ä½¿ç”¨homebrewçš„ç»éªŒ</a></p>
]]></content>
      <categories>
        <category>å‘½ä»¤è¡Œ</category>
      </categories>
      <tags>
        <tag>homebrew</tag>
      </tags>
  </entry>
  <entry>
    <title>nodejsä»‹ç»</title>
    <url>/2024/02/09/nodejs%E4%BB%8B%E7%BB%8D/</url>
    <content><![CDATA[<h2 id="nodeç®€ä»‹"><a href="#nodeç®€ä»‹" class="headerlink" title="nodeç®€ä»‹"></a>nodeç®€ä»‹</h2><p>Node.js æ˜¯èƒ½å¤Ÿåœ¨æœåŠ¡å™¨ç«¯è¿è¡ŒJavaScript çš„å¼€æ”¾æºä»£ç ã€è·¨å¹³å°æ‰§è¡Œç¯å¢ƒã€‚Node.js ç”± OpenJS Foundation æŒæœ‰å’Œç»´æŠ¤ï¼Œäº¦ä¸ºLinux åŸºé‡‘ä¼šçš„é¡¹ç›®ã€‚Node.js æ˜¯ä¸€ä¸ªå¼€æºçš„è·¨å¹³å° <a href="https://nodejs.org/en/about/">JavaScript è¿è¡Œæ—¶ç¯å¢ƒ</a>ï¼Œä¾§é‡äºæœåŠ¡å™¨ç«¯å’Œç½‘ç»œåº”ç”¨ã€‚</p>
<p>Node.js éå¸¸é€‚åˆç”¨äºï¼š</p>
<ul>
<li>ä½¿ç”¨ Node.js å¼€å‘çš„å•é¡µ Web åº”ç”¨ç¨‹åº</li>
<li>Web æœåŠ¡å™¨åç«¯</li>
<li>ç§»åŠ¨å’Œæ¡Œé¢åº”ç”¨ç¨‹åºï¼ˆåŒ…æ‹¬æ¸¸æˆï¼‰</li>
<li>æœºå™¨å­¦ä¹ ç³»ç»Ÿæˆ– IoT è®¾å¤‡çš„åç«¯</li>
</ul>
<h2 id="å®‰è£…node"><a href="#å®‰è£…node" class="headerlink" title="å®‰è£…node"></a>å®‰è£…node</h2><p>nodeç‰ˆæœ¬æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ£˜æ‰‹çš„é—®é¢˜ï¼Œæ¯”å¦‚6.3.0ç‰ˆçš„nodeè·‘ä¸äº†ä¸€äº›æ–°é¡¹ç›®ï¼Œå‡çº§åˆ°10.xç‰ˆçš„nodeåï¼Œåˆè·‘ä¸äº†æ—§é¡¹ç›®ã€‚æ‰€ä»¥å®‰è£…çš„nodeæœ€å¥½èƒ½æ–¹ä¾¿åˆ‡æ¢ç‰ˆæœ¬ã€‚æ¨èå…ˆå®‰è£…nvmï¼Œå†ä½¿ç”¨nvmå®‰è£…ç®¡ç†nodeç‰ˆæœ¬ã€‚<code>nvm</code> æ˜¯ <code>Node.js</code> çš„ç‰ˆæœ¬ç®¡ç†å·¥å…·ï¼Œå¯ä»¥åˆ›å»ºä¸åŒç‰ˆæœ¬ <code>Node</code> çš„éš”ç¦»ç¯å¢ƒï¼Œä»è€Œé¿å…ä¸åŒç‰ˆæœ¬åŒ…ä¹‹é—´çš„å¹²æ‰°ã€‚</p>
<p>å®‰è£… <code>nvm</code> ä¹‹å‰æœ€å¥½æ˜¯å°†ç°æœ‰çš„å…¨å±€ <code>Node</code> è¿›è¡Œå¸è½½ï¼Œå¦åˆ™ä¼šå‘ç”Ÿå†²çªã€‚</p>
<p>å…ˆæŸ¥çœ‹ä¸€ä¸‹nodeä¿¡æ¯ï¼š</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">âœ  ~ which <span class="keyword">node</span></span><br><span class="line"><span class="title">/usr</span>/local/bin/<span class="keyword">node</span></span><br><span class="line"><span class="title">âœ  ~ node</span> -v</span><br><span class="line">v21.<span class="number">6.1</span></span><br></pre></td></tr></table></figure>
<p>ä¹‹å‰æ˜¯ç”¨homebrewå®‰è£…çš„ï¼Œå¯ä»¥é€šè¿‡brew listæŸ¥çœ‹ï¼š</p>
<figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line">âœ  ~ brew list</span><br><span class="line"><span class="operator">=</span><span class="operator">=</span>&gt; Formulae</span><br><span class="line">abseil		icu<span class="number">4</span><span class="keyword">c</span>		libuv		python<span class="title">@3</span>.<span class="number">11</span>	xz</span><br><span class="line">brotli		inetutils	mpdecimal	readline</span><br><span class="line"><span class="keyword">c</span>-ares		libidn<span class="number">2</span>		node		sqlite</span><br><span class="line">ca-certificates	libnghttp<span class="number">2</span>	openssl<span class="title">@3</span>	swift-protobuf</span><br><span class="line">gettext		libunistring	protobuf	telnet</span><br></pre></td></tr></table></figure>
<p>å¸è½½ï¼šbrew uninstall node</p>
<h3 id="å®‰è£…nvm"><a href="#å®‰è£…nvm" class="headerlink" title="å®‰è£…nvm"></a>å®‰è£…nvm</h3><p>æ–¹æ³•ä¸€ï¼šé€šè¿‡å®˜ç½‘GitHubçš„è¯´æ˜ä¹¦</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">curl -o- https:<span class="regexp">//</span>raw.githubusercontent.com<span class="regexp">/nvm-sh/</span>nvm<span class="regexp">/v0.39.7/i</span>nstall.sh | bash</span><br></pre></td></tr></table></figure>
<p>æ–¹æ³•äºŒï¼šé€šè¿‡brewå®‰è£…ï¼ˆæœ¬æ–‡ä½¿ç”¨homebrewå®‰è£…ï¼‰</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line"><span class="keyword">brew </span><span class="keyword">install </span>nvm</span><br></pre></td></tr></table></figure>
<p>å®‰è£…å®Œæˆånvm -vè‚¯å®šä¼šæç¤ºæ‰¾ä¸åˆ°nvmå‘½ä»¤ã€‚ç»§ç»­ï¼š</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">brew</span> <span class="literal">info</span> nvm</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°å‘½ä»¤ä¼šæç¤ºä½ ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">You should create NVM<span class="string">&#x27;s working directory if it doesn&#x27;</span>t exist:</span><br><span class="line">  <span class="built_in">mkdir</span> ~/.nvm</span><br><span class="line"></span><br><span class="line">Add the following to your shell profile e.g. ~/.profile or ~/.zshrc:</span><br><span class="line">  <span class="built_in">export</span> NVM_DIR=<span class="string">&quot;<span class="variable">$HOME</span>/.nvm&quot;</span></span><br><span class="line">  [ -s <span class="string">&quot;/usr/local/opt/nvm/nvm.sh&quot;</span> ] &amp;&amp; \. <span class="string">&quot;/usr/local/opt/nvm/nvm.sh&quot;</span>  <span class="comment"># This loads nvm</span></span><br><span class="line">  [ -s <span class="string">&quot;/usr/local/opt/nvm/etc/bash_completion.d/nvm&quot;</span> ] &amp;&amp; \. <span class="string">&quot;/usr/local/opt/nvm/etc/bash_completion.d/nvm&quot;</span>  <span class="comment"># This loads nvm bash_completion</span></span><br><span class="line"></span><br><span class="line">You can <span class="built_in">set</span> <span class="variable">$NVM_DIR</span> to any location, but leaving it unchanged from</span><br><span class="line">/usr/local/Cellar/nvm/0.39.7 will destroy any nvm-installed Node installations</span><br><span class="line">upon upgrade/reinstall.</span><br></pre></td></tr></table></figure>
<p>æŒ‰ç…§ä¸Šè¿°æç¤ºï¼šå…ˆåˆ›å»º.nvmæ–‡ä»¶å¤¹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> ~/.nvm</span><br></pre></td></tr></table></figure>
<p>å†å¾€~/.zshrcé‡Œæ·»åŠ ï¼š</p>
<figure class="highlight livescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> NVM_DIR=<span class="string">&quot;$HOME/.nvm&quot;</span></span><br><span class="line">  [ -s <span class="string">&quot;/usr/local/opt/nvm/nvm.sh&quot;</span> ] &amp;&amp; <span class="string">\.</span> <span class="string">&quot;/usr/local/opt/nvm/nvm.sh&quot;</span>  <span class="comment"># This loads nvm</span></span><br><span class="line">  [ -s <span class="string">&quot;/usr/local/opt/nvm/etc/bash_completion.d/nvm&quot;</span> ] &amp;&amp; <span class="string">\.</span> <span class="string">&quot;/usr/local/opt/nvm/etc/bash_completion.d/nvm&quot;</span>  <span class="comment"># This loads nvm bash_completion</span></span><br></pre></td></tr></table></figure>
<p>æœ€å<code>source ~/.zshrc</code></p>
<p>è¿™æ—¶æŸ¥çœ‹ç‰ˆæœ¬å°±æ²¡æœ‰é—®é¢˜äº†ã€‚</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">âœ  ~ nvm -v</span><br><span class="line">0.39.7</span><br></pre></td></tr></table></figure>
<p>ç»§ç»­ï¼Œä½¿ç”¨nvmå®‰è£…node</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">nvm install --lts</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨å®‰è£… Node.js éƒ½ä¼šé»˜è®¤å®‰è£… npmï¼ˆnode åŒ…ç®¡ç†å·¥å…·ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸ç”¨å•ç‹¬å®‰è£… npmã€‚æ‰§è¡Œå®Œånodeå°±å®‰è£…å¥½äº†ã€‚</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line"><span class="keyword">node</span> <span class="title">-v</span></span><br><span class="line">npm -v</span><br></pre></td></tr></table></figure>
<h2 id="nodeç‰ˆæœ¬åˆ‡æ¢"><a href="#nodeç‰ˆæœ¬åˆ‡æ¢" class="headerlink" title="nodeç‰ˆæœ¬åˆ‡æ¢"></a>nodeç‰ˆæœ¬åˆ‡æ¢</h2><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">nvm <span class="keyword">use</span> nodeç‰ˆæœ¬ <span class="comment">//ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬</span></span><br><span class="line">nvm <span class="keyword">use</span> default <span class="comment">//ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬</span></span><br><span class="line">nvm <span class="keyword">ls</span> <span class="comment">//æŸ¥çœ‹å·²å®‰è£…çš„nodeç‰ˆæœ¬</span></span><br><span class="line">nvm <span class="keyword">ls</span>-remote</span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://heynode.com/tutorial/install-nodejs-locally-nvm/">Install Node.js Locally with Node Version Manager (nvm)</a></p>
]]></content>
      <categories>
        <category>å‘½ä»¤è¡Œ</category>
      </categories>
      <tags>
        <tag>node</tag>
      </tags>
  </entry>
  <entry>
    <title>sshæ–¹å¼git cloneæŠ¥é”™</title>
    <url>/2024/01/20/ssh%E6%96%B9%E5%BC%8Fgit%20clone%E6%8A%A5%E9%94%99/</url>
    <content><![CDATA[<p>sshç±»å‹çš„ä»“åº“ï¼Œgit clone/pullæŠ¥é”™ï¼škex_exchange_identification: Connection closed by remote host</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">git pull <span class="comment">--verbose</span></span><br><span class="line">kex_exchange_identification: <span class="keyword">Connection</span> closed <span class="keyword">by</span> remote host</span><br><span class="line"><span class="keyword">Connection</span> closed <span class="keyword">by</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> port <span class="number">7890</span></span><br><span class="line">fatal: Could <span class="keyword">not</span> <span class="keyword">read</span> <span class="keyword">from</span> remote repository.</span><br><span class="line"></span><br><span class="line">Please make sure you have the correct <span class="keyword">access</span> rights</span><br><span class="line"><span class="keyword">and</span> the repository <span class="keyword">exists</span>.</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæŠ¥é”™å…¶å®è·Ÿä½¿ç”¨æ¢¯å­æœ‰å…³ã€‚</p>
<p>è§£å†³ï¼š</p>
<p>step 1.å°†~/.sshä¸‹çš„id_rsa.pub(æ²¡æœ‰å°±å…ˆåˆ›å»ºå…¬ç§é’¥)å…¬é’¥å†…å®¹æ·»åŠ åˆ°githubåå°ã€‚</p>
<p>step 2.åœ¨~/.ssh/configæ–‡ä»¶ï¼ˆæ²¡æœ‰å°±å…ˆåˆ›å»ºï¼‰ä¸­æ·»åŠ ï¼š</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">Host github.com</span><br><span class="line">    HostName ssh.github.com</span><br><span class="line">    <span class="keyword">User</span> <span class="title">git</span></span><br><span class="line">    Port <span class="number">443</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°å†…å®¹è¡¨ç¤ºsshä½¿ç”¨443ç«¯å£è€Œä¸å†æ˜¯é»˜è®¤çš„22ã€‚</p>
<p>step 3.ä½¿ç”¨å‘½ä»¤<code>ssh -T git@github.com</code>éªŒè¯</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">$ ssh -T git@github.com</span><br><span class="line">Hi xq-<span class="number">120</span>! You<span class="symbol">&#x27;ve</span> successfully authenticated, but GitHub does <span class="keyword">not</span> provide shell <span class="keyword">access</span>.</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ—¶å€™åº”è¯¥å°±å¯ä»¥æ­£å¸¸git cloneäº†ã€‚</p>
<p>å…¶å®ä¸Šé¢æ‰§è¡Œå®Œåï¼Œä¼šåœ¨known_hostsæ·»åŠ è®°å½•ï¼š</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">[<span class="symbol">ssh.github.com</span>]:<span class="link">443 ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOMqqnkVzrm0SdG6UOoqKLsabgH5C9okWi0dh2l9GKJl</span></span><br><span class="line">[<span class="symbol">ssh.github.com</span>]:<span class="link">443 ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCj7ndNxQowgcQnjshcLrqPEiiphnt+VTTvDP6mHBL9j1aNUkY4Ue1gvwnGLVlOhGeYrnZaMgRK6+PKCUXaDbC7qtbW8gIkhL7aGCsOr/C56SJMy/BCZfxd1nWzAOxSDPgVsmerOBYfNqltV9/hWCqBywINIR+5dIg6JTJ72pcEpEjcYgXkE2YEFXV1JHnsKgbLWNlhScqb2UmyRkQyytRLtL+38TGxkxCflmO+5Z8CSSNY7GidjMIZ7Q4zMjA2n1nGrlTDkzwDCsw+wqFPGQA179cnfGWOWRVruj16z6XyvxvjJwbz0wQZ75XK5tKSb7FNyeIEs4TT4jk+S4dhPeAUC5y+bDYirYgM4GC7uEnztnZyaVWQ7B381AK4Qdrwt51ZqExKbQpTUNn+EjqoTwvqNj4kqx5QUCI0ThS/YkOxJCXmPUWZbhjpCg56i+2aB6CmK2JGhn57K5mj0MNdBXA4/WnwH6XoPWJzK5Nyu2zB3nAZp+S5hpQs+p1vN1/wsjk=</span></span><br><span class="line">[<span class="symbol">ssh.github.com</span>]:<span class="link">443 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBEmKSENjQEezOmxkZMy7opKgwFB9nkt5YRrYMjNuG5N87uRgg6CLrbo5wAdT/y6v0mKV0U2w0WZ2YB/++Tpockg=</span></span><br></pre></td></tr></table></figure>
<p>è¿™å°±æ˜¯æ‰€è°“çš„host key fingerprintï¼Œå…¶å®å°±æ˜¯ç”¨æ¥éªŒè¯æœåŠ¡å™¨èº«ä»½çš„ï¼Œé¿å…ä¸­é—´äººæ”»å‡»ã€‚</p>
<p>å¦å¤–ä¸çŸ¥é“ä¸ºå•¥è¿˜ç”Ÿæˆäº†ä¸€ä¸ªknown_hosts.oldæ–‡ä»¶ã€‚</p>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>æŸ¥çœ‹ä»“åº“çš„è¿œç¨‹URLç±»å‹</p>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">git remote -v</span></span><br></pre></td></tr></table></figure>
<p>æ‰“å°ç»“æœï¼šä¸€èˆ¬æ˜¯sshæˆ–https</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">origin	ssh:<span class="regexp">//gi</span>t<span class="variable">@github</span>.com/xxx/xxx.git (fetch)</span><br><span class="line">origin	ssh:<span class="regexp">//gi</span>t<span class="variable">@github</span>.com/xxx/xxx.git (<span class="keyword">push</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">origin	https:<span class="regexp">//gi</span>thub.com<span class="regexp">/xxx/</span>xxx.git (fetch)</span><br><span class="line">origin	https:<span class="regexp">//gi</span>thub.com<span class="regexp">/xxx/</span>xxx.git (push)</span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://juejin.cn/post/7129443602379309086">Githubï¼šé€šè¿‡sshkeyçš„æ–¹å¼æ‹‰å–ä»£ç æŠ¥é”™kex_exchange_identification: Connection closed by remote</a></p>
]]></content>
      <categories>
        <category>Git</category>
      </categories>
  </entry>
  <entry>
    <title>shellç§‘æ™®</title>
    <url>/2023/09/07/shell%E7%A7%91%E6%99%AE/</url>
    <content><![CDATA[<h3 id="ä»€ä¹ˆæ˜¯shell"><a href="#ä»€ä¹ˆæ˜¯shell" class="headerlink" title="ä»€ä¹ˆæ˜¯shell"></a>ä»€ä¹ˆæ˜¯shell</h3><p>çœ‹è¯­å¢ƒï¼Œæœ‰æ—¶å€™ShellæŒ‡è¿æ¥å†…æ ¸å’Œç”¨æˆ·çš„ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œæœ‰æ—¶å€™æŒ‡ä¸€ç§è„šæœ¬ç¼–ç¨‹è¯­è¨€ã€‚ä¸è¿‡è¿™ä¸ªçœ‹è¯­å¢ƒå¯¹äºä¸€ä¸ªå°ç™½æ¥è¯´å…¶å®è¿˜æŒºéš¾çš„ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹è¯´shellå…¶å®è¯´çš„æ˜¯åº”ç”¨ç¨‹åºï¼Œä½†å¦‚æœæ˜¯è¯´shellå‘½ä»¤ï¼Œè„šæœ¬æ–‡ä»¶é‚£shellå°±æ˜¯æŒ‡ä¸€ç§ç¼–ç¨‹è¯­è¨€ã€‚</p>
<p>macOS ç³»ç»Ÿçš„é»˜è®¤ç»ˆç«¯ï¼ˆshellåº”ç”¨ç¨‹åºï¼‰æ˜¯ Terminalï¼Œé»˜è®¤ä½¿ç”¨çš„shellæ˜¯zshï¼ˆè¿™é‡Œçš„zshå°±æ˜¯æŒ‡è„šæœ¬ç¼–ç¨‹è¯­è¨€ï¼‰ã€‚iTerm2 ä¹Ÿæ˜¯ä¸€æ¬¾ç»ˆç«¯è½¯ä»¶ã€‚iTerm2åªæ˜¯æ¯”Terminalæ‹¥æœ‰æ›´å¤šçš„è‡ªå®šä¹‰è®¾ç½®ï¼Œä½¿ç”¨oh-my-zshç¾åŒ–åéƒ½å·®ä¸å¤šã€‚ç»ˆç«¯è¿™ä¸ªshellåº”ç”¨ç¨‹åºå¯ä»¥è®¾ç½®å…·ä½“ä½¿ç”¨å“ªä¸€ç§shellä½œä¸ºé»˜è®¤shellã€‚ä½¿ç”¨å“ªç§shellä½œä¸ºé»˜è®¤shellçš„ç»ˆç«¯å°±ç§°ä¸ºxxxç»ˆç«¯ï¼Œæ¯”å¦‚zshç»ˆç«¯ï¼Œbashç»ˆç«¯ã€‚</p>
<p>Shell å¯ä»¥æŒ‡ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œå®ƒè¿æ¥äº†ç”¨æˆ·å’Œ Linux å†…æ ¸ï¼Œè®©ç”¨æˆ·èƒ½å¤Ÿæ›´åŠ é«˜æ•ˆã€å®‰å…¨ã€ä½æˆæœ¬åœ°ä½¿ç”¨ Linux å†…æ ¸ï¼Œè¿™å°±æ˜¯ Shell çš„æœ¬è´¨ã€‚Shell æœ¬èº«å¹¶ä¸æ˜¯å†…æ ¸çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒåªæ˜¯ç«™åœ¨å†…æ ¸çš„åŸºç¡€ä¸Šç¼–å†™çš„ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œå®ƒå’Œ QQã€è¿…é›·ã€Firefox ç­‰å…¶å®ƒè½¯ä»¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚ç„¶è€Œ Shell ä¹Ÿæœ‰ç€å®ƒçš„ç‰¹æ®Šæ€§ï¼Œå°±æ˜¯å¼€æœºç«‹é©¬å¯åŠ¨ï¼Œå¹¶å‘ˆç°åœ¨ç”¨æˆ·é¢å‰ï¼›ç”¨æˆ·é€šè¿‡ Shell æ¥ä½¿ç”¨ Linuxï¼Œä¸å¯åŠ¨ Shell çš„è¯ï¼Œç”¨æˆ·å°±æ²¡åŠæ³•ä½¿ç”¨ Linuxã€‚</p>
<p>Shell ä¹Ÿå¯ä»¥æŒ‡ä¸€ç§è„šæœ¬ç¼–ç¨‹è¯­è¨€ã€‚Shell ç¼–ç¨‹è·Ÿ JavaScriptã€php ç¼–ç¨‹ä¸€æ ·ï¼Œåªè¦æœ‰ä¸€ä¸ªèƒ½ç¼–å†™ä»£ç çš„æ–‡æœ¬ç¼–è¾‘å™¨å’Œä¸€ä¸ªèƒ½è§£é‡Šæ‰§è¡Œçš„è„šæœ¬è§£é‡Šå™¨ï¼ˆè§£é‡Šå™¨ä¸€èˆ¬å°±æ˜¯shellç»ˆç«¯è½¯ä»¶ä¹Ÿå°±æ˜¯Terminalæˆ–è€…iTerm2ç­‰ç­‰ï¼‰å°±å¯ä»¥äº†ã€‚</p>
<p>Shell ä¸»è¦ç”¨æ¥å¼€å‘ä¸€äº›å®ç”¨çš„ã€è‡ªåŠ¨åŒ–çš„å°å·¥å…·ï¼Œè€Œä¸æ˜¯ç”¨æ¥å¼€å‘å…·æœ‰å¤æ‚ä¸šåŠ¡é€»è¾‘çš„ä¸­å¤§å‹è½¯ä»¶ï¼Œä¾‹å¦‚æ£€æµ‹è®¡ç®—æœºçš„ç¡¬ä»¶å‚æ•°ã€æ­å»º Web è¿è¡Œç¯å¢ƒã€æ—¥å¿—åˆ†æç­‰ï¼ŒShell éƒ½éå¸¸åˆé€‚ã€‚</p>
<h3 id="æœ‰å“ªäº›shell"><a href="#æœ‰å“ªäº›shell" class="headerlink" title="æœ‰å“ªäº›shell"></a>æœ‰å“ªäº›shell</h3><p>shellæ˜¯ä¸€ä¸ªæ€»ç§°ï¼Œå…·ä½“shellæœ‰ï¼šbashã€cshã€kshã€zshç­‰ç­‰ã€‚Macé»˜è®¤ä½¿ç”¨çš„æ˜¯zshã€‚</p>
<p>æŸ¥çœ‹å®‰è£…äº†å“ªäº›shellï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/shells</span><br></pre></td></tr></table></figure>
<p>æ‰“å°ï¼š</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="comment"># List of acceptable shells for chpass(1).</span></span><br><span class="line"><span class="comment"># Ftpd will not allow users to connect who are not using</span></span><br><span class="line"><span class="comment"># one of these shells.</span></span><br><span class="line"></span><br><span class="line"><span class="regexp">/bin/</span>bash</span><br><span class="line"><span class="regexp">/bin/</span>csh</span><br><span class="line"><span class="regexp">/bin/</span>dash</span><br><span class="line"><span class="regexp">/bin/</span>ksh</span><br><span class="line"><span class="regexp">/bin/</span>sh</span><br><span class="line"><span class="regexp">/bin/</span>tcsh</span><br><span class="line"><span class="regexp">/bin/</span>zsh</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„shellæŒ‡shellç¼–ç¨‹è¯­è¨€ã€‚ä¸åŒçš„shellæ‹¥æœ‰ä¸åŒçš„è¯­æ³•å’Œå†…ç½®å‘½ä»¤ï¼Œä½†å¤§å·®ä¸å·®ï¼Œæœ‰çš„å¯ä»¥å…¼å®¹å¦ä¸€ç§ã€‚ä¸€ä¸ªç¼–å†™å¥½çš„shellè„šæœ¬éœ€è¦ä½¿ç”¨shellç»ˆç«¯æ¥è§£é‡Šæ‰§è¡Œã€‚å› ä¸ºæœ‰çš„å¯ä»¥å…¼å®¹å¦ä¸€ç§ï¼Œæ‰€ä»¥ä¸€ä¸ªä½¿ç”¨A shellç¼–å†™çš„è„šæœ¬æ–‡ä»¶å¯ä»¥ä¸åŠ ä¿®æ”¹çš„åœ¨ä½¿ç”¨B shellä½œä¸ºé»˜è®¤shellçš„ç»ˆç«¯é‡Œè§£é‡Šæ‰§è¡Œã€‚</p>
<h3 id="æŸ¥çœ‹æ­£åœ¨ä½¿ç”¨çš„æ˜¯å“ªç§shell"><a href="#æŸ¥çœ‹æ­£åœ¨ä½¿ç”¨çš„æ˜¯å“ªç§shell" class="headerlink" title="æŸ¥çœ‹æ­£åœ¨ä½¿ç”¨çš„æ˜¯å“ªç§shell"></a>æŸ¥çœ‹æ­£åœ¨ä½¿ç”¨çš„æ˜¯å“ªç§shell</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="variable">$SHELL</span></span><br></pre></td></tr></table></figure>
<p>æ‰“å°ï¼š</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">/bin/</span>zsh</span><br></pre></td></tr></table></figure>
<h3 id="å¦‚ä½•æ‰§è¡Œä¸€ä¸ªshellè„šæœ¬"><a href="#å¦‚ä½•æ‰§è¡Œä¸€ä¸ªshellè„šæœ¬" class="headerlink" title="å¦‚ä½•æ‰§è¡Œä¸€ä¸ªshellè„šæœ¬"></a>å¦‚ä½•æ‰§è¡Œä¸€ä¸ªshellè„šæœ¬</h3><p>ä¸¤è€…éƒ½è¦å…ˆæ‰“å¼€ç»ˆç«¯ï¼Œåœ¨ç»ˆç«¯é‡Œè¿è¡Œã€‚</p>
<p>æ–¹å¼1.ç»™shellè„šæœ¬æ·»åŠ å¯æ‰§è¡Œæƒé™ã€‚ è¿™ä¸ªæ˜¯å¸¸ç”¨çš„åšæ³•ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1.<span class="built_in">cd</span> åˆ°ç›¸åº”ç›®å½•</span><br><span class="line">2.<span class="built_in">chmod</span> +x ./test.sh  <span class="comment">#ä½¿è„šæœ¬å…·æœ‰æ‰§è¡Œæƒé™</span></span><br><span class="line">3../test.sh  <span class="comment">#æ‰§è¡Œè„šæœ¬</span></span><br></pre></td></tr></table></figure>
<p>æ–¹å¼2.<strong>ä½œä¸ºè§£é‡Šå™¨å‚æ•°</strong>ã€‚è¿™ç§è¿è¡Œæ–¹å¼æ˜¯ç›´æ¥è¿è¡Œè§£é‡Šå™¨ï¼Œå…¶å‚æ•°å°±æ˜¯ shell è„šæœ¬çš„æ–‡ä»¶åã€‚å¦‚ï¼š</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">/bin/zsh <span class="keyword">test</span>.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure>
<h3 id="å¦‚ä½•åˆ‡æ¢shell"><a href="#å¦‚ä½•åˆ‡æ¢shell" class="headerlink" title="å¦‚ä½•åˆ‡æ¢shell"></a>å¦‚ä½•åˆ‡æ¢shell</h3><p>chsh -s /bin/æŸshellï¼Œå¦‚ï¼š</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">chsh -s <span class="regexp">/bin/</span>zsh  <span class="comment">#åˆ‡æ¢åˆ°zsh</span></span><br><span class="line">chsh -s <span class="regexp">/bin/</span>bash  <span class="comment">#åˆ‡æ¢åˆ°bash</span></span><br></pre></td></tr></table></figure>
<p>æœ€åé‡å¯ç»ˆç«¯ã€‚</p>
<h3 id="zshä¸oh-my-zshçš„å…³ç³»"><a href="#zshä¸oh-my-zshçš„å…³ç³»" class="headerlink" title="zshä¸oh-my-zshçš„å…³ç³»"></a>zshä¸oh-my-zshçš„å…³ç³»</h3><p>zshæ—¢å¯ä»¥æŒ‡ç»ˆç«¯è½¯ä»¶åˆå¯ä»¥æŒ‡zshè„šæœ¬è¯­è¨€ï¼Œä½†åœ¨è¿™ä¸ªé—®é¢˜é‡Œï¼ŒzshæŒ‡çš„æ˜¯ç»ˆç«¯è½¯ä»¶ã€‚è€Œoh-my-zshæ˜¯ä¸€ä¸ªä¸ºäº†æ–¹ä¾¿é…ç½®zshç»ˆç«¯çš„åº“ã€‚ä½¿ç”¨oh-my-zshå¯ä»¥ç¾åŒ–zshç»ˆç«¯ï¼ˆç¾åŒ–åçš„zshç»ˆç«¯çœ‹èµ·æ¥è¦æ¯”åŸå§‹zshç»ˆç«¯è¦å¥½çœ‹å¾ˆå¤šï¼Œä¸ç®¡æ˜¯å­—ä½“ï¼Œé¢œè‰²ç­‰ç­‰ï¼‰ï¼Œå¢å¼ºzshç»ˆç«¯çš„åŠŸèƒ½ï¼ˆç›¸æ¯”åŸå§‹zshç»ˆç«¯å¯ä»¥å‘½ä»¤é«˜äº®ï¼Œå‘½ä»¤è¡¥å…¨ç­‰ç­‰ï¼‰ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨powerlineç¾åŒ–bashç»ˆç«¯ã€‚</p>
<h3 id="ç¯å¢ƒå˜é‡"><a href="#ç¯å¢ƒå˜é‡" class="headerlink" title="ç¯å¢ƒå˜é‡"></a>ç¯å¢ƒå˜é‡</h3><p>bash çš„ç¯å¢ƒå˜é‡ä¿å­˜åœ¨<code>.bash_profile</code>æ–‡ä»¶ã€‚<br>zsh çš„ç¯å¢ƒå˜é‡ä¿å­˜åœ¨<code>.zshrc</code>æ–‡ä»¶ã€‚</p>
<h4 id="TODOç¯å¢ƒå˜é‡æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#TODOç¯å¢ƒå˜é‡æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="TODOç¯å¢ƒå˜é‡æ˜¯ä»€ä¹ˆï¼Ÿ"></a>TODOç¯å¢ƒå˜é‡æ˜¯ä»€ä¹ˆï¼Ÿ</h4><h4 id="TODOä¸ºä»€ä¹ˆéœ€è¦ç¯å¢ƒå˜é‡ï¼Ÿ"><a href="#TODOä¸ºä»€ä¹ˆéœ€è¦ç¯å¢ƒå˜é‡ï¼Ÿ" class="headerlink" title="TODOä¸ºä»€ä¹ˆéœ€è¦ç¯å¢ƒå˜é‡ï¼Ÿ"></a>TODOä¸ºä»€ä¹ˆéœ€è¦ç¯å¢ƒå˜é‡ï¼Ÿ</h4><p>æ–¹ä¾¿ä½¿ç”¨ã€‚</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://blog.csdn.net/xueyingpiaoran/article/details/127930040?spm=1001.2101.3001.6650.1&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-1-127930040-blog-104599637.235%5Ev38%5Epc_relevant_sort_base3&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-1-127930040-blog-104599637.235%5Ev38%5Epc_relevant_sort_base3&amp;utm_relevant_index=2">iTerm2ä¸zshçš„å…³ç³»</a></p>
<p><a href="http://lichen-blog.logdown.com/posts/1866624-what-is-bash">bashæ˜¯ä»€ä¹ˆ</a></p>
<p><a href="https://linux.cn/article-8842-1.html">Zsh å¼€å‘æŒ‡å—ï¼ˆä¸€ï¼‰ï¼šå˜é‡å’Œè¯­å¥</a></p>
]]></content>
      <categories>
        <category>å‘½ä»¤è¡Œ</category>
      </categories>
      <tags>
        <tag>shell</tag>
      </tags>
  </entry>
  <entry>
    <title>æ‰“åŒ…é”™è¯¯Command PhaseScriptExecution failed</title>
    <url>/2023/09/01/%E6%89%93%E5%8C%85%E9%94%99%E8%AF%AFCommand%20PhaseScriptExecution%20failed/</url>
    <content><![CDATA[<p>æ‰“æµ‹è¯•åŒ…çš„æ—¶å€™ï¼Œæç¤ºCommand PhaseScriptExecution failed with a nonzero exit codeé”™è¯¯ã€‚</p>
<p>æ‰¾åˆ°<code>/Pods/Target Support Files/Pods-Runner/Pods-ä½ çš„é¡¹ç›®-frameworks.sh</code>å°†</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>=<span class="string">&quot;<span class="subst">$(readlink <span class="string">&quot;<span class="variable">$&#123;source&#125;</span>&quot;</span>)</span>&quot;</span></span><br></pre></td></tr></table></figure>
<p>æ”¹ä¸º</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>=<span class="string">&quot;<span class="subst">$(readlink -f <span class="string">&quot;<span class="variable">$&#123;source&#125;</span>&quot;</span>)</span>&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://tugberkcanozen.medium.com/resolving-command-phasescriptexecution-failed-with-a-nonzero-exit-code-error-in-xcode-936d292fc9f8">Resolving â€œCommand PhaseScriptExecution failed with a nonzero exit codeâ€ Error in Xcode</a></p>
]]></content>
      <categories>
        <category>Xcode</category>
      </categories>
  </entry>
  <entry>
    <title>å¸¸ç”¨ç›®å½•å‘½ä»¤</title>
    <url>/2023/07/30/%E5%B8%B8%E7%94%A8%E7%9B%AE%E5%BD%95%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<p>macOSç›®å½•å‘½ä»¤</p>
<h2 id="1-æ–°å»ºç›®å½•mkdir"><a href="#1-æ–°å»ºç›®å½•mkdir" class="headerlink" title="1.æ–°å»ºç›®å½•mkdir"></a>1.æ–°å»ºç›®å½•mkdir</h2><p>è¯­æ³•ï¼š</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line">mkdir [-p] dirName</span><br></pre></td></tr></table></figure>
<p>-p: å¦‚æœä¸­é—´ç›®å½•ä¸å­˜åœ¨åˆ™åˆ›å»ºä¸€ä¸ªã€‚ä¸åŠ  -p å‚æ•°å¦‚æœä¸­é—´ç›®å½•ä¸å­˜åœ¨åˆ™ä¼šæŠ¥é”™ï¼šNo such file or directoryã€‚</p>
<p>ç¤ºä¾‹:</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">mkdir</span> æ–‡ä»¶å<span class="number">1</span></span><br><span class="line"><span class="attribute">mkdir</span> æ–‡ä»¶å<span class="number">1</span> æ–‡ä»¶å<span class="number">2</span></span><br><span class="line"><span class="attribute">mkdir</span> -p æ–‡ä»¶å/æ–‡ä»¶å</span><br></pre></td></tr></table></figure>
<p>é€šå¸¸ä½¿ç”¨mdè¾ƒå¤šï¼Œmdæ˜¯mkdir -pçš„åˆ«åã€‚</p>
<h2 id="2-åˆ é™¤æ–‡ä»¶rm"><a href="#2-åˆ é™¤æ–‡ä»¶rm" class="headerlink" title="2.åˆ é™¤æ–‡ä»¶rm"></a>2.åˆ é™¤æ–‡ä»¶rm</h2><p>è¯­æ³•ï¼š</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">rm [<span class="keyword">OPTION</span>]... <span class="keyword">FILE</span>...</span><br></pre></td></tr></table></figure>
<p>åˆ é™¤æ–‡ä»¶å¯ä»¥ç›´æ¥ä½¿ç”¨rmå‘½ä»¤ã€‚æ³¨æ„ï¼šä¸ä¼šæœ‰è¯·æ±‚ç¡®è®¤ã€‚</p>
<p>egï¼šrm some.pdf</p>
<p><strong>é€‰é¡¹è¯´æ˜</strong></p>
<p>-i åˆ é™¤æŸä¸ªæ–‡ä»¶å‰è¯·æ±‚ç¡®è®¤</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">rm</span> -i downsample_ImageIO.png</span><br></pre></td></tr></table></figure>
<p>ä¼šæç¤ºï¼šremove downsample_ImageIO.png?</p>
<p>æ­¤æ—¶æŒ‰nï¼Œåˆ™ä¸ä¼šåˆ é™¤ã€‚æŒ‰yåˆ™åˆ é™¤ã€‚</p>
<p><code>-f</code> å¼ºåˆ¶åˆ é™¤,æ²¡æœ‰æç¤º.åªèƒ½åˆ é™¤æ–‡ä»¶,ä¸èƒ½åˆ é™¤æ–‡ä»¶å¤¹.</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">rm</span> <span class="operator">-f</span> downsample_ImageIO.png</span><br></pre></td></tr></table></figure>
<p><code>-r</code> é€’å½’åˆ é™¤ã€‚</p>
<p>å¦‚æœæŒ‡å®šçš„è·¯å¾„ä¸ºæ–‡ä»¶å¤¹ï¼Œåˆ™åˆ é™¤æ•´ä¸ªæ–‡ä»¶å¤¹(åŒ…æ‹¬æ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰çš„æ–‡ä»¶åŠå…¶å­æ–‡ä»¶å¤¹)ã€‚</p>
<p>å¦‚æœæŒ‡å®šçš„è·¯å¾„ä¸ºæ–‡ä»¶ï¼Œåˆ™åˆ é™¤æ–‡ä»¶ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">rm</span> -r dsds.md</span><br><span class="line"><span class="built_in">rm</span> -r æœªå‘½åæ–‡ä»¶å¤¹</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ–‡ä»¶å¤¹é‡Œé¢æœ‰äº›æ–‡ä»¶æ˜¯åªè¯»çš„ï¼Œåˆ™rm -rä¼šå¼¹å‡ºä¸€äº›æç¤º</p>
<p>eg:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">rm</span> -r <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<p>ä¼šæç¤ºï¼šoverride râ€”râ€”râ€” xuequan/staff for test/mytest? y</p>
<p>è¾“å…¥yè¡¨ç¤ºæ›´æ”¹mytestæ–‡ä»¶çš„æƒé™ï¼Œç„¶åå†åˆ é™¤ï¼ŒæŒ‰næˆ–enteré”®åˆ™ä¸ä¼šåˆ é™¤ã€‚</p>
<p>æœ‰æ—¶ä¸æƒ³éº»çƒ¦ï¼Œå¯ä»¥ä½¿ç”¨rm -rfç»„åˆå¼ºåˆ¶åˆ é™¤ã€‚</p>
<p>æ³¨æ„ï¼šä½¿ç”¨rmåˆ é™¤çš„æ–‡ä»¶ä¸ä¼šè¿›åºŸçº¸ç¯“ï¼Œå¾ˆéš¾å†æ¢å¤ï¼Œä½¿ç”¨ä¸€äº›ç‰¹æ®Šæ‰‹æ®µå¯èƒ½å¯ä»¥æ¢å¤ã€‚ä¸€ç§å®‰å…¨çš„æ–¹æ³•æ˜¯é‡å®šä¹‰rmã€‚</p>
<h2 id="3-åˆ›å»ºæ–‡ä»¶touch"><a href="#3-åˆ›å»ºæ–‡ä»¶touch" class="headerlink" title="3.åˆ›å»ºæ–‡ä»¶touch"></a>3.åˆ›å»ºæ–‡ä»¶touch</h2><p>è¯­æ³•ï¼š</p>
<figure class="highlight irpf90"><table><tr><td class="code"><pre><span class="line"><span class="keyword">touch</span> <span class="keyword">file</span></span><br></pre></td></tr></table></figure>
<p>å½“ç„¶touchå‘½ä»¤ä¹Ÿä¸æ­¢åˆ›å»ºæ–‡ä»¶è¿™ä¸€åŠŸèƒ½ï¼Œå¦å¤–åˆ›å»ºæ–‡ä»¶çš„å‘½ä»¤æœ‰å¾ˆå¤šè¿™é‡Œä¸ä¸€ä¸€ä¸¾ä¾‹äº†ã€‚</p>
<h2 id="4-æ›´æ”¹æƒé™chmod"><a href="#4-æ›´æ”¹æƒé™chmod" class="headerlink" title="4.æ›´æ”¹æƒé™chmod"></a>4.æ›´æ”¹æƒé™chmod</h2><p>eg:åˆå§‹æ—¶mytestæ˜¯å¯è¯»å¯å†™çš„ï¼š</p>
<p>-rw-râ€”râ€”  1 xuequan staff   6 6 14 14:10 mytest</p>
<p>æ‰§è¡Œ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">chmod</span> u-w mytest</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨å˜ä¸ºåªè¯»äº†ï¼š</p>
<p>-râ€”râ€”râ€”  1 xuequan staff   6 6 14 14:10 mytest</p>
<p>æ›´å¤šå‚è€ƒï¼š</p>
<p><a href="https://www.runoob.com/linux/linux-comm-chmod.html">https://www.runoob.com/linux/linux-comm-chmod.html</a></p>
<h2 id="5-ç§»åŠ¨æ–‡ä»¶mv"><a href="#5-ç§»åŠ¨æ–‡ä»¶mv" class="headerlink" title="5.ç§»åŠ¨æ–‡ä»¶mv"></a>5.ç§»åŠ¨æ–‡ä»¶mv</h2><p>mvç”¨æ¥ä¸ºæ–‡ä»¶æˆ–ç›®å½•æ”¹åã€æˆ–å°†æ–‡ä»¶æˆ–ç›®å½•ç§»å…¥å…¶å®ƒä½ç½®ã€‚</p>
<p>è¯­æ³•ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mv</span> [options] <span class="built_in">source</span> dest</span><br><span class="line"><span class="built_in">mv</span> [options] <span class="built_in">source</span>... directory</span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼š</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>mv source_file(æ–‡ä»¶) dest_file(æ–‡ä»¶)</th>
<th>å°†æºæ–‡ä»¶å source_file æ”¹ä¸ºç›®æ ‡æ–‡ä»¶å dest_file</th>
</tr>
</thead>
<tbody>
<tr>
<td>mv source_file(æ–‡ä»¶) dest_directory(ç›®å½•)</td>
<td>å°†æ–‡ä»¶ source_file ç§»åŠ¨åˆ°ç›®æ ‡ç›®å½• dest_directory ä¸­</td>
</tr>
<tr>
<td>mv source_directory(ç›®å½•) dest_directory(ç›®å½•)</td>
<td>ç›®å½•å dest_directory å·²å­˜åœ¨ï¼Œå°† source_directory ç§»åŠ¨åˆ°ç›®å½•å dest_directory ä¸­ï¼›ç›®å½•å dest_directory ä¸å­˜åœ¨åˆ™ source_directory æ”¹åä¸ºç›®å½•å dest_directory</td>
</tr>
<tr>
<td>mv source_directory(ç›®å½•)    dest_file(æ–‡ä»¶)</td>
<td>å‡ºé”™</td>
</tr>
</tbody>
</table>
</div>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>macOSé‡‡ç”¨çš„æ˜¯Unixæ–‡ä»¶ç³»ç»Ÿï¼Œæ‰€æœ‰æ–‡ä»¶éƒ½æŒ‚åœ¨æ ¹ç›®å½•â€/â€œä¸‹é¢ï¼Œæ‰€ä»¥ä¸è¦æœ‰Windows ä¸‹çš„ç›˜ç¬¦æ¦‚å¿µã€‚åœ¨ Unixç³»ç»Ÿä¸­æ˜¯åŒºåˆ«å¤§å°å†™å­—ç¬¦çš„ï¼ŒA.txt ä¸ç­‰äº a.txtã€‚æ ¹ç›®å½•æ ‡å¿— / ä¸æ˜¯å¯æœ‰å¯æ— ï¼Œ<code>cd /System</code> è¡¨ç¤ºè½¬åˆ°æ ¹ç›®å½•ä¸‹çš„Systemä¸­ï¼Œè€Œ<code>cd System</code> è¡¨ç¤ºè½¬åˆ°å½“å‰ç›®å½•ä¸‹çš„ Systemä¸­ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/u011291072/article/details/122782942?spm=1001.2101.3001.6661.1&amp;utm_medium=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-122782942-blog-104642218.235%5Ev38%5Epc_relevant_sort_base3&amp;depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-122782942-blog-104642218.235%5Ev38%5Epc_relevant_sort_base3&amp;utm_relevant_index=1">Shellã€Bashã€Zshè¿™éƒ½æ˜¯å•¥å•Š</a></p>
]]></content>
      <categories>
        <category>å‘½ä»¤è¡Œ</category>
      </categories>
      <tags>
        <tag>ç›®å½•å‘½ä»¤</tag>
      </tags>
  </entry>
  <entry>
    <title>OCå¯¹è±¡å†…å­˜å¸ƒå±€</title>
    <url>/2023/05/18/OC%E5%AF%B9%E8%B1%A1%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80/</url>
    <content><![CDATA[<h2 id="OCå¯¹è±¡çš„å†…å­˜å¸ƒå±€"><a href="#OCå¯¹è±¡çš„å†…å­˜å¸ƒå±€" class="headerlink" title="OCå¯¹è±¡çš„å†…å­˜å¸ƒå±€"></a>OCå¯¹è±¡çš„å†…å­˜å¸ƒå±€</h2><p>å¦‚ä¸‹å›¾</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/%E6%88%AA%E5%B1%8F2023-05-18%2022.18.30.png" style="zoom:50%;" /></p>
<p>æ³¨ï¼šå­ç±»å¯ä»¥æ‹¥æœ‰å’Œçˆ¶ç±»åŒåçš„å®ä¾‹å˜é‡ï¼Œå®ƒä»¬æ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚</p>
<p>isaå ç”¨8ä¸ªå­—èŠ‚ï¼Œæ˜¯æ‰€æœ‰å¯¹è±¡éƒ½æ‹¥æœ‰çš„ã€‚OCå¯¹è±¡æœ€å°‘å ç”¨16å­—èŠ‚ï¼Œä¸€äº›å¯¹è±¡å¯èƒ½å®é™…åªä½¿ç”¨äº†8ä¸ªå­—èŠ‚ï¼Œä½†ç³»ç»Ÿåœ¨åˆ†é…å†…å­˜æ—¶ä¼šè¡¥è¶³åˆ°16å­—èŠ‚ã€‚isaçš„offsetæ˜¯0ï¼Œç„¶åæŒ‰ç…§å†…å­˜å¯¹é½è§„åˆ™ï¼Œoffsetä¸€ç›´å¢åŠ ä¸‹å»ã€‚</p>
<p>ç”±äºå†…å­˜å¯¹é½çš„åŸå› ï¼Œå®ä¾‹å˜é‡åœ¨å†…å­˜ä¸­çš„é¡ºåºå¯èƒ½ä¼šå’Œæˆ‘ä»¬çš„ä¹¦å†™é¡ºåºä¸ä¸€è‡´ã€‚ä¸ªäººçŒœæµ‹ï¼šç¼–è¯‘å™¨ä¼šå°½é‡å’Œä¹¦å†™é¡ºåºä¸€è‡´ï¼Œå†æŒ‰ç…§å†…å­˜å¯¹é½è§„åˆ™è°ƒæ•´ã€‚ï¼ˆæ‰€ä»¥æœ€å¥½å°±åˆ«çŒœå®ä¾‹å˜é‡çš„é¡ºåºäº†ï¼‰</p>
<p>å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‡½æ•°æ‰“å°offsetï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> NSUInteger <span class="title function_">FBGetMinimumIvarIndex</span><span class="params">(__unsafe_unretained Class aCls)</span> &#123;</span><br><span class="line">    NSUInteger minimumIndex = <span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> count;</span><br><span class="line">    Ivar *ivars = class_copyIvarList(aCls, &amp;count);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        Ivar ivar = ivars[<span class="number">0</span>];</span><br><span class="line">        <span class="type">ptrdiff_t</span> offset = ivar_getOffset(ivar);</span><br><span class="line">        minimumIndex = offset / (<span class="keyword">sizeof</span>(<span class="type">void</span> *));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        Ivar ivar = ivars[i];</span><br><span class="line">        <span class="type">ptrdiff_t</span> offset = ivar_getOffset(ivar);</span><br><span class="line">        NSUInteger index = offset / (<span class="keyword">sizeof</span>(<span class="type">void</span> *));</span><br><span class="line">        NSLog(@<span class="string">&quot;ivar:%s,offset:%td,index:%lu&quot;</span>, ivar_getName(ivar), offset, index);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(ivars);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> minimumIndex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç±»ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">FDEDog</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="type">id</span> property_1_s;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="type">id</span> property_2_w;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">unsafe_unretained</span>) <span class="type">id</span> property_3_un;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="type">id</span> property_4_w;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="type">id</span> property_5_s;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="type">id</span> property_6_s;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">unsafe_unretained</span>) <span class="type">id</span> property_7_un;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="type">id</span> property_8_s;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="type">id</span> property_9_s;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="type">id</span> property_10_w;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="type">id</span> property_11_w;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="type">id</span> property_12_s;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="type">int</span> property_13_int;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="type">short</span> property_14_short;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="type">id</span> property_15_w;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="type">char</span> property_16_char;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="type">id</span> property_17_s;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>æ‰“å°ï¼š</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">2023</span>-<span class="number">07</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">23</span>.<span class="number">758865</span>+<span class="number">0800</span> MLeaksFinderDemo[<span class="number">26862</span>:<span class="number">7944628</span>] ivar:_property_16_char,offset:<span class="number">8</span>,index:<span class="number">1</span></span><br><span class="line"><span class="attribute">2023</span>-<span class="number">07</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">23</span>.<span class="number">758907</span>+<span class="number">0800</span> MLeaksFinderDemo[<span class="number">26862</span>:<span class="number">7944628</span>] ivar:_property_14_short,offset:<span class="number">10</span>,index:<span class="number">1</span></span><br><span class="line"><span class="attribute">2023</span>-<span class="number">07</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">23</span>.<span class="number">758948</span>+<span class="number">0800</span> MLeaksFinderDemo[<span class="number">26862</span>:<span class="number">7944628</span>] ivar:_property_13_int,offset:<span class="number">12</span>,index:<span class="number">1</span></span><br><span class="line"><span class="attribute">2023</span>-<span class="number">07</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">23</span>.<span class="number">758978</span>+<span class="number">0800</span> MLeaksFinderDemo[<span class="number">26862</span>:<span class="number">7944628</span>] ivar:_property_1_s,offset:<span class="number">16</span>,index:<span class="number">2</span></span><br><span class="line"><span class="attribute">2023</span>-<span class="number">07</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">23</span>.<span class="number">759014</span>+<span class="number">0800</span> MLeaksFinderDemo[<span class="number">26862</span>:<span class="number">7944628</span>] ivar:_property_2_w,offset:<span class="number">24</span>,index:<span class="number">3</span></span><br><span class="line"><span class="attribute">2023</span>-<span class="number">07</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">23</span>.<span class="number">759049</span>+<span class="number">0800</span> MLeaksFinderDemo[<span class="number">26862</span>:<span class="number">7944628</span>] ivar:_property_3_un,offset:<span class="number">32</span>,index:<span class="number">4</span></span><br><span class="line"><span class="attribute">2023</span>-<span class="number">07</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">23</span>.<span class="number">759077</span>+<span class="number">0800</span> MLeaksFinderDemo[<span class="number">26862</span>:<span class="number">7944628</span>] ivar:_property_4_w,offset:<span class="number">40</span>,index:<span class="number">5</span></span><br><span class="line"><span class="attribute">2023</span>-<span class="number">07</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">23</span>.<span class="number">759105</span>+<span class="number">0800</span> MLeaksFinderDemo[<span class="number">26862</span>:<span class="number">7944628</span>] ivar:_property_5_s,offset:<span class="number">48</span>,index:<span class="number">6</span></span><br><span class="line"><span class="attribute">2023</span>-<span class="number">07</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">23</span>.<span class="number">759134</span>+<span class="number">0800</span> MLeaksFinderDemo[<span class="number">26862</span>:<span class="number">7944628</span>] ivar:_property_6_s,offset:<span class="number">56</span>,index:<span class="number">7</span></span><br><span class="line"><span class="attribute">2023</span>-<span class="number">07</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">23</span>.<span class="number">759160</span>+<span class="number">0800</span> MLeaksFinderDemo[<span class="number">26862</span>:<span class="number">7944628</span>] ivar:_property_7_un,offset:<span class="number">64</span>,index:<span class="number">8</span></span><br><span class="line"><span class="attribute">2023</span>-<span class="number">07</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">23</span>.<span class="number">759191</span>+<span class="number">0800</span> MLeaksFinderDemo[<span class="number">26862</span>:<span class="number">7944628</span>] ivar:_property_8_s,offset:<span class="number">72</span>,index:<span class="number">9</span></span><br><span class="line"><span class="attribute">2023</span>-<span class="number">07</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">23</span>.<span class="number">759256</span>+<span class="number">0800</span> MLeaksFinderDemo[<span class="number">26862</span>:<span class="number">7944628</span>] ivar:_property_9_s,offset:<span class="number">80</span>,index:<span class="number">10</span></span><br><span class="line"><span class="attribute">2023</span>-<span class="number">07</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">23</span>.<span class="number">759309</span>+<span class="number">0800</span> MLeaksFinderDemo[<span class="number">26862</span>:<span class="number">7944628</span>] ivar:_property_10_w,offset:<span class="number">88</span>,index:<span class="number">11</span></span><br><span class="line"><span class="attribute">2023</span>-<span class="number">07</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">23</span>.<span class="number">759392</span>+<span class="number">0800</span> MLeaksFinderDemo[<span class="number">26862</span>:<span class="number">7944628</span>] ivar:_property_11_w,offset:<span class="number">96</span>,index:<span class="number">12</span></span><br><span class="line"><span class="attribute">2023</span>-<span class="number">07</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">23</span>.<span class="number">759458</span>+<span class="number">0800</span> MLeaksFinderDemo[<span class="number">26862</span>:<span class="number">7944628</span>] ivar:_property_12_s,offset:<span class="number">104</span>,index:<span class="number">13</span></span><br><span class="line"><span class="attribute">2023</span>-<span class="number">07</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">23</span>.<span class="number">759509</span>+<span class="number">0800</span> MLeaksFinderDemo[<span class="number">26862</span>:<span class="number">7944628</span>] ivar:_property_15_w,offset:<span class="number">112</span>,index:<span class="number">14</span></span><br><span class="line"><span class="attribute">2023</span>-<span class="number">07</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">18</span>:<span class="number">23</span>.<span class="number">759583</span>+<span class="number">0800</span> MLeaksFinderDemo[<span class="number">26862</span>:<span class="number">7944628</span>] ivar:_property_17_s,offset:<span class="number">120</span>,index:<span class="number">15</span></span><br></pre></td></tr></table></figure>
<p>å¦ï¼šè¿™é‡Œçš„indexæ˜¯8å­—èŠ‚çš„ç´¢å¼•ã€‚ä»0ä¸€ç›´åˆ°15ï¼Œæ€»å…±16ä¸ªï¼Œ16*8=128ï¼Œä¹Ÿæ˜¯FDEDogå®ä¾‹çš„å¤§å°ã€‚</p>
<h2 id="isaç»“æ„ä½“å­—æ®µéªŒè¯"><a href="#isaç»“æ„ä½“å­—æ®µéªŒè¯" class="headerlink" title="isaç»“æ„ä½“å­—æ®µéªŒè¯"></a>isaç»“æ„ä½“å­—æ®µéªŒè¯</h2><p>isaå®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">isa_t</span> &#123;</span></span><br><span class="line">    <span class="type">isa_t</span>() &#123; &#125;</span><br><span class="line">    <span class="type">isa_t</span>(<span class="type">uintptr_t</span> value) : bits(value) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    Class cls; <span class="comment">//ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘objc_classç»“æ„ä½“ã€‚è¿™æ ·å°±å¯ä»¥å…¼å®¹æ—§ç‰ˆæœ¬ã€‚</span></span><br><span class="line">    <span class="type">uintptr_t</span> bits;</span><br><span class="line">    <span class="comment">//è¿™é‡Œå±•å¼€çš„æ˜¯arm64çš„</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="type">uintptr_t</span> nonpointer        : <span class="number">1</span>; <span class="comment">//LSBã€‚0 is raw isa, 1 is non-pointer isa.                                      </span></span><br><span class="line">      	<span class="type">uintptr_t</span> has_assoc         : <span class="number">1</span>; <span class="comment">//å¯¹è±¡æ˜¯å¦æœ‰å…³è”å¯¹è±¡                                      </span></span><br><span class="line">        <span class="type">uintptr_t</span> has_cxx_dtor      : <span class="number">1</span>; <span class="comment">//å¯¹è±¡æ˜¯å¦æœ‰C++æˆ–ARCææ„å‡½æ•°                                      </span></span><br><span class="line">        <span class="type">uintptr_t</span> shiftcls          : <span class="number">33</span>; <span class="comment">/*MACH_VM_MAX_ADDRESS 0x1000000000*/</span> <span class="comment">//Classåœ°å€ã€‚</span></span><br><span class="line">        <span class="type">uintptr_t</span> magic             : <span class="number">6</span>;  <span class="comment">//ä¸€ä¸ªé­”æ³•æ•°ã€‚ç”¨äºåŒºåˆ†æ˜¯å¦åˆå§‹åŒ–                                     </span></span><br><span class="line">        <span class="type">uintptr_t</span> weakly_referenced : <span class="number">1</span>;  <span class="comment">//æ˜¯å¦æœ‰å¼±å¼•ç”¨æŒ‡é’ˆã€‚                                      </span></span><br><span class="line">        <span class="type">uintptr_t</span> deallocating      : <span class="number">1</span>; <span class="comment">//æ˜¯å¦æ­£åœ¨è¢«é”€æ¯                                      </span></span><br><span class="line">        <span class="type">uintptr_t</span> has_sidetable_rc  : <span class="number">1</span>; <span class="comment">//æ˜¯å¦æœ‰sidetableå¼•ç”¨è®¡æ•°ã€‚å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å¤ªå¤§è€Œä¸èƒ½åœ¨å†…éƒ¨ä¿å­˜æ—¶ä¼šå°†å¼•ç”¨è®¡æ•°ä¿å­˜åˆ°sidetable                                      </span></span><br><span class="line">        <span class="type">uintptr_t</span> extra_rc          : <span class="number">19</span> <span class="comment">//MSBã€‚å¯¹è±¡çš„å¼•ç”¨è®¡æ•°è¶…è¿‡1æ—¶ä¼šå­˜åœ¨è¿™é‡Œã€‚å› æ­¤extra_rcåŠ 1åæ‰æ˜¯å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚ç”±äºåªæœ‰19ä½æ‰€ä»¥åªæœ‰å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸å¤ªå¤§çš„æ—¶å€™æ‰ä¿å­˜åœ¨è¿™é‡Œ</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ä»£ç :</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Car</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="type">int</span> mileage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Truck</span> : <span class="title">Car</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="type">int</span> loadCap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)test_obj_memory_layout &#123;</span><br><span class="line">    Truck *truck = [[Truck alloc] init];</span><br><span class="line">    truck.loadCap = <span class="number">10</span>;</span><br><span class="line">    truck.mileage = <span class="number">24</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;truck:%@, cls:%@,%p&quot;</span>, truck, truck.class, truck.class);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;class_getInstanceSize([NSObject class]) = %zd&quot;</span>, class_getInstanceSize([<span class="built_in">NSObject</span> <span class="keyword">class</span>]));</span><br><span class="line">    <span class="comment">//è·å–å¯¹è±¡å®é™…ä½¿ç”¨çš„å†…å­˜å¤§å°&lt;=ç³»ç»Ÿå®é™…åˆ†é…çš„å†…å­˜å¤§å°</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;class_getInstanceSize([Truck class]) = %zd&quot;</span>, class_getInstanceSize([Truck <span class="keyword">class</span>]));</span><br><span class="line">    <span class="comment">//è·å–ç³»ç»Ÿå®é™…åˆ†é…çš„å†…å­˜å¤§å°ã€‚</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;malloc_size = %zd&quot;</span>, malloc_size((__bridge <span class="keyword">const</span> <span class="type">void</span> *)(truck)));</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;sizeof(truck) = %zd, sizeof(Truck *):%lu&quot;</span>, <span class="keyword">sizeof</span>(truck), <span class="keyword">sizeof</span>(Truck *));</span><br><span class="line">  	<span class="comment">//sizeof(truck)å’Œsizeof(Truck *)æ˜¯ç­‰ä»·çš„ï¼Œæ‰€ä»¥éƒ½æ˜¯8.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å›¾1ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/%E6%88%AA%E5%B1%8F2023-05-18%2021.41.17.png" style="zoom:50%;" /></p>
<p>åˆ†æï¼šå‰å…«ä¸ªå­—èŠ‚æ˜¯isaçš„å€¼ï¼Œç¬¬3ä¸ª4å­—èŠ‚æ˜¯mileageå­—æ®µçš„å€¼ï¼Œç¬¬4ä¸ª4å­—èŠ‚æ˜¯loadCapå­—æ®µçš„å€¼ã€‚ç”±äºæ˜¯å°ç«¯å­˜å‚¨ï¼Œä¸ºäº†æ–¹ä¾¿è½¬åŒ–ä¸ºå¤§ç«¯ï¼ˆè¿™é‡Œä»…è½¬æ¢isaçš„å€¼ï¼‰</p>
<figure class="highlight excel"><table><tr><td class="code"><pre><span class="line"><span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">04</span> <span class="number">2</span>B <span class="number">51</span> <span class="number">09</span></span><br><span class="line">=&gt;äºŒè¿›åˆ¶</span><br><span class="line"><span class="number">0000</span> <span class="number">0001</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">000</span>,<span class="number">0</span> <span class="number">00</span>,<span class="number">00</span> <span class="number">0000</span>, <span class="number">0001</span> <span class="number">04</span> <span class="number">2</span>B <span class="number">51</span> <span class="number">0000</span> <span class="number">1</span>,<span class="number">001</span></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>x1042b5108 -- <span class="number">4</span>*<span class="number">8</span>+<span class="number">1</span> = <span class="number">33</span> //è¿™å°±æ˜¯ç±»å¯¹è±¡çš„åœ°å€ï¼Œå’Œæ‰“å°ä¸€è‡´ã€‚</span><br><span class="line"><span class="symbol">1:no</span><span class="built_in">n</span>-pointer isa.æœ€åä¸€ä½ä¸º<span class="number">1</span>è¯´æ˜æ˜¯non-pointer isaã€‚</span><br><span class="line">å½“å‰å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å­˜å‚¨åœ¨isaé‡Œï¼Œå¼•ç”¨è®¡æ•°å€¼ä¸º<span class="number">1</span>.</span><br></pre></td></tr></table></figure>
<p>å¼•ç”¨è®¡æ•°å ç”¨19ä½ï¼Œå®é™…ä½¿ç”¨æ—¶åˆåˆ†ä¸ºä¸¤æ®µã€‚</p>
<p>è¿›ä¸€æ­¥æµ‹è¯•ï¼Œå¢åŠ ä¸¤ä¸ªå¼ºå¼•ç”¨æŒ‡é’ˆptr1ï¼Œptr2æŒ‡å‘å¯¹è±¡ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)test_obj_memory_layout &#123;</span><br><span class="line">    Truck *truck = [[Truck alloc] init];</span><br><span class="line">    truck.loadCap = <span class="number">10</span>;</span><br><span class="line">    truck.mileage = <span class="number">24</span>;</span><br><span class="line">    </span><br><span class="line">    Truck *ptr1 = truck;</span><br><span class="line">    Truck *ptr2 = truck;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;truck:%@, cls:%@,%p&quot;</span>, truck, truck.class, truck.class);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;class_getInstanceSize([NSObject class]) = %zd&quot;</span>, class_getInstanceSize([<span class="built_in">NSObject</span> <span class="keyword">class</span>]));</span><br><span class="line">    <span class="comment">//è·å–å¯¹è±¡å®é™…ä½¿ç”¨çš„å†…å­˜å¤§å°&lt;=ç³»ç»Ÿå®é™…åˆ†é…çš„å†…å­˜å¤§å°</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;class_getInstanceSize([Truck class]) = %zd&quot;</span>, class_getInstanceSize([Truck <span class="keyword">class</span>]));</span><br><span class="line">    <span class="comment">//è·å–ç³»ç»Ÿå®é™…åˆ†é…çš„å†…å­˜å¤§å°ã€‚</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;malloc_size = %zd&quot;</span>, malloc_size((__bridge <span class="keyword">const</span> <span class="type">void</span> *)(truck)));</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;sizeof(truck) = %zd, sizeof(Truck *):%lu&quot;</span>, <span class="keyword">sizeof</span>(truck), <span class="keyword">sizeof</span>(Truck *));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å›¾2ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/%E6%88%AA%E5%B1%8F2023-05-18%2022.05.25.png" style="zoom:50%;" /></p>
<p>åˆ†æï¼šå‰å…«ä¸ªå­—èŠ‚æ˜¯isaçš„å€¼ï¼Œç”±äºæ˜¯å°ç«¯å­˜å‚¨ï¼Œä¸ºäº†æ–¹ä¾¿è½¬åŒ–ä¸ºå¤§ç«¯</p>
<figure class="highlight excel"><table><tr><td class="code"><pre><span class="line"><span class="number">03</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="symbol">D9</span> <span class="number">91</span> <span class="number">09</span></span><br><span class="line">=&gt;äºŒè¿›åˆ¶</span><br><span class="line"><span class="number">0000</span> <span class="number">0011</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">000</span>,<span class="number">0</span> <span class="number">00</span>,<span class="number">00</span> <span class="number">0000</span>, <span class="number">0001</span> <span class="number">00</span> <span class="symbol">D9</span> <span class="number">91</span> <span class="number">0000</span> <span class="number">1</span>,<span class="number">001</span></span><br><span class="line"></span><br><span class="line"><span class="number">0</span>x100d99108 -- <span class="number">4</span>*<span class="number">8</span>+<span class="number">1</span> = <span class="number">33</span></span><br><span class="line"><span class="symbol">1:no</span><span class="built_in">n</span>-pointer isa.æœ€åä¸€ä½ä¸º<span class="number">1</span>è¯´æ˜æ˜¯non-pointer isaã€‚</span><br><span class="line">å½“å‰å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å­˜å‚¨åœ¨isaé‡Œï¼Œå¼•ç”¨è®¡æ•°å€¼ä¸º<span class="number">3</span>.</span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://cloud.tencent.com/developer/article/1560419">ã€Œç±»ä¸å¯¹è±¡ã€å¦‚ä½•å‡†ç¡®è·å–å¯¹è±¡çš„å†…å­˜å¤§å°ï¼Ÿ</a></p>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
      <tags>
        <tag>å†…å­˜å¸ƒå±€</tag>
      </tags>
  </entry>
  <entry>
    <title>iOSè¾“å…¥è¾“å‡ºæµ</title>
    <url>/2023/05/14/iOS%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E6%B5%81/</url>
    <content><![CDATA[<p>æµå¼è¯»å†™æ•°æ®ï¼Œæ‰€è°“æµå¼å°±æ˜¯åƒå°æºªæµä¸€æ ·ç»†æ°´é•¿æµé¿å…å³°å€¼å½±å“ã€‚å®ƒå¯ä»¥è®©ä½ é¿å…ä¸€æ¬¡æ€§å°†æ•°æ®åŠ è½½åˆ°å†…å­˜ï¼Œä»è€Œå¯¼è‡´å†…å­˜æš´æ¶¨ã€‚æ¯”å¦‚æ’­æ”¾ä¸€ä¸ªæœ¬åœ°è§†é¢‘æ–‡ä»¶ï¼Œä½ ä¸éœ€è¦å…ˆå°†æ•´ä¸ªè§†é¢‘éƒ½åŠ è½½åˆ°å†…å­˜å†æ’­æ”¾ï¼Œè€Œæ˜¯è¯»å–ä¸€æ®µæ’­æ”¾ä¸€æ®µã€‚</p>
<p>ç³»ç»Ÿæä¾›äº†ä¸¤ä¸ªå­ç±»NSInputStreamå’ŒNSOutputStreamç”¨äºæµå¼å¤„ç†ã€‚NSInputStreamç”¨äºæµå¼è¯»å–æ•°æ®ï¼ŒNSOutputStreamç”¨äºæµå¼å†™å…¥æ•°æ®ã€‚</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/stream_src_dest.gif" alt=""></p>
<h2 id="NSInputStream"><a href="#NSInputStream" class="headerlink" title="NSInputStream"></a>NSInputStream</h2><p>è¾“å…¥æµï¼ŒæŒ‰æ¬¡åºä»ä»“åº“è¯»å–æ•°æ®ã€‚è¿™ä¸ªä»“åº“å¯ä»¥æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªNSDataå¯¹è±¡æˆ–è€…æ˜¯ä¸€ä¸ªç½‘ç»œsocketã€‚æ³¨æ„ï¼šç½‘ç»œsocketè¾“å…¥æµå’Œå‰é¢ä¸¤ç§è¾“å…¥æµçš„åˆå§‹åŒ–æ­¥éª¤æ˜¯ä¸ä¸€æ ·çš„ã€‚</p>
<p>å› ä¸ºæ˜¯è¯»æ•°æ®ï¼Œæ‰€ä»¥ä»“åº“å¿…é¡»å­˜åœ¨ï¼Œæ¯”å¦‚å¦‚æœä»“åº“æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œåˆ™è¯¥æ–‡ä»¶å¿…é¡»å­˜åœ¨ï¼Œå¦åˆ™ä¼šæ‰“å¼€å¤±è´¥æå‡ï¼š</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">è¯»é”™è¯¯ï¼š<span class="built_in">Error</span> <span class="attribute">Domain</span>=NSPOSIXErrorDomain <span class="attribute">Code</span>=2 <span class="string">&quot;No such file or directory&quot;</span> UserInfo=&#123;<span class="attribute">_kCFStreamErrorCodeKey</span>=2, <span class="attribute">_kCFStreamErrorDomainKey</span>=1&#125;</span><br></pre></td></tr></table></figure>
<p>read:maxLength:</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">NSInteger</span>)read:(uint8_t *)buffer maxLength:(<span class="built_in">NSUInteger</span>)len;</span><br><span class="line">    <span class="comment">// reads up to length bytes into the supplied buffer, which must be at least of size len. Returns the actual number of bytes read.</span></span><br></pre></td></tr></table></figure>
<p>è¿”å›å€¼è¯´æ˜ï¼š</p>
<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line">A <span class="built_in">number</span> indicating <span class="keyword">the</span> outcome <span class="keyword">of</span> <span class="keyword">the</span> operation:</span><br><span class="line">A positive <span class="built_in">number</span> indicates <span class="keyword">the</span> <span class="built_in">number</span> <span class="keyword">of</span> <span class="keyword">bytes</span> <span class="built_in">read</span>.</span><br><span class="line"><span class="number">0</span> indicates that <span class="keyword">the</span> <span class="function"><span class="keyword">end</span> <span class="title">of</span> <span class="title">the</span> <span class="title">buffer</span> <span class="title">was</span> <span class="title">reached</span>.</span></span><br><span class="line"><span class="number">-1</span> means that <span class="keyword">the</span> operation failed; more information about <span class="keyword">the</span> error can be obtained <span class="keyword">with</span> streamError.</span><br></pre></td></tr></table></figure>
<p>ä¸€ä¸ªæ­£æ•°è¡¨ç¤ºè¯»å–äº†å¤šå°‘å­—èŠ‚ã€‚0è¡¨ç¤ºå¾…è¯»å–çš„æ•°æ®å·²ç»åˆ°äº†ç»“å°¾ï¼Œæ²¡æœ‰å¾…è¯»å–çš„æ•°æ®äº†ã€‚-1è¡¨ç¤ºè¯»å–å‡ºé”™ã€‚</p>
<h2 id="NSOutputStream"><a href="#NSOutputStream" class="headerlink" title="NSOutputStream"></a>NSOutputStream</h2><p>è¾“å‡ºæµï¼ŒæŒ‰æ¬¡åºå†™å…¥æ•°æ®åˆ°ä¸€ä¸ªä»“åº“ã€‚è¿™ä¸ªä»“åº“å¯ä»¥æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªC bufferï¼Œåº”ç”¨çš„å†…å­˜ï¼Œæˆ–è€…ä¸€ä¸ªç½‘ç»œsocketã€‚æ³¨æ„ï¼šç½‘ç»œsocketè¾“å‡ºæµå’Œå‰é¢ä¸‰ç§è¾“å‡ºæµçš„åˆå§‹åŒ–æ­¥éª¤æ˜¯ä¸ä¸€æ ·çš„ã€‚</p>
<p>å¦‚æœä»“åº“æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œæ‰“å¼€æµåç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºè¯¥æ–‡ä»¶ã€‚</p>
<p>write:maxLength:</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line">- (NSInteger)write:(<span class="type">const</span> <span class="type">uint8_t</span> *)buffer maxLength:(NSUInteger)len;</span><br><span class="line">    <span class="comment">// writes the bytes from the specified buffer to the stream up to len bytes. Returns the number of bytes actually written.</span></span><br></pre></td></tr></table></figure>
<p>è¿”å›å€¼è¯´æ˜ï¼š</p>
<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line">A <span class="built_in">number</span> indicating <span class="keyword">the</span> outcome <span class="keyword">of</span> <span class="keyword">the</span> operation:</span><br><span class="line">A positive <span class="built_in">number</span> indicates <span class="keyword">the</span> <span class="built_in">number</span> <span class="keyword">of</span> <span class="keyword">bytes</span> written.</span><br><span class="line"><span class="number">0</span> indicates that <span class="keyword">a</span> fixed-<span class="built_in">length</span> stream <span class="keyword">and</span> has reached its capacity.</span><br><span class="line"><span class="number">-1</span> means that <span class="keyword">the</span> operation failed; more information about <span class="keyword">the</span> error can be obtained <span class="keyword">with</span> streamError.</span><br></pre></td></tr></table></figure>
<p>ä¸€ä¸ªæ­£æ•°è¡¨ç¤ºå†™å…¥äº†å¤šå°‘å­—èŠ‚ã€‚0è¡¨ç¤ºå¾…å†™å…¥çš„æ•°æ®å·²ç»åˆ°äº†ç»“å°¾ï¼Œæ²¡æœ‰å¾…å†™å…¥çš„æ•°æ®äº†ã€‚-1è¡¨ç¤ºå†™å…¥å‡ºé”™ã€‚</p>
<h2 id="æµçš„äº‹ä»¶"><a href="#æµçš„äº‹ä»¶" class="headerlink" title="æµçš„äº‹ä»¶"></a>æµçš„äº‹ä»¶</h2><figure class="highlight elm"><table><tr><td class="code"><pre><span class="line">typedef <span class="type">NS_OPTIONS</span>(<span class="type">NSUInteger</span>, <span class="type">NSStreamEvent</span>) &#123;</span><br><span class="line">    <span class="type">NSStreamEventNone</span> = 0,</span><br><span class="line">    <span class="type">NSStreamEventOpenCompleted</span> = 1UL &lt;&lt; 0,</span><br><span class="line">    <span class="type">NSStreamEventHasBytesAvailable</span> = 1UL &lt;&lt; 1,</span><br><span class="line">    <span class="type">NSStreamEventHasSpaceAvailable</span> = 1UL &lt;&lt; 2,</span><br><span class="line">    <span class="type">NSStreamEventErrorOccurred</span> = 1UL &lt;&lt; 3,</span><br><span class="line">    <span class="type">NSStreamEventEndEncountered</span> = 1UL &lt;&lt; 4</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>NSStreamEventOpenCompletedï¼šæµæ‰“å¼€å®Œæˆã€‚</p>
<p>NSStreamEventHasBytesAvailableï¼šæœ‰æ•°æ®å¯è¯»å–ã€‚</p>
<p>NSStreamEventHasSpaceAvailableï¼šæœ‰ç©ºé—´å¯å†™å…¥ã€‚</p>
<p>NSStreamEventErrorOccurredï¼šè¯»å–æµå‡ºç°é”™è¯¯ã€‚</p>
<p>NSStreamEventEndEncounteredï¼šè¯»å–æµç»“æŸã€‚</p>
<p>æµå‘ç”Ÿé”™è¯¯æˆ–è€…æµå·²ç»ç»“æŸæˆ–è€…æµå·²ç»å…³é—­ï¼Œè¿™ä¸ªæµå°±ä¸èƒ½ç»§ç»­ä½¿ç”¨äº†ï¼Œä¸èƒ½å†è¯»æˆ–å†å†™ï¼Œåªèƒ½é‡æ–°åˆ›å»ºã€‚</p>
<h2 id="pollingè½®è¯¢-VS-runloopè°ƒåº¦"><a href="#pollingè½®è¯¢-VS-runloopè°ƒåº¦" class="headerlink" title="pollingè½®è¯¢ VS runloopè°ƒåº¦"></a>pollingè½®è¯¢ VS runloopè°ƒåº¦</h2><p>æœ‰ä¸¤ç§æ–¹å¼è·å–æµäº‹ä»¶å‘ç”Ÿï¼Œä¸€ç§æ˜¯è½®è¯¢ï¼Œä¸€ç§æ˜¯äº‹ä»¶ç›‘å¬ã€‚æ¯”å¦‚æµå¼è¯»å–æ•°æ®ï¼Œå¯èƒ½è¿™ä¸ªæ•°æ®çš„äº§ç”Ÿæ˜¯éšæœºçš„ï¼Œä½ ä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™ä¼šæœ‰æ•°æ®å¯è¯»ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿæœ€ç®€å•çš„åŠæ³•å°±æ˜¯ä¸æ–­åœ°æŸ¥è¯¢æ˜¯å¦æœ‰æ•°æ®ï¼Œè¿™ç§æ–¹å¼è™½ç„¶æœ‰æ•ˆä½†æ— ç–‘æ˜¯å¯¹CPUçš„æå¤§æµªè´¹ã€‚å¦ä¸€ç§åŠæ³•å°±æ˜¯äº‹ä»¶ç›‘å¬ï¼Œå°†æµç»‘å®šåˆ°ä¸€ä¸ªçº¿ç¨‹çš„runloopï¼Œè¿™æ ·å½“æœ‰æµäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä»£ç†æ–¹æ³•å°±ä¼šè¢«å›è°ƒï¼Œæ²¡æœ‰äº‹ä»¶å‘ç”Ÿæ—¶runloopä¼šè¿›å…¥ç¡çœ ã€‚</p>
<p>psï¼šè™½ç„¶è½®è¯¢çœ‹èµ·æ¥å¥½åƒä¸å¤ªè¡Œçš„æ ·å­ï¼Œä½†æ˜¯å¦‚æœæµæ˜¯ç¡®å®šçš„ï¼Œä½¿ç”¨è½®è¯¢ä¹Ÿæœªå°ä¸å¯ã€‚</p>
<p>è½®è¯¢ç¤ºä¾‹ï¼šå°†æ•°æ®æµå¼å†™å…¥åˆ°å†…å­˜ï¼Œå†è¯»å–å‡ºæ¥ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)test_outputStream_to_memory &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *filePath = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@&quot;share_qq_icon&quot;</span> ofType:<span class="string">@&quot;png&quot;</span>];</span><br><span class="line">    <span class="built_in">NSData</span> *imgData = [<span class="built_in">NSData</span> dataWithContentsOfFile:filePath];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSOutputStream</span> *outputStream = [[<span class="built_in">NSOutputStream</span> alloc] initToMemory];</span><br><span class="line">    [outputStream open];</span><br><span class="line">    </span><br><span class="line">    uint8_t *buffer = (uint8_t *)[imgData bytes];</span><br><span class="line">    <span class="built_in">NSInteger</span> totalLength = imgData.length;</span><br><span class="line">    <span class="built_in">NSInteger</span> totalWrite = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">NSInteger</span> currentWrite = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (totalWrite &gt;= totalLength) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ([outputStream hasSpaceAvailable]) &#123;</span><br><span class="line">            <span class="comment">//ä¸€æ¬¡æ€§å†™å®Œ</span></span><br><span class="line"><span class="comment">//            currWriteLen = [outputStream write:&amp;buffer[totalWrite] maxLength:totalLen - totalWrite];</span></span><br><span class="line">            <span class="comment">//writeStepä¸èƒ½æ˜¯ä¸€ä¸ªå›ºå®šå€¼æ¯”å¦‚512ï¼Œå¦åˆ™åªè¦streamè¿˜æœ‰ç©ºé—´å°±ä¼šä¸€ç›´å†™ï¼Œè¶…å‡ºbufferèŒƒå›´åè¿˜ä¼šä¸€ç›´å¾€åè¯»å‡ºæ¥ï¼Œè¶…å‡ºçš„éƒ½æ˜¯åƒåœ¾æ•°æ®äº†ã€‚</span></span><br><span class="line">            <span class="built_in">NSInteger</span> writeStep = MIN(totalLength - totalWrite, <span class="number">256</span>);</span><br><span class="line"><span class="comment">//            currWriteLen = [outputStream write:buffer maxLength:writeStep]; //é”™è¯¯ã€‚æ¯æ¬¡å†™çš„éƒ½æ˜¯bufferçš„ç¬¬ä¸€æ®µ</span></span><br><span class="line">            <span class="comment">//å†™å®Œä¸€æ®µåéœ€è¦ç§»åŠ¨ä½ç½®ï¼Œå¦åˆ™æ¯æ¬¡å†™çš„éƒ½æ˜¯bufferçš„ç¬¬ä¸€æ®µã€‚</span></span><br><span class="line">            currentWrite = [outputStream write:&amp;buffer[totalWrite] maxLength:writeStep];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (currentWrite == <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@&quot;å†™å…¥å‡ºé”™ï¼š%@&quot;</span>, outputStream.streamError);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@&quot;å†™å…¥æ•°æ®é•¿åº¦ï¼š%ld&quot;</span>, currentWrite);</span><br><span class="line">                totalWrite += currentWrite;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSData</span> *pdata = [outputStream propertyForKey:<span class="built_in">NSStreamDataWrittenToMemoryStreamKey</span>];</span><br><span class="line">    [outputStream close];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UIImage</span> *img = [<span class="built_in">UIImage</span> imageWithData:pdata];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;img = %@&quot;</span>, img);</span><br><span class="line">    <span class="built_in">UIImageView</span> *imgView = [<span class="keyword">self</span>.view viewWithTag:<span class="number">1002</span>];</span><br><span class="line">    <span class="keyword">if</span> (imgView == <span class="literal">nil</span>) &#123;</span><br><span class="line">        imgView = [[<span class="built_in">UIImageView</span> alloc] initWithImage:img];</span><br><span class="line">        imgView.tag = <span class="number">1002</span>;</span><br><span class="line">        imgView.frame = <span class="built_in">CGRectMake</span>(<span class="number">100</span>, <span class="number">100</span>, <span class="number">100</span>, <span class="number">100</span> * img.size.height / img.size.width);</span><br><span class="line">        [<span class="keyword">self</span>.view addSubview:imgView];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„åœ°æ–¹æœ‰ä¸¤ä¸ªï¼š</p>
<ol>
<li>writeStepä¸èƒ½æ˜¯ä¸€ä¸ªå›ºå®šå€¼æ¯”å¦‚512ï¼Œå¦åˆ™åªè¦streamè¿˜æœ‰ç©ºé—´å°±ä¼šä¸€ç›´å†™ï¼Œè¶…å‡ºbufferèŒƒå›´åè¿˜ä¼šä¸€ç›´å¾€åè¯»å‡ºæ¥ï¼Œè¶…å‡ºçš„éƒ½æ˜¯åƒåœ¾æ•°æ®äº†ã€‚writeStepåˆ°åé¢è‚¯å®šæ˜¯0ã€‚</li>
<li>å†™å®Œä¸€æ®µåéœ€è¦ç§»åŠ¨ä½ç½®ï¼Œå¦åˆ™æ¯æ¬¡å†™çš„éƒ½æ˜¯bufferçš„ç¬¬ä¸€æ®µã€‚</li>
</ol>
<p>é‡‡ç”¨runloopè°ƒåº¦ä¹Ÿå¾ˆç®€å•å°±ä¸å±•ç¤ºäº†ã€‚å°†æµå®‰æ’åˆ°runloopé‡Œï¼Œrunloopç›‘å¬æµäº‹ä»¶å¹¶å›è°ƒä»£ç†æ–¹æ³•ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)scheduleInRunLoop:(<span class="built_in">NSRunLoop</span> *)aRunLoop forMode:(<span class="built_in">NSRunLoopMode</span>)mode;</span><br><span class="line">- (<span class="type">void</span>)removeFromRunLoop:(<span class="built_in">NSRunLoop</span> *)aRunLoop forMode:(<span class="built_in">NSRunLoopMode</span>)mode;</span><br></pre></td></tr></table></figure>
<h2 id="æ—©æœŸç‰ˆæœ¬AFçš„ä½¿ç”¨"><a href="#æ—©æœŸç‰ˆæœ¬AFçš„ä½¿ç”¨" class="headerlink" title="æ—©æœŸç‰ˆæœ¬AFçš„ä½¿ç”¨"></a>æ—©æœŸç‰ˆæœ¬AFçš„ä½¿ç”¨</h2><h3 id="åˆå§‹åŒ–outputStream"><a href="#åˆå§‹åŒ–outputStream" class="headerlink" title="åˆå§‹åŒ–outputStream"></a>åˆå§‹åŒ–outputStream</h3><p>è¿™é‡Œåˆå§‹åŒ–äº†ä¸€ä¸ªè¾“å‡ºæµï¼Œå®ƒæ˜¯å°†æ•°æ®å†™å…¥åˆ°åº”ç”¨çš„å†…å­˜ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">NSOutputStream</span> *)outputStream &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_outputStream) &#123;</span><br><span class="line">        <span class="keyword">self</span>.outputStream = [<span class="built_in">NSOutputStream</span> outputStreamToMemory];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _outputStream;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)setOutputStream:(<span class="built_in">NSOutputStream</span> *)outputStream &#123;</span><br><span class="line">    [<span class="keyword">self</span>.lock lock];</span><br><span class="line">    <span class="keyword">if</span> (outputStream != _outputStream) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_outputStream) &#123;</span><br><span class="line">            [_outputStream close];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _outputStream = outputStream;</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="keyword">self</span>.lock unlock];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç»‘å®šåˆ°ç½‘ç»œçº¿ç¨‹çš„runloop"><a href="#ç»‘å®šåˆ°ç½‘ç»œçº¿ç¨‹çš„runloop" class="headerlink" title="ç»‘å®šåˆ°ç½‘ç»œçº¿ç¨‹çš„runloop"></a>ç»‘å®šåˆ°ç½‘ç»œçº¿ç¨‹çš„runloop</h3><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)operationDidStart &#123;</span><br><span class="line">    [<span class="keyword">self</span>.lock lock];</span><br><span class="line">    <span class="keyword">if</span> (![<span class="keyword">self</span> isCancelled]) &#123;</span><br><span class="line">        <span class="keyword">self</span>.connection = [[<span class="built_in">NSURLConnection</span> alloc] initWithRequest:<span class="keyword">self</span>.request delegate:<span class="keyword">self</span> startImmediately:<span class="literal">NO</span>];</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NSRunLoop</span> *runLoop = [<span class="built_in">NSRunLoop</span> currentRunLoop];</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSString</span> *runLoopMode <span class="keyword">in</span> <span class="keyword">self</span>.runLoopModes) &#123;</span><br><span class="line">            [<span class="keyword">self</span>.connection scheduleInRunLoop:runLoop forMode:runLoopMode];</span><br><span class="line">            [<span class="keyword">self</span>.outputStream scheduleInRunLoop:runLoop forMode:runLoopMode];<span class="comment">//è¿™ä¸€æ­¥å…¶å®å¯ä»¥ä¸éœ€è¦ï¼Œå› ä¸ºåé¢é‡‡ç”¨çš„æ˜¯è½®è¯¢</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="keyword">self</span>.outputStream open];</span><br><span class="line">        [<span class="keyword">self</span>.connection start];</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="keyword">self</span>.lock unlock];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:AFNetworkingOperationDidStartNotification object:<span class="keyword">self</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å†™å…¥æ•°æ®"><a href="#å†™å…¥æ•°æ®" class="headerlink" title="å†™å…¥æ•°æ®"></a>å†™å…¥æ•°æ®</h3><p>æµäº‹ä»¶å¯ä»¥ä½¿ç”¨äº‹ä»¶ç›‘å¬ä¹Ÿå¯ä»¥ç›´æ¥è½®è¯¢ï¼Œè¿™é‡Œæ˜¯è½®è¯¢hasSpaceAvailableã€‚å®é™…ä¸Šç”±äºæ¯æ¬¡å†™å…¥çš„æ•°æ®å¾ˆå°‘ï¼Œæ‰€ä»¥ä¸‹é¢çš„ä»£ç æ˜¯ä¸€æ¬¡å°±å†™å…¥å†…å­˜ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)connection:(<span class="built_in">NSURLConnection</span> __unused *)connection</span><br><span class="line">    didReceiveData:(<span class="built_in">NSData</span> *)data</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSUInteger</span> length = [data length];</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">YES</span>) &#123;</span><br><span class="line">        <span class="built_in">NSInteger</span> totalNumberOfBytesWritten = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span>.outputStream hasSpaceAvailable]) &#123;</span><br><span class="line">            <span class="keyword">const</span> uint8_t *dataBuffer = (uint8_t *)[data bytes];</span><br><span class="line"></span><br><span class="line">            <span class="built_in">NSInteger</span> numberOfBytesWritten = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (totalNumberOfBytesWritten &lt; (<span class="built_in">NSInteger</span>)length) &#123;</span><br><span class="line">                numberOfBytesWritten = [<span class="keyword">self</span>.outputStream write:&amp;dataBuffer[(<span class="built_in">NSUInteger</span>)totalNumberOfBytesWritten] maxLength:(length - (<span class="built_in">NSUInteger</span>)totalNumberOfBytesWritten)];</span><br><span class="line">                <span class="keyword">if</span> (numberOfBytesWritten == <span class="number">-1</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                totalNumberOfBytesWritten += numberOfBytesWritten;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            [<span class="keyword">self</span>.connection cancel];</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">self</span>.outputStream.streamError) &#123;</span><br><span class="line">                [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(connection:didFailWithError:) withObject:<span class="keyword">self</span>.connection withObject:<span class="keyword">self</span>.outputStream.streamError];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="keyword">self</span>.totalBytesRead += (<span class="type">long</span> <span class="type">long</span>)length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.downloadProgress) &#123;</span><br><span class="line">            <span class="keyword">self</span>.downloadProgress(length, <span class="keyword">self</span>.totalBytesRead, <span class="keyword">self</span>.response.expectedContentLength);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è¯»å–"><a href="#è¯»å–" class="headerlink" title="è¯»å–"></a>è¯»å–</h3><p>ç”±äºæ•°æ®æ˜¯å†™å…¥åˆ°å†…å­˜ï¼Œæˆ‘ä»¬æœ€ç»ˆéœ€è¦å°†å…¶è¯»å–å‡ºæ¥ï¼Œå¯¹äºoutputStreamToMemoryçš„è¾“å‡ºæµæ¥è¯´ï¼Œå¯ä»¥ä½¿ç”¨NSStreamDataWrittenToMemoryStreamKeyè·å–ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)connectionDidFinishLoading:(<span class="built_in">NSURLConnection</span> __unused *)connection &#123;</span><br><span class="line">    <span class="keyword">self</span>.responseData = [<span class="keyword">self</span>.outputStream propertyForKey:<span class="built_in">NSStreamDataWrittenToMemoryStreamKey</span>];</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span>.outputStream close];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.responseData) &#123;</span><br><span class="line">       <span class="keyword">self</span>.outputStream = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.connection = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> finish];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€åä¸è¦å¿˜äº†å…³é—­æµã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://developer.apple.com/library/archive/documentation/FileManagement/Conceptual/FileSystemProgrammingGuide/TechniquesforReadingandWritingCustomFiles/TechniquesforReadingandWritingCustomFiles.html">File System Programming Guide</a></p>
<p><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Streams/Streams.html#//apple_ref/doc/uid/10000188i">Stream Programming Guide</a></p>
<p><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Streams/Articles/WritingOutputStreams.html#//apple_ref/doc/uid/20002274-1002103">Writing To Output Streams</a></p>
]]></content>
      <categories>
        <category>Foundation</category>
      </categories>
      <tags>
        <tag>stream</tag>
      </tags>
  </entry>
  <entry>
    <title>OCç±»ä¸å…ƒç±»</title>
    <url>/2023/05/07/OC%E7%B1%BB%E4%B8%8E%E5%85%83%E7%B1%BB/</url>
    <content><![CDATA[<h2 id="å®ä¾‹å¯¹è±¡ã€ç±»ä¸å…ƒç±»"><a href="#å®ä¾‹å¯¹è±¡ã€ç±»ä¸å…ƒç±»" class="headerlink" title="å®ä¾‹å¯¹è±¡ã€ç±»ä¸å…ƒç±»"></a>å®ä¾‹å¯¹è±¡ã€ç±»ä¸å…ƒç±»</h2><p>å®ä¾‹å¯¹è±¡çš„ç±»ç§°ä¸ºç±»ï¼ˆç±»å¯¹è±¡ï¼‰ï¼Œç±»ï¼ˆç±»å¯¹è±¡ï¼‰çš„ç±»ç§°ä¸ºå…ƒç±»ï¼ˆå…ƒç±»å¯¹è±¡ï¼‰ã€‚ä»–ä»¬éƒ½æ˜¯å¯¹è±¡ã€‚</p>
<p>OCä¸­å¯¹è±¡ã€ç±»å’Œå…ƒç±»çš„å…³ç³»å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/9ff681b9-50e6-4b55-bc2a-2f38cb21af1c.png" alt=""></p>
<p>æ€»ç»“ä¸‹ï¼š</p>
<ol>
<li><p>å®ä¾‹å¯¹è±¡çš„ç±»æ˜¯ç±»å¯¹è±¡,ç±»å¯¹è±¡çš„ç±»æ˜¯å…ƒç±»å¯¹è±¡.å…ƒç±»å¯¹è±¡çš„ç±»æ˜¯æ ¹å…ƒç±»,æ ¹å…ƒç±»å¯¹è±¡çš„ç±»å°±æ˜¯è‡ªå·±æœ¬èº«.è¿™é‡Œå½¢æˆäº†ä¸€ä¸ªé—­ç¯.</p>
</li>
<li><p>ç±»å¯¹è±¡é‡Œé¢ä¿å­˜çš„æ˜¯å®ä¾‹æ–¹æ³•.</p>
</li>
<li><p>å…ƒç±»å¯¹è±¡é‡Œé¢ä¿å­˜çš„æ˜¯ç±»æ–¹æ³•.</p>
</li>
<li><p>æ ¹ç±»å¯¹è±¡çš„superClassæ˜¯nil,æ ¹ç±»å¯¹è±¡çš„ç±»æ˜¯æ ¹å…ƒç±»å¯¹è±¡,æ ¹å…ƒç±»å¯¹è±¡çš„superClassæ˜¯æ ¹ç±»å¯¹è±¡,è¿™é‡Œä¹Ÿå½¢æˆäº†ä¸€ä¸ªé—­ç¯.</p>
</li>
</ol>
<p>ä»£ç ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)test_class_metaClass &#123;</span><br><span class="line">    <span class="comment">//æ ¹ç±»å¯¹è±¡</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;æ ¹ç±»å¯¹è±¡[NSObject class]:%@,åœ°å€:%p&quot;</span>, [<span class="built_in">NSObject</span> <span class="keyword">class</span>], [<span class="built_in">NSObject</span> <span class="keyword">class</span>]);</span><br><span class="line">    <span class="comment">//æ ¹ç±»å¯¹è±¡çš„çˆ¶ç±»</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;æ ¹ç±»å¯¹è±¡çš„çˆ¶ç±»[[NSObject class] superclass]:%@,åœ°å€%p&quot;</span>, [[<span class="built_in">NSObject</span> <span class="keyword">class</span>] superclass], [[<span class="built_in">NSObject</span> <span class="keyword">class</span>] superclass]);</span><br><span class="line">    <span class="keyword">const</span> <span class="type">char</span> *nsobjectClassChar = [<span class="built_in">NSStringFromClass</span>([<span class="built_in">NSObject</span> <span class="keyword">class</span>]) UTF8String];</span><br><span class="line">    Class nsobjectMetaClass = objc_getMetaClass(nsobjectClassChar);</span><br><span class="line">    Class nsobjectMetaClass1 = object_getClass(<span class="built_in">NSObject</span>.class); <span class="comment">//nsobjectMetaClassä¸nsobjectMetaClass1ç›¸ç­‰ã€‚</span></span><br><span class="line">    <span class="comment">//æ ¹ç±»å¯¹è±¡çš„ç±»å³æ ¹å…ƒç±»å¯¹è±¡</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;æ ¹ç±»å¯¹è±¡çš„ç±»å³æ ¹å…ƒç±»å¯¹è±¡(NSObject metaClass):%@,åœ°å€:%p&quot;</span>, nsobjectMetaClass, nsobjectMetaClass);</span><br><span class="line">    <span class="comment">//æ ¹å…ƒç±»å¯¹è±¡çš„çˆ¶ç±»</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;æ ¹å…ƒç±»å¯¹è±¡çš„çˆ¶ç±»(NSObject metaClass superclass):%@,åœ°å€:%p&quot;</span>, [nsobjectMetaClass superclass], [nsobjectMetaClass superclass]);</span><br><span class="line">    <span class="comment">//æ ¹å…ƒç±»å¯¹è±¡çš„ç±»</span></span><br><span class="line">    Class root = objc_getMetaClass([<span class="built_in">NSStringFromClass</span>(nsobjectMetaClass) UTF8String]);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;æ ¹å…ƒç±»å¯¹è±¡çš„ç±»:%@,åœ°å€:%p&quot;</span>, root, root);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰“å°ï¼š</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">2023</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">28</span>:<span class="number">18</span>.<span class="number">507417</span>+<span class="number">0800</span> runtimeæ–¹æ³•ä½¿ç”¨Demo[<span class="number">20896</span>:<span class="number">7290701</span>] æ ¹ç±»å¯¹è±¡[NSObject class]:NSObject,åœ°å€:<span class="number">0</span>x1b9e44148</span><br><span class="line"><span class="attribute">2023</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">28</span>:<span class="number">18</span>.<span class="number">507511</span>+<span class="number">0800</span> runtimeæ–¹æ³•ä½¿ç”¨Demo[<span class="number">20896</span>:<span class="number">7290701</span>] æ ¹ç±»å¯¹è±¡çš„çˆ¶ç±»[[NSObject class] superclass]:(null),åœ°å€<span class="number">0</span>x0</span><br><span class="line"><span class="attribute">2023</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">28</span>:<span class="number">18</span>.<span class="number">507599</span>+<span class="number">0800</span> runtimeæ–¹æ³•ä½¿ç”¨Demo[<span class="number">20896</span>:<span class="number">7290701</span>] æ ¹ç±»å¯¹è±¡çš„ç±»å³æ ¹å…ƒç±»å¯¹è±¡(NSObject metaClass):NSObject,åœ°å€:<span class="number">0</span>x1b9e440f8</span><br><span class="line"><span class="attribute">2023</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">28</span>:<span class="number">18</span>.<span class="number">507663</span>+<span class="number">0800</span> runtimeæ–¹æ³•ä½¿ç”¨Demo[<span class="number">20896</span>:<span class="number">7290701</span>] æ ¹å…ƒç±»å¯¹è±¡çš„çˆ¶ç±»(NSObject metaClass superclass):NSObject,åœ°å€:<span class="number">0</span>x1b9e44148</span><br><span class="line"><span class="attribute">2023</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">28</span>:<span class="number">18</span>.<span class="number">507762</span>+<span class="number">0800</span> runtimeæ–¹æ³•ä½¿ç”¨Demo[<span class="number">20896</span>:<span class="number">7290701</span>] æ ¹å…ƒç±»å¯¹è±¡çš„ç±»:NSObject,åœ°å€:<span class="number">0</span>x1b9e440f8</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æ ¹ç±»å¯¹è±¡çš„ç±»æ˜¯æ ¹å…ƒç±»å¯¹è±¡0x1b9e440f8ã€‚æ ¹å…ƒç±»å¯¹è±¡çš„çˆ¶ç±»æ˜¯æ ¹ç±»å¯¹è±¡0x1b9e44148ã€‚æ ¹å…ƒç±»å¯¹è±¡çš„ç±»æ˜¯å®ƒæœ¬èº«0x1b9e440f8ã€‚</p>
<h2 id="ç±»å¯¹è±¡å“åº”æ ¹ç±»å¯¹è±¡çš„å®ä¾‹æ–¹æ³•"><a href="#ç±»å¯¹è±¡å“åº”æ ¹ç±»å¯¹è±¡çš„å®ä¾‹æ–¹æ³•" class="headerlink" title="ç±»å¯¹è±¡å“åº”æ ¹ç±»å¯¹è±¡çš„å®ä¾‹æ–¹æ³•"></a>ç±»å¯¹è±¡å“åº”æ ¹ç±»å¯¹è±¡çš„å®ä¾‹æ–¹æ³•</h2><p>ä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰å‘ç°ï¼Œç»™ç±»å¯¹è±¡å‘é€æ ¹ç±»å¯¹è±¡çš„å®ä¾‹æ–¹æ³•ï¼Œç¼–è¯‘å™¨æ˜¯ä¸ä¼šæŠ¥é”™çš„ï¼Œå¹¶ä¸”æ‰§è¡Œæ—¶ä¹Ÿä¸ä¼šå´©æºƒã€‚è¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿ</p>
<p>è¿˜æ˜¯çœ‹ä¸Šå›¾ï¼Œå› ä¸ºæ ¹å…ƒç±»å¯¹è±¡çš„superClassæ˜¯æ ¹ç±»å¯¹è±¡ï¼Œå½“ç»™ç±»å¯¹è±¡å‘é€å®ä¾‹æ–¹æ³•æ—¶ï¼Œæ ¹æ®æ–¹æ³•çš„æŸ¥æ‰¾é¡ºåºï¼ŒæŸ¥æ‰¾åˆ°æ ¹å…ƒç±»å¯¹è±¡æ—¶ï¼Œç”±äºæ ¹å…ƒç±»å¯¹è±¡é‡Œä¹Ÿæ²¡æœ‰è¯¥å®ä¾‹æ–¹æ³•ï¼Œæ‰€ä»¥ç»§ç»­å¾€ä¸ŠæŸ¥æ‰¾ï¼Œäºæ˜¯æŸ¥æ‰¾åˆ°æ ¹ç±»è¿™é‡Œï¼Œæ ¹ç±»é‡Œä¿å­˜çš„æ˜¯å®ä¾‹æ–¹æ³•å¹¶ä¸”åŒ…å«è¯¥å®ä¾‹æ–¹æ³•ï¼Œäºæ˜¯è¿›è¡Œè°ƒç”¨ã€‚å› æ­¤ç±»æ˜¯å¯ä»¥å“åº”æ ¹ç±»çš„å®ä¾‹æ–¹æ³•çš„ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥å†™ä¸€äº›ä»£ç éªŒè¯ä¸€ä¸‹ï¼šç»™ViewControllerå‘é€NSObjectçš„ä¸€äº›å®ä¾‹æ–¹æ³•</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)test_class_metaClass1 &#123;</span><br><span class="line">    Class vcCls = [ViewController <span class="keyword">copy</span>];</span><br><span class="line">  	<span class="comment">//copyæ˜¯æ ¹ç±»NSObjectçš„å®ä¾‹æ–¹æ³•,ä½†æ˜¯ç±»å¯¹è±¡ViewControllerä¾ç„¶èƒ½å¤Ÿâ€œå“åº”â€.</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;vcCls:%p,self.class:%p&quot;</span>, vcCls, [<span class="keyword">self</span> <span class="keyword">class</span>]); <span class="comment">//æ‰“å°çš„åœ°å€ä¸€æ ·,æ˜¯åŒä¸€ä¸ªå¯¹è±¡.</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ([ViewController respondsToSelector:<span class="keyword">@selector</span>(viewDidLoad)]) &#123; <span class="comment">//ä¸èƒ½å“åº”</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;ViewController respondsToSelector -viewDidLoad&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector OBJC_SWIFT_UNAVAILABLE(&quot;&quot;);</span></span><br><span class="line">    <span class="built_in">NSMethodSignature</span> *msig = [ViewController methodSignatureForSelector:<span class="keyword">@selector</span>(viewDidLoad)];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;msig:%@&quot;</span>, msig);</span><br><span class="line">    <span class="built_in">NSMethodSignature</span> *msig1 = [<span class="keyword">self</span> methodSignatureForSelector:<span class="keyword">@selector</span>(viewDidLoad)];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;msig1:%@&quot;</span>, msig1);</span><br><span class="line">    <span class="comment">//- (IMP)methodForSelector:(SEL)aSelector;</span></span><br><span class="line">    IMP imp = [ViewController methodForSelector:<span class="keyword">@selector</span>(viewDidLoad)]; <span class="comment">//è¿™é‡Œä¸ºå•¥ä¼šæœ‰å€¼ï¼Ÿä¸æ‡‚ã€‚ä¼°è®¡èµ°äº†æ¶ˆæ¯è½¬å‘ã€‚</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;imp:%p&quot;</span>, imp); <span class="comment">//(IMP) imp = 0x000000018002f440 (libobjc.A.dylib`_objc_msgForward)</span></span><br><span class="line">    IMP imp1 = [<span class="keyword">self</span> methodForSelector:<span class="keyword">@selector</span>(viewDidLoad)];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;imp1:%p&quot;</span>, imp1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰“å°ï¼š</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">2023</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">18</span>:<span class="number">44</span>.<span class="number">308901</span>+<span class="number">0800</span> runtimeæ–¹æ³•ä½¿ç”¨Demo[<span class="number">20472</span>:<span class="number">7278793</span>] vcCls:<span class="number">0</span>x104d452d8,self.class:<span class="number">0</span>x104d452d8</span><br><span class="line"><span class="attribute">2023</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">18</span>:<span class="number">44</span>.<span class="number">309072</span>+<span class="number">0800</span> runtimeæ–¹æ³•ä½¿ç”¨Demo[<span class="number">20472</span>:<span class="number">7278793</span>] msig:(null)</span><br><span class="line"><span class="attribute">2023</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">18</span>:<span class="number">44</span>.<span class="number">309131</span>+<span class="number">0800</span> runtimeæ–¹æ³•ä½¿ç”¨Demo[<span class="number">20472</span>:<span class="number">7278793</span>] msig1:&lt;NSMethodSignature: <span class="number">0</span>xa1d3a9acc0fd100f&gt;</span><br><span class="line"><span class="attribute">2023</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">18</span>:<span class="number">44</span>.<span class="number">309171</span>+<span class="number">0800</span> runtimeæ–¹æ³•ä½¿ç”¨Demo[<span class="number">20472</span>:<span class="number">7278793</span>] imp:<span class="number">0</span>x18002f440</span><br><span class="line"><span class="attribute">2023</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">18</span>:<span class="number">44</span>.<span class="number">309209</span>+<span class="number">0800</span> runtimeæ–¹æ³•ä½¿ç”¨Demo[<span class="number">20472</span>:<span class="number">7278793</span>] imp1:<span class="number">0</span>x104d3a940</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œç±»ViewControlleréƒ½å¯ä»¥å“åº”ã€‚ä¸è¿‡NSObjectæ ¹ç±»æ˜¯æ¯”è¾ƒç‰¹æ®Šçš„ï¼Œäº‹å®ä¸ŠNSObjectæ‰€æœ‰æš´éœ²çš„å®ä¾‹æ–¹æ³•éƒ½æœ‰å¯¹åº”çš„ä¸€ä»½ç±»æ–¹æ³•å®ç°ï¼Œåªä¸è¿‡å¤§éƒ¨åˆ†è¿™æ ·çš„ç±»æ–¹æ³•éƒ½æ²¡æœ‰æš´éœ²å‡ºæ¥ã€‚æ‰€ä»¥æ ¹å…ƒç±»é‡Œé¢æ˜¯æœ‰è¿™äº›ç±»æ–¹æ³•çš„ï¼Œæ ¹æ®æ–¹æ³•çš„æŸ¥æ‰¾é¡ºåºï¼Œæœ€ç»ˆä¼šåœ¨æ ¹å…ƒç±»è¿™é‡Œæ‰¾åˆ°è€Œä¸ä¼šç»§ç»­å¾€æ ¹ç±»é‡Œæ‰¾ï¼Œäºæ˜¯è°ƒç”¨ç›¸åº”ç±»æ–¹æ³•ã€‚è¿™åœ¨å¤–éƒ¨çœ‹èµ·æ¥åƒæ˜¯ç±»å“åº”äº†ä¸€ä¸ªå®ä¾‹æ–¹æ³•ï¼Œå®é™…ä¸Šåªæ˜¯å› ä¸ºNSObjectæ²¡æœ‰æš´éœ²å¯¹åº”çš„ç±»æ–¹æ³•ã€‚</p>
<p>å¯ä»¥çœ‹NSObjectçš„æºç å®ç°ï¼šperformSelectorï¼Œcopyç­‰éƒ½åªæš´éœ²äº†å®ä¾‹æ–¹æ³•æ¥å£ï¼Œä½†å®é™…ä¸Šå†…éƒ¨æœ‰å¯¹åº”çš„ç±»æ–¹æ³•æ¥å£ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">id</span>)performSelector:(SEL)aSelector;</span><br><span class="line">- (<span class="type">id</span>)performSelector:(SEL)aSelector withObject:(<span class="type">id</span>)object;</span><br><span class="line">- (<span class="type">id</span>)performSelector:(SEL)aSelector withObject:(<span class="type">id</span>)object1 withObject:(<span class="type">id</span>)object2;</span><br><span class="line"></span><br><span class="line">- (<span class="type">id</span>)<span class="keyword">copy</span>;</span><br><span class="line">- (<span class="type">id</span>)mutableCopy;</span><br><span class="line"></span><br><span class="line">- (<span class="type">id</span>)forwardingTargetForSelector:(SEL)aSelector OBJC_AVAILABLE(<span class="number">10.5</span>, <span class="number">2.0</span>, <span class="number">9.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>);</span><br><span class="line">- (<span class="type">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation OBJC_SWIFT_UNAVAILABLE(<span class="string">&quot;&quot;</span>);</span><br><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector OBJC_SWIFT_UNAVAILABLE(<span class="string">&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>å†…éƒ¨å®ç°ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//performSelectorç›¸å…³</span></span><br><span class="line">+ (<span class="type">id</span>)performSelector:(SEL)sel &#123;</span><br><span class="line">    <span class="keyword">if</span> (!sel) [<span class="keyword">self</span> doesNotRecognizeSelector:sel];</span><br><span class="line">    <span class="keyword">return</span> ((<span class="type">id</span>(*)(<span class="type">id</span>, SEL))objc_msgSend)((<span class="type">id</span>)<span class="keyword">self</span>, sel);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="type">id</span>)performSelector:(SEL)sel withObject:(<span class="type">id</span>)obj &#123;</span><br><span class="line">    <span class="keyword">if</span> (!sel) [<span class="keyword">self</span> doesNotRecognizeSelector:sel];</span><br><span class="line">    <span class="keyword">return</span> ((<span class="type">id</span>(*)(<span class="type">id</span>, SEL, <span class="type">id</span>))objc_msgSend)((<span class="type">id</span>)<span class="keyword">self</span>, sel, obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="type">id</span>)performSelector:(SEL)sel withObject:(<span class="type">id</span>)obj1 withObject:(<span class="type">id</span>)obj2 &#123;</span><br><span class="line">    <span class="keyword">if</span> (!sel) [<span class="keyword">self</span> doesNotRecognizeSelector:sel];</span><br><span class="line">    <span class="keyword">return</span> ((<span class="type">id</span>(*)(<span class="type">id</span>, SEL, <span class="type">id</span>, <span class="type">id</span>))objc_msgSend)((<span class="type">id</span>)<span class="keyword">self</span>, sel, obj1, obj2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">id</span>)performSelector:(SEL)sel &#123;</span><br><span class="line">    <span class="keyword">if</span> (!sel) [<span class="keyword">self</span> doesNotRecognizeSelector:sel];</span><br><span class="line">    <span class="keyword">return</span> ((<span class="type">id</span>(*)(<span class="type">id</span>, SEL))objc_msgSend)(<span class="keyword">self</span>, sel);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">id</span>)performSelector:(SEL)sel withObject:(<span class="type">id</span>)obj &#123;</span><br><span class="line">    <span class="keyword">if</span> (!sel) [<span class="keyword">self</span> doesNotRecognizeSelector:sel];</span><br><span class="line">    <span class="keyword">return</span> ((<span class="type">id</span>(*)(<span class="type">id</span>, SEL, <span class="type">id</span>))objc_msgSend)(<span class="keyword">self</span>, sel, obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">id</span>)performSelector:(SEL)sel withObject:(<span class="type">id</span>)obj1 withObject:(<span class="type">id</span>)obj2 &#123;</span><br><span class="line">    <span class="keyword">if</span> (!sel) [<span class="keyword">self</span> doesNotRecognizeSelector:sel];</span><br><span class="line">    <span class="keyword">return</span> ((<span class="type">id</span>(*)(<span class="type">id</span>, SEL, <span class="type">id</span>, <span class="type">id</span>))objc_msgSend)(<span class="keyword">self</span>, sel, obj1, obj2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//copyç›¸å…³</span></span><br><span class="line">+ (<span class="type">id</span>)<span class="keyword">copy</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">id</span>)<span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="type">id</span>)copyWithZone:(<span class="keyword">struct</span> _NSZone *)zone &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">id</span>)<span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">id</span>)<span class="keyword">copy</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [(<span class="type">id</span>)<span class="keyword">self</span> copyWithZone:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="type">id</span>)mutableCopy &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">id</span>)<span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="type">id</span>)mutableCopyWithZone:(<span class="keyword">struct</span> _NSZone *)zone &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">id</span>)<span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">id</span>)mutableCopy &#123;</span><br><span class="line">    <span class="keyword">return</span> [(<span class="type">id</span>)<span class="keyword">self</span> mutableCopyWithZone:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¶ˆæ¯è½¬å‘ç›¸å…³</span></span><br><span class="line"><span class="comment">// Replaced by CF (returns an NSMethodSignature)</span></span><br><span class="line">+ (<span class="built_in">NSMethodSignature</span> *)instanceMethodSignatureForSelector:(SEL)sel &#123;</span><br><span class="line">    _objc_fatal(<span class="string">&quot;+[NSObject instanceMethodSignatureForSelector:] &quot;</span></span><br><span class="line">                <span class="string">&quot;not available without CoreFoundation&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Replaced by CF (returns an NSMethodSignature)</span></span><br><span class="line">+ (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)sel &#123;</span><br><span class="line">    _objc_fatal(<span class="string">&quot;+[NSObject methodSignatureForSelector:] &quot;</span></span><br><span class="line">                <span class="string">&quot;not available without CoreFoundation&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Replaced by CF (returns an NSMethodSignature)</span></span><br><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)sel &#123;</span><br><span class="line">    _objc_fatal(<span class="string">&quot;-[NSObject methodSignatureForSelector:] &quot;</span></span><br><span class="line">                <span class="string">&quot;not available without CoreFoundation&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="type">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)invocation &#123;</span><br><span class="line">    [<span class="keyword">self</span> doesNotRecognizeSelector:(invocation ? [invocation selector] : <span class="number">0</span>)];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)invocation &#123;</span><br><span class="line">    [<span class="keyword">self</span> doesNotRecognizeSelector:(invocation ? [invocation selector] : <span class="number">0</span>)];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="type">id</span>)forwardingTargetForSelector:(SEL)sel &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">id</span>)forwardingTargetForSelector:(SEL)sel &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†é¿å…ä¸Šè¿°å½±å“ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç±»åˆ«ç»™NSObjectæ·»åŠ ä¸€ä¸ªå®ä¾‹æ–¹æ³•ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯æ ¹å…ƒç±»é‡Œæ²¡æœ‰å¯¹åº”çš„ç±»æ–¹æ³•ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">XQPrint</span>)</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)printSomething;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">XQPrint</span>)</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)printSomething &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;printSomething:%@&quot;</span>, <span class="keyword">self</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span> isKindOfClass:ViewController.class]) &#123; <span class="comment">//æ ¹ç±»é‡Œçš„æ–¹æ³•å¦‚æœä¸è¿›è¡Œdowncastä½œç”¨å¾ˆæœ‰é™ã€‚</span></span><br><span class="line">        ViewController *vc = (ViewController *)<span class="keyword">self</span>;</span><br><span class="line">        [vc handleBtnClicked];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;not work&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">//    ViewController *vc = (ViewController *)self;</span></span><br><span class="line"><span class="comment">//    [vc handleBtnClicked]; //å¦‚æœselfæ˜¯ç±»å¯¹è±¡è¿™é‡Œä¼šç›´æ¥å´©æºƒã€‚</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨printSomethingæ–¹æ³•</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)test_class_respond_instance_method &#123;</span><br><span class="line">    [ViewController printSomething];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰“å°ï¼š</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">2023</span>-<span class="number">05</span>-<span class="number">08</span> <span class="number">12</span>:<span class="number">12</span>:<span class="number">58</span>.<span class="number">795626</span>+<span class="number">0800</span> runtimeæ–¹æ³•ä½¿ç”¨Demo[<span class="number">45319</span>:<span class="number">7748354</span>] printSomething:ViewController</span><br><span class="line"><span class="attribute">2023</span>-<span class="number">05</span>-<span class="number">08</span> <span class="number">12</span>:<span class="number">12</span>:<span class="number">58</span>.<span class="number">795700</span>+<span class="number">0800</span> runtimeæ–¹æ³•ä½¿ç”¨Demo[<span class="number">45319</span>:<span class="number">7748354</span>] not work</span><br></pre></td></tr></table></figure>
<p>ç¥å¥‡çš„äº‹æƒ…æ¥äº†ï¼Œå®ä¾‹æ–¹æ³•printSomethingè¿˜æ˜¯è¢«è°ƒç”¨äº†ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è™½ç„¶åœ¨å®ä¾‹æ–¹æ³•é‡Œé¢ä½†selfå´æ˜¯ä¸€ä¸ªç±»å¯¹è±¡ã€‚åˆ°æ­¤ä¸ºæ­¢æˆ‘ä»¬å°±éªŒè¯äº†ç±»å¯ä»¥å“åº”æ ¹ç±»çš„å®ä¾‹æ–¹æ³•ã€‚</p>
<p>æ³¨æ„1:ç±»å¯¹è±¡åªèƒ½å“åº”æ ¹ç±»çš„å®ä¾‹æ–¹æ³•,ä¸èƒ½å“åº”å…¶çˆ¶ç±»çš„å®ä¾‹æ–¹æ³•.</p>
<p>ä¸¾ä¾‹ï¼šisBeingPresentedæ˜¯UIViewControllerçš„å®ä¾‹æ–¹æ³•ã€‚ç°åœ¨è®©ViewControlleræ‰§è¡ŒisBeingPresentedï¼Œä¼šå´©æºƒã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">[ViewController performSelector:<span class="meta">@selector(isBeingPresented)</span>];<span class="comment">//å´©æºƒ.</span></span><br></pre></td></tr></table></figure>
<p>æ³¨æ„2ï¼šä¸èƒ½ç»™å®ä¾‹å¯¹è±¡å‘é€ç±»æ–¹æ³•ã€‚ç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼Œå³ä½¿ä½¿ç”¨ä¸‹é¢çš„performSelectorè§„é¿æŠ¥é”™æœ€ç»ˆè¿˜æ˜¯ä¼šå´©æºƒã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">[obj performSelector:<span class="meta">@selector(someClassMethod)</span>]; <span class="comment">//å´©æºƒ</span></span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯å› ä¸ºç»™å®ä¾‹å¯¹è±¡å‘é€æ¶ˆæ¯æ˜¯æ²¿ç€ç±»å¯¹è±¡çš„ç»§æ‰¿é“¾æŸ¥æ‰¾çš„ï¼Œè€ŒNSObjectçš„çˆ¶ç±»æ˜¯nilï¼Œæœ€ç»ˆè‚¯å®šæ˜¯æ‰¾ä¸åˆ°è¿™ä¸ªç±»æ–¹æ³•çš„ï¼Œå› æ­¤ä¼šå´©æºƒã€‚</p>
<p>æ€»ç»“ï¼š</p>
<p>1.ç±»å¯ä»¥å“åº”æ ¹ç±»çš„å®ä¾‹æ–¹æ³•ã€‚ä¸è¿‡ä¸å»ºè®®è¿™ä¹ˆåšï¼Œå› ä¸ºæ²¡ä»€ä¹ˆæ„ä¹‰ã€‚æ‰€ä»¥æœ€å¥½è¿˜æ˜¯ç±»å¯¹è±¡å‘é€ç±»æ–¹æ³•ï¼Œå®ä¾‹å¯¹è±¡å‘é€å®ä¾‹æ–¹æ³•ã€‚</p>
<p>2.ä¸èƒ½ç»™å®ä¾‹å¯¹è±¡å‘é€ç±»æ–¹æ³•ã€‚</p>
<p>é—®é¢˜</p>
<p>Qï¼šä¸ºä»€ä¹ˆæ ¹å…ƒç±»çš„çˆ¶ç±»è¦è®¾ç½®ä¸ºæ ¹ç±»ï¼Ÿæ˜¯ä¸ºäº†è§£å†³ä»€ä¹ˆé—®é¢˜å—ï¼Œè¿˜æ˜¯å•¥åŸå› ï¼Ÿ</p>
<p>Aï¼šå°±æ˜¯ä¸ºäº†è®©ç±»å¯ä»¥å“åº”æ ¹ç±»çš„å®ä¾‹æ–¹æ³•ï¼Ÿ</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://sealiesoftware.com/blog/archive/2009/04/14/objc_explain_Classes_and_metaclasses.html">objc explain: Classes and metaclasses</a>  è¿œå¤å¤§ç¥</p>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
      <tags>
        <tag>class</tag>
      </tags>
  </entry>
  <entry>
    <title>OC classã€superClassæ–¹æ³•</title>
    <url>/2023/05/06/OC-class%E3%80%81superClass%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<p>æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)test_class_superClass &#123;</span><br><span class="line">    Person *per = [[Person alloc] init];</span><br><span class="line">    Class cls = [per <span class="keyword">class</span>]; <span class="comment">//Person</span></span><br><span class="line">    Class cls1 = [per superclass]; <span class="comment">//Animal</span></span><br><span class="line">    Class cls2 = Person.self; <span class="comment">//Person</span></span><br><span class="line">    Class cls3 = [Person <span class="keyword">class</span>]; <span class="comment">//Person</span></span><br><span class="line">    Class cls4 = [Person superclass]; <span class="comment">//Animal</span></span><br><span class="line">    Class cls5 = object_getClass(per); <span class="comment">//Person</span></span><br><span class="line">    Class cls6 = class_getSuperclass([Person <span class="keyword">class</span>]); <span class="comment">//Animal</span></span><br><span class="line">    Class cls7 = object_getClass([Person <span class="keyword">class</span>]); <span class="comment">//Personçš„å…ƒç±»</span></span><br><span class="line">    Class cls8 = class_getSuperclass(cls7); <span class="comment">//Personå…ƒç±»çš„çˆ¶ç±»</span></span><br><span class="line">    Class cls9 = [cls7 superclass]; <span class="comment">//Personå…ƒç±»çš„çˆ¶ç±» ç­‰äºcls8</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="è·å–å¯¹è±¡çš„ç±»"><a href="#è·å–å¯¹è±¡çš„ç±»" class="headerlink" title="è·å–å¯¹è±¡çš„ç±»"></a>è·å–å¯¹è±¡çš„ç±»</h2><p>è·å–ä¸€ä¸ªå¯¹è±¡ï¼ˆå®ä¾‹å¯¹è±¡æˆ–ç±»å¯¹è±¡ï¼‰çš„ç±»çš„æ ¸å¿ƒæ–¹æ³•å°±æ˜¯object_getClassï¼Œå®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Class <span class="title function_">object_getClass</span><span class="params">(id obj)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj) <span class="keyword">return</span> obj-&gt;getIsa();</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> Nil;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶å®å°±æ˜¯è·å–objc_objectç»“æ„ä½“é‡Œçš„isaå­—æ®µçš„å€¼ã€‚å› æ­¤å¦‚æœä¼ å…¥çš„æ˜¯ç±»å¯¹è±¡ï¼Œé‚£ä¹ˆè¿”å›çš„å°†æ˜¯ç±»å¯¹è±¡çš„ç±»å³å…ƒç±»ã€‚</p>
<p>å®ä¾‹æ–¹æ³•classçš„å®ç°å°±æ˜¯è°ƒç”¨object_getClassï¼š</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">- (Class)<span class="class"><span class="keyword">class</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> object_getClass(self);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯ç±»æ–¹æ³•classï¼Œå¹¶ä¸æ˜¯è¿”å›ç±»å¯¹è±¡çš„ç±»ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›çš„è‡ªå·±ã€‚</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">+ (Class)<span class="class"><span class="keyword">class</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (id)self &#123;</span><br><span class="line">    <span class="keyword">return</span> (id)self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥å¦‚æœæƒ³è¦è·å–ç±»çš„ç±»åˆ™å¿…é¡»ä½¿ç”¨object_getClassã€‚</p>
<h2 id="è·å–å¯¹è±¡çš„çˆ¶ç±»"><a href="#è·å–å¯¹è±¡çš„çˆ¶ç±»" class="headerlink" title="è·å–å¯¹è±¡çš„çˆ¶ç±»"></a>è·å–å¯¹è±¡çš„çˆ¶ç±»</h2><p>æ ¸å¿ƒæ–¹æ³•æ˜¯getSuperclassï¼Œå…¶å®å°±æ˜¯objc_classç»“æ„ä½“é‡Œçš„superclassçš„å€¼ã€‚</p>
<p>å®ä¾‹æ–¹æ³•superclassï¼šå…ˆè·å–åˆ°å®ƒçš„ç±»å†è°ƒç”¨getSuperclassã€‚</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">- (Class)superclass &#123;</span><br><span class="line">    <span class="keyword">return</span> [self <span class="class"><span class="keyword">class</span>]-&gt;<span class="title">getSuperclass</span>()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç±»æ–¹æ³•superclassï¼šè¿”å›ç±»å¯¹è±¡ç»“æ„ä½“é‡Œçš„superclassçš„å€¼ã€‚</p>
<figure class="highlight coq"><table><tr><td class="code"><pre><span class="line">+ (<span class="keyword">Class</span>)superclass &#123;</span><br><span class="line">    <span class="keyword">return</span> self-&gt;getSuperclass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>class_getSuperclassä¼ å…¥çš„å‚æ•°éœ€è¦æ˜¯ä¸€ä¸ªç±»å¯¹è±¡ï¼Œä»–çš„åŠŸèƒ½å’Œç±»æ–¹æ³•superclassä¸€è‡´ã€‚</p>
<figure class="highlight wren"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Class</span> <span class="title function_">class_getSuperclass</span>(<span class="params">Class</span> <span class="params">cls</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="operator">!</span><span class="variable">cls</span>) <span class="keyword">return</span> <span class="variable">nil</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">cls</span><span class="operator">-</span><span class="operator">&gt;</span><span class="title function_">getSuperclass</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="selfå’Œsuper"><a href="#selfå’Œsuper" class="headerlink" title="selfå’Œsuper"></a>selfå’Œsuper</h2><p>æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="variable language_">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;[self class]:%@&quot;</span>, <span class="built_in">NSStringFromClass</span>([<span class="keyword">self</span> <span class="keyword">class</span>]));</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;[super class]:%@&quot;</span>, <span class="built_in">NSStringFromClass</span>([<span class="variable language_">super</span> <span class="keyword">class</span>]));</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;[self superclass]:%@&quot;</span>, <span class="built_in">NSStringFromClass</span>([<span class="keyword">self</span> superclass]));</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;[super superclass]:%@&quot;</span>, <span class="built_in">NSStringFromClass</span>([<span class="variable language_">super</span> superclass]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºï¼š</p>
<figure class="highlight dns"><table><tr><td class="code"><pre><span class="line"><span class="number">2023-05-07</span> <span class="number">13</span>:<span class="number">03</span>:<span class="number">59.923896</span>+<span class="number">0800</span> runtimeæ–¹æ³•ä½¿ç”¨Demo[<span class="number">18358</span>:<span class="number">7221193</span>] [self class]:Person</span><br><span class="line"><span class="number">2023-05-07</span> <span class="number">13</span>:<span class="number">03</span>:<span class="number">59.924017</span>+<span class="number">0800</span> runtimeæ–¹æ³•ä½¿ç”¨Demo[<span class="number">18358</span>:<span class="number">7221193</span>] [super class]:Person</span><br><span class="line"><span class="number">2023-05-07</span> <span class="number">13</span>:<span class="number">03:59.924140</span>+<span class="number">0800</span> runtimeæ–¹æ³•ä½¿ç”¨Demo[<span class="number">18358</span>:<span class="number">7221193</span>] [self superclass]:Animal</span><br><span class="line"><span class="number">2023-05-07</span> <span class="number">13</span>:<span class="number">03:59.924237</span>+<span class="number">0800</span> runtimeæ–¹æ³•ä½¿ç”¨Demo[<span class="number">18358</span>:<span class="number">7221193</span>] [super superclass]:Animal</span><br></pre></td></tr></table></figure>
<p>ä»-classæ–¹æ³•çš„å®ç°ï¼š</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">- (Class)<span class="class"><span class="keyword">class</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> object_getClass(self);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºï¼Œobject_getClassçš„å‚æ•°å°±æ˜¯å¯¹è±¡æœ¬èº«ï¼Œæ‰€ä»¥ä¸ç®¡æ˜¯[self class]è¿˜æ˜¯[super class]ï¼Œä¼ å…¥çš„å‚æ•°éƒ½æ˜¯Personå¯¹è±¡è€Œä¸æ˜¯Animalå¯¹è±¡ã€‚æ‰€ä»¥äºŒè€…çš„ç»“æœæ˜¯ä¸€æ ·çš„ã€‚</p>
<p>superæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç¼–è¯‘æŒ‡ç¤ºå™¨, å®ƒå¹¶ä¸æ˜¯ä¸€ä¸ªæŒ‡é’ˆ, å®ƒä»…ä»…æ˜¯è¡¨ç¤ºè°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•,ä½†æ˜¯è°ƒç”¨è€…ä»ç„¶æ˜¯å½“å‰å¯¹è±¡,è·Ÿçˆ¶ç±»æ²¡æœ‰å…³ç³».ä¹Ÿå°±æ˜¯è¯´ä¸Šé¢çš„ä¾‹å­ä¸ç®¡è°ƒç”¨[self class]è¿˜æ˜¯[super class],æ¥å—æ¶ˆæ¯çš„å¯¹è±¡éƒ½æ˜¯å½“å‰Personè¿™ä¸ªå¯¹è±¡.</p>
<p>ä½¿ç”¨selfè°ƒç”¨æ–¹æ³•æ—¶,ä¼šä»å½“å‰ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­å¼€å§‹æ‰¾,å¦‚æœæ²¡æœ‰,å°±ä»çˆ¶ç±»ä¸­å†æ‰¾;è€Œå½“ä½¿ç”¨superæ—¶,åˆ™ä»çˆ¶ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­å¼€å§‹æ‰¾.ç„¶åè°ƒç”¨çˆ¶ç±»çš„è¿™ä¸ªæ–¹æ³•ï¼Œæ¶ˆæ¯æ¥æ”¶è€…å¯¹è±¡è¿˜æ˜¯å½“å‰è¿™ä¸ªå¯¹è±¡ã€‚</p>
<h2 id="å†…éƒ¨å®ç°"><a href="#å†…éƒ¨å®ç°" class="headerlink" title="å†…éƒ¨å®ç°"></a>å†…éƒ¨å®ç°</h2><p>ç›¸å…³æ–¹æ³•å£°æ˜ï¼š</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">NSObjectåè®®ï¼šå®ä¾‹æ–¹æ³•</span><br><span class="line"><span class="variable">@property</span> (readonly) Class superclass;</span><br><span class="line">- (Class)<span class="class"><span class="keyword">class</span> <span class="title">OBJC_SWIFT_UNAVAILABLE</span>(&quot;<span class="title">use</span> &#x27;<span class="title">type</span>(<span class="title">of</span>: <span class="title">anObject</span>)&#x27; <span class="title">instead</span>&quot;)</span>;</span><br><span class="line"></span><br><span class="line">NSObjectç±»ï¼šç±»æ–¹æ³•</span><br><span class="line">+ (Class)superclass;</span><br><span class="line">+ (Class)<span class="class"><span class="keyword">class</span> <span class="title">OBJC_SWIFT_UNAVAILABLE</span>(&quot;<span class="title">use</span> &#x27;<span class="title">aClass</span>.<span class="title">self</span>&#x27; <span class="title">instead</span>&quot;)</span>;</span><br></pre></td></tr></table></figure>
<p>å…³äº+classè¯´æ˜ï¼š</p>
<p>Refer to a class only by its name when it is the receiver of a message. In all other cases, the class object must be obtained through this or a similar method. For example, here <code>SomeClass</code> is passed as an argument to the <a href="doc://com.apple.documentation/documentation/objectivec/1418956-nsobject/1418511-iskindofclass?language=swift">isKindOfClass:</a> method (declared in the <code>NSObject</code> protocol):BOOL test = [self isKindOfClass:[SomeClass class]];</p>
<p>åªæœ‰ç±»ä½œä¸ºæ¶ˆæ¯çš„æ¥æ”¶è€…çš„æƒ…å†µæ‰å¯ä»¥ç›´æ¥ä½¿ç”¨ç±»åä»£è¡¨è¯¥ç±»ã€‚æ‰€æœ‰å…¶ä»–éœ€è¦ç±»çš„åœ°æ–¹éƒ½éœ€è¦é€šè¿‡è°ƒç”¨ç±»ä¼¼classçš„æ–¹æ³•æ¥è·å–ç±»å¯¹è±¡ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">+ (id)self &#123;</span><br><span class="line">    <span class="keyword">return</span> (id)self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (id)self &#123;</span><br><span class="line">    <span class="keyword">return</span> self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (Class)<span class="keyword">class</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (Class)<span class="keyword">class</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">object_getClass</span>(self);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (Class)superclass &#123;</span><br><span class="line">    <span class="keyword">return</span> self-&gt;<span class="built_in">getSuperclass</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (Class)superclass &#123;</span><br><span class="line">    <span class="keyword">return</span> [self <span class="keyword">class</span>]-&gt;<span class="built_in">getSuperclass</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* object_getClass.</span></span><br><span class="line"><span class="comment">* Locking: None. If you add locking, tell gdb (rdar://7516456).</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function">Class <span class="title">object_getClass</span><span class="params">(id obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj) <span class="keyword">return</span> obj-&gt;<span class="built_in">getIsa</span>();</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> Nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Class <span class="title">class_getSuperclass</span><span class="params">(Class cls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!cls) <span class="keyword">return</span> nil;</span><br><span class="line">    <span class="keyword">return</span> cls-&gt;<span class="built_in">getSuperclass</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>superClass</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">objc_class</span> : objc_object &#123;</span><br><span class="line">  <span class="built_in">objc_class</span>(<span class="type">const</span> objc_class&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">  <span class="built_in">objc_class</span>(objc_class&amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">  <span class="type">void</span> <span class="keyword">operator</span>=(<span class="type">const</span> objc_class&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">  <span class="type">void</span> <span class="keyword">operator</span>=(objc_class&amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    <span class="comment">// Class ISA;</span></span><br><span class="line">    Class superclass;</span><br><span class="line">    <span class="type">cache_t</span> cache;             <span class="comment">// formerly cache pointer and vtable</span></span><br><span class="line">    <span class="type">class_data_bits_t</span> bits;    <span class="comment">// class_rw_t * plus custom rr/alloc flags</span></span><br><span class="line"></span><br><span class="line">    <span class="function">Class <span class="title">getSuperclass</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">				<span class="keyword">return</span> superclass;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">objc_object</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">isa_t</span> isa;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ISA() assumes this is NOT a tagged pointer object</span></span><br><span class="line">    <span class="function">Class <span class="title">ISA</span><span class="params">(<span class="type">bool</span> authenticated = <span class="literal">false</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// rawISA() assumes this is NOT a tagged pointer object or a non pointer ISA</span></span><br><span class="line">    <span class="function">Class <span class="title">rawISA</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// getIsa() allows this to be a tagged pointer object</span></span><br><span class="line">    <span class="function">Class <span class="title">getIsa</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">uintptr_t</span> <span class="title">isaBits</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">  	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
      <tags>
        <tag>class</tag>
      </tags>
  </entry>
  <entry>
    <title>Cè¯­è¨€æ•´å‹ç±»å‹é•¿åº¦ä¸ç±»å‹æº¢å‡º</title>
    <url>/2023/04/06/C%E8%AF%AD%E8%A8%80%E6%95%B4%E5%9E%8B%E7%B1%BB%E5%9E%8B%E9%95%BF%E5%BA%A6%E4%B8%8E%E7%B1%BB%E5%9E%8B%E6%BA%A2%E5%87%BA/</url>
    <content><![CDATA[<h2 id="é¢˜å¤–è¯"><a href="#é¢˜å¤–è¯" class="headerlink" title="é¢˜å¤–è¯"></a>é¢˜å¤–è¯</h2><p>Cè¯­è¨€ç”±Dennis M. Ritchieåœ¨1973å¹´è®¾è®¡å’Œå®ç°ã€‚ä»é‚£ä»¥åä½¿ç”¨è€…é€æ¸å¢åŠ ã€‚åˆ°1978å¹´Ritchieå’ŒBellå®éªŒå®¤çš„å¦ä¸€ä½ç¨‹åºä¸“å®¶Kernighanåˆå†™äº†è‘—åçš„ã€ŠThe C Programming Languageã€‹ï¼Œå°†Cè¯­è¨€æ¨å‘å…¨ä¸–ç•Œï¼Œè®¸å¤šå›½å®¶éƒ½å‡ºäº†è¯‘æœ¬ï¼Œå›½å†…æœ‰ä¸€äº›Cè¯­è¨€ä¹¦å°±æ˜¯è¿™æœ¬ä¹¦çš„ç¿»è¯‘æˆ–è€…ç¼–è¯‘ã€‚ç”±è¿™æœ¬ä¹¦å®šä¹‰çš„Cè¯­è¨€åæ¥è¢«äººä»¬ç§°ä½œK&amp;R Cã€‚</p>
<p>éšç€Cè¯­è¨€ä½¿ç”¨å¾—è¶Šæ¥è¶Šå¹¿æ³›ï¼Œå‡ºç°äº†è®¸å¤šæ–°é—®é¢˜ï¼Œäººä»¬æ—¥ç›Šå¼ºçƒˆåœ°è¦æ±‚å¯¹Cè¯­è¨€è¿›è¡Œæ ‡å‡†åŒ–ã€‚è¿™ä¸ªæ ‡å‡†åŒ–çš„å·¥ä½œåœ¨ç¾å›½å›½å®¶æ ‡å‡†å±€ï¼ˆANSIï¼‰çš„æ¡†æ¶ä¸­è¿›è¡Œï¼ˆ1983-1988ï¼‰ï¼Œæœ€ç»ˆç»“æœæ˜¯1988å¹´10æœˆé¢å¸ƒçš„ANSIæ ‡å‡†X3.159-1989ï¼Œä¹Ÿå°±æ˜¯åæ¥äººä»¬æ‰€è¯´çš„ANSICæ ‡å‡†ã€‚ç”±è¿™ä¸ªæ ‡å‡†å®šä¹‰çš„Cè¯­è¨€è¢«ç§°ä½œANSI Cã€‚</p>
<p>ANSI Cæ ‡å‡†å¾ˆå¿«è¢«é‡‡çº³ä¸ºå›½é™…æ ‡å‡†å’Œå„å›½çš„æ ‡å‡†ã€‚å›½é™…æ ‡å‡†ä¸ºISO/IEC 9899-1990ï¼Œä¸­å›½å›½å®¶æ ‡å‡†GB/T15272-94æ˜¯å›½é™…ISOæ ‡å‡†çš„ä¸­æ–‡ç¿»è¯‘ã€‚</p>
<p>ANSI Cæ ‡å‡†åŒ–å·¥ä½œçš„ä¸€ä¸ªä¸»è¦ç›®æ ‡æ˜¯æ¸…é™¤åŸæ¥Cè¯­è¨€ä¸­çš„ä¸å®‰å…¨ã€ä¸åˆç†ã€ä¸ç²¾ç¡®ã€ä¸å®Œå–„çš„ä¸œè¥¿ã€‚ç”±æ­¤ä¹Ÿäº§ç”Ÿäº†ANSICä¸K&amp;R Cä¹‹é—´çš„å·®å¼‚ã€‚ä»æ€»ä½“ä¸Šçœ‹ï¼Œè¿™äº›å·®å¼‚ååº”çš„æ˜¯Cè¯­è¨€èµ°å‘å®Œå–„ã€èµ°å‘æˆç†Ÿã€‚</p>
<p>æˆ‘ä»¬ä¸€èˆ¬é‡‡ç”¨ANSI Cå°±å¯ä»¥äº†ã€‚</p>
<h2 id="æ•´å‹"><a href="#æ•´å‹" class="headerlink" title="æ•´å‹"></a>æ•´å‹</h2><p>æ•´å‹åŒ…æ‹¬ï¼šå­—ç¬¦ï¼ŒçŸ­æ•´å‹ï¼Œæ•´å‹ï¼Œé•¿æ•´å‹ã€‚æ¯ç§ç±»å‹åˆåˆ†ä¸ºæœ‰ç¬¦å·å’Œæ— ç¬¦å·ã€‚</p>
<p>K&amp;R Cå¹¶æ²¡æœ‰è§„å®šé•¿æ•´å‹å¿…é¡»æ¯”çŸ­æ•´å‹é•¿ï¼Œåªæ˜¯è§„å®šå®ƒä¸å¾—æ¯”çŸ­æ•´å‹çŸ­ã€‚</p>
<figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">é•¿æ•´å‹ &gt;<span class="operator">=</span> æ•´å‹ &gt;<span class="operator">=</span> çŸ­æ•´å‹</span><br></pre></td></tr></table></figure>
<p>ANSI Cåœ¨æ­¤åŸºç¡€ä¸ŠåŠ å…¥äº†ä¸€ä¸ªè§„èŒƒï¼Œè¯´æ˜äº†å„ç§æ•´å‹å€¼çš„<strong>æœ€å°å…è®¸èŒƒå›´</strong>ã€‚è¿™å¯¹ç¨‹åºçš„å¯ç§»æ¤æ€§èµ·åˆ°äº†å·¨å¤§çš„ä½œç”¨ã€‚</p>
<p>å˜é‡çš„æœ€å°èŒƒå›´ï¼š</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">ç±»å‹</th>
<th style="text-align:center">æœ€å°èŒƒå›´</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">char</td>
<td style="text-align:center">0~127</td>
</tr>
<tr>
<td style="text-align:center">signed char</td>
<td style="text-align:center">-127~127</td>
</tr>
<tr>
<td style="text-align:center">unsigned char</td>
<td style="text-align:center">0~255</td>
</tr>
<tr>
<td style="text-align:center">short int</td>
<td style="text-align:center">-(2^15 - 1) ~ (2^15 - 1) å³ -32767~32767</td>
</tr>
<tr>
<td style="text-align:center">unsigned short int</td>
<td style="text-align:center">0~(2^16 - 1) å³ 0~65535</td>
</tr>
<tr>
<td style="text-align:center">int</td>
<td style="text-align:center">-(2^15 - 1) ~ (2^15 - 1) å³ -32767~32767</td>
</tr>
<tr>
<td style="text-align:center">unsigned int</td>
<td style="text-align:center">0~(2^16 - 1) å³ 0~65535</td>
</tr>
<tr>
<td style="text-align:center">long int</td>
<td style="text-align:center">-(2^31 - 1) ~ (2^31 - 1) å³ -2147483647~2147483647</td>
</tr>
<tr>
<td style="text-align:center">unsigned long int</td>
<td style="text-align:center">0~(2^32 - 1) å³ 0~4294967295</td>
</tr>
</tbody>
</table>
</div>
<p>charè‡³å°‘8ä½ï¼Œshortè‡³å°‘16ä½ï¼Œlongè‡³å°‘32ä½ã€‚è‡³äºç¼ºçœçš„intç©¶ç«Ÿæ˜¯16ä½è¿˜æ˜¯32ä½ç”±ç¼–è¯‘å™¨å†³å®šï¼Œé€šå¸¸è¿™ä¸ªç¼ºçœå€¼æ˜¯è¿™ç§æœºå™¨æœ€ä¸ºè‡ªç„¶çš„ä½æ•°ï¼Œä¹Ÿå°±æ˜¯è·Ÿæœºå™¨ç›¸å…³ã€‚</p>
<p>æ³¨æ„ï¼šä¸Šè¿°è¡¨æ ¼åªæ˜¯ç±»å‹çš„æœ€å°èŒƒå›´ï¼Œå®é™…ä¸Šç”±äºæ•´æ•°æ˜¯ç”¨è¡¥ç è¡¨ç¤ºçš„ï¼Œæ‰€ä»¥æœ‰ç¬¦å·æ•´æ•°ç±»å‹å®é™…çš„èŒƒå›´æ˜¯ï¼š<br><code>-(2^(bitWidth - 1))~(2^(bitWidth - 1)) - 1</code>.æ¯”å¦‚shortçš„èŒƒå›´:-32768~32767</p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹åœ¨64ä½æœºå™¨ä¸Šï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;sizeof(char):%lu, sizeof(short):%lu, sizeof(int):%lu, sizeof(long):%lu, sizeof(float):%lu, sizeof(double):%lu&quot;</span>, <span class="keyword">sizeof</span>(<span class="type">char</span>), <span class="keyword">sizeof</span>(<span class="type">short</span>), <span class="keyword">sizeof</span>(<span class="type">int</span>), <span class="keyword">sizeof</span>(<span class="type">long</span>), <span class="keyword">sizeof</span>(<span class="type">float</span>), <span class="keyword">sizeof</span>(<span class="type">double</span>));</span><br></pre></td></tr></table></figure>
<p>æ‰“å°ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">sizeof</span><span class="params">(char)</span></span>:<span class="number">1</span>, </span><br><span class="line"><span class="function"><span class="title">sizeof</span><span class="params">(short)</span></span>:<span class="number">2</span>, </span><br><span class="line"><span class="function"><span class="title">sizeof</span><span class="params">(int)</span></span>:<span class="number">4</span>, </span><br><span class="line"><span class="function"><span class="title">sizeof</span><span class="params">(long)</span></span>:<span class="number">8</span>, </span><br><span class="line"><span class="function"><span class="title">sizeof</span><span class="params">(float)</span></span>:<span class="number">4</span>, </span><br><span class="line"><span class="function"><span class="title">sizeof</span><span class="params">(double)</span></span>:<span class="number">8</span></span><br></pre></td></tr></table></figure>
<p>æ˜¯ç¬¦åˆANSI Cè§„èŒƒçš„ã€‚</p>
<h2 id="ç±»å‹æº¢å‡º"><a href="#ç±»å‹æº¢å‡º" class="headerlink" title="ç±»å‹æº¢å‡º"></a>ç±»å‹æº¢å‡º</h2><p>ç”±äºæ•´å‹ç±»å‹è¡¨ç¤ºçš„æ•°æ®èŒƒå›´æœ‰é™ï¼Œæ‰€ä»¥ä¸ç®¡æ˜¯æœ‰ç¬¦å·è¿˜æ˜¯æ— ç¬¦å·æ•´å‹ç±»å‹éƒ½æœ‰å¯èƒ½å‘ç”Ÿæº¢å‡ºã€‚å‘ç”Ÿæº¢å‡ºæ—¶çš„ç»“æœæ˜¯æœªå®šä¹‰çš„ï¼Œä½†ä¸€èˆ¬æ˜¯ä¼šå›ç»•ã€‚</p>
<p>charå’Œunsigned charå›ç»•ï¼š255+1=0ï¼Œ0-1=255.</p>
<figure class="highlight brainfuck"><table><tr><td class="code"><pre><span class="line"><span class="comment">|</span><span class="literal">---</span>&gt;        &lt;<span class="literal">---</span><span class="comment">|</span></span><br><span class="line"><span class="literal">-</span><span class="comment">128</span><span class="literal">-----</span><span class="comment">0</span><span class="literal">-------</span><span class="comment">127</span></span><br><span class="line"></span><br><span class="line"><span class="comment">|</span><span class="literal">---</span>&gt;         &lt;<span class="literal">---</span><span class="comment">|</span></span><br><span class="line"><span class="comment">0</span><span class="literal">------</span><span class="comment">127</span><span class="literal">------</span><span class="comment">255</span></span><br></pre></td></tr></table></figure>
<p>å¦‚ä½•é¿å…ç±»å‹æº¢å‡ºï¼Ÿ</p>
<p>è¦å…ˆè¿›è¡Œç±»å‹è½¬æ¢æŠŠå°ç±»å‹è½¬ä¸ºå¤§ç±»å‹ï¼Œå†æ‰§è¡Œæ“ä½œï¼Œæ‰èƒ½é¿å…æº¢å‡ºã€‚å½“ç„¶å¦‚æœæ•°å­—éå¸¸å¤§ï¼Œé‚£ä¹ˆæ•´æ•°ç±»å‹å°±éƒ½ä¸èƒ½ç”¨äº†ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨å­—ç¬¦ä¸²æ“ä½œã€‚</p>
<p>ç±»å‹æº¢å‡ºä¾‹å­ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">test_signed_int_overflow</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     a = -2147483648</span></span><br><span class="line"><span class="comment">     b = 2147483647</span></span><br><span class="line"><span class="comment">     c = -2147483648</span></span><br><span class="line"><span class="comment">     d = -2147483648</span></span><br><span class="line"><span class="comment">     e = 2147483648</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> a = INT_MIN; <span class="comment">//è¡¥ç ä¸º1000 0000ï¼Œ-aè¡¥ç ä¾ç„¶æ˜¯1000 0000ï¼Œæ‰€ä»¥c,d,aç›¸ç­‰</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a = %d\n&quot;</span>, a);</span><br><span class="line">    <span class="type">int</span> b = INT_MAX;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;b = %d\n&quot;</span>, b);</span><br><span class="line">    <span class="type">int</span> c = -a;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;c = %d\n&quot;</span>, c);</span><br><span class="line">    <span class="type">long</span> d = -a;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;d = %ld\n&quot;</span>, d);</span><br><span class="line">    <span class="type">long</span> e = -(<span class="type">long</span>)a; <span class="comment">//è¦å…ˆè¿›è¡Œç±»å‹è½¬æ¢å†æ‰§è¡Œæ“ä½œï¼Œæ‰èƒ½é¿å…æº¢å‡ºã€‚å½“ç„¶å¦‚æœæ•°å­—éå¸¸å¤§ï¼Œé‚£ä¹ˆæ•´æ•°ç±»å‹å°±éƒ½ä¸èƒ½ç”¨äº†ï¼Œåªèƒ½è€ƒè™‘ä½¿ç”¨å­—ç¬¦ä¸²æ“ä½œäº†ã€‚</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;e = %ld\n&quot;</span>, e);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (c == a) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;overflow\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (d == a) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;not work\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŠ å‡ä¹˜é™¤éƒ½æœ‰å¯èƒ½å¯¼è‡´ç±»å‹æº¢å‡ºã€‚ç±»å‹æº¢å‡ºé—®é¢˜å¾ˆéš¾å‘ç°ï¼Œæ¯”å¦‚ä¸Šé¢çš„å–è´Ÿæ“ä½œï¼Œç”±äºintçš„æœ€å°å€¼æ˜¯-2147483648è€Œæœ€å¤§å€¼åªæœ‰2147483647ï¼Œé‚£ä¹ˆå¯¹-2147483648å–è´Ÿå°±ä¼šå¯¼è‡´intæº¢å‡ºã€‚è§£å†³åŠæ³•å°±æ˜¯å…ˆå¼ºè½¬ç±»å‹å†å–è´Ÿï¼šlong e = -(long)a;<br>å¾ˆå¤šç®—æ³•é¢˜ä¹Ÿæ˜¯è€ƒå¯Ÿå¤§æ•°é—®é¢˜ï¼Œé¢˜ç›®çœ‹èµ·æ¥ä¼šéå¸¸ç®€å•ï¼Œæ¯”å¦‚æ‰“å°1â€¦nï¼Œä¸¤ä¸ªæ•´æ•°ç›¸åŠ ç­‰ç­‰ã€‚æ¶‰åŠåˆ°æ•´å‹ç±»å‹çš„ç®€å•é¢˜ç›®ä¸€èˆ¬å°±æ˜¯è€ƒå¯Ÿå¤§æ•°é—®é¢˜äº†ã€‚</p>
<p>å¤§éƒ¨åˆ†è¯­è¨€å¯¹æº¢å‡ºçš„å¤„ç†éƒ½æ˜¯å›ç»•ï¼Œè¿™å…¶å®æ˜¯å¾ˆå±é™©çš„ï¼Œè¿™ä¼šå¯¼è‡´åˆ¤æ–­æ¡ä»¶å¤±æ•ˆï¼Œè¿›è€Œå‡ºç°è®¸å¤šè¯¡å¼‚bugã€‚Swiftåœ¨å‡ºç°ç±»å‹æº¢å‡ºæ—¶ç¨‹åºä¼šç›´æ¥å´©æºƒï¼Œé¿å…äº†é”™è¯¯é€»è¾‘çš„æ‰§è¡Œï¼Œæˆ‘è§‰å¾—æ˜¯ä¸é”™çš„è§£å†³åŠæ³•ã€‚</p>
]]></content>
      <categories>
        <category>C</category>
      </categories>
      <tags>
        <tag>sizeof</tag>
      </tags>
  </entry>
  <entry>
    <title>DDLogä½¿ç”¨æ³¨æ„äº‹é¡¹</title>
    <url>/2023/04/04/DDLog%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/</url>
    <content><![CDATA[<p>DDOSLoggeræ§åˆ¶å°æ‰“å°ï¼Œæ²¡æœ‰ä½¿ç”¨logMessageçš„æ—¶é—´æˆ³è€Œæ˜¯os_log_xxxæ‰§è¡Œæ—¶çš„æ—¶é—´æˆ³ï¼Œå› æ­¤ä¼šå’ŒlogMessageçš„åˆ›å»ºæ—¶é—´æœ‰ä¸ªæ—¶é—´å·®ã€‚å¦‚æœæ‰“å°æ—¶é€‰æ‹©çš„æ˜¯DDLogFlagErrorï¼Œæ‰“å°å°†æ˜¯åŒæ­¥æ‰§è¡Œï¼Œè¿™ä¸ªæ—¶é—´å·®ä¼šéå¸¸å°ã€‚è€Œå¦‚æœæ˜¯DDLogFlagErrorä»¥ä¸‹çº§åˆ«ï¼Œé‚£ä¹ˆè¿™æ¡æ‰“å°å°†æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œè¿™æ—¶çš„æ—¶é—´å·®ä¼šæ›´å¤§ï¼Œå’ŒNSLogæ··ç”¨æ—¶å¯èƒ½ä¼šè¯¯å¯¼ä½ ã€‚å› æ­¤å’ŒNSLogæ··ç”¨æˆ–è€…åœºæ™¯åŒæ­¥æ‰“å°è¦æ±‚æ¯”è¾ƒé«˜ï¼Œå»ºè®®ä½¿ç”¨DDLogFlagErroråŒæ­¥æ‰“å°æ—¥å¿—ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (DDLoggerName)loggerName &#123;</span><br><span class="line">    <span class="keyword">return</span> DDLoggerNameOS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)logMessage:(DDLogMessage *)logMessage &#123;</span><br><span class="line">    <span class="comment">// Skip captured log messages</span></span><br><span class="line">    <span class="keyword">if</span> ([logMessage-&gt;_fileName isEqualToString:<span class="string">@&quot;DDASLLogCapture&quot;</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (@available(iOS <span class="number">10.0</span>, macOS <span class="number">10.12</span>, tvOS <span class="number">10.0</span>, watchOS <span class="number">3.0</span>, *)) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> * message = _logFormatter ? [_logFormatter formatLogMessage:logMessage] : logMessage-&gt;_message;</span><br><span class="line">        <span class="keyword">if</span> (message != <span class="literal">nil</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="type">char</span> *msg = [message UTF8String];</span><br><span class="line">            __auto_type logger = [<span class="keyword">self</span> logger];</span><br><span class="line">            <span class="keyword">switch</span> (logMessage-&gt;_flag) &#123;</span><br><span class="line">                <span class="keyword">case</span> DDLogFlagError  :</span><br><span class="line">                    os_log_error(logger, <span class="string">&quot;%&#123;public&#125;s&quot;</span>, msg);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> DDLogFlagWarning:</span><br><span class="line">                <span class="keyword">case</span> DDLogFlagInfo   :</span><br><span class="line">                    os_log_info(logger, <span class="string">&quot;%&#123;public&#125;s&quot;</span>, msg);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> DDLogFlagDebug  :</span><br><span class="line">                <span class="keyword">case</span> DDLogFlagVerbose:</span><br><span class="line">                <span class="keyword">default</span>              :</span><br><span class="line">                    os_log_debug(logger, <span class="string">&quot;%&#123;public&#125;s&quot;</span>, msg);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¾‹å­ï¼šæ‰“å°æ—¶é€‰æ‹©çš„æ˜¯DDLogFlagDebugã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session dataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask</span><br><span class="line">didReceiveResponse:(<span class="built_in">NSURLResponse</span> *)response</span><br><span class="line"> completionHandler:(<span class="type">void</span> (^)(<span class="built_in">NSURLSessionResponseDisposition</span> disposition))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;æ¥æ”¶åˆ°å“åº”1:%@, çº¿ç¨‹ï¼š%@&quot;</span>, response.URL.lastPathComponent, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">    MATLogDebug(<span class="string">@&quot;MAT,æ¥æ”¶åˆ°å“åº”:%@, çº¿ç¨‹ï¼š%@&quot;</span>, response, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;æ¥æ”¶åˆ°å“åº”2:%@, çº¿ç¨‹ï¼š%@&quot;</span>, response.URL.lastPathComponent, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">    </span><br><span class="line">    completionHandler(<span class="built_in">NSURLSessionResponseAllow</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session dataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask didReceiveData:(<span class="built_in">NSData</span> *)data</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSURL</span> *url = dataTask.originalRequest.URL;</span><br><span class="line">    <span class="built_in">NSMutableData</span> *dataContainer = [<span class="keyword">self</span> dataWithURL:url];</span><br><span class="line">    [dataContainer appendData:data];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;æœ¬æ¬¡æ¥æ”¶1:%ld,çº¿ç¨‹ï¼š%@, url:%@&quot;</span>, data.length, [<span class="built_in">NSThread</span> currentThread], url.lastPathComponent);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (url.absoluteString == landscapeUrl) &#123;</span><br><span class="line">        sleep(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;æœ¬æ¬¡æ¥æ”¶2:%ld,æ€»å…±æ¥æ”¶:%ld,çº¿ç¨‹ï¼š%@, url:%@&quot;</span>, data.length, dataContainer.length, [<span class="built_in">NSThread</span> currentThread], url.lastPathComponent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ—¥å¿—ï¼š</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">2023</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">11</span>:<span class="number">05</span>:<span class="number">59</span>.<span class="number">463803</span>+<span class="number">0800</span> AFNetworking_fx[<span class="number">3039</span>:<span class="number">152895</span>] &lt;__NSURLSessionLocal: <span class="number">0</span>x103b48e60&gt;</span><br><span class="line"><span class="attribute">2023</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">11</span>:<span class="number">06</span>:<span class="number">00</span>.<span class="number">468738</span>+<span class="number">0800</span> AFNetworking_fx[<span class="number">3039</span>:<span class="number">152895</span>] å¼€å§‹è¯·æ±‚ï¼šhttps://tinypng.com/images/example-orig.png</span><br><span class="line"><span class="attribute">2023</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">11</span>:<span class="number">06</span>:<span class="number">00</span>.<span class="number">598328</span>+<span class="number">0800</span> AFNetworking_fx[<span class="number">3039</span>:<span class="number">154867</span>] æ¥æ”¶åˆ°å“åº”<span class="number">1</span>:example-orig.png, çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x2824d0f40&gt;&#123;number = <span class="number">16</span>, name = (null)&#125;</span><br><span class="line"><span class="attribute">2023</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">11</span>:<span class="number">06</span>:<span class="number">00</span>.<span class="number">599692</span>+<span class="number">0800</span> AFNetworking_fx[<span class="number">3039</span>:<span class="number">154867</span>] -----<span class="number">1</span>:<span class="number">2023</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">11</span>:<span class="number">06</span>:<span class="number">00</span>:<span class="number">600</span>---------</span><br><span class="line"><span class="attribute">2023</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">11</span>:<span class="number">06</span>:<span class="number">00</span>.<span class="number">600230</span>+<span class="number">0800</span> AFNetworking_fx[<span class="number">3039</span>:<span class="number">154867</span>] -----<span class="number">2</span>:<span class="number">2023</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">11</span>:<span class="number">06</span>:<span class="number">00</span>:<span class="number">600</span>---<span class="number">2023</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">11</span>:<span class="number">06</span>:<span class="number">00</span>:<span class="number">600</span>------</span><br><span class="line"><span class="attribute">2023</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">11</span>:<span class="number">06</span>:<span class="number">00</span>.<span class="number">600749</span>+<span class="number">0800</span> AFNetworking_fx[<span class="number">3039</span>:<span class="number">154867</span>] æ¥æ”¶åˆ°å“åº”<span class="number">2</span>:example-orig.png, çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x2824d0f40&gt;&#123;number = <span class="number">16</span>, name = (null)&#125;</span><br><span class="line"><span class="attribute">2023</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">11</span>:<span class="number">06</span>:<span class="number">00</span>.<span class="number">601729</span>+<span class="number">0800</span> AFNetworking_fx[<span class="number">3039</span>:<span class="number">154867</span>] æœ¬æ¬¡æ¥æ”¶<span class="number">1</span>:<span class="number">5455</span>,çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x2824d0f40&gt;&#123;number = <span class="number">16</span>, name = (null)&#125;, url:example-orig.png</span><br><span class="line"><span class="attribute">2023</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">11</span>:<span class="number">06</span>:<span class="number">00</span>.<span class="number">601922</span>+<span class="number">0800</span> AFNetworking_fx[<span class="number">3039</span>:<span class="number">154874</span>] <span class="number">2023</span>-<span class="number">04</span>-<span class="number">04</span> <span class="number">11</span>:<span class="number">06</span>:<span class="number">00</span>:<span class="number">600</span> -[SystemSessionViewController URLSession:dataTask:didReceiveResponse:completionHandler:] +<span class="number">171</span><span class="meta"> [level:Debug,module:0]</span></span><br><span class="line"><span class="attribute">MAT</span>,æ¥æ”¶åˆ°å“åº”:&lt;NSHTTPURLResponse: <span class="number">0</span>x2831fa500&gt; &#123; URL: https://tinypng.com/images/example-orig.png &#125; &#123; Status Code: <span class="number">200</span>, Headers &#123;</span><br></pre></td></tr></table></figure>
<p>logMessageçš„åˆ›å»ºæ—¶é—´æ˜¯2023-04-04 11:06:00:600ï¼Œä½†æ§åˆ¶å°æ˜¾ç¤ºçš„æ—¶é—´æˆ³æ˜¯2023-04-04 11:06:00.601922+0800ã€‚ç›¸å·®2msã€‚è¿˜ä»¥ä¸ºæ˜¯didReceiveDataçš„è°ƒç”¨è·‘åˆ°didReceiveResponseå‰é¢å»äº†ï¼ŒåŸæ¥æ˜¯æ‰“å°çš„é—®é¢˜ã€‚</p>
]]></content>
      <categories>
        <category>ç¬¬ä¸‰æ–¹åº“ä½¿ç”¨</category>
      </categories>
      <tags>
        <tag>DDLog</tag>
      </tags>
  </entry>
  <entry>
    <title>Swiftä¸­çš„Error</title>
    <url>/2023/04/02/Swift%E4%B8%AD%E7%9A%84Error/</url>
    <content><![CDATA[<p>OCä¸­çš„é”™è¯¯æ˜¯ä¸€ä¸ªç±»NSErrorï¼š</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Immutable, and NSError must be Sendable because it conforms to Error in Swift</span></span><br><span class="line"><span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">NSError</span> : <span class="title class_ inherited__">NSObject</span>, <span class="title class_ inherited__">NSCopying</span>, <span class="title class_ inherited__">NSSecureCoding</span>, @unchecked <span class="title class_ inherited__">Sendable</span> &#123;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Domain cannot be nil; dict may be nil if no userInfo desired.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(<span class="params">domain</span>: <span class="type">String</span>, <span class="params">code</span>: <span class="type">Int</span>, <span class="params">userInfo</span> <span class="params">dict</span>: [<span class="params">String</span> : <span class="keyword">Any</span>]<span class="operator">?</span> <span class="operator">=</span> <span class="literal">nil</span>)</span><br><span class="line">    <span class="operator">....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€ŒSwiftä¸­çš„é”™è¯¯åˆ™æ˜¯ä¸€ä¸ªåè®®Errorï¼š</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">protocol</span> <span class="title class_">Error</span> : <span class="title class_ inherited__">Sendable</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">protocol</span> <span class="title class_">Sendable</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">Error</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Retrieve the localized description for this error.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> localizedDescription: <span class="type">String</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">NSError</span> : <span class="title class_ inherited__">Error</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®é™…ä¸Šè¿™ä¸ªåè®®æ²¡æœ‰ä»»ä½•å†…å®¹ï¼Œå› æ­¤ä»»æ„ç±»ã€ç»“æ„ä½“ã€æšä¸¾éƒ½å¯ä»¥è½»æ¾å®ç°Erroråè®®ã€‚</p>
<p>å®šä¹‰Swift Error:</p>
<p>ä½¿ç”¨æšä¸¾</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">NetworkError</span>: <span class="title class_ inherited__">Error</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> domainError</span><br><span class="line">    <span class="keyword">case</span> decodingError</span><br><span class="line">    <span class="keyword">case</span> noDataError</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> localizedDescription: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> <span class="keyword">self</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> .domainError:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;urlé”™è¯¯&quot;</span></span><br><span class="line">        <span class="keyword">case</span> .decodingError:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;è§£æå‡ºé”™&quot;</span></span><br><span class="line">        <span class="keyword">case</span> .noDataError:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;æ— æ•°æ®&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±äºé”™è¯¯ä¸€èˆ¬æ˜¯åå°æ¥å£ç»™å‡ºï¼Œæ‰€ä»¥ä¸ªäººè§‰å¾—ä½¿ç”¨ç»“æ„ä½“è¡¨ç¤ºé”™è¯¯ï¼Œä½¿ç”¨æ˜¯æœ€æ–¹ä¾¿çš„ï¼š</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">BusinessError</span>: <span class="title class_ inherited__">Error</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> code <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> message <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">code</span>: <span class="type">String</span>, <span class="params">message</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.code <span class="operator">=</span> code</span><br><span class="line">        <span class="keyword">self</span>.message <span class="operator">=</span> message</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> localizedDescription: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> message</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœéœ€è¦å…·ä½“åˆ¤æ–­é”™è¯¯ç ï¼Œå¯ä»¥æ‰©å±•BusinessErrorï¼Œä¸åŒçš„ä¸šåŠ¡æ¥å£å¯ä»¥åˆ›å»ºä¸åŒçš„æ‰©å±•ã€‚</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extension</span> <span class="title class_">BusinessError</span> &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">SuperLike</span> &#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">let</span> unknow <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">let</span> badParam <span class="operator">=</span> <span class="string">&quot;-10000&quot;</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">let</span> badGender <span class="operator">=</span> <span class="string">&quot;-10001&quot;</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">let</span> notMatch <span class="operator">=</span> <span class="string">&quot;-10002&quot;</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">let</span> overFrequent <span class="operator">=</span> <span class="string">&quot;-10003&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> <span class="title function_">estimateErr</span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> error.code <span class="operator">==</span> <span class="type">BusinessError</span>.<span class="type">SuperLike</span>.badParam &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;badParam&quot;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> error.code <span class="operator">==</span> <span class="type">BusinessError</span>.<span class="type">SuperLike</span>.badGender &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;badGender&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Swift</category>
      </categories>
      <tags>
        <tag>Error</tag>
      </tags>
  </entry>
  <entry>
    <title>Swiftä¸­çš„æšä¸¾</title>
    <url>/2023/04/02/Swift%E4%B8%AD%E7%9A%84%E6%9E%9A%E4%B8%BE/</url>
    <content><![CDATA[<p>1.swiftçš„æšä¸¾åªèƒ½æ‹¥æœ‰åŸå§‹å€¼å’Œå…³è”å€¼çš„å…¶ä¸­ä¸€ç§ï¼Œä¸èƒ½åŒæ—¶æ‹¥æœ‰ï¼Œä¼šæŠ¥é”™ï¼šEnum with raw type cannot have cases with argumentsã€‚</p>
<p>2.è¯»å–å…³è”å€¼æ—¶ä¸èƒ½å†™å‚æ•°çš„ç±»å‹,å¦åˆ™ç¼–è¯‘æŠ¥é”™ã€‚</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">BinaryTree</span>&lt;<span class="type">Element</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">case</span> leaf</span><br><span class="line">    <span class="keyword">indirect</span> <span class="keyword">case</span> node(v: <span class="type">Element</span>, l: <span class="type">BinaryTree</span>&lt;<span class="type">Element</span>&gt;, r: <span class="type">BinaryTree</span>&lt;<span class="type">Element</span>&gt;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">BinaryTree</span> &#123;</span><br><span class="line">    <span class="keyword">init</span>(<span class="keyword">_</span> <span class="params">val</span>: <span class="type">Element</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span> <span class="operator">=</span> .node(v: val, l: .leaf, r: .leaf)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¯»å–å…³è”å€¼æ—¶ä¸èƒ½å†™å‚æ•°çš„ç±»å‹,å¦åˆ™ç¼–è¯‘æŠ¥é”™ã€‚</span></span><br><span class="line"><span class="comment">//case let .node(v: Element, l: BinaryTree&lt;Element&gt;, r: BinaryTree&lt;Element&gt;):</span></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">BinaryTree</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> values: [<span class="type">Element</span>] &#123;</span><br><span class="line">        <span class="keyword">switch</span> <span class="keyword">self</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> .leaf:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">let</span> .node(v, l, r): <span class="comment">//ç›´æ¥å¡«å†™å˜é‡åç§°ã€‚</span></span><br><span class="line">            <span class="keyword">return</span> l.values <span class="operator">+</span> [v] <span class="operator">+</span> r.values</span><br><span class="line"><span class="comment">//        case .node(let v, var l, var r):</span></span><br><span class="line"><span class="comment">//            return l.values + [v] + r.values</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://stackoverflow.com/questions/59378942/enum-with-raw-type-cannot-have-cases-with-arguments">Enum with raw type cannot have cases with arguments</a></p>
]]></content>
      <categories>
        <category>Swift</category>
      </categories>
      <tags>
        <tag>enum</tag>
      </tags>
  </entry>
  <entry>
    <title>OCä¸­çš„è®¿é—®æ§åˆ¶</title>
    <url>/2023/03/08/OC%E4%B8%AD%E7%9A%84%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6/</url>
    <content><![CDATA[<p>OCä¸­æä¾›äº†4ä¸ªè®¿é—®æ§åˆ¶ç¬¦ï¼š@private @package @protected @publicã€‚</p>
<p>@privateï¼ˆå½“å‰ç±»è®¿é—®æƒé™ï¼‰ï¼šæˆå‘˜åªèƒ½åœ¨å½“å‰ç±»å†…éƒ¨å¯ä»¥è®¿é—®ï¼Œåœ¨ç±»å®ç°éƒ¨åˆ†å®šä¹‰çš„æˆå‘˜å˜é‡ç›¸å½“äºé»˜è®¤ä½¿ç”¨äº†è¿™ç§è®¿é—®æƒé™ã€‚</p>
<p>@packageï¼ˆåŒæ˜ åƒè®¿é—®æƒé™ï¼‰ï¼šæˆå‘˜å¯ä»¥åœ¨å½“å‰ç±»æˆ–å’Œå½“å‰ç±»å®ç°çš„åŒä¸€æ˜ åƒä¸­ä½¿ç”¨ï¼ŒåŒä¸€æ˜ åƒå°±æ˜¯ç¼–è¯‘åç”Ÿæˆçš„åŒä¸€æ¡†æ¶æˆ–åŒä¸€ä¸ªæ‰§è¡Œæ–‡ä»¶ï¼Œè·¨æ¡†æ¶ä¸å¯ç”¨ã€‚ç®€å•ç‚¹è®²å°±æ˜¯ä½¿ç”¨packageåï¼Œè¯¥æˆå‘˜å˜é‡åœ¨åŒä¸€ä¸ªæ¡†æ¶é‡Œçš„æ‰€æœ‰ç±»é‡Œéƒ½å¯ä»¥è®¿é—®åˆ°ï¼Œåˆ«çš„æ¡†æ¶è®¿é—®ä¸åˆ°ã€‚</p>
<p>@protectedï¼ˆå­ç±»è®¿é—®æƒé™ï¼‰ï¼šæˆå‘˜å¯ä»¥åœ¨å½“å‰ç±»å’Œå½“å‰ç±»çš„å­ç±»ä¸­è®¿é—®ã€‚åœ¨ç±»æ¥å£éƒ¨åˆ†å®šä¹‰çš„æˆå‘˜å˜é‡é»˜è®¤æ˜¯è¿™ç§è®¿é—®æƒé™ã€‚</p>
<p>@publicï¼ˆå…¬å…±è®¿é—®æƒé™ï¼‰ï¼šæˆå‘˜å¯ä»¥åœ¨ä»»æ„åœ°æ–¹è®¿é—®ã€‚</p>
<p>privateå’Œpublicæ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥è¿™é‡Œå…·ä½“è¯´ä¸€ä¸‹packageå’Œprotectedçš„ä½¿ç”¨åœºæ™¯ã€‚</p>
<p>ä½¿ç”¨packageä¿®é¥°çš„æˆå‘˜åªèƒ½åœ¨å½“å‰æ¡†æ¶å†…è¢«è®¿é—®ã€‚</p>
<p>æ¯”å¦‚Aæ¡†æ¶é‡Œæœ‰ä¸€ä¸ªç±»XQSheetï¼Œå®ƒæœ‰ä¸€ä¸ª_buttonsæˆå‘˜ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">XQSheet</span> : <span class="title">JHGrandPopupView</span></span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">@package</span> <span class="built_in">NSMutableArray</span> *_buttons;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨packageä¿®é¥°åï¼Œé‚£ä¹ˆ_buttonsåªèƒ½åœ¨Aæ¡†æ¶å†…éƒ¨è¢«è®¿é—®åˆ°ï¼ˆAæ¡†æ¶çš„ä»»æ„ç±»é‡Œéƒ½å¯ä»¥ï¼‰ï¼Œä½†ä¸èƒ½åœ¨æ¡†æ¶Bé‡Œè¢«è®¿é—®ã€‚</p>
<p>å¦‚æœæ”¹ä¸ºprotectedï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">XQSheet</span> : <span class="title">JHGrandPopupView</span></span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">@protected</span> <span class="built_in">NSMutableArray</span> *_buttons;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆ_buttonsåªèƒ½åœ¨å½“å‰ç±»åŠå…¶å­ç±»é‡Œè¢«è®¿é—®åˆ°ã€‚è¿™ä¸ªå­ç±»å¯ä»¥åœ¨Aæ¡†æ¶é‡Œï¼Œä¹Ÿå¯ä»¥åœ¨Bæ¡†æ¶é‡Œï¼Œè¯´æ˜å¯ä»¥è·¨æ¡†æ¶ï¼Œä½†å¿…é¡»æ˜¯å­ç±»é‡Œã€‚Aæ¡†æ¶é‡Œçš„Personç±»é‡Œèƒ½ä¸èƒ½è®¿é—®<code>_buttons</code>? ç­”æ¡ˆæ˜¯ä¸èƒ½ã€‚è¿™å°±æ˜¯å’Œpackageçš„åŒºåˆ«ã€‚</p>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
      <tags>
        <tag>è®¿é—®æ§åˆ¶</tag>
      </tags>
  </entry>
  <entry>
    <title>Swiftä¸­çš„å…³é”®å­—</title>
    <url>/2023/02/26/Swift%E4%B8%AD%E7%9A%84%E5%85%B3%E9%94%AE%E5%AD%97/</url>
    <content><![CDATA[<h3 id="inline"><a href="#inline" class="headerlink" title="@inline"></a>@inline</h3><p>è¯´æ˜ï¼šå‡½æ•°å†…è”ï¼Œä¸€ç§ç¼–è¯‘å™¨ä¼˜åŒ–æŠ€æœ¯ã€‚å£°æ˜å†…è”çš„å‡½æ•°ï¼Œç¼–è¯‘å™¨ä¼šæŠŠè¯¥å‡½æ•°è°ƒç”¨çš„åœ°æ–¹ç”¨å®ƒçš„å®ç°æ›¿æ¢æœ‰ç‚¹ç±»ä¼¼Cè¯­è¨€çš„å®ï¼Œè¿™æ ·å°±å‡å°‘äº†å‡½æ•°çš„è°ƒç”¨å¼€é”€ï¼Œå±äºä¸€ç§å¾®ä¼˜åŒ–ï¼Œå¦‚æœå‡½æ•°å®ç°ç®€å•ï¼Œè°ƒç”¨éå¸¸é¢‘ç¹å¯ä»¥ä½¿ç”¨å†…è”è¿›è¡Œä¼˜åŒ–ã€‚ç”±äºå†…è”æ˜¯æŠŠå‡½æ•°è°ƒç”¨çš„åœ°æ–¹ç”¨å®ƒçš„å®ç°æ›¿æ¢ï¼Œå› æ­¤å†…è”å¯èƒ½ä¼šè®©ç¨‹åºçš„äºŒè¿›åˆ¶åŒ…å˜å¤§ï¼Œå–å†³äºç¼–è¯‘ä¼˜åŒ–ç­‰çº§ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šè‡ªåŠ¨å¯¹ä¸€äº›é¢‘ç¹è°ƒç”¨çš„å‡½æ•°è¿›è¡Œå†…è”ï¼Œå¦‚æœè¿™ä¸ªå‡½æ•°å®ç°æ¯”è¾ƒå¤æ‚ï¼Œé‚£ä¹ˆæ­¤æ—¶çš„å†…è”å¯èƒ½å¼Šå¤§äºåˆ©ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥ä½¿ç”¨ @inline(never) æ˜ç¡®å‘ŠçŸ¥ç¼–è¯‘å™¨å…³é—­è¿™ä¸€ç‰¹æ€§ã€‚@inlineçš„å¦ä¸€ä¸ªåº”ç”¨åœºæ™¯å°±æ˜¯ä»£ç æ··æ·†å¢åŠ é€†å‘éš¾åº¦ã€‚</p>
<p>ç”¨æ³•ï¼šä½¿ç”¨@inline(__always) å’Œ @inline(never) ä¿®é¥°å‡½æ•°ã€‚å‡½æ•°çš„è®¿é—®æƒé™å¯ä»¥æ˜¯publicä¹Ÿå¯ä»¥æ˜¯privateã€‚</p>
<p>å‚è€ƒï¼š<a href="https://swiftrocks.com/the-forbidden-inline-attribute-in-swift">The Forbidden @inline Attribute in Swift</a></p>
<h3 id="inlinable"><a href="#inlinable" class="headerlink" title="@inlinable"></a>@inlinable</h3><p>è¯´æ˜ï¼š<code>@inlinable</code> å±æ€§å…è®¸æ‚¨ä¸ºç‰¹å®šæ–¹æ³•å¯ç”¨<strong>è·¨æ¨¡å—å†…è”</strong>ã€‚è¿™æ ·åšäº†ä¹‹åï¼Œæ–¹æ³•çš„å®ç°å°†ä½œä¸ºæ¨¡å—å…¬å…±æ¥å£çš„ä¸€éƒ¨åˆ†æ¥å…¬å¼€ï¼Œå…è®¸ç¼–è¯‘å™¨è¿›ä¸€æ­¥ä¼˜åŒ–æ¥è‡ªä¸åŒæ¨¡å—çš„è°ƒç”¨ã€‚ä½¿ç”¨ <code>@inlinable</code> æœ€å¤§çš„æ”¶ç›Šå°±æ˜¯æœ‰äº›æ–¹æ³•å¯èƒ½ä¼šæœ‰æ€§èƒ½å¼€é”€ï¼Œå°½ç®¡å¤§å¤šæ•°çš„æ–¹æ³•è¿™ç§å¼€é”€å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œä½†åƒé‚£ç§åŒ…å«æ³›å‹å’Œé—­åŒ…çš„ï¼Œå¼€é”€å¾ˆå¤§ã€‚ä½¿ç”¨<code>@inlinable</code> å¯ä»¥å¸¦æ¥æ€§èƒ½æå‡ï¼Œä¸è¿‡åŒ…çš„å¤§å°ä¼šå¢åŠ ã€‚</p>
<p>ç”¨æ³•ï¼šâ€™@inlinableâ€™ åªèƒ½ç”¨äº public å‡½æ•°ï¼Œä¸èƒ½ä¿®é¥°privateå‡½æ•°ã€‚</p>
<p>å‚è€ƒï¼š<a href="https://swiftrocks.com/understanding-inlinable-in-swift.html">Understanding <code>@inlinable</code> in Swift</a></p>
<h3 id="autoclosure"><a href="#autoclosure" class="headerlink" title="@autoclosure"></a>@autoclosure</h3><p>The <code>@autoclosure</code> attribute can be applied to a closure parameter for a function, and automatically creates a closure from an <strong>expression</strong> you pass in. When you call a function that uses this attribute, the code you write <em>isnâ€™t</em> a closure, but it <em>becomes</em> a closure, which can be a bit confusing â€“ even the official Swift reference guide warns that overusing autoclosures makes your code harder to understand.</p>
<p>ä¸»è¦ç”¨äºå»¶è¿Ÿè¡¨è¾¾å¼çš„æ‰§è¡Œã€‚1.æœ‰ä¸€äº›æƒ…å†µä¼ å…¥çš„è¡¨è¾¾å¼å¾ˆæœ‰å¯èƒ½ä¸ä¼šè¢«æ‰§è¡Œï¼Œä½¿ç”¨@autoclosureå¯ä»¥èµ·åˆ°ä¸€ç‚¹ç‚¹ä¼˜åŒ–ä½œç”¨ã€‚2.ä»£ç æ›´åŠ ç®€æ´ï¼Œå°‘å†™ä¸€å¯¹èŠ±æ‹¬å·ã€‚</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">add</span>(<span class="params">a</span>: <span class="type">Int</span>, <span class="params">b</span>: <span class="keyword">@autoclosure</span> () -&gt; <span class="type">Int</span>) -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> a <span class="operator">&lt;</span> <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a <span class="operator">+</span> b()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> res1 <span class="operator">=</span> add(a: <span class="number">3</span>, b: <span class="number">3</span> <span class="operator">*</span> <span class="number">1872</span> <span class="operator">+</span> <span class="number">876</span>)</span><br><span class="line"><span class="keyword">let</span> res2 <span class="operator">=</span> add(a: <span class="operator">-</span><span class="number">2</span>, b: <span class="number">3</span> <span class="operator">*</span> <span class="number">1872</span> <span class="operator">+</span> <span class="number">876</span>) <span class="comment">//è¿™ç§æƒ…å†µä¸‹å‚æ•°bå®é™…ä¸Šæ˜¯ä¸ä¼šè®¡ç®—çš„ã€‚å¦‚æœæ˜¯æ™®é€šå‡½æ•°çš„è¯é‚£ä¹ˆåœ¨è¿è¡Œæ—¶ä¼šå…ˆè®¡ç®—å‡ºç»“æœå†ä¼ å…¥bã€‚DDLogä¹Ÿæ˜¯è¿™ä¹ˆå¹²çš„ï¼Œå› ä¸ºmessageæœ‰å¯èƒ½ä¸ä¼šè¢«æ‰“å°ã€‚</span></span><br></pre></td></tr></table></figure>
<p>å‚è€ƒï¼š</p>
<p><a href="https://www.hackingwithswift.com/example-code/language/what-is-the-autoclosure-attribute">What is the autoclosure attribute?</a></p>
<p><a href="https://www.swiftbysundell.com/articles/using-autoclosure-when-designing-swift-apis/">Using @autoclosure when designing Swift APIs</a>  æ¨èã€‚å…·ä½“çš„ä¸€äº›ä½¿ç”¨åœºæ™¯</p>
<h3 id="frozen"><a href="#frozen" class="headerlink" title="@frozen"></a>@frozen</h3><p>ç”¨äºæšä¸¾å’Œç»“æ„ä½“çš„å£°åã€‚frozenå†°å†»ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯è¿™ä¸ªæšä¸¾æˆ–ç»“æ„ä½“åº”è¯¥è¢«ä¸¥æ ¼é™åˆ¶æ”¹å˜ï¼Œä½ ä¸èƒ½å»æ·»åŠ æˆ–åˆ é™¤ã€é‡æ’caseæˆ–å±æ€§ç­‰ç­‰æ“ä½œã€‚å’Œfrozenç±»å‹äº¤äº’æ—¶ç¼–è¯‘å™¨ä¼šè¿›è¡Œä¸€äº›é¢å¤–çš„ä¼˜åŒ–ã€‚</p>
<h3 id="final"><a href="#final" class="headerlink" title="final"></a>final</h3><p>è¡¨ç¤ºä¸å…è®¸å¯¹å…¶ä¿®é¥°çš„å†…å®¹è¿›è¡Œç»§æ‰¿æˆ–è€…é‡å†™ç­‰ã€‚Swiftä¸­ï¼Œ<strong>final</strong>å…³é”®å­—å¯ä»¥åœ¨classã€funcå’Œvarå‰ä¿®é¥°ã€‚finalçš„ä½œç”¨:</p>
<ol>
<li>æƒé™æ§åˆ¶ã€‚ï¼ˆä¸»è¦ä½œç”¨ï¼‰</li>
<li>æå‡ç¨‹åºæ€§èƒ½ ã€‚ï¼ˆå¾®ä¼˜åŒ–ï¼‰</li>
</ol>
<p>å‚è€ƒï¼š<a href="https://www.jianshu.com/p/0f1e041705a4">Swift ç‰¹æ€§å…³é”®å­—finalçš„ç”¨æ³•</a></p>
<h3 id="objc"><a href="#objc" class="headerlink" title="@objc"></a>@objc</h3><p>æŠŠSwiftä»£ç ï¼ˆç±»ï¼Œæ–¹æ³•ï¼Œå±æ€§ç­‰ï¼‰æš´éœ²ç»™OCï¼Œè¿™æ ·OCä»£ç æ‰èƒ½è®¿é—®ã€‚æ··ç¼–æ—¶ç”¨åˆ°ã€‚</p>
<h3 id="dynamic"><a href="#dynamic" class="headerlink" title="dynamic"></a>dynamic</h3><p>è®©æ–¹æ³•è°ƒç”¨æ—¶èµ°OCçš„åŠ¨æ€æ´¾å‘ï¼Œç”±äºè¿è¡Œæ—¶æ˜¯OCçš„ç‰¹æ€§ï¼Œæ‰€ä»¥éœ€è¦é…åˆ@objcä½¿ç”¨ã€‚åœ¨å‡ ç§æ–¹æ³•æ´¾å‘é‡Œé¢æ˜¯æ€§èƒ½æœ€ä½çš„ã€‚</p>
<p>å‚è€ƒï¼š<a href="https://varun04tomar.medium.com/to-the-depth-of-objc-and-dynamic-in-swift-b5472800b85d">To the depth of @objc and dynamic in Swift</a></p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://docs.swift.org/swift-book/documentation/the-swift-programming-language/attributes/">Attributes</a>  å…³é”®å­—å®˜æ–¹æ–‡æ¡£ã€‚</p>
]]></content>
      <categories>
        <category>Swift</category>
      </categories>
      <tags>
        <tag>Swiftå…³é”®å­—</tag>
      </tags>
  </entry>
  <entry>
    <title>podåº“ä¾èµ–ç¬¬ä¸‰æ–¹OC++åº“ç¼–è¯‘æŠ¥é”™é—®é¢˜</title>
    <url>/2023/02/20/pod%E5%BA%93%E4%BE%9D%E8%B5%96%E7%AC%AC%E4%B8%89%E6%96%B9OC++%E5%BA%93%E7%BC%96%E8%AF%91%E6%8A%A5%E9%94%99%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<p>åœ¨å¼€å‘podåº“æ—¶ï¼Œé‡åˆ°äº†ä¸€ä¸ªç¼–è¯‘æŠ¥é”™çš„é—®é¢˜ï¼Œè®°å½•ä¸€ä¸‹ã€‚</p>
<p>ä¸»podæ˜¯OCå®ç°çš„ï¼Œä¸»podé‡Œä¾èµ–äº†WCDBï¼ˆä¸€ä¸ªOC++åº“ï¼‰ï¼Œä¸»podé‡Œæœ‰ä¸€ä¸ªå­podï¼Œå­podé‡‡ç”¨swiftå®ç°ã€‚å½“å®¿ä¸»å·¥ç¨‹é›†æˆå­podæ—¶ï¼Œç¼–è¯‘é€šä¸è¿‡ï¼ŒæŠ¥é”™åœ¨ï¼šWCDB.hé‡Œã€‚Since WCDBâ€¦</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> WCDB_h</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WCDB_h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __cplusplus</span></span><br><span class="line"><span class="meta">#<span class="keyword">error</span> Since WCDB is an Objective-C++ framework, for those files in your project that includes WCDB, you should rename their extension .m to .mm.</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>Googleäº†åŠå¤©ä¹Ÿæ²¡æœåˆ°ç±»ä¼¼çš„ï¼Œæ„Ÿè§‰åº”è¯¥æ˜¯æ··ç¼–å¯¼è‡´çš„é”™è¯¯ã€‚</p>
<p>æˆ‘çš„podspecæ–‡ä»¶ï¼š</p>
<figure class="highlight cal"><table><tr><td class="code"><pre><span class="line">spec.swift_versions = [<span class="string">&#x27;5.5&#x27;</span>, <span class="string">&#x27;5.6&#x27;</span>, <span class="string">&#x27;5.7&#x27;</span>]</span><br><span class="line">spec.requires_arc = <span class="literal">true</span></span><br><span class="line">spec.dependency <span class="string">&quot;CocoaLumberjack&quot;</span>, <span class="string">&quot;~&gt; 3.7.4&quot;</span></span><br><span class="line">spec.dependency <span class="string">&quot;WCDB&quot;</span>, <span class="string">&quot;~&gt; 1.1.0&quot;</span></span><br><span class="line"></span><br><span class="line">spec.default_subspecs = <span class="string">&#x27;Core&#x27;</span></span><br><span class="line"></span><br><span class="line">spec.subspec <span class="string">&#x27;Core&#x27;</span> <span class="keyword">do</span> |ss|</span><br><span class="line">  ss.source_files = <span class="string">&#x27;Sources/MATLog/**/*.&#123;h,m,mm&#125;&#x27;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">spec.subspec <span class="string">&#x27;Swift&#x27;</span> <span class="keyword">do</span> |ss|</span><br><span class="line">  ss.dependency <span class="string">&#x27;MATLog/Core&#x27;</span></span><br><span class="line">  ss.source_files = <span class="string">&#x27;Sources/MATLogSwift/**/*.&#123;swift,h,mm&#125;&#x27;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>å­podé‡Œå‹æ ¹å°±æ²¡ä½¿ç”¨åˆ°WCDBï¼Œå¾ˆå¥‡æ€ªä¸ºå•¥ä¼šæŠ¥é‚£ä¸ªé”™ã€‚æœä¹Ÿæ— ä»æœèµ·ï¼Œå†¥æ€è‹¦æƒ³åŠå¤©ï¼Œä¹Ÿå°± <code>MATLogModel+WCTTableCoding.h</code> å¤´æ–‡ä»¶é‡ŒåŒ…å«äº†WCDB.hï¼Œåæ¥å‘ç°ç¡®å®æ˜¯è¿™é‡Œå¼•èµ·çš„ã€‚</p>
<p>å› ä¸ºOC podåº“å¤´æ–‡ä»¶é»˜è®¤æ˜¯publicï¼Œæ‰€ä»¥å­åº“èƒ½è®¿é—®åˆ°ä¸»åº“æ‰€æœ‰æš´éœ²çš„å¤´æ–‡ä»¶ï¼Œä¿®æ”¹podspecæ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">spec.swift_versions = [<span class="string">&#x27;5.5&#x27;</span>, <span class="string">&#x27;5.6&#x27;</span>, <span class="string">&#x27;5.7&#x27;</span>]</span><br><span class="line">spec.requires_arc = <span class="keyword">true</span></span><br><span class="line">spec.dependency <span class="string">&quot;CocoaLumberjack&quot;</span>, <span class="string">&quot;~&gt; 3.7.4&quot;</span></span><br><span class="line">spec.dependency <span class="string">&quot;WCDB&quot;</span>, <span class="string">&quot;~&gt; 1.1.0&quot;</span></span><br><span class="line"></span><br><span class="line">spec.default_subspecs = <span class="string">&#x27;Core&#x27;</span></span><br><span class="line"></span><br><span class="line">spec.subspec <span class="string">&#x27;Core&#x27;</span> <span class="keyword">do</span> |ss|</span><br><span class="line">  ss.source_files = <span class="string">&#x27;Sources/MATLog/**/*.&#123;h,m,mm&#125;&#x27;</span></span><br><span class="line">  ss.private_header_files = <span class="string">&#x27;Sources/MATLog/*WCTTableCoding.&#123;h&#125;&#x27;</span> #æ§åˆ¶OCå¤´æ–‡ä»¶è®¿é—®æƒé™çš„æœ‰<span class="keyword">private</span>ã€<span class="keyword">project</span>ã€<span class="keyword">public</span>ä¸‰ç§ã€‚é»˜è®¤<span class="keyword">public</span></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">spec.subspec <span class="string">&#x27;Swift&#x27;</span> <span class="keyword">do</span> |ss|</span><br><span class="line">  ss.dependency <span class="string">&#x27;MATLog/Core&#x27;</span></span><br><span class="line">  ss.source_files = <span class="string">&#x27;Sources/MATLogSwift/**/*.&#123;swift,h,mm&#125;&#x27;</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>è¿™æ—¶ <code>MATLogModel+WCTTableCoding.h</code> å¤´æ–‡ä»¶å°±å˜æˆprivateäº†ï¼Œç¼–è¯‘ä¹Ÿèƒ½é€šè¿‡äº†ã€‚</p>
]]></content>
      <categories>
        <category>CocoaPods</category>
      </categories>
      <tags>
        <tag>æ··ç¼–</tag>
      </tags>
  </entry>
  <entry>
    <title>opensslä½¿ç”¨</title>
    <url>/2022/12/17/openssl%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h3 id="1-åˆ›å»ºç§é’¥"><a href="#1-åˆ›å»ºç§é’¥" class="headerlink" title="1.åˆ›å»ºç§é’¥"></a>1.åˆ›å»ºç§é’¥</h3><p>åˆ›å»ºä¸å¸¦å¯†ç çš„ç§é’¥ï¼š</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">openssl genrsa -<span class="keyword">out</span> test_rsa_private.pem <span class="number">1024</span></span><br></pre></td></tr></table></figure>
<p>1024è¡¨ç¤ºç§é’¥çš„é•¿åº¦ï¼Œé•¿åº¦è¶Šé•¿å®‰å…¨æ€§è¶Šé«˜ã€‚å¦‚æœå¯¹å®‰å…¨è¦æ±‚æ¯”è¾ƒé«˜å¯ä»¥æŒ‡å®šç§é’¥é•¿åº¦ä¸º2048ã€‚</p>
<p>æŸ¥çœ‹ç§é’¥ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> my_test_private.key</span><br></pre></td></tr></table></figure>
<p>æ‰“å°ï¼š</p>
<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">MIICXAIBAAKBgQCj5vQ2rQsavYxtJyNh<span class="symbol">/nugHqOvE2kmY492h8l4lPSr/zMT1I1Z</span></span><br><span class="line">D<span class="symbol">/yTkh3sDSZHNThWk5UJukXZPGsKf5xlAaj6WZiaPSBw5WW/f7Pm8M1+kNBKZGeK</span></span><br><span class="line">sSATuVfyPs69bTBl1Mn9YcBwHXkuu7ijqSxeE8aVlKsUSAR3JDIlFiCn0QIDAQAB</span><br><span class="line">AoGAfRuopCeYR1QSYaszVfSzlvhsRxJQ<span class="symbol">/A2ZD4f8oH9K+BL3gRaIwkfyqw4oqusq</span></span><br><span class="line">ocYc9<span class="symbol">/D1HZTDBlwY9M2NqogG28FJSMp2yVIHg8pG29FnGi5TGJBNV4kx4rmkpulr</span></span><br><span class="line"><span class="symbol">/E7TL1oRVioP2I6ZWxXk5xuiNvwzm60zhyRxuDHn5DHob1UCQQDRMzaTpawx5qHj</span></span><br><span class="line">p<span class="symbol">/yWLmgFyCVB07upFXF9jGOJHmZevgxgwoe6SSh9hzCEmJLY5kYo5eDW/76Nifd+</span></span><br><span class="line">so9ACSD7AkEAyJGNa<span class="symbol">/B7GRLPoYyyA8YUeTTTdWtDmU7lS4D2eceLPrzJbTrKnKR6</span></span><br><span class="line">nijlAWry<span class="symbol">/dKPFIFOq1z28X3gwxeT8aF4owJAJIvW1/pUV69bzsKVDMN0prXtVE+h</span></span><br><span class="line"><span class="number">9</span>Arr9avl45ls9tYqoWi6f1<span class="operator">+</span>ydCN<span class="operator">+</span><span class="number">5</span>VsmJEAuN4zZN5Yb<span class="operator">+</span>uwEUZzuC5jMqwJAA6Xi</span><br><span class="line">FJyDIKme7SlJ85eet7WmQvR4fklZEk5<span class="operator">+</span>LSjb94Anib0QAllbgZTs1WHEmalCwPS5</span><br><span class="line">IZTHSQ0pEWNUZYiyUQJBAIr0BOB3myFPMVGBB4EvQegnTd40JSU7hKXaK3ZBbrE<span class="symbol">/</span></span><br><span class="line">a<span class="attr">Hoxdlz8JJsuuufaaK4Rvkdy78QTuNu0vty9jonQQeM</span><span class="operator">=</span></span><br><span class="line"><span class="operator">-</span>----END RSA PRIVATE KEY-----</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°æ‰“å°æ˜¯base64è¿‡çš„ã€‚å¯ä»¥ä½¿ç”¨-textï¼Œä»¥æ˜æ–‡å½¢å¼è¾“å‡ºå„ä¸ªå‚æ•°å€¼</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">openssl rsa -<span class="keyword">in</span> test_rsa_private<span class="selector-class">.pem</span> -<span class="selector-tag">text</span> -noout</span><br></pre></td></tr></table></figure>
<p>æ‰“å°ï¼š</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">RSA</span> Private-Key: (<span class="number">1024</span> bit)</span><br><span class="line"><span class="attribute">modulus</span>:</span><br><span class="line">    <span class="attribute">00</span>:a3:e6:f4:<span class="number">36</span>:ad:<span class="number">0</span>b:<span class="number">1</span>a:bd:<span class="number">8</span>c:<span class="number">6</span>d:<span class="number">27</span>:<span class="number">23</span>:<span class="number">61</span>:fe:</span><br><span class="line">    <span class="attribute">7b</span>:a0:<span class="number">1</span>e:a3:af:<span class="number">13</span>:<span class="number">69</span>:<span class="number">26</span>:<span class="number">63</span>:<span class="number">8</span>f:<span class="number">76</span>:<span class="number">87</span>:c9:<span class="number">78</span>:<span class="number">94</span>:</span><br><span class="line">    <span class="attribute">f4</span>:ab:ff:<span class="number">33</span>:<span class="number">13</span>:d4:<span class="number">8</span>d:<span class="number">59</span>:<span class="number">0</span>f:fc:<span class="number">93</span>:<span class="number">92</span>:<span class="number">1</span>d:ec:<span class="number">0</span>d:</span><br><span class="line">    <span class="attribute">26</span>:<span class="number">47</span>:<span class="number">35</span>:<span class="number">38</span>:<span class="number">56</span>:<span class="number">93</span>:<span class="number">95</span>:<span class="number">09</span>:ba:<span class="number">45</span>:d9:<span class="number">3</span>c:<span class="number">6</span>b:<span class="number">0</span>a:<span class="number">7</span>f:</span><br><span class="line">    <span class="attribute">9c</span>:<span class="number">65</span>:<span class="number">01</span>:a8:fa:<span class="number">59</span>:<span class="number">98</span>:<span class="number">9</span>a:<span class="number">3</span>d:<span class="number">20</span>:<span class="number">70</span>:e5:<span class="number">65</span>:bf:<span class="number">7</span>f:</span><br><span class="line">    <span class="attribute">b3</span>:e6:f0:cd:<span class="number">7</span>e:<span class="number">90</span>:d0:<span class="number">4</span>a:<span class="number">64</span>:<span class="number">67</span>:<span class="number">8</span>a:b1:<span class="number">20</span>:<span class="number">13</span>:b9:</span><br><span class="line">    <span class="attribute">57</span>:f2:<span class="number">3</span>e:ce:bd:<span class="number">6</span>d:<span class="number">30</span>:<span class="number">65</span>:d4:c9:fd:<span class="number">61</span>:c0:<span class="number">70</span>:<span class="number">1</span>d:</span><br><span class="line">    <span class="attribute">79</span>:<span class="number">2</span>e:bb:b8:a3:a9:<span class="number">2</span>c:<span class="number">5</span>e:<span class="number">13</span>:c6:<span class="number">95</span>:<span class="number">94</span>:ab:<span class="number">14</span>:<span class="number">48</span>:</span><br><span class="line">    <span class="attribute">04</span>:<span class="number">77</span>:<span class="number">24</span>:<span class="number">32</span>:<span class="number">25</span>:<span class="number">16</span>:<span class="number">20</span>:a7:d1</span><br><span class="line"><span class="attribute">publicExponent</span>: <span class="number">65537</span> (<span class="number">0</span>x10001)</span><br><span class="line"><span class="attribute">privateExponent</span>:</span><br><span class="line">    <span class="attribute">7d</span>:<span class="number">1</span>b:a8:a4:<span class="number">27</span>:<span class="number">98</span>:<span class="number">47</span>:<span class="number">54</span>:<span class="number">12</span>:<span class="number">61</span>:ab:<span class="number">33</span>:<span class="number">55</span>:f4:b3:</span><br><span class="line">    <span class="attribute">96</span>:f8:<span class="number">6</span>c:<span class="number">47</span>:<span class="number">12</span>:<span class="number">50</span>:fc:<span class="number">0</span>d:<span class="number">99</span>:<span class="number">0</span>f:<span class="number">87</span>:fc:a0:<span class="number">7</span>f:<span class="number">4</span>a:</span><br><span class="line">    <span class="attribute">f8</span>:<span class="number">12</span>:f7:<span class="number">81</span>:<span class="number">16</span>:<span class="number">88</span>:c2:<span class="number">47</span>:f2:ab:<span class="number">0</span>e:<span class="number">28</span>:aa:eb:<span class="number">2</span>a:</span><br><span class="line">    <span class="attribute">a1</span>:c6:<span class="number">1</span>c:f7:f0:f5:<span class="number">1</span>d:<span class="number">94</span>:c3:<span class="number">06</span>:<span class="number">5</span>c:<span class="number">18</span>:f4:cd:<span class="number">8</span>d:</span><br><span class="line">    <span class="attribute">aa</span>:<span class="number">88</span>:<span class="number">06</span>:db:c1:<span class="number">49</span>:<span class="number">48</span>:ca:<span class="number">76</span>:c9:<span class="number">52</span>:<span class="number">07</span>:<span class="number">83</span>:ca:<span class="number">46</span>:</span><br><span class="line">    <span class="attribute">db</span>:d1:<span class="number">67</span>:<span class="number">1</span>a:<span class="number">2</span>e:<span class="number">53</span>:<span class="number">18</span>:<span class="number">90</span>:<span class="number">4</span>d:<span class="number">57</span>:<span class="number">89</span>:<span class="number">31</span>:e2:b9:a4:</span><br><span class="line">    <span class="attribute">a6</span>:e9:<span class="number">6</span>b:fc:<span class="number">4</span>e:d3:<span class="number">2</span>f:<span class="number">5</span>a:<span class="number">11</span>:<span class="number">56</span>:<span class="number">2</span>a:<span class="number">0</span>f:d8:<span class="number">8</span>e:<span class="number">99</span>:</span><br><span class="line">    <span class="attribute">5b</span>:<span class="number">15</span>:e4:e7:<span class="number">1</span>b:a2:<span class="number">36</span>:fc:<span class="number">33</span>:<span class="number">9</span>b:ad:<span class="number">33</span>:<span class="number">87</span>:<span class="number">24</span>:<span class="number">71</span>:</span><br><span class="line">    <span class="attribute">b8</span>:<span class="number">31</span>:e7:e4:<span class="number">31</span>:e8:<span class="number">6</span>f:<span class="number">55</span></span><br><span class="line"><span class="attribute">prime1</span>:</span><br><span class="line">    <span class="attribute">00</span>:d1:<span class="number">33</span>:<span class="number">36</span>:<span class="number">93</span>:a5:ac:<span class="number">31</span>:e6:a1:e3:a7:fc:<span class="number">96</span>:<span class="number">2</span>e:</span><br><span class="line">    <span class="attribute">68</span>:<span class="number">05</span>:c8:<span class="number">25</span>:<span class="number">41</span>:d3:bb:a9:<span class="number">15</span>:<span class="number">71</span>:<span class="number">7</span>d:<span class="number">8</span>c:<span class="number">63</span>:<span class="number">89</span>:<span class="number">1</span>e:</span><br><span class="line">    <span class="attribute">66</span>:<span class="number">5</span>e:be:<span class="number">0</span>c:<span class="number">60</span>:c2:<span class="number">87</span>:ba:<span class="number">49</span>:<span class="number">28</span>:<span class="number">7</span>d:<span class="number">87</span>:<span class="number">30</span>:<span class="number">84</span>:<span class="number">98</span>:</span><br><span class="line">    <span class="attribute">92</span>:d8:e6:<span class="number">46</span>:<span class="number">28</span>:e5:e0:d6:ff:be:<span class="number">8</span>d:<span class="number">89</span>:f7:<span class="number">7</span>e:b2:</span><br><span class="line">    <span class="attribute">8f</span>:<span class="number">40</span>:<span class="number">09</span>:<span class="number">20</span>:fb</span><br><span class="line"><span class="attribute">prime2</span>:</span><br><span class="line">    <span class="attribute">00</span>:c8:<span class="number">91</span>:<span class="number">8</span>d:<span class="number">6</span>b:f0:<span class="number">7</span>b:<span class="number">19</span>:<span class="number">12</span>:cf:a1:<span class="number">8</span>c:b2:<span class="number">03</span>:c6:</span><br><span class="line">    <span class="attribute">14</span>:<span class="number">79</span>:<span class="number">34</span>:d3:<span class="number">75</span>:<span class="number">6</span>b:<span class="number">43</span>:<span class="number">99</span>:<span class="number">4</span>e:e5:<span class="number">4</span>b:<span class="number">80</span>:f6:<span class="number">79</span>:c7:</span><br><span class="line">    <span class="attribute">8b</span>:<span class="number">3</span>e:bc:c9:<span class="number">6</span>d:<span class="number">3</span>a:ca:<span class="number">9</span>c:a4:<span class="number">7</span>a:<span class="number">9</span>e:<span class="number">28</span>:e5:<span class="number">01</span>:<span class="number">6</span>a:</span><br><span class="line">    <span class="attribute">f2</span>:fd:d2:<span class="number">8</span>f:<span class="number">14</span>:<span class="number">81</span>:<span class="number">4</span>e:ab:<span class="number">5</span>c:f6:f1:<span class="number">7</span>d:e0:c3:<span class="number">17</span>:</span><br><span class="line">    <span class="attribute">93</span>:f1:a1:<span class="number">78</span>:a3</span><br><span class="line"><span class="attribute">exponent1</span>:</span><br><span class="line">    <span class="attribute">24</span>:<span class="number">8</span>b:d6:d7:fa:<span class="number">54</span>:<span class="number">57</span>:af:<span class="number">5</span>b:ce:c2:<span class="number">95</span>:<span class="number">0</span>c:c3:<span class="number">74</span>:</span><br><span class="line">    <span class="attribute">a6</span>:b5:ed:<span class="number">54</span>:<span class="number">4</span>f:a1:f4:<span class="number">0</span>a:eb:f5:ab:e5:e3:<span class="number">99</span>:<span class="number">6</span>c:</span><br><span class="line">    <span class="attribute">f6</span>:d6:<span class="number">2</span>a:a1:<span class="number">68</span>:ba:<span class="number">7</span>f:<span class="number">5</span>f:b2:<span class="number">74</span>:<span class="number">23</span>:<span class="number">7</span>e:e5:<span class="number">5</span>b:<span class="number">26</span>:</span><br><span class="line">    <span class="attribute">24</span>:<span class="number">40</span>:<span class="number">2</span>e:<span class="number">37</span>:<span class="number">8</span>c:d9:<span class="number">37</span>:<span class="number">96</span>:<span class="number">1</span>b:fa:ec:<span class="number">04</span>:<span class="number">51</span>:<span class="number">9</span>c:ee:</span><br><span class="line">    <span class="attribute">0b</span>:<span class="number">98</span>:cc:ab</span><br><span class="line"><span class="attribute">exponent2</span>:</span><br><span class="line">    <span class="attribute">03</span>:a5:e2:<span class="number">14</span>:<span class="number">9</span>c:<span class="number">83</span>:<span class="number">20</span>:a9:<span class="number">9</span>e:ed:<span class="number">29</span>:<span class="number">49</span>:f3:<span class="number">97</span>:<span class="number">9</span>e:</span><br><span class="line">    <span class="attribute">b7</span>:b5:a6:<span class="number">42</span>:f4:<span class="number">78</span>:<span class="number">7</span>e:<span class="number">49</span>:<span class="number">59</span>:<span class="number">12</span>:<span class="number">4</span>e:<span class="number">7</span>e:<span class="number">2</span>d:<span class="number">28</span>:db:</span><br><span class="line">    <span class="attribute">f7</span>:<span class="number">80</span>:<span class="number">27</span>:<span class="number">89</span>:bd:<span class="number">10</span>:<span class="number">02</span>:<span class="number">59</span>:<span class="number">5</span>b:<span class="number">81</span>:<span class="number">94</span>:ec:d5:<span class="number">61</span>:c4:</span><br><span class="line">    <span class="attribute">99</span>:a9:<span class="number">42</span>:c0:f4:b9:<span class="number">21</span>:<span class="number">94</span>:c7:<span class="number">49</span>:<span class="number">0</span>d:<span class="number">29</span>:<span class="number">11</span>:<span class="number">63</span>:<span class="number">54</span>:</span><br><span class="line">    <span class="attribute">65</span>:<span class="number">88</span>:b2:<span class="number">51</span></span><br><span class="line"><span class="attribute">coefficient</span>:</span><br><span class="line">    <span class="attribute">00</span>:<span class="number">8</span>a:f4:<span class="number">04</span>:e0:<span class="number">77</span>:<span class="number">9</span>b:<span class="number">21</span>:<span class="number">4</span>f:<span class="number">31</span>:<span class="number">51</span>:<span class="number">81</span>:<span class="number">07</span>:<span class="number">81</span>:<span class="number">2</span>f:</span><br><span class="line">    <span class="attribute">41</span>:e8:<span class="number">27</span>:<span class="number">4</span>d:de:<span class="number">34</span>:<span class="number">25</span>:<span class="number">25</span>:<span class="number">3</span>b:<span class="number">84</span>:a5:da:<span class="number">2</span>b:<span class="number">76</span>:<span class="number">41</span>:</span><br><span class="line">    <span class="attribute">6e</span>:b1:<span class="number">3</span>f:<span class="number">68</span>:<span class="number">7</span>a:<span class="number">31</span>:<span class="number">76</span>:<span class="number">5</span>c:fc:<span class="number">24</span>:<span class="number">9</span>b:<span class="number">2</span>e:ba:e7:da:</span><br><span class="line">    <span class="attribute">68</span>:ae:<span class="number">11</span>:be:<span class="number">47</span>:<span class="number">72</span>:ef:c4:<span class="number">13</span>:b8:db:b4:be:dc:bd:</span><br><span class="line">    <span class="attribute">8e</span>:<span class="number">89</span>:d0:<span class="number">41</span>:e3</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºå¸¦å¯†ç çš„ç§é’¥ï¼š</p>
<figure class="highlight ceylon"><table><tr><td class="code"><pre><span class="line">openssl genrsa -des<span class="number">3</span> -passout pass:<span class="string">&quot;123456&quot;</span> -<span class="keyword">out</span> test<span class="number">_</span>encrypt<span class="number">_</span>rsa<span class="number">_p</span>rivate.pem <span class="number">2048</span></span><br><span class="line"><span class="comment">//æˆ–è€…è®©ç»ˆç«¯æç¤ºä½ è¾“å…¥å¯†ç </span></span><br><span class="line">openssl genrsa -des<span class="number">3</span> -<span class="keyword">out</span> test<span class="number">_</span>encrypt<span class="number">_</span>rsa<span class="number">_p</span>rivate.pem <span class="number">2048</span></span><br></pre></td></tr></table></figure>
<p>-des3è¡¨ç¤ºä½¿ç”¨des3å¯¹ç§°åŠ å¯†ç®—æ³•åŠ å¯†ç§é’¥ã€‚</p>
<p>è¿™ä¸ªæ—¶å€™å¦‚æœä½ è¿˜æƒ³ä»¥æ˜æ–‡å½¢å¼æŸ¥çœ‹ç§é’¥çš„å„ä¸ªå‚æ•°å°±éœ€è¦å¯†ç äº†ã€‚è¿™æ ·å³ä½¿ç§é’¥æ–‡ä»¶æ³„éœ²ï¼Œå¦‚æœå¯¹æ–¹æ²¡æœ‰å¯†ç ä¹Ÿæ˜¯æ²¡ç”¨çš„ã€‚</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">openssl rsa -<span class="keyword">in</span> test_encrypt_rsa_private<span class="selector-class">.pem</span> -<span class="selector-tag">text</span> -noout</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæˆ‘ä»¬åæœŸæƒ³æ·»åŠ ã€å»é™¤æˆ–è€…æ›´æ”¹å¯†ç ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p>
<h3 id="2-æ ¹æ®ç§é’¥æå–å…¬é’¥"><a href="#2-æ ¹æ®ç§é’¥æå–å…¬é’¥" class="headerlink" title="2.æ ¹æ®ç§é’¥æå–å…¬é’¥"></a>2.æ ¹æ®ç§é’¥æå–å…¬é’¥</h3><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">openssl rsa -<span class="keyword">in</span> test_rsa_private<span class="selector-class">.pem</span> -pubout -out test_rsa_public<span class="selector-class">.pem</span></span><br><span class="line">openssl rsa -<span class="keyword">in</span> test_encrypt_rsa_private<span class="selector-class">.pem</span> -passin pass:<span class="number">123456</span> -pubout -out test_encrypt_rsa_public<span class="selector-class">.pem</span></span><br><span class="line"><span class="comment">//æˆ–è€…è®©ç»ˆç«¯æç¤ºä½ è¾“å…¥å¯†ç </span></span><br><span class="line">openssl rsa -<span class="keyword">in</span> test_encrypt_rsa_private<span class="selector-class">.pem</span> -pubout -out test_encrypt_rsa_public.pem</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹å…¬é’¥ï¼š</p>
<figure class="highlight autohotkey"><table><tr><td class="code"><pre><span class="line">cat test_rs<span class="built_in">a_public</span>.pem</span><br></pre></td></tr></table></figure>
<p>æ‰“å°ï¼š</p>
<figure class="highlight vbnet"><table><tr><td class="code"><pre><span class="line">-----BEGIN <span class="keyword">PUBLIC</span> <span class="keyword">KEY</span>-----</span><br><span class="line">MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCj5vQ2rQsavYxtJyNh/nugHqOv</span><br><span class="line">E2kmY492h8l4lPSr/zMT1I1ZD/yTkh3sDSZHNThWk5UJukXZPGsKf5xlAaj6WZia</span><br><span class="line">PSBw5WW/f7Pm8M1+kNBKZGeKsSATuVfyPs69bTBl1Mn9YcBwHXkuu7ijqSxeE8aV</span><br><span class="line">lKsUSAR3JDIlFiCn0QIDAQAB</span><br><span class="line">-----<span class="keyword">END</span> <span class="keyword">PUBLIC</span> <span class="keyword">KEY</span>-----</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">openssl rsa -<span class="keyword">in</span> test_rsa_public<span class="selector-class">.pem</span> -pubin -<span class="selector-tag">text</span> -noout</span><br></pre></td></tr></table></figure>
<p>æ‰“å°ï¼š</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">RSA</span> Public-Key: (<span class="number">1024</span> bit)</span><br><span class="line"><span class="attribute">Modulus</span>:</span><br><span class="line">    <span class="attribute">00</span>:a3:e6:f4:<span class="number">36</span>:ad:<span class="number">0</span>b:<span class="number">1</span>a:bd:<span class="number">8</span>c:<span class="number">6</span>d:<span class="number">27</span>:<span class="number">23</span>:<span class="number">61</span>:fe:</span><br><span class="line">    <span class="attribute">7b</span>:a0:<span class="number">1</span>e:a3:af:<span class="number">13</span>:<span class="number">69</span>:<span class="number">26</span>:<span class="number">63</span>:<span class="number">8</span>f:<span class="number">76</span>:<span class="number">87</span>:c9:<span class="number">78</span>:<span class="number">94</span>:</span><br><span class="line">    <span class="attribute">f4</span>:ab:ff:<span class="number">33</span>:<span class="number">13</span>:d4:<span class="number">8</span>d:<span class="number">59</span>:<span class="number">0</span>f:fc:<span class="number">93</span>:<span class="number">92</span>:<span class="number">1</span>d:ec:<span class="number">0</span>d:</span><br><span class="line">    <span class="attribute">26</span>:<span class="number">47</span>:<span class="number">35</span>:<span class="number">38</span>:<span class="number">56</span>:<span class="number">93</span>:<span class="number">95</span>:<span class="number">09</span>:ba:<span class="number">45</span>:d9:<span class="number">3</span>c:<span class="number">6</span>b:<span class="number">0</span>a:<span class="number">7</span>f:</span><br><span class="line">    <span class="attribute">9c</span>:<span class="number">65</span>:<span class="number">01</span>:a8:fa:<span class="number">59</span>:<span class="number">98</span>:<span class="number">9</span>a:<span class="number">3</span>d:<span class="number">20</span>:<span class="number">70</span>:e5:<span class="number">65</span>:bf:<span class="number">7</span>f:</span><br><span class="line">    <span class="attribute">b3</span>:e6:f0:cd:<span class="number">7</span>e:<span class="number">90</span>:d0:<span class="number">4</span>a:<span class="number">64</span>:<span class="number">67</span>:<span class="number">8</span>a:b1:<span class="number">20</span>:<span class="number">13</span>:b9:</span><br><span class="line">    <span class="attribute">57</span>:f2:<span class="number">3</span>e:ce:bd:<span class="number">6</span>d:<span class="number">30</span>:<span class="number">65</span>:d4:c9:fd:<span class="number">61</span>:c0:<span class="number">70</span>:<span class="number">1</span>d:</span><br><span class="line">    <span class="attribute">79</span>:<span class="number">2</span>e:bb:b8:a3:a9:<span class="number">2</span>c:<span class="number">5</span>e:<span class="number">13</span>:c6:<span class="number">95</span>:<span class="number">94</span>:ab:<span class="number">14</span>:<span class="number">48</span>:</span><br><span class="line">    <span class="attribute">04</span>:<span class="number">77</span>:<span class="number">24</span>:<span class="number">32</span>:<span class="number">25</span>:<span class="number">16</span>:<span class="number">20</span>:a7:d1</span><br><span class="line"><span class="attribute">Exponent</span>: <span class="number">65537</span> (<span class="number">0</span>x10001)</span><br></pre></td></tr></table></figure>
<p>ok,åˆ°ç°åœ¨ä¸ºæ­¢rsaçš„å…¬ç§é’¥å·²ç»åˆ›å»ºå®Œæ¯•ï¼Œæˆ‘ä»¬å¯ä»¥è¯•ä¸€ä¸‹åŠ è§£å¯†æ–‡ä»¶äº†ã€‚</p>
<h3 id="3-å…¬é’¥åŠ å¯†ç§é’¥è§£å¯†"><a href="#3-å…¬é’¥åŠ å¯†ç§é’¥è§£å¯†" class="headerlink" title="3.å…¬é’¥åŠ å¯†ç§é’¥è§£å¯†"></a>3.å…¬é’¥åŠ å¯†ç§é’¥è§£å¯†</h3><p>æ³¨æ„ï¼šæ— è®ºæ˜¯ä½¿ç”¨å…¬é’¥åŠ å¯†è¿˜æ˜¯ç§é’¥åŠ å¯†ï¼ŒRSAæ¯æ¬¡èƒ½å¤ŸåŠ å¯†çš„æ•°æ®é•¿åº¦ä¸èƒ½è¶…è¿‡RSAå¯†é’¥é•¿åº¦ï¼Œå¹¶ä¸”æ ¹æ®å…·ä½“çš„è¡¥é½æ–¹å¼ä¸åŒè¾“å…¥çš„åŠ å¯†æ•°æ®æœ€å¤§é•¿åº¦ä¹Ÿä¸ä¸€æ ·ï¼Œè€Œè¾“å‡ºé•¿åº¦åˆ™æ€»æ˜¯è·ŸRSAå¯†é’¥é•¿åº¦ç›¸ç­‰ã€‚</p>
<p>å‡†å¤‡ä¸€ä¸ªplain.txtæ–‡ä»¶ï¼Œè¾“å…¥<code>hello world!</code></p>
<p>å…¬é’¥åŠ å¯†ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">openssl rsautl -encrypt -<span class="keyword">in</span> plain<span class="selector-class">.txt</span> -out encrypt_plain<span class="selector-class">.txt</span> -pubin -inkey test_rsa_public<span class="selector-class">.pem</span></span><br><span class="line">openssl rsautl -encrypt -<span class="keyword">in</span> plain<span class="selector-class">.txt</span> -out encrypt_plain1<span class="selector-class">.txt</span> -pubin -inkey test_encrypt_rsa_public.pem</span><br></pre></td></tr></table></figure>
<p>ç§é’¥è§£å¯†ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">openssl rsautl -decrypt -<span class="keyword">in</span> encrypt_plain<span class="selector-class">.txt</span> -inkey test_rsa_private<span class="selector-class">.pem</span> -out decrypt_plain<span class="selector-class">.txt</span></span><br><span class="line">openssl rsautl -decrypt -<span class="keyword">in</span> encrypt_plain1<span class="selector-class">.txt</span> -inkey test_encrypt_rsa_private<span class="selector-class">.pem</span> -passin pass:<span class="number">123456</span> -out decrypt_plain1<span class="selector-class">.txt</span></span><br><span class="line"><span class="comment">//æˆ–è€…</span></span><br><span class="line">openssl rsautl -decrypt -<span class="keyword">in</span> encrypt_plain1<span class="selector-class">.txt</span> -inkey test_encrypt_rsa_private<span class="selector-class">.pem</span> -out decrypt_plain1.txt</span><br></pre></td></tr></table></figure>
<p>æ‰“å¼€plain.txtã€decrypt_plain.txtã€decrypt_plain1.txté‡Œé¢çš„å†…å®¹åº”è¯¥æ˜¯ä¸€è‡´çš„ã€‚è¿™è¡¨æ˜å…¬é’¥åŠ å¯†ç§é’¥è§£å¯†æˆåŠŸã€‚</p>
<p>ps:å¯†ç ä¹Ÿå¯ä»¥ä¸è¾“å…¥åœ¨å‘½ä»¤ä¸­ï¼Œå¦‚æœéœ€è¦å¯†ç ï¼Œç»ˆç«¯ä¼šæç¤ºä½ è¾“å…¥çš„ã€‚</p>
<h3 id="4-ç§é’¥åŠ å¯†å…¬é’¥è§£å¯†"><a href="#4-ç§é’¥åŠ å¯†å…¬é’¥è§£å¯†" class="headerlink" title="4.ç§é’¥åŠ å¯†å…¬é’¥è§£å¯†"></a>4.ç§é’¥åŠ å¯†å…¬é’¥è§£å¯†</h3><p>ç§é’¥åŠ å¯†ï¼š</p>
<figure class="highlight fortran"><table><tr><td class="code"><pre><span class="line">openssl rsautl -<span class="built_in">sign</span> -<span class="keyword">in</span> plain.txt -inkey test_rsa_private.pem -<span class="keyword">out</span> <span class="built_in">sign</span>.txt</span><br><span class="line">openssl rsautl -<span class="built_in">sign</span> -<span class="keyword">in</span> plain.txt -inkey test_encrypt_rsa_private.pem -passin <span class="keyword">pass</span>:<span class="number">123456</span> -<span class="keyword">out</span> sign1.txt</span><br></pre></td></tr></table></figure>
<p>å…¬é’¥è§£å¯†ï¼š</p>
<figure class="highlight fortran"><table><tr><td class="code"><pre><span class="line">openssl rsautl -<span class="built_in">verify</span> -<span class="keyword">in</span> <span class="built_in">sign</span>.txt -inkey test_rsa_public.pem -pubin -<span class="keyword">out</span> verify_sign.txt</span><br><span class="line">openssl rsautl -<span class="built_in">verify</span> -<span class="keyword">in</span> sign1.txt -inkey test_encrypt_rsa_public.pem -pubin -<span class="keyword">out</span> verify_sign1.txt</span><br></pre></td></tr></table></figure>
<p>æ‰“å¼€plain.txtã€verify_sign.txtã€verify_sign1.txté‡Œé¢çš„å†…å®¹åº”è¯¥æ˜¯ä¸€è‡´çš„ã€‚è¿™è¡¨æ˜ç§é’¥åŠ å¯†å…¬é’¥è§£å¯†æˆåŠŸã€‚</p>
<h3 id="5-base64"><a href="#5-base64" class="headerlink" title="5.base64"></a>5.base64</h3><p>åŠ å¯†åçš„å†…å®¹æ˜¯äºŒè¿›åˆ¶æ‰“å¼€åæ˜¯ä¸€å †ä¹±ç æ— æ³•ç›´è§‚æŸ¥çœ‹ï¼Œå¯ä»¥å°†å…¶base64è½¬æ¢ä¸ºå¯æ‰“å°çš„å­—ç¬¦ä¸²ã€‚</p>
<p>base64åŠ å¯†:</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">openssl <span class="keyword">enc</span> -base64 -<span class="keyword">in</span> encrypt_plain.txt -<span class="keyword">out</span> base64_encrypt_plain.txt</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> base64_encrypt_plain.txt</span><br></pre></td></tr></table></figure>
<p>æ‰“å°ï¼š</p>
<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">hPuoNd2lLrszO6nmIHLwNVgCAXfrS4bWTFTTUS0s<span class="symbol">/3jFrLX6nIfdgr4R9ycUSIin</span></span><br><span class="line">dBLRf91TIi1q8qoa7Ct<span class="symbol">/NseM+EHjDXgxPSl0iwcdk2oJDNe9Rdl+KByy+CnCsPp3</span></span><br><span class="line">z47<span class="operator">+</span>W6mC<span class="operator">+</span>dNYlpL7FtFApcWfFUs2<span class="operator">+</span>a0Su4ix64PnFYQ<span class="operator">=</span></span><br></pre></td></tr></table></figure>
<p>base64è§£å¯†:</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">openssl enc -<span class="keyword">base64 </span>-d -in <span class="keyword">base64_encrypt_plain.txt </span>-out de_base64_encrypt_plain.txt</span><br></pre></td></tr></table></figure>
<p>å†ç”¨ç§é’¥è§£å¯†de_base64_encrypt_plain.txtçœ‹çœ‹èƒ½ä¸èƒ½è§£å¯†:</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">openssl rsautl -decrypt -<span class="keyword">in</span> de_base64_encrypt_plain<span class="selector-class">.txt</span> -inkey test_rsa_private<span class="selector-class">.pem</span> -out de_de_base64_encrypt_plain.txt</span><br></pre></td></tr></table></figure>
<p>æ‰“å¼€de_de_base64_encrypt_plain.txtï¼Œé‡Œé¢çš„å†…å®¹è¿˜æ˜¯<code>hello world!</code></p>
<h3 id="6-md5"><a href="#6-md5" class="headerlink" title="6.md5"></a>6.md5</h3><p>å‡†å¤‡ä¸€ä¸ªæ–‡ä»¶abc.txtï¼Œè¾“å…¥å†…å®¹â€œabcâ€</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">openssl</span> dgst -md5 abc.txt</span><br></pre></td></tr></table></figure>
<p>æ‰“å°ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">MD5</span><span class="params">(abc.txt)</span></span>= <span class="number">900150983</span>cd24fb0d6963f7d28e17f72</span><br></pre></td></tr></table></figure>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://www.cnblogs.com/morgan363/p/12965779.html">openssl genrsa å‘½ä»¤è¯¦è§£</a></p>
<p><a href="https://blog.csdn.net/oooo2316/article/details/104595615">opensslåŠ å¯†è§£å¯†</a></p>
]]></content>
      <categories>
        <category>å¯†ç å­¦</category>
      </categories>
      <tags>
        <tag>openssl</tag>
      </tags>
  </entry>
  <entry>
    <title>KVOçš„ä½¿ç”¨åŠå®ç°åŸç†</title>
    <url>/2022/11/24/KVO%E7%9A%84%E4%BD%BF%E7%94%A8%E5%8F%8A%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<h2 id="KVOä½¿ç”¨"><a href="#KVOä½¿ç”¨" class="headerlink" title="KVOä½¿ç”¨"></a>KVOä½¿ç”¨</h2><p>KVO,è§‚å¯Ÿè€…ä¸è¢«è§‚å¯Ÿè€….è¢«è§‚å¯Ÿè€…æ·»åŠ æŸä¸ªè§‚å¯Ÿè€…,è§‚å¯Ÿè‡ªèº«æŸä¸€å±æ€§çš„å˜åŒ–.å½“è¢«è§‚å¯Ÿè€…çš„å±æ€§å€¼å‘ç”Ÿå˜åŒ–æ—¶,è¢«è§‚å¯Ÿè€…ä¼šç›´æ¥å°†å˜åŒ–å‘é€ç»™è§‚å¯Ÿè€… (é€šè¿‡ç»™è§‚å¯Ÿè€…å‘é€observeValueForKeyPath:æ¶ˆæ¯),è¿™ä¹Ÿæ˜¯å’Œé€šçŸ¥å·®åˆ«æ¯”è¾ƒå¤§çš„åœ°æ–¹.</p>
<p>1.è§‚å¯Ÿè€…éœ€è¦å®ç°observeValueForKeyPath:æ–¹æ³•,å¹¶åœ¨è¯¥æ–¹æ³•ä¸­åšå‡ºç›¸åº”è¡Œä¸º.å¦‚æœè§‚å¯Ÿè€…æ²¡æœ‰å®ç°observeValueForKeyPath:æ–¹æ³•,ä¸”å…¶çˆ¶ç±»ä¹Ÿæ²¡æœ‰å®ç°ï¼Œé‚£ä¹ˆæœ€ç»ˆä¼šèµ°åˆ°NSObjectçš„å®ç°ï¼Œè€ŒNSObjectçš„é»˜è®¤å®ç°å°±æ˜¯å´©æºƒ:An -observeValueForKeyPath:ofObject:change:context: message was received but not handled.å¦‚æœè§‚å¯Ÿè€…æœ¬èº«æ²¡æœ‰å®ç°observeValueForKeyPath:â€¦æ–¹æ³•,ä½†æ˜¯å…¶çˆ¶ç±»å®ç°äº†,é‚£ä¹ˆæ‰§è¡Œçš„å°±æ˜¯çˆ¶ç±»çš„å®ç°,è¿™ä¹Ÿæ˜¯æ¶ˆæ¯çš„ä¼ é€’è¿‡ç¨‹.</p>
<p>2.[super observeValueForKeyPath:]</p>
<p>å¯¹äºç½‘ä¸Šä¸€ç§å†™æ³•:</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="type">id</span>)object</span><br><span class="line">change:(<span class="built_in">NSDictionary</span> *)change context:(<span class="type">void</span> *)context</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (object == _tableView &amp;&amp; [keyPath isEqualToString:<span class="string">@&quot;contentOffset&quot;</span>]) &#123;</span><br><span class="line">      [<span class="keyword">self</span> doSomethingWhenContentOffsetChanges];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      [<span class="variable language_">super</span> observeValueForKeyPath:keyPath ofObject:object change:change context:context];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œé¦–å…ˆè¦æ¸…æ¥š[super method]çš„ä½œç”¨,[super method]è¡¨ç¤ºçš„æ˜¯å»æ‰§è¡Œçˆ¶ç±»é‡Œçš„å®ç°,æ¶ˆæ¯çš„æ¥æ”¶è€…è¿˜æ˜¯å­ç±»å¯¹è±¡æœ¬èº«.å¹¶ä¸æ˜¯è¯´æ¶ˆæ¯çš„æ¥æ”¶è€…å˜æˆäº†ä¸€ä¸ªçˆ¶ç±»å¯¹è±¡åœ¨æ‰§è¡Œè¯¥æ–¹æ³•.å®Œæ•´çš„å†™æ³•ç¡®å®åº”è¯¥åœ¨elseå¤„æ·»åŠ superè°ƒç”¨ã€‚ä½†ç”±äºè¿™ç§åœºæ™¯å¾ˆå°‘å‡ºç°ï¼Œæ‰€ä»¥å¾ˆå°‘æœ‰äººç‰¹æ„å»è°ƒsuperï¼Œä¸€èˆ¬ä¹Ÿä¸ä¼šå‡ºé—®é¢˜ã€‚</p>
<p>3.KVOçš„contextå‚æ•°å–å€¼</p>
<p>contextå‚æ•°è™½ç„¶å¯ä»¥ä¼ å…¥ä»»æ„å€¼,ä½†å¦‚æœä¼ å…¥çš„æ˜¯ä¸€ä¸ªå¯¹è±¡,åˆ™å¿…é¡»ä¿è¯åœ¨KVOæœŸé—´è¯¥å¯¹è±¡ä¸ä¼šè¢«é”€æ¯.å¦åˆ™åœ¨observeValueForKeyPathæ–¹æ³•ä¸­å°†å¯¼è‡´é‡æŒ‡é’ˆè®¿é—®å´©æºƒ.å¯ä»¥ä¼ å…¥ä¸€äº›å¸¸é‡æ¯”å¦‚å­—ç¬¦ä¸²å¸¸é‡,æˆ–ç±»å¯¹è±¡.</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[<span class="keyword">self</span>.people addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@&quot;age&quot;</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionOld</span> context:(__bridge <span class="type">void</span> * _Nullable)(<span class="keyword">self</span>.class)];</span><br><span class="line"></span><br><span class="line">[<span class="keyword">self</span>.people addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@&quot;age&quot;</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionOld</span> context:<span class="string">@&quot;mycontext&quot;</span>];</span><br></pre></td></tr></table></figure>
<p> ä¸åº”è¯¥ä¼ å…¥ä¸€ä¸ªä¸´æ—¶å¯¹è±¡æ¯”å¦‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[<span class="keyword">self</span>.people addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@&quot;age&quot;</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionOld</span> context:(__bridge <span class="type">void</span> * _Nullable)([<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;%@&quot;</span>, <span class="built_in">NSStringFromClass</span>(<span class="keyword">self</span>.class)])];</span><br></pre></td></tr></table></figure>
<p>4.removeObserver:</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)removeObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath context:(<span class="keyword">nullable</span> <span class="type">void</span> *)context API_AVAILABLE(macos(<span class="number">10.7</span>), ios(<span class="number">5.0</span>), watchos(<span class="number">2.0</span>), tvos(<span class="number">9.0</span>));</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)removeObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨éƒ½æ˜¯ç§»é™¤è§‚å¯Ÿè€…. ä½¿ç”¨å¸¦contextçš„ç§»é™¤æ–¹æ³•,å¯ä»¥è®©ä½ ç²¾ç»†æ§åˆ¶ç§»é™¤æŒ‡å®šåœºæ™¯ä¸‹çš„è§‚å¯Ÿè€….</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)removeObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath context:(<span class="keyword">nullable</span> <span class="type">void</span> *)context <span class="built_in">NS_AVAILABLE</span>(<span class="number">10</span>_7, <span class="number">5</span>_0);</span><br></pre></td></tr></table></figure>
<p>å®˜æ–¹è¯´æ˜:<br>You should use -removeObserver:forKeyPath:context: instead of -removeObserver:forKeyPath: whenever possible because it allows you to more precisely specify your intent. When the same observer is registered for the same key path multiple times, but with different context pointers each time, -removeObserver:forKeyPath: has to guess at the context pointer when deciding what exactly to remove, and it can guess wrong.<br>ä¹Ÿå°±æ˜¯è¯´å½“ä¸€ä¸ªå¯¹è±¡å¤šæ¬¡æ³¨å†Œè§‚å¯ŸåŒä¸€ä¸ªkey pathä½†contextä¸åŒæ—¶,é‚£ä¹ˆä½¿ç”¨å¸¦contextçš„æ–¹æ³•å¯ä»¥è®©ä½ ç²¾ç¡®çš„ç§»é™¤æŸä¸ªcontextä¸‹çš„è§‚å¯Ÿ,è€Œå¦ä¸€ä¸ªç»§ç»­å·¥ä½œ.</p>
<p>5.KVOå‘</p>
<p>5.1 KVOçš„addObserverå’ŒremoveObserverè¦é…å¯¹ä½¿ç”¨,å¦åˆ™å¯¼è‡´å´©æºƒ.</p>
<p>5.1.1 æ·»åŠ æ¬¡æ•°&gt;ç§»é™¤æ¬¡æ•°ã€‚</p>
<p>å¸¸è§çš„æ˜¯æ·»åŠ äº†è€Œä¸è°ƒç”¨ç§»é™¤.è¿™ç§æƒ…å†µå´©æºƒéœ€è¦ä¸€å®šçš„æ¡ä»¶è§¦å‘ï¼šè§‚å¯Ÿè€…å…ˆäºè¢«è§‚å¯Ÿè€…é”€æ¯ï¼Œè¢«è§‚å¯Ÿè€…çš„å±æ€§å†å‘ç”Ÿæ”¹å˜ã€‚<br>Aæ·»åŠ äº†Bä½œä¸ºè§‚å¯Ÿè€…ï¼ŒBå…ˆäºAé”€æ¯ï¼ŒBé”€æ¯æ—¶éœ€è¦å°†Bä»è§‚å¯Ÿè€…åˆ—è¡¨ä¸­ç§»é™¤ã€‚å¦‚æœä¸ç§»é™¤,å½“è¢«è§‚å¯Ÿè€…çš„å±æ€§å‘ç”Ÿæ”¹å˜æ—¶,ç³»ç»Ÿä¾ç„¶ä¼šç»™è¿™ä¸ªå·²é”€æ¯çš„è§‚å¯Ÿè€…å‘é€observeValueForKeyPathæ¶ˆæ¯,ä»è€Œå¯¼è‡´é‡æŒ‡é’ˆå´©æºƒ.å†…éƒ¨å®ç°ä¼°è®¡æ˜¯unsafe_unretainå¼•ç”¨ã€‚</p>
<p>5.1.2 æ·»åŠ æ¬¡æ•°&lt;ç§»é™¤æ¬¡æ•°ã€‚</p>
<p>å¸¸è§çš„æ˜¯æ²¡æœ‰æ·»åŠ å´è°ƒç”¨ç§»é™¤.è¿™ç§æƒ…å†µæ˜¯é©¬ä¸Šå´©æºƒã€‚<br>å¦‚æœBä¸æ˜¯Açš„è§‚å¯Ÿè€…,é‚£ä¹ˆAå°±ä¸èƒ½å»removeObserver:B.å¦åˆ™å´©æºƒ:Cannot remove an observer <Student 0x60800001a020> for the key path â€œhighlightedâ€ from <UIButton 0x7fc29341f300> because it is not registered as an observer.<br>çœ‹èµ·æ¥æ˜¯åºŸè¯,ä½†ç¡®å®æœ‰å¯èƒ½å‘ç”Ÿ,æ¯”å¦‚Bä¹‹å‰æ˜¯Açš„è§‚å¯Ÿè€…,åæ¥A removeObserver:B,æ­¤æ—¶Bå°±ä¸å†æ˜¯Açš„è§‚å¯Ÿè€…,å¦‚æœåé¢AåˆremoveObserver:Bçš„è¯,å°±ä¼šå¯¼è‡´å´©æºƒ.è¿˜æœ‰ä¸€ç§åœºæ™¯å°±æ˜¯Bè¿˜æ²¡æ³¨å†Œæˆä¸ºAçš„è§‚å¯Ÿè€…æ—¶,Bå°±å…ˆé”€æ¯äº†,è€ŒBçš„deallocé‡Œæœ‰ç§»é™¤æ“ä½œï¼Œè¿™ä¸ªæ›´æœ‰å¯èƒ½å‘ç”Ÿ.</p>
<p>6.é‡å¤æ³¨å†Œ</p>
<p>å­ç±»SecondViewControllerçš„viewDidLoadé‡ŒaddObserverï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[<span class="keyword">self</span>.people addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@&quot;name&quot;</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionOld</span> context:<span class="literal">NULL</span>];</span><br></pre></td></tr></table></figure>
<p>çˆ¶ç±»BaseViewControllerçš„viewDidLoadé‡Œä¹ŸaddObserver:</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[<span class="keyword">self</span>.people addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@&quot;name&quot;</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionOld</span> context:<span class="literal">NULL</span>];</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºSecondViewControllerå®ä¾‹æ³¨å†Œäº†ä¸¤æ¬¡.å½“peopleçš„nameå‘ç”Ÿå˜åŒ–,ç³»ç»Ÿä¼šè°ƒç”¨SecondViewControllerå®ä¾‹çš„observeValueForKeyPathæ–¹æ³•ä¸¤æ¬¡.ç”±äºæ³¨å†Œäº†ä¸¤æ¬¡ï¼Œåœ¨ä¸éœ€è¦è§‚å¯Ÿæ—¶ä¹Ÿè¦ç§»é™¤ä¸¤æ¬¡ã€‚</p>
<h2 id="KVOå®ç°åŸç†"><a href="#KVOå®ç°åŸç†" class="headerlink" title="KVOå®ç°åŸç†"></a>KVOå®ç°åŸç†</h2><p>æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Tree</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> age;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)ageVarChanger:(<span class="built_in">NSInteger</span>)age;</span><br><span class="line"></span><br><span class="line">+ (<span class="type">void</span>)someClassMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) Tree *tree;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)addKVO &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;addå‰ï¼Œclass:%@, superClass:%@, setAge:%p&quot;</span>, object_getClass(<span class="keyword">self</span>.tree), class_getSuperclass(object_getClass(<span class="keyword">self</span>.tree)), [<span class="keyword">self</span>.tree methodForSelector:<span class="keyword">@selector</span>(setAge:)]);</span><br><span class="line">    [<span class="keyword">self</span> printObjectInstanceMethod:object_getClass(<span class="keyword">self</span>.tree)];</span><br><span class="line">    [<span class="keyword">self</span> printObjectClassMethod:object_getClass(<span class="keyword">self</span>.tree)];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.tree addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@&quot;age&quot;</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionOld</span> context:<span class="literal">NULL</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;addåï¼Œclass:%@, superClass:%@, setAge:%p&quot;</span>, object_getClass(<span class="keyword">self</span>.tree), class_getSuperclass(object_getClass(<span class="keyword">self</span>.tree)), [<span class="keyword">self</span>.tree methodForSelector:<span class="keyword">@selector</span>(setAge:)]);</span><br><span class="line">    [<span class="keyword">self</span> printObjectInstanceMethod:object_getClass(<span class="keyword">self</span>.tree)];</span><br><span class="line">    [<span class="keyword">self</span> printObjectClassMethod:object_getClass(<span class="keyword">self</span>.tree)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰“å°ï¼š</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">329809</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] addå‰ï¼Œclass:Tree, superClass:NSObject, setAge:<span class="number">0</span>x102fa76fc</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">329868</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] å®ä¾‹æ–¹æ³•,ageVarChanger:</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">329908</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] å®ä¾‹æ–¹æ³•,age</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">329947</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] å®ä¾‹æ–¹æ³•,setAge:</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">329977</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] å®ä¾‹æ–¹æ³•,name</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">330008</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] å®ä¾‹æ–¹æ³•,setName:</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">330037</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] å®ä¾‹æ–¹æ³•,.cxx_destruct</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">330076</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] ç±»æ–¹æ³•,someClassMethod</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">330198</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] addåï¼Œclass:NSKVONotifying_Tree, superClass:Tree, setAge:<span class="number">0</span>x180b5ff00</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">330235</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] å®ä¾‹æ–¹æ³•,setAge:</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">330268</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] å®ä¾‹æ–¹æ³•,class</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">330300</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] å®ä¾‹æ–¹æ³•,dealloc</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">13</span>.<span class="number">330330</span>+<span class="number">0800</span> UIObserver[<span class="number">10217</span>:<span class="number">296735</span>] å®ä¾‹æ–¹æ³•,_isKVOA</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°å¯¹è±¡æ·»åŠ è§‚å¯Ÿè€…åï¼Œå¯¹è±¡treeçš„isaæŒ‡é’ˆæŒ‡å‘çš„æ˜¯ç±»NSKVONotifying_Treeï¼Œè€Œä¸æ˜¯Treeã€‚å¹¶ä¸”setAge:æ–¹æ³•çš„å®ç°ä¹Ÿå˜äº†ã€‚NSKVONotifying_Treeæ˜¯Treeçš„å­ç±»ï¼Œå¹¶ä¸”é‡å†™äº†setAge:ã€‚</p>
<p>ä¸¾ä¸ªè¿è¡Œæ—¶åˆ›å»ºç±»çš„ä¾‹å­ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="variable language_">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    _obj = [ARCPerson new];</span><br><span class="line">    </span><br><span class="line">    Class newClass = objc_allocateClassPair([<span class="built_in">NSString</span> <span class="keyword">class</span>],</span><br><span class="line">    <span class="string">&quot;NSStringSubclass&quot;</span>, <span class="number">0</span>);</span><br><span class="line">     class_addMethod(newClass, <span class="keyword">@selector</span>(report), (IMP)ReportFunction, <span class="string">&quot;v@:&quot;</span>); objc_registerClassPair(newClass);</span><br><span class="line">    <span class="type">id</span> instanceOfNewClass = [[newClass alloc] init];</span><br><span class="line">     [instanceOfNewClass performSelector:<span class="keyword">@selector</span>(report)];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> ReportFunction(<span class="type">id</span> <span class="keyword">self</span>, SEL _cmd) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot; &gt;&gt; This object is %p.&quot;</span>, <span class="keyword">self</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot; &gt;&gt; Class is %@, and super is %@.&quot;</span>, [<span class="keyword">self</span> <span class="keyword">class</span>], [<span class="keyword">self</span> superclass]);</span><br><span class="line">    Class prevClass = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> count = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (Class currentClass = [<span class="keyword">self</span> <span class="keyword">class</span>]; currentClass; ++count) &#123;</span><br><span class="line">        prevClass = currentClass;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot; &gt;&gt; Following the isa pointer %d times gives %p&quot;</span>, count, currentClass);</span><br><span class="line">        currentClass = object_getClass(currentClass);</span><br><span class="line">        <span class="keyword">if</span> (prevClass == currentClass)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot; &gt;&gt; NSObject&#x27;s class is %p&quot;</span>, [<span class="built_in">NSObject</span> <span class="keyword">class</span>]);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot; &gt;&gt; NSObject&#x27;s meta class is %p&quot;</span>, object_getClass([<span class="built_in">NSObject</span> <span class="keyword">class</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å®‰å…¨çš„ä½¿ç”¨KVO"><a href="#å®‰å…¨çš„ä½¿ç”¨KVO" class="headerlink" title="å®‰å…¨çš„ä½¿ç”¨KVO"></a>å®‰å…¨çš„ä½¿ç”¨KVO</h2><p>å‰é¢åˆ†æäº†KVOçš„ä½¿ç”¨æ·»åŠ å’Œç§»é™¤æ¬¡æ•°å¿…é¡»åŒ¹é…ï¼Œå¦åˆ™å¾ˆå®¹æ˜“å´©æºƒã€‚ä½†æ˜¯åœ¨æ—¥å¸¸ä½¿ç”¨ä¸­æœ‰æ—¶è¿˜æ˜¯ä¼šå‡ºç°ä¸åŒ¹é…çš„æƒ…å†µï¼Œæœ‰æ²¡æœ‰å¯èƒ½ä»æŠ€æœ¯å±‚é¢å®Œå…¨é¿å…å‘¢ï¼Ÿæœ‰ï¼Œç­”æ¡ˆå°±æ˜¯Facebookå¼€æºçš„KVOControllerã€‚KVOControlleråœ¨æˆ‘çœ‹æ¥æœ‰ä¸‹é¢å‡ ä¸ªä¼˜åŠ¿ï¼š</p>
<ol>
<li>APIæ›´åŠ ç°ä»£ï¼Œä½¿ç”¨æ›´åŠ æ–¹ä¾¿ã€‚æä¾›blockå’Œselectorï¼Œä¸ä»…å¦‚æ­¤ç«Ÿç„¶è¿˜æ”¯æŒåœ¨åŸç”Ÿæ–¹æ³•é‡Œå¤„ç†ã€‚</li>
<li>çº¿ç¨‹å®‰å…¨ã€‚</li>
<li>å¯ä»¥é¿å…æ·»åŠ å’Œç§»é™¤æ¬¡æ•°ä¸åŒ¹é…çš„é—®é¢˜ã€‚</li>
<li>è§‚å¯Ÿè€…é”€æ¯æ—¶è‡ªåŠ¨è¢«ç§»é™¤ï¼ˆå¦‚æœéœ€è¦ï¼‰ã€‚</li>
</ol>
<p>ç¼ºç‚¹ï¼š</p>
<ol>
<li>ä¸æ”¯æŒè®¾ç½®å¤šä¸ªcontextã€‚</li>
<li>å…¶ä»–ä¸€äº›åé—¨åœºæ™¯å¯èƒ½ä¼šæœ‰é—®é¢˜ã€‚</li>
</ol>
<p>å¦‚æœä½ ä¸æƒ³ç”¨KVOControllerï¼Œä¹Ÿæœ‰ä¸¤ä¸ªç®€å•çš„æ–¹æ³•ï¼š</p>
<ol>
<li>è‡ªå·±å®šä¹‰ä¸€ä¸ªæ ‡å¿—ä½ï¼Œæ·»åŠ äº†è®¾ç½®ä¸ºtrueï¼Œç§»é™¤æ—¶å…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯æ·»åŠ äº†ï¼Œæ·»åŠ äº†æ‰ç§»é™¤ã€‚</li>
<li>ä½¿ç”¨try-catchåŒ…è£¹ç§»é™¤æ–¹æ³•ã€‚</li>
</ol>
<p>ç›¸è¾ƒèµ·æ¥è¿˜æ˜¯KVOControlleræ›´ç‰›é€¼ã€‚ä¸è¿‡å°è£…æœ¬èº«å°±æ˜¯è¶Šå°è£…ä½¿ç”¨è¶Šæ–¹ä¾¿ï¼Œä½†åŠŸèƒ½ç»†èŠ‚ä¹Ÿä¸¢å¤±å¾—è¶Šå¤šã€‚çœ‹æƒ…å†µä½¿ç”¨å§ã€‚</p>
<h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><ol>
<li><p>ä¸­é—´ç±»æ˜¯ä»€ä¹ˆæ—¶å€™ç”Ÿæˆçš„ï¼Ÿæ˜¯åœ¨ç¼–è¯‘æœŸé—´ç”Ÿæˆè¿˜æ˜¯è¿è¡Œæ—¶ç”Ÿæˆï¼Ÿ</p>
<p>è¿è¡Œæ—¶ç”Ÿæˆã€‚</p>
<p>p1å¯¹è±¡æ‰§è¡Œè¿‡addObserveræ“ä½œä¹‹åï¼Œp1å¯¹è±¡çš„isaæŒ‡é’ˆç”±ä¹‹å‰çš„æŒ‡å‘ç±»å¯¹è±¡Personå˜ä¸ºæŒ‡å‘NSKVONotifyin_Personç±»å¯¹è±¡ï¼Œè€Œp2å¯¹è±¡æ²¡æœ‰ä»»ä½•æ”¹å˜ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸€æ—¦p1å¯¹è±¡æ·»åŠ äº†KVOç›‘å¬ä»¥åï¼Œå…¶isaæŒ‡é’ˆå°±ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå› æ­¤setæ–¹æ³•çš„æ‰§è¡Œæ•ˆæœå°±ä¸ä¸€æ ·äº†ã€‚</p>
<p>å½“ä¸€ä¸ªå¯¹è±¡ä½¿ç”¨äº†KVOç›‘å¬ï¼ŒiOSç³»ç»Ÿä¼šä¿®æ”¹è¿™ä¸ªå¯¹è±¡çš„isaæŒ‡é’ˆï¼Œæ”¹ä¸ºæŒ‡å‘ä¸€ä¸ªå…¨æ–°çš„é€šè¿‡RuntimeåŠ¨æ€åˆ›å»ºçš„å­ç±»ï¼Œå­ç±»æ‹¥æœ‰è‡ªå·±çš„setæ–¹æ³•å®ç°ï¼Œsetæ–¹æ³•å®ç°å†…éƒ¨ä¼šé¡ºåºè°ƒç”¨<strong>willChangeValueForKeyæ–¹æ³•ã€åŸæ¥çš„setteræ–¹æ³•å®ç°ã€didChangeValueForKeyæ–¹æ³•ï¼Œè€ŒdidChangeValueForKeyæ–¹æ³•å†…éƒ¨åˆä¼šè°ƒç”¨ç›‘å¬å™¨çš„observeValueForKeyPath:ofObject:change:context:ç›‘å¬æ–¹æ³•ã€‚</strong></p>
</li>
<li><p>ä¸­é—´ç±»å’ŒåŸç±»çš„å…³ç³»ï¼Ÿ</p>
<p>ç”Ÿæˆçš„ä¸­é—´ç±»NSKVONotifyin_Personæ˜¯åŸç±»Personçš„å­ç±»ï¼Œå¹¶ä¸”é‡å†™äº†setAge:ï¼Œclassæ–¹æ³•ã€‚é‡å†™classæ–¹æ³•ï¼Œå¯ä»¥è®©å¤–éƒ¨ä»¥ä¸ºä½¿ç”¨çš„è¿˜æ˜¯åŸç±»ï¼Œè¿™æ ·å°±éšè—äº†å®ç°ç»†èŠ‚ã€‚å½“ç»™å¯¹è±¡å‘é€å…¶ä»–æ¶ˆæ¯æ—¶ï¼Œç”±äºNSKVONotifyin_Personæ˜¯Personçš„å­ç±»ï¼Œè€ŒNSKVONotifyin_Personåˆæ²¡æœ‰é‡å†™è¿™äº›æ–¹æ³•ï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œåˆ°çˆ¶ç±»çš„å®ç°ï¼Œéå¸¸çš„å®Œç¾ã€‚</p>
</li>
</ol>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://juejin.cn/post/6844903593925935117">iOSåº•å±‚åŸç†æ€»ç»“ - æ¢å¯»KVOæœ¬è´¨</a></p>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
      <tags>
        <tag>KVO</tag>
      </tags>
  </entry>
  <entry>
    <title>å·¦ç§»ä¸å³ç§»</title>
    <url>/2022/10/17/%E5%B7%A6%E7%A7%BB%E4%B8%8E%E5%8F%B3%E7%A7%BB/</url>
    <content><![CDATA[<p>å·¦ç§»ä¸å³ç§»ï¼š</p>
<figure class="highlight excel"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;&gt;&gt;&quot;</span>å³ç§»</span><br><span class="line">æ“ä½œè§„åˆ™ï¼šæœ€ä½ä½ä¸¢å¼ƒã€‚æ­£æ•°å‰é¢è¡¥é›¶ï¼Œè´Ÿæ•°å‰é¢è¡¥<span class="number">1</span>ã€‚</span><br><span class="line"><span class="string">&quot;&lt;&lt;&quot;</span>å·¦ç§»</span><br><span class="line">æ“ä½œè§„åˆ™ï¼šæœ€é«˜ä½ä¸¢å¼ƒã€‚æ— è®ºæ­£è´Ÿæ•°ï¼Œåé¢è¡¥é›¶ã€‚</span><br><span class="line">å»ºè®®ï¼šå·¦å³ç§»æ—¶å‚æ•°æœ€å¥½é™å®šä¸ºæ— ç¬¦å·æ•°æˆ–æ­£æ•´æ•°ã€‚æœ‰ç¬¦å·æ•°éœ€è¦æ³¨æ„çš„åœ°æ–¹å¤ªå¤šäº†ã€‚</span><br><span class="line"></span><br><span class="line">æœ‰ç¬¦å·æ•°ï¼š</span><br><span class="line">æ ¹æ®å†…å­˜åˆ†å¸ƒï¼ŒæŒ‰ä¸Šè¿°è§„åˆ™ç§»åŠ¨ã€‚</span><br><span class="line">å·¦ç§»ï¼šç”±äºæœ‰ç¬¦å·æ•°æœ€é«˜ä½ä¸ºç¬¦å·ä½ï¼Œå·¦ç§»æ—¶å¯èƒ½ä¼šå‘ç”Ÿç¬¦å·ä½å˜åŒ–æ‰€ä»¥æœ€å¥½è‡ªå·±æ ¹æ®å†…å­˜åˆ†å¸ƒè®¡ç®—ã€‚</span><br><span class="line">å³ç§»ï¼šå¦‚æœæ•°ä¸ºæ­£ï¼Œä¸æº¢å‡ºçš„æƒ…å†µä¸‹ï¼Œæ¯ç§»ä¸€ä½ç›¸å½“äºé™¤ä»¥<span class="number">2</span>å¹¶å‘ä¸‹å–æ•´ï¼Œç­‰ä»·äºé™¤ä»¥<span class="number">2</span>ã€‚å¦‚æœæ•°ä¸ºè´Ÿï¼Œæ¯ç§»ä¸€ä½ç›¸å½“äºé™¤ä»¥<span class="number">2</span>å¹¶å‘ä¸Šå–æ•´ã€‚å¦‚-<span class="number">1</span>ï¼Œ-<span class="number">1</span>/<span class="number">2</span> = -<span class="number">0.5</span>å‘ä¸Šå–æ•´ = -<span class="number">1</span>ã€‚-<span class="number">3</span>ï¼Œ-<span class="number">3</span>/<span class="number">2</span> = -<span class="number">1.5</span>å‘ä¸Šå–æ•´ = -<span class="number">2</span>ã€‚</span><br><span class="line"></span><br><span class="line">æ— ç¬¦å·æ•°ï¼š</span><br><span class="line">å·¦ç§»ï¼šä¸æº¢å‡ºçš„æƒ…å†µä¸‹ï¼Œå·¦ç§»ä¸€ä½ç›¸å½“äºä¹˜<span class="number">2</span>ã€‚</span><br><span class="line">å³ç§»ï¼šä¸æº¢å‡ºçš„æƒ…å†µä¸‹ï¼Œå³ç§»ä¸€ä½ç›¸å½“äºé™¤<span class="number">2</span>å¹¶å‘ä¸‹å–æ•´ï¼Œç­‰ä»·äºé™¤ä»¥<span class="number">2</span>ã€‚</span><br><span class="line"></span><br><span class="line"><span class="built_in">n</span>           = <span class="number">1010</span> <span class="number">1000</span></span><br><span class="line"><span class="built_in">n</span> - <span class="number">1</span>       = <span class="number">1010</span> <span class="number">0111</span></span><br><span class="line"><span class="built_in">n</span> &amp; (<span class="built_in">n</span> - <span class="number">1</span>) = <span class="number">1010</span> <span class="number">0000</span>  //ç›¸å½“äºå°†<span class="built_in">n</span>çš„æœ€å³è¾¹çš„<span class="number">1</span>æ¶ˆä¸º<span class="number">0</span>ã€‚<span class="built_in">n</span>ä¸ºæ­£æ•°æˆ–è´Ÿæ•°éƒ½å¯ä»¥ã€‚</span><br><span class="line">è€Œå³ç§»éœ€è¦å‚æ•°ä¸ºæ­£æ•°ã€‚</span><br><span class="line">åœ¨æ•°äºŒè¿›åˆ¶<span class="number">1</span>çš„ä¸ªæ•°æ–¹é¢ï¼Œ<span class="built_in">n</span> &amp; (<span class="built_in">n</span> - <span class="number">1</span>)æ˜¯æœ€ä½³è§£å†³åŠæ³•ã€‚</span><br></pre></td></tr></table></figure>
<p>ä»£ç ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">char</span> a = <span class="number">-3</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;a = %d\n&quot;</span>, a);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> cnt = <span class="built_in">hammingWeight</span>(a); <span class="comment">//ä¼šè¢«å¼ºè½¬ä¸ºintã€‚</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;cnt = %d\n&quot;</span>, cnt);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> b = a &gt;&gt; <span class="number">1</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;b = %dï¼Œa / 2 = %d\n&quot;</span>, b, a / <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> c = <span class="number">3</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;c = %d\n&quot;</span>, c);</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> d = c &gt;&gt; <span class="number">1</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;d = %d\n&quot;</span>, d);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">hammingWeight</span><span class="params">(<span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (n != <span class="number">0</span>) &#123;</span><br><span class="line">        cnt += <span class="number">1</span>;</span><br><span class="line">        n &amp;= n - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cnt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰“å°ï¼š</p>
<figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">a</span> <span class="operator">=</span> -<span class="number">3</span></span><br><span class="line"><span class="attribute">cnt</span> <span class="operator">=</span> <span class="number">31</span></span><br><span class="line"><span class="attribute">b</span> <span class="operator">=</span> -<span class="number">2</span>ï¼Œa / <span class="number">2</span> <span class="operator">=</span> -<span class="number">1</span></span><br><span class="line"><span class="attribute">c</span> <span class="operator">=</span> <span class="number">3</span></span><br><span class="line"><span class="attribute">d</span> <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>C</category>
      </categories>
      <tags>
        <tag>ç§»ä½</tag>
      </tags>
  </entry>
  <entry>
    <title>NSCopyingåè®®</title>
    <url>/2022/10/11/NSCopying%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%AE%9E%E7%8E%B0/</url>
    <content><![CDATA[<p>NSCopyingåè®®ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">NSCopying</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">id</span>)copyWithZone:(<span class="keyword">nullable</span> <span class="built_in">NSZone</span> *)zone; <span class="comment">//å®ä¾‹æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">NSMutableCopying</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">id</span>)mutableCopyWithZone:(<span class="keyword">nullable</span> <span class="built_in">NSZone</span> *)zone; <span class="comment">//å®ä¾‹æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>åˆ†ä¸ºä¸å¯å˜å’Œå¯å˜ä¸¤ç§æ‹·è´ã€‚zoneå‚æ•°æ˜¯è¢«å¿½ç•¥çš„ï¼Œå› æ­¤å¯ä»¥ä¸ç®¡ã€‚</p>
<p>å®ç°ï¼š</p>
<p>å…·ä½“æ€ä¹ˆå®ç°ç›´æ¥å‚è€ƒçŸ¥åå¼€æºæ¡†æ¶çš„å†™æ³•ï¼Œè·Ÿç€å¤§ä½¬æ¥è‚¯å®šæ²¡é”™ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nullable</span>) <span class="built_in">NSSet</span> &lt;<span class="built_in">NSData</span> *&gt; *pinnedCertificates;</span><br><span class="line">- (<span class="keyword">instancetype</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone &#123;</span><br><span class="line">    AFSecurityPolicy *securityPolicy = [[[<span class="keyword">self</span> <span class="keyword">class</span>] allocWithZone:zone] init];</span><br><span class="line">    securityPolicy.SSLPinningMode = <span class="keyword">self</span>.SSLPinningMode; <span class="comment">//å€¼ç±»å‹ï¼Œç›´æ¥èµ‹å€¼å°±å¯ä»¥äº†ã€‚</span></span><br><span class="line">    securityPolicy.allowInvalidCertificates = <span class="keyword">self</span>.allowInvalidCertificates;</span><br><span class="line">    securityPolicy.validatesDomainName = <span class="keyword">self</span>.validatesDomainName;</span><br><span class="line">    securityPolicy.pinnedCertificates = [<span class="keyword">self</span>.pinnedCertificates copyWithZone:zone]; <span class="comment">//å¯¹è±¡ç±»å‹è°ƒç”¨copyWithZoneï¼Œéœ€è¦ç¡®ä¿å¯¹è±¡å·²ç»å®ç°äº†copyåè®®ã€‚è¿™é‡Œä¸éœ€è¦å¯å˜æ‰€ä»¥è°ƒç”¨copyWithZone</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> securityPolicy;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableDictionary</span> *mutableHTTPRequestHeaders;</span><br><span class="line">- (<span class="keyword">instancetype</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone &#123;</span><br><span class="line">    AFHTTPRequestSerializer *serializer = [[[<span class="keyword">self</span> <span class="keyword">class</span>] allocWithZone:zone] init];</span><br><span class="line">    <span class="built_in">dispatch_sync</span>(<span class="keyword">self</span>.requestHeaderModificationQueue, ^&#123;</span><br><span class="line">      	<span class="comment">//è¿™é‡Œéœ€è¦å¯å˜æ‰€ä»¥è°ƒç”¨mutableCopyWithZone</span></span><br><span class="line">        serializer.mutableHTTPRequestHeaders = [<span class="keyword">self</span>.mutableHTTPRequestHeaders mutableCopyWithZone:zone];</span><br><span class="line">    &#125;);</span><br><span class="line">    serializer.queryStringSerializationStyle = <span class="keyword">self</span>.queryStringSerializationStyle;</span><br><span class="line">    serializer.queryStringSerialization = <span class="keyword">self</span>.queryStringSerialization;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> serializer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//---AFHTTPResponseSerializer</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - NSCopying</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone &#123;</span><br><span class="line">    AFHTTPResponseSerializer *serializer = [[[<span class="keyword">self</span> <span class="keyword">class</span>] allocWithZone:zone] init]; <span class="comment">//ä¸èƒ½å†™æ­»ä¸º[AFHTTPResponseSerializer allocWithZone:zone]</span></span><br><span class="line">    serializer.acceptableStatusCodes = [<span class="keyword">self</span>.acceptableStatusCodes copyWithZone:zone];</span><br><span class="line">    serializer.acceptableContentTypes = [<span class="keyword">self</span>.acceptableContentTypes copyWithZone:zone];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> serializer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//---AFCompoundResponseSerializer:AFHTTPResponseSerializer</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSArray</span> *responseSerializers;</span><br><span class="line">- (<span class="keyword">instancetype</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone &#123;</span><br><span class="line">    AFCompoundResponseSerializer *serializer = [<span class="variable language_">super</span> copyWithZone:zone];</span><br><span class="line">    serializer.responseSerializers = <span class="keyword">self</span>.responseSerializers; <span class="comment">//responseSerializerså±æ€§æ˜¯copyï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥èµ‹å€¼ã€‚setteræ–¹æ³•é‡Œä¼šè°ƒç”¨copy.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> serializer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœçˆ¶ç±»å®ç°äº†åˆ™å¿…é¡»è°ƒç”¨superï¼Œå¦åˆ™ä¼šä¸¢å¤±ä¿¡æ¯ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone &#123;</span><br><span class="line">    AFPropertyListResponseSerializer *serializer = [<span class="variable language_">super</span> copyWithZone:zone]; <span class="comment">//è°ƒç”¨super</span></span><br><span class="line">    serializer.format = <span class="keyword">self</span>.format;</span><br><span class="line">    serializer.readOptions = <span class="keyword">self</span>.readOptions;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> serializer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼šNSObjectæ˜¯æ²¡æœ‰å®ç°copyåè®®çš„ã€‚</p>
<p>NSObjectä¸‹æœ‰ä¸¤ä¸ªå®ä¾‹æ–¹æ³•ï¼š</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">id</span>)<span class="keyword">copy</span>;</span><br><span class="line">- (<span class="built_in">id</span>)mutableCopy;</span><br></pre></td></tr></table></figure>
<p>ä»–ä»¬ä»…ä»…æ˜¯è¿”å›å¯¹åº”çš„copyåè®®æ–¹æ³•çš„å€¼ã€‚å¦‚æœå¯¹è±¡æ²¡å®ç°åˆ™ä¼šå´©æºƒã€‚è¿™ä¸¤ä¸ªæ–¹æ³•åªæ˜¯æ–¹ä¾¿ä½¿ç”¨ã€‚</p>
<figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line">This <span class="keyword">is</span> a convenience <span class="keyword">method</span> <span class="title function_">for</span> <span class="title function_">classes</span> <span class="title function_">that</span> <span class="title function_">adopt</span> <span class="title function_">the</span> <span class="title function_">NSCopying</span> <span class="title function_">protocol</span>. <span class="title function_">An</span> <span class="title function_">exception</span> <span class="title function_">is</span> <span class="title function_">raised</span> <span class="title function_">if</span> <span class="title function_">there</span> <span class="title function_">is</span> <span class="title function_">no</span> <span class="title function_">implementation</span> <span class="title function_">for</span> <span class="title function_">copyWithZone</span>:.</span><br><span class="line">NSObject does <span class="keyword">not</span> itself support the NSCopying protocol. Subclasses must support the protocol <span class="keyword">and</span> implement the copyWithZone: <span class="keyword">method</span>. A subclass version <span class="keyword">of</span> the copyWithZone: <span class="keyword">method</span> <span class="title function_">should</span> <span class="title function_">send</span> <span class="title function_">the</span> <span class="title function_">message</span> <span class="title function_">to</span> <span class="title function_">super</span> <span class="title function_">first</span>, <span class="title function_">to</span> <span class="title function_">incorporate</span> <span class="title function_">its</span> <span class="title function_">implementation</span>, <span class="title function_">unless</span> <span class="title function_">the</span> <span class="title function_">subclass</span> <span class="title function_">descends</span> <span class="title function_">directly</span> <span class="title function_">from</span> <span class="title function_">NSObject</span>.</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
      <tags>
        <tag>NSCopying</tag>
      </tags>
  </entry>
  <entry>
    <title>OCå†…å­˜ç®¡ç†å˜è¿</title>
    <url>/2022/10/10/OC%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%8F%98%E8%BF%81/</url>
    <content><![CDATA[<p>OCçš„å†…å­˜ç®¡ç†å¤§è‡´å¯ä»¥åˆ†ä¸ºMRCé˜¶æ®µå’ŒARCé˜¶æ®µã€‚</p>
<p>MRCï¼šæ‰‹åŠ¨å¼•ç”¨è®¡æ•°ï¼Œâ€œæ‰‹åŠ¨â€å¾ˆå¥½ç†è§£å°±æ˜¯äº²è‡ªåŠ¨æ‰‹å†™ä»£ç ï¼Œâ€œå¼•ç”¨è®¡æ•°â€å°±æ˜¯æ•°æ•°ï¼Œæ•°ä¸€ä¸‹è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨æ¬¡æ•°ã€‚å½“æˆ‘ä»¬éœ€è¦ç”¨è¿™ä¸ªå¯¹è±¡çš„æ—¶å€™å…ˆè°ƒç”¨ä¸€ä¸‹retainï¼Œå¼•ç”¨è®¡æ•°å°±åŠ 1ï¼Œä¸ç”¨äº†å°±è°ƒç”¨ä¸€ä¸‹releaseï¼Œå¼•ç”¨è®¡æ•°å°±å‡1ï¼Œå‡åˆ°0ç³»ç»Ÿå°±ä¼šå¸®æˆ‘ä»¬é‡Šæ”¾è¿™ä¸ªå¯¹è±¡çš„å†…å­˜ã€‚</p>
<p>ä¸ºä»€ä¹ˆä¼šæœ‰â€œå¼•ç”¨è®¡æ•°â€è¿™ä¹ˆä¸ªä¸œè¥¿ï¼Ÿ<br>è¯•æƒ³ä¸€ä¸‹å¦‚æœæ²¡æœ‰å¼•ç”¨è®¡æ•°ä¼šæ€æ ·ï¼Œæ¯”å¦‚ä½ åˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¼ æ¥ä¼ å»åœ¨å¾ˆå¤šä¸ªåœ°æ–¹ä½¿ç”¨ï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™è°ƒç”¨freeé”€æ¯å¯¹è±¡æˆäº†ä¸€ä¸ªéš¾é¢˜ã€‚å¦‚ä¸‹ï¼šç±»Aåˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡objï¼Œç„¶åobjä½œä¸ºå‚æ•°ä¼ ç»™ç±»Bã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)function</span><br><span class="line">&#123;</span><br><span class="line">	  <span class="type">id</span> obj = [xxx new];</span><br><span class="line">	  [B someMethod:obj];</span><br><span class="line">	  ...</span><br><span class="line">	  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>objä¼ ç»™ç±»Båï¼ŒBæœ‰å¯èƒ½ä¿å­˜ä¹Ÿå¯èƒ½ä¸ä¿å­˜objã€‚è¿™æ—¶ç±»Aå¯¹objçš„å¤„ç†å°±éå¸¸å°´å°¬äº†ï¼Œå¦‚æœè´¸ç„¶è°ƒç”¨freeï¼Œä¸‡ä¸€ç±»Bè¿˜åœ¨ç”¨å°±ä¼šå¯¼è‡´é‡æŒ‡é’ˆè®¿é—®å´©æºƒï¼Œä¸è°ƒç”¨å§ï¼Œä¸‡ä¸€ç±»Båˆæ²¡åœ¨ç”¨å°±ä¼šå†…å­˜æ³„éœ²ã€‚ä½†æ˜¯é€šè¿‡å¼•ç”¨è®¡æ•°ï¼Œæˆ‘ä»¬å°±ä¸éœ€è¦è€ƒè™‘ä»€ä¹ˆæ—¶å€™è°ƒç”¨freeäº†ï¼Œç³»ç»Ÿä¼šæ ¹æ®å¼•ç”¨è®¡æ•°æ˜¯å¦ä¸º0æ¥å†³å®šæ˜¯å¦é”€æ¯å¯¹è±¡ï¼Œä½ åªéœ€è¦retainå’Œreleaseã€‚</p>
<p>ä¸¾ä¸ªç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š</p>
<p>åœºæ™¯1ï¼šå¼ ä¸‰å»å•æ‰€æ‹‰å±ï¼Œé‡Œé¢ä¸€ç‰‡æ¼†é»‘ï¼Œäºæ˜¯å¼ ä¸‰æ‰“å¼€ç¯ï¼Œæ‰¾äº†ä¸ªå‘ä½å…³ä¸Šé—¨å¼€å§‹é€ ã€‚é€ å®Œåï¼Œå‡ºæ¥å…³ä¸Šç¯ã€‚å®Œç¾ï¼</p>
<p>åœºæ™¯2ï¼šè¿˜æ˜¯å¼ ä¸‰å»å•æ‰€æ‹‰å±ï¼Œé‡Œé¢ä¸€ç‰‡æ¼†é»‘ï¼Œäºæ˜¯å¼ ä¸‰æ‰“å¼€ç¯ï¼Œæ‰¾äº†ä¸ªå‘ä½å…³ä¸Šé—¨å¼€å§‹é€ ã€‚è¿™æ—¶ï¼Œæå››ä¹Ÿæ¥æ‹‰å±ï¼Œç”±äºç¯æ˜¯äº®çš„äºæ˜¯æå››å¾„ç›´æ‰¾äº†ä¸ªå‘ä½å…³ä¸Šé—¨å¼€å§‹é€ ã€‚è¿‡äº†ä¸€ä¼šå¼ ä¸‰æ‹‰å®Œäº†ï¼Œç”±äºå¼ ä¸‰å¹¶ä¸çŸ¥é“æå››è¿›æ¥äº†ï¼Œäºæ˜¯å‡ºé—¨æŠŠç¯å…³äº†ã€‚åªå¬è§åœ¨æ¼†é»‘é‡Œçš„æå››ä¸€å£°å§æ§½ï¼</p>
<p>ä»ä¸Šé¢çš„ä¾‹å­å¯ä»¥çœ‹å‡ºä»€ä¹ˆæ—¶å€™å…³ç¯ç¡®å®æ˜¯ä¸ªé—®é¢˜ï¼Œæ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿæ–¹æ³•æœ‰å¾ˆå¤šæ¯”å¦‚è¿›å»ä¹‹åå¤§å–Šä¸€å£°ä¿ºæ¥äº†è®©é‡Œé¢æ‰€æœ‰äººéƒ½çŸ¥é“æœ‰äººæ¥äº†ã€‚ä½†æ˜¯æœ€ç®€å•çš„åŠæ³•è¿˜æ˜¯å¤§å®¶éƒ½éµå®ˆä¸€å¥—è§„åˆ™ï¼šè¿›é—¨å‰è¯·æŒ‰åŠ å·é”®ï¼Œå‡ºé—¨åè¯·æŒ‰å‡å·é”®ã€‚è¿™å°±ç›¸å½“äºå¼•ç”¨è®¡æ•°äº†ã€‚</p>
<p>åœºæ™¯3ï¼šå¼ ä¸‰å»å•æ‰€æ‹‰å±ï¼Œé‡Œé¢ä¸€ç‰‡æ¼†é»‘ï¼Œå¤–é¢å‘Šç¤ºå†™ç€è¿›é—¨å‰è¯·æŒ‰åŠ å·é”®ï¼Œå‡ºé—¨åè¯·æŒ‰å‡å·é”®ã€‚è¿™æ—¶å¼ ä¸‰æŒ‰äº†ä¸€ä¸‹å¢™å£ä¸Šçš„åŠ å·é”®ï¼Œç¯äº®äº†ï¼Œäºæ˜¯æ‰¾äº†ä¸ªå‘ä½å…³ä¸Šé—¨å¼€å§‹é€ ã€‚è¿™æ—¶æå››ä¹Ÿæ¥æ‹‰å±ï¼Œä»–ä¹ŸæŒ‰ç…§å‘Šç¤ºæŒ‰äº†ä¸‹å¢™å£ä¸Šçš„åŠ å·é”®ï¼Œæ¥ç€ä»–æ‰¾äº†ä¸ªå‘ä½å¼€å§‹å®‰å¿ƒæ‹‰å±ã€‚è¿™æ—¶å¼ ä¸‰æ‹‰å®Œå±ï¼Œå‡ºé—¨æ—¶æŒ‰ç…§å‘Šç¤ºæŒ‰ä¸‹äº†å‡å·é”®ï¼Œç¯æ²¡æœ‰ç­ï¼Œè¿™æ—¶å¼ ä¸‰æ˜ç™½äº†æœŸé—´åˆæ¥äººäº†ï¼Œè™½ç„¶ä¸çŸ¥é“åœ¨å“ªä¸ªå‘ä½ï¼Œä½†è‚¯å®šæ˜¯æœ‰äººæ­£åœ¨æ‹‰ã€‚å½“æå››æ‹‰å®Œåï¼Œä¹ŸæŒ‰äº†ä¸‹å¢™å£ä¸Šçš„å‡å·é”®ï¼Œè¿™æ—¶ç¡®å®æ²¡äººåœ¨æ‹‰å±äº†ï¼Œäºæ˜¯ç¯ç­äº†ï¼Œéå¸¸çš„å®Œç¾ã€‚åœ¨è¿™ä¸ªç³»ç»Ÿé‡Œï¼Œä½ ä¸éœ€è¦çŸ¥é“ä¸­é€”è¿›æ¥äº†å¤šå°‘äººï¼Œä¹Ÿä¸éœ€è¦ä»»ä½•äº¤æµï¼Œåªéœ€è¦éµå®ˆå¤–é¢çš„å‘Šç¤ºï¼Œå°±è§£å†³äº†ç¯ä½•æ—¶ç­çš„é—®é¢˜ã€‚</p>
<p>retainä»£è¡¨ä½ æ‹¥æœ‰äº†è¿™ä¸ªå¯¹è±¡ï¼Œä¸å†éœ€è¦æ—¶è¦è°ƒç”¨releaseï¼Œå°†å¼•ç”¨è®¡æ•°å‡1ã€‚é™¤äº†retainæ–¹æ³•ä»£è¡¨ä½ æ‹¥æœ‰è¿™ä¸ªå¯¹è±¡ï¼Œæœ‰ä¸€äº›æ–¹æ³•ä¹Ÿä»£è¡¨ä½ æ‹¥æœ‰è¿™ä¸ªå¯¹è±¡ï¼Œä¸ç”¨äº†ä¹Ÿéœ€è¦è°ƒç”¨releaseï¼Œç©¶ç«Ÿæ˜¯å“ªäº›æ–¹æ³•å‘¢ï¼Ÿäººä»¬å®šä¹‰äº†ä¸€å¥—å‘½åè§„åˆ™ï¼Œè§„å®šä»¥alloc/new/copy/mutableCopyå¼€å¤´çš„æ–¹æ³•åˆ›å»ºçš„å¯¹è±¡æ˜¯ä½ è‡ªå·±æ‹¥æœ‰çš„å¯¹è±¡ï¼Œä¸ç”¨äº†ä¹Ÿéœ€è¦è°ƒç”¨releaseã€‚é™¤æ­¤ä¹‹å¤–è·å¾—çš„å¯¹è±¡åˆ™ä¸æ˜¯è‡ªå·±æ‹¥æœ‰çš„å¯¹è±¡ï¼Œä¸èƒ½è°ƒç”¨releaseã€‚è¿™å°±æ˜¯æ‰‹åŠ¨å¼•ç”¨è®¡æ•°ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼š</p>
<p>XQCat ä¸ºARCï¼ŒViewControllerä¸ºMRC</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="variable language_">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> test_creat_obj];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)test_creat_obj &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        XQCat *cat1 = [XQCat newCat];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;cat1:%@&quot;</span>, cat1);</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        XQCat *cat2 = [XQCat newerCat];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;cat2:%@&quot;</span>, cat2);</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        XQCat *cat3 = [XQCat allocCat];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;cat3:%@&quot;</span>, cat3);</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        XQCat *cat4 = [XQCat allocationCat];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;cat4:%@&quot;</span>, cat4);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">XQCat</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)dealloc</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@é”€æ¯&quot;</span>,<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)newCat &#123;</span><br><span class="line">    <span class="type">id</span> cat = [[[<span class="keyword">self</span> <span class="keyword">class</span>] alloc] init];</span><br><span class="line">    <span class="keyword">return</span> cat;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)newerCat &#123;</span><br><span class="line">    <span class="type">id</span> cat = [[[<span class="keyword">self</span> <span class="keyword">class</span>] alloc] init];</span><br><span class="line">    <span class="keyword">return</span> cat;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)allocCat &#123;</span><br><span class="line">    <span class="type">id</span> cat = [[[<span class="keyword">self</span> <span class="keyword">class</span>] alloc] init];</span><br><span class="line">    <span class="keyword">return</span> cat;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)allocationCat &#123;</span><br><span class="line">    <span class="type">id</span> cat = [[[<span class="keyword">self</span> <span class="keyword">class</span>] alloc] init];</span><br><span class="line">    <span class="keyword">return</span> cat;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>æ‰“å°ï¼š</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">2022</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">27</span>:<span class="number">25</span>.<span class="number">267602</span>+<span class="number">0800</span> MRCDemo[<span class="number">4032</span>:<span class="number">1406589</span>] cat1:&lt;XQCat: <span class="number">0</span>x600003110be0&gt;</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">27</span>:<span class="number">25</span>.<span class="number">267668</span>+<span class="number">0800</span> MRCDemo[<span class="number">4032</span>:<span class="number">1406589</span>] cat2:&lt;XQCat: <span class="number">0</span>x60000310c140&gt;</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">27</span>:<span class="number">25</span>.<span class="number">267708</span>+<span class="number">0800</span> MRCDemo[<span class="number">4032</span>:<span class="number">1406589</span>] cat3:&lt;XQCat: <span class="number">0</span>x600003108340&gt;</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">27</span>:<span class="number">25</span>.<span class="number">267749</span>+<span class="number">0800</span> MRCDemo[<span class="number">4032</span>:<span class="number">1406589</span>] cat4:&lt;XQCat: <span class="number">0</span>x600003100f20&gt;</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">27</span>:<span class="number">25</span>.<span class="number">281462</span>+<span class="number">0800</span> MRCDemo[<span class="number">4032</span>:<span class="number">1406589</span>] &lt;XQCat: <span class="number">0</span>x600003100f20&gt;é”€æ¯</span><br><span class="line"><span class="attribute">2022</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">27</span>:<span class="number">25</span>.<span class="number">281524</span>+<span class="number">0800</span> MRCDemo[<span class="number">4032</span>:<span class="number">1406589</span>] &lt;XQCat: <span class="number">0</span>x60000310c140&gt;é”€æ¯</span><br></pre></td></tr></table></figure>
<p>ä½ ä¼šå‘ç°cat1,cat3æ²¡è¢«é‡Šæ”¾ï¼Œcat2å’Œcat4è¢«é‡Šæ”¾äº†ï¼Œè¯´æ˜ç³»ç»Ÿæ˜¯éµå®ˆè¿™ä¸ªå‘½åè§„åˆ™çš„ã€‚cat1,cat3æ˜¯æˆ‘ä»¬è‡ªå·±æ‹¥æœ‰çš„ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±è°ƒç”¨releaseé‡Šæ”¾ï¼Œè€Œcat2å’Œcat4ä¸æ˜¯æŒ‰ç…§å‘½åè§„åˆ™åˆ›å»ºçš„ï¼Œè¯´æ˜ä¸æ˜¯æˆ‘ä»¬æ‹¥æœ‰çš„å¯¹è±¡ï¼Œè€Œæ˜¯æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± é‡Œçš„å¯¹è±¡ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸èƒ½å†è°ƒç”¨releaseã€‚</p>
<p>ç„¶è€Œï¼Œæ¯æ¬¡æ‰‹åŠ¨è°ƒç”¨retainå’Œreleaseä¹Ÿæ˜¯æŒºéº»çƒ¦çš„ï¼Œç¨æœ‰ä¸æ…å¤šè°ƒç”¨äº†ä¸€æ¬¡releaseï¼Œé‚£å°±é‡æŒ‡é’ˆå´©æºƒï¼Œå°‘è°ƒç”¨äº†ä¸€æ¬¡å°±å†…å­˜æ³„éœ²ã€‚äºæ˜¯äººä»¬ä¾¿æƒ³æœ‰æ²¡æœ‰åŠæ³•è®©ç³»ç»Ÿè‡ªåŠ¨åœ¨åˆé€‚çš„åœ°æ–¹æ·»åŠ retainå’Œreleaseï¼Ÿç­”æ¡ˆè‡ªç„¶æ˜¯æœ‰ã€‚å˜é‡çš„ä½œç”¨åŸŸå°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ—¶æœºã€‚å˜é‡åˆå§‹åŒ–çš„æ—¶å€™å°±æ’å…¥ä¸€æ¡retainï¼Œå½“å˜é‡è¶…å‡ºä½œç”¨åŸŸçš„æ—¶å€™å°±æ’å…¥ä¸€æ¡releaseã€‚è¿™æ ·å°±ä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨è°ƒç”¨äº†ï¼Œç¼–è¯‘å™¨ä¼šåœ¨åˆé€‚çš„åœ°æ–¹è‡ªåŠ¨æ·»åŠ retainå’Œreleaseã€‚ä¸Šé¢çš„ä¾‹å­ï¼Œäººä»¬æ‰‹åŠ¨æŒ‰æŒ‰é’®æ”¹ä¸ºçº¢å¤–çº¿è‡ªåŠ¨æ„Ÿåº”å…¥å’Œå‡ºï¼Œè¿™å°±æ˜¯è‡ªåŠ¨å¼•ç”¨è®¡æ•°äº†ã€‚</p>
<p>å…³äºARCè¿˜æœ‰ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚å¹¶ä¸æ˜¯æ¯æ¬¡å˜é‡åˆå§‹åŒ–éƒ½æ˜¯æ’å…¥retainï¼Œæœ‰å¯èƒ½æˆ‘ä»¬éœ€è¦çš„æ˜¯weakï¼Œé‚£ä¹ˆç¼–è¯‘å™¨æ˜¯æ€ä¹ˆçŸ¥é“çš„å‘¢ï¼Ÿä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ‰€æœ‰æƒä¿®é¥°ç¬¦ä¾¿å‡ºç°äº†ã€‚é€šè¿‡ä¸åŒç±»å‹çš„æ‰€æœ‰æƒä¿®é¥°ç¬¦ï¼Œç¼–è¯‘å™¨å°±çŸ¥é“æ˜¯æ·»åŠ retainè¿˜æ˜¯æ·»åŠ weakäº†ã€‚ARC æœ‰æ•ˆæ—¶ï¼Œ<strong>id ç±»å‹å’Œå¯¹è±¡ç±»å‹</strong>å¿…é¡»é™„åŠ æ‰€æœ‰æƒä¿®é¥°ç¬¦ï¼Œæœ‰å¦‚ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>__strong ä¿®é¥°ç¬¦</li>
<li>__weak ä¿®é¥°ç¬¦</li>
<li>__unsafe_unretained ä¿®é¥°ç¬¦</li>
<li>__autoreleasing ä¿®é¥°ç¬¦</li>
</ul>
<p>å…¶ä¸­ <code>__strong</code> ä¿®é¥°ç¬¦æ˜¯OCå¯¹è±¡ç±»å‹çš„é»˜è®¤ä¿®é¥°ç¬¦ï¼Œæ­¤æ—¶ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨æ’å…¥retain/releaseã€‚å…³äºæ‰€æœ‰æƒä¿®é¥°ç¬¦èƒŒåçš„æ•…äº‹å¯ä»¥å‚è€ƒå…¶ä»–æ–‡ç« ã€‚</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://blog.devtang.com/2016/07/30/ios-memory-management/">ç†è§£ iOS çš„å†…å­˜ç®¡ç†</a></p>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
      <tags>
        <tag>å†…å­˜ç®¡ç†</tag>
      </tags>
  </entry>
  <entry>
    <title>å¯å˜å‚æ•°çš„å‡½æ•°</title>
    <url>/2022/10/03/%E5%8F%AF%E5%8F%98%E5%8F%82%E6%95%B0%E7%9A%84%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<h3 id="å¦‚ä½•å£°æ˜ä¸€ä¸ªå¯å˜å‚æ•°çš„å‡½æ•°"><a href="#å¦‚ä½•å£°æ˜ä¸€ä¸ªå¯å˜å‚æ•°çš„å‡½æ•°" class="headerlink" title="å¦‚ä½•å£°æ˜ä¸€ä¸ªå¯å˜å‚æ•°çš„å‡½æ•°"></a>å¦‚ä½•å£°æ˜ä¸€ä¸ªå¯å˜å‚æ•°çš„å‡½æ•°</h3><p>åœ¨æ— æ³•ç»™å‡ºæ‰€æœ‰ä¼ é€’ç»™å‡½æ•°çš„å‚æ•°çš„ç±»å‹å’Œæ•°ç›®æ—¶ï¼Œå¯ä»¥ä½¿ç”¨çœç•¥å·ï¼ˆâ€¦ï¼‰æŒ‡å®šå‡½æ•°å‚æ•°è¡¨ã€‚æœ‰å¦‚ä¸‹å‡ ç§å½¢å¼ï¼š</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun1</span><span class="params">(<span class="type">int</span> a, <span class="type">double</span> b, ...)</span></span>; <span class="comment">//ç»™å‡ºç¡®å®šçš„å‡ ä¸ªå‚æ•°ï¼Œå…¶ä»–ç”¨çœç•¥å·</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun2</span><span class="params">(<span class="type">int</span> a ...)</span></span>;            <span class="comment">//çœç•¥å·å‰æœ‰æˆ–è€…æ²¡æœ‰é€—å·éƒ½æ˜¯å¯ä»¥çš„</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun3</span><span class="params">(...)</span></span>;                  <span class="comment">//ä¹Ÿå¯ä»¥ä¸ç¡®å®šä»»ä½•å‚æ•°ï¼Œä½†å’Œæ²¡æœ‰å‚æ•°æ˜¯ä¸ä¸€æ ·çš„</span></span><br></pre></td></tr></table></figure>
<p>ä¸¾ä¸ªä¾‹å­ï¼šè®¡ç®—nä¸ªæ•´æ•°çš„å’Œã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">int</span>)test_n_number_add:(<span class="type">int</span>)n, ... &#123;</span><br><span class="line">    <span class="type">int</span> res = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    va_list ap; <span class="comment">//å£°æ˜</span></span><br><span class="line">    va_start(ap, n); <span class="comment">//ç»‘å®š</span></span><br><span class="line">    <span class="keyword">while</span> (n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        res += va_arg(ap, <span class="type">int</span>); <span class="comment">//è·å–å‚æ•°ã€‚va_argè¿”å›çš„å°±æ˜¯å‚æ•°çš„å€¼ã€‚</span></span><br><span class="line">        n -= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    va_end(ap); <span class="comment">//é‡Šæ”¾</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;res:%d&quot;</span>, res);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>va_listå­˜åœ¨çš„ä¸¤ä¸ªéšæ‚£ï¼š</p>
<p>1.å¦‚ä½•ç¡®å®šå‚æ•°çš„ç±»å‹ã€‚</p>
<p>æ²¡æœ‰å…¶ä»–åŠæ³•ï¼Œå°±æ˜¯é€šè¿‡å¼ºåˆ¶è½¬æ¢ã€‚va_argå°±æ˜¯æŠŠå½“å‰æŒ‡é’ˆæ‰€æŒ‡å‘çš„å†…å®¹å¼ºåˆ¶è½¬æ¢åˆ°æŒ‡å®šç±»å‹ã€‚åƒprintfå‡½æ•°è¿˜æœ‰ä¸ªæ ¼å¼åŒ–å‚æ•°æ¥è¯´æ˜åé¢å‚æ•°çš„ç±»å‹ã€‚å¦‚æœæ˜¯è‡ªå·±å†™çš„ï¼ŒåŒæ ·å¾—äº‹å…ˆçº¦å®šå¥½ä¸€å¥—è§„åˆ™ã€‚</p>
<p>2.å¦‚ä½•ç¡®å®šå‚æ•°çš„ä¸ªæ•°ã€‚ä¹Ÿå°±æ˜¯å‚æ•°ç»“æŸæ ‡å¿—ã€‚</p>
<p>ä¹Ÿæ²¡æœ‰è§„å®šï¼ŒåŒæ ·å¾—äº‹å…ˆçº¦å®šå¥½ä¸€å¥—è§„åˆ™ã€‚æ¯”å¦‚è¿™é‡Œç¬¬ä¸€ä¸ªå›ºå®šå‚æ•°è¯´æ˜äº†åç»­å¯å˜å‚æ•°çš„ä¸ªæ•°ã€‚å†æ¯”å¦‚æ±‚è‡ªç„¶æ•°çš„å¹³æ–¹å’Œï¼Œé‚£ä¹ˆå¯ä»¥æŠŠè´Ÿæ•°å’Œ0ä½œä¸ºå®ƒçš„ç»“æŸæ ‡å¿—ã€‚å…¶ä»–ç³»ç»Ÿå‡½æ•°å¦‚scanfæŠŠæ¥æ”¶åˆ°çš„å›è½¦ç¬¦ä½œä¸ºç»“æŸæ ‡å¿—ï¼Œå¤§å®¶ç†ŸçŸ¥çš„printfå¯¹å­—ç¬¦ä¸²çš„å¤„ç†ç”¨â€™\0â€™ä½œä¸ºç»“æŸæ ‡å¿—ã€‚</p>
<p>ç”±äºä¸Šé¢çš„åŸå› ï¼Œå¯¹äºå¯å˜å‚æ•°çš„å‡½æ•°ï¼Œå¤–éƒ¨è°ƒç”¨è€…å’Œå®ç°è€…å¿…é¡»éµå®ˆå…±åŒçš„çº¦å®šæ‰è¡Œã€‚å¯å˜å‚æ•°çš„å‡½æ•°ï¼Œä¸€èˆ¬åœ¨æ ¼å¼åŒ–å‡½æ•°ä¸­ç”¨çš„æ¯”è¾ƒå¤šã€‚</p>
<h3 id="NSLog-å’Œ-NSLogv"><a href="#NSLog-å’Œ-NSLogv" class="headerlink" title="NSLog å’Œ NSLogv"></a>NSLog å’Œ NSLogv</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">FOUNDATION_EXPORT <span class="type">void</span> <span class="built_in">NSLog</span>(<span class="built_in">NSString</span> *format, ...) <span class="built_in">NS_FORMAT_FUNCTION</span>(<span class="number">1</span>,<span class="number">2</span>) <span class="built_in">NS_NO_TAIL_CALL</span>;</span><br><span class="line">FOUNDATION_EXPORT <span class="type">void</span> <span class="built_in">NSLogv</span>(<span class="built_in">NSString</span> *format, va_list args) <span class="built_in">NS_FORMAT_FUNCTION</span>(<span class="number">1</span>,<span class="number">0</span>) <span class="built_in">NS_NO_TAIL_CALL</span>;</span><br></pre></td></tr></table></figure>
<p>NSLogvå¯ä»¥ä¼ å…¥ä¸€ä¸ªå¯å˜å‚æ•°åˆ—è¡¨ï¼Œè€ŒNSLogä¸èƒ½ï¼ˆåºŸè¯ï¼‰ã€‚</p>
<p>è€ƒè™‘è¿™æ ·ä¸€ç§æƒ…å†µï¼šå‡½æ•°Aæ¥å—å¯å˜å‚æ•°ï¼Œå‡½æ•°Bä¹Ÿæ¥å—å¯å˜å‚æ•°ã€‚Aå†…éƒ¨è¦è°ƒç”¨å‡½æ•°Bï¼Œé‚£ä¹ˆæ€ä¹ˆæŠŠå¯å˜å‚æ•°ä¼ ç»™Bå‘¢ï¼Ÿé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨va_listå…ˆè·å–åˆ°å¯å˜å‚æ•°åˆ—è¡¨ï¼Œå†ä¼ ç»™Bã€‚</p>
<p>ä¸¾ä¾‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)test_nslog &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *format = <span class="string">@&quot;this is object:%@, age = %d, ch = %c&quot;</span>;</span><br><span class="line">    <span class="built_in">NSLog</span>(format, <span class="keyword">self</span>, age, <span class="string">&#x27;s&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)test_nslogv:(<span class="built_in">NSString</span> *)format, ... &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *myLogFormat = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;[my log v0]:%@&quot;</span>, format];</span><br><span class="line">    </span><br><span class="line">    va_list ap;</span><br><span class="line">    va_start(ap, format);</span><br><span class="line">    <span class="built_in">NSLogv</span>(myLogFormat, ap); <span class="comment">//è·å–åˆ°å‚æ•°åˆ—è¡¨åï¼Œç›´æ¥ä¼ ç»™NSLogvã€‚å› ä¸ºæˆ‘ä»¬å¹¶ä¸å…³å¿ƒå‚æ•°åˆ—è¡¨é‡Œç©¶ç«Ÿæ˜¯å•¥å‚æ•°ã€‚</span></span><br><span class="line">    va_end(ap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://www.cnblogs.com/pengdonglin137/p/3345911.html">ç†è§£å¯å˜å‚æ•°va_listã€va_startã€va_argã€va_endåŸç†åŠä½¿ç”¨æ–¹æ³•</a></p>
]]></content>
      <categories>
        <category>C</category>
      </categories>
      <tags>
        <tag>å¯å˜å‚æ•°</tag>
      </tags>
  </entry>
  <entry>
    <title>ç»™ç¬¬ä¸‰æ–¹åº“åŠ¨æ€æ·»åŠ æ–¹æ³•å®ç°</title>
    <url>/2022/09/20/%E7%BB%99%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E5%8A%A8%E6%80%81%E6%B7%BB%E5%8A%A0%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0/</url>
    <content><![CDATA[<p>ç»™NextGrowingTextViewæ·»åŠ æ‰©å±•ï¼Œæ”¯æŒè®¾ç½®å…‰æ ‡å¤§å°ã€‚</p>
<p>NextGrowingTextViewæ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œå†…éƒ¨æœ‰ä¸€ä¸ªç»§æ‰¿è‡ªUITextViewçš„NextGrowingInternalTextViewï¼Œè¿™ä¸ªtextviewå¤–éƒ¨æ˜¯è®¿é—®ä¸äº†çš„ã€‚è€Œè®¾ç½®textviewçš„å…‰æ ‡å¤§å°éœ€è¦ç»§æ‰¿UITextViewå¹¶é‡å†™UITextInput.caretRect(for:)æ–¹æ³•ã€‚æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<p>å¤§æ¦‚æœ‰ä¸‰ç§åŠæ³•ï¼š</p>
<p>1ã€ç§æœ‰åŒ–NextGrowingTextViewã€‚ç›´æ¥æ”¹NextGrowingInternalTextViewç±»ã€‚è¿™ç§æœ€ç®€å•ï¼Œä½†æ˜¯ä»¥åå°±éœ€è¦è‡ªå·±ç»´æŠ¤è¿™ä¸ªåº“äº†ã€‚</p>
<p>2ã€æ–¹æ³•äº¤æ¢UITextViewçš„caretRect(for:)å®ç°ã€‚è¿™ç§ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯ç”±äºäº¤æ¢çš„æ˜¯UITextViewçš„å®ç°ï¼Œå½±å“çš„èŒƒå›´æ¯”è¾ƒå¤§ã€‚</p>
<p>3ã€åŠ¨æ€ç»™NextGrowingInternalTextViewæ·»åŠ caretRect(for:)å®ç°ã€‚è¿™ä¸ªå½±å“çš„èŒƒå›´åªæœ‰NextGrowingInternalTextViewï¼Œå¹¶ä¸”ä¹Ÿä¸éœ€è¦ç§æœ‰åŒ–NextGrowingTextViewã€‚ä¸ªäººè§‰å¾—æ˜¯æœ€ä½³çš„è§£å†³åŠæ³•äº†ã€‚è¿™ä¸ªæ–¹æ¡ˆçš„éš¾ç‚¹æ˜¯æ·»åŠ è‡ªå·±çš„å®ç°åæ€ä¹ˆè°ƒç”¨çˆ¶ç±»çš„å®ç°ã€‚è§£å†³åŠæ³•å°±æ˜¯å…ˆè·å–çˆ¶ç±»çš„IMPï¼Œå†æ·»åŠ è‡ªå·±çš„å®ç°ã€‚</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extension</span> <span class="title class_">NextGrowingTextView</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">struct</span> <span class="title class_">AssociatedKeys</span> &#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">var</span> caretSize <span class="operator">=</span> <span class="string">&quot;caretSize&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> caretSize: <span class="type">CGSize</span>? &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, <span class="operator">&amp;</span><span class="type">AssociatedKeys</span>.caretSize) <span class="keyword">as?</span> <span class="type">CGSize</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123;</span><br><span class="line">            objc_setAssociatedObject(<span class="keyword">self</span>, <span class="operator">&amp;</span><span class="type">AssociatedKeys</span>.caretSize, newValue, objc_AssociationPolicy.<span class="type">OBJC_ASSOCIATION_RETAIN_NONATOMIC</span>)</span><br><span class="line">            hookCaretRectMethodOnce()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">func</span> <span class="title function_">hookCaretRectMethodOnce</span>() &#123;</span><br><span class="line">        <span class="type">DispatchQueue</span>.once &#123;</span><br><span class="line">            <span class="keyword">let</span> cls: <span class="type">AnyClass</span> <span class="operator">=</span> <span class="built_in">type</span>(of: <span class="keyword">self</span>.textView)</span><br><span class="line">            <span class="keyword">let</span> sel: <span class="type">Selector</span> <span class="operator">=</span> <span class="keyword">#selector</span>(<span class="type">UITextInput</span>.caretRect(for:))</span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> originalMethod <span class="operator">=</span> class_getInstanceMethod(cls, sel) <span class="keyword">else</span> &#123;<span class="keyword">return</span>&#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">let</span> originalIMP <span class="operator">=</span> method_getImplementation(originalMethod)</span><br><span class="line">            <span class="keyword">typealias</span> <span class="type">Function</span> <span class="operator">=</span> <span class="keyword">@convention(c)</span> (<span class="type">AnyObject</span>, <span class="type">Selector</span>, <span class="keyword">Any</span><span class="operator">?</span>) -&gt; <span class="type">CGRect</span></span><br><span class="line">            <span class="keyword">let</span> function <span class="operator">=</span> <span class="built_in">unsafeBitCast</span>(originalIMP, to: <span class="type">Function</span>.<span class="keyword">self</span>)</span><br><span class="line">            <span class="keyword">let</span> implementBlock: <span class="keyword">@convention(block)</span> (<span class="type">UITextView</span>, <span class="type">UITextPosition</span>) -&gt; <span class="type">CGRect</span> <span class="operator">=</span> &#123; (textView, position) -&gt; <span class="type">CGRect</span> <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">var</span> rect <span class="operator">=</span> function(textView, sel, position)</span><br><span class="line">                <span class="keyword">guard</span> <span class="keyword">let</span> parentView <span class="operator">=</span> textView.superview <span class="keyword">as?</span> <span class="type">NextGrowingTextView</span> <span class="keyword">else</span> &#123;<span class="keyword">return</span> rect&#125;</span><br><span class="line">                <span class="keyword">guard</span> <span class="keyword">let</span> caretSize <span class="operator">=</span> parentView.caretSize <span class="keyword">else</span> &#123;<span class="keyword">return</span> rect&#125;</span><br><span class="line">                rect.origin.y <span class="operator">-=</span> (caretSize.height <span class="operator">-</span> rect.size.height)</span><br><span class="line">                rect.size <span class="operator">=</span> caretSize</span><br><span class="line">                <span class="keyword">return</span> rect</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">let</span> types <span class="operator">=</span> <span class="string">&quot;&#123;CGRect=&#123;CGPoint=dd&#125;&#123;CGSize=dd&#125;&#125;@:@&quot;</span></span><br><span class="line">            class_addMethod(cls, sel, imp_implementationWithBlock(<span class="built_in">unsafeBitCast</span>(implementBlock, to: <span class="type">AnyObject</span>.<span class="keyword">self</span>)), types)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://swift.gg/2016/05/18/swift-qa-2016-05-18/">æ¯å‘¨ Swift ç¤¾åŒºé—®ç­”ï¼š@convention</a></p>
]]></content>
      <categories>
        <category>runtime</category>
      </categories>
      <tags>
        <tag>NextGrowingTextView</tag>
      </tags>
  </entry>
  <entry>
    <title>XcodeçœŸæœºè°ƒè¯•æç¤ºUnable to install [appName]</title>
    <url>/2022/08/18/Xcode%E7%9C%9F%E6%9C%BA%E8%B0%83%E8%AF%95%E6%8F%90%E7%A4%BAUnable-to-install-appName/</url>
    <content><![CDATA[<p>gitæ‹‰ä»£ç åˆ°æœ¬åœ°åï¼Œç¼–è¯‘æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯Xcodeä¸€è¿è¡Œåœ¨å®‰è£…appçš„æ—¶å€™å°±å¤±è´¥,å¼¹çª—æç¤º</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">Details</span><br><span class="line"></span><br><span class="line">Unable <span class="keyword">to</span> install &quot;XXX&quot;</span><br><span class="line"><span class="keyword">Domain</span>: com.apple.dt.MobileDeviceErrorDomain</span><br><span class="line">Code: <span class="number">-402653081</span></span><br><span class="line">Recovery Suggestion: Please <span class="keyword">check</span> your project settings <span class="keyword">and</span> ensure that a <span class="keyword">valid</span> product has been built.</span><br><span class="line"><span class="keyword">User</span> <span class="keyword">Info</span>: &#123;</span><br><span class="line">    DVTErrorCreationDateKey = &quot;2022-08-18 07:53:05 +0000&quot;;</span><br><span class="line">    IDERunOperationFailingWorker = IDEInstalliPhoneLauncher;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">--</span></span><br><span class="line">There was an <span class="type">internal</span> API error.</span><br><span class="line"><span class="keyword">Domain</span>: com.apple.dt.MobileDeviceErrorDomain</span><br><span class="line">Code: <span class="number">-402653081</span></span><br><span class="line"><span class="keyword">User</span> <span class="keyword">Info</span>: &#123;</span><br><span class="line">    DVTRadarComponentKey = <span class="number">261622</span>;</span><br><span class="line">    MobileDeviceErrorCode = &quot;(0xE8000067)&quot;;</span><br><span class="line">    &quot;com.apple.dtdevicekit.stacktrace&quot; = (</span><br><span class="line">	<span class="number">0</span>   DTDeviceKitBase                     <span class="number">0x000000028daad614</span> DTDKCreateNSErrorFromAMDErrorCode + <span class="number">272</span></span><br><span class="line">	<span class="number">1</span>   DTDeviceKitBase                     <span class="number">0x000000028dae6dd8</span> __90-[DTDKMobileDeviceToken installApplicationBundleAtPath:withOptions:andError:withCallback:]_block_invoke + <span class="number">160</span></span><br><span class="line">	<span class="number">2</span>   DVTFoundation                       <span class="number">0x0000000102eb5bd0</span> DVTInvokeWithStrongOwnership + <span class="number">76</span></span><br><span class="line">	<span class="number">3</span>   DTDeviceKitBase                     <span class="number">0x000000028dae6b30</span> -[DTDKMobileDeviceToken installApplicationBundleAtPath:withOptions:andError:withCallback:] + <span class="number">1336</span></span><br><span class="line">	<span class="number">4</span>   IDEiOSSupportCore                   <span class="number">0x0000000133351590</span> __118-[DVTiOSDevice(DVTiPhoneApplicationInstallation) processAppInstallSet:appUninstallSet:installOptions:completionBlock:]_block_invoke<span class="number">.301</span> + <span class="number">2916</span></span><br><span class="line">	<span class="number">5</span>   DVTFoundation                       <span class="number">0x0000000102fdcf50</span> __DVT_CALLING_CLIENT_BLOCK__ + <span class="number">16</span></span><br><span class="line">	<span class="number">6</span>   DVTFoundation                       <span class="number">0x0000000102fde068</span> __DVTDispatchAsync_block_invoke + <span class="number">364</span></span><br><span class="line">	<span class="number">7</span>   libdispatch.dylib                   <span class="number">0x00000001a2504e60</span> _dispatch_call_block_and_release + <span class="number">32</span></span><br><span class="line">	<span class="number">8</span>   libdispatch.dylib                   <span class="number">0x00000001a2506bac</span> _dispatch_client_callout + <span class="number">20</span></span><br><span class="line">	<span class="number">9</span>   libdispatch.dylib                   <span class="number">0x00000001a250e330</span> _dispatch_lane_serial_drain + <span class="number">672</span></span><br><span class="line">	<span class="number">10</span>  libdispatch.dylib                   <span class="number">0x00000001a250eea4</span> _dispatch_lane_invoke + <span class="number">392</span></span><br><span class="line">	<span class="number">11</span>  libdispatch.dylib                   <span class="number">0x00000001a2519708</span> _dispatch_workloop_worker_thread + <span class="number">656</span></span><br><span class="line">	<span class="number">12</span>  libsystem_pthread.dylib             <span class="number">0x00000001a26c15b0</span> _pthread_wqthread + <span class="number">288</span></span><br><span class="line">	<span class="number">13</span>  libsystem_pthread.dylib             <span class="number">0x00000001a26c02c4</span> start_wqthread + <span class="number">8</span></span><br><span class="line">);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">--</span></span><br><span class="line"></span><br><span class="line">Analytics Event: com.apple.dt.IDERunOperationWorkerFinished : &#123;</span><br><span class="line">    &quot;device_model&quot; = &quot;iPhone9,2&quot;;</span><br><span class="line">    &quot;device_osBuild&quot; = &quot;15.6 (19G71)&quot;;</span><br><span class="line">    &quot;device_platform&quot; = &quot;com.apple.platform.iphoneos&quot;;</span><br><span class="line">    &quot;launchSession_schemeCommand&quot; = Run;</span><br><span class="line">    &quot;launchSession_state&quot; = <span class="number">1</span>;</span><br><span class="line">    &quot;launchSession_targetArch&quot; = arm64;</span><br><span class="line">    &quot;operation_duration_ms&quot; = <span class="number">6186</span>;</span><br><span class="line">    &quot;operation_errorCode&quot; = &quot;-402653081&quot;;</span><br><span class="line">    &quot;operation_errorDomain&quot; = &quot;com.apple.dt.MobileDeviceErrorDomain&quot;;</span><br><span class="line">    &quot;operation_errorWorker&quot; = IDEInstalliPhoneLauncher;</span><br><span class="line">    &quot;operation_name&quot; = IDEiPhoneRunOperationWorkerGroup;</span><br><span class="line">    &quot;param_consoleMode&quot; = <span class="number">0</span>;</span><br><span class="line">    &quot;param_debugger_attachToExtensions&quot; = <span class="number">0</span>;</span><br><span class="line">    &quot;param_debugger_attachToXPC&quot; = <span class="number">1</span>;</span><br><span class="line">    &quot;param_debugger_type&quot; = <span class="number">5</span>;</span><br><span class="line">    &quot;param_destination_isProxy&quot; = <span class="number">0</span>;</span><br><span class="line">    &quot;param_destination_platform&quot; = &quot;com.apple.platform.iphoneos&quot;;</span><br><span class="line">    &quot;param_diag_MainThreadChecker_stopOnIssue&quot; = <span class="number">0</span>;</span><br><span class="line">    &quot;param_diag_MallocStackLogging_enableDuringAttach&quot; = <span class="number">0</span>;</span><br><span class="line">    &quot;param_diag_MallocStackLogging_enableForXPC&quot; = <span class="number">1</span>;</span><br><span class="line">    &quot;param_diag_allowLocationSimulation&quot; = <span class="number">1</span>;</span><br><span class="line">    &quot;param_diag_gpu_frameCapture_enable&quot; = <span class="number">0</span>;</span><br><span class="line">    &quot;param_diag_gpu_shaderValidation_enable&quot; = <span class="number">0</span>;</span><br><span class="line">    &quot;param_diag_gpu_validation_enable&quot; = <span class="number">0</span>;</span><br><span class="line">    &quot;param_diag_memoryGraphOnResourceException&quot; = <span class="number">0</span>;</span><br><span class="line">    &quot;param_diag_queueDebugging_enable&quot; = <span class="number">1</span>;</span><br><span class="line">    &quot;param_diag_runtimeProfile_generate&quot; = <span class="number">0</span>;</span><br><span class="line">    &quot;param_diag_sanitizer_asan_enable&quot; = <span class="number">0</span>;</span><br><span class="line">    &quot;param_diag_sanitizer_tsan_enable&quot; = <span class="number">0</span>;</span><br><span class="line">    &quot;param_diag_sanitizer_tsan_stopOnIssue&quot; = <span class="number">0</span>;</span><br><span class="line">    &quot;param_diag_sanitizer_ubsan_stopOnIssue&quot; = <span class="number">0</span>;</span><br><span class="line">    &quot;param_diag_showNonLocalizedStrings&quot; = <span class="number">0</span>;</span><br><span class="line">    &quot;param_diag_viewDebugging_enabled&quot; = <span class="number">1</span>;</span><br><span class="line">    &quot;param_diag_viewDebugging_insertDylibOnLaunch&quot; = <span class="number">1</span>;</span><br><span class="line">    &quot;param_install_style&quot; = <span class="number">0</span>;</span><br><span class="line">    &quot;param_launcher_UID&quot; = <span class="number">2</span>;</span><br><span class="line">    &quot;param_launcher_allowDeviceSensorReplayData&quot; = <span class="number">0</span>;</span><br><span class="line">    &quot;param_launcher_kind&quot; = <span class="number">0</span>;</span><br><span class="line">    &quot;param_launcher_style&quot; = <span class="number">0</span>;</span><br><span class="line">    &quot;param_launcher_substyle&quot; = <span class="number">0</span>;</span><br><span class="line">    &quot;param_runnable_appExtensionHostRunMode&quot; = <span class="number">0</span>;</span><br><span class="line">    &quot;param_runnable_productType&quot; = &quot;com.apple.product-type.application&quot;;</span><br><span class="line">    &quot;param_runnable_swiftVersion&quot; = &quot;5.6.1&quot;;</span><br><span class="line">    &quot;param_runnable_type&quot; = <span class="number">2</span>;</span><br><span class="line">    &quot;param_testing_launchedForTesting&quot; = <span class="number">0</span>;</span><br><span class="line">    &quot;param_testing_suppressSimulatorApp&quot; = <span class="number">0</span>;</span><br><span class="line">    &quot;param_testing_usingCLI&quot; = <span class="number">0</span>;</span><br><span class="line">    &quot;sdk_canonicalName&quot; = &quot;iphoneos15.5&quot;;</span><br><span class="line">    &quot;sdk_osVersion&quot; = &quot;15.5&quot;;</span><br><span class="line">    &quot;sdk_variant&quot; = iphoneos;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">--</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">System</span> Information</span><br><span class="line"></span><br><span class="line">macOS <span class="keyword">Version</span> <span class="number">12.0</span><span class="number">.1</span> (Build <span class="number">21</span>A559)</span><br><span class="line">Xcode <span class="number">13.4</span><span class="number">.1</span> (<span class="number">20504</span>) (Build <span class="number">13</span>F100)</span><br><span class="line"><span class="type">Timestamp</span>: <span class="number">2022</span><span class="number">-08</span><span class="number">-18</span>T15:<span class="number">53</span>:<span class="number">05</span>+<span class="number">08</span>:<span class="number">00</span></span><br></pre></td></tr></table></figure>
<p>å…ˆcleanå·¥ç¨‹ï¼Œå†åˆ DerivedDataæ–‡ä»¶ï¼Œé‡å¯æ‰‹æœºï¼Œé‡å¯ç”µè„‘ï¼Œä½†æ˜¯éƒ½æ²¡æœ‰ç”¨ã€‚cleanã€åˆ é™¤å¥½å‡ ééƒ½æ²¡æœ‰ç”¨ï¼Œå…¶å®åˆ°è¿™é‡Œå°±å¯ä»¥è‚¯å®šæ˜¯å’Œç¼“å­˜æ²¡å…³ç³»äº†ï¼Œå†æ€ä¹ˆcleanéƒ½æ²¡ç”¨ï¼Œå› ä¸ºå¯èƒ½æ˜¯å…¶ä»–åœ°æ–¹çš„åŸå› å¯¼è‡´çš„ã€‚å®Œå…¨cleanä¸¤æ¬¡å¦‚æœæ²¡ç”¨å°±åº”è¯¥æ‰¾å…¶ä»–åŸå› äº†ï¼Œå¦‚æœæ—©æ„è¯†åˆ°è¿™ä¸€ç‚¹è¿˜å¯ä»¥èŠ‚çœç‚¹æ—¶é—´ã€‚</p>
<p>æŸ¥äº†1ä¸ªåŠå°æ—¶ï¼Œå°±å‘ç°ä¸€ç¯‡æ–‡ç« æåˆ°åˆ é™¤targeté‡Œçš„é€šçŸ¥æ‰©å±•ï¼Œåˆ é™¤åç¡®å®å¯ä»¥è¿è¡Œå®‰è£…ï¼Œä½†æ˜¯è¿™ä¸æ˜¯è§£å†³åŠæ³•å•Šã€‚ä¼°æ‘¸ç€å¤§æ¦‚å°±æ˜¯é€šçŸ¥æ‰©å±•é‚£ä¸€å—æœ‰é—®é¢˜ï¼Œäºæ˜¯æ¯”å¯¹å¥½çš„å·¥ç¨‹çš„è®¾ç½®ï¼Œæœ€ç»ˆå‘ç°æ˜¯NotificationService.swiftæ–‡ä»¶æ²¡æœ‰åŠ åˆ°NotificationService targeté‡Œå»å¯¼è‡´çš„ã€‚æ·»åŠ åè§£å†³ã€‚ç½‘ä¸Šå¥½å¤šç±»ä¼¼çš„é—®é¢˜ï¼Œä½†å’Œæˆ‘è¿™ä¸ªå®Œå…¨ä¸€æ ·çš„å‡ ä¹æ²¡æœ‰ï¼Œå¥½æµªè´¹æ—¶é—´æ— è¯­ã€‚</p>
]]></content>
      <categories>
        <category>Xcode</category>
      </categories>
  </entry>
  <entry>
    <title>MessageKitæºç åˆ†æ</title>
    <url>/2022/08/17/MessageKit%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<p>MessageKitæ˜¯ä¸€ä¸ªå¼€æºçš„IM æ¶ˆæ¯èŠå¤©UIæ¡†æ¶ã€‚</p>
<p>MessageKité‡‡ç”¨UICollectionViewè€ŒéUITableViewä½œä¸ºä¸»ä½“æ¶æ„ï¼ˆä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾è®¡Why?ï¼‰ï¼Œé‡‡ç”¨UICollectionViewCellå®ç°èŠå¤©cellã€‚ä¸€ä¸ªsectionå¯¹åº”ä¸€æ¡èŠå¤©æ¶ˆæ¯ï¼Œé»˜è®¤ä¸€ä¸ªsectioné‡Œé¢åªæœ‰ä¸€ä¸ªcellï¼ˆä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾è®¡Whyï¼Ÿï¼‰ã€‚</p>
<p>ä½œä¸ºä¸€ä¸ªæ¡†æ¶ï¼Œéš¾å°±éš¾åœ¨å¦‚ä½•å°è£…å„ç§é£æ ¼è¿¥å¼‚çš„èŠå¤©cellï¼ŸMessageKitè‡ªå®šä¹‰äº†ä¸€ç§CollectionViewå¸ƒå±€æ–¹å¼MessagesCollectionViewFlowLayoutï¼Œå®ƒç»§æ‰¿è‡ªUICollectionViewFlowLayoutã€‚å¯¹åº”éœ€è¦è‡ªå®šä¹‰layoutAttributesâ€”MessagesCollectionViewLayoutAttributesï¼Œç»§æ‰¿è‡ªUICollectionViewLayoutAttributesã€‚</p>
<p>æ¡†æ¶å†…éƒ¨æä¾›äº†å‡ ç§é»˜è®¤çš„æ¶ˆæ¯ç±»å‹:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="comment">/// An enum representing the kind of message and its underlying kind.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">MessageKind</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// A standard text message.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// - Note: The font used for this message will be the value of the</span></span><br><span class="line">    <span class="comment">/// `messageLabelFont` property in the `MessagesCollectionViewFlowLayout` object.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Using `MessageKind.attributedText(NSAttributedString)` doesn&#x27;t require you</span></span><br><span class="line">    <span class="comment">/// to set this property and results in higher performance.</span></span><br><span class="line">    <span class="keyword">case</span> text(<span class="type">String</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// A message with attributed text.</span></span><br><span class="line">    <span class="keyword">case</span> attributedText(<span class="type">NSAttributedString</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// A photo message.</span></span><br><span class="line">    <span class="keyword">case</span> photo(<span class="type">MediaItem</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// A video message.</span></span><br><span class="line">    <span class="keyword">case</span> video(<span class="type">MediaItem</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// A location message.</span></span><br><span class="line">    <span class="keyword">case</span> location(<span class="type">LocationItem</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// An emoji message.</span></span><br><span class="line">    <span class="keyword">case</span> emoji(<span class="type">String</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// An audio message.</span></span><br><span class="line">    <span class="keyword">case</span> audio(<span class="type">AudioItem</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// A contact message.</span></span><br><span class="line">    <span class="keyword">case</span> contact(<span class="type">ContactItem</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// A link preview message.</span></span><br><span class="line">    <span class="keyword">case</span> linkPreview(<span class="type">LinkItem</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// A custom message.</span></span><br><span class="line">    <span class="comment">/// - Note: Using this case requires that you implement the following methods and handle this case:</span></span><br><span class="line">    <span class="comment">///   - MessagesDataSource: customCell(for message: MessageType, at indexPath: IndexPath, in messagesCollectionView: MessagesCollectionView) -&gt; UICollectionViewCell</span></span><br><span class="line">    <span class="comment">///   - MessagesLayoutDelegate: customCellSizeCalculator(for message: MessageType, at indexPath: IndexPath, in messagesCollectionView: MessagesCollectionView) -&gt; CellSizeCalculator</span></span><br><span class="line">    <span class="keyword">case</span> custom(<span class="keyword">Any</span><span class="operator">?</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: - Not supported yet</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//    case system(String)</span></span><br><span class="line"><span class="comment">//    </span></span><br><span class="line"><span class="comment">//    case placeholder</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¯ç§æ¶ˆæ¯ç±»å‹æä¾›äº†é»˜è®¤çš„cellæ ·å¼ï¼Œå¦‚æœä¸æƒ³ç”¨é»˜è®¤çš„æ ·å¼å¯ä»¥é€šè¿‡ä»£ç†è‡ªå·±è¿”å›ã€‚æ¯ç§cellå¯¹åº”ä¸€ç§CellSizeCalculatorï¼Œç”¨äºæä¾›cellçš„å®½é«˜ã€‚å†…éƒ¨æä¾›çš„æ¯”å¦‚ï¼šTextMessageCellâ€”TextMessageSizeCalculatorã€MediaMessageCellâ€”MediaMessageSizeCalculatorã€AudioMessageCellâ€”AudioMessageSizeCalculatorã€‚</p>
<p>MessageKitçš„è®¾è®¡æ€æƒ³çœŸçš„åŠï¼Œæ¡†æ¶æä¾›äº†é»˜è®¤æ ·å¼ï¼Œå¦‚æœä¸æƒ³ç”¨é»˜è®¤çš„æ ·å¼å¯ä»¥é€šè¿‡ä»£ç†è‡ªå·±è¿”å›ã€‚</p>
<h2 id="å‡ ç§åŸºç±»"><a href="#å‡ ç§åŸºç±»" class="headerlink" title="å‡ ç§åŸºç±»"></a>å‡ ç§åŸºç±»</h2><p>MessagesViewControllerâ€”&gt;UIViewController</p>
<p>å®é™…ä½¿ç”¨æ—¶å¯ä»¥ç»§æ‰¿MessagesViewControlleræˆ–æ‹·è´å…¶æºç åˆ°è‡ªå·±çš„æ§åˆ¶å™¨ã€‚</p>
<p>MessagesCollectionViewâ€”&gt;UICollectionView</p>
<p>xxxâ€”&gt;MessageContentCellâ€”&gt;MessageCollectionViewCellâ€”&gt;UICollectionViewCell</p>
<p>MessageContentCellé‡Œå·²ç»æ·»åŠ äº†å¾ˆå¤šå¿…è¦çš„æ§ä»¶ï¼Œæ¯”å¦‚ï¼šavatarViewã€messageContainerViewã€cellTopLabelç­‰ç­‰ã€‚</p>
<p>xxxâ€”&gt;MessageSizeCalculatorâ€”&gt;CellSizeCalculator</p>
<p>Calculatorè´Ÿè´£é…ç½®LayoutAttributesï¼Œå¹¶è®¡ç®—cellçš„sizeã€‚MessageSizeCalculatorå†…éƒ¨å·²ç»å¸®ä½ è®¡ç®—å¥½äº†ï¼Œå­æ§ä»¶çš„é«˜åº¦ç”±å¤–éƒ¨ä»£ç†ã€‚</p>
<p>MessagesCollectionViewFlowLayoutâ€”&gt;UICollectionViewFlowLayout</p>
<p>MessagesCollectionViewFlowLayoutè´Ÿè´£è¿”å›cellçš„sizeï¼Œå®é™…çš„sizeè®¡ç®—ç”±cellå¯¹åº”çš„Calculatorå®Œæˆã€‚ç”±äºcellçš„ç§ç±»ç¹å¤šï¼ŒLayoutå†…éƒ¨å·²ç»å†…ç½®äº†å„ç§Calculatorï¼Œä¹Ÿå¯ä»¥ç”±å¤–éƒ¨ä¼ å…¥ï¼ˆä»£ç†ï¼‰ã€‚</p>
<p>MessagesCollectionViewLayoutAttributesâ€”&gt;UICollectionViewLayoutAttributes</p>
<h3 id="MessagesCollectionView"><a href="#MessagesCollectionView" class="headerlink" title="MessagesCollectionView"></a>MessagesCollectionView</h3><p>å†…éƒ¨å·²ç»æ³¨å†Œäº†å‡ ç§é»˜è®¤çš„æ ·å¼cell:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="comment">// MARK: - Methods</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">func</span> <span class="title function_">registerReusableViews</span>() &#123;</span><br><span class="line">    register(<span class="type">TextMessageCell</span>.<span class="keyword">self</span>)</span><br><span class="line">    register(<span class="type">MediaMessageCell</span>.<span class="keyword">self</span>)</span><br><span class="line">    register(<span class="type">LocationMessageCell</span>.<span class="keyword">self</span>)</span><br><span class="line">    register(<span class="type">AudioMessageCell</span>.<span class="keyword">self</span>)</span><br><span class="line">    register(<span class="type">ContactMessageCell</span>.<span class="keyword">self</span>)</span><br><span class="line">    register(<span class="type">TypingIndicatorCell</span>.<span class="keyword">self</span>)</span><br><span class="line">    register(<span class="type">LinkPreviewMessageCell</span>.<span class="keyword">self</span>)</span><br><span class="line">    register(<span class="type">MessageReusableView</span>.<span class="keyword">self</span>, forSupplementaryViewOfKind: <span class="type">UICollectionView</span>.elementKindSectionHeader)</span><br><span class="line">    register(<span class="type">MessageReusableView</span>.<span class="keyword">self</span>, forSupplementaryViewOfKind: <span class="type">UICollectionView</span>.elementKindSectionFooter)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="é»˜è®¤cellæ ·å¼"><a href="#é»˜è®¤cellæ ·å¼" class="headerlink" title="é»˜è®¤cellæ ·å¼"></a>é»˜è®¤cellæ ·å¼</h2><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">https:<span class="regexp">//</span>raw.githubusercontent.com<span class="regexp">/MessageKit/</span>MessageKit<span class="regexp">/master/</span>Assets/CellStructure.png</span><br></pre></td></tr></table></figure>
<h2 id="è‡ªå®šä¹‰cellæ ·å¼"><a href="#è‡ªå®šä¹‰cellæ ·å¼" class="headerlink" title="è‡ªå®šä¹‰cellæ ·å¼"></a>è‡ªå®šä¹‰cellæ ·å¼</h2><p>è™½ç„¶æ¡†æ¶å·²ç»æä¾›äº†å¾ˆå¤šç§cellæ ·å¼äº†ï¼Œä½†æ˜¯UIæ˜¯æœ€å®¹æ˜“å˜çš„ã€‚æ‰€ä»¥è¿˜æ˜¯éœ€è¦å®Œå…¨è‡ªå®šä¹‰cellæ ·å¼ã€‚</p>
]]></content>
      <categories>
        <category>æºç åˆ†æ</category>
      </categories>
      <tags>
        <tag>MessageKit</tag>
      </tags>
  </entry>
  <entry>
    <title>çˆ¶å­ã€å­å­æ§åˆ¶å™¨é—´çš„é€šä¿¡</title>
    <url>/2022/08/10/%E7%88%B6%E5%AD%90%E3%80%81%E5%AD%90%E5%AD%90%E6%8E%A7%E5%88%B6%E5%99%A8%E9%97%B4%E7%9A%84%E9%80%9A%E4%BF%A1/</url>
    <content><![CDATA[<p>æœ‰ä¸€ä¸ªå®¹å™¨æ§åˆ¶å™¨Pï¼Œå®ƒä¸‹é¢æœ‰ä¸‰ä¸ªå­æ§åˆ¶å™¨Aã€Bã€Cã€‚æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦åœ¨ABCä¹‹é—´å…±äº«ä¸€äº›çŠ¶æ€ä¿¡æ¯ã€‚</p>
<p>ä¸€ç§å¯è¡Œçš„åšæ³•ï¼šåœ¨Pä¸‹é¢æŒ‚ä¸€ä¸ªstatusContextå¯¹è±¡ï¼ˆä¿¡æ¯å°‘ä¹Ÿå¯ä»¥ç›´æ¥å¹³é“ºåœ¨Pä¸‹ï¼‰ï¼Œä¸‰ä¸ªå­æ§åˆ¶å™¨è®¿é—®è¿™ä¸ªstatusContextå¯¹è±¡è¾¾åˆ°æ•°æ®é€šä¿¡çš„ç›®çš„ã€‚è¿™ç§æ–¹æ¡ˆé€‚åˆçŠ¶æ€æŸ¥è¯¢è¿™ç§éå³æ—¶å¤„ç†çš„åœºæ™¯ï¼Œå¦‚æœæ˜¯é‚£ç§éœ€è¦å³æ—¶å¤„ç†äº‹ä»¶çš„åœºæ™¯ï¼Œé‚£ä¹ˆè¿˜æ˜¯ä½¿ç”¨ä»£ç†ï¼Œé€šçŸ¥ï¼Œblockæ¯”è¾ƒå¥½ã€‚</p>
<p>å¦å¤–ä¸€ç§æ–¹æ³•ï¼šç›´æ¥å•ä¾‹æèµ·ï¼Œå•ä¾‹åœ¨ABCä¹‹é—´ç©¿æ¢­ã€‚ä¸å¤ªæ¨èã€‚æœ‰å‡ ä¸ªåŸå› ï¼š1.å•ä¾‹å› ä¸ºä½¿ç”¨è¿‡äºæ–¹ä¾¿å¯¼è‡´å¾ˆå®¹æ˜“è¢«æ»¥ç”¨ï¼Œæ»¥ç”¨åï¼Œä¼šå¾ˆéš¾è¿½è¸ªæŸä¸ªå±æ€§åˆ°åº•æ˜¯åœ¨å“ªä¸ªåœ°æ–¹ä¿®æ”¹çš„ã€‚2.å•ä¾‹åˆ›å»ºåä¸€èˆ¬ä¸ä¼šä¸»åŠ¨é”€æ¯ï¼Œå¯¼è‡´å¾ˆéš¾ç»´æŠ¤å®ƒä¸Šé¢çš„çŠ¶æ€ä¿¡æ¯ï¼Œä¸‹ä¸€æ¬¡ä½¿ç”¨æ—¶å¯èƒ½ä¼šæ®‹å­˜ä¸Šä¸€æ¬¡çš„çŠ¶æ€ä¿¡æ¯ã€‚</p>
]]></content>
      <categories>
        <category>ä¸šåŠ¡å¼€å‘</category>
      </categories>
      <tags>
        <tag>æ•°æ®é€šä¿¡</tag>
      </tags>
  </entry>
  <entry>
    <title>mallocã€callocã€reallocç®€ä»‹</title>
    <url>/2022/08/09/malloc%E3%80%81calloc%E3%80%81realloc%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<h2 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h2><p>å‡½æ•°å£°æ˜ï¼š</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line">void	*<span class="built_in">malloc</span>(size_t __size) __result_use_check <span class="built_in">__alloc_size</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>Initialization: <strong>malloc()</strong> allocates memory block of given size (in bytes) and returns a pointer to the beginning of the block. malloc() doesnâ€™t initialize the allocated memory. If we try to acess the content of memory block then weâ€™ll get garbage values.</p>
<h2 id="calloc"><a href="#calloc" class="headerlink" title="calloc"></a>calloc</h2><p>å‡½æ•°å£°æ˜ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>	*<span class="title">calloc</span><span class="params">(<span class="type">size_t</span> __count, <span class="type">size_t</span> __size)</span> __result_use_check __<span class="title">alloc_size</span><span class="params">(<span class="number">1</span>,<span class="number">2</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>å‚æ•°è¯´æ˜ï¼š</p>
<ol>
<li>Number of blocks to be allocated.</li>
<li>Size of each block.</li>
</ol>
<p><strong>calloc()</strong> allocates the memory and also initializes the allocates memory block to zero. If we try to access the content of these blocks then weâ€™ll get 0.</p>
<p>å› ä¸ºcallocä¼šå°†ç”³è¯·çš„å†…å­˜åˆå§‹åŒ–ä¸º0æˆ–NULLï¼Œæ‰€ä»¥åœ¨éœ€è¦åˆå§‹åŒ–çš„åœºæ™¯ä¸‹è¯¥å‡½æ•°ä¼šå¾ˆæ–¹ä¾¿ï¼Œæ¯”å¦‚åˆ›å»ºä¸€ä¸ªç»“æ„ä½“ï¼Œåˆ›å»ºä¸€ä¸ªæ•°ç»„ã€‚</p>
<h2 id="realloc"><a href="#realloc" class="headerlink" title="realloc"></a>realloc</h2><p>å‡½æ•°å£°æ˜ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>	*<span class="title">realloc</span><span class="params">(<span class="type">void</span> *__ptr, <span class="type">size_t</span> __size)</span> __result_use_check __<span class="title">alloc_size</span><span class="params">(<span class="number">2</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>å‚æ•°è¯´æ˜ï¼š</p>
<ul>
<li><strong>ptr</strong> âˆ’ This is the pointer to a memory block previously allocated with malloc, calloc or realloc to be reallocated. If this is NULL, a new block is allocated and a pointer to it is returned by the function.</li>
<li>This is the new size for the memory block, in bytes. If it is 0 and ptr points to an existing block of memory, the memory block pointed by ptr is deallocated and a NULL pointer is returned.</li>
</ul>
<p>å‡½æ•°è¯´æ˜ï¼š</p>
<p>reallocå¯ä»¥ç”¨æ¥é‡æ–°è°ƒæ•´ä¹‹å‰åˆ†é…çš„å†…å­˜å¤§å°ã€‚æŒ‡é’ˆpå¿…é¡»ä¸ºæŒ‡å‘å †å†…å­˜ç©ºé—´çš„æŒ‡é’ˆï¼Œå³ç”±mallocå‡½æ•°ã€callocå‡½æ•°æˆ–reallocå‡½æ•°åˆ†é…ç©ºé—´çš„æŒ‡é’ˆæˆ–è€…ä¸ºNULLã€‚size  = 0ï¼Œè¡Œä¸ºæœªå®šä¹‰ï¼Œä¸€ç§å®ç°æ˜¯ï¼šé‡Šæ”¾æŒ‡é’ˆpæŒ‡å‘çš„å†…å­˜ï¼Œå¹¶è¿”å›NULLã€‚</p>
<p>reallocå‡½æ•°æœ‰ä¸¤ç§è¡Œä¸ºï¼š</p>
<ol>
<li>åœ¨åŸæ¥çš„å†…å­˜ç©ºé—´ä¸Šè¿›è¡Œæ‰©å¼ æˆ–æ”¶ç¼©ã€‚min(newSize, oldSize)åŒºåŸŸå†…çš„å†…å®¹ä¸å˜ã€‚å¦‚æœæ˜¯æ‰©å¼ åˆ™æ‰©å¼ éƒ¨åˆ†çš„å†…å­˜ç©ºé—´æ˜¯æœªåˆå§‹åŒ–çš„ã€‚</li>
<li>ç”³è¯·ä¸€å—å…¨æ–°çš„å†…å­˜ç©ºé—´ï¼Œå¹¶å°†åŸæ¥æŒ‡å‘ç©ºé—´çš„å†…å®¹ä¾æ¬¡å¤åˆ¶åˆ°æ–°çš„å†…å­˜ç©ºé—´ä¸Šï¼Œpä¹‹å‰æŒ‡å‘çš„ç©ºé—´è¢«é‡Šæ”¾ã€‚æ‰©å¼ éƒ¨åˆ†çš„å†…å­˜ç©ºé—´æ˜¯æœªåˆå§‹åŒ–çš„ã€‚</li>
</ol>
<p>è°ƒç”¨reallocåï¼Œä¸åº”è¯¥å†ä½¿ç”¨åŸæ¥çš„æŒ‡é’ˆpï¼Œå¦‚æœä½¿ç”¨åˆ™è¡Œä¸ºæœªå®šä¹‰ã€‚</p>
<p>ä¸Šé¢ä¸‰ä¸ªç”³è¯·å†…å­˜çš„å‡½æ•°ï¼Œåœ¨ä½¿ç”¨å®Œåéƒ½éœ€è¦è°ƒç”¨freeé‡Šæ”¾å†…å­˜ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.tutorialspoint.com/c_standard_library/c_function_realloc.htm">realloc</a>  æ¯”è¾ƒæ¸…æ™°</p>
<p><a href="https://en.cppreference.com/w/c/memory/realloc">realloc</a>  å¾ˆè¯¦ç»†ã€‚è¿™ä¸ªç½‘ç«™ä¹Ÿä¸é”™ï¼Œå›Šæ‹¬äº†å¤§éƒ¨åˆ†C++çš„å‡½æ•°è¯´æ˜ã€‚</p>
]]></content>
      <categories>
        <category>C</category>
      </categories>
      <tags>
        <tag>å†…å­˜ç®¡ç†</tag>
      </tags>
  </entry>
  <entry>
    <title>å¹²çœ¼ç—‡è¾…åŠ©æ²»ç–—</title>
    <url>/2022/08/06/%E5%B9%B2%E7%9C%BC%E7%97%87%E8%BE%85%E5%8A%A9%E6%B2%BB%E7%96%97/</url>
    <content><![CDATA[<p>å…·ä½“æ˜¯ä»€ä¹ˆæ—¶å€™å¼€å§‹æœ‰å¹²çœ¼ç—‡çš„ç—‡çŠ¶å·²ç»è®°ä¸æ¸…æ¥šäº†ï¼Œå¤§æ¦‚æ˜¯2016å¹´æ‚£å¹²çœ¼ç—‡ï¼Œç›®å‰ï¼ˆ2022å¹´08æœˆ06æ—¥ï¼‰å¹²çœ¼ç—‡ç—‡çŠ¶ï¼šå¹²ç‡¥ã€å¼‚ç‰©æ„Ÿã€ç˜™ç—’ã€ç¼ç—›ï¼Œé—­çœ¼ç¡è§‰ï¼ˆä¸ç®¡æ˜¯ç™½å¤©è¿˜æ˜¯æ™šä¸Šï¼Œåªè¦æ˜¯é—­çœ¼ä¸€æ®µæ—¶é—´ï¼‰ç‰¹åˆ«æ˜æ˜¾ï¼Œççœ¼åä¸æ˜æ˜¾ã€‚</p>
<p>å¹²çœ¼ç—‡ç›®å‰æ²»ç–—æ°´å¹³ï¼šå¹²çœ¼ç—‡æ˜¯ä¸€ç§æ…¢æ€§ã€å¹¶ä¸”é€šå¸¸æ˜¯è¿›è¡Œæ€§ç—…ç—‡ã€‚æ ¹æ®å…¶åŸå› å’Œä¸¥é‡ç¨‹åº¦ï¼Œå¹²çœ¼ç—‡æœ‰æ—¶å¹¶ä¸èƒ½å®Œå…¨æ²»æ„ˆã€‚ä½†åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¹²çœ¼ç—‡çš„ç–¾ç—…ç®¡ç†å¯ä»¥å¾ˆæˆåŠŸï¼Œé€šè¿‡æ–½ä»¥é€‚å½“çš„æ²»ç–—æ‰‹æ®µï¼Œå¯ä»¥æ˜æ˜¾æ”¹å–„çœ¼ç›èˆ’é€‚åº¦ã€ç¼“è§£å¹²çœ¼ç—‡çŠ¶ã€å¹¶ä¸”æœ‰æ—¶ç”šè‡³å¯ä»¥è·å¾—æ›´æ¸…æ™°çš„è§†åŠ›ã€‚</p>
<h2 id="è¾…åŠ©æ²»ç–—æ–¹æ¡ˆ"><a href="#è¾…åŠ©æ²»ç–—æ–¹æ¡ˆ" class="headerlink" title="è¾…åŠ©æ²»ç–—æ–¹æ¡ˆ"></a>è¾…åŠ©æ²»ç–—æ–¹æ¡ˆ</h2><p>å»åŒ»é™¢çœ‹è¿‡å‡ æ¬¡ï¼Œä¸è¿‡æ•ˆæœä¸å¤§ã€‚ç”±äºæ˜¯æ…¢æ€§é•¿æœŸçš„ç—…ï¼Œæ‰€ä»¥è¿˜æ˜¯è¦æœ‰ä¸€å¥—èƒ½å¤Ÿéšæ‰‹å°±ç”¨çš„è¾…åŠ©æ²»ç–—æ–¹æ¡ˆã€‚</p>
<ol>
<li><p>æ—©ç¡æ—©èµ·ã€‚23:00å‡†å¤‡å…¥ç¡ã€‚23:30â€”7:30ã€‚</p>
</li>
<li><p>æŒ‰æ‘©çƒ­æ•·ã€‚æ—©æ™šå„ä¸€æ¬¡ã€‚æ¯æ¬¡12åˆ†é’Ÿã€‚</p>
</li>
<li><p>é£Ÿç–—ã€‚å¤šå–æ°´ï¼Œå¿Œè¾›è¾£ï¼Œæ²¹è…»ï¼Œå†°çš„ã€‚</p>
</li>
<li><p>å¤šæˆ·å¤–æ´»åŠ¨ã€‚è¿›è¡Œæˆ·å¤–è·‘æ­¥ã€‚å»ºè®®æ¯å‘¨ä¸¤æ¬¡æˆ·å¤–è·‘ï¼Œæ¯æ¬¡é”»ç‚¼åŠå°æ—¶ï¼Œå¤§æ¦‚å¯ä»¥è·‘3-4å…¬é‡Œã€‚</p>
</li>
<li><p>æ”¹å–„æ—¥å¸¸ç”Ÿæ´»ä¹ æƒ¯ã€‚</p>
<ul>
<li><p>å¤šçœ¨çœ¼ã€‚</p>
</li>
<li><p>åœ¨ç”µè„‘ä½¿ç”¨è¿‡ç¨‹ä¸­ç»å¸¸ä¼‘æ¯ã€‚ä¸€ä¸ªæ¯”è¾ƒå¥½çš„æ–¹æ³•æ˜¯â€”â€”è‡³å°‘æ¯éš”30åˆ†é’Ÿè¿œçœºï¼ˆåŠç±³ä»¥å¤–ï¼‰è‡³å°‘ç›´å¾„ä¸ºåŠç±³ä»¥ä¸Šçš„ç‰©ä½“3åˆ†é’Ÿï¼Œå®ƒå¯ä»¥å¸®åŠ©ç¼“è§£å¹²çœ¼ç—‡å’Œç”µè„‘çœ¼ç–²åŠ³ã€‚</p>
</li>
<li><p>ä¸èººç€ç©æ‰‹æœºã€ä¸åœ¨å…³ç¯åç©æ‰‹æœºã€‚</p>
</li>
<li><p>å‡å°‘ç”µå­è®¾å¤‡çš„ä½¿ç”¨ã€‚å°‘ç©æ¸¸æˆï¼Œå°‘ç©æ‰‹æœºã€ç”µè„‘ã€‚åˆæœŸå»ºè®®æ¯æ¬¡ç©æ¸¸æˆæ—¶é—´ä¸è¶…è¿‡2å°æ—¶ã€‚</p>
</li>
</ul>
</li>
<li><p>ä¿æŒç§¯æå¿ƒæ€ã€‚ä¸è¦å•¥ä¹Ÿä¸å¹²ï¼Œå¤©å¤©èººç€ã€‚ç©ºé—²æ—¶é—´å¤šè¯»ä¹¦ï¼Œå¬ä¹¦ä¹Ÿè¡Œã€‚</p>
</li>
</ol>
<p>è¾…åŠ©æ²»ç–—æ–¹æ¡ˆéœ€è¦é•¿æœŸçš„åšæŒä¸‹å»ã€‚å¸Œæœ›èƒ½å¤Ÿå¯¹å¹²çœ¼ç—‡æœ‰æ‰€ç¼“è§£ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>åŒ»å­¦ä¸Šæ—©å°±ç¡®è®¤å‡å°‘çœ¨çœ¼ç‡çš„æ´»åŠ¨ä¼šå¢åŠ å¹²çœ¼ç—‡çš„æ‚£ç—…ç‡ã€‚ä¾‹å¦‚ï¼Œåœ¨è®¡ç®—æœºä¸ŠèŠ±è´¹å¾ˆé•¿æ—¶é—´æ˜¯å¹²çœ¼ç—‡çš„ä¸€ä¸ªç¡®å®šçš„é£é™©å› ç´ ã€‚ç”±äºå¹²çœ¼ç—‡å¯èƒ½æœ‰å¤šç§åŸå› ï¼Œå› æ­¤é‡‡ç”¨çš„æ²»ç–—æ–¹æ³•å¯èƒ½å„æœ‰ä¸åŒã€‚é€šå¸¸å¹¶æ²¡æœ‰èƒ½å¤Ÿâ€œå¿«é€Ÿæ²»æ„ˆâ€å¹²çœ¼ç—‡çš„æ–¹æ³•ã€‚</p>
<h3 id="çƒ­æ•·ç–—æ³•"><a href="#çƒ­æ•·ç–—æ³•" class="headerlink" title="çƒ­æ•·ç–—æ³•"></a>çƒ­æ•·ç–—æ³•</h3><p>è¯¥æ–¹æ³•å¯ä»¥ä½œä¸ºç‘æ¿è…ºç–—æ³•çš„ä¸€ç§æ›´åŠ èˆ’é€‚çš„æ›¿ä»£æ‰‹æ®µï¼Œå®ƒé€šè¿‡ç®€å•åœ°å¯¹é—­åˆçš„çœ¼ç‘æ–½çƒ­æ•·ä»¥è½¯åŒ–ç‘æ¿ã€‚ä¸è¿‡ä¸ºäº†è¾¾åˆ°æ›´å¥½çš„æ•ˆæœï¼Œä¸€äº›ç ”ç©¶äººå‘˜æŒ‡å‡ºå¿…é¡»ä½¿çƒ­æ•·åœ¨42æ‘„æ°åº¦ä¸‹ä¿æŒè¶…è¿‡10åˆ†é’Ÿï¼Œå¹¶ä¸”å‹æ•·å¿…é¡»åœ¨è¿™æ®µæ—¶é—´å†…è‡³å°‘æ–½åŠ ä¸¤æ¬¡ã€‚å¤§å¤šæ•°äººä¸èƒ½æˆ–ä¸æ„¿æ„æ­£ç¡®åœ°è¿›è¡Œè¿™ç§å¹²çœ¼æ²»ç–—ï¼Œåªåœ¨è¾ƒä½æ¸©åº¦ä¸‹è¿›è¡Œå‹æ•·ï¼Œæ‰€ä»¥ç»å¸¸è¾¾ä¸åˆ°é¢„æœŸæ•ˆæœã€‚</p>
<h3 id="è¥å…»ç–—æ³•"><a href="#è¥å…»ç–—æ³•" class="headerlink" title="è¥å…»ç–—æ³•"></a>è¥å…»ç–—æ³•</h3><p>é€šè¿‡é£Ÿç‰©è¿›è¡Œè¥å…»è¡¥å……å¯ä»¥ä½œä¸ºå¹²çœ¼ç—‡æ²»ç–—çš„ä¸€éƒ¨åˆ†ã€‚ç ”ç©¶å‘ç°å«æœ‰omega-3è„‚è‚ªé…¸çš„é£Ÿç‰©å¯ä»¥å‡å°‘å¹²çœ¼ç—‡çŠ¶ã€‚omega-3çš„è‰¯å¥½é£Ÿç‰©æ¥æºä¸»è¦æ˜¯å„ç±»å†·æ°´é±¼ï¼Œå¦‚é²‘é±¼ã€æ²™ä¸é±¼ã€é²±é±¼å’Œé³•é±¼ï¼Œä¹Ÿå¯ä»¥ä»äºšéº»ç±½æ²¹ä¸­æ¥è·å¾—ã€‚æ­¤å¤–ï¼Œå–æ›´å¤šçš„æ°´ä¹Ÿå¯ä»¥å¯¹å¹²çœ¼ç—‡æœ‰æ‰€å¸®åŠ©ã€‚è½»åº¦è„±æ°´å¸¸å¸¸ä¼šä½¿å¹²çœ¼ç—‡çŠ¶æ¶åŒ–ï¼Œåœ¨ç‚çƒ­ï¼Œå¹²ç‡¥å’Œå¤šé£çš„å¤©æ°”ä¸­æƒ…å†µå°¤å…¶å¦‚æ­¤ã€‚ç®€å•åœ°å–æ›´å¤šçš„æ°´æœ‰æ—¶ä¼šå‡å°‘å¹²çœ¼ç—‡çš„ç—‡çŠ¶ã€‚</p>
<h3 id="æ”¹å–„æ—¥å¸¸ç”Ÿæ´»ä¹ æƒ¯"><a href="#æ”¹å–„æ—¥å¸¸ç”Ÿæ´»ä¹ æƒ¯" class="headerlink" title="æ”¹å–„æ—¥å¸¸ç”Ÿæ´»ä¹ æƒ¯"></a>æ”¹å–„æ—¥å¸¸ç”Ÿæ´»ä¹ æƒ¯</h3><ul>
<li><p>æ›´é¢‘ç¹çš„çœ¨çœ¼ã€‚å½“ä½¿ç”¨ç”µè„‘ã€æ‰‹æœºæˆ–å…¶ä»–æ•°ç è®¾å¤‡æ—¶ï¼Œæˆ‘ä»¬å¾€å¾€æ¯”å¹³æ—¶æ›´å°‘çš„çœ¨çœ¼ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æˆ–æ¶åŒ–å¹²çœ¼ç—‡ã€‚åº”å½“æœ‰æ„è¯†åœ°æ³¨æ„è¿™ä¸€ç‚¹ï¼Œåœ¨ä½¿ç”¨è¿™äº›ç”µå­è®¾å¤‡æ—¶æ›´é¢‘ç¹åœ°çœ¨çœ¼ã€‚</p>
</li>
<li><p>åœ¨ç”µè„‘ä½¿ç”¨è¿‡ç¨‹ä¸­ç»å¸¸ä¼‘æ¯ã€‚ä¸€ä¸ªæ¯”è¾ƒå¥½çš„æ–¹æ³•æ˜¯â€”â€”è‡³å°‘æ¯éš”20åˆ†é’Ÿè¿œçœºï¼ˆåŠç±³ä»¥å¤–ï¼‰è‡³å°‘ç›´å¾„ä¸ºåŠç±³ä»¥ä¸Šçš„ç‰©ä½“ï¼Œå®ƒå¯ä»¥å¸®åŠ©ç¼“è§£å¹²çœ¼ç—‡å’Œç”µè„‘çœ¼ç–²åŠ³ã€‚</p>
</li>
<li><p>æ¸…æ´çœ¼çš®ã€‚åœ¨ç¡å‰æ´—è„¸æ—¶ï¼Œè½»è½»åœ°æ¸…æ´—çœ¼ç‘ä»¥æ¸…é™¤å¯èƒ½ä¼šå¯¼è‡´ç‘ç¼˜ç‚å’Œç‘æ¿è…ºé—®é¢˜çš„ç»†èŒã€‚ç¡å‰å¯ä»¥å°†æ¸©æš–æ¹¿æ¶¦çš„æ¯›å·¾çƒ­æ•·çœ¼ç›ä¸€ä¸¤åˆ†é’Ÿï¼Œç„¶åç”¨æ¸©å’Œçš„æ´—æµ´ç”¨å“ï¼ˆå¦‚ç¨€é‡Šåçš„å©´å„¿æ´—å‘æ°´ï¼‰è½»è½»æ“¦æ´—çœ¼ç‘å’Œç«æ¯›ã€‚</p>
</li>
</ul>
<p><a href="https://zhuanlan.zhihu.com/p/38201841">å¹²çœ¼ç—‡æ²»ç–—çš„12ç§æ–¹æ³•</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/421364423">ç»“è†œç‚ å¹²çœ¼ç—‡ æ²»ç–—æ–¹æ¡ˆä¸åº·å¤è®°å½•</a></p>
]]></content>
      <categories>
        <category>Life</category>
      </categories>
  </entry>
  <entry>
    <title>Unix domain Socketç®€ä»‹</title>
    <url>/2022/08/05/Unix-domain-Socket%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>uds serverä¸clientæ˜¯æ€ä¹ˆè¿›è¡Œæ•°æ®é€šä¿¡çš„ï¼Ÿ</p>
<p>uds socketæ–‡ä»¶çš„ä½œç”¨ï¼Ÿ</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://www.flydean.com/17-unix-domain-socket/">ç½‘ç»œåè®®ä¹‹:socketåè®®è¯¦è§£ä¹‹Unix domain Socket</a></p>
<p><a href="https://mp.weixin.qq.com/s/fHzKYlW0WMhP2jxh2H_59A">Unix Domain Socketå·¥ä½œåŸç†</a></p>
]]></content>
      <categories>
        <category>Socket</category>
      </categories>
      <tags>
        <tag>UDS</tag>
      </tags>
  </entry>
  <entry>
    <title>è‹¹æœå®˜æ–¹æ–‡æ¡£æŸ¥è¯¢</title>
    <url>/2022/08/04/%E8%8B%B9%E6%9E%9C%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E6%9F%A5%E8%AF%A2/</url>
    <content><![CDATA[<p><a href="https://developer.apple.com/library/archive/navigation/">Documentation Archive</a>   :æœxxç¼–ç¨‹æŒ‡å—ï¼Œç¼ºç‚¹å°±æ˜¯è‹¹æœå·²ç»ä¸å†æ›´æ–°äº†ã€‚eg:CFNetwork Programming Guideã€Stream Programming Guideã€‚</p>
<p><a href="https://developer.apple.com/documentation/technologies">documentation-Technologies</a>  :è‹¹æœç›®å‰ç»´æŠ¤æ›´æ–°çš„å®˜æ–¹æ–‡æ¡£åœ°å€ï¼Œå¯ä»¥ç”¨æ¥æœAPIè¯´æ˜ã€‚ç¼ºç‚¹ï¼šéƒ½æ˜¯ä¸€äº›APIçš„ä»‹ç»è¯´æ˜ï¼ŒåŸç†æ€§ã€ç³»ç»Ÿæ€§çš„ä¸œè¥¿å¾ˆå°‘ã€‚</p>
]]></content>
      <categories>
        <category>å‚è€ƒèµ„æ–™</category>
      </categories>
      <tags>
        <tag>è‹¹æœå®˜æ–¹æ–‡æ¡£</tag>
      </tags>
  </entry>
  <entry>
    <title>è¡¥ç å®Œå…¨æŒ‡å—</title>
    <url>/2022/07/31/%E8%A1%A5%E7%A0%81%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/</url>
    <content><![CDATA[<p>æœ¬æ–‡åŸºäºè‡ªå·±çš„ç†è§£ï¼Œè¯•å›¾è®©çŒªéƒ½èƒ½ç†è§£è¡¥ç çš„æ¦‚å¿µ^_^ã€‚è€è§„çŸ©ï¼Œå…ˆæ˜¯å‡ ä¸ªæ¦‚å¿µã€‚</p>
<h2 id="æœºå™¨æ•°"><a href="#æœºå™¨æ•°" class="headerlink" title="æœºå™¨æ•°"></a>æœºå™¨æ•°</h2><p>æœºå™¨æ•°æ˜¯å°†ç¬¦å·æ•°å­—åŒ–çš„æ•°ï¼Œæœ€é«˜ä½æ˜¯ç¬¦å·ä½ï¼Œæ­£æ•°ç¬¦å·ä½ä¸º0ï¼Œè´Ÿæ•°ç¬¦å·ä½ä¸º1ï¼Œå…¶ä½™ä½è¡¨ç¤ºæ•°å€¼ã€‚</p>
<h2 id="çœŸå€¼"><a href="#çœŸå€¼" class="headerlink" title="çœŸå€¼"></a>çœŸå€¼</h2><p>æœºå™¨æ•°æ‰€å¯¹åº”çš„å®é™…æ•°å€¼ã€‚ã€€</p>
<h2 id="ç¼–ç¨‹è¯­è¨€ç±»å‹"><a href="#ç¼–ç¨‹è¯­è¨€ç±»å‹" class="headerlink" title="ç¼–ç¨‹è¯­è¨€ç±»å‹"></a>ç¼–ç¨‹è¯­è¨€ç±»å‹</h2><h3 id="æ— ç¬¦å·æ•°"><a href="#æ— ç¬¦å·æ•°" class="headerlink" title="æ— ç¬¦å·æ•°"></a>æ— ç¬¦å·æ•°</h3><p>å…¨éƒ¨äºŒè¿›åˆ¶ä½å‡ä»£è¡¨æ•°å€¼ï¼Œæ²¡æœ‰ç¬¦å·ä½ã€‚</p>
<h3 id="æœ‰ç¬¦å·æ•°"><a href="#æœ‰ç¬¦å·æ•°" class="headerlink" title="æœ‰ç¬¦å·æ•°"></a>æœ‰ç¬¦å·æ•°</h3><p>æœ€é«˜ä½ä»£è¡¨ç¬¦å·ä½(â€œ0â€è¡¨ç¤ºâ€œ+â€ï¼Œâ€œ1â€è¡¨ç¤ºâ€œ-â€)ï¼Œå…¶ä½™ä½è¡¨ç¤ºæ•°å€¼ã€‚</p>
<h3 id="ç±»å‹å¼ºè½¬"><a href="#ç±»å‹å¼ºè½¬" class="headerlink" title="ç±»å‹å¼ºè½¬"></a>ç±»å‹å¼ºè½¬</h3><p>åœ¨è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œæ•°å€¼ä¸€å¾‹ç”¨è¡¥ç æ¥å­˜å‚¨ã€‚å¯¹äºä¸€ä¸²äºŒè¿›åˆ¶æ•°å­—ï¼Œè¢«è§£é‡Šä¸ºæ— ç¬¦å·æ•°æˆ–æœ‰ç¬¦å·æ•°å®ƒå¯¹åº”çš„çœŸå€¼å¯èƒ½æ˜¯ä¸ç›¸ç­‰çš„ã€‚æ¯”å¦‚å†…å­˜ä¸­çš„ä¸€ä¸²äºŒè¿›åˆ¶1111 1111ï¼Œè¢«è§£é‡Šä¸ºæ— ç¬¦å·æ•°æ—¶åˆ™è¡¨ç¤º127ï¼Œè¢«è§£é‡Šä¸ºæœ‰ç¬¦å·æ•°æ—¶åˆ™è¡¨ç¤º-1ã€‚åœ¨å¼ºè½¬ç±»å‹æ—¶ç‰¹åˆ«è¦æ³¨æ„ï¼Œç‰¹åˆ«æ˜¯è¯­è¨€çš„éšå¼å¼ºè½¬ï¼Œå¾ˆå®¹æ˜“å°±å‡ºbugã€‚</p>
<h2 id="åŸç "><a href="#åŸç " class="headerlink" title="åŸç "></a>åŸç </h2><ul>
<li>æœ€é«˜ä½ä¸ºç¬¦å·ä½ï¼Œâ€œ0â€è¡¨ç¤ºæ­£å·ï¼Œâ€œ1â€è¡¨ç¤ºè´Ÿå·ã€‚</li>
<li>å…¶ä½™çš„n-1ä½è¡¨ç¤ºæ•°å€¼çš„ç»å¯¹å€¼ã€‚</li>
<li>åŸç å°±æ˜¯ç¬¦å·ä½åŠ ä¸ŠçœŸå€¼çš„ç»å¯¹å€¼, å³ç”¨ç¬¬ä¸€ä½è¡¨ç¤ºç¬¦å·, å…¶ä½™ä½è¡¨ç¤ºå€¼ã€‚</li>
<li>æ•°å­—â€œ0â€æœ‰â€œ+0â€å’Œâ€œ- 0â€ä¸¤ç§è¡¨ç¤ºå½¢å¼ï¼š0000 0000ï¼ˆ+0ï¼‰ã€1000 0000ï¼ˆ-0ï¼‰ã€‚</li>
<li>å¯¹äºæœºå™¨å­—é•¿ä¸ºn+1ä½çš„æœºå™¨ï¼ŒåŸç è¡¨ç¤ºæ³•å¯è¡¨ç¤ºçš„æ•°å€¼èŒƒå›´ä¸ºï¼š-2^n+1 â‰¤ X â‰¤ 2^n-1ã€‚æ¯”å¦‚8ä½å­—é•¿ï¼ŒåŸç èƒ½å¤Ÿè¡¨ç¤ºçš„æ•°å€¼èŒƒå›´ä¸º[-127, 127]ã€‚</li>
</ul>
<h2 id="åç "><a href="#åç " class="headerlink" title="åç "></a>åç </h2><ul>
<li>æœ€é«˜ä½ä¸ºç¬¦å·ä½ï¼Œâ€œ0â€è¡¨ç¤ºæ­£å·ï¼Œâ€œ1â€è¡¨ç¤ºè´Ÿå·ã€‚</li>
<li>å…¶ä½™çš„n-1ä½è¡¨ç¤ºæ•°å€¼ã€‚</li>
<li>æ­£æ•°çš„åç ä¸åŸç ç›¸åŒã€‚</li>
<li>è´Ÿæ•°çš„åç åˆ™æ˜¯åœ¨å…¶åŸç çš„åŸºç¡€ä¸Š, ç¬¦å·ä½ä¸å˜ï¼Œå…¶ä½™å„ä¸ªä½å–åã€‚</li>
<li>æ•°å­—â€œ0â€æœ‰â€œ+0â€å’Œâ€œ- 0â€ä¸¤ç§è¡¨ç¤ºå½¢å¼ï¼š0111 1111ï¼ˆ+0ï¼‰ã€1111 1111ï¼ˆ-0ï¼‰ã€‚</li>
<li>å¯¹äºæœºå™¨å­—é•¿ä¸ºn+1ä½çš„æœºå™¨ï¼Œåç è¡¨ç¤ºæ³•å¯è¡¨ç¤ºçš„æ•°å€¼èŒƒå›´ä¸ºï¼š-2^n+1 â‰¤ X â‰¤ 2^n-1ã€‚æ¯”å¦‚8ä½å­—é•¿ï¼Œåç èƒ½å¤Ÿè¡¨ç¤ºçš„æ•°å€¼èŒƒå›´ä¸º[-127, 127]ã€‚</li>
</ul>
<h2 id="è¡¥ç "><a href="#è¡¥ç " class="headerlink" title="è¡¥ç "></a>è¡¥ç </h2><ul>
<li>æœ€é«˜ä½ä¸ºç¬¦å·ä½ï¼Œâ€œ0â€è¡¨ç¤ºæ­£å·ï¼Œâ€œ1â€è¡¨ç¤ºè´Ÿå·ã€‚</li>
<li>æ•°å­—â€œ0â€åªæœ‰ä¸€ç§è¡¨ç¤ºå½¢å¼ï¼š0000 0000ã€‚</li>
<li>æ­£æ•°çš„è¡¥ç ä¸åŸç ç›¸åŒã€‚</li>
<li>è´Ÿæ•°çš„è¡¥ç æ˜¯å°†å…¶å¯¹åº”æ­£æ•°æŒ‰ä½å–åå†åŠ 1ã€‚ï¼ˆpsï¼šè¿™ä¸æ˜¯è§„å®šï¼Œåé¢æœ‰æ¨å¯¼ï¼‰</li>
<li>å¯¹äºæœºå™¨å­—é•¿ä¸ºn+1ä½çš„æœºå™¨ï¼Œè¡¥ç è¡¨ç¤ºæ³•å¯è¡¨ç¤ºçš„æ•°å€¼èŒƒå›´ä¸ºï¼š-2^n â‰¤ X â‰¤ 2^n-1ã€‚æ¯”å¦‚8ä½å­—é•¿ï¼Œè¡¥ç èƒ½å¤Ÿè¡¨ç¤ºçš„æ•°å€¼èŒƒå›´ä¸º[-128, 127]ã€‚è¿™å°±æœ‰æ„æ€äº†ï¼Œ-128å·²ç»è¶…å‡ºäº†åŸç å’Œåç çš„è¡¨ç¤ºèŒƒå›´ï¼Œå› æ­¤-128æœ‰è¡¥ç è¡¨ç¤ºï¼ˆ1000 0000ï¼‰ä½†å´æ²¡æœ‰å¯¹åº”çš„8ä½å­—é•¿çš„åŸç å’Œåç è¡¨ç¤ºã€‚æ‰€ä»¥è®¡ç®—ä¸€ä¸ªæ•°çš„è¡¥ç æœ€å¥½ä¸è¦ç”¨å¤§éƒ¨åˆ†ç½‘ä¸Šè¯´çš„å…ˆç®—åŸç å†ç®—åç å•¥çš„ï¼Œå…ˆç®—åŸç å°±ä¼šæœ‰ç‰¹ä¾‹-128ï¼Œè¿ç®—è§„åˆ™å°±ä¸ç»Ÿä¸€ï¼Œè€Œä¸”è¿˜å¾ˆéš¾ç†è§£-128çš„è¡¥ç ã€‚æœ€å¥½å°±æ˜¯ç”¨ä¸Šé¢çš„åŠæ³•ã€‚</li>
</ul>
<p>eg:</p>
<p>1.å·²çŸ¥çœŸå€¼æ±‚è¡¥ç </p>
<p>æ­£æ•°çš„è¡¥ç ä¸åŸç ç›¸åŒã€‚è´Ÿæ•°çš„è¡¥ç æ˜¯å°†å…¶å¯¹åº”æ­£æ•°æŒ‰ä½å–åå†åŠ 1ã€‚</p>
<p>æ±‚-1çš„è¡¥ç ã€‚-1çš„ç»å¯¹å€¼ä¸º1ï¼ŒäºŒè¿›åˆ¶ä¸º0000 0001ï¼ŒæŒ‰ä½å–åå¾—åˆ°1111 1110ï¼Œå†åŠ 1ï¼Œå¾—åˆ°è¡¥ç 1111 1111ã€‚</p>
<p>æ±‚-128çš„è¡¥ç ã€‚-128çš„ç»å¯¹å€¼ä¸º128ï¼ŒäºŒè¿›åˆ¶ä¸º1000 0000ï¼ŒæŒ‰ä½å–åå¾—åˆ°0111 1111ï¼Œå†åŠ 1ï¼Œå¾—åˆ°è¡¥ç 1000 0000ã€‚</p>
<p>2.å·²çŸ¥è¡¥ç æ±‚çœŸå€¼</p>
<p>å…ˆçœ‹æœ€é«˜ä½ï¼Œç¡®å®šç¬¦å·ï¼Œå¦‚æœæ˜¯0ï¼Œåˆ™ç›´æ¥ç®—å¾—å…¶çœŸå€¼ã€‚å¦‚æœä¸ºè´Ÿæ•°åˆ™æŒ‰ä½å–åï¼Œå†åŠ 1ï¼Œå¾—åˆ°å…¶çœŸå€¼çš„ç»å¯¹å€¼ï¼Œç¬¦å·+ç»å¯¹å€¼å¾—åˆ°çœŸå€¼ã€‚</p>
<p>æ±‚è¡¥ç 1000 0000çš„çœŸå€¼ã€‚æœ€é«˜ä½ä¸º1ï¼Œè¯´æ˜çœŸå€¼æ˜¯ä¸€ä¸ªè´Ÿæ•°ï¼ŒæŒ‰ä½å–åå¾—åˆ°0111 1111ï¼Œå†åŠ 1ï¼Œå¾—åˆ°çœŸå€¼çš„ç»å¯¹å€¼1000 0000å³128ï¼Œæ‰€ä»¥æœ€ç»ˆçœŸå€¼ä¸º-128ã€‚</p>
<p>æ±‚è¡¥ç 1111 1111çš„çœŸå€¼ã€‚æœ€é«˜ä½ä¸º1ï¼Œè¯´æ˜çœŸå€¼æ˜¯ä¸€ä¸ªè´Ÿæ•°ï¼ŒæŒ‰ä½å–åå¾—åˆ°0000 0000ï¼Œå†åŠ 1ï¼Œå¾—åˆ°çœŸå€¼çš„ç»å¯¹å€¼0000 0001å³1ï¼Œæ‰€ä»¥æœ€ç»ˆçœŸå€¼ä¸º-1ã€‚</p>
<p>å¯ä»¥çœ‹å‡ºå¯¹ä¸€ä¸ªè´Ÿæ•°çš„è¡¥ç å†å–ååŠ 1å¾—åˆ°çš„å°±æ˜¯è´Ÿæ•°çš„ç»å¯¹å€¼ã€‚</p>
<h3 id="ä¸ºä»€ä¹ˆä½¿ç”¨è¡¥ç "><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨è¡¥ç " class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨è¡¥ç "></a>ä¸ºä»€ä¹ˆä½¿ç”¨è¡¥ç </h3><p><strong>åœ¨æœ‰æ¨¡çš„è®¡é‡ç³»ç»Ÿä¸­</strong>ï¼Œå‡ä¸€ä¸ªæ•°ç­‰äºåŠ ä¸Šå®ƒçš„è¡¥æ•°ã€‚æ¯”å¦‚3 - 1 = 3 + [-1]è¡¥ = 3 + 255 = 0000 0011 + 1111 1111 = 0000 0010ï¼ˆæœ€é«˜ä½ä¸¢å¼ƒï¼‰ = 2</p>
<p>ä¸Šé¢è¿™ä¸ªä¾‹å­å¯èƒ½ä¸æ˜¯å¾ˆå¥½ç†è§£ï¼Œä¸€èˆ¬éƒ½æ˜¯ç”¨æ—¶é’Ÿç³»ç»Ÿæ¥ä¸¾ä¾‹ã€‚</p>
<p>å‡è®¾ç°åœ¨æ˜¯3ç‚¹é’Ÿï¼Œé€†æ—¶é’ˆæ—‹è½¬ä»£è¡¨å‡ï¼Œé¡ºæ—¶é’ˆæ—‹è½¬ä»£è¡¨åŠ ï¼Œé‚£ä¹ˆ- 1ï¼Œå°±æ˜¯é€†æ—¶é’ˆæ—‹è½¬1æ ¼ï¼ŒæŒ‡å‘2ï¼Œæ‰€ä»¥3 - 1 = 2ã€‚äº‹å®ä¸Šæˆ‘ä»¬å¯ä»¥é¡ºæ—¶é’ˆæ—‹è½¬11æ ¼ï¼ŒåŒæ ·æœ€ç»ˆä¼šæŒ‡å‘2ã€‚å› æ­¤åœ¨è¿™ä¸ªç³»ç»Ÿé‡Œ 3 - 1 ç­‰ä»·äº 3 + 11ã€‚11å°±æ˜¯-1çš„è¡¥ç ã€‚</p>
<p>æœ‰äº†è¡¥ç ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨åŠ æ³•æ¥è®¡ç®—å‡æ³•äº†ã€‚å°±ä¸ç”¨å•ç‹¬è®¾è®¡ä¸€å¥—å‡æ³•å™¨äº†ï¼Œç›´æ¥ä½¿ç”¨åŠ æ³•å™¨å°±å¯ä»¥äº†ã€‚</p>
<p>ç©è¿‡DNF PKçš„äººéƒ½çŸ¥é“ï¼Œè¦æƒ³æˆä¸ºä¸€ä¸ªPKé«˜æ‰‹ï¼Œè®¡ç®—å¯¹æ‰‹çš„è¹²ä¼æ—¶é—´ã€èè‰çš„è‰äººæ—¶é—´éå¸¸é‡è¦ï¼Œå¹¶ä¸”è¿˜è¦è®¡ç®—çš„éå¸¸å¿«ï¼Œå¦‚æœä½ è®¡ç®—çš„ä¸å¿«å¯èƒ½éƒ½å¿˜äº†å¯¹æ‰‹ä»€ä¹ˆæ—¶å€™äº¤çš„è¹²ä¼äº†ã€‚å¦‚æœä½ ç†Ÿæ‚‰è¡¥ç çš„è¯ï¼Œé‚£ä½ å°±å¯ä»¥è®¡ç®—çš„éå¸¸å¿«ã€‚</p>
<p>æ¯”å¦‚å¯¹æ‰‹3åˆ†18ç§’äº¤çš„è¹²ä¼ï¼Œ20ç§’åè¹²ä¼å†·å´ã€‚é‚£ä¹ˆä»–ä¸‹ä¸€æ¬¡å†·å´çš„æ—¶é—´å°±æ˜¯3åˆ†18ç§’ - 20ç§’ = 2åˆ†58ç§’ã€‚å¦‚æœä½ ç›´æ¥å»ç®—å‡æ³•çš„è¯å¯èƒ½ä¼šå¾ˆç»•ã€‚ç®—åŠ æ³•å°±å¾ˆç®€å•ï¼Œç§’æ—¶é—´æ˜¯ä¸€ä¸ªæ¨¡ä¸º60çš„ç³»ç»Ÿï¼Œ-20å°±ç›¸å½“äº+40ï¼Œå› æ­¤18 - 20 = 18 + 40 = 58ï¼Œå¾ˆå¿«å°±ç®—å‡ºæ¥å¯¹æ‰‹çš„ä¸‹ä¸€æ¬¡è¹²ä¼æ˜¯58ç§’ã€‚åˆ†é’Ÿä¸€èˆ¬ä¸ç”¨è€ƒè™‘ã€‚</p>
<p>å†æ¯”å¦‚é­”é“çš„è‰äººæ˜¯48ç§’ï¼Œå¦‚æœå¯¹æ‰‹3åˆ†13ç§’äº¤çš„è‰äººï¼Œé‚£ä¹ˆä»–ä¸‹ä¸€æ¬¡å†·å´çš„æ—¶é—´å°±æ˜¯3åˆ†13ç§’ - 48ç§’ï¼Œ-48ç›¸å½“äº+12ï¼Œ å› æ­¤ 13 + 12 = 25ï¼Œå³2åˆ†25ç§’é­”é“çš„è‰äººå†æ¬¡å†·å´ã€‚å¦‚æœç§’çš„å€’è®¡æ—¶å¤§äº48å°±ä¸è¦ç”¨è¡¥ç å»ç®—äº†ï¼Œæ¯”å¦‚3åˆ†52ç§’ï¼Œ52 - 48 = 4ã€‚å½“ç„¶å¦‚æœä½ æƒ³ç”¨è¡¥ç å»ç®—ä¹Ÿæ²¡æœ‰é—®é¢˜ï¼Œ52 + 12 = 64ï¼Œ6æ˜¯è¿›ä½èˆå»ï¼Œç»“æœä¹Ÿæ˜¯4ã€‚</p>
<h3 id="è¡¥ç çš„è®¡ç®—æ–¹å¼ç”±æ¥"><a href="#è¡¥ç çš„è®¡ç®—æ–¹å¼ç”±æ¥" class="headerlink" title="è¡¥ç çš„è®¡ç®—æ–¹å¼ç”±æ¥"></a>è¡¥ç çš„è®¡ç®—æ–¹å¼ç”±æ¥</h3><p>ä¸ºä»€ä¹ˆè´Ÿæ•°çš„è¡¥ç æ˜¯å°†å…¶å¯¹åº”æ­£æ•°æŒ‰ä½å–åå†åŠ 1ï¼Ÿ</p>
<p>å¯¹äº8ä½æœºå™¨å­—é•¿ï¼Œå®ƒçš„æ¨¡å°±æ˜¯256ï¼Œä¸€ä¸ªè´Ÿæ•°çš„è¡¥ç å°±ç­‰äºæ¨¡åŠ ä¸Šè¿™ä¸ªè´Ÿæ•°ã€‚å…¶å®æ­£æ•°çš„è¡¥ç ä¹Ÿç­‰äºæ¨¡åŠ ä¸Šè¿™ä¸ªæ•°åªä¸è¿‡èˆå»è¿›ä½å°±æ˜¯æ­£æ•°è‡ªèº«ï¼Œæ‰€ä»¥æ­£æ•°çš„è¡¥ç å°±æ˜¯å…¶åŸç ã€‚</p>
<p>æ¯”å¦‚ï¼š-1ï¼Œå®ƒçš„è¡¥ç å°±æ˜¯256+(-1) = 256 - 1 = 255 - 1 + 1 = 1111 1111 - 0000 0001 + 1 = 1111 1110 + 1 = 1111 1111</p>
<p>1111 1111å‡å»ä¸€ä¸ªæ­£æ•°Aç­‰ä»·äºAæŒ‰ä½å–åã€‚å› æ­¤ä¸€ä¸ªè´Ÿæ•°çš„è¡¥ç æ˜¯å°†å…¶å¯¹åº”æ­£æ•°æŒ‰ä½å–åå†åŠ 1ã€‚</p>
<h2 id="åŠ å‡æ³•ç”µè·¯"><a href="#åŠ å‡æ³•ç”µè·¯" class="headerlink" title="åŠ å‡æ³•ç”µè·¯"></a>åŠ å‡æ³•ç”µè·¯</h2><p>å¦‚å›¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/4%E4%BD%8D%E5%85%A8%E5%8A%A0%E5%99%A8.png" alt=""></p>
<p>ä¸Šå›¾è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ª4ä½åŠ å‡æ³•å™¨ï¼Œå¯ä»¥è®¡ç®—åŠ æ³•å’Œå‡æ³•ã€‚</p>
<p>è¾“å…¥ä¸ºA3A2A1A0ï¼ŒB3B2B1B0ï¼Œè¾“å‡ºä¸ºS3S2S1S0ã€‚Kä¿¡å·ä»£è¡¨åŠ å‡æ“ä½œï¼ŒK=0è¡¨ç¤ºåšåŠ æ³•ï¼ŒK=1è¡¨ç¤ºåšå‡æ³•ï¼ŒåŒæ—¶Kä¹Ÿä½œä¸ºè¾“å…¥ã€‚ä¸‰è§’å½¢ä¸ºå¼‚æˆ–é—¨ï¼ŒçŸ©å½¢ä¸ºå…¨åŠ å™¨ã€‚è¯¥ç”µè·¯ä¸»è¦éƒ¨ä»¶è¿˜æ˜¯åŠ æ³•å™¨ï¼Œé…åˆå¼‚æˆ–å™¨å’ŒåŠ å‡æ ‡å¿—ä¿¡å·åï¼Œå°±å¯ä»¥åšå‡æ³•äº†ã€‚å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªæ•°çš„å‡æ³•æœ€ç»ˆè¢«è½¬æ¢ä¸ºå¦ä¸¤ä¸ªæ•°çš„åŠ æ³•ï¼Œé¿å…äº†å•ç‹¬è®¾è®¡å‡æ³•å™¨ã€‚</p>
<p>æ¯”å¦‚5 - 2 = 0101 - 0010ï¼Œå› ä¸ºæ˜¯å‡æ³•æ‰€ä»¥K=1ï¼Œ0010ä¸1å¼‚æˆ–ï¼Œå…¶å®å°±æ˜¯æŒ‰ä½å–åï¼ŒåŒæ—¶Kä½œä¸ºè¾“å…¥ç›¸åŠ ï¼Œæ­£å¥½å°±æ˜¯åŠ 1ã€‚æ‰€ä»¥5 - 2 = 0101 - 0010 = 0101 + 1101 + 1 = 0101 + 1110 = 5 +  [-2]è¡¥ = 10011ï¼Œå› ä¸ºæ˜¯4ä½æœºæœ€é«˜ä½èˆå»ï¼Œç»“æœå°±æ˜¯0011ï¼Œä¹Ÿå°±æ˜¯3ã€‚</p>
<p>å†æ¯”å¦‚5 + 2ï¼Œå› ä¸ºæ˜¯åŠ æ³•K = 0 ï¼Œ0010ä¸0å¼‚æˆ–ï¼Œå…¶å®å°±æ˜¯ä¸å˜ï¼ŒçœŸæ˜¯å¤ªå·§äº†ã€‚ç›´æ¥åŠ å°±å®Œäº†ã€‚0101 + 0010 = 0111 = 7ã€‚</p>
<p>å†æ¯”å¦‚4 - (-1) ï¼Œç”±äºè´Ÿæ•°æ˜¯ä»¥è¡¥ç å­˜å‚¨çš„ï¼Œæ‰€ä»¥4 - (-1) = 0100 - 1111 = 0100 + 0000 + 1 = 0100 + 0001 = 4 + 1 = 5ã€‚</p>
<p>å†æ¯”å¦‚3 + (-1) = 0011 + 1111 = 10010ï¼Œæœ€é«˜ä½èˆå»ï¼Œç»“æœå°±æ˜¯0010 = 2ã€‚</p>
<p>int i = -1; =&gt; i = 0 - 1 = 0000 + 1111 = 1111ã€‚1111å­˜å…¥å†…å­˜ã€‚ä¸Šè¿°è¿‡ç¨‹å…¶å®å°±æ˜¯æŠŠ1è¿›è¡ŒæŒ‰ä½å–åå†åŠ 1ï¼Œè¿™æ­£æ˜¯è¡¥ç çš„ç®—æ³•ã€‚ä»¥ä¸Šç”µè·¯å®ç°äº†æ•´æ•°ä»¥è¡¥ç è¿›è¡Œå­˜å‚¨ã€‚</p>
]]></content>
      <categories>
        <category>è®¡ç®—æœºåŸºç¡€</category>
      </categories>
      <tags>
        <tag>è¡¥ç </tag>
      </tags>
  </entry>
  <entry>
    <title>TCPåè®®æŠ¥æ–‡</title>
    <url>/2022/07/29/TCP%E5%8D%8F%E8%AE%AE%E6%8A%A5%E6%96%87/</url>
    <content><![CDATA[<h3 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h3><p>ä¼ è¾“æ§åˆ¶åè®®ï¼ˆTransmission Control Protocolï¼ŒTCPï¼‰æ˜¯ä¸€ç§é¢å‘è¿æ¥çš„ã€å¯é çš„ã€åŸºäºå­—èŠ‚æµçš„ä¼ è¾“å±‚é€šä¿¡åè®®ã€‚</p>
<p>TCPåè®®ä½äºå››å±‚æ¨¡å‹ä¸­çš„ä¼ è¾“å±‚</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B.jpg" alt=""></p>
<h3 id="TCPæŠ¥æ–‡"><a href="#TCPæŠ¥æ–‡" class="headerlink" title="TCPæŠ¥æ–‡"></a>TCPæŠ¥æ–‡</h3><p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/032325597971641.jpg" alt=""></p>
<p><strong>æºç«¯å£</strong>ï¼š16bitï¼Œå…±65536ä¸ªç«¯å£ï¼Œç«¯å£0æœ‰ç‰¹æ®Šå«ä¹‰ï¼Œä¸èƒ½ä½¿ç”¨ï¼Œè¿™æ ·å¯ç”¨ç«¯å£æœ€å¤šåªæœ‰65535ã€‚</p>
<p><strong>ç›®çš„ç«¯å£</strong>ï¼š16bitï¼Œæ¥æ”¶æ–¹çš„ç«¯å£å·ã€‚</p>
<p><strong>åºå·</strong>ï¼š32bitï¼Œå¯é ä¼ è¾“æœåŠ¡çš„å…³é”®å­—æ®µã€‚åºå·ï¼ˆsequence numberï¼Œ seqï¼‰æ˜¯æŠ¥æ–‡æ®µé¦–å­—èŠ‚çš„å­—èŠ‚æµç¼–å·ï¼ŒTCPæŠŠæ•°æ®çœ‹æˆæ˜¯æœ‰åºçš„å­—èŠ‚æµï¼ŒTCPä¼šéšå¼åœ°å¯¹æ•°æ®æµçš„æ¯ä¸ªå­—èŠ‚è¿›è¡Œç¼–å·ã€‚ç¬¬ä¸€ä¸ªåŒ…çš„ç¼–å·ç”±æœ¬åœ°éšæœºäº§ç”Ÿï¼Œåˆ°è¾¾2^32-1åä¼šå†å›åˆ°0ã€‚å®¢æˆ·ç«¯ã€æœåŠ¡å™¨ç«¯æœ‰å„è‡ªçš„seqåºå·ã€‚åºå·ä¸»è¦<strong>ç”¨æ¥è§£å†³ç½‘ç»œåŒ…ä¹±åºï¼ˆreorderingï¼‰é—®é¢˜</strong>ã€‚</p>
<p><strong>ç¡®è®¤å·</strong>ï¼š32bitï¼Œå¯é ä¼ è¾“æœåŠ¡çš„å…³é”®å­—æ®µã€‚ç¡®è®¤å·ï¼ˆacknowledgment numberï¼Œackï¼‰æ˜¯æœŸæœ›çš„å¯¹æ–¹çš„ä¸‹ä¸€ä¸ªåºå·ã€‚ä¸»è¦<strong>ç”¨æ¥è§£å†³ä¸ä¸¢åŒ…çš„é—®é¢˜</strong>ã€‚</p>
<p><strong>é¦–éƒ¨é•¿åº¦</strong>ï¼š4bitï¼Œä»¥32bits4å­—èŠ‚ä¸ºå•ä½ï¼Œè¿™æ ·é¦–éƒ¨æœ€å¤§é•¿åº¦ä¸º15 * 4 = 60å­—èŠ‚ã€‚é™¤å»å›ºå®šéƒ¨åˆ†çš„é•¿åº¦20å­—èŠ‚ï¼Œå¯å˜éƒ¨åˆ†çš„é•¿åº¦æœ€å¤§ä¸º40å­—èŠ‚ã€‚é¦–éƒ¨é•¿åº¦ä¹Ÿç§°æ•°æ®åç§»ï¼Œç”±äºæŠ¥å¤´çš„é•¿åº¦å¯å˜ ï¼Œé¦–éƒ¨é•¿åº¦æŒ‡ç¤ºäº†æ•°æ®åŒºåœ¨æŠ¥æ–‡æ®µä¸­çš„èµ·å§‹åç§»å€¼ ã€‚</p>
<p><strong>ä¿ç•™</strong>ï¼š6bitsã€‚</p>
<p><strong>æ ‡å¿—</strong>ï¼š6bitsã€‚URGã€ACKã€PSHã€RSTã€SYNã€FINå…±6ä¸ªï¼Œæ¯ä¸€ä¸ªæ§åˆ¶ä½è¡¨ç¤ºä¸€ä¸ªæ§åˆ¶åŠŸèƒ½ã€‚ï¼ˆè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ä¸è¦æŠŠè¿™é‡Œçš„æ ‡å¿—ä½SYNï¼ŒACKå’Œä¸Šé¢çš„åºå·seqå’Œç¡®è®¤å·ackç›¸æ··æ·†ï¼Œè¿™ä¸¤ä¸ªæ˜¯ä¸åŒçš„ä¸œè¥¿ï¼‰</p>
<ul>
<li><p>URGï¼šç´§æ€¥æŒ‡é’ˆæ ‡å¿—ï¼Œä¸º1æ—¶è¡¨ç¤ºç´§æ€¥æŒ‡é’ˆæœ‰æ•ˆï¼Œä¸º0åˆ™å¿½ç•¥ç´§æ€¥æŒ‡é’ˆã€‚</p>
</li>
<li><p>ACKï¼šç¡®è®¤å·æ ‡å¿—ï¼Œä¸º1æ—¶ç¡®è®¤å·æœ‰æ•ˆ ï¼Œä¸º0æ—¶ç¡®è®¤å·æ— æ•ˆã€‚TCP è§„å®šé™¤äº†æœ€åˆå»ºç«‹è¿æ¥æ—¶çš„ SYN åŒ…ä¹‹å¤–è¯¥ä½å¿…é¡»è®¾ç½®ä¸º 1 ã€‚</p>
</li>
<li><p>PSHï¼šæ¨é€æ ‡å¿—ï¼Œä¸º1è¡¨ç¤ºæ˜¯å¸¦æœ‰pushæ ‡å¿—çš„æ•°æ®ï¼ŒæŒ‡ç¤ºæ¥æ”¶æ–¹åœ¨æ¥æ”¶åˆ°è¯¥æŠ¥æ–‡æ®µä»¥åï¼Œåº”å°½å¿«å°†è¿™ä¸ªæŠ¥æ–‡æ®µäº¤ç»™åº”ç”¨ç¨‹åºï¼Œè€Œä¸æ˜¯åœ¨ç¼“å†²åŒºæ’é˜Ÿã€‚</p>
</li>
<li><p>RSTï¼šé‡ç½®è¿æ¥æ ‡å¿—ï¼Œç”¨äºé‡ç½®ç”±äºä¸»æœºå´©æºƒæˆ–å…¶ä»–åŸå› è€Œå‡ºç°é”™è¯¯çš„è¿æ¥ã€‚æˆ–è€…ç”¨äºæ‹’ç»éæ³•çš„æŠ¥æ–‡æ®µå’Œæ‹’ç»è¿æ¥è¯·æ±‚ã€‚</p>
</li>
<li><p>SYNï¼šåŒæ­¥åºå·æ ‡å¿—ï¼Œç”¨äºå»ºç«‹è¿æ¥ï¼Œåœ¨è¿æ¥å»ºç«‹æ—¶åŒæ­¥åºå·ï¼ŒSYN=1æ—¶è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªè¿æ¥è¯·æ±‚æˆ–è¿æ¥æ¥å—æŠ¥æ–‡</p>
<blockquote>
<p>å½“SYN=1ä¸”ACK=0æ—¶ï¼Œè¡¨æ˜è¿™æ˜¯ä¸€ä¸ªè¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µ</p>
<p>å½“SYN=1ä¸”ACK=1æ—¶ï¼Œè¡¨æ˜å¯¹æ–¹åŒæ„å»ºç«‹è¿æ¥</p>
</blockquote>
<p>SYN=1çš„æŠ¥æ–‡<strong>ä¸èƒ½æºå¸¦æ•°æ®</strong>ï¼Œä½†è¦<strong>æ¶ˆè€—æ‰ä¸€ä¸ªåºå·</strong>ã€‚SYN=0ã€ACK=1çš„æŠ¥æ–‡<strong>å¯ä»¥æºå¸¦æ•°æ®</strong>ï¼Œå¦‚æœä¸æºå¸¦æ•°æ®åˆ™ä¸æ¶ˆè€—åºå·ï¼Œæ­¤æ—¶ä¸‹ä¸€ä¸ªæŠ¥æ–‡çš„åºå·ä¸å½“å‰æŠ¥æ–‡çš„åºå·ç›¸åŒ(æ³¨æ„ç†è§£è¿™é‡Œ)ã€‚</p>
</li>
<li><p>FINï¼šç»ˆæ­¢æ ‡å¿—ï¼Œç”¨äºé‡Šæ”¾è¿æ¥ï¼Œå€¼ä¸º1è¡¨ç¤ºè¦å‘é€çš„æ•°æ®æŠ¥å·²ç»å‘é€å®Œæ¯•ï¼Œéœ€è¦é‡Šæ”¾ä¼ è¾“è¿æ¥ã€‚</p>
</li>
</ul>
<p><strong>çª—å£</strong>ï¼š16bitï¼Œå•ä½å­—èŠ‚ã€‚æ»‘åŠ¨çª—å£å¤§å°ï¼Œç”¨äºæ¥æ”¶ç«¯å‘ŠçŸ¥å‘é€ç«¯ï¼Œæœ¬æ¥å—ç«¯çš„<strong>ç¼“å­˜å¤§å°</strong>ï¼Œä»¥æ­¤æ§åˆ¶å‘é€ç«¯å‘é€æ•°æ®çš„é€Ÿç‡ï¼Œä»è€Œè¾¾åˆ°<strong>æµé‡æ§åˆ¶</strong>ã€‚çª—å£æœ€å¤§ä¸º2^16-1=65535å­—èŠ‚ã€‚è¿™ä¹Ÿé™åˆ¶äº†TCPçš„ååé‡ï¼Œå¯ä»¥é€šè¿‡çª—å£ç¼©æ”¾é€‰é¡¹å¯¹è¿™ä¸ªå€¼è¿›è¡Œç¼©æ”¾ã€‚</p>
<p><strong>æ ¡éªŒå’Œ</strong>ï¼šå¥‡å¶æ ¡éªŒï¼Œæ­¤æ ¡éªŒå’Œæ˜¯å¯¹æ•´ä¸ªçš„ TCP æŠ¥æ–‡æ®µï¼ŒåŒ…æ‹¬ TCP å¤´éƒ¨å’Œ TCP æ•°æ®ï¼Œä»¥ 16 ä½å­—èŠ‚è¿›è¡Œè®¡ç®—æ‰€å¾—ã€‚ç”±å‘é€ç«¯è®¡ç®—å’Œå­˜å‚¨ï¼Œå¹¶ç”±æ¥æ”¶ç«¯è¿›è¡ŒéªŒè¯ã€‚</p>
<p><strong>ç´§æ€¥æŒ‡é’ˆ</strong>ï¼šåªæœ‰åœ¨URGå­—æ®µæ‰“å¼€æ—¶æ‰æœ‰æ•ˆã€‚æš‚æ—¶ä¸æ¸…æ¥šæœ‰å•¥ç”¨</p>
<p><strong>é€‰é¡¹</strong>ï¼šé•¿åº¦å¯å˜ï¼Œæœ€é•¿40å­—èŠ‚ï¼Œå½“æ²¡æœ‰é€‰é¡¹æ—¶æŠ¥å¤´é•¿åº¦æ˜¯20å­—èŠ‚ã€‚å¸¸è§çš„æœ‰MSSï¼Œwindow scaleï¼Œæ—¶é—´æˆ³ï¼ŒSACKã€‚</p>
<p><strong>å¡«å……</strong>ï¼šé€‰é¡¹é•¿åº¦ä¸ä¸€å®šæ˜¯32ä½çš„æ•´æ•°å€ï¼Œæ‰€ä»¥è¦åŠ å¡«å……ä½ï¼Œå³åœ¨è¿™ä¸ªå­—æ®µä¸­åŠ å…¥é¢å¤–çš„é›¶ï¼Œä»¥ä¿è¯TCPå¤´æ˜¯32çš„æ•´æ•°å€ã€‚</p>
<p><strong>æ•°æ®éƒ¨åˆ†</strong>ï¼š TCP æŠ¥æ–‡æ®µä¸­çš„æ•°æ®éƒ¨åˆ†æ˜¯å¯é€‰çš„ã€‚<br>åœ¨ä¸€ä¸ªè¿æ¥å»ºç«‹å’Œç»ˆæ­¢æ—¶ï¼ŒåŒæ–¹äº¤æ¢çš„æŠ¥æ–‡æ®µä»…æœ‰ TCP æŠ¥å¤´ã€‚å¦‚æœä¸€æ–¹æ²¡æœ‰æ•°æ®è¦å‘é€ï¼Œä¹Ÿä½¿ç”¨æ²¡æœ‰ä»»ä½•æ•°æ®çš„æŠ¥å¤´æ¥ç¡®è®¤æ”¶åˆ°çš„æ•°æ®ã€‚åœ¨å¤„ç†è¶…æ—¶çš„è®¸å¤šæƒ…å†µä¸­ï¼Œä¹Ÿä¼šå‘é€ä¸å¸¦ä»»ä½•æ•°æ®çš„æŠ¥å¤´ã€‚</p>
<h3 id="ACKæ ‡å¿—ä¸º1çš„TCPæŠ¥æ–‡èƒ½å¦æºå¸¦æ•°æ®ï¼Ÿ"><a href="#ACKæ ‡å¿—ä¸º1çš„TCPæŠ¥æ–‡èƒ½å¦æºå¸¦æ•°æ®ï¼Ÿ" class="headerlink" title="ACKæ ‡å¿—ä¸º1çš„TCPæŠ¥æ–‡èƒ½å¦æºå¸¦æ•°æ®ï¼Ÿ"></a>ACKæ ‡å¿—ä¸º1çš„TCPæŠ¥æ–‡èƒ½å¦æºå¸¦æ•°æ®ï¼Ÿ</h3><p>ACKæ ‡å¿—ä¸º1çš„TCPæŠ¥æ–‡ï¼Œè¡¨ç¤ºæŠ¥æ–‡ä¸­çš„ç¡®è®¤å·æœ‰æ•ˆï¼ŒTCP è§„å®šé™¤äº†æœ€åˆå»ºç«‹è¿æ¥æ—¶çš„ SYN åŒ…ä¹‹å¤–è¯¥ä½å¿…é¡»è®¾ç½®ä¸º 1 ã€‚å¯ä»¥æºå¸¦æ•°æ®ä¹Ÿå¯ä»¥ä¸æºå¸¦æ•°æ®ï¼Œå¦‚æœä¸æºå¸¦æ•°æ®åˆ™ä¸æ¶ˆè€—åºå·ã€‚ACKåªæ˜¯TCPçš„ä¸€ç§ç¡®è®¤æœºåˆ¶ï¼Œæ¥æ”¶ç«¯æ¥æ”¶åˆ°æ•°æ®åä¸éœ€è¦é©¬ä¸Šå›å¤ä¸€æ¡ACKæŠ¥æ–‡ï¼Œæ¥æ”¶ç«¯å¯ä»¥å»¶è¿Ÿç¡®è®¤ï¼Œä¹Ÿå¯ä»¥è·Ÿéšå°†è¦å‘é€çš„æ•°æ®ä¸€èµ·è¿‡å»è¿™æ—¶ACKè™½ç„¶ä¸º1ä½†æ˜¯å´æºå¸¦äº†æ•°æ®ï¼Œé¿å…ä¼ è¾“åªæœ‰TCPå¤´çš„ç©ºæŠ¥æ–‡ã€‚</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://blog.csdn.net/a19881029/article/details/38091243?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-3.nonecase&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-3.nonecase">ç†è§£TCPåºåˆ—å·ï¼ˆSequence Numberï¼‰å’Œç¡®è®¤å·ï¼ˆAcknowledgment Numberï¼‰</a>   è¯‘æ–‡,é€šè¿‡æŠ“åŒ…æ¥è§£é‡Šseq numberå’Œack numberã€‚</p>
<p><a href="https://packetlife.net/blog/2010/jun/7/understanding-tcp-sequence-acknowledgment-numbers/">Understanding TCP Sequence and Acknowledgment Numbers</a>  åŸæ–‡</p>
<p><a href="https://andrewpqc.github.io/2018/07/17/sequence-number-and-ack-number-in-tcp/">TCPä¸­çš„åºå·å’Œç¡®è®¤å·</a></p>
<p><a href="http://jm.taobao.org/2017/06/08/20170608/">å°±æ˜¯è¦ä½ æ‡‚ TCP</a>   é˜¿é‡Œä¸­é—´ä»¶å›¢é˜Ÿåšå®¢ </p>
]]></content>
      <categories>
        <category>TCP/IP</category>
      </categories>
      <tags>
        <tag>TCPæŠ¥æ–‡</tag>
      </tags>
  </entry>
  <entry>
    <title>IPåè®®æŠ¥æ–‡</title>
    <url>/2022/07/29/IP%E5%8D%8F%E8%AE%AE%E6%8A%A5%E6%96%87/</url>
    <content><![CDATA[<h3 id="ç½‘ç»œæ¨¡å‹"><a href="#ç½‘ç»œæ¨¡å‹" class="headerlink" title="ç½‘ç»œæ¨¡å‹"></a>ç½‘ç»œæ¨¡å‹</h3><p>ç½‘ç»œæ¨¡å‹å¸¸è§çš„æœ‰7ï¼Œ4ï¼Œ5å±‚æ¨¡å‹ã€‚</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B.jpg" alt=""></p>
<p>IPåè®®ä½äºå››å±‚æ¨¡å‹ä¸­çš„ç½‘ç»œå±‚ã€‚</p>
<h3 id="IPæŠ¥æ–‡"><a href="#IPæŠ¥æ–‡" class="headerlink" title="IPæŠ¥æ–‡"></a>IPæŠ¥æ–‡</h3><p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20170301092349308.png" alt=""></p>
<p><strong>ç‰ˆæœ¬</strong>ï¼šIPåè®®çš„ç‰ˆæœ¬ï¼Œå 4bitï¼Œç›®å‰çš„IPåè®®ç‰ˆæœ¬å·ä¸º4ï¼Œä¸‹ä¸€ä»£IPåè®®ç‰ˆæœ¬å·ä¸º6ã€‚æ³¨æ„è¿™é‡Œè®¨è®ºçš„æ˜¯IPv4çš„æŠ¥æ–‡ï¼ŒIPv6çš„æŠ¥æ–‡å·²ç»ä¸é•¿è¿™ä¸ªæ ·äº†ã€‚</p>
<p><strong>é¦–éƒ¨é•¿åº¦</strong>ï¼šIPæŠ¥å¤´çš„é•¿åº¦ã€‚å›ºå®šéƒ¨åˆ†çš„é•¿åº¦ï¼ˆ20å­—èŠ‚ï¼‰å’Œå¯å˜éƒ¨åˆ†çš„é•¿åº¦ä¹‹å’Œã€‚å…±å 4ä½ã€‚æœ€å¤§ä¸º1111ï¼Œå³10è¿›åˆ¶çš„15ï¼Œä»¥32bits4å­—èŠ‚ä¸ºå•ä½ï¼Œä»£è¡¨IPæŠ¥å¤´çš„æœ€å¤§é•¿åº¦å¯ä»¥ä¸º15ä¸ª32bitsï¼ˆ4å­—èŠ‚ï¼‰ï¼Œä¹Ÿå°±æ˜¯æœ€é•¿å¯ä¸º15*4=60å­—èŠ‚ï¼Œé™¤å»å›ºå®šéƒ¨åˆ†çš„é•¿åº¦20å­—èŠ‚ï¼Œå¯å˜éƒ¨åˆ†çš„é•¿åº¦æœ€å¤§ä¸º40å­—èŠ‚ã€‚</p>
<p><strong>æœåŠ¡ç±»å‹</strong>ï¼šType Of Serviceã€‚</p>
<p><strong>æ€»é•¿åº¦</strong>ï¼šIPæŠ¥æ–‡çš„æ€»é•¿åº¦ã€‚æŠ¥å¤´çš„é•¿åº¦å’Œæ•°æ®éƒ¨åˆ†çš„é•¿åº¦ä¹‹å’Œã€‚ç”¨16ä½äºŒè¿›åˆ¶æ•°è¡¨ç¤ºï¼Œå•ä½ä¸º8bits1å­—èŠ‚ï¼Œå› æ­¤ï¼ŒIPæŠ¥æ–‡çš„æœ€å¤§é•¿åº¦ä¸º65535å­—èŠ‚ã€‚ä½†ç”±äºMTUçš„é™åˆ¶ï¼Œè¶…è¿‡çš„è¯éœ€è¦åˆ†ç‰‡ä¼ è¾“ã€‚æ‰€ä»¥å°±å¿…é¡»è¦æœ‰åˆ†ç‰‡ç›¸å…³ä¿¡æ¯çš„å­—æ®µï¼Œåé¢ä¸‰ä¸ªå°±æ˜¯åˆ†ç‰‡ç›¸å…³çš„å­—æ®µã€‚</p>
<p><strong>æ ‡è¯†</strong>ï¼šå”¯ä¸€çš„æ ‡è¯†ä¸»æœºå‘é€çš„æ¯ä¸€ä»½æ•°æ®æŠ¥ã€‚é€šå¸¸æ¯å‘é€ä¸€ä¸ªæŠ¥æ–‡ï¼Œå®ƒçš„å€¼åŠ ä¸€ã€‚å½“IPæŠ¥æ–‡é•¿åº¦è¶…è¿‡ä¼ è¾“ç½‘ç»œçš„MTUï¼ˆæœ€å¤§ä¼ è¾“å•å…ƒï¼‰æ—¶å¿…é¡»åˆ†ç‰‡ï¼Œè¿™ä¸ªæ ‡è¯†å­—æ®µçš„å€¼è¢«å¤åˆ¶åˆ°æ‰€æœ‰æ•°æ®åˆ†ç‰‡çš„æ ‡è¯†å­—æ®µä¸­ï¼Œä½¿å¾—è¿™äº›åˆ†ç‰‡åœ¨è¾¾åˆ°æœ€ç»ˆç›®çš„åœ°æ—¶å¯ä»¥ä¾ç…§æ ‡è¯†å­—æ®µçš„å†…å®¹é‡æ–°ç»„æˆåŸå…ˆçš„æ•°æ®ã€‚</p>
<p><strong>æ ‡å¿—</strong>ï¼šå…±3ä½ã€‚Rã€DFã€MFä¸‰ä½ã€‚ç›®å‰åªæœ‰åä¸¤ä½æœ‰æ•ˆï¼ŒDFä½ï¼šä¸º1è¡¨ç¤ºä¸åˆ†ç‰‡ï¼Œä¸º0è¡¨ç¤ºåˆ†ç‰‡ã€‚MFï¼šä¸º1è¡¨ç¤ºâ€œæ›´å¤šçš„ç‰‡â€ï¼Œä¸º0è¡¨ç¤ºè¿™æ˜¯æœ€åä¸€ç‰‡ã€‚</p>
<p><strong>ç‰‡åç§»</strong>ï¼šæœ¬åˆ†ç‰‡åœ¨åŸå…ˆæ•°æ®æŠ¥æ–‡ä¸­ç›¸å¯¹é¦–ä½çš„åç§»é‡ï¼Œå­—æ®µé•¿åº¦ä¸º13ä½ï¼Œä»¥8bit1å­—èŠ‚ä¸ºå•ä½ï¼Œä¸»è¦ä½œç”¨æ˜¯ä¸ºäº†ä½¿åˆ†ç‰‡æ•°æ®çš„æ¥æ”¶è€…èƒ½å¤Ÿ<strong>æŒ‰ç…§æ­£ç¡®çš„é¡ºåº</strong>é‡ç»„æŠ¥æ–‡ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªç‰‡åç§»å€¼é‚£ä¹ˆæ¥æ”¶æ–¹æ”¶åˆ°åˆ†ç‰‡åå°±ä¸çŸ¥é“æŠŠè¿™ä¸ªåˆ†ç‰‡çš„æ•°æ®æ‹¼æ¥åœ¨å“ªä¸ªä½ç½®äº†ã€‚</p>
<p><strong>ç”Ÿå­˜æ—¶é—´</strong>ï¼šIPæŠ¥æ–‡æ‰€å…è®¸é€šè¿‡çš„è·¯ç”±å™¨çš„æœ€å¤§æ•°é‡ã€‚æ¯ç»è¿‡ä¸€ä¸ªè·¯ç”±å™¨ï¼ŒTTLï¼ˆTime To Liveï¼‰å‡1ï¼Œå½“ä¸º0æ—¶ï¼Œè·¯ç”±å™¨å°†è¯¥æ•°æ®æŠ¥ä¸¢å¼ƒã€‚TTL å­—æ®µæ˜¯ç”±å‘é€ç«¯åˆå§‹è®¾ç½®ä¸€ä¸ª 8 bitå­—æ®µ.æ¨èçš„åˆå§‹å€¼ç”±åˆ†é…æ•°å­— RFC æŒ‡å®šï¼Œå½“å‰å€¼ä¸º 64ã€‚å‘é€ ICMP å›æ˜¾åº”ç­”æ—¶ç»å¸¸æŠŠ TTL è®¾ä¸ºæœ€å¤§å€¼ 255ã€‚</p>
<p><strong>åè®®</strong>ï¼šæŒ‡å‡ºIPæŠ¥æ–‡æºå¸¦çš„æ•°æ®ä½¿ç”¨çš„æ˜¯é‚£ç§åè®®ï¼Œä»¥ä¾¿ç›®çš„ä¸»æœºçš„IPå±‚èƒ½çŸ¥é“è¦å°†æ•°æ®æŠ¥ä¸Šäº¤åˆ°å“ªä¸ªè¿›ç¨‹ï¼ˆä¸åŒçš„åè®®æœ‰ä¸“é—¨ä¸åŒçš„è¿›ç¨‹å¤„ç†ï¼‰ã€‚å’Œç«¯å£å·ç±»ä¼¼ï¼Œæ­¤å¤„é‡‡ç”¨åè®®å·ï¼ŒTCPçš„åè®®å·ä¸º6ï¼ŒUDPçš„åè®®å·ä¸º17ã€‚ICMPçš„åè®®å·ä¸º1ï¼ŒIGMPçš„åè®®å·ä¸º2.</p>
<p><strong>é¦–éƒ¨æ ¡éªŒå’Œ</strong>ï¼šè®¡ç®—IPå¤´éƒ¨çš„æ ¡éªŒå’Œï¼Œæ£€æŸ¥IPæŠ¥å¤´çš„å®Œæ•´æ€§ã€‚</p>
<p><strong>æºIPåœ°å€</strong>ï¼šæ ‡è¯†IPæ•°æ®æŠ¥çš„æºç«¯è®¾å¤‡ã€‚32ä½ï¼Œæœ€å¤§å¯ä»¥æ ‡è¯† <code>2^32</code>ï¼ˆçº¦ç­‰äº43äº¿ï¼‰ä¸ªè®¾å¤‡ã€‚43äº¿çœ‹èµ·æ¥å¾ˆå¤šï¼Œä½†ç°åœ¨å·²ç»æ‰€å‰©æ— å‡ ï¼Œæ‰€ä»¥æ‰å‡ºäº†IPv6ï¼ŒæŠŠIPåœ°å€ç›´æ¥å¹²åˆ°128ä½ï¼Œæœ€å¤§å¯ä»¥æ ‡è¯† <code>2^128</code> ï¼ˆ43äº¿ <em> 43äº¿ </em> 43äº¿ * 43äº¿ï¼‰ä¸ªè®¾å¤‡ï¼Œåº”è¯¥æ˜¯ç”¨ä¸å®Œçš„ã€‚</p>
<p><strong>ç›®çš„IPåœ°å€</strong>ï¼šæ ‡è¯†IPæ•°æ®æŠ¥çš„ç›®çš„åœ°å€ã€‚</p>
<p>æœ‰å…´è¶£çš„å¯ä»¥ç ”ç©¶ä¸‹IPåˆ†ç‰‡ä¸åˆ†ç‰‡é‡ç»„ã€‚</p>
<p><strong>å‚è€ƒ</strong></p>
<p><a href="https://blog.csdn.net/mary19920410/article/details/59035804">IPæŠ¥æ–‡æ ¼å¼è¯¦è§£</a></p>
<p><a href="http://www.023wg.com/message/message/cd_feature_ip_message_format.html">IPæŠ¥æ–‡æ ¼å¼</a></p>
<h3 id="é—®ç­”"><a href="#é—®ç­”" class="headerlink" title="é—®ç­”"></a>é—®ç­”</h3><h4 id="1-IPæŠ¥æ–‡ä¸­çš„TTLè®¾ç½®çš„è§„åˆ™æ˜¯ä»€ä¹ˆï¼Œæœ€å¤§å€¼255ä¼šä¸ä¼šä¸å¤Ÿï¼Ÿ"><a href="#1-IPæŠ¥æ–‡ä¸­çš„TTLè®¾ç½®çš„è§„åˆ™æ˜¯ä»€ä¹ˆï¼Œæœ€å¤§å€¼255ä¼šä¸ä¼šä¸å¤Ÿï¼Ÿ" class="headerlink" title="1. IPæŠ¥æ–‡ä¸­çš„TTLè®¾ç½®çš„è§„åˆ™æ˜¯ä»€ä¹ˆï¼Œæœ€å¤§å€¼255ä¼šä¸ä¼šä¸å¤Ÿï¼Ÿ"></a>1. IPæŠ¥æ–‡ä¸­çš„TTLè®¾ç½®çš„è§„åˆ™æ˜¯ä»€ä¹ˆï¼Œæœ€å¤§å€¼255ä¼šä¸ä¼šä¸å¤Ÿï¼Ÿ</h4><p>ç°è¡Œçš„ IP ç½‘ç»œçœ‹ä¼¼éå¸¸åºå¤§ï¼Œä½†å¾—ç›Šäºéª¨å¹²ç½‘ç»œä¼˜åŒ–ï¼Œä»»æ„ä¸¤ç‚¹çš„æœ€çŸ­è·¯å¾„å¹¶ä¸é•¿ã€‚æ‰€ä»¥å°±ç›®å‰é˜¶æ®µæ¥è¯´TTLä¸€èˆ¬è®¾ç½®ä¸º64æˆ–128è¶³ä»¥ã€‚</p>
<p>å‚è€ƒ:</p>
<p><a href="https://fasionchan.com/network/ip/ttl/">TTLï¼ŒIPåŒ…å­˜æ´»æ—¶é—´</a>  ç³»åˆ—æ–‡ç« ï¼Œä½œè€…å†™çš„è¿˜ä¸é”™ã€‚</p>
<h4 id="2-IPæŠ¥æ–‡æ€ä¹ˆè®¡ç®—æ•°æ®éƒ¨åˆ†é•¿åº¦"><a href="#2-IPæŠ¥æ–‡æ€ä¹ˆè®¡ç®—æ•°æ®éƒ¨åˆ†é•¿åº¦" class="headerlink" title="2. IPæŠ¥æ–‡æ€ä¹ˆè®¡ç®—æ•°æ®éƒ¨åˆ†é•¿åº¦"></a>2. IPæŠ¥æ–‡æ€ä¹ˆè®¡ç®—æ•°æ®éƒ¨åˆ†é•¿åº¦</h4><p>IPæŠ¥æ–‡ä¸­æœ‰ä¸¤ä¸ªå­—æ®µé¦–éƒ¨é•¿åº¦ã€æ€»é•¿åº¦ï¼Œå› æ­¤IPæŠ¥æ–‡çš„æ•°æ®éƒ¨åˆ†é•¿åº¦å°±ç­‰äºæ€»é•¿åº¦-é¦–éƒ¨é•¿åº¦ã€‚</p>
<h4 id="3-IPæŠ¥æ–‡ä¸ºä»€ä¹ˆéœ€è¦æ€»é•¿åº¦å­—æ®µ"><a href="#3-IPæŠ¥æ–‡ä¸ºä»€ä¹ˆéœ€è¦æ€»é•¿åº¦å­—æ®µ" class="headerlink" title="3.IPæŠ¥æ–‡ä¸ºä»€ä¹ˆéœ€è¦æ€»é•¿åº¦å­—æ®µ"></a>3.IPæŠ¥æ–‡ä¸ºä»€ä¹ˆéœ€è¦æ€»é•¿åº¦å­—æ®µ</h4><p>ç½‘ä¸Šåšå®¢çš„è§£é‡Šï¼š<br>å› ä¸ºä¸€äº›æ•°æ®é“¾è·¯ï¼ˆä»¥å¤ªç½‘ï¼‰æœ‰MTUæœ€å¤§ä¼ è¾“å•å…ƒé™åˆ¶ï¼Œå°äºæœ€å°MTUéœ€è¦å¡«å……ä¸€äº›æ•°æ®ä»¥è¾¾åˆ°æœ€å°é•¿åº¦ï¼Œå¤§äºæœ€å¤§MTUéœ€è¦å¯¹æ•°æ®æŠ¥è¿›è¡Œåˆ†ç‰‡å¤„ç†ï¼Œæ‰€ä»¥éœ€è¦æ€»é•¿åº¦æ¥ç¡®å®š IP æ•°æ®éƒ¨åˆ†çš„å†…å®¹ã€‚</p>
<p>ä¸»è¦åŸå› è¿˜æ˜¯å› ä¸ºä»¥å¤ªå¸§å¯èƒ½ä¼šè¿›è¡Œå¡«å……ã€‚</p>
<p><a href="https://qinnsang.github.io/2019/09/10/%E7%BD%91%E7%BB%9C%E5%B1%82%E4%B9%8BIP%E5%8D%8F%E8%AE%AE/">ç½‘ç»œå±‚ä¹‹IPåè®®</a></p>
<h4 id="4-ä¸ºä»€ä¹ˆä»¥å¤ªç½‘MTUé€šå¸¸è¢«è®¾ç½®ä¸º1500ï¼Ÿ"><a href="#4-ä¸ºä»€ä¹ˆä»¥å¤ªç½‘MTUé€šå¸¸è¢«è®¾ç½®ä¸º1500ï¼Ÿ" class="headerlink" title="4.ä¸ºä»€ä¹ˆä»¥å¤ªç½‘MTUé€šå¸¸è¢«è®¾ç½®ä¸º1500ï¼Ÿ"></a>4.ä¸ºä»€ä¹ˆä»¥å¤ªç½‘MTUé€šå¸¸è¢«è®¾ç½®ä¸º1500ï¼Ÿ</h4><p>RFCæ ‡å‡†å®šä¹‰ä»¥å¤ªç½‘çš„é»˜è®¤MTUå€¼ä¸º1500ã€‚é‚£ä¹ˆè¿™1500çš„å–å€¼æ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿ</p>
<p>æ—©æœŸçš„ä»¥å¤ªç½‘ä½¿ç”¨å…±äº«é“¾è·¯çš„å·¥ä½œæ–¹å¼ï¼Œä¸ºäº†ä¿è¯CSMA/CDï¼ˆè½½æ³¢å¤šè·¯å¤ç”¨/å†²çªæ£€æµ‹ï¼‰æœºåˆ¶ï¼Œæ‰€ä»¥è§„å®šäº†ä»¥å¤ªå¸§é•¿åº¦æœ€å°ä¸º64å­—èŠ‚ï¼Œæœ€å¤§ä¸º1518å­—èŠ‚ã€‚æœ€å°64å­—èŠ‚æ˜¯ä¸ºäº†ä¿è¯æœ€æç«¯çš„å†²çªèƒ½è¢«æ£€æµ‹åˆ°ï¼Œ64å­—èŠ‚æ˜¯èƒ½è¢«æ£€æµ‹åˆ°çš„æœ€å°å€¼ï¼›æœ€å¤§ä¸è¶…è¿‡1518å­—èŠ‚æ˜¯ä¸ºäº†é˜²æ­¢è¿‡é•¿çš„å¸§ä¼ è¾“æ—¶é—´è¿‡é•¿è€Œå ç”¨å…±äº«é“¾è·¯å¤ªé•¿æ—¶é—´å¯¼è‡´å…¶ä»–ä¸šåŠ¡é˜»å¡ã€‚æ‰€ä»¥è§„å®šä»¥å¤ªç½‘å¸§å¤§å°ä¸º64~1518å­—èŠ‚ï¼Œè™½ç„¶æŠ€æœ¯ä¸æ–­å‘å±•ï¼Œä½†åè®®ä¸€ç›´æ²¡æœ‰æ›´æ”¹ã€‚</p>
<p>ä»¥å¤ªç½‘æœ€å¤§çš„æ•°æ®å¸§æ˜¯1518å­—èŠ‚ï¼Œè¿™æ ·åˆ¨å»å¸§å¤´14å­—èŠ‚å’Œå¸§å°¾<a href="https://info.support.huawei.com/info-finder/encyclopedia/zh/CRC.html">CRC</a>æ ¡éªŒéƒ¨åˆ†4å­—èŠ‚ï¼Œé‚£ä¹ˆå‰©ä¸‹æ‰¿è½½ä¸Šå±‚IPæŠ¥æ–‡çš„åœ°æ–¹æœ€å¤§å°±åªæœ‰1500å­—èŠ‚ï¼Œè¿™ä¸ªå€¼å°±æ˜¯ä»¥å¤ªç½‘çš„é»˜è®¤MTUå€¼ã€‚è¿™ä¸ªMTUå°±æ˜¯ç½‘ç»œå±‚åè®®éå¸¸å…³å¿ƒçš„åœ°æ–¹ï¼Œå› ä¸ºç½‘ç»œå±‚åè®®æ¯”å¦‚IPåè®®ä¼šæ ¹æ®è¿™ä¸ªå€¼æ¥å†³å®šæ˜¯å¦æŠŠä¸Šå±‚ä¼ ä¸‹æ¥çš„æ•°æ®è¿›è¡Œåˆ†ç‰‡ï¼Œå¦‚æœå•ä¸ªIPæŠ¥æ–‡é•¿åº¦å¤§äºMTUï¼Œåˆ™ä¼šåœ¨å‘é€å‡ºæ¥å£å‰è¢«åˆ†ç‰‡ï¼Œè¢«åˆ‡å‰²ä¸ºå°äºæˆ–ç­‰äºMTUé•¿åº¦çš„IPåŒ…ã€‚</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/MTU.png" alt=""></p>
<h4 id="5-è¶…è¿‡MTUçš„æŠ¥æ–‡å¦‚ä½•è¿›è¡Œåˆ†ç‰‡ï¼Ÿ"><a href="#5-è¶…è¿‡MTUçš„æŠ¥æ–‡å¦‚ä½•è¿›è¡Œåˆ†ç‰‡ï¼Ÿ" class="headerlink" title="5.è¶…è¿‡MTUçš„æŠ¥æ–‡å¦‚ä½•è¿›è¡Œåˆ†ç‰‡ï¼Ÿ"></a>5.è¶…è¿‡MTUçš„æŠ¥æ–‡å¦‚ä½•è¿›è¡Œåˆ†ç‰‡ï¼Ÿ</h4><p>ä»¥å¤ªç½‘ç¼ºçœMTU=1500å­—èŠ‚ï¼Œè¿™æ˜¯ä»¥å¤ªç½‘æ¥å£å¯¹IPå±‚çš„çº¦æŸï¼Œå¦‚æœIPå±‚æœ‰&lt;=1500å­—èŠ‚éœ€è¦å‘é€ï¼Œåªéœ€è¦ä¸€ä¸ªIPåŒ…å°±å¯ä»¥å®Œæˆå‘é€ä»»åŠ¡ï¼›å¦‚æœIPå±‚æœ‰&gt;1500å­—èŠ‚æ•°æ®éœ€è¦å‘é€ï¼Œéœ€è¦åˆ†ç‰‡æ‰èƒ½å®Œæˆå‘é€ã€‚</p>
<p>ä»¥ä¸»æœºå‘é€ä¸€ä¸ªæ•°æ®è½½è·é•¿åº¦ä¸º2000å­—èŠ‚çš„æŠ¥æ–‡ä¸ºä¾‹è¯´æ˜å…¶åˆ†ç‰‡çš„è¿‡ç¨‹ï¼ˆå‡è®¾å‡ºæ¥å£çš„MTUå€¼ä¸º1500ï¼‰ã€‚åœ¨ç½‘ç»œå±‚ä¼šå¯¹æŠ¥æ–‡è¿›è¡Œå°è£…ï¼Œå…¶ç»“æ„ç»„æˆï¼šIPå¤´éƒ¨20å­—èŠ‚+æ•°æ®è½½è·é•¿åº¦2000å­—èŠ‚ï¼ŒæŠ¥æ–‡å°è£…åï¼Œæ•´ä¸ªæŠ¥æ–‡é•¿åº¦ä¸º2020å­—èŠ‚ã€‚åœ¨å‡ºæ¥å£è¿›è¡Œè½¬å‘çš„æ—¶å€™ï¼Œå‘ç°IPæŠ¥æ–‡çš„é•¿åº¦è¶…è¿‡äº†MTUçš„å€¼1500ï¼Œå› æ­¤è¦è¿›è¡Œåˆ†ç‰‡å¤„ç†ï¼Œè¯¦æƒ…è§ä¸‹å›¾ã€‚</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/IP%E5%88%86%E7%89%87%E7%A4%BA%E6%84%8F.png" alt=""></p>
<p>ç¬¬ä¸€ç‰‡æŠ¥æ–‡ï¼ŒIPæŠ¥æ–‡å¤´å›ºå®š20å­—èŠ‚ï¼Œæ•°æ®è½½è·å¯ä»¥å°è£…1480å­—èŠ‚ï¼ˆMTUå€¼1500å­—èŠ‚-IPæŠ¥æ–‡å¤´20å­—èŠ‚ï¼Œæ•°æ®è½½è·é•¿åº¦é¡»æ˜¯8çš„å€æ•°ï¼‰ï¼›</p>
<p>ç¬¬äºŒç‰‡æŠ¥æ–‡ï¼Œå¤åˆ¶ç¬¬ä¸€ç‰‡çš„IPå¤´ï¼ŒIPæŠ¥æ–‡å¤´å›ºå®š20å­—èŠ‚ï¼Œæ•°æ®è½½è·ä¸ºå‰©ä½™çš„520å­—èŠ‚ï¼ˆæ€»æ•°æ®è½½è·é•¿åº¦2000å­—èŠ‚å‡å»ç¬¬ä¸€ç‰‡ä¸­å·²å°è£…çš„1480å­—èŠ‚ï¼‰ã€‚å¦‚æœæœ€åä¸€ç‰‡æŠ¥æ–‡çš„é•¿åº¦ä¸è¶³46å­—èŠ‚(MTUæœ€å°å€¼ä¸º46å­—èŠ‚)ï¼Œä¼šè‡ªåŠ¨å¡«å……è‡³46å­—èŠ‚ã€‚ï¼ˆå¯ä»¥çœ‹åˆ°è¿™é‡Œä¼šè‡ªåŠ¨å¡«å……åˆ°46å­—èŠ‚ï¼Œå‡å¦‚æ•´ä¸ªIPåŒ…åªæœ‰30å­—èŠ‚ï¼Œå¦‚æœä¸çŸ¥é“IPåŒ…çš„æ€»é•¿åº¦é‚£ä¹ˆå°±æ— æ³•å¾—çŸ¥IPåŒ…çš„ç•Œé™ã€‚ç”±äºåˆ†ç‰‡å’Œå¡«å……çš„åŸå› ï¼Œæ‰€ä»¥IPåŒ…é‡Œé¢éœ€è¦æœ‰ä¸€ä¸ªæ€»é•¿åº¦çš„å­—æ®µã€‚ï¼‰</p>
<p>æ‰€æœ‰åˆ†ç‰‡æŠ¥æ–‡åœ¨å‘é€è‡³ç›®çš„ä¸»æœºåï¼Œåœ¨ç›®çš„ä¸»æœºè¿›è¡Œåˆ†ç‰‡é‡ç»„ï¼Œæ¢å¤ä¸ºåŸæŠ¥æ–‡ã€‚åœ¨è¿›è¡Œé‡ç»„æ—¶ï¼Œé€šè¿‡IPæ ‡å¿—ä½ä¸­çš„MFç”¨æ¥åˆ†è¾¨è¿™æ˜¯ä¸æ˜¯æœ€åä¸€ä¸ªåˆ†ç‰‡ï¼Œç‰‡åç§»ç”¨æ¥åˆ†è¾¨è¿™ä¸ªåˆ†ç‰‡ç›¸å¯¹åŸæ•°æ®æŠ¥çš„ä½ç½®ã€‚é€šè¿‡è¿™å‡ ä¸ªå­—æ®µï¼Œå¯ä»¥å‡†ç¡®çš„å®Œæˆæ•°æ®æŠ¥çš„é‡ç»„æ“ä½œã€‚</p>
]]></content>
      <categories>
        <category>TCP/IP</category>
      </categories>
      <tags>
        <tag>IPæŠ¥æ–‡</tag>
      </tags>
  </entry>
  <entry>
    <title>å­—ç¬¦ä¸²æ“ä½œrangeæ³¨æ„äº‹é¡¹</title>
    <url>/2022/07/27/%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%93%8D%E4%BD%9Crange%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/</url>
    <content><![CDATA[<p>ä»£ç ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *string = <span class="string">@&quot;&quot;</span>;</span><br><span class="line">    <span class="built_in">NSString</span> *ret = [string stringByReplacingCharactersInRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, <span class="number">0</span>) withString:<span class="string">@&quot;å› å¹æ–¯æ±€&quot;</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;string:%@\nret:%@&quot;</span>, string, ret); <span class="comment">//å› å¹æ–¯æ±€</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *string = <span class="string">@&quot;å€’è®¡æ—¶å¼€å…³æ˜¯&quot;</span>;</span><br><span class="line">    <span class="built_in">NSString</span> *ret = [string stringByReplacingCharactersInRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, <span class="number">0</span>) withString:<span class="string">@&quot;å› å¹æ–¯æ±€&quot;</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;string:%@\nret:%@&quot;</span>, string, ret); <span class="comment">//å› å¹æ–¯æ±€å€’è®¡æ—¶å¼€å…³æ˜¯</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *string = <span class="string">@&quot;å€’è®¡æ—¶å¼€å…³æ˜¯&quot;</span>;</span><br><span class="line">    <span class="built_in">NSString</span> *ret = [string stringByReplacingCharactersInRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, <span class="number">1</span>) withString:<span class="string">@&quot;å› å¹æ–¯æ±€&quot;</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;string:%@\nret:%@&quot;</span>, string, ret); <span class="comment">//å› å¹æ–¯æ±€è®¡æ—¶å¼€å…³æ˜¯</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *string = <span class="string">@&quot;å€’è®¡æ—¶å¼€å…³æ˜¯&quot;</span>;</span><br><span class="line">    <span class="built_in">NSString</span> *ret = [string stringByReplacingCharactersInRange:<span class="built_in">NSMakeRange</span>(string.length, <span class="number">0</span>) withString:<span class="string">@&quot;å› å¹æ–¯æ±€&quot;</span>]; <span class="comment">//å€’è®¡æ—¶å¼€å…³æ˜¯å› å¹æ–¯æ±€</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;string:%@\nret:%@&quot;</span>, string, ret);</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *string = <span class="string">@&quot;å€’è®¡æ—¶å¼€å…³æ˜¯&quot;</span>;</span><br><span class="line">    <span class="built_in">NSString</span> *ret = [string stringByReplacingCharactersInRange:<span class="built_in">NSMakeRange</span>(string.length - <span class="number">1</span>, <span class="number">1</span>) withString:<span class="string">@&quot;å› å¹æ–¯æ±€&quot;</span>]; <span class="comment">//å€’è®¡æ—¶å¼€å…³å› å¹æ–¯æ±€</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;string:%@\nret:%@&quot;</span>, string, ret);</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *string = <span class="string">@&quot;å€’è®¡æ—¶å¼€å…³æ˜¯&quot;</span>;</span><br><span class="line">    <span class="built_in">NSString</span> *ret = [string stringByReplacingCharactersInRange:<span class="built_in">NSMakeRange</span>(string.length, <span class="number">1</span>) withString:<span class="string">@&quot;å› å¹æ–¯æ±€&quot;</span>]; <span class="comment">//å´©æºƒ</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;string:%@\nret:%@&quot;</span>, string, ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ€»ç»“ï¼š</p>
<p>ä¼ å…¥çš„rangeå¿…é¡»æ»¡è¶³ï¼š(range.location + range.length) &lt;= string.lengthï¼Œå¦åˆ™ä¼šå‘ç”Ÿè¶Šç•Œå´©æºƒã€‚</p>
]]></content>
      <categories>
        <category>å­—ç¬¦ä¸²</category>
      </categories>
  </entry>
  <entry>
    <title>éšå¼ç±»å‹è½¬æ¢å¯¼è‡´çš„è¯¡å¼‚bug</title>
    <url>/2022/07/27/%E9%9A%90%E5%BC%8F%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E5%AF%BC%E8%87%B4%E7%9A%84%E8%AF%A1%E5%BC%82bug/</url>
    <content><![CDATA[<p>çœ‹ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSUInteger</span> a = <span class="number">100</span>;</span><br><span class="line"><span class="built_in">NSUInteger</span> b = <span class="number">104</span>;</span><br><span class="line"><span class="built_in">NSUInteger</span> c = <span class="number">30</span>;</span><br><span class="line"><span class="built_in">NSInteger</span> ret = a - b;</span><br><span class="line"><span class="keyword">if</span> (ret &gt; c) &#123; <span class="comment">//retè¢«éšå¼è½¬æ¢ä¸ºæ— ç¬¦å·æ•´å‹</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;1&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (ret &gt; (<span class="built_in">NSInteger</span>)c) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;2&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;ret:%ld&quot;</span>, (<span class="type">long</span>)ret);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;ret:%lu&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span>)ret);</span><br></pre></td></tr></table></figure>
<p>æ‰“å°ï¼š</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">2023</span>-<span class="number">04</span>-<span class="number">30</span> <span class="number">13</span>:<span class="number">10</span>:<span class="number">02</span>.<span class="number">474708</span>+<span class="number">0800</span> PodDemo[<span class="number">22390</span>:<span class="number">3868894</span>] <span class="number">1</span></span><br><span class="line"><span class="attribute">2023</span>-<span class="number">04</span>-<span class="number">30</span> <span class="number">13</span>:<span class="number">10</span>:<span class="number">02</span>.<span class="number">474798</span>+<span class="number">0800</span> PodDemo[<span class="number">22390</span>:<span class="number">3868894</span>] ret:-<span class="number">4</span></span><br><span class="line"><span class="attribute">2023</span>-<span class="number">04</span>-<span class="number">30</span> <span class="number">13</span>:<span class="number">10</span>:<span class="number">02</span>.<span class="number">474845</span>+<span class="number">0800</span> PodDemo[<span class="number">22390</span>:<span class="number">3868894</span>] ret:<span class="number">18446744073709551612</span></span><br></pre></td></tr></table></figure>
<p>po ä¸ pï¼šå¯¹è±¡æœ€å¥½ä½¿ç”¨poï¼ŒåŸºç¡€æ•°æ®ç±»å‹ä½¿ç”¨pã€‚</p>
<p>swiftåˆ™ä¼šæº¢å‡ºå´©æºƒï¼šswiftç›´æ¥å†™ä¸Šé¢çš„ä»£ç ç¼–è¯‘éƒ½é€šä¸è¿‡ï¼Œå¾—æ‹ä¸ªå¼¯ï¼š</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">myoverflow</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> a: <span class="type">UInt64</span> <span class="operator">=</span> <span class="number">100</span></span><br><span class="line">    <span class="keyword">let</span> b: <span class="type">UInt64</span> <span class="operator">=</span> <span class="number">103</span></span><br><span class="line">    _myoverflow(a, b)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">func</span> <span class="title function_">_myoverflow</span>(<span class="keyword">_</span> <span class="params">a</span>: <span class="type">UInt64</span>, <span class="keyword">_</span> <span class="params">b</span>: <span class="type">UInt64</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> ret <span class="operator">=</span> a <span class="operator">-</span> b <span class="comment">//Thread 1: Swift runtime failure: arithmetic overflow</span></span><br><span class="line">    <span class="keyword">let</span> c: <span class="type">Int</span> <span class="operator">=</span> <span class="number">30</span></span><br><span class="line">    <span class="keyword">if</span> ret <span class="operator">&gt;</span> c &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;sd&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>swiftç¡®å®æ˜¯ä¸€é—¨å®‰å…¨çš„è¯­è¨€ã€‚</p>
]]></content>
      <categories>
        <category>Bug</category>
      </categories>
      <tags>
        <tag>éšå¼ç±»å‹è½¬æ¢</tag>
      </tags>
  </entry>
  <entry>
    <title>å¦‚ä½•å­¦ä¹ ä¸€ä¸ªæ¡†æ¶</title>
    <url>/2022/07/25/%E5%A6%82%E4%BD%95%E5%AD%A6%E4%B9%A0%E4%B8%80%E4%B8%AA%E6%A1%86%E6%9E%B6/</url>
    <content><![CDATA[<p>åœ¨è¯»äº†ä¸€äº›æ¡†æ¶æºç åï¼Œä¸ªäººè§‰å¾—åº”è¯¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢å­¦ä¹ ä¸€ä¸ªæ¡†æ¶ï¼š</p>
<p>1.æ¡†æ¶å®ç°çš„åŠŸèƒ½<br>è¿™ä¸ªæ¡†æ¶æ˜¯ç”¨æ¥å¹²å˜›çš„ã€‚</p>
<p>2.æ¡†æ¶çš„å·¥ä½œæµç¨‹<br>é«˜å±‹å»ºç“´çš„æè¿°ä¸€ä¸‹æ¡†æ¶çš„å·¥ä½œæµç¨‹ã€‚</p>
<p>3.ç®€å•çš„ä½¿ç”¨æ¡†æ¶<br>åšä¸€ä¸ªå°demoã€‚</p>
<p>4.æ¡†æ¶ä½¿ç”¨çš„åŸºç¡€åº“<br>åŸºäºå“ªäº›ç³»ç»Ÿæ¡†æ¶æˆ–å…¶ä»–ç¬¬ä¸‰æ–¹åº“ã€‚</p>
<p>5.æ¡†æ¶çš„è®¾è®¡<br>æ¶æ„è®¾è®¡ï¼Œè®¾è®¡æ¨¡å¼ï¼Œæ•°æ®ç»“æ„å’Œç®—æ³•ï¼Œç±»çš„UMLå›¾ã€‚</p>
<p>6.æ¡†æ¶çš„å®ç°ç»†èŠ‚<br>è¯­è¨€çš„é«˜çº§ä½¿ç”¨ï¼Œå¤šçº¿ç¨‹å¤„ç†ï¼Œå¤ç”¨ï¼Œå†…å­˜ä¼˜åŒ–ï¼ŒCPUä¼˜åŒ–ï¼Œ<strong>è¾¹ç•Œæƒ…å†µå¤„ç†</strong>ç­‰ç­‰ã€‚</p>
<p>7.æ¡†æ¶çš„ä¼˜ç¼ºç‚¹<br>åœ¨å¯¹æ¡†æ¶è¾¾åˆ°ä¸€å®šçš„äº†è§£åï¼Œæ˜ç™½æ¡†æ¶çš„æœ€ä½³ä½¿ç”¨åœºæ™¯åŠå±€é™æ€§ã€‚</p>
<p>8.å¯¹æ¡†æ¶çš„æ”¹è¿›<br>å°è¯•è§£å†³æ¡†æ¶ä¸­å­˜åœ¨çš„ä¸è¶³ã€‚</p>
]]></content>
      <categories>
        <category>å­¦ä¹ å¿ƒå¾—</category>
      </categories>
  </entry>
  <entry>
    <title>IOæ¨¡å‹ç®€ä»‹</title>
    <url>/2022/07/25/IO%E6%A8%A1%E5%9E%8B%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<p>å¤§è‡´æœ‰ä¸‹é¢äº”ç§IOæ¨¡å‹ï¼š</p>
<p>é˜»å¡IOæ¨¡å‹ï¼Œéé˜»å¡IOæ¨¡å‹ï¼ŒIOå¤ç”¨æ¨¡å‹ï¼Œä¿¡å·é©±åŠ¨IOæ¨¡å‹ï¼Œå¼‚æ­¥IOæ¨¡å‹ã€‚</p>
<h2 id="é˜»å¡IOæ¨¡å‹"><a href="#é˜»å¡IOæ¨¡å‹" class="headerlink" title="é˜»å¡IOæ¨¡å‹"></a>é˜»å¡IOæ¨¡å‹</h2><p>è¯»æ•°æ®ï¼Œå‘ç°æ²¡æœ‰æ•°æ®ï¼Œçº¿ç¨‹å°±ä¸€ç›´ç­‰å¾…ç›´åˆ°æœ‰æ•°æ®è¯»å–ã€‚</p>
<h2 id="éé˜»å¡IOæ¨¡å‹"><a href="#éé˜»å¡IOæ¨¡å‹" class="headerlink" title="éé˜»å¡IOæ¨¡å‹"></a>éé˜»å¡IOæ¨¡å‹</h2><p>è¯»æ•°æ®ï¼Œå‘ç°æ²¡æœ‰æ•°æ®ï¼Œçº¿ç¨‹ä¸ç­‰å¾…ç›´æ¥è¿”å›è¯»é”™è¯¯ç ã€‚ç”±äºä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™ä¼šæœ‰æ•°æ®æ‰€ä»¥è¿™ç§éé˜»å¡IOæ¨¡å‹éœ€è¦è°ƒç”¨æ–¹ä¸æ–­æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®ã€‚</p>
<p>fdé»˜è®¤æ˜¯é˜»å¡IOè®¿é—®ï¼Œå¯ä»¥ä½¿ç”¨fcntlå‡½æ•°è®¾ç½®ä¸ºéé˜»å¡IO:</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">status</span> = fcntl(socketFD, F_SETFL, O_NONBLOCK)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<h2 id="IOå¤ç”¨æ¨¡å‹"><a href="#IOå¤ç”¨æ¨¡å‹" class="headerlink" title="IOå¤ç”¨æ¨¡å‹"></a>IOå¤ç”¨æ¨¡å‹</h2><p>å¯¹éé˜»å¡IOæ¨¡å‹çš„ä¸€ç§æ”¹è¿›ï¼Œå› ä¸ºéé˜»å¡IOæ¨¡å‹éœ€è¦ä¸æ–­æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®å¯è¯»ã€‚å‡å¦‚æœ‰100ä¸ªfdè¦è¯»ï¼Œé‚£ä¹ˆå°±éœ€è¦100ä¸ªçº¿ç¨‹å„è‡ªåœ¨ä¸æ–­çš„æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®å¯è¯»ï¼Œè¿™æ˜¾ç„¶æµªè´¹äº†å¤§é‡çš„CPUå’Œå†…å­˜ã€‚</p>
<p>äº‹å®ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€æ¡çº¿ç¨‹å»è½®è¯¢fdé›†åˆï¼Œå½“æŸä¸ªfdæœ‰æ•°æ®å¯è¯»æ—¶å°±è¿”å›è¯¥fdå¹¶é€šçŸ¥åº”ç”¨ç¨‹åºè¯»ã€‚ç³»ç»Ÿå†…æ ¸æä¾›äº†selectå†…æ ¸å‡½æ•°ï¼Œselectå‡½æ•°ä¼šå¸®æˆ‘ä»¬åšä¸Šè¿°äº‹æƒ…ï¼Œå½“çº¿ç¨‹è°ƒç”¨selectå‡½æ•°åä¼šé˜»å¡åœ¨selectå‡½æ•°ï¼Œå½“æœ‰æ•°æ®å¯è¯»æ—¶selectå‡½æ•°ä¼šè¿”å›è¯¥fdï¼Œäºæ˜¯æˆ‘ä»¬å†å¼€çº¿ç¨‹è¯»å–æ•°æ®ã€‚</p>
<h2 id="ä¿¡å·é©±åŠ¨IOæ¨¡å‹"><a href="#ä¿¡å·é©±åŠ¨IOæ¨¡å‹" class="headerlink" title="ä¿¡å·é©±åŠ¨IOæ¨¡å‹"></a>ä¿¡å·é©±åŠ¨IOæ¨¡å‹</h2><p>ä¿¡å·é©±åŠ¨IOæ¨¡å‹æ˜¯å¯¹ä¸Šè¿°æ¨¡å‹ä¸­è½®è¯¢ç­–ç•¥çš„ä¸€ç§æ”¹è¿›ï¼Œå› ä¸ºè½®è¯¢çš„æ•ˆç‡æ˜¯å¾ˆä½çš„ï¼Œç»å¤§å¤šæ•°æ—¶å€™æ˜¯æ²¡æœ‰æ•°æ®å¯è¯»çš„ï¼Œå› æ­¤è½®è¯¢åšäº†å¤§é‡æ— ç”¨åŠŸã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥å‘ç³»ç»Ÿå†…æ ¸æ³¨å†Œä¸€ä¸ªä¿¡å·ï¼Œç³»ç»Ÿå†…æ ¸å‘ç°æœ‰æ•°æ®å¯è¯»æ—¶å†å‘é€è¯¥ä¿¡å·é€šçŸ¥æˆ‘ä»¬ï¼Œäºæ˜¯æˆ‘ä»¬æ‰å»è¯»æ•°æ®ã€‚</p>
<h2 id="å¼‚æ­¥IOæ¨¡å‹"><a href="#å¼‚æ­¥IOæ¨¡å‹" class="headerlink" title="å¼‚æ­¥IOæ¨¡å‹"></a>å¼‚æ­¥IOæ¨¡å‹</h2><p>å¼‚æ­¥IOæ¨¡å‹æ˜¯å¯¹ä¿¡å·é©±åŠ¨IOæ¨¡å‹è¿›ä¸€æ­¥æ”¹è¿›ã€‚å› ä¸ºä¿¡å·é©±åŠ¨IOæ¨¡å‹åªæ˜¯å‘Šè¯‰äº†æˆ‘ä»¬è¯»æ•°æ®çš„æ—¶æœºï¼Œæˆ‘ä»¬è¿˜æ˜¯éœ€è¦è°ƒç”¨recvfromå‡½æ•°å»è¯»æŠŠæ•°æ®ä»å†…æ ¸ç©ºé—´å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ã€‚</p>
<p>äº‹å®ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä¿¡å·é©±åŠ¨IOæ¨¡å‹çš„ä¸¤æ­¥å¹¶åšä¸€æ­¥ï¼Œå‘ç³»ç»Ÿå†…æ ¸å‘èµ·ä¸€ä¸ªreadè¯·æ±‚ï¼Œéšå³è¿”å›ã€‚ç³»ç»Ÿå†…æ ¸æ¥æ”¶è¯·æ±‚ï¼Œå½“å‘ç°æœ‰æ•°æ®å¯è¯»æ—¶ç›´æ¥å¸®æˆ‘ä»¬æŠŠæ•°æ®ä»å†…æ ¸ç©ºé—´å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´å¹¶é€šçŸ¥åº”ç”¨ã€‚</p>
<p>è¿™å‡ ç§æ¨¡å‹ä½“ç°äº†æŠ€æœ¯çš„ä¸æ–­å‘å±•ï¼Œä½“ç°äº†äººä»¬å¯¹æ€§èƒ½çš„ä¸æ–­è¿½æ±‚ã€‚æŠ€æœ¯ä¸æ˜¯ä¸€è¹´è€Œå°±çš„è€Œæ˜¯ä»ä¸€ä¸ªç²—ç³™çš„ä¸œè¥¿ä¸æ–­è¿­ä»£æœ€ç»ˆæ‰å˜æˆä¸€ä¸ªç²¾ç»†çš„ä¸œè¥¿çš„ã€‚æ‰€ä»¥å®Œç¾çš„äº‹ç‰©æ˜¯ä¸å­˜åœ¨çš„ï¼Œä½ ä¸å¿…å®Œç¾ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://zhuanlan.zhihu.com/p/115912936">100%å¼„æ˜ç™½5ç§IOæ¨¡å‹</a>  </p>
<p><a href="https://blog.csdn.net/hguisu/article/details/7453390">socketé˜»å¡ä¸éé˜»å¡ï¼ŒåŒæ­¥ä¸å¼‚æ­¥ã€I/Oæ¨¡å‹</a>  ä¸»è¦çœ‹é‚£å‡ å¹…å›¾ã€‚</p>
<p><a href="https://www.itzhai.com/articles/necessary-knowledge-of-network-programming-graphic-socket-core-insider-and-five-io-models.html">ç½‘ç»œç¼–ç¨‹å¿…å¤‡çŸ¥è¯†ï¼šå›¾è§£Socketæ ¸å¿ƒå†…å¹•ä»¥åŠäº”å¤§IOæ¨¡å‹ | é˜»å¡IO,éé˜»å¡IO,IOå¤ç”¨,ä¿¡å·é©±åŠ¨å¼IO,å¼‚æ­¥IO</a>   æ„Ÿè§‰å¾ˆåŠçš„æ ·å­</p>
]]></content>
      <categories>
        <category>è®¡ç®—æœºåŸºç¡€</category>
      </categories>
      <tags>
        <tag>I/Oæ¨¡å‹</tag>
      </tags>
  </entry>
  <entry>
    <title>ifconfig</title>
    <url>/2022/07/20/ifconfig/</url>
    <content><![CDATA[<p>ifconfig</p>
<p>å…¨ç§°ï¼šinterfaces config,ä¸»è¦ç”¨äºè®¾ç½®æˆ–æ˜¾ç¤ºç½‘ç»œè®¾å¤‡ä¿¡æ¯çš„ã€‚</p>
<p>æ‰“å°ï¼š</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">lo0</span>: flags=<span class="number">8049</span>&lt;UP,LOOPBACK,RUNNING,MULTICAST&gt; mtu <span class="number">16384</span></span><br><span class="line">	<span class="attribute">options</span>=<span class="number">1203</span>&lt;RXCSUM,TXCSUM,TXSTATUS,SW_TIMESTAMP&gt;</span><br><span class="line">	<span class="attribute">inet</span> <span class="number">127.0.0.1</span> netmask <span class="number">0</span>xff000000</span><br><span class="line">	<span class="attribute">inet6</span> ::<span class="number">1</span> prefixlen <span class="number">128</span></span><br><span class="line">	<span class="attribute">inet6</span> fe80::<span class="number">1</span>%lo0 prefixlen <span class="number">64</span> scopeid <span class="number">0</span>x1</span><br><span class="line">	<span class="attribute">nd6</span> options=<span class="number">201</span>&lt;PERFORMNUD,DAD&gt;</span><br><span class="line"><span class="attribute">gif0</span>: flags=<span class="number">8010</span>&lt;POINTOPOINT,MULTICAST&gt; mtu <span class="number">1280</span></span><br><span class="line"><span class="attribute">stf0</span>: flags=<span class="number">0</span>&lt;&gt; mtu <span class="number">1280</span></span><br><span class="line"><span class="attribute">en0</span>: flags=<span class="number">8863</span>&lt;UP,BROADCAST,SMART,RUNNING,SIMPLEX,MULTICAST&gt; mtu <span class="number">1500</span></span><br><span class="line">	<span class="attribute">options</span>=<span class="number">50</span>b&lt;RXCSUM,TXCSUM,VLAN_HWTAGGING,AV,CHANNEL_IO&gt;</span><br><span class="line">	<span class="attribute">ether</span> b0:e5:f9:f3:a8:de   //macåœ°å€</span><br><span class="line">	<span class="attribute">inet6</span> fe80::<span class="number">1</span>c2c:<span class="number">2</span>b1d:<span class="number">6</span>af8:<span class="number">3558</span>%en0 prefixlen <span class="number">64</span> secured scopeid <span class="number">0</span>x6  //ipv6åœ°å€</span><br><span class="line">	<span class="attribute">inet</span> <span class="number">10.1.63.198</span> netmask <span class="number">0</span>xffffff00 broadcast <span class="number">10.1.63.255</span> //ipv4åœ°å€ã€å­ç½‘æ©ç ã€å¹¿æ’­åœ°å€</span><br><span class="line">	<span class="attribute">nd6</span> options=<span class="number">201</span>&lt;PERFORMNUD,DAD&gt;</span><br><span class="line">	<span class="attribute">media</span>: autoselect (<span class="number">1000</span>baseT &lt;full-duplex&gt;)</span><br><span class="line">	<span class="attribute">status</span>: active</span><br></pre></td></tr></table></figure>
<p>ifconfigæ‰“å°çš„æ˜¯æ‰€æœ‰ç½‘ç»œè®¾å¤‡çš„ä¿¡æ¯ï¼Œå¹¶ä¸”åç§°æ˜¯ä¸“æœ‰åè¯æ¯”å¦‚en0ï¼Œä¸€èˆ¬æ¥è¯´å¦‚æœç”µè„‘åªè¿äº†WIFIé‚£ä¹ˆen0ä»£è¡¨çš„å°±æ˜¯WIFIç½‘å¡ä¿¡æ¯ï¼Œå¦‚æœè¿˜æ’äº†ç½‘çº¿é‚£ä¹ˆen0ä»£è¡¨çš„å°±æ˜¯ä»¥å¤ªç½‘ç½‘å¡ä¿¡æ¯ï¼Œen1ä»£è¡¨çš„æ‰æ˜¯WIFIç½‘å¡ä¿¡æ¯ã€‚å¯ä»¥é…åˆ<code>networksetup -listallhardwareports</code> æŸ¥çœ‹ã€‚</p>
<p>networksetup -listallhardwareports</p>
<p>æ‰“å°ï¼š</p>
<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">Hardware <span class="params">Port:</span> Ethernet</span><br><span class="line"><span class="params">Device:</span> en0</span><br><span class="line">Ethernet <span class="params">Address:</span> b0:e5:f9:f3:a8:de</span><br><span class="line"></span><br><span class="line">Hardware <span class="params">Port:</span> USB <span class="number">10</span><span class="symbol">/100/1000</span> LAN</span><br><span class="line"><span class="params">Device:</span> en4</span><br><span class="line">Ethernet <span class="params">Address:</span> <span class="number">00</span>:e0:<span class="number">4</span>c:<span class="number">89</span>:fe:<span class="number">55</span></span><br><span class="line"></span><br><span class="line">Hardware <span class="params">Port:</span> Ethernet Adapter (en5)</span><br><span class="line"><span class="params">Device:</span> en5</span><br><span class="line">Ethernet <span class="params">Address:</span> <span class="number">16</span>:<span class="number">6</span>a:<span class="number">42</span>:<span class="number">01</span>:<span class="number">62</span>:<span class="number">87</span></span><br><span class="line"></span><br><span class="line">Hardware <span class="params">Port:</span> Ethernet Adapter (en6)</span><br><span class="line"><span class="params">Device:</span> en6</span><br><span class="line">Ethernet <span class="params">Address:</span> <span class="number">16</span>:<span class="number">6</span>a:<span class="number">42</span>:<span class="number">01</span>:<span class="number">62</span>:<span class="number">88</span></span><br><span class="line"></span><br><span class="line">Hardware <span class="params">Port:</span> Wi-Fi</span><br><span class="line"><span class="params">Device:</span> en1</span><br><span class="line">Ethernet <span class="params">Address:</span> b0:e5:f9:f2:<span class="number">56</span>:<span class="number">75</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>networksetup -listallnetworkservices</p>
<p>æ‰“å°ï¼š</p>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">An asterisk</span> <span class="comment">(*) denotes that a network service is disabled.</span></span><br><span class="line"><span class="comment">Wi-Fi</span></span><br><span class="line"><span class="comment">Ethernet</span></span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://ss64.com/osx/ifconfig.html">ifconfig manæ‰‹å†Œ</a></p>
<p><a href="https://www.runoob.com/linux/linux-comm-ifconfig.html">Linux ifconfigå‘½ä»¤</a></p>
]]></content>
      <categories>
        <category>å‘½ä»¤è¡Œ</category>
      </categories>
      <tags>
        <tag>ifconfig</tag>
      </tags>
  </entry>
  <entry>
    <title>runloopä½¿ç”¨</title>
    <url>/2022/07/15/runloop%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>runloopå¯åŠ¨å‰å¿…é¡»å…ˆæ·»åŠ è¾“å…¥æºæˆ–å®šæ—¶å™¨æºï¼Œå¦åˆ™runloopä¸€å¯åŠ¨å°±ä¼šé€€å‡ºã€‚æ€»ä¹‹runloopéœ€è¦æœ‰ç›‘å¬çš„äº‹ä»¶ï¼Œå¦åˆ™å°±ä¼šé€€å‡ºã€‚</p>
<h2 id="å¯åŠ¨runloop"><a href="#å¯åŠ¨runloop" class="headerlink" title="å¯åŠ¨runloop"></a>å¯åŠ¨runloop</h2><p>NSRunLoopæä¾›äº†å¦‚ä¸‹3ç§å¯åŠ¨runloopçš„æ–¹æ³•ã€‚å½“ç„¶NSRunLoopå…¶å®å°è£…çš„æ˜¯CFRunloopã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)run <span class="built_in">NS_SWIFT_UNAVAILABLE_FROM_ASYNC</span>(<span class="string">&quot;run cannot be used from async contexts.&quot;</span>);</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)runUntilDate:(<span class="built_in">NSDate</span> *)limitDate <span class="built_in">NS_SWIFT_UNAVAILABLE_FROM_ASYNC</span>(<span class="string">&quot;run(until:) cannot be used from async contexts.&quot;</span>);</span><br><span class="line"></span><br><span class="line">- (<span class="type">BOOL</span>)runMode:(<span class="built_in">NSRunLoopMode</span>)mode beforeDate:(<span class="built_in">NSDate</span> *)limitDate <span class="built_in">NS_SWIFT_UNAVAILABLE_FROM_ASYNC</span>(<span class="string">&quot;run(_:before:) cannot be used from async contexts.&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>ç›¸åŒç‚¹ï¼šå¦‚æœæ²¡æœ‰è¾“å…¥æºæˆ–å®šæ—¶å™¨æºé™„åŠ åˆ°runloopä¸Šï¼Œrunloopä¼šé©¬ä¸Šé€€å‡ºï¼Œå¹¶ä¸”æ–¹æ³•ä¹Ÿä¼šç«‹å³é€€å‡ºã€‚</p>
<p>run<br>å®ƒä¼šè®©runloopç½®èº«åœ¨ä¸€ä¸ªæ°¸ä¹…çš„å¾ªç¯å½“ä¸­.å³ä½¿runloopå› ä¸ºå¤„ç†å®Œäº†æŸä¸ªè¾“å…¥æºäº‹ä»¶è€Œé€€å‡º,è¯¥æ–¹æ³•åˆä¼šè®©å®ƒé‡æ–°è¿è¡Œ.å› æ­¤å¦‚æœä½ æƒ³å¤„ç†å®ŒæŸä¸ªäº‹ä»¶åèƒ½å¤Ÿé€€å‡ºrunloop,é‚£ä¹ˆä½ å°±ä¸èƒ½ä½¿ç”¨è¯¥æ–¹æ³•äº†ã€‚runloopè¿è¡Œåœ¨defaultæ¨¡å¼ã€‚</p>
<p>runUntilDateï¼š<br>å’Œrunæ–¹æ³•å·®ä¸å¤šåªæ˜¯å¤šäº†ä¸ªæˆªæ­¢æ—¶é—´ï¼Œæˆªæ­¢æ—¶é—´åˆ°äº†runloopå°±ä¼šé€€å‡ºã€‚runloopåŒæ ·è¿è¡Œåœ¨defaultæ¨¡å¼ã€‚</p>
<p>runMode:beforeDate:<br>å¯ä»¥æŒ‡å®šrunloopè¿è¡Œçš„æ¨¡å¼ä»¥åŠä¸€ä¸ªæˆªæ­¢æ—¶é—´ã€‚å¤„ç†å®šæ—¶å™¨æºäº‹ä»¶åä¸ä¼šé€€å‡ºrunloopï¼Œä½†å¤„ç†è¾“å…¥æºäº‹ä»¶åä¼šé€€å‡ºrunloopï¼Œå› æ­¤éœ€è¦å¤–éƒ¨é‡æ–°é©±åŠ¨è¿›å…¥runloopã€‚</p>
<h2 id="é€€å‡ºrunloop"><a href="#é€€å‡ºrunloop" class="headerlink" title="é€€å‡ºrunloop"></a>é€€å‡ºrunloop</h2><p>æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œæ‰‹åŠ¨ç§»é™¤è¾“å…¥æºæˆ–å®šæ—¶å™¨æºä¸èƒ½ç¡®ä¿runloopä¼šé€€å‡ºã€‚æœ€å¥½çš„åŠæ³•æ˜¯ä½¿ç”¨runMode:beforeDate:æ–¹æ³•å¯åŠ¨runloopï¼Œè®¾ç«‹æ ‡å¿—ä½ï¼Œç»™å­çº¿ç¨‹å‘é€æ¶ˆæ¯perform selectorã€‚</p>
<h2 id="runloopä½¿ç”¨åœºæ™¯"><a href="#runloopä½¿ç”¨åœºæ™¯" class="headerlink" title="runloopä½¿ç”¨åœºæ™¯"></a>runloopä½¿ç”¨åœºæ™¯</h2><p>ç”±äºä¸»çº¿ç¨‹çš„runloopé»˜è®¤æ˜¯å¼€å¯çš„ï¼Œæ‰€ä»¥ä¸€èˆ¬æ˜¯å­çº¿ç¨‹åº”ç”¨runloopã€‚</p>
<ol>
<li>åœ¨å­çº¿ç¨‹ä¸Šä½¿ç”¨å®šæ—¶å™¨</li>
<li>å…¶ä»–çº¿ç¨‹éœ€è¦ä¸è¯¥å­çº¿ç¨‹é€šä¿¡ï¼Œæ¯”å¦‚perform selectoræˆ–å…¶ä»–sourceã€‚</li>
</ol>
<h2 id="CocoaAsyncSocket"><a href="#CocoaAsyncSocket" class="headerlink" title="CocoaAsyncSocket"></a>CocoaAsyncSocket</h2><h3 id="åˆ›å»ºçº¿ç¨‹"><a href="#åˆ›å»ºçº¿ç¨‹" class="headerlink" title="åˆ›å»ºçº¿ç¨‹"></a>åˆ›å»ºçº¿ç¨‹</h3><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> TARGET_OS_IPHONE</span></span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">NSThread</span> *cfstreamThread;  <span class="comment">// Used for CFStreams</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> uint64_t cfstreamThreadRetainCount;   <span class="comment">// setup &amp; teardown</span></span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">dispatch_queue_t</span> cfstreamThreadSetupQueue; <span class="comment">// setup &amp; teardown</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="type">void</span>)startCFStreamThreadIfNeeded</span><br><span class="line">&#123;</span><br><span class="line">	LogTrace();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> predicate;</span><br><span class="line">	<span class="built_in">dispatch_once</span>(&amp;predicate, ^&#123;</span><br><span class="line">		</span><br><span class="line">		cfstreamThreadRetainCount = <span class="number">0</span>;</span><br><span class="line">		cfstreamThreadSetupQueue = dispatch_queue_create(<span class="string">&quot;GCDAsyncSocket-CFStreamThreadSetup&quot;</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">	&#125;);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">dispatch_sync</span>(cfstreamThreadSetupQueue, ^&#123; <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (++cfstreamThreadRetainCount == <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			cfstreamThread = [[<span class="built_in">NSThread</span> alloc] initWithTarget:<span class="keyword">self</span></span><br><span class="line">			                                         selector:<span class="keyword">@selector</span>(cfstreamThread:)</span><br><span class="line">			                                           object:<span class="literal">nil</span>];</span><br><span class="line">			[cfstreamThread start];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="çº¿ç¨‹ä¿æ´»â€”runloop"><a href="#çº¿ç¨‹ä¿æ´»â€”runloop" class="headerlink" title="çº¿ç¨‹ä¿æ´»â€”runloop"></a>çº¿ç¨‹ä¿æ´»â€”runloop</h3><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="type">void</span>)cfstreamThread:(<span class="type">id</span>)unused &#123; <span class="keyword">@autoreleasepool</span></span><br><span class="line">&#123;</span><br><span class="line">	[[<span class="built_in">NSThread</span> currentThread] setName:GCDAsyncSocketThreadName];</span><br><span class="line">	</span><br><span class="line">	LogInfo(<span class="string">@&quot;CFStreamThread: Started&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// We can&#x27;t run the run loop unless it has an associated input source or a timer.</span></span><br><span class="line">	<span class="comment">// So we&#x27;ll just create a timer that will never fire - unless the server runs for decades.</span></span><br><span class="line">	[<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:[[<span class="built_in">NSDate</span> distantFuture] timeIntervalSinceNow]</span><br><span class="line">	                                 target:<span class="keyword">self</span></span><br><span class="line">	                               selector:<span class="keyword">@selector</span>(ignore:)</span><br><span class="line">	                               userInfo:<span class="literal">nil</span></span><br><span class="line">	                                repeats:<span class="literal">YES</span>];</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">NSThread</span> *currentThread = [<span class="built_in">NSThread</span> currentThread];</span><br><span class="line">	<span class="built_in">NSRunLoop</span> *currentRunLoop = [<span class="built_in">NSRunLoop</span> currentRunLoop];</span><br><span class="line">	</span><br><span class="line">	<span class="type">BOOL</span> isCancelled = [currentThread isCancelled];</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span> (!isCancelled &amp;&amp; [currentRunLoop runMode:<span class="built_in">NSDefaultRunLoopMode</span> beforeDate:[<span class="built_in">NSDate</span> distantFuture]])</span><br><span class="line">	&#123;</span><br><span class="line">		isCancelled = [currentThread isCancelled];</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	LogInfo(<span class="string">@&quot;CFStreamThread: Stopped&quot;</span>);</span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>å°†ä¸€ä¸ªå¯é‡å¤çš„ã€é—´éš”æ—¶é—´ä¸ºæ°¸è¿œçš„ï¼ˆä¹Ÿå°±æ˜¯æ°¸è¿œä¸ä¼šè§¦å‘çš„å®šæ—¶å™¨ï¼‰å®šæ—¶å™¨æ·»åŠ åˆ°runloop,è¿™æ ·å°±ç¡®ä¿äº†runloopä¸è‡³äºä¸€å¯åŠ¨å°±é€€å‡ºã€‚</p>
<p>è°ƒç”¨<code>- (BOOL)runMode:(NSRunLoopMode)mode beforeDate:(NSDate *)limitDate;</code> æ¥å¯åŠ¨runloop,è¿™æ ·runloopåœ¨å¤„ç†è¾“å…¥æºåå°±ä¼šé€€å‡ºã€‚</p>
<p>whileå¾ªç¯åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«å–æ¶ˆï¼Œå¦‚æœä¸æ˜¯è¢«å–æ¶ˆåˆ™é‡æ–°å¯åŠ¨runloopã€‚</p>
<h3 id="ç»“æŸçº¿ç¨‹"><a href="#ç»“æŸçº¿ç¨‹" class="headerlink" title="ç»“æŸçº¿ç¨‹"></a>ç»“æŸçº¿ç¨‹</h3><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="type">void</span>)stopCFStreamThreadIfNeeded</span><br><span class="line">&#123;</span><br><span class="line">	LogTrace();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// The creation of the cfstreamThread is relatively expensive.</span></span><br><span class="line">	<span class="comment">// So we&#x27;d like to keep it available for recycling.</span></span><br><span class="line">	<span class="comment">// However, there&#x27;s a tradeoff here, because it shouldn&#x27;t remain alive forever.</span></span><br><span class="line">	<span class="comment">// So what we&#x27;re going to do is use a little delay before taking it down.</span></span><br><span class="line">	<span class="comment">// This way it can be reused properly in situations where multiple sockets are continually in flux.</span></span><br><span class="line">	</span><br><span class="line">	<span class="type">int</span> delayInSeconds = <span class="number">30</span>;</span><br><span class="line">	dispatch_time_t when = dispatch_time(DISPATCH_TIME_NOW, (int64_t)(delayInSeconds * <span class="built_in">NSEC_PER_SEC</span>));</span><br><span class="line">	dispatch_after(when, cfstreamThreadSetupQueue, ^&#123; <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> clang diagnostic push</span></span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> clang diagnostic <span class="keyword">warning</span> <span class="string">&quot;-Wimplicit-retain-self&quot;</span></span></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (cfstreamThreadRetainCount == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			LogWarn(<span class="string">@&quot;Logic error concerning cfstreamThread start / stop&quot;</span>);</span><br><span class="line">			return_from_block;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (--cfstreamThreadRetainCount == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			[cfstreamThread cancel]; <span class="comment">// set isCancelled flag</span></span><br><span class="line">			</span><br><span class="line">			<span class="comment">// wake up the thread</span></span><br><span class="line">            [[<span class="keyword">self</span> <span class="keyword">class</span>] performSelector:<span class="keyword">@selector</span>(ignore:)</span><br><span class="line">                                 onThread:cfstreamThread</span><br><span class="line">                               withObject:[<span class="built_in">NSNull</span> null]</span><br><span class="line">                            waitUntilDone:<span class="literal">NO</span>];</span><br><span class="line">            </span><br><span class="line">			cfstreamThread = <span class="literal">nil</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> clang diagnostic pop</span></span><br><span class="line">	&#125;&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»“æŸçº¿ç¨‹è¿™é‡Œè°ƒçš„æ˜¯cancelæ–¹æ³•ï¼Œç”±äºçº¿ç¨‹è¿˜å¯åŠ¨äº†runloopï¼Œæ‰€ä»¥åœ¨å­çº¿ç¨‹ä¸Šè°ƒç”¨performSelectorï¼Œå”¤é†’çº¿ç¨‹ï¼Œrunloopå¤„ç†åä¼šé€€å‡ºï¼Œç”±äºå·²ç»cancelï¼Œæ‰€ä»¥whileä¹Ÿä¸ä¼šå†å¯åŠ¨runloopï¼Œäºæ˜¯çº¿ç¨‹æ­£å¸¸ç»“æŸã€‚</p>
<p>çº¿ç¨‹çš„åˆ›å»ºå’Œç»“æŸéƒ½æ˜¯åœ¨ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—é‡Œæ“ä½œçš„ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°å¤šçº¿ç¨‹æ“ä½œçš„æƒ…å†µã€‚</p>
<h2 id="AFNetworking"><a href="#AFNetworking" class="headerlink" title="AFNetworking"></a>AFNetworking</h2><h3 id="åˆ›å»ºçº¿ç¨‹-1"><a href="#åˆ›å»ºçº¿ç¨‹-1" class="headerlink" title="åˆ›å»ºçº¿ç¨‹"></a>åˆ›å»ºçº¿ç¨‹</h3><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="built_in">NSThread</span> *)networkRequestThread &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSThread</span> *_networkRequestThread = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> oncePredicate;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;oncePredicate, ^&#123;</span><br><span class="line">        _networkRequestThread = [[<span class="built_in">NSThread</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(networkRequestThreadEntryPoint:) object:<span class="literal">nil</span>];</span><br><span class="line">        [_networkRequestThread start];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _networkRequestThread;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="çº¿ç¨‹ä¿æ´»â€”runloop-1"><a href="#çº¿ç¨‹ä¿æ´»â€”runloop-1" class="headerlink" title="çº¿ç¨‹ä¿æ´»â€”runloop"></a>çº¿ç¨‹ä¿æ´»â€”runloop</h3><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="type">void</span>)networkRequestThreadEntryPoint:(<span class="type">id</span>)__unused object &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        [[<span class="built_in">NSThread</span> currentThread] setName:<span class="string">@&quot;AFNetworking&quot;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NSRunLoop</span> *runLoop = [<span class="built_in">NSRunLoop</span> currentRunLoop];</span><br><span class="line">        [runLoop addPort:[<span class="built_in">NSMachPort</span> port] forMode:<span class="built_in">NSDefaultRunLoopMode</span>];</span><br><span class="line">        [runLoop run];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ·»åŠ äº†ä¸€ä¸ªåŸºäºç«¯å£çš„è¾“å…¥æºï¼ˆè™½ç„¶å¹¶æ²¡æœ‰çœŸæ­£ä½¿ç”¨åˆ°ï¼‰ï¼Œç¡®ä¿runloopä¸è‡³äºä¸€å¯åŠ¨å°±é€€å‡ºã€‚è°ƒç”¨<code>run</code> æ¥å¯åŠ¨runloopï¼Œè¯¥æ–¹æ³•åœ¨runloopé€€å‡ºåä¼šé‡æ–°å¯åŠ¨runloopç»§ç»­è¿è¡Œã€‚AFNetworkingåˆ›å»ºçš„è¿™ä¸ªçº¿ç¨‹åœ¨æ•´ä¸ªAPPå†…éƒ½ä¸ä¼šé”€æ¯çš„ã€‚äºŒè€…æ— ä¸€ä¾‹å¤–çš„ä½¿ç”¨å…¨å±€å˜é‡æ¥å¼•ç”¨çº¿ç¨‹ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.jianshu.com/p/d8c790bcf10e">CFRunloopçš„å¤šçº¿ç¨‹éšæ‚£</a></p>
]]></content>
      <categories>
        <category>runloop</category>
      </categories>
      <tags>
        <tag>runloop</tag>
      </tags>
  </entry>
  <entry>
    <title>å­—èŠ‚åºè§£æ</title>
    <url>/2022/07/01/%E5%AD%97%E8%8A%82%E5%BA%8F%E8%A7%A3%E6%9E%90/</url>
    <content><![CDATA[<h3 id="å­—èŠ‚åº"><a href="#å­—èŠ‚åº" class="headerlink" title="å­—èŠ‚åº"></a>å­—èŠ‚åº</h3><p>å­—èŠ‚é—´çš„é¡ºåºã€‚ä¸»è¦æœ‰ä¸¤ç§ï¼šå¤§ç«¯åºå’Œå°ç«¯åºã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥è§„å®šå…¶ä»–çš„é¡ºåºï¼Œä½†è¿™ä¸¤ç§é¡ºåºæ˜¯è§„åˆ™æœ€ç®€å•çš„äº†ã€‚</p>
<p>å†…å­˜ï¼š</p>
<figure class="highlight tap"><table><tr><td class="code"><pre><span class="line">å†…å­˜ï¼š   -------------------------------&gt;</span><br><span class="line">å†…å­˜åœ°å€ï¼š0      <span class="number"> 1 </span>     <span class="number"> 2 </span>      3</span><br></pre></td></tr></table></figure>
<p>å¤§ç«¯åºï¼šä»å·¦å¾€å³è¯»ï¼Œæœ€å·¦è¾¹ä¸ºæœ€é«˜ä½ã€‚åæ˜ åœ¨å†…å­˜å³æœ€ä½åœ°å€ä¸ºæœ€é«˜ä½ï¼Œæœ€é«˜åœ°å€ä¸ºæœ€ä½ä½ã€‚<br>å°ç«¯åºï¼šä»å³å¾€å·¦è¯»ï¼Œæœ€å³è¾¹ä¸ºæœ€é«˜ä½ã€‚åæ˜ åœ¨å†…å­˜å³æœ€ä½åœ°å€ä¸ºæœ€ä½ä½ï¼Œæœ€é«˜åœ°å€ä¸ºæœ€é«˜ä½ã€‚<br>å¯ä»¥çœ‹åˆ°ï¼Œå¤§ç«¯åºå’Œå°ç«¯åºæœ€é«˜ä½åˆ°æœ€ä½ä½çš„é¡ºåºåˆšå¥½ç›¸åï¼Œæ˜¯ç¿»è½¬çš„å…³ç³»ã€‚</p>
<p>ä¸ºä»€ä¹ˆä¼šæœ‰å­—èŠ‚åºï¼Ÿ<br>å› ä¸ºä¸€ä¸²æ•°å­—å¯ä»¥ä»å·¦å¼€å§‹è¯»ï¼Œä¹Ÿå¯ä»¥ä»å³å¼€å§‹è¯»ã€‚å¦‚æœä¸è§„å®šè¯»çš„é¡ºåºï¼Œé‚£ä¹ˆå°±æ— æ³•å¾—çŸ¥æ­£ç¡®çš„ä¿¡æ¯ã€‚<br>æ¯”å¦‚ï¼šä¸€å¼ çº¸ä¸Šå†™ç€1234<br>æŒ‰å¤§ç«¯åºè¯»ï¼Œæœ€å·¦è¾¹çš„1å°±æ˜¯æœ€é«˜ä½ï¼Œç»“æœå°±æ˜¯ä¸€åƒä¸¤ç™¾ä¸‰åå››<br>æŒ‰å°ç«¯åºè¯»ï¼Œæœ€å³è¾¹4å°±æ˜¯æœ€é«˜ä½ï¼Œæœ€å·¦è¾¹çš„1åè€Œæ˜¯æœ€ä½ä½ï¼Œç»“æœå°±æ˜¯å››åƒä¸‰ç™¾äºŒåä¸€<br>å¯ä»¥çœ‹åˆ°å¯¹äºåŒä¸€ä¸²æ–‡æœ¬ï¼Œè¯»çš„é¡ºåºä¸åŒï¼Œå¾—åˆ°çš„ç»“æœä¹Ÿä¼šä¸åŒã€‚å¤§éƒ¨åˆ†å›½å®¶éƒ½æ˜¯ä»å·¦åˆ°å³è¯»ï¼Œä½†ä¹Ÿæœ‰çš„å›½å®¶æ˜¯ä»å³åˆ°å·¦è¯»çš„ã€‚æ²¡æœ‰å¥½åï¼Œçº¯å±ä¹ æƒ¯é—®é¢˜ã€‚å› æ­¤æ•°å­—â€œä¸€åƒä¸¤ç™¾ä¸‰åå››â€ï¼Œå¯¹äºä»å·¦åˆ°å³è¯»çš„å›½å®¶ï¼Œä¹¦å†™å‡ºæ¥å°±æ˜¯1234ã€‚è€Œå¯¹äºä»å³åˆ°å·¦è¯»çš„å›½å®¶ï¼Œä¹¦å†™å‡ºæ¥å°±æ˜¯4321ã€‚å¤§å°ç«¯åªæ˜¯è®°æ³•ä¸åŒï¼Œè¡¨è¾¾çš„æ•°å­—è¿˜æ˜¯åŒä¸€ä¸ªã€‚</p>
<p>CPUè¯»å–å†…å­˜ä¸­çš„æ•°æ®æ—¶ï¼Œæ˜¯ä»ä½åœ°å€å‘é«˜åœ°å€æ–¹å‘è¿›è¡Œè¯»å–çš„ã€‚æ‰€ä»¥ä¸€èˆ¬è®¡ç®—æœºçš„å†…éƒ¨å¤„ç†éƒ½æ˜¯å°ç«¯å­—èŠ‚åºï¼ˆç›®å‰ä¸ºæ­¢æˆ‘å°±è¿˜æ²¡é‡åˆ°è¿‡é‡‡ç”¨å¤§ç«¯å­˜å‚¨çš„æœºå™¨ï¼‰ã€‚ä½†æ˜¯ï¼Œäººç±»è¿˜æ˜¯ä¹ æƒ¯è¯»å†™å¤§ç«¯å­—èŠ‚åºã€‚æ‰€ä»¥ï¼Œé™¤äº†è®¡ç®—æœºçš„å†…éƒ¨å¤„ç†ï¼Œå…¶ä»–çš„åœºåˆæ¯”å¦‚ç½‘ç»œä¼ è¾“å’Œæ–‡ä»¶å‚¨å­˜ï¼Œå‡ ä¹éƒ½æ˜¯ç”¨çš„å¤§ç«¯å­—èŠ‚åºã€‚</p>
<p>ä¸¾ä¾‹ï¼š</p>
<p>0x1234<br>0001 0010 0011 0100 ï¼ˆé‡‡ç”¨å¤§ç«¯åºå­˜å‚¨ï¼‰-&gt; 0010 1100 0100 1000ï¼ˆé‡‡ç”¨å°ç«¯åºå­˜å‚¨ï¼Œæ ¹æ®å¤§ç«¯ç¿»è½¬å³å¯ï¼‰<br>1234                                                            -&gt;  3412ï¼ˆç¬¬ä¸€ä¸ªå­—èŠ‚ä»£è¡¨çš„å°±æ˜¯0x34ï¼Œå°ç«¯ä»å³å¾€å·¦è¯»ï¼‰</p>
<p>0x01<br>0000 0000 0000 0000 0000 0000 0000 0001ï¼ˆå¤§ç«¯åºï¼‰<br>-&gt;<br>1000 0000 0000 0000 0000 0000 0000 0000ï¼ˆå°ç«¯åºï¼‰</p>
<h4 id="åˆ¤æ–­å½“å‰æœºå™¨çš„ç«¯åº"><a href="#åˆ¤æ–­å½“å‰æœºå™¨çš„ç«¯åº" class="headerlink" title="åˆ¤æ–­å½“å‰æœºå™¨çš„ç«¯åº"></a>åˆ¤æ–­å½“å‰æœºå™¨çš„ç«¯åº</h4><p>å¯ä»¥é‡‡ç”¨ä»¥ä¸‹ä»£ç åˆ¤æ–­ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>  a;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> b;</span><br><span class="line">&#125;c;</span><br><span class="line">c.a = <span class="number">1</span>;</span><br><span class="line"><span class="type">bool</span> isLittleEndian = <span class="number">1</span> == c.b;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯å°ç«¯åºé‚£ä¹ˆæœ€ä½ä½1åœ¨æœ€ä½åœ°å€ï¼Œcharå ä¸€ä¸ªå­—èŠ‚ï¼Œc.bå°±ç­‰äº1ã€‚<br>å¦‚æœæ˜¯å¤§ç«¯åºé‚£ä¹ˆæœ€ä½ä½1åœ¨æœ€é«˜åœ°å€ï¼Œcharå ä¸€ä¸ªå­—èŠ‚ï¼Œc.bå°±ç­‰äº0ã€‚</p>
<p>è™½ç„¶å¤§éƒ¨åˆ†è®¡ç®—æœºçš„å†…éƒ¨å¤„ç†éƒ½æ˜¯é‡‡ç”¨å°ç«¯å­—èŠ‚åºï¼Œä½†è¿˜æ˜¯æœ‰ä¸€äº›è®¡ç®—æœºé‡‡ç”¨çš„æ˜¯å¤§ç«¯å­—èŠ‚åºã€‚é‚£ä¹ˆè¿™ä¸¤å°è®¡ç®—æœºé€šä¿¡æ—¶è¯¥å¦‚ä½•ç¡®ä¿æ­£ç¡®æ€§å‘¢ï¼Ÿ<br>å¾ˆç®€å•ï¼Œå¯ä»¥è§„å®šç½‘ç»œä¼ è¾“æ—¶å¿…é¡»é‡‡ç”¨å¤§ç«¯å­—èŠ‚åºä¼ è¾“å³å…ˆä¼ è¾“æœ€é«˜å­—èŠ‚ä¾æ­¤ç±»æ¨ç›´åˆ°æœ€ä½å­—èŠ‚ï¼Œä¸¤ç«¯æ”¶åˆ°åå„è‡ªè‡ªè¡Œè½¬æ¢å³å¯ã€‚è¿™æ ·å°±ä¸å¿…å¢åŠ åè®®ä¼ é€’å­—èŠ‚åºä¿¡æ¯äº†ã€‚</p>
<figure class="highlight clean"><table><tr><td class="code"><pre><span class="line">htonç«¯è½¬æ¢å™¨  &lt;--&gt;  ç½‘ç»œä¼ è¾“ &lt;--&gt; ntohç«¯è½¬æ¢å™¨</span><br><span class="line">   |ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€|</span><br><span class="line"> Aç”µè„‘ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€Bç”µè„‘</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ç«¯è½¬æ¢å™¨ï¼Œä»¥åŠè§„å®šç½‘ç»œä¼ è¾“æ—¶å¿…é¡»é‡‡ç”¨å¤§ç«¯å­—èŠ‚åºï¼Œå°±å¯ä»¥å±è”½ç”µè„‘çš„å…·ä½“å­—èŠ‚åºäº†ã€‚æ‰€ä»¥å¦‚æœä½ è¦å‘é€ä¸€ä¸ªæ•°å­—ç»™å¯¹æ–¹ï¼Œä½ è¦å…ˆç”¨ç«¯è½¬æ¢å™¨å°†hostç«¯è½¬ä¸ºå¤§ç«¯ï¼Œå¦ä¸€ç«¯æ”¶åˆ°åå†å°†å¤§ç«¯è½¬æ¢ä¸ºhostç«¯ï¼Œè¿™æ ·ä½ ä»¬ä¸¤ä¸ªç†è§£çš„æ‰æ˜¯åŒä¸€ä¸ªæ•°å­—ã€‚æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> test_bit_data1(<span class="type">void</span>) &#123;</span><br><span class="line">    <span class="type">short</span> a = <span class="number">0x5678</span>;</span><br><span class="line">    <span class="built_in">NSData</span> *dataA = [[<span class="built_in">NSData</span> alloc] initWithBytes:&amp;a length:<span class="keyword">sizeof</span>(<span class="type">short</span>)];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;a = %d, hex:0x%x, data:%@&quot;</span>, a, a, dataA); <span class="comment">//hex:0x5678 data:0x7856</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ä¼ è¾“æ—¶å°†hostç«¯åºè½¬ä¸ºå¤§ç«¯åº</span></span><br><span class="line">    <span class="type">short</span> b = <span class="built_in">NSSwapHostShortToBig</span>(a);</span><br><span class="line">    <span class="built_in">NSData</span> *dataB = [[<span class="built_in">NSData</span> alloc] initWithBytes:&amp;b length:<span class="keyword">sizeof</span>(<span class="type">short</span>)];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;b = %d, hex:0x%x, data:%@&quot;</span>, b, b, dataB); <span class="comment">//hex:0x7856 data:0x5678</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">short</span> c;</span><br><span class="line">    [dataB getBytes:&amp;c range:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="type">short</span>))];</span><br><span class="line">    <span class="built_in">NSData</span> *dataC = [[<span class="built_in">NSData</span> alloc] initWithBytes:&amp;c length:<span class="keyword">sizeof</span>(<span class="type">short</span>)];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;c = %d, hex:0x%x, data:%@&quot;</span>, c, c, dataC); <span class="comment">//hex:0x7856 data:0x5678</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ”¶åˆ°åå°†å¤§ç«¯åºè½¬ä¸ºhostç«¯åº</span></span><br><span class="line">    <span class="type">short</span> d = <span class="built_in">NSSwapBigShortToHost</span>(c);</span><br><span class="line">    <span class="built_in">NSData</span> *dataD = [[<span class="built_in">NSData</span> alloc] initWithBytes:&amp;d length:<span class="keyword">sizeof</span>(<span class="type">short</span>)];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;d = %d, hex:0x%x, data:%@&quot;</span>, d, d, dataD); <span class="comment">//hex:0x5678 data:0x7856</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ¯”ç‰¹åº"><a href="#æ¯”ç‰¹åº" class="headerlink" title="æ¯”ç‰¹åº"></a>æ¯”ç‰¹åº</h3><p>æ¯”ç‰¹é—´çš„é¡ºåºã€‚äº‹å®ä¸Šåªè¦æœ‰ä¸¤ä½bitï¼Œå°±éœ€è¦è§„å®šè¯»é¡ºåºäº†ã€‚æ¯”ç‰¹åºåŒæ ·åˆ†ä¸ºå¤§ç«¯æ¯”ç‰¹åºå’Œå°ç«¯æ¯”ç‰¹åºã€‚é€šå¸¸å°ç«¯å­—èŠ‚åºçš„CPUä¹Ÿé‡‡ç”¨å°ç«¯æ¯”ç‰¹åºï¼Œå¤§ç«¯å­—èŠ‚åºçš„CPUé‡‡ç”¨å¤§ç«¯æ¯”ç‰¹åºã€‚ä½†æ˜¯è¿™ä¸ªä¸ç»å¯¹ï¼Œä¹Ÿæœ‰å¤§ç«¯å­—èŠ‚åºçš„CPUé‡‡ç”¨å°ç«¯æ¯”ç‰¹åºã€‚æ¯”ç‰¹åºå¯¹äºè½¯ä»¶å±‚æ˜¯ä¸ªé»‘ç®±é€šå¸¸ä¸éœ€è¦å…³å¿ƒï¼Œä¸å¿…çº ç»“æœºå™¨åˆ°åº•æ˜¯é‡‡ç”¨å“ªç§æ¯”ç‰¹åºå­˜å‚¨ä¸€ä¸ªå­—èŠ‚çš„ã€‚</p>
<p>å¯¹äºä¸€ä¸ªå­—èŠ‚çš„æ•´å‹å€¼æœºå™¨åˆ°åº•æ˜¯é‡‡ç”¨å“ªç§æ¯”ç‰¹åºå­˜å‚¨çš„ï¼Œæˆ‘æ›¾ç»èŠ±äº†å¾ˆé•¿çš„æ—¶é—´å»æŸ¥èµ„æ–™ï¼Œä½†æ˜¯è¯´å•¥çš„éƒ½æœ‰ã€‚æœ€åè¿˜æ˜¯è‡ªå·±å†™äº†ä¸ªç¨‹åºéªŒè¯ä¸€ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">test_bit_order_in_byte</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> a;</span><br><span class="line">        </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">bs</span> &#123;</span></span><br><span class="line">            <span class="type">unsigned</span> <span class="type">char</span> b0: <span class="number">1</span>,</span><br><span class="line">                          b1: <span class="number">1</span>,</span><br><span class="line">                          b2: <span class="number">1</span>,</span><br><span class="line">                          b3: <span class="number">1</span>,</span><br><span class="line">                          b4: <span class="number">1</span>,</span><br><span class="line">                          b5: <span class="number">1</span>,</span><br><span class="line">                          b6: <span class="number">1</span>,</span><br><span class="line">                          b7: <span class="number">1</span>;</span><br><span class="line">        &#125;data;</span><br><span class="line">        </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">bs1</span> &#123;</span></span><br><span class="line">            <span class="type">unsigned</span> <span class="type">char</span> b0_1: <span class="number">2</span>,</span><br><span class="line">                          b2_3: <span class="number">2</span>,</span><br><span class="line">                          b4_5: <span class="number">2</span>,</span><br><span class="line">                          b6_7: <span class="number">2</span>;</span><br><span class="line">        &#125;data1;</span><br><span class="line">        </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">bs2</span> &#123;</span></span><br><span class="line">            <span class="type">unsigned</span> <span class="type">char</span> b0_3: <span class="number">4</span>,</span><br><span class="line">                          b4_7: <span class="number">4</span>;</span><br><span class="line">        &#125;data2;</span><br><span class="line">    &#125;ua;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     0x34</span></span><br><span class="line"><span class="comment">     å¤§ç«¯ï¼š0011 0100</span></span><br><span class="line"><span class="comment">     å°ç«¯ï¼š0010 1100</span></span><br><span class="line"><span class="comment">     </span></span><br><span class="line"><span class="comment">     //0010 1100</span></span><br><span class="line"><span class="comment">     //0 1 3 0</span></span><br><span class="line"><span class="comment">     //4 3</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ua.a = <span class="number">0x34</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a:%d\n&quot;</span>, ua.a);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;b0:%d\n&quot;</span>, ua.data.b0);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;b1:%d\n&quot;</span>, ua.data.b1);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;b2:%d\n&quot;</span>, ua.data.b2);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;b3:%d\n&quot;</span>, ua.data.b3);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;b4:%d\n&quot;</span>, ua.data.b4);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;b5:%d\n&quot;</span>, ua.data.b5);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;b6:%d\n&quot;</span>, ua.data.b6);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;b7:%d\n&quot;</span>, ua.data.b7);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;b0_1:%d\n&quot;</span>, ua.data1.b0_1);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;b2_3:%d\n&quot;</span>, ua.data1.b2_3);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;b4_5:%d\n&quot;</span>, ua.data1.b4_5);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;b6_7:%d\n&quot;</span>, ua.data1.b6_7);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;b0_3:%d\n&quot;</span>, ua.data2.b0_3);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;b4_7:%d\n&quot;</span>, ua.data2.b4_7);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å°ç«¯å­—èŠ‚åºæœºå™¨è¿è¡Œï¼š</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">a</span>:<span class="number">52</span></span><br><span class="line"><span class="attribute">b0</span>:<span class="number">0</span></span><br><span class="line"><span class="attribute">b1</span>:<span class="number">0</span></span><br><span class="line"><span class="attribute">b2</span>:<span class="number">1</span></span><br><span class="line"><span class="attribute">b3</span>:<span class="number">0</span></span><br><span class="line"><span class="attribute">b4</span>:<span class="number">1</span></span><br><span class="line"><span class="attribute">b5</span>:<span class="number">1</span></span><br><span class="line"><span class="attribute">b6</span>:<span class="number">0</span></span><br><span class="line"><span class="attribute">b7</span>:<span class="number">0</span></span><br><span class="line"><span class="attribute">b0_1</span>:<span class="number">0</span></span><br><span class="line"><span class="attribute">b2_3</span>:<span class="number">1</span></span><br><span class="line"><span class="attribute">b4_5</span>:<span class="number">3</span></span><br><span class="line"><span class="attribute">b6_7</span>:<span class="number">0</span></span><br><span class="line"><span class="attribute">b0_3</span>:<span class="number">4</span></span><br><span class="line"><span class="attribute">b4_7</span>:<span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°å°ç«¯å­—èŠ‚åºæœºå™¨ï¼Œå¯¹äº0x34ï¼Œå®ƒçš„æ¯”ç‰¹é¡ºåºæ˜¯0010 1100ï¼Œè¿˜æ˜¯å°ç«¯ã€‚å¦‚æœå°ç«¯å­—èŠ‚åºçš„CPUé‡‡ç”¨å¤§ç«¯æ¯”ç‰¹åºè¿™ä¸ç–¯äº†å—ã€‚æ‰€ä»¥æˆ‘æ›´å€¾å‘äºï¼šå°ç«¯å­—èŠ‚åºçš„CPUä¹Ÿé‡‡ç”¨å°ç«¯æ¯”ç‰¹åºï¼Œå¤§ç«¯å­—èŠ‚åºçš„CPUé‡‡ç”¨å¤§ç«¯æ¯”ç‰¹åºã€‚</p>
<p>ä½†æ˜¯ç½‘ç»œä¼ è¾“çš„æ—¶å€™è¿˜æ˜¯ä¸€ä¸ªbitæ¥ä¸€ä¸ªbitå‘é€çš„ï¼Œé‚£æ¯”ç‰¹é¡ºåºä¸ä¸€æ ·çš„ä¸¤å°æœºå™¨æ”¶å‘ä¸ä¼šå‡ºé—®é¢˜å—ï¼Ÿæ¯”å¦‚å‘ä¸€ä¸ªunsigned char æ•´å‹å€¼0x34ã€‚ä»å®é™…æƒ…å†µæ¥çœ‹ï¼Œç¡®å®æ²¡æœ‰é—®é¢˜ï¼Œæ€ä¹ˆåšåˆ°çš„ï¼ŸæŸ¥äº†å¾ˆå¤šèµ„æ–™ï¼Œæ¯”è¾ƒå¯ä¿¡çš„è¯´æ³•ï¼š<br>åœ¨ä»¥å¤ªç½‘(Ethernet)ä¸­ï¼Œå‘é€ä¸€ä¸ªå­—èŠ‚æ˜¯ä»æœ€ä½æœ‰æ•ˆæ¯”ç‰¹ä½åˆ°æœ€é«˜æœ‰æ•ˆæ¯”ç‰¹ä½çš„å‘é€é¡ºåºï¼Œä¹Ÿå°±æ˜¯æœ€ä½æœ‰æ•ˆæ¯”ç‰¹ä½é¦–å…ˆå‘é€ã€‚æ¥æ”¶æ–¹æ¥æ”¶åˆ°çš„æ•°æ®é¡ºåºå’Œå‘é€æ–¹å‘é€çš„bité¡ºåºä¸€è‡´ï¼Œæ”¶åˆ°åç½‘å¡ä¼šæŠŠæ¥æ”¶åˆ°çš„æ¯”ç‰¹åºè½¬æ¢æˆä¸»æœºçš„æ¯”ç‰¹åºã€‚è¿™ä¸€è¿‡ç¨‹å¯¹CPUã€è½¯ä»¶éƒ½æ˜¯ä¸å¯è§çš„ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸éœ€è¦å…³å¿ƒæ¯”ç‰¹é—´çš„é¡ºåºï¼Œåªéœ€è¦å…³å¿ƒå­—èŠ‚é—´çš„é¡ºåºã€‚æ¯”å¦‚å•å­—èŠ‚0x34ï¼Œä¸ç®¡å‘é€æ–¹æ˜¯å¤§ç«¯è¿˜æ˜¯å°ç«¯ï¼Œå¯¹ç«¯æ”¶åˆ°åè‚¯å®šè¿˜æ˜¯0x34ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">å‘é€ç«¯å¤§ç«¯:</span> <span class="number">0011 </span><span class="number">0100</span>      </span><br><span class="line"><span class="string">ç½‘ç»œä¼ è¾“:</span>   <span class="number">0010 </span><span class="number">1100</span>    </span><br><span class="line"><span class="string">æ¥æ”¶ç«¯å°ç«¯:</span> <span class="number">0010 </span><span class="number">1100</span>    </span><br><span class="line"></span><br><span class="line"><span class="string">å‘é€ç«¯å°ç«¯:</span> <span class="number">0010 </span><span class="number">1100</span> </span><br><span class="line"><span class="string">ç½‘ç»œä¼ è¾“:</span>   <span class="number">0010 </span><span class="number">1100</span></span><br><span class="line"><span class="string">æ¥æ”¶ç«¯å¤§ç«¯:</span> <span class="number">0011 </span><span class="number">0100</span></span><br></pre></td></tr></table></figure>
<p>å•ä¸ªå­—èŠ‚ä¸éœ€è¦ç«¯åºè½¬æ¢ï¼Œä¸¤ç«¯ä¹Ÿèƒ½æ­£ç¡®ç†è§£ï¼Œä¸¤ç«¯ä¸­çš„æ¯”ç‰¹é¡ºåºå¯èƒ½ä¸ä¸€è‡´ï¼Œä½†è¡¨è¾¾çš„æ˜¯åŒä¸€ä¸ªæ•°å­—ã€‚</p>
<h3 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h3><p>Q1ï¼šçœŸæœºæŸ¥çœ‹ä¸€ä¸‹æ•´æ•°ã€å­—ç¬¦ä¸²åœ¨å†…å­˜é‡Œçš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼Ÿ</p>
<p>æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_number_and_char</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">0x1234</span>;</span><br><span class="line">    <span class="type">char</span> *p = <span class="string">&quot;1234&quot;</span>; <span class="comment">//å­—ç¬¦1å¯¹åº”çš„asciiç å°±æ˜¯0x31</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a = 0x%x, ch = %s\n&quot;</span>, a, p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å°ç«¯æœºå™¨è¿è¡Œ</p>
<p>intæ•´å‹0x1234</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/image-20221020110929974.png" alt=""></p>
<p>æ•°å­—åœ¨å†…å­˜é‡Œæ˜¯æŒ‰å°ç«¯å­—èŠ‚åºå­˜å‚¨çš„ã€‚</p>
<p>å­—ç¬¦ä¸²â€1234â€</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20221020110814.png" alt=""></p>
<p>å¯ä»¥çœ‹åˆ°å°ç«¯æœºå™¨ï¼Œå­—ç¬¦ä¸²åœ¨å†…å­˜é‡Œæ˜¯æŒ‰å¤§ç«¯å­—èŠ‚åºå­˜å‚¨çš„ã€‚</p>
<p>Q2ï¼šæŸ¥çœ‹æ–‡æœ¬æ–‡ä»¶çš„å­—èŠ‚åºï¼Ÿ</p>
<p>ä½œä¸ºä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œä¸ªäººè§‰å¾—æ˜¯è¦è¯´æ˜ç¼–ç è§„åˆ™å’Œå­—èŠ‚åºçš„ã€‚å½“ç„¶æœ‰çš„ç¼–ç ä¸éœ€è¦ç‰¹åˆ«è¯´æ˜å­—èŠ‚åºæ¯”å¦‚utf-8ã€‚ï¼ˆæœ‰ç©ºå†ç ”ç©¶å§ï¼‰</p>
<p>Q3ï¼šä¸€æ®µå­—ç¬¦ä¸²ä»Aç”µè„‘ç½‘ç»œä¼ è¾“åˆ°Bç”µè„‘éœ€è¦è€ƒè™‘å­—èŠ‚åºå—ï¼Ÿ</p>
<p>ä¸éœ€è¦ï¼Œå› ä¸ºå­—ç¬¦ä¸²æ— è®ºåœ¨å¤§ç«¯è¿˜æ˜¯å°ç«¯æœºå™¨éƒ½æ˜¯ä»¥å¤§ç«¯å­—èŠ‚åºå­˜å‚¨çš„ï¼Œç½‘ç»œä¼ è¾“æ—¶ä¹Ÿæ˜¯æŒ‰å¤§ç«¯å­—èŠ‚åºä¼ è¾“çš„ï¼Œå¯¹ç«¯æ”¶åˆ°ååŒæ ·æ˜¯å¤§ç«¯å­—èŠ‚é¡ºåºï¼Œæ‰€ä»¥ä¸¤ç«¯ç†è§£çš„æ˜¯åŒä¸€ä¸ªä¸œè¥¿ã€‚è‡³äºå•å­—èŠ‚é‡Œçš„æ¯”ç‰¹åºå¯èƒ½ä¼šä¸ä¸€æ ·ã€‚</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://cloud.tencent.com/developer/article/1476226">å­—èŠ‚åº: ä¸€ä¸ªä¸æ˜¯å¾ˆé‡è¦çš„æ¦‚å¿µ</a></p>
<p><a href="https://www.wikiwand.com/en/Bit_numbering">Bit numbering</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/544398250">ä¸€æ–‡å¸¦ä½ ç§’æ‡‚ å­—èŠ‚åº(byte order)ï¼Œæ¯”ç‰¹åº(bit order)ï¼Œä½åŸŸ(bit field)</a></p>
<p><a href="https://blog.csdn.net/shaohui973/article/details/115766497">Ethernetä¸‹å­—èŠ‚åºå’Œbitåºçš„æ€»ç»“</a>   è¿™ä¸¤ç¯‡æ–‡ç« bitå‘é€é¡ºåºçš„è§‚ç‚¹åˆšå¥½ç›¸åã€‚</p>
<p><a href="https://www.linecall.de/wp-content/uploads/2016/11/802.3-2015_SECTION1.pdf">MACå¸§çš„å…«ä½å­—èŠ‚å‘é€é¡ºåº</a>  ä¼˜å…ˆå‘é€æœ€ä½ä½ã€‚Each octet of the MAC frame, with the exception of the FCS, is transmitted least significant bit first.</p>
<p><a href="https://blog.csdn.net/liuxingen/article/details/45420455">å­—èŠ‚åº(byte order)å’Œä½åº(bit order)</a>  3â­ï¸</p>
<p><a href="https://www.ruanyifeng.com/blog/2016/11/byte-order.html">ç†è§£å­—èŠ‚åº</a></p>
<p><a href="https://blog.erratasec.com/2016/11/how-to-teach-endian.html#.Y05SIexBxvc">How to teach endian</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1673920">Cè¯­è¨€æ‰“å°æ•°æ®çš„äºŒè¿›åˆ¶æ ¼å¼-åŸç†è§£æä¸ç¼–ç¨‹å®ç°</a></p>
<p><a href="https://www.cnblogs.com/leesf456/p/5317574.html">ã€å­—ç¬¦ç¼–ç ã€‘å½»åº•ç†è§£å­—ç¬¦ç¼–ç </a></p>
]]></content>
      <categories>
        <category>è®¡ç®—æœºåŸºç¡€</category>
      </categories>
      <tags>
        <tag>å­—èŠ‚åº</tag>
      </tags>
  </entry>
  <entry>
    <title>è‡ªåŠ¨å‹ç¼©å›¾ç‰‡--ä½ çš„ç¬¬ä¸€ä¸ªè„šæœ¬</title>
    <url>/2022/06/19/%E8%87%AA%E5%8A%A8%E5%8E%8B%E7%BC%A9%E5%9B%BE%E7%89%87--%E4%BD%A0%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA%E8%84%9A%E6%9C%AC/</url>
    <content><![CDATA[<p>åœ¨å¾€å›¾åºŠä¸Šä¸¢å›¾ç‰‡æ—¶ï¼Œæœ‰æ—¶å€™æ€»æ˜¯å› ä¸ºå›¾ç‰‡å¤ªå¤§è€Œè¦ç­‰å¾ˆä¹…çš„æ—¶é—´ï¼Œé¢å¯¹è¿™ç§æƒ…å†µå‹ç¼©å›¾ç‰‡åå†ä¸Šä¼ æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚ä½†æ˜¯æ¯æ¬¡éƒ½è¦å…ˆæ‰“å¼€å›¾ç‰‡å‹ç¼©è½¯ä»¶ï¼Œå†ä¸¢å›¾ç‰‡å‹ç¼©ï¼Œå†æ‰¾åˆ°å‹ç¼©åçš„å›¾ç‰‡ï¼Œå†ä¸Šä¼ åˆ°å›¾åºŠï¼Œè¿™ä¸€ç³»åˆ—æ“ä½œä¹Ÿæ˜¯ç¹çã€‚ä»Šå¤©å°±æ¥è§£å†³ä¸€ä¸‹è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>å¾ˆæ˜¾ç„¶è„šæœ¬èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬è‡ªåŠ¨å®Œæˆè¿™äº›çƒ¦äººçš„æ“ä½œã€‚æˆ‘ä»¬å¸Œæœ›è¿™ä¸ªè„šæœ¬èƒ½å¤Ÿè‡ªåŠ¨å‹ç¼©å½“å‰æ–‡ä»¶å¤¹çš„æ‰€æœ‰å›¾ç‰‡ï¼Œå‹ç¼©åå°†å›¾ç‰‡è½¬ç§»åˆ°å¦ä¸€ä¸ªæ–‡ä»¶å¤¹æ–¹ä¾¿æŸ¥æ‰¾ã€‚</p>
<p>è¯´å¹²å°±å¹²ï¼Œlets go!</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…ä¸€ä¸ªå›¾ç‰‡å‹ç¼©è½¯ä»¶ï¼Œè¿™ä¸ªå›¾ç‰‡å‹ç¼©è½¯ä»¶è¦èƒ½æ”¯æŒå‘½ä»¤è¡Œæ“ä½œï¼Œè¿™é‡Œé€‰æ‹©ImageOptim: <a href="https://imageoptim.com">https://imageoptim.com</a> ï¼Œåˆ°å®˜ç½‘ä¸‹è½½åå®‰è£…å³å¯ã€‚</p>
<p>å…¶æ¬¡ï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…ImageOptim-CLIï¼Œæœ‰äº†å®ƒå°±å¯ä»¥ç”¨å‘½ä»¤è¡Œæ“ä½œå›¾ç‰‡å‹ç¼©è½¯ä»¶ImageOptimäº†ã€‚æ¨èä½¿ç”¨npmå®‰è£…ç‰¹åˆ«æ˜¯M1èŠ¯ç‰‡çš„Macï¼Œæ‰“å¼€ç»ˆç«¯è¾“å…¥ï¼š</p>
<figure class="highlight avrasm"><table><tr><td class="code"><pre><span class="line">npm install -g imageoptim-<span class="keyword">cli</span></span><br></pre></td></tr></table></figure>
<p>å®‰è£…å®ŒæˆåæŸ¥çœ‹ä¸€ä¸‹ç‰ˆæœ¬ç¡®å®šæ˜¯å¦å®‰è£…æˆåŠŸï¼š</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">imageoptim</span> --version</span><br><span class="line"><span class="attribute">3</span>.<span class="number">0</span>.<span class="number">7</span></span><br></pre></td></tr></table></figure>
<p>æœ€åï¼Œå°±æ˜¯å†™è„šæœ¬äº†ï¼šç›®å‰æˆ‘ä»¬åªå‹ç¼©pngï¼Œjpgï¼Œjpegï¼Œgif</p>
<p>éšä¾¿æ‰“å¼€ä¸€ä¸ªæ–‡æœ¬ç¼–è¾‘å™¨æ¯”å¦‚è®°äº‹æœ¬ï¼Œæ‹·è´ä¸‹é¢çš„ä»£ç å¹¶ä¿å­˜ä¸º <code>compress.sh</code> ï¼Œä¿å­˜è·¯å¾„éšæ„è¿™é‡Œä¸ºæ¡Œé¢ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">png=<span class="string">&quot;*.png&quot;</span></span><br><span class="line">jpg=<span class="string">&quot;*.jpg&quot;</span></span><br><span class="line">jpeg=<span class="string">&quot;*.jpeg&quot;</span></span><br><span class="line">gif=<span class="string">&quot;*.gif&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ç›®å‰åªå‹ç¼©ï¼š&quot;</span><span class="variable">$png</span><span class="string">&quot;ã€&quot;</span><span class="variable">$jpg</span><span class="string">&quot;ã€&quot;</span><span class="variable">$jpeg</span><span class="string">&quot;ã€&quot;</span><span class="variable">$gif</span><span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;å¼€å§‹å‹ç¼©&quot;</span></span><br><span class="line">imageoptim <span class="variable">$png</span> <span class="variable">$jpg</span> <span class="variable">$jpeg</span> <span class="variable">$gif</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;å®Œæˆå‹ç¼©&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;å¼€å§‹å°†å›¾ç‰‡ç§»åˆ°compressedæ–‡ä»¶å¤¹&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span> -p compressed</span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> $(find . -maxdepth 1 -name <span class="string">&quot;<span class="variable">$png</span>&quot;</span> -or -name <span class="string">&quot;<span class="variable">$jpg</span>&quot;</span> -or -name <span class="string">&quot;<span class="variable">$jpeg</span>&quot;</span> -or -name <span class="string">&quot;<span class="variable">$gif</span>&quot;</span>)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;ç§»åŠ¨æ–‡ä»¶:<span class="variable">$&#123;file&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">mv</span> <span class="variable">$&#123;file&#125;</span> compressed</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;å®Œæˆå°†å›¾ç‰‡ç§»åˆ°compressedæ–‡ä»¶å¤¹&quot;</span></span><br></pre></td></tr></table></figure>
<p>è„šæœ¬å¾ˆç®€å•ï¼Œå°±æ˜¯å‹ç¼©å½“å‰æ–‡ä»¶å¤¹é‡Œçš„pngï¼Œjpgï¼Œjpegï¼Œgifå›¾ç‰‡ï¼Œç„¶åå°†è¿™äº›å‹ç¼©å¥½çš„å›¾ç‰‡è½¬ç§»åˆ°compressedæ–‡ä»¶å¤¹ã€‚å½“ç„¶è¿™ä¸ªæ—¶å€™è®¡ç®—æœºè¿˜åªæ˜¯è®¤ä¸ºå®ƒæ˜¯ä¸€ä¸ªæ™®é€šçš„æ–‡æœ¬æ–‡ä»¶ã€‚æˆ‘ä»¬éœ€è¦å°†å®ƒèµ‹äºˆå¯æ‰§è¡Œå±æ€§ï¼š</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">cd</span> ~/Desktop</span><br><span class="line">chmod +x <span class="keyword">compress</span>.<span class="keyword">sh</span></span><br></pre></td></tr></table></figure>
<p>è¿™æ ·compress.shå°±å˜ä¸ºä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶äº†ã€‚</p>
<p>æœ€åæµ‹è¯•ä¸€ä¸‹æ•ˆæœå§^_^</p>
<p>åœ¨æ¡Œé¢åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹pictureStorageï¼Œå°†compress.shæ‹–å…¥åˆ°è¯¥æ–‡ä»¶å¤¹é‡Œï¼Œå†å‡†å¤‡å‡ å¼ å›¾ç‰‡ä¹Ÿæ”¾å…¥åˆ°è¯¥æ–‡ä»¶å¤¹é‡Œã€‚</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/QQ20220619-154224%402x.png" alt=""></p>
<p>æ‰§è¡Œï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/Desktop/pictureStorage</span><br><span class="line">./compress.sh</span><br></pre></td></tr></table></figure>
<p>å°±å¯çœ‹åˆ°æ‰“å°æ—¥å¿—ï¼š</p>
<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">ç›®å‰åªå‹ç¼©ï¼š<span class="operator">*</span>.pngã€<span class="operator">*</span>.jpgã€<span class="operator">*</span>.jpegã€<span class="operator">*</span>.gif</span><br><span class="line">å¼€å§‹å‹ç¼©</span><br><span class="line">Running ImageOptim...</span><br><span class="line">âœ“ ç–‘é—®.png <span class="params">was:</span> <span class="number">223</span>kB <span class="params">now:</span> <span class="number">180</span>kB <span class="params">saving:</span> <span class="number">43.3</span>kB (<span class="number">19.44</span>%)</span><br><span class="line">âœ“ v2-ae634956702d53f64862c9fe58691e7d_1440w.jpg <span class="params">was:</span> <span class="number">22.3</span>kB <span class="params">now:</span> <span class="number">5.39</span>kB <span class="params">saving:</span> <span class="number">16.9</span>kB (<span class="number">75.86</span>%)</span><br><span class="line">âœ“ ç‹å¢ƒæ³½<span class="number">1</span>.gif <span class="params">was:</span> <span class="number">1.02</span>MB <span class="params">now:</span> <span class="number">935</span>kB <span class="params">saving:</span> <span class="number">85.4</span>kB (<span class="number">8.37</span>%)</span><br><span class="line">âœ“ TOTAL <span class="params">was:</span> <span class="number">1.27</span>MB <span class="params">now:</span> <span class="number">1.12</span>MB <span class="params">saving:</span> <span class="number">146</span>kB (<span class="number">11.51</span>%)</span><br><span class="line">âœ“ Finished</span><br><span class="line">å®Œæˆå‹ç¼©</span><br><span class="line">å¼€å§‹å°†å›¾ç‰‡ç§»åˆ°compressedæ–‡ä»¶å¤¹</span><br><span class="line">ç§»åŠ¨æ–‡ä»¶:.<span class="operator">/</span>ç–‘é—®.png</span><br><span class="line">ç§»åŠ¨æ–‡ä»¶:.<span class="operator">/</span>ç‹å¢ƒæ³½<span class="number">1</span>.gif</span><br><span class="line">ç§»åŠ¨æ–‡ä»¶:<span class="symbol">./v2-ae634956702d53f64862c9fe58691e7d_1440w.jpg</span></span><br><span class="line">å®Œæˆå°†å›¾ç‰‡ç§»åˆ°compressedæ–‡ä»¶å¤¹</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/QQ20220619-155225%402x.png" alt=""></p>
<p>ä¸‰å¼ å›¾ç‰‡ä¸€å…±å‡å°‘äº†146kBï¼Œè¿˜æ˜¯å¯ä»¥çš„ã€‚</p>
<p>ä»¥åä½ å°±åªéœ€è¦å°†å›¾ç‰‡ä¸¢åˆ°pictureStorageæ–‡ä»¶å¤¹ï¼Œç„¶åæ‰§è¡Œ <code>./compress.sh</code> è„šæœ¬å°±å¯ä»¥äº†ï¼å®Œå…¨ä¸éœ€è¦æ‰“å¼€ImageOptimï¼Œä¸€å¼ å¼ é€‰äº†ã€‚çœŸæ˜¯å®‰å…¨åˆæ–¹ä¾¿ï¼</p>
]]></content>
      <categories>
        <category>è„šæœ¬</category>
      </categories>
      <tags>
        <tag>å›¾ç‰‡å‹ç¼©</tag>
      </tags>
  </entry>
  <entry>
    <title>findå‘½ä»¤</title>
    <url>/2022/06/19/find%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<h2 id="find"><a href="#find" class="headerlink" title="find"></a>find</h2><p>åœ¨æŒ‡å®šç›®å½•ä¸‹æŸ¥æ‰¾æ–‡ä»¶ã€‚</p>
<p>ä½¿ç”¨è¯¥å‘½ä»¤æ—¶ï¼Œä¸è®¾ç½®ä»»ä½•å‚æ•°ï¼Œåˆ™findå‘½ä»¤å°†åœ¨å½“å‰ç›®å½•ä¸‹æŸ¥æ‰¾å­ç›®å½•ä¸æ–‡ä»¶ï¼ˆå³é»˜è®¤é€’å½’æŸ¥æ‰¾ï¼‰ã€‚å¹¶ä¸”å°†æŸ¥æ‰¾åˆ°çš„å­ç›®å½•å’Œæ–‡ä»¶å…¨éƒ¨è¿›è¡Œæ˜¾ç¤ºã€‚</p>
<h3 id="è¯­æ³•"><a href="#è¯­æ³•" class="headerlink" title="è¯­æ³•"></a>è¯­æ³•</h3><figure class="highlight dos"><table><tr><td class="code"><pre><span class="line"><span class="built_in">find</span> <span class="built_in">path</span> expression</span><br></pre></td></tr></table></figure>
<p>expressionï¼šè¡¨è¾¾å¼ï¼Œé€‰é¡¹ï¼Œå‚æ•°ã€‚</p>
<p>find æ ¹æ®ä¸‹åˆ—è§„åˆ™åˆ¤æ–­ path å’Œ expressionï¼Œåœ¨å‘½ä»¤åˆ—ä¸Šç¬¬ä¸€ä¸ª - ( ) , ! ä¹‹å‰çš„éƒ¨ä»½ä¸º pathï¼Œä¹‹åçš„æ˜¯ expressionã€‚å¦‚æœ path æ˜¯ç©ºå­—ä¸²åˆ™ä½¿ç”¨ç›®å‰è·¯å¾„ï¼Œå¦‚æœ expression æ˜¯ç©ºå­—ä¸²åˆ™ä½¿ç”¨ -print ä¸ºé¢„è®¾ expressionã€‚</p>
<p>æ³¨æ„ï¼špathæœ€å¥½ä¸è¦çœç•¥ã€‚</p>
<p>expression ä¸­å¯ä½¿ç”¨çš„é€‰é¡¹æœ‰äºŒä¸‰åä¸ªä¹‹å¤šï¼Œç”¨åˆ°çš„æ—¶å€™å¯ä»¥æŸ¥ä¸€ä¸‹ã€‚</p>
<p>å¸¸è§çš„æœ‰ï¼š</p>
<p>-print</p>
<p>-name</p>
<p>-iname</p>
<p>-maxdepth</p>
<p>-type</p>
<p>-and</p>
<p>-or</p>
<p>-not</p>
<h3 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h3><p>eg1ï¼šåˆ—å‡ºå½“å‰ç›®å½•åŠå­ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶å’Œæ–‡ä»¶å¤¹</p>
<p><code>find .</code></p>
<p>ç»“æœï¼š</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line"><span class="string">./.DS_Store</span></span><br><span class="line"><span class="string">./compress.sh</span></span><br><span class="line"><span class="string">./compressed</span></span><br><span class="line"><span class="string">./compressed/</span>ç–‘é—®<span class="string">.png</span></span><br><span class="line"><span class="string">./compressed/QQ20220619-004415</span>@2x.png</span><br><span class="line"><span class="string">./compressed/v2-ae634956702d53f64862c9fe58691e7d_1440w.jpg</span></span><br></pre></td></tr></table></figure>
<p>eg2ï¼šä»…åœ¨å½“å‰ç›®å½•æŸ¥æ‰¾ã€‚</p>
<p><code>find . -maxdepth 1</code></p>
<p>ç»“æœï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">./.DS_Store</span><br><span class="line">./compress.sh</span><br><span class="line">./compressed</span><br></pre></td></tr></table></figure>
<p>eg3ï¼šåœ¨å½“å‰ç›®å½•ä¸­æŸ¥æ‰¾æŒ‡å®šçš„æ–‡ä»¶</p>
<p><code>find /Applications/Xcode.app -name symbolicatecrash</code></p>
<p>ç»“æœï¼š</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">/Applications/</span>Xcode.app<span class="regexp">/Contents/</span>Developer<span class="regexp">/Platforms/</span>WatchSimulator.platform<span class="regexp">/Developer/</span>Library<span class="regexp">/PrivateFrameworks/</span>DVTFoundation.framework/symbolicatecrash</span><br><span class="line"><span class="regexp">/Applications/</span>Xcode.app<span class="regexp">/Contents/</span>Developer<span class="regexp">/Platforms/</span>AppleTVSimulator.platform<span class="regexp">/Developer/</span>Library<span class="regexp">/PrivateFrameworks/</span>DVTFoundation.framework/symbolicatecrash</span><br><span class="line"><span class="regexp">/Applications/</span>Xcode.app<span class="regexp">/Contents/</span>Developer<span class="regexp">/Platforms/i</span>PhoneSimulator.platform<span class="regexp">/Developer/</span>Library<span class="regexp">/PrivateFrameworks/</span>DVTFoundation.framework/symbolicatecrash</span><br><span class="line"><span class="regexp">/Applications/</span>Xcode.app<span class="regexp">/Contents/</span>SharedFrameworks<span class="regexp">/DVTFoundation.framework/</span>Versions<span class="regexp">/A/</span>Resources/symbolicatecrash</span><br></pre></td></tr></table></figure>
<p>åœ¨å½“å‰è·¯å¾„ä¸‹é€’å½’æŸ¥æ‰¾ä»¥.txtç»“å°¾çš„æ–‡ä»¶</p>
<p><code>find . -name &quot;*.txt&quot;</code></p>
<p>eg4ï¼šä»…åœ¨å½“å‰è·¯å¾„ä¸‹æŸ¥æ‰¾ä»¥.pngã€.jpgã€.jpegç»“å°¾çš„æ–‡ä»¶</p>
<p><code>find . -maxdepth 1 -name &quot;*.png&quot; -or -name &quot;*.jpg&quot; -or -name &quot;*.jpeg&quot;</code></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://wangchujiang.com/linux-command/c/find.html">find</a>  Linuxå‘½ä»¤æœç´¢çš„ä¸€ä¸ªç½‘ç«™</p>
]]></content>
      <categories>
        <category>å‘½ä»¤è¡Œ</category>
      </categories>
      <tags>
        <tag>find</tag>
      </tags>
  </entry>
  <entry>
    <title>iOSå¾ªç¯æ’­æ”¾è§†é¢‘</title>
    <url>/2022/05/29/iOS%E5%BE%AA%E7%8E%AF%E6%92%AD%E6%94%BE%E8%A7%86%E9%A2%91/</url>
    <content><![CDATA[<p>æœ‰ä¸€ä¸ªéœ€æ±‚éœ€è¦å¾ªç¯æ’­æ”¾ä¸€ä¸ªè§†é¢‘ï¼ŒUIå¸Œæœ›çš„æ•ˆæœæ˜¯æ— ç¼å¾ªç¯æ’­æ”¾ã€‚å½“æ—¶è§‰å¾—åº”è¯¥é—®é¢˜ä¸å¤§ï¼Œä½†äº‹å®å´å¹¶éå¦‚æ­¤ã€‚å¦‚æœåªæ˜¯å•çº¯çš„å¾ªç¯æ’­æ”¾ï¼Œç¡®å®ç®€å•ã€‚ä½†æ˜¯æƒ³è¦æ— ç¼ä¸æ»‘è¿è´¯çš„å¾ªç¯æ’­æ”¾å´å¹¶ä¸é‚£ä¹ˆç®€å•ã€‚</p>
<h3 id="æ–¹æ¡ˆä¸€ï¼šijkplayer"><a href="#æ–¹æ¡ˆä¸€ï¼šijkplayer" class="headerlink" title="æ–¹æ¡ˆä¸€ï¼šijkplayer"></a>æ–¹æ¡ˆä¸€ï¼šijkplayer</h3><p>é¡¹ç›®ä¸­ç”¨çš„ijkplayerï¼Œåˆšå¼€å§‹æ˜¯ç›‘å¬æ’­æ”¾å®Œæˆé€šçŸ¥ï¼Œæ’­æ”¾å®Œåé‡æ–°æ’­æ”¾ï¼Œç»“æœå‘ç°æ¯æ¬¡æ’­å®Œåéƒ½è¦åœé¡¿ä¸€ä¸‹æ‰ä¼šç»§ç»­æ’­æ”¾ã€‚è¾¾ä¸åˆ°æ— ç¼å¾ªç¯çš„è¦æ±‚ã€‚</p>
<p>ä¸€é¡¿æœç´¢ä¹‹åï¼Œå‘ç°å¯ä»¥é€šè¿‡è®¾ç½®optionçš„loopå±æ€§ï¼Œè®¾ç½®ä¸º100å°±æ˜¯å¾ªç¯æ’­æ”¾100æ¬¡ï¼Œè®¾ç½®1å°±æ˜¯æ’­æ”¾ä¸€æ¬¡ï¼Œè®¾ç½®0å°±æ˜¯æ— çº¿å¾ªç¯æ’­æ”¾ã€‚è¿™ä¸€æ¬¡ä»¥ä¸ºç¨³äº†ï¼Œç„¶å¹¶åµï¼Œè¿˜æ˜¯æ¯æ¬¡æ’­å®Œåéƒ½è¦åœé¡¿ä¸€ä¸‹æ‰ä¼šç»§ç»­æ’­æ”¾ã€‚</p>
<p>åˆæ˜¯ä¸€é¡¿æœç´¢ï¼Œå‘ç°äº†ijkplayerå¯ä»¥æ’­æ”¾contactæ–‡ä»¶ï¼Œæ‰€è°“contactæ–‡ä»¶å°±æ˜¯æŒ‰ç…§ä¸€å®šçš„æ ¼å¼å°†è¦æ’­æ”¾çš„è§†é¢‘åœ°å€æŒ‰é¡ºåºå†™å…¥ä¸€ä¸ªæ–‡ä»¶ï¼ŒæŠŠè¿™ä¸ªæ–‡ä»¶ä¸¢ç»™ijkplayerï¼Œijkplayerå°±ä¼šæŒ‰ç…§é¡ºåºä¸€ä¸ªä¸ªæ’­æ”¾ï¼Œå½“æ—¶å°±åœ¨æƒ³æ˜¯ä¸æ˜¯è¿™ç§æ–¹å¼å¯ä»¥æ— ç¼æ’­æ”¾å‘¢ï¼Ÿäºæ˜¯å°†è§†é¢‘çš„åœ°å€å†™äº†1000éï¼Œè¿™æ ·ijkplayerå°±ä¼šæ’­æ”¾1000æ¬¡ï¼Œè¾¾åˆ°ä¸€ä¸ªå¾ªç¯æ’­æ”¾çš„å‡è±¡ã€‚ç„¶è€Œè¿˜æ˜¯æ²¡æœ‰ä»€ä¹ˆåµç”¨ï¼Œæ•ˆæœå’Œä¸Šé¢ä¸€æ ·ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼šijkplayerçš„æ’­æ”¾æœºåˆ¶å°±æ˜¯æ’­å®Œåä¼šæš‚åœï¼Œè¿™ä¸€æš‚åœå°±å¯¼è‡´ä¸è¿è´¯äº†ï¼Œå› æ­¤å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°ä¼šåœé¡¿ä¸€ä¸‹æ‰ç»§ç»­æ’­æ”¾ã€‚ä½¿ç”¨ijkplayeråŸºæœ¬ä¸Šåšä¸åˆ°æ— ç¼å¾ªç¯æ’­æ”¾è§†é¢‘ã€‚å½“ç„¶ä¹Ÿæœ‰å¯èƒ½æ˜¯æˆ‘æ‰ç–å­¦æµ…æ²¡æ‰¾åˆ°æ­£ç¡®çš„æ–¹å¼ã€‚</p>
<h3 id="æ–¹æ¡ˆäºŒï¼šAVPlayer"><a href="#æ–¹æ¡ˆäºŒï¼šAVPlayer" class="headerlink" title="æ–¹æ¡ˆäºŒï¼šAVPlayer"></a>æ–¹æ¡ˆäºŒï¼šAVPlayer</h3><p>ijkplayeræ—¢ç„¶ä¸è¡Œï¼Œé‚£å°±åªèƒ½è¯•ä¸€ä¸‹ç³»ç»Ÿçš„AVPlayeräº†ï¼Œè¿˜æ˜¯åŒæ ·çš„æ€è·¯ï¼Œç›‘å¬æ’­æ”¾å®Œæˆé€šçŸ¥ï¼Œæ’­æ”¾å®Œåé‡æ–°æ’­æ”¾ï¼Œç»“æœå‘ç°æ•ˆæœä¸€æ ·ã€‚</p>
<h3 id="æ–¹æ¡ˆä¸‰ï¼šAVQueuePlayer"><a href="#æ–¹æ¡ˆä¸‰ï¼šAVQueuePlayer" class="headerlink" title="æ–¹æ¡ˆä¸‰ï¼šAVQueuePlayer"></a>æ–¹æ¡ˆä¸‰ï¼šAVQueuePlayer</h3><p>æœ€åæ‰¾åˆ°ä¸€ç¯‡æ–‡ç« è¯´æ˜¯è¦ä½¿ç”¨AVPlayerçš„å­ç±»AVQueuePlayerï¼Œè¯•äº†ä¸€ä¸‹å‘ç°æ•ˆæœç¡®å®å¾ˆä¸é”™ï¼Œå‡ ä¹çœ‹ä¸å‡ºæ¥æœ‰åœé¡¿çš„æ„Ÿè§‰ã€‚AVQueuePlayeråº”è¯¥ä¼šé¢„åŠ è½½è¦æ’­æ”¾çš„èµ„æºï¼Œè¿™æ ·æ’­æ”¾å®Œåå°±å¯ä»¥ç«‹å³åŠ è½½æ¸²æŸ“ä¸‹ä¸€ä¸ªè§†é¢‘çš„ç”»é¢äº†ã€‚</p>
<p>æ€»ç»“ï¼šå¦‚æœè¦æ— ç¼å¾ªç¯æ’­æ”¾è§†é¢‘ï¼ŒAVQueuePlayeræ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</p>
<h3 id="æ–¹æ¡ˆå››ï¼šGIF-Webpæ’­æ”¾"><a href="#æ–¹æ¡ˆå››ï¼šGIF-Webpæ’­æ”¾" class="headerlink" title="æ–¹æ¡ˆå››ï¼šGIF/Webpæ’­æ”¾"></a>æ–¹æ¡ˆå››ï¼šGIF/Webpæ’­æ”¾</h3><p>æœ¬æ¥æˆ‘ä»¬é¡¹ç›®ä¸­å¯¹ijkplayeråšäº†ä¸€äº›ä¿®æ”¹æ”¯æŒæ’­æ”¾é€æ˜è§†é¢‘ï¼Œç»“æœå› ä¸ºijkplayerå¾ªç¯æ’­æ”¾ä¸ä¸æ»‘ï¼Œåªèƒ½å¦è¾Ÿè¹Šå¾„ã€‚è€Œç³»ç»Ÿæ’­æ”¾å™¨å¯å®šåˆ¶ç¨‹åº¦ä¸é«˜ï¼Œå¦‚æœä½ éœ€è¦å…ˆå¤„ç†è§†é¢‘ç”»é¢å†æ’­æ”¾ï¼Œé‚£ä¹ˆAVQueuePlayerå¯èƒ½ä¹Ÿä¸è¡Œäº†ï¼Œæ¯”å¦‚é€æ˜è§†é¢‘çš„æ— ç¼å¾ªç¯æ’­æ”¾ã€‚ç„¶è€Œè¿™ä¸ªéœ€æ±‚å°±æ˜¯éœ€è¦é€æ˜è§†é¢‘çš„æ— ç¼å¾ªç¯æ’­æ”¾ï¼Œè¿™ä¸æ˜¯å·§äº†å—ï¼Œäºæ˜¯AVQueuePlayerä¹Ÿè¢«passäº†ã€‚</p>
<p>æœ€åå®åœ¨æ˜¯æ²¡æœ‰åŠæ³•äº†ï¼Œçªç„¶æƒ³åˆ°åæ­£æ˜¯æ’­ä¸€ä¸ªæ²¡å£°éŸ³çš„è§†é¢‘ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥è‡ªå·±ä¸€å¸§ä¸€å¸§æ’­å›¾ç‰‡å‘¢ï¼Œè¿™æ ·è¿è´¯æ€§è‚¯å®šæœ‰ä¿éšœäº†ã€‚äºæ˜¯è®©UIå‡ºäº†ä¸€ä¸ªWebpèµ„æºï¼Œé…åˆYYAnimateImageViewæ’­æ”¾ï¼Œå¯ä»¥è¯´æ˜¯éå¸¸çš„ä¸æ»‘ã€‚å”¯ä¸€ä¸è¶³çš„æ˜¯èµ„æºå¤§å°å˜å¤§äº†ä¸€å€ï¼Œä¸è¿‡è¿˜èƒ½æ¥å—ã€‚</p>
]]></content>
      <categories>
        <category>éŸ³è§†é¢‘</category>
      </categories>
  </entry>
  <entry>
    <title>MacBook Proå¤–æ¥æ˜¾ç¤ºå™¨(å…­)ä¹‹æˆ‘çš„ç”µè„‘ä¿®å¥½äº†</title>
    <url>/2022/05/08/MacBook%20Pro%E5%A4%96%E6%8E%A5%E6%98%BE%E7%A4%BA%E5%99%A8(%E5%85%AD)%E4%B9%8B%E6%88%91%E7%9A%84%E7%94%B5%E8%84%91%E4%BF%AE%E5%A5%BD%E4%BA%86/</url>
    <content><![CDATA[<p>è‡ªä»ç”µè„‘åäº†ä¹‹åå°±ä¸€ç›´æ²¡æœ‰æ‹¿å»ä¿®ï¼Œæ²¡ç©ºæ˜¯ä¸€æ–¹é¢ï¼Œæ›´å¤šçš„æ˜¯æ‹…å¿ƒä¿®ä¸å¥½è¿˜è¢«å‘ç»´ä¿®è´¹ã€‚å°±è¿™æ ·ç£¨ç£¨è¹­è¹­è¿‡äº†å·®ä¸å¤šå¤§åŠå¹´ï¼Œä»Šå¹´äº”ä¸€æ”¾å‡ä¹Ÿæ²¡å•¥å»å¤„ï¼Œäºæ˜¯æƒ³å¹²è„†å»åå¼ºåŒ—ä¿®ä¸€ä¿®ï¼Œä¸‡ä¸€ä¿®å¥½äº†å‘¢ã€‚æœ¬æ¥æ˜¯æƒ³5æœˆ1æ—¥å»ä¿®çš„ï¼Œç»“æœèµ·å¤ªæ™šäº†ç£¨è¹­åˆ°2ç‚¹æ„Ÿè§‰æœ‰ç‚¹æ™šäº†ï¼Œå°±æƒ³ç€ç¬¬äºŒå¤©å»å§ï¼Œç»“æœç¬¬äºŒå¤©ä¸‹äº†ä¸€å¤©çš„é›¨ï¼Œä¹Ÿæ²¡å»æˆã€‚</p>
<p>5æœˆ3æ—¥å¤©æ°”æœ‰ç‚¹é˜´æ²‰ï¼Œä½†å¥½æ­¹æ²¡ä¸‹é›¨äº†ã€‚äºæ˜¯ä»è§’è½æŠŠç”µè„‘ç¿»å‡ºæ¥å‘ç°ç›–å­éƒ½æœ‰ç‚¹å‘éœ‰äº†ï¼Œç®€å•çš„æ¸…ç†äº†ä¸€ä¸‹ä¾¿è£…è¿›èƒŒåŒ…ï¼Œå‘åå¼ºåŒ—å‡ºå‘ã€‚åå¼ºåŒ—è™½ç„¶ç»è¿‡è¿‡å‡ æ¬¡ï¼Œä½†æ²¡å»é‡Œè¾¹ä¿®è¿‡ä¸œè¥¿ï¼Œå‡ºå‘å‰æœäº†ä¸‹åå¼ºåŒ—ä¿®ç”µè„‘çš„å¸–å­ï¼Œå¹¿å‘Šå¾ˆå¤šï¼Œè¢«éª—è¢«å‘çš„å›ç­”ä¹Ÿå¾ˆå¤šï¼Œå¾ˆå¤šç­”ä¸»è¯´è¦æ…é‡ï¼Œè¯´æœ‰çš„åº—å°±æ˜¯æ‹–ç€ä½ è¯´ä¿®ä¸å¥½è®©ä½ ä½ä»·å–ç»™ä»–ï¼Œæœ‰çš„è¿˜ä¼šå·æ¢ç”µè„‘é›¶ä»¶ï¼Œåæ­£å•¥æ ·çš„éƒ½æœ‰ã€‚çœ‹å®Œä¹‹åè¿˜æ˜¯æœ‰ç‚¹å¿å¿‘çš„ï¼Œå€’ä¸æ˜¯æ€•å·æ¢é›¶ä»¶ï¼Œæ¯•ç«Ÿæˆ‘è¿™ä¸ªç”µè„‘ç”¨äº†6å¹´åŠäº†ä¹Ÿæ²¡å•¥å¥½é›¶ä»¶äº†ï¼Œä¸»è¦æ˜¯æ€•æ¼«å¤©è¦ä»·ï¼Œæ‹–ç€ä¸ä¿®ï¼Œæ‰¯çš®é—¹å¿ƒã€‚</p>
<p>ä¸è¿‡è¿˜æ˜¯å†³å®šå»è¯•ä¸€ä¸‹ï¼Œä¸‹åˆä¸¤ç‚¹åˆ°äº†åå¼ºè·¯Aå‡ºå£ï¼Œä¸€å‡ºæ¥å°±çœ‹åˆ°å‡ å®¶æ‰‹æœºç”µè„‘ç»´ä¿®çš„åº—å­ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“å“ªå®¶å¥½ï¼Œä¹Ÿæ²¡æœ‰å¤šé—®å¤šé€‰ï¼Œç›´æ¥èµ°è¿›äº†ç¬¬ä¸€å®¶ã€‚è¿›å»ä¹‹åæ²¡æœ‰è¯´ä¿®ç”µè„‘çš„äº‹ï¼Œå½“æ—¶æ‰‹æœºæ‹ç…§æœ‰é»‘æ–‘ï¼Œå°±å…ˆé—®äº†ä¸‹æ‰‹æœºçš„é—®é¢˜èƒ½ä¸èƒ½ä¿®ï¼Œç»´ä¿®çš„å‡ ä¸ªäººéƒ½æ˜¯å¹´è½»äººï¼Œè¯´èƒ½ä¿®å¤§æ¦‚160-180å—é’±ï¼Œåªéœ€è¦æ¸…æ´—ä¸€ä¸‹æ‘„åƒå¤´å°±å¯ä»¥å¼„å¥½ã€‚</p>
<p>è¿™é‡Œè¯´ä¸€ä¸‹ç»´ä¿®åº—çš„æ¨¡å¼ï¼ŒåŸºæœ¬ä¸Šåº—é¢éƒ½æ˜¯ä¸€ä¸ªå°é—¨é¢ï¼Œç›¸å½“äºä¸€ä¸ªå°å·¥ä½œå°ï¼Œè¿™é‡Œåªä¼šåšä¸€äº›ç®€å•çš„ç»´ä¿®æ¯”å¦‚æ¢ä¸ªå±ï¼Œè´´ä¸ªè†œï¼Œåˆæ­¥æ£€æµ‹ä¸‹è®¾å¤‡å•¥çš„ï¼Œå¦‚æœé—®é¢˜æ¯”è¾ƒå¤§æˆ–è€…éœ€è¦å…¶ä»–è®¾å¤‡ï¼Œä»–ä»¬ä¼šæ‹¿åˆ°ä»–ä»¬æ‰€è°“çš„ç»´ä¿®é—´é‡Œï¼Œä¸¤ä¸ªåœ°æ–¹æ˜¯æœ‰ä¸€æ®µè·ç¦»çš„è€Œä¸”ä½ æ˜¯ä¸å¯èƒ½è·Ÿç€å»çš„ï¼Œé¡¾å®¢åªèƒ½åœ¨åº—é¢ç­‰ç€ã€‚</p>
<p>è¯è¯´å›æ¥ï¼Œè®©ä»–æ‹†ä¸‹æ‘„åƒå¤´åæˆ‘é—®è¦æ´—å¤šä¹…ï¼Œä»–è¯´å¤§æ¦‚è¦ç­‰1ä¸ªå°æ—¶ã€‚æ„Ÿè§‰è¿˜è¡Œä¾¿é—®è¿™é‡Œèƒ½ä¸èƒ½ä¿®ç”µè„‘ï¼Œä»–è¯´èƒ½ä¿®ç”µè„‘ï¼Œäºæ˜¯æˆ‘æŠŠç”µè„‘ç»™ä»–çœ‹äº†çœ‹ï¼Œå‘Šè¯‰ä»–æ˜¯ä¸»æ¿çƒ§åäº†ï¼Œä»–æ‹¿ç€ä¸‡ç”¨è¡¨æµ‹äº†æµ‹ï¼Œè¯´çš„åŸå› æˆ‘ä¹Ÿè®°ä¸ä½ï¼Œå¤§æ¦‚çš„æ„æ€æ˜¯èŠ¯ç‰‡ä¾›ç”µæ¨¡å—çŸ­è·¯ã€‚</p>
<p>æˆ‘ï¼šä¿®å¥½å¤§æ¦‚è¦å¤šå°‘é’±</p>
<p>ä»–ï¼š550</p>
<p>æˆ‘ï¼šæœ‰ç‚¹è´µ</p>
<p>ä»–ï¼šå·²ç»æ˜¯æœ€ä½ä»·äº†ï¼Œè¿™æ ·å§ï¼ŒåŠ ä¸Šé‚£ä¸ªæ´—æ‘„åƒå¤´çš„è´¹ç”¨ä¸€å…±700æ€ä¹ˆæ ·</p>
<p>æˆ‘ï¼šé‚£è¦ä¿®å¤šä¹…å•Š</p>
<p>ä»–ï¼šå¤§æ¦‚1ä¸ªåŠå°æ—¶</p>
<p>æˆ‘å¿ƒé‡Œæƒ³è¦æ˜¯èƒ½ä¿®å¥½çš„è¯ï¼Œä¹Ÿè¿˜èƒ½æ¥æ”¶ã€‚äºæ˜¯ä¾¿ç­”åº”äº†ï¼Œç”±äºè¦ç­‰1ä¸ªå¤šå°æ—¶ä¹Ÿä¸èƒ½å¹²ç­‰ç€ï¼Œä¾¿å››å¤„é€›äº†ä¸‹ï¼Œåå¼ºåŒ—ç¡®å®åä¸è™šä¼ ï¼Œæ•´ä¸ªä¸€æ¡è¡—ä¸¤è¾¹å…¨æ˜¯æ‰‹æœºç”µè„‘ç»´ä¿®çš„ï¼Œä»ä¸€å¤´èµ°åˆ°å¦ä¸€å¤´ä¼°è®¡å¾—è¦äºŒä¸‰ååˆ†é’Ÿã€‚</p>
<p>ä¸¤ä¸ªå°æ—¶åï¼Œæˆ‘å›åˆ°åº—é‡Œï¼Œä»–ä»¬ä¹Ÿå·²ç»ä¿®å®Œäº†ã€‚æ‰‹æœºæ‘„åƒå¤´è£…ä¸Šï¼Œæ£€æŸ¥äº†ä¸‹é»‘æ–‘æ²¡äº†ï¼Œæ„Ÿè§‰è¿˜æ˜¯æŒºå¼€å¿ƒçš„ã€‚ç”µè„‘ä»–ä¹Ÿå¼€äº†æœºç»™æˆ‘çœ‹äº†ä¸‹ï¼Œæˆ‘ç”¨äº†å‡ åˆ†é’Ÿæ‰“å¼€æµè§ˆå™¨çœ‹äº†ä¸‹è§†é¢‘è°ƒäº†ä¸‹éŸ³é‡äº®åº¦ç­‰æ„Ÿè§‰æ²¡å•¥æ¯›ç—…ï¼Œäºæ˜¯å…³äº†æœºï¼Œä»˜äº†é’±å°±ååœ°é“å›å®¶äº†ã€‚å¿ƒé‡Œæƒ³åå¼ºåŒ—ä¸äºæ˜¯åå¼ºåŒ—æ˜¯çœŸçš„å¼ºã€‚</p>
<p>ç„¶è€Œäº‹æƒ…å¹¶æ²¡æœ‰è¿™ä¹ˆå®Œç¾ï¼Œç”±äºç¬¬ä¸€æ¬¡å»éå®˜æ–¹ä¿®ç”µè„‘æ²¡å•¥ç»éªŒï¼Œä¿®å¥½åè‡ªå·±éƒ½æ²¡æ€ä¹ˆæµ‹è¯•å°±è£…åŒ…å›å®¶äº†ï¼Œè¿™åŸ‹ä¸‹äº†ä¼ç¬”ã€‚äº‹å®ä¸Šåƒä¸»æ¿çƒ§åå¼€ä¸äº†æœºçš„æƒ…å†µï¼Œä¿®å¥½åä¸€å®šè¦å„ç§å¼€å…³æœºçš„æƒ…å†µéƒ½æµ‹è¯•ä¸€ä¸‹æ‰è¡Œã€‚ç­‰æˆ‘åƒå®Œé¥­å›åˆ°å®¶ï¼Œæƒ³æ‰“å¼€æˆ‘ä¹…è¿çš„ç”µè„‘çœ‹çœ‹æ—¶ï¼Œç»“æœä¸€æŒ‰å¼€æœºé”®æ²¡ä»»ä½•ååº”ï¼Œè¯•äº†å¥½å‡ æ¬¡éƒ½æ²¡æœ‰ä»»ä½•ååº”ã€‚å¿ƒé‡ŒçœŸæ˜¯æ—¥äº†ç‹—ï¼Œçœ‹æ¥æ˜å¤©è¿˜å¾—å»ä¸€è¶Ÿã€‚</p>
<p>5æœˆ4æ—¥å¤©æ°”æ™´æœ—ï¼Œæˆ‘ä¸å‡ºæ„æ–™çš„åˆèµ·çš„å¾ˆæ™šå·²ç»12ç‚¹äº†ï¼Œæƒ³æƒ³å°±ä¸åƒæ—©é¤äº†ï¼Œäºæ˜¯ç›´æ¥åƒäº†åˆé¤å°±èƒŒç€åŒ…å»äº†åå¼ºåŒ—ï¼Œåˆ°äº†ä¹‹åå·²ç»1ç‚¹åŠäº†ã€‚ä¸€è¿›åº—æ˜¨å¤©çš„ç»´ä¿®å°å“¥ä¼°è®¡ä¹Ÿæœ‰ç‚¹åƒæƒŠæ€ä¹ˆç¬¬äºŒå¤©å°±æ¥äº†ï¼Œæˆ‘è·Ÿä»–è¯´åº”è¯¥æ²¡ä¿®å¥½ï¼Œè¿˜æ˜¯å¼€ä¸äº†æœºã€‚ä»–æ‹¿è¿‡æœºå™¨æ‹†å¼€ååˆ°å¤„æµ‹äº†æµ‹è¯´å…¶å®æ˜¯èƒ½å¼€æœºæ˜¯è¿æ¥æ˜¾ç¤ºå™¨çš„æŸä¸ªæ¥å£æ¥è§¦ä¸ç¨³å®šå¯¼è‡´ï¼Œ</p>
<p>æˆ‘ï¼šä¿®å¥½å¤§æ¦‚è¦å¤šå°‘é’±</p>
<p>ä»–ï¼š340</p>
<p>æˆ‘ï¼šé‚£è¦ä¿®å¤šä¹…å•Š</p>
<p>ä»–ï¼šä¸¤ä¸ªå°æ—¶</p>
<p>æˆ‘ï¼šç¡®å®šèƒ½ä¿®å¥½å—</p>
<p>ä»–ï¼šè‚¯å®šèƒ½</p>
<p>æˆ‘è¯´è¡Œï¼Œä¸¤ä¸ªå°æ—¶åï¼Œæˆ‘å›æ¥é—®ä»–ä¿®çš„å’‹æ ·äº†ï¼Œä»–å‘Šè¯‰æˆ‘è¯´æ¥è§¦è¿˜æ˜¯ä¸ç¨³å®šï¼Œè¯´è¦æƒ³å®Œå…¨ä¿®å¥½å¾—æ¢æ¥å£ï¼Œå¹¶ä¸€å†å¼ºè°ƒè‚¯å®šå¯ä»¥ä¿®å¥½ã€‚æˆ‘å¿ƒé‡Œä¸€æƒ³å®Œäº†æ˜¯ä¸æ˜¯æ‰å‘é‡Œäº†ã€‚</p>
<p>æˆ‘ï¼šé‚£ä¿®å¥½å¤§æ¦‚è¦å¤šå°‘é’±</p>
<p>ä»–ï¼šæ¢æ¥å£çš„è¯è¦å†å¤šåŠ 430å—ï¼Œä¸€å…±770</p>
<p>æˆ‘ï¼šä½ è¿™ä¹Ÿå¤ªè´µäº†ï¼Œèƒ½ä¸èƒ½ä¾¿å®œç‚¹å•Š</p>
<p>ä»–ï¼šæœ€å°‘700ï¼Œè¿™æ¬¡è‚¯å®šèƒ½ç»™ä½ ä¿®å¥½ï¼Œæˆ‘ä»¬æ‹¿åŸè£…çš„ç»™ä½ æ¢ä¸Šã€‚</p>
<p>æˆ‘ï¼šè¿˜æ˜¯å¤ªè´µäº†ï¼Œæˆ‘ä¸èƒ½æ¥å—ã€‚</p>
<p>ä»–ï¼šè¿™å·²ç»æ˜¯æœ€ä½ä»·äº†ï¼Œå°±æŒ£ä½ ä¸ªæ‰‹å·¥é’±äº†ã€‚</p>
<p>æˆ‘ï¼š500ï¼Œè¡Œä¸è¡Œ</p>
<p>ä»–ï¼š500çœŸä¸è¡Œï¼Œ500æˆ‘éƒ½äºæœ¬äº†ã€‚æ‹¿è´§éƒ½æ‹¿ä¸åˆ°</p>
<p>æˆ‘ï¼šå®è¯è·Ÿä½ è¯´å§ï¼Œç¬¬ä¸€æˆ‘ä¹Ÿä¸æŒ‡æœ›æˆ‘è¿™ç”µè„‘ä¸€å®šè¦ä¿®å¥½æˆ‘ä¸å¯èƒ½æ— ä¸Šé™çš„å»ä¿®è¿™å°ç”µè„‘ï¼ˆäº‹å®ä¸Šæˆ‘æ—©å°±ä¹°äº†æ–°ç”µè„‘äº†ï¼Œä¿®è¿™å°ç”µè„‘å®Œå…¨æ˜¯æƒ…æ€€ï¼‰ï¼Œç¬¬äºŒæˆ‘æœ€å¤šåªèƒ½ç»™åˆ°600å¦‚æœä½ è§‰å¾—è¿˜æ˜¯ä¸è¡Œçš„è¯ï¼Œé‚£å°±åªèƒ½æŠŠæˆ‘ç”µè„‘è¿˜ç»™æˆ‘æˆ‘ååœ°é“å›å»äº†ã€‚</p>
<p>åˆæ˜¯ä¸€é¡¿æ‰¯çš®åï¼Œæœ€ç»ˆä»–ç­”åº”äº†ï¼Œæˆ‘è¯´å°±600å•Šï¼Œå¦‚æœæœ€ååˆè¯´è¿˜æœ‰å…¶ä»–é—®é¢˜åˆè¦æ¢å•¥çš„æˆ‘å¯ä¸å¹²å•Šï¼Œä»–è¯´è¿™ä¸€æ¬¡æ˜¯æ¢ä¸œè¥¿ï¼Œè‚¯å®šèƒ½ä¿®å¥½ã€‚æˆ‘è¯´è¦ä¿®å¤šä¹…ï¼Œä»–ä¸æ•¢è¯´äº†å·®ä¸å¤š2ä¸ªå°æ—¶å§ã€‚æˆ‘çœ‹äº†ä¸‹æ‰‹æœºç°åœ¨4ç‚¹åŠäº†ï¼Œé‚£æˆ‘6ç‚¹åŠå†æ¥ã€‚</p>
<p>ç„¶ååˆæŠŠåå¼ºåŒ—å‘¨è¾¹èµ°äº†ä¸€å¤§åœˆï¼Œè¯´å®è¯åå¼ºåŒ—ç”µå­è¡—äººè¿˜æ˜¯æŒºå¤šçš„ã€‚ç–«æƒ…ä¸‹å¤§å®¶éƒ½å¸¦ç€å£ç½©ï¼Œå–‡å­é‡Œä¸€éåˆä¸€éçš„æ’­æ”¾ç€æ‰“ç–«è‹—é¢†å¥–å“ã€‚å¤•é˜³è¥¿ä¸‹ï¼Œç†™ç†™æ”˜æ”˜ï¼Œä¸è¿‡å¿«ä¹æ˜¯ä»–ä»¬çš„ã€‚</p>
<p>å·®ä¸å¤š6ç‚¹45ï¼Œæˆ‘å›åˆ°äº†åº—é‡Œï¼Œé—®ä»–ä¿®çš„å’‹æ ·äº†ï¼Œä»–è¯´å¿«äº†åœ¨æµ‹è¯•äº†ï¼Œç»“æœä¸€ç›´ç­‰åˆ°7ç‚¹åŠï¼Œç»ˆäºä»–è¯´æµ‹è¯•å¥½äº†ï¼Œä¸€ä¼šç»™æˆ‘æ‹¿è¿‡æ¥ã€‚æ‹¿è¿‡æ¥åç¡®å®å¯ä»¥å¼€æœºäº†ï¼Œç„¶åç”µè„‘ç»™åˆ°æˆ‘ï¼Œæˆ‘ç°åœ¨æ”¾èªæ˜äº†ï¼Œå„ç§å¼€å…³æœºæµ‹è¯•ï¼Œæ­£å¸¸å¼€å…³æœºï¼Œå¼ºåˆ¶å¼€å…³æœºï¼Œæµ‹äº†åå¤šåˆ†é’Ÿï¼ŒæœŸé—´ä»–è¯´å“ªæœ‰ä½ è¿™ä¹ˆæµ‹çš„ï¼Œæˆ‘è¯´è¦æ˜¯çœŸä¿®å¥½äº†è‚¯å®šæ²¡é—®é¢˜çš„ï¼Œæœ€åç¡®è®¤æ²¡å•¥é—®é¢˜åï¼Œæˆ‘åˆä»”ç»†æ£€æŸ¥äº†ä¸‹å¤–è§‚ï¼Œå‘ç°åç›–æœ‰å‡ ä¸ªèºä¸æ²¡æ‹§å¥½ï¼Œåˆè®©ä»–ä»¬æ‹§å¥½ï¼Œæœ€åä»˜äº†é’±ã€‚</p>
<p>èƒŒä¸ŠèƒŒåŒ…ï¼Œåˆ°äº†è¿™ä¸ªç‚¹éƒ½æœ‰äº›é¥¿äº†ï¼Œäºæ˜¯åœ¨å‘¨è¾¹åƒäº†é¥­æ‰å›å»äº†ã€‚è¿™æ¬¡ä¿®ç”µè„‘æ€»å…±ä¿®äº†æˆ‘1150ï¼Œç­‰äº†7ä¸ªå°æ—¶ï¼Œä¸è¿‡æ€»ç®—æ˜¯ä¿®å¥½äº†ï¼Œä¹Ÿè¿˜èƒ½æ¥å—ã€‚</p>
<p>è¯´ä¸€ä¸‹è¿™æ¬¡ä¿®ç”µè„‘çš„æ„Ÿæ‚Ÿï¼š</p>
<ol>
<li>å…³äºè‹¹æœç”µè„‘ç»´ä¿®ã€‚è‹¹æœç”µè„‘æ˜¯ä¸€å¹´æ•´æœºä¿ä¿®ï¼Œä¸¤å¹´ä¸»è¦éƒ¨ä»¶ä¿ä¿®ï¼ˆä¸»è¦éƒ¨ä»¶åŒ…æ‹¬ä¸»æ¿ (MLB)ã€å¤„ç†å™¨ (CPU)ã€å†…å­˜ã€ç¡¬ç›˜ (HDD/SSD)ã€ç”µæºé€‚é…å™¨ã€é”®ç›˜å’Œæ˜¾ç¤ºå± (LCD)ï¼‰ï¼Œç”µæ± æ˜¯ä¸ç®—çš„ã€‚å¦‚æœä½ çš„ç”µè„‘æ˜¯ä¸¤å¹´å†…å‡ºé—®é¢˜äº†æœ€å¥½å»è‹¹æœç›´è¥åº—ä¹Ÿå°±æ˜¯å¤©æ‰å§é¢„çº¦ç»´ä¿®ï¼ŒåŸºæœ¬ä¸Šéäººä¸ºåŸå› éƒ½ä¸ç”¨å‡ºé’±ã€‚ä¸¤å¹´~ä¸‰å¹´å†…å»ºè®®è¿˜æ˜¯åˆ°å®˜æ–¹ç»´ä¿®ï¼Œè™½ç„¶è´µä½†æ˜¯æœ‰ä¿éšœï¼ˆä¸è¿‡æ˜¯çœŸçš„è´µçœ‹æƒ…å†µå§ï¼‰ã€‚3å¹´ä»¥ä¸Šçš„åˆ°å¤–é¢ä¿®è¿˜æ˜¯ä¾¿å®œä¸€ç‚¹ä¸è¿‡ä¿éšœè‚¯å®šä¸å¦‚åŸå‚ã€‚</li>
<li>åå¼ºåŒ—ä¹Ÿæ²¡æœ‰ç½‘ä¸Šè¯´çš„é‚£ä¹ˆå¦–é­”é¬¼æ€ªã€‚å°é©¬è¿‡æ²³çš„è¯¾æ–‡å¤§å®¶åº”è¯¥éƒ½å­¦è¿‡ï¼Œæœ‰æ—¶å€™è¿˜æ˜¯å¾—äº²è‡ªè¯•ä¸€ä¸‹æ‰çŸ¥é“ï¼Œåˆ«äººçš„æ„è§å¯ä»¥ä½œä¸ºå‚è€ƒç•™ä¸ªå¿ƒçœ¼ã€‚ä¸ªäººæ„Ÿè§‰è¿˜è¡Œåå¼ºåŒ—è¿˜æ˜¯æœ‰ç‚¹æŠ€æœ¯çš„ï¼Œå½“ç„¶é‡Œé¢çš„å¥—è·¯åº”è¯¥è¿˜æ˜¯æœ‰çš„ã€‚</li>
<li>ä¿®å¥½åè‡ªå·±æ£€æµ‹çš„æ—¶å€™è¦æ ¹æ®é—®é¢˜é’ˆå¯¹æ€§çš„ä»”ç»†æµ‹è¯•ã€‚</li>
<li>ä¿®ç”µè„‘è¿˜æ˜¯å‡æœŸå»ï¼Œåšå¥½å‡†å¤‡ï¼Œæ¯•ç«Ÿä¸æ˜¯ä¸€ä¸‹å°±èƒ½ä¿®å¥½çš„ã€‚</li>
</ol>
<p>æœ€åé™„ä¸€å¼ ä¿®å¥½åçš„å›¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/IMG_3562.jpg" alt=""></p>
]]></content>
      <categories>
        <category>Life</category>
      </categories>
  </entry>
  <entry>
    <title>hexo nextä¸»é¢˜ç»™æ–‡ç« æ·»åŠ ç‰ˆæƒä¿¡æ¯</title>
    <url>/2022/05/07/hexo-next%E4%B8%BB%E9%A2%98%E7%BB%99%E6%96%87%E7%AB%A0%E6%B7%BB%E5%8A%A0%E7%89%88%E6%9D%83%E4%BF%A1%E6%81%AF/</url>
    <content><![CDATA[<h2 id="nextä¸»é¢˜ä¸‹ç»™æ–‡ç« æ·»åŠ ç‰ˆæƒä¿¡æ¯"><a href="#nextä¸»é¢˜ä¸‹ç»™æ–‡ç« æ·»åŠ ç‰ˆæƒä¿¡æ¯" class="headerlink" title="nextä¸»é¢˜ä¸‹ç»™æ–‡ç« æ·»åŠ ç‰ˆæƒä¿¡æ¯"></a>nextä¸»é¢˜ä¸‹ç»™æ–‡ç« æ·»åŠ ç‰ˆæƒä¿¡æ¯</h2><p>1ã€ä¿®æ”¹<code>_config.yml</code>æ–‡ä»¶</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">creative_commons:</span></span><br><span class="line">  <span class="attr">license:</span> <span class="string">by-nc-sa</span></span><br><span class="line">  <span class="attr">sidebar:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">post:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">language:</span></span><br></pre></td></tr></table></figure>
<p>postçš„å€¼æ”¹ä¸ºtrueè¡¨ç¤ºæ–‡ç« å¼€å¯æ·»åŠ ç‰ˆæƒä¿¡æ¯ã€‚</p>
<p>è‡³æ­¤ï¼Œéƒ¨ç½²åå°±å¯ä»¥çœ‹åˆ°æ¯ç¯‡æ–‡ç« ä¸‹é¢éƒ½ä¼šæœ‰ç‰ˆæƒä¿¡æ¯äº†ã€‚ä½†æ˜¯æœ‰ä¸€äº›æ–‡ç« æˆ‘ä»¬ä¸æƒ³æ·»åŠ ç‰ˆæƒä¿¡æ¯ï¼Œé‚£ä¹ˆè¿˜éœ€è¦æ¥ç€è®¾ç½®ï¼š</p>
<p>2ã€æ‰“å¼€æ–‡ä»¶ <code>themes/next/layout/_macro/post.swig</code> ï¼š</p>
<p>æ‰¾åˆ°creative_commonsé‚£ä¸€è¡Œæ”¹ä¸ºï¼š</p>
<figure class="highlight handlebars"><table><tr><td class="code"><pre><span class="line"><span class="language-xml">&#123;%- if theme.creative_commons.license and theme.creative_commons.post and page.copyright %&#125;</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name"><span class="built_in">partial</span></span>(<span class="name">&#x27;_partials/post/post-copyright.swig&#x27;</span>) &#125;&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">&#123;%- endif %&#125;</span></span><br></pre></td></tr></table></figure>
<p>å°±æ˜¯æ·»åŠ äº† page.copyright ï¼Œè¿™æ ·å°±å¯ä»¥å•ç‹¬æ§åˆ¶æŸç¯‡æ–‡ç« æ˜¯å¦æ·»åŠ ç‰ˆæƒä¿¡æ¯äº†ã€‚</p>
<p>åœ¨æ–‡ç« å¼€å¤´çš„å¤´éƒ¨æ·»åŠ  <code>copyright: true</code> è¡¨ç¤ºå½“å‰æ–‡ç« è¦æ·»åŠ ç‰ˆæƒä¿¡æ¯ï¼Œfalseè¡¨ç¤ºä¸éœ€è¦ã€‚</p>
<p>å¯ä»¥ä¿®æ”¹æ¨¡æ¿æ–‡ä»¶ï¼Œè¿™æ ·é»˜è®¤å°±æœ‰ <code>copyright: true</code></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://choubin.site/2019/12/30/CustomBlogTheme/">hexo ä¸ªäººåšå®¢åŸºäº NexT ä¸»é¢˜çš„åŸºæœ¬é…ç½®å’Œå®šåˆ¶ä¼˜åŒ–</a></p>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
  </entry>
  <entry>
    <title>iOSå®šæ—¶å™¨æ‚è®°</title>
    <url>/2022/05/01/iOS%E5%AE%9A%E6%97%B6%E5%99%A8%E6%9D%82%E8%AE%B0/</url>
    <content><![CDATA[<h2 id="NSTimer"><a href="#NSTimer" class="headerlink" title="NSTimer"></a>NSTimer</h2><p>NSTimeræ˜¯ä½¿ç”¨æœ€å¤šçš„ä¸€ç§å®šæ—¶å™¨ï¼Œè™½ç„¶ä½†æ˜¯NSTimerè¿˜æ˜¯æœ‰å¾ˆå¤šçš„æ³¨æ„äº‹é¡¹ï¼š</p>
<ol>
<li><p>ä¸æ³¨æ„ä½¿ç”¨çš„è¯æœ‰å¾ªç¯å¼•ç”¨çš„éšæ‚£ã€‚å› ä¸ºNSTimerä¼šå¼ºå¼•ç”¨targetï¼Œå¦‚æœtargetå†å¼ºå¼•ç”¨NSTimeré‚£ä¹ˆå°±ä¼šå‘ç”Ÿå¾ªç¯å¼•ç”¨ã€‚æ¯”å¦‚ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)test_normal_timer1 &#123;</span><br><span class="line">    <span class="keyword">self</span>.normalStrongTimer = [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">1</span> target:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(doSome) userInfo:<span class="literal">nil</span> repeats:<span class="literal">YES</span>];</span><br><span class="line">    [[<span class="built_in">NSRunLoop</span> currentRunLoop] addTimer:<span class="keyword">self</span>.normalStrongTimer forMode:<span class="built_in">NSRunLoopCommonModes</span>];</span><br><span class="line">    [<span class="keyword">self</span>.normalStrongTimer fire];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç å°±ä¼šå‘ç”Ÿå¾ªç¯å¼•ç”¨ã€‚æ­¤æ—¶å³ä½¿é¡µé¢è¿”å›ï¼Œä½†æ˜¯å› ä¸ºå¾ªç¯å¼•ç”¨ï¼ŒViewControllerçš„deallocå°†ä¸ä¼šè¢«æ‰§è¡Œï¼Œå› æ­¤invalidateä¸èƒ½æ”¾åœ¨deallocé‡Œï¼Œåªèƒ½åœ¨å…¶ä»–æ—¶æœºæ¯”å¦‚viewDidDisappearé‡Œè°ƒç”¨ã€‚æ‰€ä»¥ä¸€èˆ¬ä½¿ç”¨weakæ¥å¼±å¼•ç”¨å®šæ—¶å™¨ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨deallocé‡Œè°ƒç”¨invalidateã€‚</p>
</li>
<li><p>éœ€è¦åœ¨åˆé€‚çš„åœ°æ–¹invalidå®šæ—¶å™¨ï¼Œå¦åˆ™å®šæ—¶å™¨ä¼šä¸€ç›´å¼ºå¼•ç”¨targetä»è€Œå»¶é•¿targetçš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
<p>åœ¨å¼€å‘ä¸­å¾ˆå®¹æ˜“å¿˜è®°invalidå®šæ—¶å™¨ï¼Œä¸€æ—¦å¿˜è®°invalidå®šæ—¶å™¨ï¼Œå®šæ—¶å™¨å°±ä¼šå»¶é•¿targetçš„ç”Ÿå‘½å‘¨æœŸï¼Œæ¯”å¦‚é¡µé¢è¿”å›äº†ä½†å®é™…è¿˜æ²¡æœ‰è¢«é”€æ¯ï¼Œä»è€Œäº§ç”Ÿä¸€äº›è¯¡å¼‚é—®é¢˜ã€‚è¿™ä¹Ÿæ˜¯ä½¿ç”¨NSTimerå¿…é¡»æ³¨æ„çš„åœ°æ–¹ã€‚</p>
</li>
<li><p>ä½¿ç”¨æ—¶å¿…é¡»ä¿è¯æœ‰ä¸€ä¸ªæ´»è·ƒçš„runloopï¼Œå¹¶ä¸”éœ€è¦æŒ‡å®šmodeã€‚å› æ­¤åœ¨å­çº¿ç¨‹ä¸­ä½¿ç”¨ä¸æ˜¯å¾ˆæ–¹ä¾¿ã€‚</p>
</li>
<li><p>ç²¾åº¦å¯èƒ½ä¸å¤Ÿã€‚</p>
</li>
<li><p>ç½‘ä¸Šçš„ä¸€ä¸ªè¯´æ³•ï¼šåˆ›å»ºå’Œæ’¤é”€å¿…é¡»åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸Šï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä½¿ç”¨ä¸ä¾¿ã€‚(è¿™ä¸€æ¡å­˜ç–‘ï¼Œç»è¿‡éªŒè¯åœ¨å­çº¿ç¨‹åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼Œåœ¨å¦ä¸€ä¸ªå­çº¿ç¨‹invalidateå¹¶æ²¡æœ‰å‘ç°æœ‰ä»€ä¹ˆé—®é¢˜)</p>
</li>
<li><p>iOS10å¼€å§‹æ”¯æŒblockä½¿ç”¨ï¼ŒåŒæ ·åœ¨ä½¿ç”¨blockæ—¶ä¸€å®šè¦æ³¨æ„å¾ªç¯å¼•ç”¨ã€‚</p>
</li>
</ol>
<p>ä¸ºäº†ä»æ ¹æœ¬ä¸Šé¿å…ä¸Šè¿°é—®é¢˜ï¼Œä¸€ä¸ªå¼±å¼•ç”¨targetçš„ã€èƒ½å¤Ÿåœ¨è‡ªèº«é”€æ¯æ—¶è‡ªåŠ¨invalidçš„å®šæ—¶å™¨æƒ³å¿…æ˜¯æå¥½çš„ã€‚è§£å†³åŠæ³•å°±æ˜¯å°è£…GCDå®šæ—¶å™¨ã€‚</p>
<h2 id="GCDå®šæ—¶å™¨"><a href="#GCDå®šæ—¶å™¨" class="headerlink" title="GCDå®šæ—¶å™¨"></a>GCDå®šæ—¶å™¨</h2><p>åŸºæœ¬ä½¿ç”¨ï¼š</p>
<p>1.åˆ›å»ºå®šæ—¶å™¨æº</p>
<figure class="highlight autohotkey"><table><tr><td class="code"><pre><span class="line">self.timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER,</span><br><span class="line"><span class="built_in">                                            0,</span></span><br><span class="line"><span class="built_in">                                            0,</span></span><br><span class="line">                                            self.privateSerialQueue)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>2.è®¾ç½®å®šæ—¶å™¨</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">int64</span>_t <span class="built_in">int</span>ervalInNanoseconds = (<span class="built_in">int64</span>_t)(self.timeInterval * NSEC_PER_SEC);</span><br><span class="line"><span class="built_in">int64</span>_t toleranceInNanoseconds = (<span class="built_in">int64</span>_t)(self.tolerance * NSEC_PER_SEC);</span><br><span class="line"></span><br><span class="line">dispatch_source_set_timer(self.timer,</span><br><span class="line">                          dispatch_time(DISPATCH_TIME_NOW, <span class="built_in">int</span>ervalInNanoseconds),</span><br><span class="line">                          (<span class="built_in">uint64</span>_t)<span class="built_in">int</span>ervalInNanoseconds,</span><br><span class="line">                          toleranceInNanoseconds</span><br><span class="line">                          );</span><br></pre></td></tr></table></figure>
<p>3.è®¾ç½®äº‹ä»¶å›è°ƒ</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">dispatch_source_set_event_handler</span>(self.timer, ^&#123;</span><br><span class="line">    <span class="selector-attr">[weakSelf timerFired]</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>4.å¯åŠ¨å®šæ—¶å™¨</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="built_in">dispatch_resume</span>(self.timer);</span><br></pre></td></tr></table></figure>
<p>5.æ’¤é”€å®šæ—¶å™¨</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="built_in">dispatch_source_cancel</span>(timer);</span><br></pre></td></tr></table></figure>
<h2 id="é—®ç­”"><a href="#é—®ç­”" class="headerlink" title="é—®ç­”"></a>é—®ç­”</h2><h3 id="1-åœ¨å­çº¿ç¨‹ä¸­ä½¿ç”¨å®šæ—¶å™¨"><a href="#1-åœ¨å­çº¿ç¨‹ä¸­ä½¿ç”¨å®šæ—¶å™¨" class="headerlink" title="1. åœ¨å­çº¿ç¨‹ä¸­ä½¿ç”¨å®šæ—¶å™¨"></a>1. åœ¨å­çº¿ç¨‹ä¸­ä½¿ç”¨å®šæ—¶å™¨</h3><p>æœ€ä½³å®è·µå°±æ˜¯ä½¿ç”¨GCDå®šæ—¶å™¨ï¼Œå› ä¸ºGCDå®šæ—¶å™¨ä¸éœ€è¦æ·»åŠ åœ¨runloopä¸­ï¼Œå¹¶ä¸”æœ¬èº«ä¹Ÿæ”¯æŒæŒ‡å®šäº‹ä»¶å›è°ƒçš„æ´¾å‘é˜Ÿåˆ—ã€‚</p>
<p>å¦‚æœä½ éå¾—ä½¿ç”¨NSTimer+NSThreadï¼Œé‚£ä¹ˆå¿…é¡»æ³¨æ„runloopçš„æ“ä½œã€‚runloopæœ‰ä¸‹é¢ä¸‰ç§å¼€å¯æ–¹å¼ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)run; </span><br><span class="line">- (<span class="type">void</span>)runUntilDate:(<span class="built_in">NSDate</span> *)limitDate;</span><br><span class="line">- (<span class="type">BOOL</span>)runMode:(<span class="built_in">NSRunLoopMode</span>)mode beforeDate:(<span class="built_in">NSDate</span> *)limitDate;</span><br></pre></td></tr></table></figure>
<p>runï¼šå¯åŠ¨å‰å¦‚æœæ²¡æœ‰æ·»åŠ ä»»ä½•æºé‚£ä¹ˆrunloopä¸€å¯åŠ¨å°±ä¼šé©¬ä¸Šé€€å‡ºï¼Œæ–¹æ³•ä¹Ÿä¼šé©¬ä¸Šè¿”å›ï¼ˆä¸‰ç§æ–¹å¼éƒ½éµå®ˆï¼‰ã€‚è€Œå¦‚æœæœ‰æ·»åŠ æºåˆ™runloopå°†ä¸€ç›´è¿è¡Œï¼Œä¸ä¼šé€€å‡ºã€‚å³ä½¿æ‰‹åŠ¨ç§»é™¤äº†æºï¼Œä¹Ÿä¸ä¼šä½¿å¾—runloopä¼šé€€å‡ºã€‚</p>
<p>runUntilDateï¼šå’Œrunå·®ä¸å¤šï¼Œåªæ˜¯å¤šäº†ä¸€ä¸ªæˆªæ­¢æ—¥æœŸã€‚æˆªæ­¢æ—¥æœŸåˆ°äº†ï¼Œåˆ™é€€å‡ºrunloopï¼Œæ–¹æ³•è¿”å›ã€‚</p>
<p>runModeï¼šè¿è¡Œä¸€æ¬¡runloopåä¼šé€€å‡ºã€‚æ¯”å¦‚runloopæœŸé—´å¤„ç†äº†ä¸€ä¸ªè¾“å…¥æºäº‹ä»¶ï¼Œå¤„ç†åä¼šé€€å‡ºrunloopï¼Œæ–¹æ³•ä¹Ÿä¼šè¿”å›ã€‚æ³¨æ„å¤„ç†å®šæ—¶å™¨äº‹ä»¶ä¸ä¼šä½¿å¾—runloopé€€å‡ºï¼Œä½†å¦‚æœè°ƒç”¨invalidateåˆ™ä¼šé€€å‡ºã€‚æ‰€ä»¥å¦‚æœä½ æƒ³è®©runloopèƒ½å¤Ÿé€€å‡ºçš„è¯æœ€å¥½ä½¿ç”¨è¯¥æ–¹æ³•ã€‚</p>
<p>å‰é¢ä¸¤ç§æ–¹æ³•å³ä½¿è°ƒç”¨ <code>[self.timer invalidate];</code> ï¼Œrunloopä¹Ÿä¸ä¼šé€€å‡ºï¼ˆå°‘é‡æƒ…å†µä¸‹ä¹Ÿä¼šé€€å‡ºï¼‰ï¼Œè¿™æ ·çº¿ç¨‹å°±ä¼šä¸€ç›´å­˜åœ¨ï¼Œ</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">//çº¿ç¨‹ä¹Ÿæ˜¯ä¼šå¼ºå¼•ç”¨targetçš„ï¼Œæ‰€ä»¥è¿™é‡Œçº¿ç¨‹å’Œselfå¾ªç¯å¼•ç”¨äº†ã€‚</span></span><br><span class="line"><span class="keyword">self</span>.thread = [[<span class="built_in">NSThread</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(createTimer1) object:<span class="literal">nil</span>];</span><br><span class="line">[<span class="keyword">self</span>.thread start];</span><br></pre></td></tr></table></figure>
<p>çº¿ç¨‹ä¸€ç›´å­˜åœ¨å°±ä¼šä¸€ç›´æŒæœ‰selfï¼Œå¯¼è‡´é¡µé¢å³ä½¿è¿”å›äº†ä¹Ÿä¸ä¼šé”€æ¯ã€‚è€Œå¦‚æœåœ¨å½“å‰çº¿ç¨‹ä¸­å¼ºè¡Œè°ƒç”¨ <code>+ (void)exit;</code> é€€å‡ºçº¿ç¨‹ï¼Œä¼šå› ä¸ºä¸€äº›èµ„æºæ²¡æœ‰æ­£å¸¸é‡Šæ”¾è€Œé€ æˆå†…å­˜æ³„éœ²ï¼Œç»è¿‡éªŒè¯selfä¾ç„¶æ˜¯æ²¡æœ‰è¢«é‡Šæ”¾çš„ã€‚æ‰€ä»¥åªèƒ½ä½¿ç”¨ç¬¬ä¸‰ç§å¯åŠ¨æ–¹å¼ã€‚</p>
<p>å› æ­¤ï¼Œåœ¨å­çº¿ç¨‹ä¸­ä½¿ç”¨å®šæ—¶å™¨ï¼Œæœ€ä½³å®è·µå°±æ˜¯ä½¿ç”¨GCDå®šæ—¶å™¨ã€‚</p>
<h3 id="2-ä¸ºä»€ä¹ˆMSWeakTimerçš„invalidateæ–¹æ³•é‡Œå¿…é¡»æ˜¯å¼‚æ­¥å–æ¶ˆï¼ŒåŒæ­¥å–æ¶ˆä¸è¡Œå—ï¼Ÿ"><a href="#2-ä¸ºä»€ä¹ˆMSWeakTimerçš„invalidateæ–¹æ³•é‡Œå¿…é¡»æ˜¯å¼‚æ­¥å–æ¶ˆï¼ŒåŒæ­¥å–æ¶ˆä¸è¡Œå—ï¼Ÿ" class="headerlink" title="2.ä¸ºä»€ä¹ˆMSWeakTimerçš„invalidateæ–¹æ³•é‡Œå¿…é¡»æ˜¯å¼‚æ­¥å–æ¶ˆï¼ŒåŒæ­¥å–æ¶ˆä¸è¡Œå—ï¼Ÿ"></a>2.ä¸ºä»€ä¹ˆMSWeakTimerçš„invalidateæ–¹æ³•é‡Œå¿…é¡»æ˜¯å¼‚æ­¥å–æ¶ˆï¼ŒåŒæ­¥å–æ¶ˆä¸è¡Œå—ï¼Ÿ</h3><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)invalidate</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// We check with an atomic operation if it has already been invalidated. Ideally we would synchronize this on the private queue,</span></span><br><span class="line">    <span class="comment">// but since we can&#x27;t know the context from which this method will be called, dispatch_sync might cause a deadlock.</span></span><br><span class="line">    <span class="keyword">if</span> (!OSAtomicTestAndSetBarrier(<span class="number">7</span>, &amp;_timerFlags.timerIsInvalidated))</span><br><span class="line">    &#123;</span><br><span class="line">        dispatch_source_t timer = <span class="keyword">self</span>.timer;</span><br><span class="line">        <span class="built_in">dispatch_async</span>(<span class="keyword">self</span>.privateSerialQueue, ^&#123;</span><br><span class="line">            dispatch_source_cancel(timer);</span><br><span class="line">            ms_release_gcd_object(timer);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­£å¦‚æ³¨é‡Šå†™çš„ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å›è°ƒçš„æ–¹æ³•é‡Œè°ƒç”¨invalidateæ–¹æ³•ï¼Œé‚£ä¹ˆå°†å¯¼è‡´é˜Ÿåˆ—æ­»é”ã€‚æ‰€ä»¥è¿™é‡Œå¿…é¡»é‡‡ç”¨å¼‚æ­¥invalidateã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.jianshu.com/p/aeae7b73aee2">Dispatch Sourceå­¦ä¹ </a></p>
<p><a href="http://blog.lessfun.com/blog/2016/08/05/reliable-timer-in-ios/">æ›´å¯é å’Œé«˜ç²¾åº¦çš„ iOS å®šæ—¶å™¨</a></p>
<p><a href="https://blog.csdn.net/qianlima210210/article/details/54799476">dispatch sourceç†è§£</a></p>
<p><a href="https://juejin.cn/post/6844903486677581831">NSRunLoopçš„é€€å‡ºæ–¹å¼</a> æŒºä¸é”™çš„</p>
<p><a href="https://juejin.cn/post/6844903775816122375">å…³äº performSelector çš„ä¸€äº›å°æ¢è®¨</a></p>
]]></content>
      <categories>
        <category>Foundation</category>
      </categories>
      <tags>
        <tag>NSTimer</tag>
        <tag>å®šæ—¶å™¨</tag>
      </tags>
  </entry>
  <entry>
    <title>HTTPå„ç‰ˆæœ¬ç‰¹æ€§</title>
    <url>/2022/03/28/HTTP%E5%90%84%E7%89%88%E6%9C%AC%E7%89%B9%E6%80%A7/</url>
    <content><![CDATA[<h3 id="HTTPå„ç‰ˆæœ¬ç‰¹æ€§"><a href="#HTTPå„ç‰ˆæœ¬ç‰¹æ€§" class="headerlink" title="HTTPå„ç‰ˆæœ¬ç‰¹æ€§"></a>HTTPå„ç‰ˆæœ¬ç‰¹æ€§</h3><h4 id="HTTP-0-9"><a href="#HTTP-0-9" class="headerlink" title="HTTP 0.9"></a>HTTP 0.9</h4><p>1991å¹´å‘å¸ƒ</p>
<p>åŸºæœ¬ä¸Šåªæ˜¯ä¸€ä¸ªè‰ç¨¿ï¼Œè®¾è®¡çš„åˆè¡·åªæ˜¯ä¸ºäº†è·å–ç®€å•çš„HTMLå¯¹è±¡ã€‚åªæ”¯æŒGETã€‚æ²¡æ€ä¹ˆä½¿ç”¨å°±è¢«HTTP 1.0ä»£æ›¿äº†ã€‚</p>
<h4 id="HTTP-1-0"><a href="#HTTP-1-0" class="headerlink" title="HTTP 1.0"></a>HTTP 1.0</h4><p>1996å¹´5æœˆå‘å¸ƒè§„èŒƒ rfc1945</p>
<p>ç¬¬ä¸€ä¸ªå¹¿æ³›ä½¿ç”¨çš„ç‰ˆæœ¬ã€‚</p>
<p><strong>ç›¸æ¯”HTTP 0.9</strong>ï¼š</p>
<ol>
<li><p>å¢åŠ äº†å¯¹å¤šåª’ä½“å¯¹è±¡çš„å¤„ç†ï¼Œä»»ä½•æ ¼å¼çš„å†…å®¹éƒ½å¯ä»¥å‘é€ã€‚è¿™ä½¿å¾—äº’è”ç½‘ä¸ä»…å¯ä»¥ä¼ è¾“æ–‡å­—ï¼Œè¿˜èƒ½ä¼ è¾“å›¾åƒã€è§†é¢‘ã€äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p>
</li>
<li><p>å¢åŠ äº†ä¸€äº›æ–¹æ³•ï¼šPOSTï¼ŒHEADã€‚ä¸°å¯Œäº†æµè§ˆå™¨ä¸æœåŠ¡å™¨çš„äº’åŠ¨æ‰‹æ®µã€‚</p>
</li>
<li><p>æ–°å¢äº†HTTPé¦–éƒ¨ã€‚æ¯”è¾ƒé‡è¦çš„æœ‰Content-Type ï¼ŒContent-Lengthï¼ŒContent-Encoding</p>
</li>
<li><p>HTTPè¯·æ±‚å’Œå“åº”æ ¼å¼çš„æ”¹å˜ã€‚</p>
</li>
<li><p>å…¶ä»–æ–°å¢åŠŸèƒ½ã€‚æ¯”å¦‚çŠ¶æ€ç çš„å®šä¹‰ã€‚</p>
</li>
</ol>
<p>è¯·æ±‚æŠ¥æ–‡ï¼š</p>
<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">è¯·æ±‚è¡Œ  egï¼šGET <span class="symbol">/u/2167612f3a86</span> HTTP<span class="symbol">/1.1</span></span><br><span class="line">è¯·æ±‚å¤´</span><br><span class="line"></span><br><span class="line">è¯·æ±‚ä½“</span><br></pre></td></tr></table></figure>
<p>å“åº”æŠ¥æ–‡ï¼š</p>
<figure class="highlight dns"><table><tr><td class="code"><pre><span class="line">å“åº”è¡Œ  egï¼šHTTP/<span class="number">1.1 200</span> OK</span><br><span class="line">å“åº”å¤´</span><br><span class="line"></span><br><span class="line">å“åº”ä½“</span><br></pre></td></tr></table></figure>
<p><strong>HTTP/1.0 ç¼ºç‚¹ï¼š</strong></p>
<p>HTTP/1.0 ç‰ˆçš„ä¸»è¦ç¼ºç‚¹æ˜¯ï¼Œæ¯ä¸ªTCPè¿æ¥åªèƒ½å‘é€ä¸€ä¸ªè¯·æ±‚ã€‚å‘é€æ•°æ®å®Œæ¯•ï¼Œè¿æ¥å°±å…³é—­ï¼Œå¦‚æœè¿˜è¦è¯·æ±‚å…¶ä»–èµ„æºï¼Œå°±å¿…é¡»å†æ–°å»ºä¸€ä¸ªè¿æ¥ã€‚</p>
<p>TCPè¿æ¥çš„æ–°å»ºæˆæœ¬å¾ˆé«˜ï¼Œå› ä¸ºéœ€è¦å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¸‰æ¬¡æ¡æ‰‹ï¼Œå¹¶ä¸”å¼€å§‹æ—¶å‘é€é€Ÿç‡è¾ƒæ…¢ï¼ˆslow startï¼‰ã€‚æ‰€ä»¥ï¼ŒHTTP 1.0ç‰ˆæœ¬çš„æ€§èƒ½æ¯”è¾ƒå·®ã€‚éšç€ç½‘é¡µåŠ è½½çš„å¤–éƒ¨èµ„æºè¶Šæ¥è¶Šå¤šï¼Œè¿™ä¸ªé—®é¢˜å°±æ„ˆå‘çªå‡ºäº†ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåœ¨è¿˜æ²¡å‡ºHTTP/1.1è§„èŒƒæ—¶ï¼Œå„ä¸ªå…¬å¸å¯èƒ½ä¼šæœ‰ä¸€äº›è‡ªå·±çš„ä¼˜åŒ–æ‰‹æ®µã€‚æœ‰äº›æµè§ˆå™¨åœ¨è¯·æ±‚æ—¶ï¼Œç”¨äº†ä¸€ä¸ªéæ ‡å‡†çš„<code>Connection</code>å­—æ®µã€‚</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Connection</span>: keep-alive</span><br><span class="line"><span class="keyword">Connection</span>: <span class="keyword">close</span></span><br></pre></td></tr></table></figure>
<p>Connectionå¤´éƒ¨ï¼Œç”¨äºå†³å®šå½“å‰çš„äº‹åŠ¡å®Œæˆåï¼Œæ˜¯å¦ä¼šå…³é—­ç½‘ç»œè¿æ¥ã€‚</p>
<p>å¦‚æœè¯¥å€¼æ˜¯â€œkeep-aliveâ€ï¼Œç½‘ç»œè¿æ¥å°±æ˜¯æŒä¹…çš„ï¼Œä¸ä¼šå…³é—­ï¼Œä½¿å¾—<strong>å¯¹åŒä¸€ä¸ªæœåŠ¡å™¨çš„è¯·æ±‚</strong>å¯ä»¥ç»§ç»­åœ¨è¯¥è¿æ¥ä¸Šå®Œæˆã€‚</p>
<p>å¦‚æœè¯¥å€¼æ˜¯â€œcloseâ€è¡¨æ˜å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨æƒ³è¦å…³é—­è¯¥ç½‘ç»œè¿æ¥ã€‚</p>
<p>åƒè¿™ç§åšçš„æ¯”è¾ƒå¥½çš„ä¼˜åŒ–å¯èƒ½å°±ä¼šè¢«æ”¾åˆ°ä¸‹ä¸€æ¬¡çš„RFCè§„èŒƒä¸­å»ã€‚Connectionå¤´éƒ¨å°±è¢«HTTP/1.1è§„èŒƒæ‰€é‡‡ç”¨ã€‚</p>
<h4 id="HTTP-1-1"><a href="#HTTP-1-1" class="headerlink" title="HTTP 1.1"></a>HTTP 1.1</h4><p>1999å¹´6æœˆå‘å¸ƒè§„èŒƒ rfc2616</p>
<p>è¿›ä¸€æ­¥å®Œå–„äº† HTTP åè®®ï¼Œä¸€ç›´ç”¨åˆ°äº†20å¹´åçš„ä»Šå¤©ï¼Œç›´åˆ°ç°åœ¨è¿˜æ˜¯æœ€æµè¡Œçš„ç‰ˆæœ¬ã€‚</p>
<p><strong>ç›¸æ¯”HTTP/1.0ï¼š</strong></p>
<p><strong>1.å¼•å…¥äº†æŒä¹…è¿æ¥ï¼ˆpersistent connectionï¼‰</strong></p>
<p>é€šè¿‡Connectionå¤´éƒ¨æ§åˆ¶ï¼ŒHTTP/1.0é»˜è®¤æ˜¯closeï¼ŒHTTP/1.1é»˜è®¤æ˜¯keep-aliveã€‚è¯·æ±‚å®ŒæˆåTCPè¿æ¥é»˜è®¤ä¸å…³é—­ï¼Œå› æ­¤å¯ä»¥è¢«å¤šä¸ªè¯·æ±‚å¤ç”¨ã€‚</p>
<p>åœ¨HTTP 1.0ä¸­ï¼Œæ²¡æœ‰å®˜æ–¹çš„keepaliveæ“ä½œã€‚é€šå¸¸æ˜¯åœ¨ç°æœ‰åè®®ä¸Šæ·»åŠ ä¸€ä¸ªé¦–éƒ¨ã€‚å¦‚æœæµè§ˆå™¨æ”¯æŒkeep-aliveï¼Œå®ƒä¼šåœ¨è¯·æ±‚çš„åŒ…å¤´ä¸­æ·»åŠ ï¼š</p>
<figure class="highlight armasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">Connection:</span> <span class="meta">Keep</span>-Alive</span><br></pre></td></tr></table></figure>
<p>ç„¶åå½“æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚ï¼Œä½œå‡ºå›åº”çš„æ—¶å€™ï¼Œå®ƒä¹Ÿæ·»åŠ ä¸€ä¸ªå¤´åœ¨å“åº”ä¸­ï¼š</p>
<figure class="highlight armasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">Connection:</span> <span class="meta">Keep</span>-Alive</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·åšï¼Œè¿æ¥å°±ä¸ä¼šä¸­æ–­ï¼Œè€Œæ˜¯ä¿æŒè¿æ¥ã€‚å½“å®¢æˆ·ç«¯å‘é€å¦ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œå®ƒä¼šä½¿ç”¨åŒä¸€ä¸ªè¿æ¥ã€‚è¿™ä¸€ç›´ç»§ç»­åˆ°å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨ç«¯è®¤ä¸ºä¼šè¯å·²ç»ç»“æŸï¼Œå…¶ä¸­ä¸€æ–¹ä¸­æ–­è¿æ¥ã€‚</p>
<p>åœ¨HTTP 1.1ä¸­æ‰€æœ‰çš„è¿æ¥é»˜è®¤éƒ½æ˜¯æŒç»­è¿æ¥ï¼Œé™¤éç‰¹æ®Šå£°æ˜ä¸æ”¯æŒã€‚</p>
<p>æŒä¹…è¿æ¥çš„å¥½å¤„ï¼š</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line">Persistent HTTP connections have a <span class="built_in">number</span> <span class="keyword">of</span> advantages:</span><br><span class="line">â€¢ By opening <span class="keyword">and</span> closing fewer TCP connections, CPU <span class="built_in">time</span> <span class="keyword">is</span> saved <span class="keyword">in</span> routers <span class="keyword">and</span> hosts (clients, servers, proxies, gateways, tunnels, <span class="keyword">or</span> caches), <span class="keyword">and</span> memory used <span class="keyword">for</span> TCP protocol control blocks can be saved <span class="keyword">in</span> hosts.</span><br><span class="line"></span><br><span class="line">â€¢ HTTP requests <span class="keyword">and</span> responses can be pipelined <span class="keyword">on</span> a connection. Pipelining allows a client <span class="keyword">to</span> make multiple requests <span class="keyword">without</span> waiting <span class="keyword">for</span> each response, allowing a single TCP connection <span class="keyword">to</span> be used much more efficiently, <span class="keyword">with</span> much lower elapsed <span class="built_in">time</span>.</span><br><span class="line"></span><br><span class="line">â€¢ Network congestion <span class="keyword">is</span> reduced <span class="keyword">by</span> reducing <span class="keyword">the</span> <span class="built_in">number</span> <span class="keyword">of</span> packets caused <span class="keyword">by</span> TCP opens, <span class="keyword">and</span> <span class="keyword">by</span> allowing TCP sufficient <span class="built_in">time</span> <span class="keyword">to</span> determine <span class="keyword">the</span> congestion state <span class="keyword">of</span> <span class="keyword">the</span> network.</span><br><span class="line"></span><br><span class="line">â€¢ Latency <span class="keyword">on</span> subsequent requests <span class="keyword">is</span> reduced <span class="keyword">since</span> there <span class="keyword">is</span> no <span class="built_in">time</span> spent <span class="keyword">in</span> TCPâ€™s connection opening handshake.</span><br><span class="line"></span><br><span class="line">â€¢ HTTP can evolve more gracefully, <span class="keyword">since</span> errors can be reported <span class="keyword">without</span> <span class="keyword">the</span> penalty <span class="keyword">of</span> closing <span class="keyword">the</span> TCP connection. Clients using future versions <span class="keyword">of</span> HTTP might optimistically <span class="keyword">try</span> a new feature, <span class="keyword">but</span> <span class="keyword">if</span> communicating <span class="keyword">with</span> an older server, retry <span class="keyword">with</span> old semantics <span class="keyword">after</span> an <span class="keyword">error</span> <span class="keyword">is</span> reported.</span><br><span class="line"></span><br><span class="line">HTTP implementations SHOULD implement persistent connections.</span><br></pre></td></tr></table></figure>
<p>RFC ä¸Šåˆ—ä¸¾äº†è¿™ä¹ˆå¤šå…¶å®å°±ä¸¤ç‚¹</p>
<ol>
<li>æŒä¹…è¿æ¥ä¸ºè¿æ¥çš„å¤ç”¨æä¾›åŸºç¡€ï¼Œä»è€Œå‡å°‘äº†é¢å¤–çš„TCPè¿æ¥ï¼Œä»¥åŠTCPåˆšè¿æ¥æ—¶çš„æ…¢å¯åŠ¨å¸¦æ¥çš„æŸè€—ã€‚</li>
<li>æŒä¹…è¿æ¥ä¸ºç®¡çº¿æœºåˆ¶æä¾›åŸºç¡€ã€‚</li>
</ol>
<p>æ³¨æ„ï¼šä½¿ç”¨æŒä¹…è¿æ¥æ—¶ï¼Œå°±ä¸èƒ½é€šè¿‡è¿æ¥çš„æ–­å¼€ä½œä¸ºæŠ¥æ–‡çš„ç»ˆæ­¢ç¬¦äº†ã€‚æ¯ä¸ªæŠ¥æ–‡æœ€å¥½æä¾›ä¸€ä¸ªContent-Lengthè¦ä¸ç„¶æ²¡æ³•åŒºåˆ†å„æŠ¥æ–‡çš„è¾¹ç•Œã€‚è€Œå¯¹äºåŠ¨æ€ç”Ÿæˆçš„æ–‡ä»¶å› ä¸ºæ— æ³•æä¾›content-lengthï¼Œæ‰€ä»¥æœ€å¥½é‡‡ç”¨åˆ†å—ï¼ˆchunkedï¼‰ä¼ è¾“ï¼Œchunked ç¼–ç çš„æ•°æ®åœ¨æœ€åæœ‰ä¸€ä¸ªç©º chunked å—ï¼Œè¡¨æ˜æœ¬æ¬¡ä¼ è¾“æ•°æ®ç»“æŸã€‚</p>
<p>ä½¿ç”¨äº†æŒä¹…è¿æ¥å¯¹æ¯”å›¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/D7A734A6FA0923F4C7E86A2F647AB26B.jpg" alt=""></p>
<p><strong>2.ç®¡çº¿æœºåˆ¶ï¼ˆPipeliningï¼‰</strong></p>
<p>åœ¨ä½¿ç”¨æŒä¹…è¿æ¥åï¼Œç®¡çº¿æœºåˆ¶å¯ä»¥è®©å®¢æˆ·ç«¯åœ¨ä¸Šä¸€ä¸ªå“åº”è¿˜æ²¡å›æ¥æ—¶å°±å¯ä»¥å‘é€ä¸‹ä¸€ä¸ªè¯·æ±‚ã€‚ä½†æ˜¯æœåŠ¡å™¨ç«¯è¿”å›çš„å“åº”çš„é¡ºåºå¿…é¡»æŒ‰ç…§æ¥æ”¶åˆ°çš„è¯·æ±‚çš„é¡ºåºæ¥å‘é€ï¼ˆå¦‚æœæœåŠ¡å™¨æ²¡æœ‰æŒ‰ç…§è¯¥è§„åˆ™å®ç°çš„è¯ï¼Œå®¢æˆ·ç«¯æ¥æ”¶åˆ°çš„å°†æ˜¯æ··æ‚æ•°æ®ï¼‰ã€‚å‚è€ƒ <a href="https://github.com/AFNetworking/AFNetworking/issues/528">AF issue #528</a></p>
<p>æ¯”å¦‚æœåŠ¡å™¨æ”¶åˆ°å®¢æœç«¯å‘æ¥çš„A-B-Cä¸‰ä¸ªè¯·æ±‚ï¼Œé‚£ä¹ˆè¿”å›å“åº”æ—¶å¿…é¡»Açš„å“åº”å‘å®Œåæ‰èƒ½å†å‘Bçš„ï¼ŒBçš„å‘å®Œåå†å‘Cçš„ã€‚</p>
<p>èªæ˜çš„ä½ å¯èƒ½å·²ç»çœ‹åˆ°ç®¡çº¿æœºåˆ¶çš„ç¼ºç‚¹äº†ï¼Œå¦‚æœç¬¬ä¸€ä¸ªè¯·æ±‚éœ€è¦å¤„ç†çš„æ—¶é—´éå¸¸é•¿ï¼Œé‚£ä¹ˆåç»­çš„è¯·æ±‚å³ä½¿å·²ç»è¢«æœåŠ¡å™¨å¤„ç†å®Œæˆï¼Œå“åº”ä¹Ÿä¸èƒ½ç«‹å³è¿”å›ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨æœåŠ¡ç«¯çš„ç¼“å­˜åŒºä¸­ï¼Œç­‰å¾…ç¬¬ä¸€ä¸ªå“åº”çš„å®Œæˆï¼Œæ‰èƒ½æŒ‰ç…§FIFOé¡ºåºè¿”å›ã€‚è¿™å°±æ˜¯é˜Ÿå¤´é˜»å¡ã€‚</p>
<p>æ­£æ˜¯ç”±äºå­˜åœ¨è¿™æ ·æˆ–é‚£æ ·çš„é—®é¢˜ï¼ŒHTTPç®¡é“æŠ€æœ¯çš„åº”ç”¨æ¯”è¾ƒæœ‰é™ï¼Œå¹¶æ²¡æœ‰å¤§é¢ç§¯æ¨å¹¿å¼€æ¥ï¼ŒåŸºæœ¬ä¸Šæ˜¯å…³çš„ï¼Œå³ä½¿ä¸€äº›æ”¯æŒå®ƒçš„æµè§ˆå™¨ä¹Ÿä»…ä»…æŠŠå®ƒä½œä¸ºä¸€ä¸ªé«˜çº§é€‰é¡¹ã€‚è¿™äº›ç¼ºç‚¹å°†åœ¨HTTP2ä¸­å¾—ä»¥è§£å†³ã€‚</p>
<p>ä½¿ç”¨äº†ç®¡çº¿æœºåˆ¶å¯¹æ¯”å›¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/MbAOA.png" alt=""></p>
<p>è¿™é‡Œéœ€è¦å¯¹pipeliningå›¾åšä¸€ç‚¹è§£é‡Š</p>
<p>ç®¡çº¿æœºåˆ¶ï¼ŒAï¼ŒBï¼ŒCçš„å“åº”æ•°æ®æ˜¯ä¸å¯ä»¥äº¤å‰è¿”å›çš„ã€‚å› ä¸ºå¦‚æœäº¤å‰çš„è¯ï¼Œå®¢æˆ·ç«¯æ ¹æœ¬æ— æ³•åŒºåˆ†æ”¶åˆ°çš„æ•°æ®å±äºå“ªä¸ªè¯·æ±‚ã€‚æ—¢ç„¶Aï¼ŒBï¼ŒCçš„å“åº”æ˜¯é¡ºåºè¿”å›çš„ä¹Ÿå°±æ˜¯Açš„å“åº”å¿…é¡»å‘å®Œåæ‰èƒ½å†å‘Bçš„ï¼Œé‚£ä¹ˆå¦‚æœAæ˜¯ä¸€ä¸ªä¸‹è½½å¤§æ–‡ä»¶çš„è¯·æ±‚ï¼ŒBï¼ŒCéƒ½æ˜¯å°æ•°æ®è¯·æ±‚ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å°†ä¼šç­‰å¾ˆä¹…æ‰èƒ½æ”¶åˆ°Bï¼ŒCçš„å“åº”ï¼Œè¿™å°±æ˜¯é˜Ÿå¤´é˜»å¡ã€‚</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/sdCNX.png" alt=""></p>
<p><strong>3.æ–°å¢äº†ä¸€äº›æ–¹æ³•</strong></p>
<p>OPTIONSï¼ŒPUTï¼ŒDELETEï¼ŒTRACEï¼ŒCONNECTã€‚</p>
<p><strong>4.æ–°å¢äº†ä¸€å¤§æ³¢çŠ¶æ€ç </strong></p>
<p>åœ¨HTTP1.1ä¸­æ–°å¢äº†24ä¸ªé”™è¯¯çŠ¶æ€å“åº”ç ã€‚</p>
<p><strong>5.å®Œå–„äº†ç¼“å­˜æœºåˆ¶</strong></p>
<p>åœ¨ HTTP 1.0 ä¸­ä¸»è¦ä½¿ç”¨ header é‡Œçš„ If-Modified-Since,Expires æ¥åšä¸ºç¼“å­˜åˆ¤æ–­çš„æ ‡å‡†ï¼ŒHTTP 1.1åˆ™å¼•å…¥äº†æ›´å¤šçš„ç¼“å­˜æ§åˆ¶ç­–ç•¥ä¾‹å¦‚ Entity tagï¼ŒIf-Unmodified-Since, If-Match, If-None-Matchç­‰æ›´å¤šå¯ä¾›é€‰æ‹©çš„ç¼“å­˜å¤´æ¥æ§åˆ¶ç¼“å­˜ç­–ç•¥ã€‚</p>
<p>å…³äºHTTPçš„ç¼“å­˜æœºåˆ¶è¿™é‡Œä¸åšå±•å¼€ï¼Œå› ä¸ºè¿™åˆæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„è¯é¢˜ã€‚</p>
<p><strong>6.æ–°å¢äº†ä¸€å¤§æ³¢é¦–éƒ¨</strong></p>
<p>æ¯”å¦‚è·Ÿç¼“å­˜æ§åˆ¶ç›¸å…³çš„å°±å¢åŠ äº†å¾ˆå¤šï¼Œè¿˜æœ‰Content-Rangeï¼Œ Hostï¼Œ Rangeç­‰ã€‚</p>
<p><strong>Hosté¦–éƒ¨</strong></p>
<p>åœ¨HTTP1.0ä¸­è®¤ä¸ºæ¯å°æœåŠ¡å™¨éƒ½ç»‘å®šä¸€ä¸ªå”¯ä¸€çš„IPåœ°å€ï¼Œå› æ­¤ï¼Œè¯·æ±‚æ¶ˆæ¯ä¸­çš„URLå¹¶æ²¡æœ‰ä¼ é€’ä¸»æœºåï¼ˆhostnameï¼‰ã€‚ä½†éšç€è™šæ‹Ÿä¸»æœºæŠ€æœ¯çš„å‘å±•ï¼Œåœ¨ä¸€å°ç‰©ç†æœåŠ¡å™¨ä¸Šå¯ä»¥å­˜åœ¨å¤šä¸ªè™šæ‹Ÿä¸»æœºï¼ˆMulti-homed Web Serversï¼‰ï¼Œå¹¶ä¸”å®ƒä»¬å…±äº«ä¸€ä¸ªIPåœ°å€ã€‚ç”±äºHTTP 1.0ä¸æ”¯æŒHostè¯·æ±‚å¤´å­—æ®µï¼ŒWEBæµè§ˆå™¨æ— æ³•ä½¿ç”¨ä¸»æœºå¤´åæ¥æ˜ç¡®è¡¨ç¤ºè¦è®¿é—®æœåŠ¡å™¨ä¸Šçš„å“ªä¸ªWEBç«™ç‚¹ï¼Œè¿™æ ·å°±æ— æ³•ä½¿ç”¨WEBæœåŠ¡å™¨åœ¨åŒä¸€ä¸ªIPåœ°å€å’Œç«¯å£å·ä¸Šé…ç½®å¤šä¸ªè™šæ‹ŸWEBç«™ç‚¹ã€‚åœ¨HTTP 1.1ä¸­å¢åŠ Hostè¯·æ±‚å¤´å­—æ®µåï¼ŒWEBæµè§ˆå™¨å¯ä»¥ä½¿ç”¨ä¸»æœºå¤´åæ¥æ˜ç¡®è¡¨ç¤ºè¦è®¿é—®æœåŠ¡å™¨ä¸Šçš„å“ªä¸ªWEBç«™ç‚¹ï¼Œè¿™æ‰å®ç°äº†åœ¨ä¸€å°WEBæœåŠ¡å™¨ä¸Šå¯ä»¥åœ¨åŒä¸€ä¸ªIPåœ°å€å’Œç«¯å£å·ä¸Šä½¿ç”¨ä¸åŒçš„ä¸»æœºåæ¥åˆ›å»ºå¤šä¸ªè™šæ‹ŸWEBç«™ç‚¹ã€‚</p>
<p><strong>7.å¸¦å®½ä¼˜åŒ–</strong></p>
<p>HTTP/1.0ä¸­ï¼Œå­˜åœ¨ä¸€äº›æµªè´¹å¸¦å®½çš„ç°è±¡ï¼Œä¾‹å¦‚å®¢æˆ·ç«¯åªæ˜¯éœ€è¦æŸä¸ªå¯¹è±¡çš„ä¸€éƒ¨åˆ†ï¼Œè€ŒæœåŠ¡å™¨å´å°†æ•´ä¸ªå¯¹è±¡é€è¿‡æ¥äº†ï¼Œåˆæ¯”å¦‚ä¸‹è½½å¤§æ–‡ä»¶æ—¶éœ€è¦æ”¯æŒæ–­ç‚¹ç»­ä¼ åŠŸèƒ½ï¼Œè€Œä¸æ˜¯åœ¨å‘ç”Ÿæ–­è¿åä¸å¾—ä¸é‡æ–°ä¸‹è½½å®Œæ•´çš„åŒ…ã€‚HTTP/1.1ä¸­åœ¨è¯·æ±‚æ¶ˆæ¯ä¸­å¼•å…¥äº†rangeå¤´åŸŸï¼Œå®ƒå…è®¸åªè¯·æ±‚èµ„æºçš„æŸä¸ªéƒ¨åˆ†ã€‚åœ¨å“åº”æ¶ˆæ¯ä¸­Content-Rangeå¤´åŸŸå£°æ˜äº†è¿”å›çš„è¿™éƒ¨åˆ†å¯¹è±¡çš„åç§»å€¼å’Œé•¿åº¦ã€‚å¦‚æœæœåŠ¡å™¨ç›¸åº”åœ°è¿”å›äº†å¯¹è±¡æ‰€è¯·æ±‚èŒƒå›´çš„å†…å®¹ï¼Œåˆ™å“åº”ç ä¸º206ï¼ˆPartial Contentï¼‰ï¼Œå®ƒå¯ä»¥é˜²æ­¢Cacheå°†å“åº”è¯¯ä»¥ä¸ºæ˜¯å®Œæ•´çš„ä¸€ä¸ªå¯¹è±¡ã€‚</p>
<p>å¦å¤–ä¸€ç§æƒ…å†µæ˜¯è¯·æ±‚æ¶ˆæ¯ä¸­å¦‚æœåŒ…å«æ¯”è¾ƒå¤§çš„å®ä½“å†…å®¹ï¼Œä½†ä¸ç¡®å®šæœåŠ¡å™¨æ˜¯å¦èƒ½å¤Ÿæ¥æ”¶è¯¥è¯·æ±‚ï¼ˆå¦‚æ˜¯å¦æœ‰æƒé™ï¼‰ï¼Œæ­¤æ—¶è‹¥è´¸ç„¶å‘å‡ºå¸¦å®ä½“çš„è¯·æ±‚ï¼Œå¦‚æœè¢«æ‹’ç»ä¹Ÿä¼šæµªè´¹å¸¦å®½ã€‚HTTP/1.1åŠ å…¥äº†ä¸€ä¸ªæ–°çš„çŠ¶æ€ç 100ï¼ˆContinueï¼‰ã€‚å®¢æˆ·ç«¯äº‹å…ˆå‘é€ä¸€ä¸ªåªå¸¦å¤´åŸŸçš„è¯·æ±‚ï¼Œå¦‚æœæœåŠ¡å™¨å› ä¸ºæƒé™æ‹’ç»äº†è¯·æ±‚ï¼Œå°±å›é€å“åº”ç 401ï¼ˆUnauthorizedï¼‰ï¼›å¦‚æœæœåŠ¡å™¨æ¥æ”¶æ­¤è¯·æ±‚å°±å›é€å“åº”ç 100ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥ç»§ç»­å‘é€å¸¦å®ä½“çš„å®Œæ•´è¯·æ±‚äº†ã€‚æ³¨æ„ï¼ŒHTTP/1.0çš„å®¢æˆ·ç«¯ä¸æ”¯æŒ100å“åº”ç ã€‚ä½†å¯ä»¥è®©å®¢æˆ·ç«¯åœ¨è¯·æ±‚æ¶ˆæ¯ä¸­åŠ å…¥Expectå¤´åŸŸï¼Œå¹¶å°†å®ƒçš„å€¼è®¾ç½®ä¸º100-continueã€‚</p>
<p><strong>8.åˆ†å—ä¼ è¾“ç¼–ç </strong></p>
<p>HTTPæ¶ˆæ¯ä¸­å¯ä»¥åŒ…å«ä»»æ„é•¿åº¦çš„å®ä½“ï¼Œé€šå¸¸å®ƒä»¬ä½¿ç”¨Content-Lengthæ¥ç»™å‡ºæ¶ˆæ¯ç»“æŸæ ‡å¿—ã€‚ä½†æ˜¯ï¼Œå¯¹äºå¾ˆå¤šåŠ¨æ€äº§ç”Ÿçš„å“åº”ï¼Œåªèƒ½é€šè¿‡ç¼“å†²å®Œæ•´çš„æ¶ˆæ¯æ¥åˆ¤æ–­æ¶ˆæ¯çš„å¤§å°ï¼Œä½†è¿™æ ·åšä¼šåŠ å¤§å»¶è¿Ÿã€‚</p>
<p>1.1ç‰ˆè§„å®šå¯ä»¥ä¸ä½¿ç”¨<code>Content-Length</code>å­—æ®µï¼Œè€Œä½¿ç”¨<a href="https://zh.wikipedia.org/wiki/åˆ†å—ä¼ è¾“ç¼–ç ">â€œåˆ†å—ä¼ è¾“ç¼–ç â€</a>ï¼ˆchunked transfer encodingï¼‰ã€‚åªè¦è¯·æ±‚æˆ–å›åº”çš„å¤´ä¿¡æ¯æœ‰<code>Transfer-Encoding</code>å­—æ®µï¼Œå°±è¡¨æ˜å›åº”å°†ç”±æ•°é‡æœªå®šçš„æ•°æ®å—ç»„æˆã€‚å‘é€æ–¹å°†æ¶ˆæ¯åˆ†å‰²æˆè‹¥å¹²ä¸ªä»»æ„å¤§å°çš„æ•°æ®å—ï¼Œæ¯ä¸ªæ•°æ®å—åœ¨å‘é€æ—¶éƒ½ä¼šé™„ä¸Šå—çš„é•¿åº¦ï¼Œæœ€åç”¨ä¸€ä¸ªé›¶é•¿åº¦çš„å—ä½œä¸ºæ¶ˆæ¯ç»“æŸçš„æ ‡å¿—ã€‚</p>
<p>æ–°å¢MIMEç±»å‹ <code>multipart/form-data</code> ç­‰ã€‚</p>
<p><strong>HTTP/1.1ç¼ºç‚¹ï¼š</strong></p>
<p><strong>1.é˜Ÿå¤´é˜»å¡</strong></p>
<p>åœ¨ä½¿ç”¨æŒä¹…è¿æ¥åï¼Œç®¡çº¿æœºåˆ¶å¯ä»¥è®©å®¢æˆ·ç«¯åœ¨ä¸Šä¸€ä¸ªå“åº”è¿˜æ²¡å›æ¥æ—¶å°±å¯ä»¥å‘é€ä¸‹ä¸€ä¸ªè¯·æ±‚ã€‚ä½†æ˜¯æœåŠ¡å™¨ç«¯è¿”å›çš„å“åº”çš„é¡ºåºå¿…é¡»æŒ‰ç…§æ¥æ”¶åˆ°çš„è¯·æ±‚çš„é¡ºåºæ¥å‘é€ã€‚å¦‚æœç¬¬ä¸€ä¸ªè¯·æ±‚éœ€è¦å¤„ç†çš„æ—¶é—´éå¸¸é•¿ï¼Œé‚£ä¹ˆåç»­çš„è¯·æ±‚å³ä½¿å·²ç»è¢«æœåŠ¡å™¨å¤„ç†å®Œæˆï¼Œå“åº”ä¹Ÿä¸èƒ½ç«‹å³è¿”å›ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨æœåŠ¡ç«¯çš„ç¼“å­˜åŒºä¸­ï¼Œç­‰å¾…ç¬¬ä¸€ä¸ªå“åº”çš„å®Œæˆï¼Œæ‰èƒ½æŒ‰ç…§FIFOé¡ºåºè¿”å›ã€‚è¿™å°±æ˜¯é˜Ÿå¤´é˜»å¡ã€‚</p>
<p>ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œåªæœ‰ä¸¤ç§æ–¹æ³•ï¼šä¸€æ˜¯å‡å°‘è¯·æ±‚æ•°ï¼ŒäºŒæ˜¯åŒæ—¶å¤šå¼€æŒä¹…è¿æ¥ã€‚è¿™å¯¼è‡´äº†å¾ˆå¤šçš„ç½‘é¡µä¼˜åŒ–æŠ€å·§ï¼Œæ¯”å¦‚åˆå¹¶è„šæœ¬å’Œæ ·å¼è¡¨ã€å°†å›¾ç‰‡åµŒå…¥CSSä»£ç ã€é›ªç¢§å›¾ã€åŸŸååˆ†ç‰‡ï¼ˆdomain shardingï¼‰ç­‰ç­‰ã€‚å¦‚æœHTTPåè®®è®¾è®¡å¾—æ›´å¥½ä¸€äº›ï¼Œè¿™äº›é¢å¤–çš„å·¥ä½œæ˜¯å¯ä»¥é¿å…çš„ã€‚</p>
<p>å¦å¤–HTTPè¿æ¥ä¹Ÿä¸æ˜¯æƒ³å¼€å¤šå°‘å°±å¼€å¤šå°‘çš„ï¼ŒHTTP1.1ï¼ŒChromeæµè§ˆå™¨é€šå¸¸å…è®¸æ¯ä¸ªåŸŸååŒæ—¶å‘å‡ºçš„æœ€å¤§è¿æ¥æ•°ä¸º6ä¸ªã€‚è¿™æ„å‘³ç€åœ¨åŒä¸€ä¸ªé¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥åŒæ—¶å‘å‡º6ä¸ªåŒæºè¯·æ±‚ã€‚è¯·æ³¨æ„ï¼Œè¿™ä¸ªé™åˆ¶æ˜¯é’ˆå¯¹æ¯ä¸ªåŸŸåçš„ï¼Œå¦‚æœæ‚¨çš„é¡µé¢ä½¿ç”¨äº†å¤šä¸ªåŸŸåï¼ˆä¾‹å¦‚ä½¿ç”¨CDNï¼‰ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥åŒæ—¶å‘å‡ºæ›´å¤šçš„è¯·æ±‚ã€‚å¯¹äºè¶…è¿‡é™åˆ¶æ•°ç›®çš„è¯·æ±‚ä¼šè¢«é˜»å¡ç›´åˆ°ä¸€äº›è¯·æ±‚å®Œæˆæ‰ä¼šç»§ç»­å‘å‡ºã€‚æ‰€ä»¥ä¸€äº›ä¼˜åŒ–å°±ä¼šæŠŠèµ„æºæ”¾åœ¨ä¸åŒçš„åŸŸåä¸‹ã€‚</p>
<p><a href="https://stackoverflow.com/questions/14810890/what-are-the-disadvantages-of-using-http-pipelining">What are the disadvantage(s) of using HTTP pipelining?</a>  è®¨è®ºç®¡çº¿æœºåˆ¶çš„ç¼ºç‚¹çš„ã€‚é‡Œé¢å‚è€ƒèµ„æ–™ä¸­æˆ‘å¤§è‹¹æœWWDC2015é‡Œå°±å·²ç»å¯¹æ¯”äº†HTTP1.1å’ŒHTTP2çš„æ€§èƒ½ï¼Œå¥ˆä½•è‡ªå·±æ²¡çœ‹WWDCã€‚ä½œä¸ºä¸€ä¸ªiOSå¼€å‘è€…ï¼ŒWWDCå¿…çœ‹æ‰è¡Œã€‚</p>
<p><strong>2.æ— çŠ¶æ€ç‰¹æ€§ â€“ å¸¦æ¥å·¨å¤§çš„ HTTP å¤´éƒ¨</strong></p>
<p>ç”±äºæŠ¥æ–‡ Header ä¸€èˆ¬ä¼šæºå¸¦â€User Agentâ€ â€œCookieâ€â€œAcceptâ€â€Serverâ€ç­‰è®¸å¤šå›ºå®šçš„å¤´å­—æ®µï¼ˆå¦‚ä¸‹å›¾ï¼‰ï¼Œå¤šè¾¾å‡ ç™¾å­—èŠ‚ç”šè‡³ä¸Šåƒå­—èŠ‚ï¼Œä½† Body å´ç»å¸¸åªæœ‰å‡ åå­—èŠ‚ï¼ˆæ¯”å¦‚ GET è¯·æ±‚ã€ 204/301/304 å“åº”ï¼‰ï¼Œæˆäº†ä¸æŠ˜ä¸æ‰£çš„â€œå¤§å¤´å„¿å­â€ã€‚Header é‡Œæºå¸¦çš„å†…å®¹è¿‡å¤§ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šå¢åŠ äº†ä¼ è¾“æˆæœ¬ã€‚æ›´è¦å‘½çš„æ˜¯ï¼Œæˆåƒä¸Šä¸‡çš„è¯·æ±‚å“åº”æŠ¥æ–‡é‡Œæœ‰å¾ˆå¤šå­—æ®µå€¼éƒ½æ˜¯é‡å¤çš„ï¼Œéå¸¸æµªè´¹ã€‚</p>
<h4 id="SPDYåè®®"><a href="#SPDYåè®®" class="headerlink" title="SPDYåè®®"></a>SPDYåè®®</h4><p>è°·æ­Œå‡ºå“ï¼Œäº2009 å¹´å…¬å¼€</p>
<p>å› ä¸º HTTP/1 çš„é—®é¢˜ï¼Œæˆ‘ä»¬ä¼šå¼•å…¥é›ªç¢§å›¾ã€å°†å°å›¾å†…è”ã€ä½¿ç”¨å¤šä¸ªåŸŸåç­‰ç­‰çš„æ–¹å¼æ¥æé«˜æ€§èƒ½ã€‚ä¸è¿‡è¿™äº›ä¼˜åŒ–éƒ½ç»•å¼€äº†åè®®æœ¬èº«ï¼Œç›´åˆ° 2009 å¹´ï¼Œè°·æ­Œå…¬å¼€äº†è‡ªè¡Œç ”å‘çš„ SPDY åè®®ï¼Œå®ƒä¸»è¦è§£å†³ HTTP/1.1 æ•ˆç‡ä¸é«˜çš„é—®é¢˜ã€‚</p>
<p>ç›´åˆ°è¿™æ—¶ï¼Œæ‰ç®—æ˜¯æ­£å¼æ”¹é€ äº† HTTP åè®®æœ¬èº«ã€‚SPDY è¿›è¡Œå»¶è¿Ÿé™ä½ã€header å‹ç¼©ç­‰æ”¹è¿›ï¼Œå…¶å®è·µè¯æ˜äº†è¿™äº›ä¼˜åŒ–çš„æ•ˆæœï¼Œä¹Ÿæœ€ç»ˆå¸¦æ¥äº† HTTP/2 çš„è¯ç”Ÿã€‚</p>
<h4 id="HTTP-2"><a href="#HTTP-2" class="headerlink" title="HTTP 2"></a>HTTP 2</h4><p>2015å¹´5æœˆå‘å¸ƒè§„èŒƒ rfc7540</p>
<p><strong>ç›¸æ¯”HTTP/1.1ï¼š</strong></p>
<p><strong>1.äºŒè¿›åˆ¶åè®®</strong></p>
<p>ä¹‹å‰çš„HTTPç‰ˆæœ¬å¯ä»¥è¯´æ˜¯ä¸€ä¸ªæ–‡æœ¬åè®®ï¼Œéœ€è¦æŒ‰ç…§ä¸€å®šçš„ä¹¦å†™æ ¼å¼ï¼ŒåŒæ–¹æ‰èƒ½æ­£ç¡®è§£æã€‚ä½†HTTP/2 åˆ™æ˜¯ä¸€ä¸ªå½»åº•çš„äºŒè¿›åˆ¶åè®®ï¼Œå¤´ä¿¡æ¯å’Œæ•°æ®ä½“éƒ½æ˜¯äºŒè¿›åˆ¶ï¼Œå¹¶ä¸”ç»Ÿç§°ä¸ºâ€å¸§â€ï¼ˆframeï¼‰ï¼šå¤´ä¿¡æ¯å¸§å’Œæ•°æ®å¸§ã€‚</p>
<p>äºŒè¿›åˆ¶åè®®çš„ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œå¯ä»¥å®šä¹‰é¢å¤–çš„å¸§ã€‚HTTP/2 å®šä¹‰äº†è¿‘åç§å¸§ï¼Œä¸ºå°†æ¥çš„é«˜çº§åº”ç”¨æ‰“å¥½äº†åŸºç¡€ã€‚å¦‚æœä½¿ç”¨æ–‡æœ¬å®ç°è¿™ç§åŠŸèƒ½ï¼Œè§£ææ•°æ®å°†ä¼šå˜å¾—éå¸¸éº»çƒ¦ï¼ŒäºŒè¿›åˆ¶è§£æåˆ™æ–¹ä¾¿å¾—å¤šã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä»‹ç»å‡ ä¸ªé‡è¦çš„æ¦‚å¿µï¼š</p>
<ul>
<li>æµï¼ˆStreamï¼‰ï¼šæµæ˜¯è¿æ¥ä¸­çš„ä¸€ä¸ªè™šæ‹Ÿä¿¡é“ï¼Œ<strong>å¯ä»¥æ‰¿è½½åŒå‘çš„æ¶ˆæ¯</strong>ï¼›æ¯ä¸ªæµéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ•´æ•°æ ‡è¯†ç¬¦ï¼ˆ1ã€2â€¦Nï¼‰ï¼›</li>
<li>æ¶ˆæ¯ï¼šæ˜¯æŒ‡é€»è¾‘ä¸Šçš„ HTTP æ¶ˆæ¯ï¼Œæ¯”å¦‚è¯·æ±‚ã€å“åº”ç­‰ï¼Œç”±ä¸€æˆ–å¤šä¸ªå¸§ç»„æˆã€‚</li>
<li>å¸§ï¼šHTTP 2.0 é€šä¿¡çš„æœ€å°å•ä½ï¼Œæ¯ä¸ªå¸§åŒ…å«å¸§é¦–éƒ¨ï¼Œè‡³å°‘ä¹Ÿä¼šæ ‡è¯†å‡ºå½“å‰å¸§æ‰€å±çš„æµï¼Œæ‰¿è½½ç€ç‰¹å®šç±»å‹çš„æ•°æ®ï¼Œå¦‚ HTTP é¦–éƒ¨ã€è´Ÿè·ï¼Œç­‰ç­‰</li>
</ul>
<p>ä¸€ä¸ª TCP è¿æ¥ï¼ˆHTTP2 è¿æ¥å»ºç«‹åœ¨ TCP è¿æ¥ä¹‹ä¸Šï¼‰é‡Œå¯ä»¥å‘é€è‹¥å¹²ä¸ªæµï¼ˆstreamï¼‰ï¼Œæ¯ä¸ªæµä¸­å¯ä»¥ä¼ è¾“è‹¥å¹²æ¡æ¶ˆæ¯ï¼ˆmessageï¼‰ï¼Œæ¯æ¡æ¶ˆæ¯ç”±è‹¥å¹²äºŒè¿›åˆ¶å¸§ï¼ˆframeï¼‰ç»„æˆã€‚</p>
<p>æ³¨ï¼šæµè¿˜æ˜¯æŒºå¤æ‚çš„ï¼Œå…·ä½“å¯ä»¥çœ‹ä¸€ä¸‹æµçš„çŠ¶æ€å›¾ã€‚</p>
<p>HTTP 2çš„å¸§å¸ƒå±€å¦‚ä¸‹ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20200821155127.png" alt=""></p>
<p>æ‰€æœ‰çš„å¸§éƒ½ä»¥ä¸€ä¸ªå›ºå®šçš„9å­—èŠ‚çš„å¤´å¼€å§‹ï¼Œåé¢è·Ÿç€çš„æ˜¯é•¿åº¦å¯å˜çš„payloadã€‚</p>
<p>å¸§å¤´å­—æ®µçš„å®šä¹‰ï¼š</p>
<p>Lengthï¼š24bitï¼Œæ— ç¬¦å·æ•´å‹ï¼Œæœ€å¤§2^14 (16,384) ï¼Œå¸§çš„é•¿åº¦è¿˜å—åˆ°SETTINGS_MAX_FRAME_SIZEå¸§çš„é™åˆ¶ã€‚è¯¥å€¼ä¸åŒ…å«å›ºå®šçš„9å­—èŠ‚å¸§å¤´ï¼Œå°±æ˜¯payloadçš„é•¿åº¦ã€‚</p>
<p>Typeï¼š8bitï¼Œä»£è¡¨å¸§çš„ç±»å‹ã€‚æ¯”å¦‚DATAå¸§å’ŒHEADERSå¸§ã€‚å¯¹äºå„ç§å¸§å¯ä»¥æŠ“åŒ…å­¦ä¹ ä¸€ä¸‹ã€‚</p>
<p>Flagsï¼šå…·ä½“å¸§çš„æ ‡è¯†</p>
<p>Rï¼šä¿ç•™ä½ã€‚</p>
<p>Stream Identifierï¼šæµIDã€‚æ— ç¬¦å·31ä½æ•´å‹ã€‚å€¼0æ˜¯ä¿ç•™çš„ã€‚æ¯ä¸ªæµéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ•´æ•° IDã€‚æµIDå°±æ˜¯ç”¨æ¥æ ‡è¯†è¯¥å¸§å±äºå“ªä¸ªæµçš„ï¼Œè¿™æ ·ä¸€ä¸ªè¿æ¥ä¸Šä¼ è¾“çš„å¸§æ‰èƒ½çŸ¥é“è‡ªå·±å±äºå“ªä¸ªæµï¼Œæ¥æ”¶æ–¹æ‰èƒ½æ­£ç¡®çš„è¿›è¡Œæ‹¼æ¥å¸§ä¸è‡³äºæ‹¼æ¥äº†åˆ«çš„æµçš„å¸§ã€‚å¯ä»¥é¢„è§å•ä¸ªæµçš„æ‰€æœ‰å¸§ä¹‹é—´æ˜¯æœ‰åºçš„ã€‚</p>
<p>RFCè§„å®šç”±å®¢æˆ·ç«¯åˆå§‹åŒ–çš„æµä½¿ç”¨å¥‡æ•°IDï¼Œç”±æœåŠ¡å™¨åˆå§‹åŒ–çš„æµä½¿ç”¨å¶æ•°IDï¼Œè¿™é‡Œä¸æ˜¯å¾ˆæ‡‚ï¼Œä»€ä¹ˆæƒ…å†µä¸‹æœåŠ¡å™¨ä¼šåˆå§‹åŒ–æµï¼Ÿè¯·æ±‚ä¸éƒ½æ˜¯ç”±å®¢æˆ·ç«¯å‘èµ·çš„å—ï¼Ÿ</p>
<p>åœ¨RFC 8.2.2.  Push Responsesä¸­æœ‰è¯´æ˜ï¼š</p>
<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line">After sending <span class="keyword">the</span> PUSH_PROMISE frame, <span class="keyword">the</span> server can begin delivering</span><br><span class="line"><span class="keyword">the</span> pushed response <span class="keyword">as</span> <span class="keyword">a</span> response (Section <span class="number">8.1</span><span class="number">.2</span><span class="number">.4</span>) <span class="keyword">on</span> <span class="title">a</span> <span class="title">server</span>-</span><br><span class="line">initiated stream that uses <span class="keyword">the</span> promised stream identifier.</span><br></pre></td></tr></table></figure>
<p>æœç„¶æ˜¯æœåŠ¡å™¨æ¨é€æ—¶ï¼ŒæœåŠ¡å™¨ä¼šåˆå§‹åŒ–æµï¼Œæ­¤æ—¶æµçš„IDå°±ä¸ºå¶æ•°ã€‚</p>
<p><strong>äºŒè¿›åˆ¶åˆ†å¸§å±‚</strong></p>
<p>åœ¨ä¸æ”¹åŠ¨ HTTP/1.1 çš„è¯­ä¹‰ã€â½…æ³•ã€çŠ¶æ€ç ã€URI ä»¥åŠâ¾¸éƒ¨å­—æ®µç­‰ç­‰çš„æƒ…å†µä¸‹, HTTP/1.1 æ˜¯å¦‚ä½•è½¬åˆ°HTTP/2å‘¢? </p>
<p>ç­”æ¡ˆå°±æ˜¯HTTP/1.1 çš„æŠ¥æ–‡å…ˆç»è¿‡â¼€ä¸ªâ¼†è¿›åˆ¶åˆ†å¸§å±‚å°†å…¶è½¬åŒ–ä¸ºHTTP/2 äºŒè¿›åˆ¶åè®®ï¼Œåé¢çš„å°±æ˜¯ä¸€æ ·çš„äº†ã€‚</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/2860230-0c2d3d66de3e9a87.png" alt=""></p>
<p>åœ¨ HTTP/2 ä¸­ï¼Œæœ‰äº†äºŒè¿›åˆ¶åˆ†å¸§ä¹‹åï¼ŒHTTP /2 ä¸å†ä¾èµ– TCP é“¾æ¥å»å®ç°å¤šæµå¹¶è¡Œäº†ï¼Œè¿™ä¸€ç‰¹æ€§ï¼Œä½¿æ€§èƒ½æœ‰äº†æå¤§æå‡ï¼š</p>
<ul>
<li><strong>åŒä¸ªåŸŸå</strong>åªéœ€è¦å ç”¨ä¸€ä¸ª TCP è¿æ¥ï¼Œä½¿ç”¨ä¸€ä¸ªè¿æ¥å¹¶è¡Œå‘é€å¤šä¸ªè¯·æ±‚å’Œå“åº”ï¼Œæ¶ˆé™¤äº†å› å¤šä¸ª TCP è¿æ¥è€Œå¸¦æ¥çš„å»¶æ—¶å’Œå†…å­˜æ¶ˆè€—ã€‚</li>
<li>å¯ä»¥å¹¶è¡Œäº¤é”™åœ°å‘é€å¤šä¸ªè¯·æ±‚ï¼Œè¯·æ±‚ä¹‹é—´äº’ä¸å½±å“ã€‚</li>
<li>å¯ä»¥å¹¶è¡Œäº¤é”™åœ°å‘é€å¤šä¸ªå“åº”ï¼Œå“åº”ä¹‹é—´äº’ä¸å¹²æ‰°ã€‚</li>
<li>åœ¨ HTTP/2 ä¸­ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½å¯ä»¥å¸¦ä¸€ä¸ª 31bit çš„ä¼˜å…ˆå€¼ï¼Œ0 è¡¨ç¤ºæœ€é«˜ä¼˜å…ˆçº§ï¼Œ æ•°å€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šä½ã€‚æœ‰äº†è¿™ä¸ªä¼˜å…ˆå€¼ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å°±å¯ä»¥åœ¨å¤„ç†ä¸åŒçš„æµæ—¶é‡‡å–ä¸åŒçš„ç­–ç•¥ï¼Œä»¥æœ€ä¼˜çš„æ–¹å¼å‘é€æµã€æ¶ˆæ¯å’Œå¸§ã€‚</li>
</ul>
<p><strong>2.å¤šè·¯å¤ç”¨</strong></p>
<p>HTTP/2 å¤ç”¨TCPè¿æ¥ï¼Œåœ¨ä¸€ä¸ªè¿æ¥é‡Œï¼Œå®¢æˆ·ç«¯å¯ä»¥åŒæ—¶å‘é€å¤šä¸ªè¯·æ±‚ï¼ŒæœåŠ¡å™¨ç«¯å›å¤çš„å“åº”ä¹Ÿä¸ç”¨æŒ‰ç…§é¡ºåºä¸€ä¸€å¯¹åº”ï¼Œè¿™æ ·å°±é¿å…äº†â€é˜Ÿå¤´å µå¡â€ã€‚</p>
<p>å®¢æˆ·ç«¯æ ¹æ®æµIDæ¥åŒºåˆ†ä¸åŒçš„å¸§ä»è€Œåˆ†åˆ«å¾—åˆ°Aå’ŒBçš„å“åº”ã€‚</p>
<p><strong>3.Header å‹ç¼©</strong></p>
<p>HTTP2.0 ä½¿ç”¨ HPACK ç®—æ³•å¯¹ header çš„æ•°æ®è¿›è¡Œå‹ç¼©ï¼Œå‡å°‘è¯·æ±‚çš„å¤§å°ï¼Œå‡å°‘æµé‡æ¶ˆè€—ï¼Œæé«˜æ•ˆç‡ã€‚å› ä¸ºä¹‹å‰å­˜åœ¨ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½è¦å¸¦ä¸Š headerï¼Œè€Œè¿™ä¸ª header ä¸­çš„æ•°æ®é€šå¸¸æ˜¯ä¸å˜çš„ã€‚</p>
<p><strong>4.Server Push</strong></p>
<p>HTTP/2 å…è®¸æœåŠ¡å™¨æœªç»è¯·æ±‚ï¼Œä¸»åŠ¨å‘å®¢æˆ·ç«¯å‘é€èµ„æºï¼Œè¿™å«åšæœåŠ¡å™¨æ¨é€ï¼ˆserver pushï¼‰ã€‚</p>
<p>å¸¸è§åœºæ™¯æ˜¯å®¢æˆ·ç«¯è¯·æ±‚ä¸€ä¸ªç½‘é¡µï¼Œè¿™ä¸ªç½‘é¡µé‡Œé¢åŒ…å«å¾ˆå¤šé™æ€èµ„æºã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯å¿…é¡»æ”¶åˆ°ç½‘é¡µåï¼Œè§£æHTMLæºç ï¼Œå‘ç°æœ‰é™æ€èµ„æºï¼Œå†å‘å‡ºé™æ€èµ„æºè¯·æ±‚ã€‚å…¶å®ï¼ŒæœåŠ¡å™¨å¯ä»¥é¢„æœŸåˆ°å®¢æˆ·ç«¯è¯·æ±‚ç½‘é¡µåï¼Œå¾ˆå¯èƒ½ä¼šå†è¯·æ±‚é™æ€èµ„æºï¼Œæ‰€ä»¥å°±ä¸»åŠ¨æŠŠè¿™äº›é™æ€èµ„æºéšç€ç½‘é¡µä¸€èµ·å‘ç»™å®¢æˆ·ç«¯äº†ã€‚</p>
<p><strong>HTTP/2 ç¼ºç‚¹ï¼š</strong></p>
<p><strong>1.æ²¡æœ‰å½»åº•è§£å†³é˜Ÿå¤´é˜»å¡</strong></p>
<p>HTTP/2 å¹¶æ²¡æœ‰å½»åº•è§£å†³é˜Ÿå¤´é˜»å¡ï¼Œç”±äºHTTP2æ˜¯åœ¨ä¸€ä¸ªTCPè¿æ¥ä¸Šå‘é€è¯·æ±‚ï¼Œæ¥æ”¶è¯·æ±‚çš„ã€‚ä¸€æ—¦å‡ºç°ä¸¢åŒ…ï¼Œä¸¢å¤±çš„åŒ…å¿…é¡»è¦ç­‰å¾…é‡æ–°ä¼ è¾“ç¡®è®¤ï¼Œå› æ­¤HTTP/2 å‡ºç°ä¸¢åŒ…æ—¶ï¼Œæ•´ä¸ª TCP éƒ½è¦å¼€å§‹ç­‰å¾…é‡ä¼ ï¼Œé‚£ä¹ˆå°±ä¼šé˜»å¡è¯¥ TCP è¿æ¥ä¸­çš„æ‰€æœ‰è¯·æ±‚ã€‚è€Œå¯¹äº HTTP/1.1 æ¥è¯´ï¼Œå¯ä»¥å¼€å¯å¤šä¸ª TCP è¿æ¥ï¼Œå‡ºç°è¿™ç§æƒ…å†µåå€’åªä¼šå½±å“å…¶ä¸­ä¸€ä¸ªè¿æ¥ï¼Œå‰©ä½™çš„ TCP è¿æ¥è¿˜å¯ä»¥æ­£å¸¸ä¼ è¾“æ•°æ®ã€‚</p>
<p><strong>2.TCP å’Œ TCP+TLS å»ºç«‹è¿æ¥çš„å»¶æ—¶</strong></p>
<p>HTTP/2 æ˜¯ä½¿ç”¨ TCP åè®®æ¥ä¼ è¾“çš„ã€‚å¦‚æœä½¿ç”¨ HTTPS çš„è¯ï¼Œè¿˜éœ€è¦ä½¿ç”¨ TLS åè®®è¿›è¡Œå®‰å…¨ä¼ è¾“ï¼Œè€Œä½¿ç”¨ TLS ä¹Ÿéœ€è¦ä¸€ä¸ªæ¡æ‰‹è¿‡ç¨‹ï¼Œè¿™æ ·å°±éœ€è¦æœ‰ä¸¤ä¸ªæ¡æ‰‹å»¶è¿Ÿè¿‡ç¨‹ã€‚</p>
<p>ä¸Šé¢ä¸¤ä¸ªé—®é¢˜è¦åŠ¨å¤§åˆ€æ‰èƒ½è§£å†³ï¼Œå› ä¸ºè¿™æ˜¯åº•å±‚æ”¯æ’‘çš„ TCP åè®®é€ æˆçš„ã€‚è¦æƒ³ä¼˜åŒ–çš„è¯ï¼Œåªèƒ½æ›¿æ¢åº•å±‚çš„TCPäº†ã€‚</p>
<p>HTTP/3åŠè°·æ­Œçš„QUICåè®®ï¼ˆä¸»è¦æ˜¯è°·æ­Œï¼Œæ¯•ç«Ÿåªè¦è°·æ­Œæå®Œåæµ‹è¯•æ­£å¸¸ï¼ŒRFCç›´æ¥å°†å…¶å®šä¸ºè§„èŒƒå°±å®Œäº‹äº†ï¼‰å°±æ˜¯ä¸ºè§£å†³ä¸Šè¿°é—®é¢˜è€Œæå‡ºçš„æ–¹æ¡ˆã€‚</p>
<p><strong>å‚è€ƒ</strong></p>
<p><a href="https://developers.google.com/web/fundamentals/performance/http2">HTTP/2 ç®€ä»‹</a></p>
<p><a href="https://blog.wangriyu.wang/2018/05-HTTP2.html">HTTP2 è¯¦è§£</a></p>
<p><a href="https://skyao.io/learning-http2/frame/">HTTP2/å¸§</a></p>
<h4 id="QUICå’ŒHTTP-3"><a href="#QUICå’ŒHTTP-3" class="headerlink" title="QUICå’ŒHTTP/3"></a>QUICå’ŒHTTP/3</h4><p>HTTP/3 å·²äº 2022å¹´6æœˆ6æ—¥æ­£å¼å‘å¸ƒäº†ï¼Œè¢«æ ‡å‡†åŒ–ä¸º RFC 9114ã€‚</p>
<p>QUIC åŸºäº UDPï¼Œè€Œ UDP æ˜¯â€œæ— è¿æ¥â€çš„ï¼Œæ ¹æœ¬å°±ä¸éœ€è¦â€œæ¡æ‰‹â€å’Œâ€œæŒ¥æ‰‹â€ï¼Œæ‰€ä»¥å°±æ¯” TCP æ¥å¾—å¿«ã€‚æ­¤å¤–ï¼ŒQUIC ä¹Ÿå®ç°äº†å¯é ä¼ è¾“ï¼Œä¿è¯æ•°æ®ä¸€å®šèƒ½å¤ŸæŠµè¾¾ç›®çš„åœ°ã€‚å®ƒè¿˜å¼•å…¥äº†ç±»ä¼¼ HTTP/2 çš„â€œæµâ€å’Œâ€œå¤šè·¯å¤ç”¨â€ï¼Œå•ä¸ªâ€œæµâ€æ˜¯æœ‰åºçš„ï¼Œå¯èƒ½ä¼šå› ä¸ºä¸¢åŒ…è€Œé˜»å¡ï¼Œä½†å…¶ä»–â€œæµâ€ä¸ä¼šå—åˆ°å½±å“ã€‚</p>
<h3 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h3><h4 id="ä¸ºä»€ä¹ˆè¦å¤ç”¨è¿æ¥"><a href="#ä¸ºä»€ä¹ˆè¦å¤ç”¨è¿æ¥" class="headerlink" title="ä¸ºä»€ä¹ˆè¦å¤ç”¨è¿æ¥?"></a>ä¸ºä»€ä¹ˆè¦å¤ç”¨è¿æ¥?</h4><p>HTTPè€—æ—¶ = TCPæ¡æ‰‹</p>
<p>HTTPSè€—æ—¶ = TCPæ¡æ‰‹ + SSLæ¡æ‰‹</p>
<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">curl <span class="operator">-</span>w <span class="string">&quot;TCP handshake: %&#123;time_connect&#125;, SSL handshake: %&#123;time_appconnect&#125;<span class="char escape_">\n</span>&quot;</span> <span class="operator">-</span>so <span class="symbol">/dev/null</span> https:<span class="symbol">//www.alipay.com</span></span><br><span class="line">TCP <span class="params">handshake:</span> <span class="number">0.035926</span>, SSL <span class="params">handshake:</span> <span class="number">0.138877</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢å‘½ä»¤ä¸­çš„wå‚æ•°è¡¨ç¤ºæŒ‡å®šè¾“å‡ºæ ¼å¼ï¼Œtime_connectå˜é‡è¡¨ç¤ºTCPæ¡æ‰‹çš„è€—æ—¶ï¼Œtime_appconnectå˜é‡è¡¨ç¤ºSSLæ¡æ‰‹çš„è€—æ—¶ï¼ˆæ›´å¤šå˜é‡è¯·æŸ¥çœ‹<a href="http://curl.haxx.se/docs/manpage.html">æ–‡æ¡£</a>å’Œ<a href="https://josephscott.org/archives/2011/10/timing-details-with-curl/">å®ä¾‹</a>ï¼‰ï¼Œså‚æ•°å’Œoå‚æ•°ç”¨æ¥å…³é—­æ ‡å‡†è¾“å‡ºã€‚å¦å¤–é’èŠ±ç“·æŠ“åŒ…ä¹Ÿå¯ä»¥çœ‹åˆ°å„é˜¶æ®µçš„è€—æ—¶ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°å¦‚æœä¸å¤ç”¨è¿æ¥ï¼Œé‚£ä¹ˆæ¯æ¬¡éƒ½è¦3æ¬¡TCPæ¡æ‰‹å»ºç«‹TCPè¿æ¥ï¼Œ7æ¬¡SSLæ¡æ‰‹å»ºç«‹SSLè¿æ¥ï¼Œè€Œè¿™äº›è¿æ¥çš„å»ºç«‹éƒ½éœ€è¦è€—æ—¶ï¼Œç‰¹åˆ«æ˜¯å»ºç«‹SSLè¿æ¥è€—æ—¶æ›´å¤§ï¼Œå·®ä¸å¤šæ˜¯TCPçš„2-3å€ã€‚</p>
<p>é™¤äº†å»ºç«‹è¿æ¥è€—æ—¶å¤–ï¼ŒTCPçš„æ…¢å¯åŠ¨æœºåˆ¶ä¹Ÿä¼šå½±å“ä¼ è¾“é€Ÿåº¦ã€‚</p>
<p>å› æ­¤ä»HTTP1.1ç‰ˆæœ¬å¼€å§‹å°±æ”¯æŒè¿æ¥çš„å¤ç”¨äº†ï¼Œåªä¸è¿‡HTTP1.1ç‰ˆæœ¬çš„è¿æ¥å¤ç”¨è¿˜ä¸æˆç†Ÿï¼Œæ¯•ç«ŸæŠ€æœ¯éƒ½æœ‰ä¸€ä¸ªä¸æ–­ä¼˜åŒ–çš„è¿‡ç¨‹ï¼Œä»æ¥éƒ½ä¸æ˜¯ä¸€è¹´è€Œå°±çš„ã€‚</p>
<p><a href="https://www.iteye.com/blog/a280606790-1095085">HTTPåè®®å¤´éƒ¨ä¸Keep-Aliveæ¨¡å¼è¯¦è§£</a></p>
<h4 id="HTTP2ï¼Œå¸§é—´é¡ºåºå¦‚ä½•ä¿è¯ï¼Ÿ"><a href="#HTTP2ï¼Œå¸§é—´é¡ºåºå¦‚ä½•ä¿è¯ï¼Ÿ" class="headerlink" title="HTTP2ï¼Œå¸§é—´é¡ºåºå¦‚ä½•ä¿è¯ï¼Ÿ"></a>HTTP2ï¼Œå¸§é—´é¡ºåºå¦‚ä½•ä¿è¯ï¼Ÿ</h4><p>ï¼ˆç½‘ä¸Šçš„åšå®¢ï¼‰:æµå†…éƒ¨çš„å¸§æ˜¯æœ‰ä¸¥æ ¼é¡ºåºçš„ï¼ˆä¸ç¡®å®šæ˜¯ç”±åè®®å­—æ®µæ¥ä¿è¯è¿˜æ˜¯ç”±å‘é€ç«¯ä¸¥æ ¼æŒ‰ç…§é¡ºåºå‘é€æ¥ä¿è¯ï¼Œæ„Ÿè§‰åº”è¯¥æ˜¯ç”±å‘é€ç«¯æ¥ä¿è¯ï¼Œå› ä¸ºåè®®é‡Œæ²¡æœ‰ç›¸å…³å­—æ®µï¼‰ï¼Œä½†æ˜¯æµä¹‹é—´äº’ç›¸ç‹¬ç«‹ï¼›<strong>æµ ID ä¸èƒ½é‡ç”¨</strong>ï¼Œåªèƒ½<strong>é¡ºåº</strong>é€’å¢ï¼Œå®¢æˆ·ç«¯å‘èµ·çš„ Stream ID æ˜¯å¥‡æ•°ï¼ŒæœåŠ¡å™¨ç«¯å‘èµ·çš„ Stream ID æ˜¯å¶æ•°ï¼›</p>
<h4 id="HTTP1-1å¦‚ä½•åå•†å‡çº§åˆ°HTTP2"><a href="#HTTP1-1å¦‚ä½•åå•†å‡çº§åˆ°HTTP2" class="headerlink" title="HTTP1.1å¦‚ä½•åå•†å‡çº§åˆ°HTTP2"></a>HTTP1.1å¦‚ä½•åå•†å‡çº§åˆ°HTTP2</h4><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>example.com</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Upgrade, HTTP2-Settings</span><br><span class="line"><span class="attribute">Upgrade</span><span class="punctuation">: </span>h2c</span><br><span class="line"><span class="attribute">HTTP2-Settings</span><span class="punctuation">: </span>&lt;base64url encoding of HTTP/2 SETTINGS payload&gt;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæœåŠ¡ç«¯ä¸æ”¯æŒ HTTP/2ï¼Œå®ƒä¼šå¿½ç•¥ <code>Upgrade</code> å­—æ®µï¼Œç›´æ¥è¿”å› HTTP/1.1 å“åº”ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>243</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html</span><br><span class="line"></span><br><span class="line"><span class="language-node-repl"><span class="meta prompt_">...</span></span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœæœåŠ¡ç«¯æ”¯æŒ HTTP/2ï¼Œé‚£å°±å¯ä»¥å›åº” <code>101</code> çŠ¶æ€ç åŠå¯¹åº”å¤´éƒ¨ï¼Œå¹¶ä¸”åœ¨å“åº”æ­£æ–‡ä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨ HTTP/2 äºŒè¿›åˆ¶å¸§ï¼š</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">101</span> Switching Protocols</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Upgrade</span><br><span class="line"><span class="attribute">Upgrade</span><span class="punctuation">: </span>h2c</span><br><span class="line"></span><br><span class="line"><span class="language-angelscript"><span class="string">[ HTTP/2 connection ... ]</span></span></span><br></pre></td></tr></table></figure>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://lixiaoyu.cc/2018/09/04/computer-network-12-http-version-differences/">HTTP å„ç‰ˆæœ¬å·®å¼‚</a>  </p>
<p><a href="https://www.ruanyifeng.com/blog/2016/08/http.html">HTTP åè®®å…¥é—¨</a>   é˜®ä¸€å³°</p>
<p><a href="https://www.infoq.cn/article/kU4OkqR8vH123a8dLCCJ">è§£å¯† HTTP/2 ä¸ HTTP/3 çš„æ–°ç‰¹æ€§</a></p>
<p><a href="https://www.zhihu.com/question/34074946">HTTP/2 ç›¸æ¯” 1.0 æœ‰å“ªäº›é‡å¤§æ”¹è¿›ï¼Ÿ</a>  çŸ¥ä¹å›ç­”</p>
<p><a href="https://segmentfault.com/a/1190000007219256">æ·±å…¥ç ”ç©¶ï¼šHTTP2 çš„çœŸæ­£æ€§èƒ½åˆ°åº•å¦‚ä½•</a></p>
<p><a href="https://www.cnblogs.com/syfwhu/p/6116277.html">HTTP 1.1å­¦ä¹ ç¬”è®°</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/140739394">æ·±å…¥è§£è¯»HTTP3çš„åŸç†åŠåº”ç”¨</a></p>
<p><a href="https://tools.ietf.org/html/rfc1945">rfc1945â€”Hypertext Transfer Protocol â€” HTTP/1.0</a></p>
<p><a href="https://tools.ietf.org/html/rfc2616">rfc2616â€”Hypertext Transfer Protocol â€” HTTP/1.1 </a></p>
<p><a href="https://tools.ietf.org/html/rfc7540">rfc7540â€”Hypertext Transfer Protocol Version 2 (HTTP/2)</a></p>
<p><a href="https://quicwg.org/base-drafts/draft-ietf-quic-http.html">Hypertext Transfer Protocol Version 3 (HTTP/3)</a></p>
<p><a href="https://www.cnblogs.com/noKing/p/9334243.html">HTTP/HTTPSåè®®</a>  é¢è¯•é—®é¢˜</p>
<p><a href="https://hungryturbo.com/HTTP3-explained/">HTTP/3è¯¦è§£</a>  4</p>
<p><a href="https://imququ.com/post/protocol-negotiation-in-http2.html">è°ˆè°ˆ HTTP/2 çš„åè®®åå•†æœºåˆ¶</a></p>
]]></content>
      <categories>
        <category>HTTP</category>
      </categories>
  </entry>
  <entry>
    <title>ç±»åˆ«è¦†ç›–åŸå§‹å®ç°å¼•å‘çš„è–›å®šè°”çš„bug</title>
    <url>/2021/12/18/%E7%B1%BB%E5%88%AB%E8%A6%86%E7%9B%96%E5%8E%9F%E5%A7%8B%E5%AE%9E%E7%8E%B0%E5%BC%95%E5%8F%91%E7%9A%84%E8%96%9B%E5%AE%9A%E8%B0%94%E7%9A%84bug/</url>
    <content><![CDATA[<h4 id="Bug"><a href="#Bug" class="headerlink" title="Bug"></a>Bug</h4><p>å‡ºç°æœºå‹ï¼šiPhone7Plus iOS15.1ã€‚</p>
<p>æè¿°ï¼šåœ¨å¼€å‘è¿‡ç¨‹ä¸­å‘ç°å¼¹å‡ºå¼¹çª—ç‚¹å‡»å…³é—­ä¹‹åç•Œé¢å°±å¡æ­»äº†ã€‚å¤šæ¬¡å°è¯•ä¹‹åï¼Œæœ€ç»ˆå‘ç°åªæœ‰åœ¨è°ƒè¯•çš„æ—¶å€™å‡ºç°ï¼ŒæŠŠçº¿ä¸€æ‹”ä¸è°ƒè¯•çš„æ—¶å€™ä¸€åˆ‡åˆæ­£å¸¸äº†ã€‚æ‹¿å¦ä¸€éƒ¨iPhone6Plus iOS12.5.4çš„æ‰‹æœºåˆéƒ½ä¸ä¼šå‡ºç°ã€‚é¡¿æ—¶æ„Ÿè§‰é‡åˆ°â€è–›å®šè°”çš„bugâ€äº†ã€‚</p>
<h4 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h4><p>é¡¹ç›®ä¸­å¯¹UIAlertControlleråšäº†ä¸€å±‚ç®€å•çš„å°è£…ï¼Œæ˜¯åœ¨è‡ªå·±çš„windowä¸Špresentå‡ºæ¥çš„ï¼Œè¿™æ ·åœ¨ä½¿ç”¨çš„æ—¶å€™å°±ä¸ç”¨æ“å¿ƒè°æ¥presentäº†ã€‚</p>
<p>æ–¹æ³•æ¥å£ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+ (void)showActionSheetWithTitle:(nullable NSString *)title message:(nullable NSString *)message cancelButtonTitle:(nullable NSString *)cancelButtonTitle destructiveButtonIndex:(NSInteger)destructiveButtonIndex buttonTitles:(nullable NSArray *)buttonTitles showedPatternHandler:(nullable NSDictionary *(^)(void))showedPatternHandler buttonClickedHandler:(nullable void(^)(NSUInteger buttonIndex))buttonClickedHandler;</span><br></pre></td></tr></table></figure>
<p>å†…éƒ¨éƒ¨åˆ†å®ç°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UIAlertController *alertController = [UIAlertController alertControllerWithTitle:title message:message preferredStyle:preferredStyle];</span><br><span class="line">alertController.alertWindow = [[UIWindow alloc] initWithFrame:[[UIScreen mainScreen] bounds]];</span><br><span class="line">alertController.alertWindow.backgroundColor = [UIColor clearColor];</span><br><span class="line">alertController.alertWindow.hidden = NO;</span><br><span class="line">...</span><br><span class="line">alertController.alertWindow.rootViewController = [UIViewController new];</span><br><span class="line">[alertController.alertWindow.rootViewController presentViewController:alertController animated:YES completion:nil];</span><br></pre></td></tr></table></figure>
<p>åˆšå¼€å§‹æ—¶ï¼Œå¯¹è±¡æŒæœ‰å…³ç³»ï¼š</p>
<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">alertController</span>------&gt;</span><span class="function"><span class="title">alertWindow</span>------&gt;</span>rootViewController</span><br></pre></td></tr></table></figure>
<p>å½“presentå</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[alertController.alertWindow.rootViewController presentViewController:alertController animated:YES completion:nil]</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>rootViewControllerçš„æ§åˆ¶å™¨æ ˆä¼šæŒæœ‰alertControllerï¼Œäºæ˜¯å¯¹è±¡å…³ç³»å˜ä¸ºï¼š</p>
<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">alertController</span>------&gt;</span><span class="function"><span class="title">alertWindow</span>------&gt;</span>rootViewController</span><br><span class="line">        â†‘----------------------------------------|</span><br></pre></td></tr></table></figure>
<p>å½¢æˆäº†ä¸€ä¸ªå¾ªç¯ï¼Œå› æ­¤ä¸‰è€…éƒ½ä¸ä¼šè¢«é‡Šæ”¾ã€‚</p>
<p>å½“ç‚¹å‡»alertControllerä¸Šçš„æŸä¸ªæŒ‰é’®æ—¶ç³»ç»Ÿä¼šè‡ªåŠ¨è°ƒç”¨dismissäºæ˜¯alertControllerä»æ§åˆ¶å™¨æ ˆç§»é™¤ï¼Œäºæ˜¯rootViewControllerä¸å†æŒæœ‰alertControllerï¼Œå¾ªç¯è¢«æ‰“ç ´ï¼Œä¸‰è€…é‡Šæ”¾ï¼Œwindowè‡ªç„¶ä¹Ÿè¢«ç§»é™¤ã€‚ä¸ºæ–¹ä¾¿è¡¨è¿°æš‚ä¸”å°†è¿™ç§æ‰“ç ´å¾ªç¯çš„æ–¹å¼ç§°ä¸ºè‡ªåŠ¨æ‰“ç ´ã€‚</p>
<figure class="highlight brainfuck"><table><tr><td class="code"><pre><span class="line"><span class="comment">alertController</span><span class="literal">------</span>&gt;<span class="comment">alertWindow</span><span class="literal">------</span>&gt;<span class="comment">rootViewController</span></span><br><span class="line">        <span class="comment">â†‘</span><span class="literal">------------------</span> <span class="comment">X</span> <span class="literal">-------------------</span> <span class="comment">|</span></span><br></pre></td></tr></table></figure>
<p>ç”±äºå¾ªç¯ä¼šè‡ªåŠ¨æ‰“ç ´ï¼Œå› æ­¤å†…å­˜èƒ½å¤Ÿæ­£å¸¸å›æ”¶ã€‚è°ƒç”¨dismissåï¼Œåœ¨iOS10.3.3ã€iOS12.5.4ã€iOS15.1ä¸Šéƒ½èƒ½é”€æ¯ï¼Œå’Œåˆ†æçš„ä¸€è‡´ã€‚</p>
<p>åœ¨çœ‹å®ç°çš„æ—¶å€™ï¼Œçœ‹åˆ°å°è£…çš„äººä¸ºäº†é¿å…æ½œåœ¨çš„å¼•ç”¨å¾ªç¯ï¼Œåœ¨<strong>ç±»åˆ«</strong>é‡Œé‡å†™äº†viewDidDisappear:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)viewDidDisappear:(<span class="type">BOOL</span>)animated &#123;</span><br><span class="line">    [<span class="variable language_">super</span> viewDidDisappear:animated];</span><br><span class="line">    <span class="keyword">self</span>.alertWindow = <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å½“å¼¹çª—æ§åˆ¶å™¨dismissæ—¶ï¼ŒviewDidDisappearä¼šè¢«è°ƒç”¨ï¼ŒalertWindowä¼šè¢«ç½®ä¸ºnilï¼Œå¾ªç¯è¢«æ‰“ç ´ã€‚è¿™é‡Œå°†è¿™ç§å¾ªç¯æ‰“ç ´æ–¹å¼ç§°ä¸ºä¸»åŠ¨æ‰“ç ´ã€‚</p>
<p>æ¯”è¾ƒä¸€ä¸‹è¿™ä¸¤ç§æ‰“ç ´æ–¹å¼ï¼Œ</p>
<p>è‡ªåŠ¨æ‰“ç ´ï¼š</p>
<figure class="highlight brainfuck"><table><tr><td class="code"><pre><span class="line"><span class="comment">alertController</span><span class="literal">------</span>&gt;<span class="comment">alertWindow</span><span class="literal">------</span>&gt;<span class="comment">rootViewController</span></span><br><span class="line">        <span class="comment">â†‘</span><span class="literal">------------------</span> <span class="comment">X</span> <span class="literal">-------------------</span> <span class="comment">|</span></span><br></pre></td></tr></table></figure>
<p>ä¸»åŠ¨æ‰“ç ´ï¼š</p>
<figure class="highlight brainfuck"><table><tr><td class="code"><pre><span class="line"><span class="comment">alertController</span><span class="literal">---</span><span class="comment">X</span><span class="literal">---</span>&gt;<span class="comment">alertWindow</span><span class="literal">------</span>&gt;<span class="comment">rootViewController</span></span><br><span class="line">        <span class="comment">â†‘</span><span class="literal">------------------</span> <span class="comment">X</span> <span class="literal">-------------------</span> <span class="comment">|</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°å½“dismissæ—¶ä¸»åŠ¨æ‰“ç ´æœ‰ä¸¤å¤„æ‰“ç ´çš„åœ°æ–¹ã€‚</p>
<p>è€ƒè™‘å¦‚ä¸‹åœºæ™¯ï¼Œå‡å¦‚æœ‰å…¶ä»–åœ°æ–¹å¼ºå¼•ç”¨äº†alertControllerï¼Œå¯¹äºè‡ªåŠ¨æ‰“ç ´å…³ç³»å›¾ä¸ºï¼š</p>
<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">obj</span>------&gt;</span><span class="function"><span class="title">alertController</span>------&gt;</span><span class="function"><span class="title">alertWindow</span>------&gt;</span>rootViewController</span><br><span class="line">                â†‘----------------------------------------|</span><br></pre></td></tr></table></figure>
<p>å½“è°ƒç”¨dismissåï¼Œå…³ç³»å›¾å˜ä¸ºï¼š</p>
<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">obj</span>------&gt;</span><span class="function"><span class="title">alertController</span>------&gt;</span><span class="function"><span class="title">alertWindow</span>------&gt;</span>rootViewController</span><br><span class="line">                â†‘--------------------X--------------------|</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°windowå¹¶ä¸ä¼šè¢«é”€æ¯ï¼Œwindowä¸é”€æ¯ä¼šå‡ºç°è°ƒç”¨dismissåå¼¹çª—è™½ç„¶æ¶ˆå¤±äº†ï¼Œä½†ç”±äºæ²¡æœ‰å°†windowéšè—ï¼Œå®ƒå…¶å®è¿˜åœ¨è§†å›¾å±‚çº§ä¸­ï¼Œåªä¸è¿‡æ˜¯é€æ˜çš„ï¼Œè¿™æ—¶ç”¨æˆ·æ˜¯æ— æ³•ç‚¹å‡»çœ‹åˆ°çš„æ§ä»¶çš„ï¼Œæ•´ä¸ªAPPå°±åƒå¡æ­»äº†ä¸€æ ·ï¼Œå®é™…ä¸Šæ˜¯å› ä¸ºæœ€ä¸Šå±‚æœ‰ä¸€å±‚é€æ˜çš„windowï¼Œäº‹ä»¶éƒ½è¢«è¿™ä¸ªé€æ˜çš„windowåƒäº†ã€‚</p>
<p>è€Œä¸»åŠ¨æ‰“ç ´å…³ç³»å›¾ä¸ºï¼š</p>
<figure class="highlight brainfuck"><table><tr><td class="code"><pre><span class="line"><span class="comment">obj</span><span class="literal">------</span>&gt;<span class="comment">alertController</span><span class="literal">---</span><span class="comment">X</span><span class="literal">---</span>&gt;<span class="comment">alertWindow</span><span class="literal">------</span>&gt;<span class="comment">rootViewController</span></span><br><span class="line">                <span class="comment">â†‘</span><span class="literal">--------------------</span><span class="comment">X</span><span class="literal">--------------------</span><span class="comment">|</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥ç¡®ä¿windowè¢«é”€æ¯ï¼Œwindowè¢«é”€æ¯äº†è‡ªç„¶ä¸ä¼šå‡ºç°åœ¨è§†å›¾å±‚çº§ä¸­ï¼Œå› æ­¤å°±ç®—æœ‰å¤–éƒ¨å¼ºå¼•ç”¨alertControllerä¹Ÿä¸ä¼šå‘ç”Ÿä¸Šé¢çš„å¯æ€•bugã€‚ç„¶è€Œå®é™…æƒ…å†µå´å‡ºç°äº†ä¸Šé¢çš„bugã€‚WTFï¼Ÿ</p>
<h4 id="å¯èƒ½çš„åŸå› "><a href="#å¯èƒ½çš„åŸå› " class="headerlink" title="å¯èƒ½çš„åŸå› "></a>å¯èƒ½çš„åŸå› </h4><p>æœ‰æ²¡æœ‰ä¸€ç§å¯èƒ½ï¼Œåœ¨iPhone7plus iOS15.1ä¸Šï¼Œè„±æœºæ—¶dismisså¼¹çª—ä»£ç èµ°çš„æ˜¯ç±»åˆ«çš„å®ç°viewDidDisappearï¼Œä½†æ˜¯è”æœºæ—¶ä»£ç èµ°çš„æ˜¯ç³»ç»Ÿçš„viewDidDisappearå®ç°ã€‚è€Œåœ¨iOS12.5.4ä¸Šèµ°çš„éƒ½æ˜¯ç±»åˆ«çš„å®ç°ï¼Ÿ</p>
<p>ä½†æ˜¯è¿™åˆè·Ÿæˆ‘çœ‹çš„runtimeåº•å±‚å®ç°ç±»åˆ«çš„åŠ è½½æœ‰å†²çªï¼ŒæŒ‰ç…§ç±»åˆ«çš„åŠ è½½æœºåˆ¶ï¼Œç±»åˆ«ä¼šè¦†ç›–åŸç±»çš„å®ç°ï¼Œå¦‚æœæœ‰å¤šä¸ªç±»åˆ«åˆ™æœ€åä¸€ä¸ªç¼–è¯‘çš„ç±»åˆ«æœ‰æ•ˆæœã€‚æ‰€ä»¥è‚¯å®šæ˜¯ä¸ä¼šèµ°ç³»ç»Ÿçš„å®ç°å•Šï¼OMGï¼</p>
<p>å…ˆä¸ç®¡äº†ï¼Œå…ˆæœä¸€ä¸‹è·ŸUIAlertControllerç›¸å…³çš„ä»£ç ï¼Œç»“æœå‘ç°é¡¹ç›®ä¸­å±…ç„¶æœ‰ä¸‰ä¸ªUIAlertControllerçš„ç±»åˆ«è€Œä¸”éƒ½å®ç°äº†viewDidDisappear:</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/49B6C945762D605C86403C144A2AD6F7.jpg" alt=""></p>
<p>çœŸæ˜¯ä¸æœä¸è¦ç´§ï¼Œä¸€æœå“ä¸€è·³ã€‚</p>
<p>äºæ˜¯æŠŠè¿™ä¸‰ä¸ªç±»åˆ«æ‹–å‡ºæ¥ï¼Œåšäº†ä¸€ä¸ªå°demoéªŒè¯ä¸€ä¸‹ã€‚</p>
<p>è¿™æ˜¯è„±æœºæ‰“å°æ—¥å¿—ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20211218151539.png" alt=""></p>
<p>ç¬¦åˆç¼–è¯‘é¡ºåºï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20211218151559.png" alt=""></p>
<p>è¿™æ˜¯è”æœºæ—¶çš„æ—¥å¿—ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/84166464.png" alt=""></p>
<p>viewDidDisappearçš„æ—¥å¿—æ²¡äº†ï¼Ÿï¼Ÿï¼Ÿå®é™…ä¸Šä»£ç èµ°çš„æ˜¯ç³»ç»Ÿçš„å®ç°ï¼Œè¿™ä¸€ç‚¹å¯ä»¥æ‰“ç¬¦å·æ–­ç‚¹éªŒè¯ã€‚</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20211218151901.png" alt=""></p>
<p>ç»“æœï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20211218152155.png" alt=""></p>
<p>ç¥å¥‡ä¸ç¥å¥‡ï¼Ÿå®Œå…¨æ— è§†runtimeåº•å±‚å®ç°ç±»åˆ«çš„åŠ è½½ï¼Œèµ°çš„ç«Ÿç„¶æ˜¯ç³»ç»Ÿçš„å®ç°ã€‚</p>
<h4 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h4><p>è‡³æ­¤ï¼ŒçœŸç›¸ç»ˆäºå¤§ç™½ï¼Œå’ŒçŒœæƒ³ä¸€è‡´ï¼Œåœ¨iPhone7plus iOS15.1ä¸Šï¼Œè„±æœºæ—¶dismisså¼¹çª—ä»£ç ä¼šèµ°ç±»åˆ«çš„å®ç°viewDidDisappearï¼Œä½†æ˜¯è”æœºæ—¶ä»£ç èµ°çš„æ˜¯ç³»ç»Ÿçš„viewDidDisappearå®ç°ã€‚è€Œåœ¨iOS12.5.4ä¸Šèµ°çš„éƒ½æ˜¯ç±»åˆ«çš„å®ç°ã€‚</p>
<p>æœ‰ä¸¤ç§è§£å†³åŠæ³•ï¼šä¸€ç§æ˜¯åœ¨loadé‡ŒhookåŸç±»çš„viewDidDisappearï¼Œä¸€ç§æ˜¯å­ç±»åŒ–UIAlertControllerã€‚è€ƒè™‘åˆ°loadå¤ªå¤šå½±å“å¯åŠ¨æ—¶é—´ï¼Œè¿˜æ˜¯å­ç±»åŒ–å§ï¼Œè¿™æ ·viewDidDisappearå’Œdeallocæ–¹æ³•éƒ½å¯ä»¥é‡å†™ã€‚</p>
<p>ä»æ­¤ä»¥åæˆ‘å†ä¹Ÿæ²¡æœ‰é‡åˆ°è¿™åªè–›å®šè°”çš„çŒ«äº†ã€‚ä¸è¿‡æˆ‘è¿˜æ˜¯æœ‰ç–‘æƒ‘è”æœºè°ƒè¯•çš„æ—¶å€™ä¸ºå•¥å°±èµ°åˆ°ç³»ç»Ÿçš„å®ç°ï¼Ÿæ˜¯ç³»ç»Ÿå‡ºBugäº†å—ï¼Ÿä¸å¾—è€ŒçŸ¥ï¼Œæˆ–è®¸äº‹æƒ…çš„çœŸç›¸åªæœ‰ç³»ç»Ÿä»–è‡ªå·±æ‰çŸ¥é“äº†ã€‚</p>
]]></content>
      <categories>
        <category>Bug</category>
      </categories>
      <tags>
        <tag>ç±»åˆ«è¦†ç›–</tag>
      </tags>
  </entry>
  <entry>
    <title>ç±»åˆ«å¯¼è‡´çš„target-actionæ–¹æ³•ä¸è°ƒç”¨é—®é¢˜</title>
    <url>/2021/12/01/%E7%B1%BB%E5%88%AB%E5%AF%BC%E8%87%B4%E7%9A%84target-action%E6%96%B9%E6%B3%95%E4%B8%8D%E8%B0%83%E7%94%A8%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<h3 id="Bug"><a href="#Bug" class="headerlink" title="Bug"></a>Bug</h3><p>æè¿°ï¼šZATextField è‡ªå·±æ·»åŠ è‡ªå·±ä½œä¸ºtargetåï¼Œå‘ç°actionæ–¹æ³•ä¸è¢«è°ƒç”¨ã€‚</p>
<h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>ZATextFieldçš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&quot;ZATextField.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ZATextField</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithFrame:(<span class="built_in">CGRect</span>)frame &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="variable language_">super</span> initWithFrame:frame];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        __<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br><span class="line">        [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserverForName:<span class="built_in">UITextFieldTextDidBeginEditingNotification</span> object:<span class="keyword">self</span> queue:<span class="literal">nil</span> usingBlock:^(<span class="built_in">NSNotification</span> * _Nonnull note) &#123;</span><br><span class="line">            <span class="keyword">if</span> (weakSelf.rightView &amp;&amp; weakSelf.rightViewMode == <span class="built_in">UITextFieldViewModeWhileEditing</span>) &#123;</span><br><span class="line">                weakSelf.rightView.hidden = weakSelf.text.length &gt; <span class="number">0</span> ? <span class="literal">NO</span> : <span class="literal">YES</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (weakSelf.leftView &amp;&amp; weakSelf.leftViewMode == <span class="built_in">UITextFieldViewModeWhileEditing</span>) &#123;</span><br><span class="line">                weakSelf.leftView.hidden = weakSelf.text.length &gt; <span class="number">0</span> ? <span class="literal">NO</span> : <span class="literal">YES</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">        [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserverForName:<span class="built_in">UITextFieldTextDidChangeNotification</span> object:<span class="keyword">self</span> queue:<span class="literal">nil</span> usingBlock:^(<span class="built_in">NSNotification</span> * _Nonnull note) &#123;</span><br><span class="line">            <span class="keyword">if</span> (weakSelf.rightView &amp;&amp; weakSelf.rightViewMode == <span class="built_in">UITextFieldViewModeWhileEditing</span>) &#123;</span><br><span class="line">                weakSelf.rightView.hidden = weakSelf.text.length &gt; <span class="number">0</span> ? <span class="literal">NO</span> : <span class="literal">YES</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (weakSelf.leftView &amp;&amp; weakSelf.leftViewMode == <span class="built_in">UITextFieldViewModeWhileEditing</span>) &#123;</span><br><span class="line">                weakSelf.leftView.hidden = weakSelf.text.length &gt; <span class="number">0</span> ? <span class="literal">NO</span> : <span class="literal">YES</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">        </span><br><span class="line">        [<span class="keyword">self</span> addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(xxxxchange:) forControlEvents:<span class="built_in">UIControlEventEditingChanged</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)xxxxchange:(<span class="built_in">UITextField</span> *)sender &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;text:%@&quot;</span>, <span class="keyword">self</span>.text);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…‰æ ‡å¤§å°è®¾ç½®</span></span><br><span class="line">- (<span class="built_in">CGRect</span>)caretRectForPosition:(<span class="built_in">UITextPosition</span> *)position &#123;</span><br><span class="line">    <span class="built_in">CGRect</span> originalRect = [<span class="variable language_">super</span> caretRectForPosition:position];</span><br><span class="line">    <span class="built_in">CGFloat</span> caretHeight = <span class="keyword">self</span>.font.lineHeight - <span class="number">4</span>;</span><br><span class="line">    originalRect.size.height = caretHeight;</span><br><span class="line">    originalRect.origin.y = (<span class="keyword">self</span>.frame.size.height - caretHeight) / <span class="number">2.0</span>;</span><br><span class="line">    <span class="keyword">return</span> originalRect;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>è‡ªå·±æ·»åŠ äº†è‡ªå·±ä½œä¸ºtarget:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">[<span class="keyword">self</span> addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(xxxxchange:) forControlEvents:<span class="built_in">UIControlEventEditingChanged</span>];</span><br></pre></td></tr></table></figure>
<p>ç†è®ºä¸Šè®²å½“æœ‰æ–‡å­—è¾“å…¥æ—¶ï¼Œxxxxchangeæ–¹æ³•è‚¯å®šä¼šè°ƒç”¨çš„ï¼Œä½†æ˜¯å®é™…æ²¡æœ‰ã€‚</p>
<h3 id="å¯èƒ½çš„åŸå› "><a href="#å¯èƒ½çš„åŸå› " class="headerlink" title="å¯èƒ½çš„åŸå› "></a>å¯èƒ½çš„åŸå› </h3><p>1.æ–¹æ³•è¢«å…¶ä»–åœ°æ–¹çš„ç±»åˆ«è¦†ç›–äº†ã€‚</p>
<p>2.targetè¢«ç§»é™¤äº†ã€‚</p>
<p>é’ˆå¯¹ç¬¬ä¸€ç‚¹ï¼Œæ”¹äº†ä¸€ä¸ªå¾ˆéšæ„çš„æ–¹æ³•åç§°xxxxchange:ï¼Œä½†æ˜¯æ²¡æœ‰ç”¨ã€‚è¯´æ˜ä¸æ˜¯å› ä¸ºç±»åˆ«è¦†ç›–çš„åŸå› ã€‚</p>
<p>é’ˆå¯¹ç¬¬äºŒç‚¹ï¼Œè°ƒè¯•æ—¶æ‰“å°äº†allTargetsï¼Œç«Ÿç„¶å‘ç°selfèµ«ç„¶åœ¨åˆ—ã€‚WTFï¼ä¸€æ—¶é—´æ²¡æœ‰ä»»ä½•æ€è·¯ï¼Œä¸€åº¦ä»¥ä¸ºäº‹ä»¶ä¼ é€’æœ‰é—®é¢˜ï¼Œæµªè´¹å¾ˆå¤šæ—¶é—´ã€‚æœ€ç»ˆæœç´¢æ‰€æœ‰ä¸UITextFieldç›¸å…³çš„ç±»åˆ«ï¼Œå­ç±»ç­‰ï¼Œç»“æœå‘ç°ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">ZATextField *textField = [[ZATextField alloc] initWithFrame:<span class="built_in">CGRectZero</span>];</span><br><span class="line">textField.font = [<span class="built_in">UIFont</span> systemFontOfSize:<span class="number">21</span>];</span><br><span class="line">textField.textColor = [<span class="built_in">UIColor</span> colorWithHexString:<span class="string">@&quot;#26273C&quot;</span>];</span><br><span class="line">textField.placeholder = <span class="string">@&quot;è¯·è¾“å…¥å¯†ç &quot;</span>;</span><br><span class="line">textField.delegate = <span class="keyword">self</span>;</span><br><span class="line">textField.backgroundColor = <span class="built_in">UIColor</span>.whiteColor;</span><br><span class="line">textField.layer.cornerRadius = <span class="number">28</span>;</span><br><span class="line">textField.layer.masksToBounds = <span class="literal">YES</span>;</span><br><span class="line">textField.secureTextEntry = <span class="literal">YES</span>;</span><br><span class="line">textField.keyboardType = <span class="built_in">UIKeyboardTypeASCIICapable</span>;</span><br><span class="line">textField.xq_limitTextLength = <span class="number">20</span>; <span class="comment">//å°±æ˜¯è¿™é‡Œ</span></span><br></pre></td></tr></table></figure>
<p>ZATextFieldæœ‰ç”¨åˆ°ä¸€ä¸ªé•¿åº¦é™åˆ¶çš„ç±»åˆ«ï¼Œå®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">NSInteger</span>)xq_limitTextLength</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSNumber</span> *limit = objc_getAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(xq_limitTextLength));</span><br><span class="line">    <span class="keyword">return</span> limit.integerValue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)setXq_limitTextLength:(<span class="built_in">NSInteger</span>)xq_limitTextLength</span><br><span class="line">&#123;</span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(xq_limitTextLength), @(xq_limitTextLength), OBJC_ASSOCIATION_RETAIN);</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> removeTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(xq_textFieldTextDidChanged:) forControlEvents:<span class="built_in">UIControlEventEditingChanged</span>];</span><br><span class="line">    [<span class="keyword">self</span> addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(xq_textFieldTextDidChanged:) forControlEvents:<span class="built_in">UIControlEventEditingChanged</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‡Œé¢æœ‰removeTargetçš„æ“ä½œï¼Œä½†æ˜¯</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[<span class="keyword">self</span> removeTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(xq_textFieldTextDidChanged:) forControlEvents:<span class="built_in">UIControlEventEditingChanged</span>];</span><br></pre></td></tr></table></figure>
<p>è¿™å¥ä»£ç çš„æ„æ€ä¸æ˜¯ç§»é™¤selfâ€”UIControlEventEditingChangedâ€”xq_textFieldTextDidChangedé”®å€¼å¯¹å—ï¼Ÿæ€ä¹ˆä»¥å‰çš„ä¹Ÿç§»é™¤äº†ï¼Ÿçœ‹æ¥æ˜¯æˆ‘å¯¹removeTargetç†è§£çš„æœ‰é—®é¢˜ã€‚</p>
<h3 id="é‡æ–°ç†è§£addTarget-removeTarget"><a href="#é‡æ–°ç†è§£addTarget-removeTarget" class="headerlink" title="é‡æ–°ç†è§£addTarget/removeTarget"></a>é‡æ–°ç†è§£addTarget/removeTarget</h3><p>addTarget:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// add target/action for particular event. you can call this multiple times and you can specify multiple target/actions for a particular event.</span></span><br><span class="line"><span class="comment">// passing in nil as the target goes up the responder chain. The action may optionally include the sender and the event in that order</span></span><br><span class="line"><span class="comment">// the action cannot be NULL. Note that the target is not retained.</span></span><br><span class="line">- (<span class="type">void</span>)addTarget:(<span class="keyword">nullable</span> <span class="type">id</span>)target action:(SEL)action forControlEvents:(<span class="built_in">UIControlEvents</span>)controlEvents;</span><br></pre></td></tr></table></figure>
<p>Note that the target is not retained.æ–°å‘ç°ï¼ŒåŸæ¥UIControlå¹¶ä¸ä¼šå¼ºå¼•ç”¨targetã€‚æ‰€ä»¥self addTarget:selfï¼Œå¹¶ä¸ä¼šå¼•èµ·å†…å­˜é—®é¢˜ã€‚ä¸è¿‡è¿™è·Ÿæˆ‘ä»¬ç°åœ¨çš„é—®é¢˜æ²¡å•¥å…³ç³»ã€‚</p>
<p>removeTargetï¼š</p>
<figure class="highlight fortran"><table><tr><td class="code"><pre><span class="line">// remove the <span class="keyword">target</span>/<span class="keyword">action</span> for a set of events. <span class="keyword">pass</span> <span class="keyword">in</span> NULL for the <span class="keyword">action</span> to remove <span class="built_in">all</span> actions for that <span class="keyword">target</span></span><br><span class="line">- (void)removeTarget:(nullable id)<span class="keyword">target</span> <span class="keyword">action</span>:(nullable SEL)<span class="keyword">action</span> forControlEvents:(UIControlEvents)controlEvents;</span><br></pre></td></tr></table></figure>
<p>æ–‡æ¡£è¯´æ˜ï¼š</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">Use this <span class="keyword">method</span> <span class="keyword">to</span> prevent the delivery <span class="keyword">of</span> control events <span class="keyword">to</span> target objects associated <span class="keyword">with</span> control. <span class="keyword">If</span> you specify a <span class="keyword">valid</span> <span class="keyword">object</span> <span class="keyword">in</span> the target parameter, this <span class="keyword">method</span> stops the delivery <span class="keyword">of</span> the specified events <span class="keyword">to</span> <span class="keyword">all</span> action methods associated <span class="keyword">with</span> that <span class="keyword">object</span>. <span class="keyword">If</span> you specify nil <span class="keyword">for</span> the target parameter, this <span class="keyword">method</span> prevents the delivery <span class="keyword">of</span> those events <span class="keyword">to</span> <span class="keyword">all</span> action methods <span class="keyword">of</span> <span class="keyword">all</span> target objects.</span><br><span class="line">Although the action parameter <span class="keyword">is</span> <span class="keyword">not</span> considered <span class="keyword">when</span> stopping the delivery <span class="keyword">of</span> events, you should specify an appropriate <span class="keyword">value</span> anyway. <span class="keyword">If</span> the specified target/action combination <span class="keyword">no</span> longer has <span class="keyword">any</span> <span class="keyword">valid</span> control events associated <span class="keyword">with</span> it, the control cleans up its corresponding <span class="type">internal</span> data structures. Doing so can affect the <span class="keyword">set</span> <span class="keyword">of</span> objects returned <span class="keyword">by</span> the allTargets <span class="keyword">method</span>.</span><br></pre></td></tr></table></figure>
<p>é‡Œé¢æœ‰ä¸€å¥é‡è¦è¯´æ˜ï¼š</p>
<p>If you specify a valid object in the target parameter, this method stops the delivery of the specified events to all action methods associated with that object.If you specify nil for the target parameter, this method prevents the delivery of those events to all action methods of all target objects.</p>
<p>ç¿»è¯‘è¿‡æ¥å°±æ˜¯ï¼Œå½“ä¼ å…¥ä¸€ä¸ªæœ‰æ•ˆçš„targetå’ŒæŒ‡å®šäº‹ä»¶ï¼Œè°ƒç”¨è¯¥æ–¹æ³•åï¼Œè¯¥targetçš„æ‰€æœ‰æŒ‡å®šäº‹ä»¶çš„actionæ–¹æ³•éƒ½ä¸ä¼šå†æ‰§è¡Œäº†ã€‚å¦‚æœä¼ å…¥çš„æ˜¯nilï¼Œé‚£ä¹ˆæŒ‡å®šäº‹ä»¶çš„æ‰€æœ‰targetçš„æ‰€æœ‰actionæ–¹æ³•éƒ½ä¸ä¼šå†æ‰§è¡Œã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´removeTargetæ–¹æ³•çš„ä¸‰ä¸ªå‚æ•°ä¸­ï¼Œactionå‚æ•°æ²¡æœ‰å®é™…ç”¨å¤„ï¼Œæœ‰ç”¨çš„æ˜¯targetå’ŒcontrolEventså‚æ•°ã€‚</p>
<p>å¾ˆæœ‰å¯èƒ½å†…éƒ¨çš„æ•°æ®ç»“æ„æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">controlEvents : [<span class="built_in">target1</span>(m1,m2,m3), <span class="built_in">target2</span>(m1), <span class="built_in">target3</span>(m1)]</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[textF addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(printBeginA:) forControlEvents:<span class="built_in">UIControlEventEditingDidBegin</span>];</span><br><span class="line">[textF addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(printBeginB:) forControlEvents:<span class="built_in">UIControlEventEditingDidBegin</span>];</span><br><span class="line">[textF addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(printBeginC:) forControlEvents:<span class="built_in">UIControlEventEditingDidBegin</span>];</span><br><span class="line">dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">5</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">    [textF removeTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(printBeginA:) forControlEvents:<span class="built_in">UIControlEventEditingDidBegin</span>];</span><br><span class="line">    [textF addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(printBeginD:) forControlEvents:<span class="built_in">UIControlEventEditingDidBegin</span>];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>åˆšå¼€å§‹æ—¶æ•°æ®ç»“æ„ä¸ºï¼š</p>
<p>UIControlEventEditingDidBegin ï¼š [self(printBeginA, printBeginB, printBeginC)]</p>
<p>è°ƒç”¨removeTargetå</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">[textF removeTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(printBeginA:) forControlEvents:<span class="built_in">UIControlEventEditingDidBegin</span>];</span><br></pre></td></tr></table></figure>
<p>æ•°æ®ç»“æ„å˜ä¸ºï¼š</p>
<p>UIControlEventEditingDidBegin ï¼š[]ï¼Œæœ‰å¯èƒ½è¿™ä¸€æ éƒ½æ²¡æœ‰äº†ã€‚</p>
<p>æœ€ååˆaddTargetï¼Œæ•°æ®ç»“æ„å˜ä¸ºï¼š</p>
<p>UIControlEventEditingDidBegin ï¼š[self(printBeginD)]</p>
<p>æ‰€ä»¥æœ€ååªæœ‰printBeginDå“åº”äº†ã€‚</p>
<p>è€Œé‡å¤addTarget</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">[textF addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(printBegin:) forControlEvents:<span class="built_in">UIControlEventEditingDidBegin</span>];</span><br><span class="line">[textF addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(printBegin:) forControlEvents:<span class="built_in">UIControlEventEditingDidBegin</span>];</span><br><span class="line">[textF addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(printBegin:) forControlEvents:<span class="built_in">UIControlEventEditingDidBegin</span>];</span><br><span class="line">[textF addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(printBegin:) forControlEvents:<span class="built_in">UIControlEventEditingDidBegin</span>];</span><br></pre></td></tr></table></figure>
<p>æ•°æ®ç»“æ„ä¸ºï¼š</p>
<p>UIControlEventEditingDidBegin ï¼š[self(printBegin)]</p>
<p>å› æ­¤é‡å¤addTargetåŒä¸€actionæ²¡æœ‰ä»€ä¹ˆå½±å“ï¼Œäº‹ä»¶æ¥äº†ï¼Œactionæ–¹æ³•åªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚</p>
<h3 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h3><p>åˆ é™¤ç±»åˆ«é‡Œçš„removeTargetå³å¯ã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">[<span class="keyword">self</span> removeTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(xq_textFieldTextDidChanged:) forControlEvents:<span class="built_in">UIControlEventEditingChanged</span>];</span><br></pre></td></tr></table></figure>
<p>æ€»ç»“ï¼š</p>
<p>removeTargetæ²¡åŠæ³•ç§»é™¤æŒ‡å®štargetçš„æŒ‡å®šäº‹ä»¶çš„æŒ‡å®šactionã€‚è¿™æ˜¯åœ¨å¼€å‘è¿‡ç¨‹ä¸­éœ€è¦æ³¨æ„çš„ã€‚</p>
]]></content>
      <categories>
        <category>Bug</category>
      </categories>
      <tags>
        <tag>UITextField</tag>
        <tag>removeTarget</tag>
      </tags>
  </entry>
  <entry>
    <title>OCå…³è”å¯¹è±¡å®ç°åŸç†</title>
    <url>/2021/09/28/OC%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<h3 id="objc-AssociationPolicy"><a href="#objc-AssociationPolicy" class="headerlink" title="objc_AssociationPolicy"></a>objc_AssociationPolicy</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Policies related to associative references.</span></span><br><span class="line"><span class="comment"> * These are options to objc_setAssociatedObject()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">OBJC_ENUM</span><span class="params">(<span class="type">uintptr_t</span>, objc_AssociationPolicy)</span> &#123;</span><br><span class="line">    OBJC_ASSOCIATION_ASSIGN = <span class="number">0</span>,           <span class="comment">/**&lt; Specifies a weak reference to the associated object. */</span></span><br><span class="line">    OBJC_ASSOCIATION_RETAIN_NONATOMIC = <span class="number">1</span>, <span class="comment">/**&lt; Specifies a strong reference to the associated object. </span></span><br><span class="line"><span class="comment">                                            *   The association is not made atomically. */</span></span><br><span class="line">    OBJC_ASSOCIATION_COPY_NONATOMIC = <span class="number">3</span>,   <span class="comment">/**&lt; Specifies that the associated object is copied. </span></span><br><span class="line"><span class="comment">                                            *   The association is not made atomically. */</span></span><br><span class="line">    OBJC_ASSOCIATION_RETAIN = <span class="number">01401</span>,       <span class="comment">/**&lt; Specifies a strong reference to the associated object.</span></span><br><span class="line"><span class="comment">                                            *   The association is made atomically. */</span><span class="number">0x0301</span></span><br><span class="line">    OBJC_ASSOCIATION_COPY = <span class="number">01403</span>          <span class="comment">/**&lt; Specifies that the associated object is copied.</span></span><br><span class="line"><span class="comment">                                            *   The association is made atomically. */</span><span class="number">0x0303</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯¹åº”çš„å†…éƒ¨æšä¸¾</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    OBJC_ASSOCIATION_SETTER_ASSIGN      = <span class="number">0</span>,</span><br><span class="line">    OBJC_ASSOCIATION_SETTER_RETAIN      = <span class="number">1</span>,</span><br><span class="line">    OBJC_ASSOCIATION_SETTER_COPY        = <span class="number">3</span>,            <span class="comment">// <span class="doctag">NOTE:</span>  both bits are set, so we can simply test 1 bit in releaseValue below.</span></span><br><span class="line">    OBJC_ASSOCIATION_GETTER_READ        = (<span class="number">0</span> &lt;&lt; <span class="number">8</span>),</span><br><span class="line">    OBJC_ASSOCIATION_GETTER_RETAIN      = (<span class="number">1</span> &lt;&lt; <span class="number">8</span>),</span><br><span class="line">    OBJC_ASSOCIATION_GETTER_AUTORELEASE = (<span class="number">2</span> &lt;&lt; <span class="number">8</span>)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼šä¸Šé¢çš„01401æ˜¯å…«è¿›åˆ¶å†™æ³•ï¼Œå¯¹åº”çš„åå…­è¿›åˆ¶æ˜¯0x0301ã€‚æˆ‘è¯´æ€ä¹ˆåé¢çš„switchçœ‹ä¸æ‡‚å‘¢ã€‚</p>
<h4 id="AssociationPolicyä¸­NONATOMIC-å’Œ-ATOMIC-çš„åŒºåˆ«"><a href="#AssociationPolicyä¸­NONATOMIC-å’Œ-ATOMIC-çš„åŒºåˆ«" class="headerlink" title="AssociationPolicyä¸­NONATOMIC å’Œ ATOMIC çš„åŒºåˆ«"></a>AssociationPolicyä¸­NONATOMIC å’Œ ATOMIC çš„åŒºåˆ«</h4><p>å¯¹äºsetteræ–¹æ³•ï¼Œ<code>NONATOMIC</code> å’Œ <code>ATOMIC</code> æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_object_set_associative_reference(id object, <span class="type">const</span> <span class="type">void</span> *key, id value, <span class="type">uintptr_t</span> policy)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// This code used to work when nil was passed for object and key. Some code</span></span><br><span class="line">    <span class="comment">// probably relies on that to not crash. Check and handle it explicitly.</span></span><br><span class="line">    <span class="comment">// rdar://problem/44094390</span></span><br><span class="line">    <span class="keyword">if</span> (!object &amp;&amp; !value) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (object-&gt;getIsa()-&gt;forbidsAssociatedObjects())</span><br><span class="line">        _objc_fatal(<span class="string">&quot;objc_setAssociatedObject called on instance (%p) of class %s which does not allow associated objects&quot;</span>, object, object_getClassName(object));</span><br><span class="line"></span><br><span class="line">    DisguisedPtr&lt;objc_object&gt; disguised&#123;(objc_object *)object&#125;;</span><br><span class="line">    ObjcAssociation association&#123;policy, value&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// retain the new value (if any) outside the lock.</span></span><br><span class="line">    association.acquireValue();</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> isFirstAssociation = <span class="literal">false</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        AssociationsManager manager;</span><br><span class="line">        AssociationsHashMap &amp;<span class="title function_">associations</span><span class="params">(manager.get())</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (value) &#123;</span><br><span class="line">          	<span class="comment">//try_emplaceä¼šå…ˆæŸ¥æ‰¾ï¼Œæ²¡æ‰¾åˆ°æ‰åˆ›å»ºæ–°çš„ObjectAssociationMapï¼Œåˆ›å»ºæ—¶ä¼šæ ¹æ®éœ€è¦æ‰©å®¹AssociationsHashMapã€‚</span></span><br><span class="line">            <span class="keyword">auto</span> refs_result = associations.try_emplace(disguised, ObjectAssociationMap&#123;&#125;);</span><br><span class="line">            <span class="keyword">if</span> (refs_result.second) &#123; <span class="comment">//æŒ‡å®šçš„disguisedï¼Œä»¥å‰æ²¡æœ‰å€¼ï¼Œè¿™é‡Œæ˜¯æ–°åˆ›å»ºçš„ã€‚åˆ™åšå¥½æ ‡è®°isFirstAssociationã€‚</span></span><br><span class="line">                <span class="comment">/* it&#x27;s the first association we make */</span></span><br><span class="line">                isFirstAssociation = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* establish or replace the association */</span></span><br><span class="line">            <span class="keyword">auto</span> &amp;refs = refs_result.first-&gt;second; <span class="comment">//refsæ˜¯ObjectAssociationMapå“ˆå¸Œè¡¨</span></span><br><span class="line">            <span class="keyword">auto</span> result = refs.try_emplace(key, <span class="built_in">std</span>::move(association)); <span class="comment">//try_emplaceä½œç”¨åŒä¸Šã€‚</span></span><br><span class="line">            <span class="keyword">if</span> (!result.second) &#123; <span class="comment">//æŒ‡å®šçš„keyæœ‰æ—§å€¼ï¼Œè¿›è¡Œswapï¼Œè¿™æ ·associationä¿å­˜çš„å°±æ˜¯æ—§å€¼ï¼Œåé¢å°±æ‰§è¡Œé‡Šæ”¾æ—§å€¼çš„æ“ä½œã€‚</span></span><br><span class="line">                association.swap(result.first-&gt;second); <span class="comment">//result.first-&gt;secondæ˜¯ObjcAssociationå¯¹è±¡</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">auto</span> refs_it = associations.find(disguised);</span><br><span class="line">            <span class="keyword">if</span> (refs_it != associations.end()) &#123;</span><br><span class="line">                <span class="keyword">auto</span> &amp;refs = refs_it-&gt;second;</span><br><span class="line">                <span class="keyword">auto</span> it = refs.find(key);</span><br><span class="line">                <span class="keyword">if</span> (it != refs.end()) &#123;</span><br><span class="line">                    association.swap(it-&gt;second);</span><br><span class="line">                    refs.erase(it);</span><br><span class="line">                    <span class="keyword">if</span> (refs.size() == <span class="number">0</span>) &#123; <span class="comment">//ObjectAssociationMapå“ˆå¸Œè¡¨å…¨ç©ºæ—¶ï¼Œåˆ™å°†å…¶ä»AssociationsHashMapä¸­æ¸…é™¤ã€‚</span></span><br><span class="line">                        associations.erase(refs_it); <span class="comment">//æ¸…é™¤AssociationsHashMapçš„æŸä¸ªæ¡¶ã€‚eraseé‡Œè¿˜ä¼šå¯¹AssociationsHashMapè¿›è¡Œå‡å®¹æˆ–æ‰©å®¹ã€‚</span></span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call setHasAssociatedObjects outside the lock, since this</span></span><br><span class="line">    <span class="comment">// will call the object&#x27;s _noteAssociatedObjects method if it</span></span><br><span class="line">    <span class="comment">// has one, and this may trigger +initialize which might do</span></span><br><span class="line">    <span class="comment">// arbitrary stuff, including setting more associated objects.</span></span><br><span class="line">    <span class="keyword">if</span> (isFirstAssociation)</span><br><span class="line">        object-&gt;setHasAssociatedObjects();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// release the old value (outside of the lock).</span></span><br><span class="line">    association.releaseHeldValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">acquireValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (_value) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (_policy &amp; <span class="number">0xFF</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> OBJC_ASSOCIATION_SETTER_RETAIN:</span><br><span class="line">            _value = objc_retain(_value);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> OBJC_ASSOCIATION_SETTER_COPY:</span><br><span class="line">            _value = ((id(*)(id, SEL))objc_msgSend)(_value, @selector(copy));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">releaseHeldValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (_value &amp;&amp; (_policy &amp; OBJC_ASSOCIATION_SETTER_RETAIN)) &#123;</span><br><span class="line">        objc_release(_value); <span class="comment">//_policyæ˜¯å¸¦retainæˆ–copyçš„è¿™é‡Œéƒ½ä¼šè¿›è¡Œreleaseã€‚</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">swap</span><span class="params">(ObjcAssociation &amp;other)</span> &#123;</span><br><span class="line">    <span class="built_in">std</span>::swap(_policy, other._policy);</span><br><span class="line">    <span class="built_in">std</span>::swap(_value, other._value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¤§è‡´æ­¥éª¤ï¼š</p>
<ol>
<li>retainæ–°å€¼ï¼Œif neededã€‚ä½¿ç”¨OBJC_ASSOCIATION_ASSIGNç­–ç•¥æ˜¯ä¸ä¼šretainçš„ã€‚</li>
<li>AssociationsManagerLockåŠ é”</li>
<li>å°†æ–°å€¼ä¿å­˜åˆ°å“ˆå¸Œè¡¨ä¸­ï¼Œå°†æ—§å€¼ä¿å­˜åˆ°associationé‡Œï¼Œç”¨äºåç»­é‡Šæ”¾ã€‚</li>
<li>AssociationsManagerLockè§£é”</li>
<li>æ ‡è®°objectæœ‰å…³è”å¯¹è±¡</li>
<li>releaseæ—§å€¼ï¼Œif neededã€‚</li>
</ol>
<p><code>NONATOMIC</code> å’Œ <code>ATOMIC</code> çš„åŒºåˆ«åªä½“ç°åœ¨ <code>objc_getAssociatedObject</code> çš„å®ç°ä¸Šï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">id</span><br><span class="line"><span class="title function_">objc_getAssociatedObject</span><span class="params">(id object, <span class="type">const</span> <span class="type">void</span> *key)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> _object_get_associative_reference(object, key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">id</span><br><span class="line">_object_get_associative_reference(id object, <span class="type">const</span> <span class="type">void</span> *key)</span><br><span class="line">&#123;</span><br><span class="line">    ObjcAssociation association&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        AssociationsManager manager; <span class="comment">//ä¸´æ—¶å˜é‡managerï¼Œé‡Œé¢æœ‰å…¨å±€é”ï¼Œç›¸å½“äºå¯¹ä»£ç å—è¿›è¡Œäº†åŠ é”è§£é”ï¼Œå¸¸è§å†™æ³•ã€‚</span></span><br><span class="line">        AssociationsHashMap &amp;<span class="title function_">associations</span><span class="params">(manager.get())</span>;</span><br><span class="line">        AssociationsHashMap::iterator i = associations.find((objc_object *)object);</span><br><span class="line">        <span class="keyword">if</span> (i != associations.end()) &#123;</span><br><span class="line">            ObjectAssociationMap &amp;refs = i-&gt;second;</span><br><span class="line">            ObjectAssociationMap::iterator j = refs.find(key);</span><br><span class="line">            <span class="keyword">if</span> (j != refs.end()) &#123;</span><br><span class="line">                association = j-&gt;second;</span><br><span class="line">                association.retainReturnedValue();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> association.autoreleaseReturnedValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">retainReturnedValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (_value &amp;&amp; (_policy &amp; OBJC_ASSOCIATION_GETTER_RETAIN)) &#123;</span><br><span class="line">        objc_retain(_value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> id <span class="title function_">autoreleaseReturnedValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (slowpath(_value &amp;&amp; (_policy &amp; OBJC_ASSOCIATION_GETTER_AUTORELEASE))) &#123;</span><br><span class="line">        <span class="keyword">return</span> objc_autorelease(_value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹äº<code>ATOMIC</code>è°ƒç”¨getteræ–¹æ³•æ—¶ï¼Œè·å–åˆ°çš„æ˜¯retainåæ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± é‡Œçš„å¯¹è±¡ï¼š</p>
<ol>
<li>AssociationsManagerLockåŠ é”</li>
<li>è·å–å…³è”å¯¹è±¡</li>
<li><strong>retainå…³è”å¯¹è±¡</strong></li>
<li>AssociationsManagerLockè§£é”</li>
<li>å°†å…³è”å¯¹è±¡æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå¹¶è¿”å›ç»™è°ƒç”¨è€…</li>
</ol>
<p>è€Œ<code>NONATOMIC</code> åªæ˜¯ç®€å•çš„è¿”å›å¯¹è±¡çš„åœ°å€ï¼š</p>
<ol>
<li>AssociationsManagerLockåŠ é”</li>
<li>è·å–å…³è”å¯¹è±¡</li>
<li>AssociationsManagerLockè§£é”</li>
<li>å°†å…³è”å¯¹è±¡è¿”å›ç»™è°ƒç”¨è€…ã€‚</li>
</ol>
<p>å› æ­¤ä½¿ç”¨ <code>NONATOMIC</code> é€‰é¡¹ï¼Œå¯èƒ½ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼šAçº¿ç¨‹è°ƒç”¨getteræ–¹æ³•å¾—åˆ°å¯¹è±¡çš„åœ°å€ï¼Œåé¢Bçº¿ç¨‹è°ƒç”¨setteræ–¹æ³•ï¼Œè€Œsetteræ–¹æ³•ä¼šé‡Šæ”¾æ—§å€¼ï¼Œäºæ˜¯Açº¿ç¨‹è·å¾—çš„å¯¹è±¡è¢«é”€æ¯äº†ï¼ŒAçº¿ç¨‹åœ¨ä½¿ç”¨æ—¶å­˜åœ¨é‡æŒ‡é’ˆé£é™©ã€‚è€Œä½¿ç”¨ <code>ATOMIC</code> é€‰é¡¹ï¼Œå› ä¸ºgetteræ–¹æ³•é‡Œä¼šretainå¹¶æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± æ‰€ä»¥Açº¿ç¨‹è·å¾—å¯¹è±¡åœ¨ä½¿ç”¨æœŸé—´ä¸ä¼šè¢«é”€æ¯ã€‚å®éªŒæ—¶åº”è¯¥é‡‡ç”¨MRCç¯å¢ƒã€‚</p>
<p>æ­£æ˜¯ç”±äºä¸Šè¿°ç»†å¾®çš„ä¸åŒï¼Œæ‰€ä»¥å¯¹äºå…³è”å¯¹è±¡è¯¥ç”¨ <code>ATOMIC</code> é€‰é¡¹æ—¶ï¼Œè¿˜å¾—ç”¨ <code>ATOMIC</code> é€‰é¡¹ã€‚</p>
<h3 id="å…³è”å¯¹è±¡çš„å­˜å‚¨"><a href="#å…³è”å¯¹è±¡çš„å­˜å‚¨" class="headerlink" title="å…³è”å¯¹è±¡çš„å­˜å‚¨"></a>å…³è”å¯¹è±¡çš„å­˜å‚¨</h3><p>é€šè¿‡objc_setAssociatedObjectå®Œæˆè®¾å€¼ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)setNonatomicBook:(<span class="built_in">NSString</span> *)nonatomicBook &#123;</span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(nonatomicBook), nonatomicBook, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ps:å…³è”çš„å€¼åªèƒ½ä¸ºå¯¹è±¡ï¼Œä¸èƒ½ä¸ºåŸºç¡€ç±»å‹ã€‚</p>
<p>é‚£ä¹ˆè¯¥æ–¹æ³•ç©¶ç«ŸæŠŠä¼ å…¥çš„å¯¹è±¡ä¿å­˜åˆ°å“ªé‡Œå»äº†å‘¢ï¼Ÿæ•°æ®ç»“æ„å‡ºåœºã€‚</p>
<h4 id="AssociationsManager"><a href="#AssociationsManager" class="headerlink" title="AssociationsManager"></a>AssociationsManager</h4><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">spinlock_t</span> AssociationsManagerLock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> objc &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ObjcAssociation</span> &#123;</span><br><span class="line">    <span class="type">uintptr_t</span> _policy;</span><br><span class="line">    id _value; <span class="comment">//åªèƒ½æ˜¯å¯¹è±¡</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ObjcAssociation</span>(<span class="type">uintptr_t</span> policy, id value) : _policy(policy), _value(value) &#123;&#125;</span><br><span class="line">    <span class="built_in">ObjcAssociation</span>() : _policy(<span class="number">0</span>), _value(nil) &#123;&#125;</span><br><span class="line">    <span class="built_in">ObjcAssociation</span>(<span class="type">const</span> ObjcAssociation &amp;other) = <span class="keyword">default</span>;</span><br><span class="line">    ObjcAssociation &amp;<span class="keyword">operator</span>=(<span class="type">const</span> ObjcAssociation &amp;other) = <span class="keyword">default</span>;</span><br><span class="line">    <span class="built_in">ObjcAssociation</span>(ObjcAssociation &amp;&amp;other) : <span class="built_in">ObjcAssociation</span>() &#123;</span><br><span class="line">        <span class="built_in">swap</span>(other);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">swap</span><span class="params">(ObjcAssociation &amp;other)</span> </span>&#123;</span><br><span class="line">        std::<span class="built_in">swap</span>(_policy, other._policy);</span><br><span class="line">        std::<span class="built_in">swap</span>(_value, other._value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">uintptr_t</span> <span class="title">policy</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> _policy; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> id <span class="title">value</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> _value; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">acquireValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (_value) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (_policy &amp; <span class="number">0xFF</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> OBJC_ASSOCIATION_SETTER_RETAIN:</span><br><span class="line">                _value = <span class="built_in">objc_retain</span>(_value);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OBJC_ASSOCIATION_SETTER_COPY:</span><br><span class="line">                _value = ((<span class="built_in">id</span>(*)(id, SEL))objc_msgSend)(_value, @<span class="built_in">selector</span>(copy));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  	...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> DenseMap&lt;<span class="type">const</span> <span class="type">void</span> *, ObjcAssociation&gt; ObjectAssociationMap;</span><br><span class="line"><span class="keyword">typedef</span> DenseMap&lt;DisguisedPtr&lt;objc_object&gt;, ObjectAssociationMap&gt; AssociationsHashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">// class AssociationsManager manages a lock / hash table singleton pair.</span></span><br><span class="line"><span class="comment">// Allocating an instance acquires the lock</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AssociationsManager</span> &#123;</span><br><span class="line">    <span class="keyword">using</span> Storage = ExplicitInitDenseMap&lt;DisguisedPtr&lt;objc_object&gt;, ObjectAssociationMap&gt;;</span><br><span class="line">    <span class="type">static</span> Storage _mapStorage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">AssociationsManager</span>()   &#123; AssociationsManagerLock.<span class="built_in">lock</span>(); &#125;</span><br><span class="line">    ~<span class="built_in">AssociationsManager</span>()  &#123; AssociationsManagerLock.<span class="built_in">unlock</span>(); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">AssociationsHashMap &amp;<span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _mapStorage.<span class="built_in">get</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        _mapStorage.<span class="built_in">init</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">AssociationsManager::Storage AssociationsManager::_mapStorage;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace objc</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// We cannot use a C++ static initializer to initialize certain globals because</span></span><br><span class="line"><span class="comment">// libc calls us before our C++ initializers run. We also don&#x27;t want a global</span></span><br><span class="line"><span class="comment">// pointer to some globals because of the extra indirection.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// ExplicitInit / LazyInit wrap doing it the hard way.</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Type&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExplicitInit</span> &#123;</span><br><span class="line">    <span class="built_in">alignas</span>(Type) <span class="type">uint8_t</span> _storage[<span class="built_in">sizeof</span>(Type)];</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span>... Ts&gt;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(Ts &amp;&amp;... Args)</span> </span>&#123; <span class="comment">//ä¸Šé¢çš„initæ–¹æ³•</span></span><br><span class="line">        <span class="keyword">new</span> (_storage) <span class="built_in">Type</span>(std::forward&lt;Ts&gt;(Args)...); <span class="comment">//å †ä¸Šçš„å®¹å™¨ã€‚</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Type &amp;<span class="title">get</span><span class="params">()</span> </span>&#123;<span class="comment">//ä¸Šé¢çš„getæ–¹æ³•</span></span><br><span class="line">        <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;Type *&gt;(_storage);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å­—æ®µï¼š</p>
<p>AssociationsManagerLockï¼šä¸€æŠŠ<strong>å…¨å±€</strong>è‡ªæ—‹é”ã€‚</p>
<p>_mapStorageï¼šä¸€ä¸ªå±€éƒ¨é™æ€å˜é‡å“ˆå¸Œè¡¨AssociationsHashMapï¼Œé”®ä¸ºå¯¹è±¡åœ°å€ï¼Œå€¼ä¸ºä¸€ä¸ªå“ˆå¸Œè¡¨ObjectAssociationMapã€‚å“ˆå¸Œè¡¨ObjectAssociationMapçš„é”®ä¸ºå…³è”å¯¹è±¡çš„keyï¼ˆå¿…é¡»ä¸ºä¸€ä¸ªå¸¸é‡å­—ç¬¦ä¸²ï¼Œå¦‚æœæ˜¯allocåŠ¨æ€ç”Ÿæˆçš„å³ä½¿å­—ç¬¦ç›¸ç­‰ä¹Ÿä¼šæœ‰é—®é¢˜ï¼‰ï¼Œå€¼ä¸ºObjcAssociationã€‚ObjcAssociationé‡Œè®°å½•äº†policyå’Œvalueï¼ˆä¼ å…¥çš„å…³è”å¯¹è±¡ï¼‰ã€‚</p>
<p>å› æ­¤æ•´ä¸ªæ•°æ®ç»“æ„å°±å¾ˆæ¸…æ¥šäº†ï¼Œå°±æ˜¯å“ˆå¸Œè¡¨å¥—å“ˆå¸Œè¡¨ã€‚è¿™ç§æ•°æ®ç»“æ„åœ¨æºç é‡Œç”¨çš„å¾ˆæ™®éã€‚</p>
<p>è®¾å€¼è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>åŠ é”ã€‚</li>
<li>æ ¹æ®å¯¹è±¡çš„åœ°å€ä»å“ˆå¸Œè¡¨AssociationsHashMapä¸­æ‰¾åˆ°å“ˆå¸Œè¡¨ObjectAssociationMapã€‚</li>
<li>å†æ ¹æ®å…³è”å¯¹è±¡çš„keyä»å“ˆå¸Œè¡¨ObjectAssociationMapä¸­æ‰¾åˆ°ObjcAssociationã€‚</li>
<li>æ–°å€¼æ›¿æ¢æ—§å€¼ã€‚</li>
<li>è§£é”ã€‚ç»“æŸã€‚</li>
</ol>
<h4 id="AssociationsHashMap-ObjectAssociationMapæ‰©å®¹å‡å®¹æ—¶æœº"><a href="#AssociationsHashMap-ObjectAssociationMapæ‰©å®¹å‡å®¹æ—¶æœº" class="headerlink" title="AssociationsHashMap/ObjectAssociationMapæ‰©å®¹å‡å®¹æ—¶æœº"></a>AssociationsHashMap/ObjectAssociationMapæ‰©å®¹å‡å®¹æ—¶æœº</h4><p>è¿™é‡Œå…¨æ˜¯C++ä»£ç ï¼Œçœ‹ä¸æ‡‚ã€‚</p>
<p>å“ˆå¸Œè¡¨åœ¨æ’å…¥å…ƒç´ æ—¶ä¼šæ ¹æ®éœ€è¦è¿›è¡Œæ‰©å®¹ï¼Œåœ¨åˆ é™¤å…ƒç´ æ—¶ä¼šè¿›è¡Œå‡å®¹æˆ–æ‰©å®¹ï¼ˆåˆ é™¤åä¼šæ£€æŸ¥æ˜¯å¦æ»¡è¶³æ‰©å®¹æ¡ä»¶ï¼‰ã€‚AssociationsHashMapåˆå§‹åŒ–åæœ‰ä¸€ä¸ªé»˜è®¤å®¹é‡ï¼ˆä¸ä¼šå¾ˆå¤§ï¼‰ï¼Œåç»­æ ¹æ®éœ€è¦æ‰©å®¹å’Œå‡å®¹ã€‚</p>
<h3 id="å…³è”å¯¹è±¡çš„è·å–"><a href="#å…³è”å¯¹è±¡çš„è·å–" class="headerlink" title="å…³è”å¯¹è±¡çš„è·å–"></a>å…³è”å¯¹è±¡çš„è·å–</h3><p>è·å–è¿‡ç¨‹ç±»ä¼¼ã€‚</p>
<h3 id="æ·»åŠ weakå…³è”å¯¹è±¡"><a href="#æ·»åŠ weakå…³è”å¯¹è±¡" class="headerlink" title="æ·»åŠ weakå…³è”å¯¹è±¡"></a>æ·»åŠ weakå…³è”å¯¹è±¡</h3><p>ä»objc_AssociationPolicyæšä¸¾ä¸­ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯æ²¡æœ‰weaké€‰é¡¹çš„ï¼Œåªæœ‰ä¸€ä¸ªassignï¼Œä½†assignåœ¨å…³è”å¯¹è±¡é”€æ¯åï¼ŒæŒ‡é’ˆå¹¶ä¸ä¼šè¢«ç½®ä¸ºnilï¼Œå› æ­¤æœ‰é‡æŒ‡é’ˆè®¿é—®é£é™©ã€‚è‡³äºç³»ç»Ÿä¸ºå•¥æ²¡æœ‰å¸®æˆ‘ä»¬å®ç°weaké€‰é¡¹ï¼Œå¯èƒ½çš„åŸå› æ˜¯å› ä¸ºç±»åˆ«æ·»åŠ çš„å±æ€§å…¶å®æ˜¯æ²¡æœ‰å®ä¾‹å˜é‡å¯¹åº”çš„ï¼Œæ‰€ä»¥æ²¡åŠæ³•æŠŠæŒ‡é’ˆå˜é‡åœ°å€æ³¨å†Œåˆ°å…³è”å¯¹è±¡çš„weakè¡¨ä¸­å»ï¼Œä¸è¿‡å…·ä½“åŸå› ä¸å¾—è€ŒçŸ¥ï¼Œæˆ‘ä¹Ÿæƒ³è±¡ä¸åˆ°ã€‚</p>
<p>ä½†æˆ‘ä»¬è‡ªå·±å¯ä»¥å®ç°è¿™ä¸ªweaké€‰é¡¹ã€‚</p>
<p>weakä¸»è¦çš„ä½œç”¨å°±æ˜¯å¯¹è±¡é”€æ¯åï¼Œæ‰€æœ‰æŒ‡å‘å®ƒçš„æŒ‡é’ˆéƒ½å°†è¢«ç½®ä¸ºnilï¼Œä»è€Œé¿å…äº†é‡æŒ‡é’ˆè®¿é—®ã€‚å› æ­¤æˆ‘ä»¬åªéœ€è¦åœ¨å…³è”å¯¹è±¡é”€æ¯æ—¶ï¼Œå†æ¬¡è°ƒç”¨objc_setAssociatedObjectç½®ä¸ºnilå°±å¯ä»¥äº†ã€‚</p>
<p>ä¸€ç§ç®€æ´çš„å®ç°ï¼šåˆ©ç”¨blockèƒ½å¤Ÿæ•è·è‡ªåŠ¨å˜é‡çš„ç‰¹ç‚¹ä»¥åŠç°æˆçš„weakç‰¹æ€§ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">XQDetailViewController</span> (<span class="title">Book</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) Book *myBook;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line">  </span><br><span class="line">- (Book *)myBook &#123;</span><br><span class="line">    <span class="type">id</span> (^block)(<span class="type">void</span>) = objc_getAssociatedObject (<span class="keyword">self</span>, <span class="keyword">@selector</span>(myBook));</span><br><span class="line">    <span class="type">id</span> obj = (block ? block () : <span class="literal">nil</span>);</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)setMyBook:(Book *)myBook &#123;</span><br><span class="line">    <span class="type">id</span> __<span class="keyword">weak</span> weakObject = myBook;</span><br><span class="line">    <span class="type">id</span> (^block)(<span class="type">void</span>) = ^&#123; <span class="keyword">return</span> weakObject; &#125;;</span><br><span class="line">    objc_setAssociatedObject (<span class="keyword">self</span>, <span class="keyword">@selector</span> (myBook), block, OBJC_ASSOCIATION_COPY_NONATOMIC);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¬¬äºŒç§åŠæ³•ï¼šåˆ©ç”¨ä¸­é—´å±‚ã€‚</p>
<p>ç¬¬ä¸‰ç§åŠæ³•ï¼šç»™å…³è”å¯¹è±¡æ·»åŠ ä¸€ä¸ªstubå­˜æ ¹å¯¹è±¡ï¼Œå­˜æ ¹å¯¹è±¡æ˜¯éšåŒå…³è”å¯¹è±¡é”€æ¯çš„ï¼Œå­˜æ ¹å¯¹è±¡é”€æ¯çš„deallocæ–¹æ³•é‡Œé¢è°ƒç”¨blockå°†å®¿ä¸»å¯¹è±¡çš„æ‰‹åŠ¨è®¾ç½®ä¸ºnilã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (Person *)person &#123;</span><br><span class="line">    <span class="type">id</span> obj = objc_getAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(person));</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)setPerson:(Person *)person &#123;</span><br><span class="line">    __<span class="keyword">weak</span> XQDetailViewController *obj = <span class="keyword">self</span>;</span><br><span class="line">    [person jj_deallocBlock:^&#123;</span><br><span class="line">      	<span class="comment">/// personå¯¹è±¡é”€æ¯åæ‰‹åŠ¨ç½®ä¸ºnil.</span></span><br><span class="line">        objc_setAssociatedObject(obj, <span class="keyword">@selector</span> (person), <span class="literal">nil</span>, OBJC_ASSOCIATION_ASSIGN);</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="comment">/// è¿™é‡Œä¸èƒ½å†æ˜¯retainäº†ï¼Œåªèƒ½æ˜¯assignã€‚ç„¶åå…³è”å¯¹è±¡é”€æ¯çš„æ—¶å€™å†æ‰‹åŠ¨ç½®ä¸ºnil.</span></span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span> (person), person, OBJC_ASSOCIATION_ASSIGN);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ‰æ²¡æœ‰é€šç”¨çš„æ–¹æ³•ï¼Ÿä»ç³»ç»Ÿå±‚é¢è§£å†³ï¼Ÿ</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://www.codenong.com/jsed65d71554d8/">å¦‚ä½•ä½¿ç”¨ Runtime ç»™ç°æœ‰çš„ç±»æ·»åŠ  weak å±æ€§</a></p>
<p><a href="https://sunsetroads.github.io/2020/03/22/weak-associated-object/">Weak Associated Object</a></p>
<p><a href="https://stackoverflow.com/questions/29934289/objc-setassociatedobject-retain-atomic-or-nonatomic">objc_setAssociatedObject retain atomic or nonatomic</a></p>
<p><a href="https://xcqromance.top/2018/05/16/2018-05-16/">iOSå¼€å‘é‡å‘æ€»ç»“</a></p>
<p><a href="https://blog.csdn.net/weixin_52093215/article/details/124852296">C++ å£°æ˜æœªçŸ¥å¤§å°çš„å…¨å±€æ•°ç»„</a> åªèƒ½ä½¿ç”¨</p>
<h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><h4 id="Qï¼š1-å…¨å±€å“ˆå¸Œè¡¨æˆ–æ•°ç»„å®ƒçš„å®¹é‡åé¢è¿˜èƒ½æ‰©å®¹å—ï¼Ÿ"><a href="#Qï¼š1-å…¨å±€å“ˆå¸Œè¡¨æˆ–æ•°ç»„å®ƒçš„å®¹é‡åé¢è¿˜èƒ½æ‰©å®¹å—ï¼Ÿ" class="headerlink" title="Qï¼š1.å…¨å±€å“ˆå¸Œè¡¨æˆ–æ•°ç»„å®ƒçš„å®¹é‡åé¢è¿˜èƒ½æ‰©å®¹å—ï¼Ÿ"></a>Qï¼š1.å…¨å±€å“ˆå¸Œè¡¨æˆ–æ•°ç»„å®ƒçš„å®¹é‡åé¢è¿˜èƒ½æ‰©å®¹å—ï¼Ÿ</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX 10</span></span><br><span class="line"><span class="type">char</span> a[MAX]; <span class="comment">//å…¨å±€åŒº</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	<span class="type">char</span> b[MAX]; <span class="comment">//æ ˆåŒº</span></span><br><span class="line">	<span class="type">char</span> *c=(<span class="type">char</span> *)<span class="built_in">malloc</span>(MAX * <span class="keyword">sizeof</span>(<span class="type">char</span>));  <span class="comment">//å †åŒº</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ•°ç»„çš„å¤§å°å…¶å®æ˜¯å›ºå®šçš„ã€‚æ‰©å®¹å¹¶ä¸æ˜¯åœ¨åŸæ¥çš„å†…å­˜åŸºç¡€ä¸Šå¢åŠ å†…å­˜ï¼Œè€Œæ˜¯é‡æ–°ç”³è¯·ä¸€ç‰‡å†…å­˜ï¼Œç„¶åæŠŠä¹‹å‰çš„æ•°æ®æ‹·è´è¿‡æ¥ï¼Œæ•ˆæœä¸Šçœ‹èµ·æ¥åƒæ˜¯åŸæ¥çš„æ•°ç»„å˜å¤§äº†ã€‚è€Œä¸ºäº†è¡¨è¿°æ–¹ä¾¿å°±æŠŠè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºæ‰©å®¹ã€‚èƒ½å¤Ÿæ‰©å®¹è¯´æ˜è¿™æ®µå†…å­˜æ˜¯ç”±ç¨‹åºå‘˜ç®¡ç†çš„ï¼Œè€Œåªæœ‰å †åŒºçš„å†…å­˜æ˜¯ç”±ç¨‹åºå‘˜è´Ÿè´£ç”³è¯·å’Œé‡Šæ”¾ã€‚è€Œå…¨å±€åŒºçš„å†…å­˜æ˜¯ç”±ç³»ç»Ÿåˆ†é…ç®¡ç†çš„ï¼Œæ‰€ä»¥æ— æ³•åœ¨å…¨å±€åŒºå†…å­˜è¿›è¡Œæ•°ç»„æ‰©å®¹ã€‚ä¸Šé¢çš„å…¨å±€å…³è”å“ˆå¸Œè¡¨å®é™…ä¸Šç±»ä¼¼äºä¸€ä¸ªå…¨å±€æŒ‡é’ˆå˜é‡ï¼ŒæŒ‡å‘ä¸€ä¸ªå †ä¸Šçš„å“ˆå¸Œè¡¨ã€‚å› æ­¤å¯ä»¥æ‰©å®¹å‡å®¹ã€‚weakä¸­çš„å…¨å±€SideTablesMapå“ˆå¸Œè¡¨ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚ç›®å‰å¾ˆå°‘çœ‹åˆ°ä½¿ç”¨ç›´æ¥åœ¨å…¨å±€åŒºåˆ›å»ºçš„æ•°ç»„ï¼Œä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨æŒ‡é’ˆã€‚</p>
<p><strong>åè¿›åˆ¶(decimal)</strong>ï¼šé0å¼€å¤´,æ‰€ä»¥å…¶ä»–è¿›åˆ¶çš„å†™æ³•è¦å‰è¡¥0ç”¨äºåŒºåˆ†ï¼›</p>
<p><strong>äºŒè¿›åˆ¶ï¼ˆbinaryï¼‰</strong>ï¼š 0b æˆ– 0Bå¼€å¤´ï¼›</p>
<p><strong>å…«è¿›åˆ¶(Octalç¼©å†™OCTæˆ–O)</strong> ï¼šå¸¸å¸¸ä»¥æ•°å­—0å¼€å§‹è¡¨æ˜è¯¥æ•°å­—æ˜¯å…«è¿›åˆ¶ï¼›</p>
<p><strong>åå…­è¿›åˆ¶ï¼ˆï¼ˆç®€å†™ä¸ºhexæˆ–ä¸‹æ ‡16ï¼‰ï¼‰</strong>ï¼š0xæˆ–0Xå¼€å¤´ï¼›</p>
<p><strong>è´Ÿæ•°</strong>ï¼šå‰é¢åŠ  -</p>
<p>å·¦ç§»ï¼š</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">NSInteger</span> a = <span class="number">0</span> &lt;&lt; <span class="number">8</span>; //           <span class="number">0</span></span><br><span class="line"><span class="attribute">NSInteger</span> b = <span class="number">1</span> &lt;&lt; <span class="number">8</span>; // <span class="number">01</span> <span class="number">0000</span> <span class="number">0000</span></span><br><span class="line"><span class="attribute">NSInteger</span> c = <span class="number">2</span> &lt;&lt; <span class="number">8</span>; // <span class="number">10</span> <span class="number">0000</span> <span class="number">0000</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>runtime</category>
      </categories>
      <tags>
        <tag>å…³è”å¯¹è±¡</tag>
      </tags>
  </entry>
  <entry>
    <title>NSURLSessionç®€å•ä»‹ç»</title>
    <url>/2021/08/29/NSURLSession%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D/</url>
    <content><![CDATA[<h2 id="NSURLSessionä»‹ç»"><a href="#NSURLSessionä»‹ç»" class="headerlink" title="NSURLSessionä»‹ç»"></a>NSURLSessionä»‹ç»</h2><p>NSURLSessionæ˜¯è‹¹æœå¯¹ç½‘ç»œä¼šè¯çš„å°è£…ï¼Œå¯ä»¥å®Œå…¨æ›¿ä»£åŸæ¥çš„NSURLConnectionã€‚ç›¸æ¯”äºNSURLConnectionï¼ŒNSURLSessionå…·å¤‡ä»¥ä¸‹ä¼˜åŠ¿:</p>
<p>ä¸NSURLConnectionç›¸æ¯”ä¸å†éœ€è¦å¤„ç†RunLoopç›¸å…³çš„ä¸œè¥¿<br>æ”¯æŒHTTP/2 å’Œ HTTP/3åè®®<br>æ”¯æŒåœ¨APPæœªè¿è¡Œæˆ–æŒ‚èµ·æ—¶è¿›è¡Œåå°ä¸‹è½½/ä¸Šä¼ <br>æä¾›äº†å…¨å±€çš„sessionï¼Œä½¿ç”¨æ–¹ä¾¿<br>æä¾›äº†ä¸°å¯Œçš„ä»£ç†æ–¹æ³•<br>æ”¯æŒç›‘æµ‹æ•´ä¸ªHTTPäº‹åŠ¡å„ä¸ªé˜¶æ®µçš„ç½‘ç»œæŒ‡æ ‡</p>
<h3 id="æ”¯æŒçš„åè®®"><a href="#æ”¯æŒçš„åè®®" class="headerlink" title="æ”¯æŒçš„åè®®"></a>æ”¯æŒçš„åè®®</h3><figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line">The URLSession class natively supports <span class="keyword">the</span> data, <span class="built_in">file</span>, <span class="keyword">ftp</span>, <span class="keyword">http</span>, <span class="keyword">and</span> <span class="keyword">https</span> <span class="built_in">URL</span> schemes, <span class="keyword">with</span> transparent support <span class="keyword">for</span> proxy servers <span class="keyword">and</span> SOCKS gateways, <span class="keyword">as</span> configured <span class="keyword">in</span> <span class="keyword">the</span> userâ€™s <span class="keyword">system</span> preferences.</span><br><span class="line"></span><br><span class="line">URLSession supports <span class="keyword">the</span> HTTP/<span class="number">1.1</span>, HTTP/<span class="number">2</span>, <span class="keyword">and</span> HTTP/<span class="number">3</span> protocols. HTTP/<span class="number">2</span> support, <span class="keyword">as</span> described <span class="keyword">by</span> RFC <span class="number">7540</span>, requires <span class="keyword">a</span> server that supports Application-Layer Protocol Negotiation (ALPN).</span><br><span class="line"></span><br><span class="line">You can also <span class="built_in">add</span> support <span class="keyword">for</span> your own custom networking protocols <span class="keyword">and</span> <span class="built_in">URL</span> schemes (<span class="keyword">for</span> your appâ€™s <span class="keyword">private</span> use) <span class="keyword">by</span> subclassing URLProtocol.</span><br></pre></td></tr></table></figure>
<p>URLSessionåŸç”Ÿæ”¯æŒdata, file, ftp, http, å’Œ httpsåè®®ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥å­ç±»åŒ–URLProtocolæ¥æ”¯æŒè‡ªå·±çš„ç§æœ‰ç½‘ç»œåè®®ã€‚URLSessionæ”¯æŒçš„HTTPç‰ˆæœ¬ä¸ºHTTP/1.1, HTTP/2, å’Œ HTTP/3ï¼Œå½“ç„¶è¦æƒ³ä½¿ç”¨åˆ°HTTP/2, HTTP/3æœåŠ¡å™¨ç«¯ä¹Ÿå¿…é¡»å¾—æ”¯æŒæ‰è¡Œã€‚</p>
<h2 id="URLSessionConfiguration"><a href="#URLSessionConfiguration" class="headerlink" title="URLSessionConfiguration"></a>URLSessionConfiguration</h2><h3 id="httpMaximumConnectionsPerHost"><a href="#httpMaximumConnectionsPerHost" class="headerlink" title="httpMaximumConnectionsPerHost"></a>httpMaximumConnectionsPerHost</h3><p>åŒä¸€æ—¶é—´ï¼ŒåŒä¸€ä¸ªhostçš„æœ€å¤§httpè¿æ¥æ•°é‡ï¼Œé»˜è®¤6ä¸ªã€‚è¯¥é™åˆ¶æ˜¯é’ˆå¯¹å•ä¸ªsessionçš„ï¼Œå¦‚æœä½ æœ‰å¤šä¸ªsessionï¼Œé‚£ä¹ˆä½ çš„Appå¯èƒ½å°±ä¼šè¶…è¿‡è¿™ä¸ªé™åˆ¶ã€‚å—å½“å‰è¿æ¥èµ„æºå½±å“ï¼Œå•ä¸ªsessionçš„å®é™…httpMaximumConnectionsPerHostå¯èƒ½ä¼šå°äºä½ è®¾ç½®çš„å€¼ã€‚</p>
<h2 id="NSURLSessionçš„åŸºç¡€ç”¨æ³•"><a href="#NSURLSessionçš„åŸºç¡€ç”¨æ³•" class="headerlink" title="NSURLSessionçš„åŸºç¡€ç”¨æ³•"></a>NSURLSessionçš„åŸºç¡€ç”¨æ³•</h2><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">  - (<span class="type">void</span>)viewDidLoad &#123;</span><br><span class="line">  [<span class="variable language_">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">  <span class="built_in">NSURLSessionConfiguration</span> *config = [<span class="built_in">NSURLSessionConfiguration</span> defaultSessionConfiguration];</span><br><span class="line">  <span class="built_in">NSOperationQueue</span> *queue = [[<span class="built_in">NSOperationQueue</span> alloc] init];</span><br><span class="line">  queue.maxConcurrentOperationCount = <span class="number">3</span>; <span class="comment">//è®¾ç½®ä»£ç†å›è°ƒé˜Ÿåˆ—çš„æœ€å¤§å¹¶å‘æ•°ã€‚</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">self</span>.session = [<span class="built_in">NSURLSession</span> sessionWithConfiguration:config delegate:<span class="keyword">self</span> delegateQueue:queue];</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, <span class="keyword">self</span>.session);</span><br><span class="line">    </span><br><span class="line">  <span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:landscapeUrl];</span><br><span class="line">  <span class="built_in">NSMutableURLRequest</span> *req = [<span class="built_in">NSMutableURLRequest</span> requestWithURL:url cachePolicy:<span class="built_in">NSURLRequestReloadIgnoringLocalCacheData</span> timeoutInterval:<span class="number">60</span> * <span class="number">5</span>];</span><br><span class="line">  <span class="built_in">NSURLSessionDataTask</span> *dataTask = [<span class="keyword">self</span>.session dataTaskWithRequest:req];</span><br><span class="line">  [dataTask resume];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  - (<span class="type">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session dataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask</span><br><span class="line">didReceiveResponse:(<span class="built_in">NSURLResponse</span> *)response</span><br><span class="line">completionHandler:(<span class="type">void</span> (^)(<span class="built_in">NSURLSessionResponseDisposition</span> disposition))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;æ”¶åˆ°å“åº”:%@     \ndataTask:%@&quot;</span>, response, dataTask);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">self</span>.mData = [<span class="built_in">NSMutableData</span> data];</span><br><span class="line"></span><br><span class="line">  <span class="built_in">NSURLSessionResponseDisposition</span> disposition = <span class="built_in">NSURLSessionResponseAllow</span>;</span><br><span class="line">  completionHandler(disposition);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session dataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask</span><br><span class="line">  didReceiveData:(<span class="built_in">NSData</span> *)data</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;%@æ”¶åˆ°data:%ld&quot;</span>,[<span class="built_in">NSThread</span> currentThread] ,data.length);</span><br><span class="line"></span><br><span class="line">  [<span class="keyword">self</span>.mData appendData:data];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session task:(<span class="built_in">NSURLSessionTask</span> *)task</span><br><span class="line">didCompleteWithError:(<span class="keyword">nullable</span> <span class="built_in">NSError</span> *)error</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;å®Œæˆ, error:%@&quot;</span>, error);</span><br><span class="line">  <span class="keyword">if</span> (!error) &#123;</span><br><span class="line">      <span class="comment">//åœ¨å®Œæˆçš„æ—¶å€™,ä¹‹å‰æ”¶åˆ°çš„dataæ€ä¹ˆå–åˆ°?ä¸å€ŸåŠ©å…¶ä»–çš„å˜é‡,åœ¨è¯¥æ–¹æ³•é‡Œå–ä¸åˆ°?</span></span><br><span class="line">      <span class="built_in">NSDictionary</span> *dict = [<span class="built_in">NSJSONSerialization</span> JSONObjectWithData:<span class="keyword">self</span>.mData options:<span class="built_in">NSJSONReadingAllowFragments</span> error:<span class="literal">nil</span>];</span><br><span class="line">      <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, dict);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//ä¸æŠŠæœ¬æ¬¡session Invalidate,é‚£ä¹ˆsessionæŒæœ‰çš„delegateä¸ä¼šè¢«é‡Šæ”¾.</span></span><br><span class="line">  [session finishTasksAndInvalidate];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹äºæ–¹æ³• </p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="built_in">NSURLSession</span> *)sessionWithConfiguration:(<span class="built_in">NSURLSessionConfiguration</span> *)configuration </span><br><span class="line">								  delegate:(<span class="keyword">nullable</span> <span class="type">id</span> &lt;<span class="built_in">NSURLSessionDelegate</span>&gt;)delegate </span><br><span class="line">							 delegateQueue:(<span class="keyword">nullable</span> <span class="built_in">NSOperationQueue</span> *)queue;</span><br></pre></td></tr></table></figure>
<p>delegateå’ŒdelegateQueueä¼šè¢«sessionå¼ºå¼•ç”¨ã€‚åªæœ‰å½“sessionè¢« invalidateå,delegateåœ¨<code>URLSession:didBecomeInvalidWithError</code>ç»“æŸåæ‰ä¼šè¢«é‡Šæ”¾.å¯¹äºdelegateQueue,å®é™…ä½¿ç”¨æ—¶delegateQueueæœ€å¥½ä¸è¦è®¾ç½®ä¸ºä¸»é˜Ÿåˆ—ï¼ˆä¼šå¢åŠ ä¸»çº¿ç¨‹è´Ÿæ‹…ï¼‰.å½“delegateQueueä¸æ˜¯ä¸»é˜Ÿåˆ—æ—¶,didReceiveData:æ–¹æ³•å°†éšæœºåœ¨æŸä¸ªçº¿ç¨‹æ‰§è¡Œ.</p>
<p>åŸºæœ¬ä¸Šä¸€ä¸ªAPP,ç”Ÿæˆä¸€ä¸ªurlSessionå°±å¤Ÿäº†.æ²¡å¿…è¦ä¸€æ¬¡è¯·æ±‚,åˆ›å»ºä¸€ä¸ªsession,è¯·æ±‚ç»“æŸååˆå°†session Invalidate.å› æ­¤ä¹Ÿå°±æ²¡å¿…è¦å»ç®¡delegateå’ŒdelegateQueueçš„å†…å­˜é‡Šæ”¾é—®é¢˜,è¿™ä¸‰ä¸ªå¯¹è±¡åŸºæœ¬ä¸Šæ˜¯ç­‰åˆ°APPç»“æŸæ‰ä¼šé”€æ¯çš„.ä¸€èˆ¬çš„åšæ³•æ˜¯å¸¸è§„çš„APIè¯·æ±‚ä½¿ç”¨ä¸€ä¸ªsessionï¼Œä¸Šä¼ ä¸‹è½½çš„è¯·æ±‚ä½¿ç”¨å¦ä¸€ä¸ªsessionã€‚</p>
<p>å¯¹äºä»£ç†æ–¹æ³•: </p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session dataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask</span><br><span class="line">didReceiveResponse:(<span class="built_in">NSURLResponse</span> *)response</span><br><span class="line"> completionHandler:(<span class="type">void</span> (^)(<span class="built_in">NSURLSessionResponseDisposition</span> disposition))completionHandler</span><br></pre></td></tr></table></figure>
<p><strong>åœ¨è¯¥æ–¹æ³•ä¸­,ä¸ºä»€ä¹ˆæ”¶åˆ°å“åº”å,è¿˜è¦è°ƒç”¨completionHandler?</strong><br>å› ä¸ºåœ¨è¯¥æ–¹æ³•ä¸­,é€šè¿‡dispositionå‚æ•°,è°ƒç”¨completionHandlerå,å¯ä»¥æ›´ç»†ç²’åº¦çš„æ§åˆ¶æœ¬æ¬¡è¯·æ±‚æ˜¯ç»§ç»­è¿˜æ˜¯å–æ¶ˆè¿˜æ˜¯è½¬ä¸ºä¸‹è½½ä»»åŠ¡.å¦‚æœæ˜¯å–æ¶ˆ,åˆ™åé¢è¯·æ±‚çš„å“åº”ä½“ä¸ä¼šæ¥æ”¶.å¦‚æœæ˜¯è½¬ä¸ºä¸‹è½½ä»»åŠ¡,é‚£ä¹ˆé€šè¿‡è°ƒç”¨completionHandler,NSURLSessionå°†è°ƒç”¨Delegateçš„ <code>URLSession:dataTask:didBecomeDownloadTask:</code>æ–¹æ³•å¹¶å°†æ–°ç”Ÿæˆçš„Download taskå¯¹è±¡ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚åœ¨æ­¤è°ƒç”¨ä¹‹åï¼ŒDelegateå°†ä¸å†æ¥æ”¶æ¥è‡ªData taskçš„å›è°ƒæ¶ˆæ¯ï¼Œå¹¶å¼€å§‹æ¥æ”¶Download taskçš„å›è°ƒæ¶ˆæ¯ã€‚<br>æ³¨æ„:å¦‚æœä¸è°ƒç”¨</p>
<figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">NSURLSessionResponseDisposition disposition <span class="operator">=</span> NSURLSessionResponseAllow<span class="comment">;</span></span><br><span class="line">completionHandler(disposition)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>åé¢çš„didReceiveData:ä»£ç†æ–¹æ³•å°†ä¸ä¼šæ‰§è¡Œ.</p>
<h2 id="delegateQueue"><a href="#delegateQueue" class="headerlink" title="delegateQueue"></a>delegateQueue</h2><p>å›è°ƒçš„æ´¾å‘é˜Ÿåˆ—ï¼Œæ–¹æ³•å‚æ•°è¯´æ˜ï¼š</p>
<figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line">An operation queue <span class="keyword">for</span> scheduling the <span class="keyword">delegate</span> calls <span class="keyword">and</span> completion handlers. The queue should be a serial queue, <span class="keyword">in</span> <span class="keyword">order</span> <span class="keyword">to</span> <span class="keyword">ensure</span> the correct ordering <span class="keyword">of</span> callbacks. <span class="keyword">If</span> <span class="keyword">nil</span>, the session creates a serial operation queue <span class="keyword">for</span> performing all <span class="keyword">delegate</span> <span class="keyword">method</span> <span class="title function_">calls</span> <span class="title function_">and</span> <span class="title function_">completion</span> <span class="title function_">handler</span> <span class="title function_">calls</span>.</span><br></pre></td></tr></table></figure>
<p>ç”¨äºæ‰§è¡Œdelegateå›è°ƒå’Œå®Œæˆå¤„ç†çš„æ´¾å‘é˜Ÿåˆ—ï¼ŒdelegateQueueæœ€å¥½æ˜¯ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿æ­£ç¡®çš„å›è°ƒé¡ºåºã€‚é»˜è®¤æ˜¯ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ã€‚æ³¨æ„è¿™ä¸ªåªæ˜¯å›è°ƒæ–¹æ³•çš„æ´¾å‘é˜Ÿåˆ—ï¼Œå’Œç½‘ç»œè¯·æ±‚çš„çº¿ç¨‹ä¸æ˜¯åŒä¸€ä¸ªã€‚</p>
<figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">ç½‘ç»œè¯·æ±‚çº¿ç¨‹        å›è°ƒé˜Ÿåˆ—</span><br><span class="line">    |<span class="string">               </span>|</span><br><span class="line">    |<span class="string">  callback1    </span>|</span><br><span class="line">    |<span class="string">-----------&gt;   </span>|</span><br><span class="line">    |<span class="string">               </span>|</span><br><span class="line">    |<span class="string">  callback2    </span>|</span><br><span class="line">    |<span class="string">-----------&gt;   </span>|</span><br><span class="line">    |<span class="string">               </span>|</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæ–‡æ¡£æ˜¯shouldï¼Œå¦‚æœç”¨ä¸ªå¹¶å‘é˜Ÿåˆ—ä¼šæ€æ ·ï¼Ÿæˆ‘ä»¬é¡¹ç›®é‡Œç”¨çš„å°±æ˜¯å¹¶å‘é˜Ÿåˆ—ï¼Œç”¨äº†è¿™ä¹ˆä¹…å¥½åƒä¹Ÿæ²¡ä»€ä¹ˆå½±å“ã€‚</p>
<p>åœºæ™¯ï¼šç‚¹å‡»æŒ‰é’®ï¼Œå‘èµ·1ä¸ªè¯·æ±‚ï¼Œæ•…æ„é˜»å¡didReceiveDataå›è°ƒã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session dataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask didReceiveData:(<span class="built_in">NSData</span> *)data</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span>.mData appendData:data];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> time = MAX(<span class="number">1</span>, arc4random() % <span class="number">4</span>);</span><br><span class="line">    sleep(time*<span class="number">10</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;æœ¬æ¬¡æ¥æ”¶:%ld,æ€»å…±æ¥æ”¶:%ld,çº¿ç¨‹ï¼š%@&quot;</span>, data.length, <span class="keyword">self</span>.mData.length, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å³ä½¿delegateQueueçš„æœ€å¤§å¹¶å‘æ•°è®¾ç½®ä¸º3ï¼Œä½†æ˜¯didReceiveDataçš„å›è°ƒè¡Œä¸ºè¿˜æ˜¯ç±»ä¼¼ä¸²è¡Œï¼ˆè™½ç„¶æ¯æ¬¡çº¿ç¨‹ç¡®å®ä¼šä¸ä¸€æ ·ï¼‰ï¼Œä¸ä¼šå‡ºç°ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å›è°ƒdidReceiveDataã€‚</p>
<p>é€šè¿‡å®éªŒå¯ä»¥å¾—å‡ºï¼š</p>
<p>1.delegateQueueçš„æœ€å¤§å¹¶å‘æ•°è®¾ç½®ä¸º1ï¼Œé‚£ä¹ˆå›è°ƒå°±æ˜¯ä¸²è¡Œçš„ï¼Œç”±äºå¤šä¸ªè¯·æ±‚å…±ç”¨è¿™ä¸€ä¸ªå›è°ƒæ´¾å‘é˜Ÿåˆ—ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªè¯·æ±‚çš„ä»£ç†æ–¹æ³•æ¯”è¾ƒè€—æ—¶ï¼Œé‚£ä¹ˆå…¶ä»–è¯·æ±‚çš„å›è°ƒå°†ä¼šç­‰å¾…å‰é¢çš„å›è°ƒã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session dataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask didReceiveData:(<span class="built_in">NSData</span> *)data</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSURL</span> *url = dataTask.originalRequest.URL;</span><br><span class="line">    <span class="built_in">NSMutableData</span> *dataContainer = [<span class="keyword">self</span> dataWithURL:url];</span><br><span class="line">    [dataContainer appendData:data];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;æœ¬æ¬¡æ¥æ”¶1:%ld,çº¿ç¨‹ï¼š%@, url:%@&quot;</span>, data.length, [<span class="built_in">NSThread</span> currentThread], url.lastPathComponent);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (url.absoluteString == landscapeUrl) &#123; <span class="comment">//æ•…æ„è®©landscapeUrlçš„è¯·æ±‚å›è°ƒé˜»å¡ä¸€ä¸‹ï¼Œå…¶ä»–urlä¸é˜»å¡ã€‚</span></span><br><span class="line">        sleep(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;æœ¬æ¬¡æ¥æ”¶2:%ld,æ€»å…±æ¥æ”¶:%ld,çº¿ç¨‹ï¼š%@, url:%@&quot;</span>, data.length, dataContainer.length, [<span class="built_in">NSThread</span> currentThread], url.lastPathComponent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸è¿‡ä¸€èˆ¬æƒ…å†µä¸‹didReceiveDataä¸å¯èƒ½å‡ºç°è¿™ç§æ•…æ„é˜»å¡çš„å†™æ³•ï¼Œæ‰€ä»¥delegateQueueçš„å¹¶å‘æ•°è®¾ç½®ä¸º1å‡ ä¹æ²¡æœ‰ä»€ä¹ˆå½±å“ï¼Œå¦‚æœæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„ç†ç”±è¿˜æ˜¯æŒ‰æ–‡æ¡£ä¸Šæ¥è®¾ç½®ä¸º1å§ã€‚</p>
<p>2.delegateQueueçš„æœ€å¤§å¹¶å‘æ•°è®¾ç½®ä¸º3ï¼ˆå¤§äº1çš„æƒ…å†µï¼‰ï¼Œé‚£ä¹ˆå›è°ƒå°±æ˜¯å¹¶å‘çš„ï¼Œç›®å‰æ²¡çœ‹åˆ°æœ‰ä»€ä¹ˆå¼‚å¸¸å½±å“ã€‚å› ä¸ºæ˜¯å¹¶å‘é˜Ÿåˆ—ï¼Œå…¶ä»–è¯·æ±‚çš„å›è°ƒä¸ç”¨ç­‰å¾…å‰é¢çš„å›è°ƒå®Œæˆå› è€Œå¯ä»¥å¿«é€Ÿè¢«å›è°ƒã€‚</p>
<p>3.å³ä½¿delegateQueueçš„æœ€å¤§å¹¶å‘æ•°è®¾ç½®ä¸º3ï¼Œå¯¹äºåŒä¸€ä¸ªè¯·æ±‚çš„å›è°ƒï¼ŒdidReceiveDataçš„å›è°ƒè¡Œä¸ºè¿˜æ˜¯ç±»ä¼¼ä¸²è¡Œï¼ˆè™½ç„¶æ¯æ¬¡çº¿ç¨‹ç¡®å®ä¼šä¸ä¸€æ ·ï¼‰ï¼Œä¸ä¼šå‡ºç°ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å›è°ƒdidReceiveDataã€‚</p>
<h2 id="defaultSession-å’Œ-ephemeralSession"><a href="#defaultSession-å’Œ-ephemeralSession" class="headerlink" title="defaultSession å’Œ ephemeralSession"></a>defaultSession å’Œ ephemeralSession</h2><p>ephemeralSessionï¼Œä¸ä¼šå°†å“åº”ç¼“å­˜åˆ°ç£ç›˜ï¼Œä¹Ÿä¸ä¼šä½¿ç”¨ç£ç›˜ç¼“å­˜çš„å“åº”ã€‚æœ€å¤šå°†ä¸€äº›session-relatedçš„æ•°æ®ä¿å­˜åœ¨å†…å­˜ã€‚APPç»“æŸï¼Œæ‰€æœ‰ä¼šè¯ä¿¡æ¯éƒ½ä¼šéšç€å†…å­˜å›æ”¶è€Œè¢«æ¸…é™¤ã€‚</p>
<p>defaultSessionï¼Œé»˜è®¤sessionï¼Œå¦‚æœå“åº”èƒ½å¤Ÿç¼“å­˜åˆ™ä¼šå°†å“åº”æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚</p>
<h2 id="é—®ç­”"><a href="#é—®ç­”" class="headerlink" title="é—®ç­”"></a>é—®ç­”</h2><h3 id="1-NSURLSessionå¯¹è±¡æ˜¯è¢«è°å¼ºå¼•ç”¨äº†-å¦‚ä½•é‡Šæ”¾"><a href="#1-NSURLSessionå¯¹è±¡æ˜¯è¢«è°å¼ºå¼•ç”¨äº†-å¦‚ä½•é‡Šæ”¾" class="headerlink" title="1.NSURLSessionå¯¹è±¡æ˜¯è¢«è°å¼ºå¼•ç”¨äº†?å¦‚ä½•é‡Šæ”¾?"></a>1.NSURLSessionå¯¹è±¡æ˜¯è¢«è°å¼ºå¼•ç”¨äº†?å¦‚ä½•é‡Šæ”¾?</h3><p>NSURLSessionå¯¹è±¡åº”è¯¥æ˜¯è¢«ç³»ç»Ÿçš„runloopå¼ºå¼•ç”¨äº†,å°±ç±»ä¼¼äºå®šæ—¶å™¨ä¸€æ ·,éœ€è¦invalidå,æ‰ä¼šè¢«é‡Šæ”¾é”€æ¯.<br>é¢˜å¤–è¯:å¦‚æœtimerå±æ€§æ˜¯strong,é‚£ä¹ˆinvalidateåæœ€å¥½å°†å…¶ç½®ä¸ºnil,å¦åˆ™invalidåtimerå› ä¸ºè¿˜æœ‰äººæŒæœ‰å®ƒ,è€Œä¸èƒ½é”€æ¯.strongæƒ…å†µä¸‹,timerçš„é‡Šæ”¾: <code>[self.timer invalidate];self.timer = nil;</code>å®šæ—¶å™¨å¯¹è±¡æ˜¯æ³¨å†Œåˆ°runloopé‡Œçš„,åº”è¯¥é€šè¿‡invalidateæ¥å‘Šè¯‰runloopé‡Šæ”¾å®ƒ.æ‰€ä»¥selfä¸åº”è¯¥æŒæœ‰è¯¥å¯¹è±¡,å› æ­¤timerå±æ€§æœ€å¥½ä¸ºweak.</p>
<h3 id="2-åœ¨didCompleteWithError-å®Œæˆçš„æ—¶å€™-ä¹‹å‰æ”¶åˆ°çš„dataæ€ä¹ˆå–åˆ°-ä¸å€ŸåŠ©å…¶ä»–çš„å˜é‡-åœ¨è¯¥æ–¹æ³•é‡Œå–ä¸åˆ°"><a href="#2-åœ¨didCompleteWithError-å®Œæˆçš„æ—¶å€™-ä¹‹å‰æ”¶åˆ°çš„dataæ€ä¹ˆå–åˆ°-ä¸å€ŸåŠ©å…¶ä»–çš„å˜é‡-åœ¨è¯¥æ–¹æ³•é‡Œå–ä¸åˆ°" class="headerlink" title="2. åœ¨didCompleteWithError:å®Œæˆçš„æ—¶å€™,ä¹‹å‰æ”¶åˆ°çš„dataæ€ä¹ˆå–åˆ°?ä¸å€ŸåŠ©å…¶ä»–çš„å˜é‡,åœ¨è¯¥æ–¹æ³•é‡Œå–ä¸åˆ°?"></a>2. åœ¨didCompleteWithError:å®Œæˆçš„æ—¶å€™,ä¹‹å‰æ”¶åˆ°çš„dataæ€ä¹ˆå–åˆ°?ä¸å€ŸåŠ©å…¶ä»–çš„å˜é‡,åœ¨è¯¥æ–¹æ³•é‡Œå–ä¸åˆ°?</h3><p>å®Œæˆå›è°ƒé‡Œæ˜¯å–ä¸åˆ°dataçš„ã€‚éœ€è¦åœ¨ç›¸åº”çš„ä»£ç†æ–¹æ³•é‡Œä¿å­˜æ•°æ®ã€‚</p>
<h3 id="3-è¯·æ±‚è½¬ä¸ºä¸‹è½½ä»»åŠ¡æ—¶ï¼Œä¸ºä»€ä¹ˆä¼šè½¬ç§»åˆ°å…¶ä»–çš„ä»£ç†æ–¹æ³•æ¯”å¦‚didBecomeDownloadTaskï¼Ÿ"><a href="#3-è¯·æ±‚è½¬ä¸ºä¸‹è½½ä»»åŠ¡æ—¶ï¼Œä¸ºä»€ä¹ˆä¼šè½¬ç§»åˆ°å…¶ä»–çš„ä»£ç†æ–¹æ³•æ¯”å¦‚didBecomeDownloadTaskï¼Ÿ" class="headerlink" title="3. è¯·æ±‚è½¬ä¸ºä¸‹è½½ä»»åŠ¡æ—¶ï¼Œä¸ºä»€ä¹ˆä¼šè½¬ç§»åˆ°å…¶ä»–çš„ä»£ç†æ–¹æ³•æ¯”å¦‚didBecomeDownloadTaskï¼Ÿ"></a>3. è¯·æ±‚è½¬ä¸ºä¸‹è½½ä»»åŠ¡æ—¶ï¼Œä¸ºä»€ä¹ˆä¼šè½¬ç§»åˆ°å…¶ä»–çš„ä»£ç†æ–¹æ³•æ¯”å¦‚didBecomeDownloadTaskï¼Ÿ</h3><p>è¿™æ˜¯å› ä¸ºä¸‹è½½ä»»åŠ¡çš„èµ„æºä¸€èˆ¬è¾ƒå¤§ï¼Œæ¥æ”¶åˆ°çš„æ•°æ®ä¸èƒ½åƒæ™®é€šè¯·æ±‚é‚£æ ·ç›´æ¥ç¼“å­˜åœ¨å†…å­˜ï¼Œå¦åˆ™ä¼šå¯¼è‡´APP OOMã€‚æ‰€ä»¥å¿…é¡»è½¬ç§»åˆ°å…¶ä»–ä»£ç†æ–¹æ³•è¾¹æ¥æ”¶è¾¹ç¼“å­˜åˆ°ç£ç›˜ã€‚</p>
<h3 id="4-TCPæ¥æ”¶åˆ°æ•°æ®åæ˜¯æ€ä¹ˆä¼ ç»™NSURLSessionçš„ï¼ŒNSURLSessionåˆæ˜¯æ€ä¹ˆä¼ ç»™delegateQueueæ‰§è¡Œå„ä¸ªä»£ç†æ–¹æ³•çš„ï¼Œçº¿ç¨‹å…³ç³»ï¼ŸTODO"><a href="#4-TCPæ¥æ”¶åˆ°æ•°æ®åæ˜¯æ€ä¹ˆä¼ ç»™NSURLSessionçš„ï¼ŒNSURLSessionåˆæ˜¯æ€ä¹ˆä¼ ç»™delegateQueueæ‰§è¡Œå„ä¸ªä»£ç†æ–¹æ³•çš„ï¼Œçº¿ç¨‹å…³ç³»ï¼ŸTODO" class="headerlink" title="4.TCPæ¥æ”¶åˆ°æ•°æ®åæ˜¯æ€ä¹ˆä¼ ç»™NSURLSessionçš„ï¼ŒNSURLSessionåˆæ˜¯æ€ä¹ˆä¼ ç»™delegateQueueæ‰§è¡Œå„ä¸ªä»£ç†æ–¹æ³•çš„ï¼Œçº¿ç¨‹å…³ç³»ï¼ŸTODO"></a>4.TCPæ¥æ”¶åˆ°æ•°æ®åæ˜¯æ€ä¹ˆä¼ ç»™NSURLSessionçš„ï¼ŒNSURLSessionåˆæ˜¯æ€ä¹ˆä¼ ç»™delegateQueueæ‰§è¡Œå„ä¸ªä»£ç†æ–¹æ³•çš„ï¼Œçº¿ç¨‹å…³ç³»ï¼ŸTODO</h3><p>ä¸çŸ¥é“ã€‚</p>
]]></content>
      <categories>
        <category>Foundation</category>
      </categories>
      <tags>
        <tag>NSURLSession</tag>
      </tags>
  </entry>
  <entry>
    <title>TASã€CASç®€ä»‹</title>
    <url>/2021/08/01/TAS%E3%80%81CAS%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<p>åŸå­æ“ä½œæ˜¯æŒ‡æ“ä½œæ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œè¦ä¹ˆå‘ç”Ÿï¼Œè¦ä¹ˆä¸å‘ç”Ÿã€‚äº‹ç‰©åªä¼šå¤„äºåŸå§‹çŠ¶æ€å’ŒæˆåŠŸçŠ¶æ€ä¸¤ç§ä¸­çš„ä¸€ç§ï¼Œä¸ä¼šå¤„äºä¸€ç§å®Œæˆä¸€åŠçš„çŠ¶æ€ã€‚</p>
<p>TASå’ŒCASæŒ‡ä»¤æ˜¯åŸå­æ“ä½œï¼Œä½†æˆ‘æ„Ÿè§‰åŸå­æ“ä½œä¸ä»…æ˜¯åŸå­æ“ä½œè€Œä¸”è¿˜æ˜¯æ’ä»–çš„ï¼Œä¸€ä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡ŒæŸä¸ªåŸå­æ“ä½œæ—¶ï¼Œå…¶ä»–çº¿ç¨‹ä¸èƒ½åŒæ—¶å†æ‰§è¡Œè¯¥åŸå­æ“ä½œã€‚</p>
<h3 id="Cè¯­è¨€é‡Œçš„volatile"><a href="#Cè¯­è¨€é‡Œçš„volatile" class="headerlink" title="Cè¯­è¨€é‡Œçš„volatile"></a>Cè¯­è¨€é‡Œçš„volatile</h3><p>ä½œç”¨ï¼š</p>
<ol>
<li><p>ä¿è¯å¯è§æ€§</p>
<p>è¡¨ç¤ºç”¨åˆ°è¿™ä¸ªå˜é‡æ—¶å¿…é¡»æ¯æ¬¡éƒ½é‡æ–°ä»å†…å­˜é‡Œè¯»å–è¿™ä¸ªå˜é‡çš„å€¼ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ä¿å­˜åœ¨å¯„å­˜å™¨é‡Œçš„å¤‡ä»½ã€‚ä¸»è¦ç”¨äºé˜²æ­¢ç¼–è¯‘å™¨çš„ä¸€äº›ä¼˜åŒ–ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ç¤ºä¾‹ä¸€</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> i = <span class="number">10</span>;</span><br><span class="line">	<span class="type">int</span> a = i; <span class="comment">//ä¼˜åŒ–</span></span><br><span class="line">	<span class="type">int</span> b = i;</span><br><span class="line"> </span><br><span class="line">	<span class="built_in">printf</span> (<span class="string">&quot;i = %d\n&quot;</span>, b);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//ç¤ºä¾‹äºŒ</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">volatile</span> <span class="type">int</span> i = <span class="number">10</span>;</span><br><span class="line">	<span class="type">int</span> a = i; <span class="comment">//æœªä¼˜åŒ–</span></span><br><span class="line">	<span class="type">int</span> b = i; <span class="comment">//è¿™é‡Œä¼šç»§ç»­ä»å†…å­˜é‡Œè¯»å–içš„å€¼è€Œä¸æ˜¯ç”¨ä¸Šé¢è¯»è¿‡çš„ç¼“å­˜ã€‚</span></span><br><span class="line"> </span><br><span class="line">	<span class="built_in">printf</span> (<span class="string">&quot;i = %d\n&quot;</span>, b);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
</li>
<li><p>ç¦æ­¢æŒ‡ä»¤é‡æ’ï¼ˆè²Œä¼¼åªåœ¨Javaé‡Œæœ‰è¿™ä¸ªåŠŸèƒ½ï¼‰</p>
<p>ä¿è¯volatileæ‰€ä¿®é¥°çš„å˜é‡ä¹‹å‰çš„ä»£ç ä¸ä¼šåœ¨è¯¥å˜é‡ä¹‹åæ‰§è¡Œï¼Œè¯¥å˜é‡ä¹‹åçš„ä»£ç ä¸ä¼šåœ¨è¯¥å˜é‡ä¹‹å‰æ‰§è¡Œã€‚</p>
</li>
</ol>
<p>volatileä¸èƒ½ä¿è¯åŸå­æ€§ã€‚ä»…ä½¿ç”¨ volatile ä¿®é¥° iï¼Œi++ä¹Ÿä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p>ä¸çŸ¥é“Cè¯­è¨€é‡Œçš„volatileæ˜¯å¦å’ŒJavaé‡Œçš„æ„ä¹‰ä¸€æ ·ï¼Ÿ</p>
<h3 id="TASï¼ˆTest-And-Setï¼‰"><a href="#TASï¼ˆTest-And-Setï¼‰" class="headerlink" title="TASï¼ˆTest And Setï¼‰"></a>TASï¼ˆTest And Setï¼‰</h3><p>TASæŒ‡ä»¤çš„è¯­ä¹‰æ˜¯ï¼šå‘æŸä¸ªå†…å­˜åœ°å€å†™å…¥å€¼1ï¼Œå¹¶ä¸”è¿”å›è¿™å—å†…å­˜åœ°å€å­˜çš„åŸå§‹å€¼ã€‚TASæŒ‡ä»¤æ˜¯åŸå­çš„ï¼Œè¿™æ˜¯ç”±å®ç°TASæŒ‡ä»¤çš„ç¡¬ä»¶ä¿è¯çš„ï¼ˆè¿™é‡Œçš„ç¡¬ä»¶å¯ä»¥æ˜¯CPUï¼Œä¹Ÿå¯ä»¥æ˜¯å®ç°äº†TASçš„å…¶ä»–ç¡¬ä»¶ï¼‰ã€‚</p>
<p>ä¼ªä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">testAndSet</span><span class="params">(<span class="type">bool</span> *target)</span> &#123;</span><br><span class="line">		<span class="type">bool</span> old = *target;</span><br><span class="line">		*target = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">return</span> old;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¼•ç”¨ç»´åŸºç™¾ç§‘ä¸Šçš„ä¸€æ®µè¯ï¼š</p>
<p>In <a href="https://en.wikipedia.org/wiki/Computer_science">computer science</a>, the <strong>test-and-set</strong> instruction is an instruction used to write 1 (set) to a memory location and return its old value as a single <a href="https://en.wikipedia.org/wiki/Atomic_(computer_science">atomic</a>) (i.e., non-interruptible) operation. <strong>If multiple processes may access the same memory location, and if a process is currently performing a test-and-set, no other process may begin another test-and-set until the first processâ€™s test-and-set is finished.</strong> A <a href="https://en.wikipedia.org/wiki/Central_processing_unit">CPU</a> may use a test-and-set instruction offered by another electronic component, such as <a href="https://en.wikipedia.org/wiki/DPRAM">dual-port RAM</a>; a CPU itself may also offer a test-and-set instruction.</p>
<p>è¿™æ®µè¯æ¶ˆé™¤äº†æˆ‘çš„ä¸€ä¸ªç–‘æƒ‘ï¼šå¯¹äºåŒä¸€ä¸ªå†…å­˜åœ°å€å¦‚æœæœ‰ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡Œtest-and-setæŒ‡ä»¤ï¼Œé‚£ä¹ˆå…¶ä»–çº¿ç¨‹éœ€è¦ç­‰åˆ°å®ƒæ‰§è¡Œå®Œæˆåæ‰èƒ½ç»§ç»­æ‰§è¡Œtest-and-setæŒ‡ä»¤ã€‚è¿™å¯ä»¥åœ¨ç¡¬ä»¶å±‚é¢åšåˆ°ã€‚å…·ä½“æ˜¯æ€ä¹ˆåšåˆ°çš„ä»¥åæœ‰ç©ºå¯ä»¥ç ”ç©¶ä¸€ä¸‹ã€‚</p>
<p>å› æ­¤å¯ä»¥è¯´TASå³æ˜¯åŸå­æ“ä½œä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œç”±ç¡¬ä»¶ä¿è¯ã€‚</p>
<h3 id="CASï¼ˆCompare-And-Swapï¼‰"><a href="#CASï¼ˆCompare-And-Swapï¼‰" class="headerlink" title="CASï¼ˆCompare And Swapï¼‰"></a>CASï¼ˆCompare And Swapï¼‰</h3><p>CASçš„è¯­ä¹‰æ˜¯ï¼šè®©CPUæ¯”è¾ƒæŸä¸ªå†…å­˜åœ°å€çš„å€¼ä¸ä¸€ä¸ªç»™å®šå€¼ï¼ˆ<strong>è¿™ä¸ªç»™å®šå€¼æ˜¯ä¸Šä¸€åˆ»ä»æ­¤å†…å­˜åœ°å€è¯»å‡ºæ¥çš„</strong>ï¼‰æ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸ç­‰ï¼Œåˆ™æŠŠä¸€ä¸ªæ–°å€¼å†™å…¥åˆ°æ­¤å†…å­˜åœ°å€ï¼Œå¦åˆ™ä»€ä¹ˆéƒ½ä¸åšã€‚</p>
<p>CASæ˜¯é¡¹<strong>ä¹è§‚é”</strong>æŠ€æœ¯ï¼Œå½“å¤šä¸ªçº¿ç¨‹å°è¯•ä½¿ç”¨CASåŒæ—¶æ›´æ–°åŒä¸€ä¸ªå˜é‡æ—¶ï¼Œåªæœ‰å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹èƒ½æ›´æ–°å˜é‡çš„å€¼ï¼Œè€Œå…¶å®ƒçº¿ç¨‹éƒ½å¤±è´¥ï¼Œå¤±è´¥çš„çº¿ç¨‹å¹¶ä¸ä¼šè¢«æŒ‚èµ·ï¼Œè€Œæ˜¯è¢«å‘ŠçŸ¥è¿™æ¬¡ç«äº‰ä¸­å¤±è´¥ï¼Œå¹¶å¯ä»¥å†æ¬¡å°è¯•ã€‚</p>
<p>CASæŒ‡ä»¤éœ€è¦ä¸‰ä¸ªå‚æ•°ï¼Œä¸€ä¸ªå†…å­˜åœ°å€(V)ã€ä¸€ä¸ªæœŸæœ›æ—§å€¼(E)ã€ä¸€ä¸ªæ–°å€¼(N)ã€‚</p>
<p>CASæŒ‡ä»¤çš„æ‰§è¡Œè¿‡ç¨‹ï¼š</p>
<figure class="highlight mathematica"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span>æ¯”è¾ƒå†…å­˜<span class="variable">V</span>çš„å€¼æ˜¯å¦ä¸<span class="built_in">E</span>ç›¸ç­‰ï¼Ÿ</span><br><span class="line"><span class="number">2.</span>å¦‚æœç›¸ç­‰ï¼Œåˆ™ç”¨æ–°å€¼<span class="built_in">N</span>æ›¿æ¢å†…å­˜ä½ç½®<span class="variable">V</span>çš„æ—§å€¼</span><br><span class="line"><span class="number">3.</span>å¦‚æœä¸ç›¸ç­‰ï¼Œä¸åšä»»ä½•æ“ä½œã€‚</span><br><span class="line"><span class="number">4.</span>æ— è®ºå“ªä¸ªæƒ…å†µï¼Œ<span class="variable">CAS</span>éƒ½ä¼šæŠŠå†…å­˜<span class="variable">V</span>åŸæ¥çš„å€¼è¿”å›ã€‚</span><br></pre></td></tr></table></figure>
<p>ä¼ªä»£ç ï¼š</p>
<figure class="highlight autoit"><table><tr><td class="code"><pre><span class="line"><span class="built_in">int</span> CAS(<span class="built_in">int</span> *<span class="built_in">ptr</span>,<span class="built_in">int</span> oldvalue,<span class="built_in">int</span> newvalue)</span><br><span class="line">&#123;</span><br><span class="line">   <span class="built_in">int</span> temp = *<span class="built_in">ptr</span><span class="comment">;</span></span><br><span class="line">   <span class="keyword">if</span>(temp == oldvalue)</span><br><span class="line">       *<span class="built_in">ptr</span> = newvalue<span class="comment">;</span></span><br><span class="line">   <span class="keyword">return</span> temp<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦å¤–ä¸€ç§æ˜¯è¿”å› bool ç»“æœï¼š</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">cas</span><span class="params">(<span class="type">long</span> *addr, <span class="type">long</span> old, <span class="type">long</span> <span class="keyword">new</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* Executes atomically. */</span></span><br><span class="line">    <span class="keyword">if</span>(*addr != old)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    *addr = <span class="keyword">new</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šè¿‡ç¨‹åœ¨CASæŒ‡ä»¤ä¸­æ˜¯åŸå­æ“ä½œã€‚</p>
<p>CASåº”ç”¨ç¤ºä¾‹ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">do</span>&#123;  </span><br><span class="line">   å¤‡ä»½æ—§æ•°æ®ï¼› </span><br><span class="line">   åŸºäºæ—§æ•°æ®æ„é€ æ–°æ•°æ®ï¼› </span><br><span class="line">&#125;<span class="keyword">while</span>(!<span class="built_in">CAS</span>( å†…å­˜åœ°å€ï¼Œå¤‡ä»½çš„æ—§æ•°æ®ï¼Œæ–°æ•°æ® ))  <span class="comment">//CASä¿®æ”¹å¤±è´¥åˆ™ç»§ç»­å°è¯•ï¼Œçº¿ç¨‹å¹¶ä¸ä¼šè¢«æŒ‚èµ·é˜»å¡ã€‚</span></span><br></pre></td></tr></table></figure>
<p><strong>ABA ç°è±¡</strong></p>
<p>ABA ç°è±¡æŒ‡çš„æ˜¯çº¿ç¨‹ 1 å…ˆè¯»å–äº†å˜é‡çš„å€¼ä¸ºAä½œä¸ºæœŸæœ›æ—§å€¼ï¼Œç„¶åå°†è¦æ‰§è¡Œ CAS æŒ‡ä»¤æ—¶ï¼Œå˜é‡çš„å€¼åœ¨å…¶ä»–çº¿ç¨‹å·²ç»ç”± A æ”¹ä¸º Bï¼Œåˆæ”¹å›äº† Aã€‚ä½†æ˜¯å½“çº¿ç¨‹ 1 æ‰§è¡Œ CAS æ—¶æ˜¯æ— æ³•æ„ŸçŸ¥è¿™ä¸€å˜åŒ–çš„ï¼Œå› æ­¤å®ƒåˆ¤æ–­æ˜¯ç›¸ç­‰çš„æ‰€ä»¥ä¾ç„¶æ‰§è¡ŒæˆåŠŸã€‚</p>
<p>ABA ç°è±¡ä¸ä¸€å®šå°±ä¼šå‡ºé—®é¢˜ï¼Œå–å†³äºå…·ä½“çš„åœºæ™¯ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ ABA ç°è±¡å°±ä¼šå˜æˆ ABA é—®é¢˜ã€‚</p>
<p>è§£å†³çš„åŠæ³•å°±æ˜¯åœ¨å˜é‡å‰é¢åŠ ä¸Šç‰ˆæœ¬å·ï¼Œæ¯æ¬¡å˜é‡æ›´æ–°çš„æ—¶å€™å˜é‡çš„<strong>ç‰ˆæœ¬å·éƒ½<code>+1</code></strong>ï¼Œå³<code>A-&gt;B-&gt;A</code>å°±å˜æˆäº†<code>1A-&gt;2B-&gt;3A</code>ã€‚æ·»åŠ äº†ç‰ˆæœ¬å·åçº¿ç¨‹ 1 è¯»å–åˆ°çš„ E å°†æ˜¯ 1Aï¼Œè€Œå½“å®ƒæ‰§è¡Œ CAS æ—¶é‡æ–°è·å–å˜é‡çš„å€¼å°†ä¸º 3Aï¼Œäºæ˜¯ä¸ç›¸ç­‰ï¼ŒCAS å°†æ‰§è¡Œå¤±è´¥ã€‚</p>
<p>ä¾‹å­ï¼š<a href="https://blog.csdn.net/WSYW126/article/details/53979918">AtomicIntegerã€Unsafeç±»ã€ABAé—®é¢˜</a></p>
<p><strong>ç–‘é—®</strong></p>
<p>Q1ï¼šçº¿ç¨‹ 1 å°†è¦æ‰§è¡Œ CAS(v, 1, 2)ï¼Œçº¿ç¨‹ 2 å°†è¦æ‰§è¡Œ CAS(v, 1, 2)ï¼Œå¯¹äºå¤šæ ¸ CPU ä¼šä¸ä¼šåŒæ—¶æ‰§è¡Œè¿™ä¸¤æ¡CAS æŒ‡ä»¤ï¼Ÿ</p>
<p>ä¸ªäººè§‰å¾—å¯¹äºåŒä¸€å˜é‡çš„ CAS æŒ‡ä»¤ï¼ŒåŒä¸€æ—¶åˆ»CPUåªä¼šæ‰§è¡Œå…¶ä¸­ä¸€æ¡ CAS æ“ä½œã€‚æ‰§è¡Œå®Œå…¶ä¸­ä¸€æ¡åæ‰ä¼šç»§ç»­æ‰§è¡Œä¸‹ä¸€æ¡ã€‚è¦ä¸ç„¶ä¸€æ ·å¯¼è‡´ç»“æœä¸ç¬¦åˆé¢„æœŸï¼Œçº¿ç¨‹ä¸å®‰å…¨ã€‚</p>
<p>Q2ï¼šåŸå­æŒ‡ä»¤æ˜¯å¦å…·æœ‰æ’ä»–æ€§ï¼Ÿæ¯”å¦‚çº¿ç¨‹1æ­£åœ¨å¯¹æŸä¸ªå˜é‡æ‰§è¡ŒåŸå­æ“ä½œï¼Œé‚£ä¹ˆçº¿ç¨‹2èƒ½ä¸èƒ½åŒæ—¶ä¹Ÿå¯¹è¿™ä¸ªå˜é‡æ‰§è¡Œè¯¥åŸå­æ“ä½œï¼Ÿçº¿ç¨‹2èƒ½ä¸èƒ½åŒæ—¶æ‰§è¡Œè¯¥å˜é‡çš„å…¶ä»–åŸå­æ“ä½œï¼Ÿ</p>
<p>ä¸å¤ªç¡®å®šçš„ç»“è®ºï¼šåŒä¸€ä¸ªåŸå­æ“ä½œä¼šæ’ä»–ï¼Œä¸åŒåŸå­æ“ä½œä¸ä¼šã€‚</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line">çº¿ç¨‹<span class="number">1</span>ï¼š<span class="built_in">TAS</span>(v)</span><br><span class="line">çº¿ç¨‹<span class="number">2</span>ï¼š<span class="built_in">CAS</span>(v, <span class="number">0</span>, <span class="number">3</span>)</span><br><span class="line">çº¿ç¨‹<span class="number">1</span>è¿˜æ²¡æœ‰å†™å…¥<span class="number">1</span>æ—¶ï¼Œçº¿ç¨‹<span class="number">2</span>æ¯”è¾ƒå‘ç°ç›¸ç­‰å†™å…¥äº†<span class="number">3</span>ï¼Œçº¿ç¨‹<span class="number">1</span>ç»§ç»­æ‰§è¡Œå†™å…¥äº†<span class="number">1</span>.é‚£ä¹ˆvæœ€ç»ˆæ˜¯<span class="number">1</span>ï¼Ÿ</span><br></pre></td></tr></table></figure>
<p>Q3ï¼šåœ¨æ‰§è¡Œç±»ä¼¼CASè¿™ç§å¤æ‚åŸå­æŒ‡ä»¤æœŸé—´ï¼Œå…¶ä»–çº¿ç¨‹èƒ½ä¸èƒ½è¯»å†™è¯¥å˜é‡çš„å†…å­˜ï¼Ÿ</p>
<p>ä¸å¤ªç¡®å®šçš„ç»“è®ºï¼šè²Œä¼¼å¯ä»¥ã€‚å¯èƒ½ä¸Šé¢çš„ç»“è®ºæ˜¯é”™è¯¯ï¼Œæ²¡æŸ¥åˆ°èµ„æ–™ï¼Œä¹Ÿå¯èƒ½æ˜¯ï¼šåœ¨æ‰§è¡ŒåŸå­æŒ‡ä»¤æ—¶ï¼Œå…¶ä»–çº¿ç¨‹ä¸èƒ½è®¿é—®è¯¥å˜é‡çš„å†…å­˜ã€‚</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">çº¿ç¨‹<span class="number">1</span>ï¼š<span class="built_in">fetch_and_add</span>(<span class="attribute">x</span>, <span class="number">1</span>)</span><br><span class="line">çº¿ç¨‹<span class="number">2</span>ï¼š<span class="attribute">x</span> = <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>Qï¼šä¸€æ¡æ±‡ç¼–æŒ‡ä»¤èƒ½ä¸èƒ½è¢«å¤šæ ¸ CPU åŒæ—¶æ‰§è¡Œï¼Ÿ</p>
<p>å¯ä»¥ã€‚ä½†å¦‚æœé”å†…å­˜æ€»çº¿åï¼Œå°±å¯ä»¥ä¿è¯åŒæ—¶åªæœ‰ä¸€ä¸ªæ ¸æ¥æ‰§è¡Œè¯¥æŒ‡ä»¤ï¼Œä»è€Œé¿å…äº†å¤šæ ¸ä¸‹å‘ç”Ÿçš„é—®é¢˜ã€‚</p>
<p>ä¸Šé¢çš„ç»“è®ºæœ‰äº›å¯èƒ½æ˜¯é”™è¯¯çš„ï¼ŒçŸ¥é“çš„è€é“å¯ä»¥ç•™è¨€æŒ‡æ˜ä¸€ä¸‹ã€‚</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://bitdewy.github.io/blog/2013/09/02/atomic-operation/">C++11ä¸­çš„åŸå­æ“ä½œ (Atomic Operation)</a>  åªè®²äº†ä½¿ç”¨æ²¡æœ‰è®²åŸç†ã€‚</p>
<p><a href="https://juejin.im/post/5ce8f2a86fb9a07ee062f298">é”çš„ç¡¬ä»¶å®ç°</a></p>
<p><a href="https://steemit.com/cn/@cifer/c-volatile">å¦‚ä½•ä½¿ç”¨ C è¯­è¨€ä¸­çš„ volatile å…³é”®å­—?</a>  åç¡¬ä»¶å±‚é¢å¯¹ volatile çš„è§£é‡Š</p>
<p><a href="https://en.wikipedia.org/wiki/Test-and-set">Test-and-set</a>  Test-and-setç»´åŸºç™¾ç§‘ä»‹ç»</p>
<p>CAS ç›¸å…³ï¼š</p>
<p><a href="https://juejin.im/post/5c87afa06fb9a049f1550b04">CASåŸç†åˆ†æåŠABAé—®é¢˜è¯¦è§£</a>  </p>
<p><a href="https://blog.csdn.net/WSYW126/article/details/53979918">AtomicIntegerã€Unsafeç±»ã€ABAé—®é¢˜</a></p>
<p><a href="https://www.jianshu.com/p/fb6e91b013cc">æ·±å…¥æµ…å‡ºCAS</a></p>
<p><a href="https://blog.csdn.net/a7980718/article/details/82860505">CASæ“ä½œåœ¨ARMå’Œx86ä¸‹çš„ä¸åŒå®ç°</a>  ç¡¬ä»¶æ±‡ç¼–å±‚é¢åˆ†æ</p>
<p><a href="https://infilos.com/reading/RD02-VM/Dive-Into-Jvm/CH13.html">CH13-çº¿ç¨‹å®‰å…¨ä¸é”ä¼˜åŒ–</a>  ä¸€æœ¬ä¹¦ï¼Œè¿˜ä¸é”™ã€‚</p>
<p><a href="https://blog.codingnow.com/2007/12/fence_in_multi_core.html">å¤šæ ¸ç¯å¢ƒä¸‹çš„å†…å­˜å±éšœæŒ‡ä»¤</a></p>
<p><a href="https://yemablog.com/posts/cache-locking">x86 cache locking çš„çŒœæƒ³</a></p>
]]></content>
      <categories>
        <category>å¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>TAS</tag>
      </tags>
  </entry>
  <entry>
    <title>iOS synchronizedå®ç°åŸç†</title>
    <url>/2021/08/01/iOS%20synchronized%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<p>æºç ç‰ˆæœ¬ï¼šobjc4-781</p>
<h4 id="synchronizedä»‹ç»"><a href="#synchronizedä»‹ç»" class="headerlink" title="@synchronizedä»‹ç»"></a>@synchronizedä»‹ç»</h4><p><code>@synchronized</code> æ‰€åšçš„äº‹æƒ…è·Ÿé”ï¼ˆlockï¼‰ä¸€æ ·ï¼šå®ƒé˜²æ­¢ä¸åŒçš„çº¿ç¨‹åŒæ—¶æ‰§è¡ŒåŒä¸€æ®µä»£ç ã€‚ä½†ç›¸æ¯”äºä½¿ç”¨ <code>NSLock</code> åˆ›å»ºé”å¯¹è±¡ã€åŠ é”å’Œè§£é”æ¥è¯´ï¼Œ<code>@synchronized</code> ç”¨ç€æ›´æ–¹ä¾¿ï¼Œå¯è¯»æ€§æ›´é«˜ã€‚</p>
<p><code>@synchronized</code>æ˜¯å¯¹<code>mutex</code>é€’å½’é”çš„å°è£…ï¼Œ <code>@synchronized(obj)</code>å†…éƒ¨ä¼šæ ¹æ®ä¼ å…¥çš„åŒæ­¥å¯¹è±¡objå¾—åˆ°ä¸€æŠŠé€’å½’é”ï¼Œç„¶åè¿›è¡ŒåŠ é”ã€è§£é”æ“ä½œã€‚</p>
<p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)increment</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">@synchronized</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        [_elements addObject:element];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°synchronizedçš„ä½¿ç”¨æ˜¯éå¸¸ç®€å•çš„ã€‚</p>
<p>å…³äºsynchronizedæœ‰å‡ ä¸ªé‡è¦é—®é¢˜ï¼Ÿ</p>
<p>1.é”æ˜¯å¦‚ä½•ä¸ä½ ä¼ å…¥ <code>@synchronized</code> çš„å¯¹è±¡å…³è”ä¸Šçš„ï¼Ÿ</p>
<p>2.<code>@synchronized</code>ä¼šä¿æŒï¼ˆretainï¼Œå¢åŠ å¼•ç”¨è®¡æ•°ï¼‰è¢«é”ä½çš„å¯¹è±¡ä¹ˆï¼Ÿ</p>
<p>3.å‡å¦‚ä½ ä¼ å…¥ <code>@synchronized</code> çš„å¯¹è±¡åœ¨ <code>@synchronized</code> çš„ä»£ç å—é‡Œé¢è¢«èµ‹å€¼ä¸º <code>nil</code> å°†ä¼šæ€ä¹ˆæ ·ï¼Ÿ</p>
<p>4.ç»™<code>@synchronized</code>ä¼ å…¥nilä¼šæ€æ ·ï¼Ÿ</p>
<h4 id="åŸç†æ¢ç©¶"><a href="#åŸç†æ¢ç©¶" class="headerlink" title="åŸç†æ¢ç©¶"></a>åŸç†æ¢ç©¶</h4><p>å¯¹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> * argv[])</span> &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        NSObject *obj = [NSObject new];</span><br><span class="line">        @synchronized (obj) &#123;</span><br><span class="line">            NSLog(@<span class="string">&quot;obj is @synchronized&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>clang -rewrite-objc main.m</code>  å¾—åˆ°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* @autoreleasepool */</span></span><br><span class="line">    &#123;</span><br><span class="line">        __AtAutoreleasePool __autoreleasepool;</span><br><span class="line">        NSObject *obj = ((NSObject *(*)(id, SEL))(<span class="type">void</span> *)objc_msgSend)((id)<span class="built_in">objc_getClass</span>(<span class="string">&quot;NSObject&quot;</span>), <span class="built_in">sel_registerName</span>(<span class="string">&quot;new&quot;</span>));</span><br><span class="line">        &#123;</span><br><span class="line">            id _rethrow = <span class="number">0</span>; </span><br><span class="line">          	id _sync_obj = (id)obj; </span><br><span class="line">          	<span class="built_in">objc_sync_enter</span>(_sync_obj);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">struct</span> <span class="title class_">_SYNC_EXIT</span> &#123;</span><br><span class="line">                    _SYNC_EXIT(id arg) : <span class="built_in">sync_exit</span>(arg) &#123;&#125;</span><br><span class="line">                    ~_SYNC_EXIT() &#123;<span class="built_in">objc_sync_exit</span>(sync_exit);&#125;</span><br><span class="line">                    id sync_exit;</span><br><span class="line">                &#125; _sync_exit(_sync_obj);</span><br><span class="line"></span><br><span class="line">                <span class="built_in">NSLog</span>((NSString *)&amp;__NSConstantStringImpl__var_folders_5z_1pxqzfcn77s2n7z4gmr63sdr0000gn_T_main_4eec76_mi_0);</span><br><span class="line">            &#125; <span class="built_in">catch</span> (id e) &#123;</span><br><span class="line">              _rethrow = e;</span><br><span class="line">            &#125;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">struct</span> <span class="title class_">_FIN</span> &#123;</span><br><span class="line">                    _FIN(id reth) : <span class="built_in">rethrow</span>(reth) &#123;&#125;</span><br><span class="line">                    ~_FIN() &#123; <span class="keyword">if</span> (rethrow) <span class="built_in">objc_exception_throw</span>(rethrow); &#125;</span><br><span class="line">                    id rethrow;</span><br><span class="line">                &#125; _fin_force_rethow(_rethrow);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡º <code>@synchronized (obj)</code> çš„å·¥ä½œæµç¨‹ï¼š</p>
<p>1.æ–°å»ºä¸€ä¸ªä½œç”¨åŸŸå°†åŒæ­¥ä»£ç å—åŒ…è£¹åœ¨å†…ã€‚</p>
<p>2.å°†ä¼ å…¥çš„åŒæ­¥å¯¹è±¡èµ‹å€¼ç»™ä¸€ä¸ªä¸´æ—¶å˜é‡<code>id _sync_obj = (id)obj;</code>ï¼Œåç»­çš„æ“ä½œä½¿ç”¨çš„éƒ½æ˜¯è¯¥ä¸´æ—¶å˜é‡ã€‚ å› æ­¤ä»¥å‰çš„å˜é‡çš„å€¼å‘ç”Ÿæ›´æ”¹å¯¹æœ¬æ¬¡åŠ è§£é”ä¸ä¼šäº§ç”Ÿå½±å“ï¼Œä½†æ˜¯å½“ä¸‹ä¸€æ¬¡å…¶ä»–çº¿ç¨‹æ‰§è¡Œåˆ°@synchronizedæ—¶ç”±äºåŒæ­¥å¯¹è±¡å·²ç»å‘ç”Ÿæ”¹å˜å› æ­¤è·å–åˆ°çš„å°†ä¸æ˜¯åŒä¸€æŠŠé”äºæ˜¯å…¶ä»–çº¿ç¨‹æ­¤æ—¶ä¹Ÿèƒ½å¤Ÿè¿›å…¥ä¸´ç•ŒåŒºï¼Œè¿™æ ·å°±æœ‰å¯èƒ½ä¸´ç•ŒåŒºåŒä¸€æ—¶åˆ»æœ‰å¤šä¸ªçº¿ç¨‹åœ¨è®¿é—®ï¼Œä»è€Œé€ æˆå¤šçº¿ç¨‹é—®é¢˜ã€‚å› æ­¤ä½¿ç”¨synchronizedæ—¶éœ€è¦ä¿è¯æŒ‡å‘åŒæ­¥å¯¹è±¡çš„å˜é‡çš„å€¼ä¸è¢«æ›´æ”¹ï¼ŒåŒæ­¥å¯¹è±¡è‡ªèº«çš„ç”Ÿå‘½å‘¨æœŸæœ€å¥½ä¹Ÿä¸èƒ½å¤ªçŸ­ã€‚</p>
<p>3.è°ƒç”¨objc_sync_enterå‡½æ•°åŠ é”ï¼Œobjc_sync_enter(_sync_obj);    </p>
<p>4.å¯¹åŒæ­¥ä»£ç å—è¿›è¡Œtry-catchï¼Œtryä½œç”¨åŸŸç»“æŸæ—¶ï¼Œè°ƒç”¨objc_sync_exit(sync_exit)è§£é”;</p>
<p>5.åŒæ­¥ä»£ç å—ä¸­å¦‚æœå‡ºç°å¼‚å¸¸ï¼Œåˆ™åœ¨ä½œç”¨åŸŸç»“æŸæ—¶é‡æ–°æŠ›å‡ºã€‚</p>
<p>ä¸çŸ¥é“å¤§å®¶æ³¨æ„åˆ°æ²¡æœ‰<code>objc_sync_exit(sync_exit);</code>å¹¶ä¸æ˜¯åœ¨ä»€ä¹ˆ@finallyé‡Œé¢è°ƒç”¨çš„ï¼Œè€Œæ˜¯<code>_sync_exit</code>å®ä¾‹é”€æ¯æ—¶åœ¨è‡ªèº«ææ„å‡½æ•°é‡Œè°ƒç”¨çš„ã€‚éš¾é“å®ƒå°±ä¸æ€•tryé‡Œé¢å‘ç”Ÿå´©æºƒå—ï¼Ÿå¦‚æœtryé‡Œé¢å‘ç”Ÿå´©æºƒé‚£ä¹ˆ_sync_exitå®ä¾‹å°†ä¸ä¼šé”€æ¯ï¼Œææ„å‡½æ•°ä¹Ÿä¸ä¼šæ‰§è¡Œè‡ªç„¶objc_sync_exitä¹Ÿä¸ä¼šè°ƒç”¨ï¼Œé‚£ä¹ˆåŠ è§£é”æ¬¡æ•°å°±ä¸ä¸€è‡´äº†ï¼Œå…¶ä»–çº¿ç¨‹å°†æ°¸è¿œè·å–ä¸åˆ°é”äº†ã€‚è¿™ç§æƒ…å†µå¦‚æœåœ¨OCæ–‡ä»¶ä»£ç é‡Œé»˜è®¤æƒ…å†µä¸‹ç¡®å®ä¼šè¿™æ ·ï¼Œä½†æ˜¯åœ¨C++é‡Œç¼–è¯‘å™¨ä¼šäº§ç”Ÿä¸€äº›ä»£ç ç¡®ä¿å³ä½¿tryé‡Œå‘ç”Ÿå´©æºƒï¼Œtryé‡Œçš„ä¸´æ—¶å¯¹è±¡ä¹Ÿä¼šè¢«é”€æ¯ã€‚æ‰€ä»¥ä¸ä¼šå‡ºç°ä¸Šè¿°æƒ…å†µã€‚</p>
<p>è¿™æ ·tryé‡Œé¢å³ä½¿å‘ç”Ÿå´©æºƒï¼Œ<code>_sync_exit</code>å®ä¾‹ä¹Ÿä¼šæ‰§è¡Œææ„å‡½æ•°ï¼Œä»è€Œè°ƒç”¨<code>objc_sync_exit(sync_exit);</code>è¿›è¡Œè§£é”ã€‚å¦å¤–éœ€è¦æ³¨æ„çš„ä¸€ç‚¹ï¼Œç”±äºå¼‚å¸¸ä¼šè¢«é‡æ–°æŠ›å‡ºï¼Œæ‰€ä»¥å½“ä»£ç å—é‡Œé¢çœŸçš„ä¼šå´©æºƒæ—¶ï¼Œè¿˜æ˜¯éœ€è¦æˆ‘ä»¬è‡ªå·±try-catchçš„ã€‚</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯objc_sync_enterå’Œobjc_sync_exitä¸¤ä¸ªå‡½æ•°äº†ã€‚å‰é¢æˆ‘ä»¬å¤§æ¦‚ä¹ŸçŸ¥é“äº†objc_sync_enterå¯¹åº”ç€åŠ é”ï¼Œobjc_sync_exitå¯¹åº”ç€è§£é”ï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶ä¸çŸ¥é“é”æ˜¯æ€ä¹ˆå¾—æ¥çš„å’Œä¼ å…¥çš„åŒæ­¥å¯¹è±¡åˆæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿæƒ³çŸ¥é“è¿™ä¸€åˆ‡çš„è¯å°±å¾—æ·±å…¥objc_sync_enter/exitçš„å®ç°äº†ã€‚</p>
<h4 id="objc-sync-enter"><a href="#objc-sync-enter" class="headerlink" title="objc_sync_enter"></a>objc_sync_enter</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Begin synchronizing on &#x27;obj&#x27;. </span></span><br><span class="line"><span class="comment">// Allocates recursive mutex associated with &#x27;obj&#x27; if needed.</span></span><br><span class="line"><span class="comment">// Returns OBJC_SYNC_SUCCESS once lock is acquired.  </span></span><br><span class="line"><span class="type">int</span> <span class="title function_">objc_sync_enter</span><span class="params">(id obj)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> result = OBJC_SYNC_SUCCESS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (obj) &#123;</span><br><span class="line">        SyncData* data = id2data(obj, ACQUIRE);</span><br><span class="line">        ASSERT(data);</span><br><span class="line">        data-&gt;mutex.lock();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// @synchronized(nil) does nothing</span></span><br><span class="line">        <span class="keyword">if</span> (DebugNilSync) &#123;</span><br><span class="line">            _objc_inform(<span class="string">&quot;NIL SYNC DEBUG: @synchronized(nil); set a breakpoint on objc_sync_nil to debug&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        objc_sync_nil();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>objc_sync_enterçš„ä½œç”¨ï¼š</p>
<p>å¦‚æœobjä¸ç­‰äºnilï¼Œåˆ™æ ¹æ®ä¼ å…¥çš„objæ‰¾åˆ°ä¸€ä¸ªSyncDataï¼ŒSyncDataä¸­æœ‰ä¸€æŠŠé€’å½’é”ï¼Œç„¶ååŠ é”ã€‚</p>
<p>å¦‚æœobjç­‰äºnilï¼Œåˆ™æ‰§è¡Œ<code>objc_sync_nilï¼›</code>ã€‚å…¶å®å°±æ˜¯ä»€ä¹ˆä¹Ÿä¸åšç›´æ¥è¿”å›OBJC_SYNC_SUCCESSï¼Œæ­¤æ—¶ä»£ç å—å°±æ²¡æœ‰è¿›è¡ŒåŠ é”ä¿æŠ¤ã€‚</p>
<p>objc_sync_nilå®ç°ï¼š</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">BREAKPOINT_FUNCTION(</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">objc_sync_nil</span>(<span class="params"><span class="keyword">void</span></span>)</span></span><br><span class="line"><span class="function">)</span>;</span><br></pre></td></tr></table></figure>
<p>å®BREAKPOINT_FUNCTIONçš„å®šä¹‰ï¼š</p>
<figure class="highlight elm"><table><tr><td class="code"><pre><span class="line">#   define <span class="type">BREAKPOINT_FUNCTION</span>(proto<span class="keyword">type</span>)                             \</span><br><span class="line">    <span class="type">OBJC_EXTERN</span> __attribute__((noinline, used, visibility(<span class="string">&quot;hidden&quot;</span>))) \</span><br><span class="line">    proto<span class="keyword">type</span> &#123; asm(&quot;&quot;); &#125;</span><br></pre></td></tr></table></figure>
<p>å±•å¼€åç­‰ä»·äºï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extern</span> __attribute__((noinline, used, visibility(<span class="string">&quot;hidden&quot;</span>))) </span><br><span class="line"><span class="type">void</span> <span class="title function_">objc_sync_nil</span><span class="params">(<span class="type">void</span>)</span> &#123; 		 		</span><br><span class="line">  <span class="keyword">asm</span>(<span class="string">&quot;&quot;</span>); </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å®BREAKPOINT_FUNCTIONçš„ä½œç”¨å°±æ˜¯å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°åªæœ‰ä¸€è¡Œå®ç°<code>asm(&quot;&quot;);</code>ï¼Œä»BREAKPOINT_FUNCTIONè¯­ä¹‰ä¸Šä¹Ÿå¯ä»¥æ˜ç™½å®šä¹‰çš„å‡½æ•°åªæ˜¯ç”¨æ¥æ‰“æ–­ç‚¹çš„ã€‚æ²¡æœ‰ä»€ä¹ˆå®é™…ç”¨é€”ã€‚</p>
<p>å…·ä½“æ˜¯å¦‚ä½•æ ¹æ®objè·å–é”çš„ï¼Œè¿˜å¾—çœ‹id2data()å‡½æ•°çš„å®ç°ï¼š</p>
<h4 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h4><h5 id="SyncData"><a href="#SyncData" class="headerlink" title="SyncData"></a>SyncData</h5><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Allocate a lock only when needed.  Since few locks are needed at any point</span></span><br><span class="line"><span class="comment">// in time, keep them on a single list.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title function_">alignas</span><span class="params">(CacheLineSize)</span> SyncData &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">SyncData</span>* <span class="title">nextData</span>;</span></span><br><span class="line">    DisguisedPtr&lt;objc_object&gt; object;</span><br><span class="line">    <span class="type">int32_t</span> threadCount;  <span class="comment">// number of THREADS using this blockã€‚åªä¼šæ˜¯0å’Œ1ã€‚0ä»£è¡¨ç©ºé—²ï¼ŒSyncDataå¯è¢«å¤ç”¨</span></span><br><span class="line">    <span class="type">recursive_mutex_t</span> mutex;</span><br><span class="line">&#125; SyncData;</span><br></pre></td></tr></table></figure>
<p>nextDataï¼šæŒ‡å‘ä¸‹ä¸€ä¸ªSyncDataï¼Œå› æ­¤SyncDataæ˜¯ä¸€ä¸ªå•é“¾è¡¨ã€‚</p>
<p>objectï¼šä¼ å…¥çš„åŒæ­¥å¯¹è±¡ï¼ŒDisguisedPtr<objc_object>ç±»å‹ï¼Œå…¶å®å°±æ˜¯è®°å½•å¯¹è±¡çš„åœ°å€</p>
<p>threadCountï¼šä½¿ç”¨è¯¥blockçš„çº¿ç¨‹æ•°ï¼Œè¯¥è®¡æ•°å™¨ä½œç”¨ï¼š</p>
<p>1ç”¨äºå®‰å…¨åˆ¤æ–­</p>
<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">if</span> (result-&gt;</span><span class="function"><span class="title">threadCount</span> &lt;= 0  ||  item-&gt;</span>lockCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    _objc_fatal(<span class="string">&quot;id2data cache is buggy&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2 å¦‚æœç­‰äº0ï¼Œè¯´æ˜mutexå¤„äºç©ºé—²çŠ¶æ€ï¼Œé‚£ä¹ˆSyncDataå°±å¯ä»¥å¤ç”¨äº†ï¼Œå¤ç”¨æ—¶ object å±æ€§å¯ä»¥èµ‹å€¼å…¶ä»–å¯¹è±¡ï¼Œä¹Ÿå°±é¿å…äº†åˆ›å»ºSyncDataçš„å¼€é”€ã€‚</p>
<p>mutexï¼šåˆ†é…çš„é€’å½’é”ï¼Œç”¨äºåŠ è§£é”ã€‚</p>
<p>ä¸ºäº†èƒ½å¤Ÿæ›´é«˜æ•ˆçš„æ ¹æ®åŒæ­¥å¯¹è±¡è·å¾—ä¸€æŠŠé”ï¼Œç³»ç»Ÿåšäº†ç¼“å­˜ã€‚</p>
<h5 id="SyncCacheItem"><a href="#SyncCacheItem" class="headerlink" title="SyncCacheItem"></a>SyncCacheItem</h5><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    SyncData *data;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> lockCount;  <span class="comment">// number of times THIS THREAD locked this block</span></span><br><span class="line">&#125; SyncCacheItem;</span><br></pre></td></tr></table></figure>
<p>dataï¼šSyncDataå¯¹è±¡</p>
<p>lockCountï¼šå½“å‰çº¿ç¨‹é”ä½è¯¥blockï¼ˆblockåº”è¯¥æŒ‡çš„æ˜¯åŒæ­¥ä»£ç å—ï¼‰çš„æ¬¡æ•°ã€‚å¤–éƒ¨éœ€è¦æ ¹æ®å®ƒæ¥æ¸…é™¤ç¼“å­˜ï¼ŒåŠ é”æ—¶è®¡æ•°å™¨åŠ 1ï¼Œè§£é”æ—¶è®¡æ•°å™¨å‡1ã€‚å‡åˆ°0æ—¶ï¼ŒFastCacheå°±ä¼šå°†ä¿å­˜çš„SyncDataå¯¹è±¡æ¸…é™¤ã€‚è™½ç„¶é€’å½’é”å†…éƒ¨ä¹Ÿæœ‰ä¸ªè®¡æ•°å™¨ä½†æ˜¯ç”±äºå¤–éƒ¨ä¸èƒ½è®¿é—®åˆ°ï¼Œæ‰€ä»¥SyncCacheItemè¿™é‡Œä¸å¾—ä¸å®šä¹‰ä¸€ä¸ªlockCountã€‚</p>
<p>ä¸ºä½•è¦ç»´æŠ¤lockCountå’ŒthreadCountï¼Œç”¨å…¶ä¸­ä¸€ä¸ªä¸è¡Œå—ï¼Ÿä¸ªäººè®¤ä¸ºå› ä¸ºæ“ä½œthreadCountéœ€è¦åŠ é”ï¼Œè€Œæ“ä½œlockCountåªä¼šåœ¨å•ä¸€çº¿ç¨‹æ‰€ä»¥ç»´æŠ¤ä¸¤ä¸ªå˜é‡å¯ä»¥æé«˜æ€§èƒ½ã€‚</p>
<h5 id="SyncCache"><a href="#SyncCache" class="headerlink" title="SyncCache"></a>SyncCache</h5><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">SyncCache</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> allocated;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> used;</span><br><span class="line">    SyncCacheItem <span class="built_in">list</span>[<span class="number">0</span>]; <span class="comment">//æ•°ç»„ï¼Œé»˜è®¤ä¸ªæ•°æ˜¯4ä¸ª</span></span><br><span class="line">&#125; SyncCache;</span><br></pre></td></tr></table></figure>
<p>å­˜å‚¨äºTLS(çº¿ç¨‹æœ¬åœ°å­˜å‚¨)ã€‚</p>
<p>allocatedï¼šåˆ†é…çš„SyncCacheItemå†…å­˜ç©ºé—´ä¸ªæ•°ï¼Œé»˜è®¤æ˜¯4ä¸ªã€‚å½“used==allocatedæ—¶ï¼Œä¼šæ‰©å®¹ä¸ºåŸæ¥çš„2å€ã€‚</p>
<p>usedï¼šå·²ä½¿ç”¨çš„SyncCacheItemå†…å­˜ç©ºé—´ä¸ªæ•°</p>
<p>listï¼šæ•°ç»„ï¼Œä¿å­˜å·²ä½¿ç”¨çš„SyncCacheItem</p>
<h5 id="SyncList"><a href="#SyncList" class="headerlink" title="SyncList"></a>SyncList</h5><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SyncList</span> &#123;</span></span><br><span class="line">    SyncData *data;</span><br><span class="line">    <span class="type">spinlock_t</span> lock;</span><br><span class="line"></span><br><span class="line">    <span class="type">constexpr</span> <span class="title function_">SyncList</span><span class="params">()</span> : <span class="title function_">data</span><span class="params">(nil)</span>, <span class="title function_">lock</span><span class="params">(fork_unsafe_lock)</span> &#123; &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>åŒ…è£¹äº†ä¸€ä¸ªé“¾è¡¨å’Œè‡ªæ—‹é”ï¼Œç”¨äºå¤„ç†å¤šçº¿ç¨‹æ“ä½œé“¾è¡¨ã€‚</p>
<h5 id="StripedMap-lt-SyncList-gt"><a href="#StripedMap-lt-SyncList-gt" class="headerlink" title="StripedMap&lt;SyncList&gt;"></a>StripedMap<code>&lt;SyncList&gt;</code></h5><p>å¦å¤–è¿˜æœ‰ä¸€ä¸ªç±»å‹ä¸ºStripedMapçš„å…¨å±€å˜é‡sDataListsï¼ŒStripedMapé‡Œé¢æœ‰ä¸€ä¸ªæ•°ç»„æ€»é•¿åº¦ä¸º8ï¼ˆiPhoneï¼‰ï¼Œæ•°ç»„çš„å…ƒç´ æ˜¯SyncListã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Use multiple parallel lists to decrease contention among unrelated objects.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOCK_FOR_OBJ(obj) sDataLists[obj].lock</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LIST_FOR_OBJ(obj) sDataLists[obj].data</span></span><br><span class="line"><span class="type">static</span> StripedMap&lt;SyncList&gt; sDataLists; <span class="comment">//æ˜¯åœ¨å“ªé‡Œåˆå§‹åŒ–çš„ï¼Ÿ</span></span><br></pre></td></tr></table></figure>
<p>LOCK_FOR_OBJ(object)å’ŒLIST_FOR_OBJ(object)å°±æ˜¯ä»å…¨å±€StripedMapå˜é‡sDataListsçš„æ•°ç»„å±æ€§ä¸­æ‰¾åˆ°ä¸€ä¸ªSyncListã€‚</p>
<p>StripedMapçš„éƒ¨åˆ†å®šä¹‰ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// StripedMap&lt;T&gt; is a map of void* -&gt; T, sized appropriately </span></span><br><span class="line"><span class="comment">// for cache-friendly lock striping. </span></span><br><span class="line"><span class="comment">// For example, this may be used as StripedMap&lt;spinlock_t&gt;</span></span><br><span class="line"><span class="comment">// or as StripedMap&lt;SomeStruct&gt; where SomeStruct stores a spin lock.</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StripedMap</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> TARGET_OS_IPHONE &amp;&amp; !TARGET_OS_SIMULATOR</span></span><br><span class="line">    <span class="keyword">enum</span> &#123; StripeCount = <span class="number">8</span> &#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="keyword">enum</span> &#123; StripeCount = <span class="number">64</span> &#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">PaddedT</span> &#123;</span><br><span class="line">        <span class="function">T value <span class="title">alignas</span><span class="params">(CacheLineSize)</span></span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    PaddedT array[StripeCount];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">int</span> <span class="title">indexForPointer</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *p)</span> </span>&#123;</span><br><span class="line">        <span class="type">uintptr_t</span> addr = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uintptr_t</span>&gt;(p);</span><br><span class="line">        <span class="keyword">return</span> ((addr &gt;&gt; <span class="number">4</span>) ^ (addr &gt;&gt; <span class="number">9</span>)) % StripeCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">    T&amp; <span class="keyword">operator</span>[] (<span class="type">const</span> <span class="type">void</span> *p) &#123; </span><br><span class="line">        <span class="keyword">return</span> array[<span class="built_in">indexForPointer</span>(p)].value; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> T&amp; <span class="keyword">operator</span>[] (<span class="type">const</span> <span class="type">void</span> *p) <span class="type">const</span> &#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">const_cast</span>&lt;StripedMap&lt;T&gt;&gt;(<span class="keyword">this</span>)[p]; </span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>StripedMapé‡Œå®šä¹‰äº†ä¸€ä¸ªæ€»é•¿åº¦ä¸º8çš„æ•°ç»„<code>PaddedT array[StripeCount];</code></p>
<p>å¦‚ä½•æ ¹æ®objectæŸ¥æ‰¾åˆ°ä¸€ä¸ªSyncListå‘¢ï¼Ÿ</p>
<p>å…¶å®å°±æ˜¯æŠŠobjectå¯¹è±¡çš„åœ°å€æ˜ å°„ä¸ºä¸€ä¸ªæ•°ç»„ç´¢å¼•ï¼Œç„¶åä»ç´¢å¼•å¤„è·å–ä¸€ä¸ªSyncListã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">indexForPointer</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *p)</span> &#123;</span><br><span class="line">    <span class="type">uintptr_t</span> addr = reinterpret_cast&lt;<span class="type">uintptr_t</span>&gt;(p);</span><br><span class="line">    <span class="keyword">return</span> ((addr &gt;&gt; <span class="number">4</span>) ^ (addr &gt;&gt; <span class="number">9</span>)) % StripeCount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ°å€å³ç§»å››ä½çš„ç»“æœ æŒ‰ä½å¼‚æˆ– åœ°å€å³ç§»ä¹ä½çš„ç»“æœ å†æ¨¡ä¸Šæ•°ç»„æ€»é•¿åº¦ã€‚è¿™æ ·å¤„ç†åä¸åŒåœ°å€å¾—åˆ°ç›¸åŒçš„ç»“æœå¯èƒ½æ€§ä¼šå°ä¸€äº›ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°sDataListså°±æ˜¯ä¸€ä¸ªå“ˆå¸Œè¡¨ã€‚æ ¹æ®ä¼ å…¥çš„objectä»å“ˆå¸Œè¡¨é‡Œæ‰¾åˆ°ä¸€ä¸ªSyncListï¼Œç„¶åä»SyncListå•é“¾è¡¨ä¸­æŸ¥æ‰¾SyncDataçš„åŒæ­¥å¯¹è±¡ä¸ä¼ å…¥çš„objectç›¸ç­‰çš„SyncDataã€‚è¯¥å“ˆå¸Œè¡¨é‡‡ç”¨çš„æ˜¯æ‹‰é“¾æ³•å¤„ç†å“ˆå¸Œå†²çªçš„ã€‚</p>
<h4 id="id2data"><a href="#id2data" class="headerlink" title="id2data"></a>id2data</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> SyncData* <span class="title function_">id2data</span><span class="params">(id object, <span class="keyword">enum</span> usage why)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">spinlock_t</span> *lockp = &amp;LOCK_FOR_OBJ(object);</span><br><span class="line">    SyncData **listp = &amp;LIST_FOR_OBJ(object);</span><br><span class="line">    SyncData* result = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> SUPPORT_DIRECT_THREAD_KEYS</span></span><br><span class="line">    <span class="comment">// Check per-thread single-entry fast cache for matching object</span></span><br><span class="line">    <span class="type">bool</span> fastCacheOccupied = NO;</span><br><span class="line">    SyncData *data = (SyncData *)tls_get_direct(SYNC_DATA_DIRECT_KEY);</span><br><span class="line">    <span class="keyword">if</span> (data) &#123;</span><br><span class="line">        fastCacheOccupied = YES;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (data-&gt;object == object) &#123;</span><br><span class="line">            <span class="comment">// Found a match in fast cache.</span></span><br><span class="line">            <span class="type">uintptr_t</span> lockCount;</span><br><span class="line"></span><br><span class="line">            result = data;</span><br><span class="line">            lockCount = (<span class="type">uintptr_t</span>)tls_get_direct(SYNC_COUNT_DIRECT_KEY);</span><br><span class="line">            <span class="keyword">if</span> (result-&gt;threadCount &lt;= <span class="number">0</span>  ||  lockCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                _objc_fatal(<span class="string">&quot;id2data fastcache is buggy&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span>(why) &#123;</span><br><span class="line">            <span class="keyword">case</span> ACQUIRE: &#123;</span><br><span class="line">                lockCount++;</span><br><span class="line">                tls_set_direct(SYNC_COUNT_DIRECT_KEY, (<span class="type">void</span>*)lockCount);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> RELEASE:</span><br><span class="line">                lockCount--;</span><br><span class="line">                tls_set_direct(SYNC_COUNT_DIRECT_KEY, (<span class="type">void</span>*)lockCount);</span><br><span class="line">                <span class="keyword">if</span> (lockCount == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// remove from fast cache</span></span><br><span class="line">                    tls_set_direct(SYNC_DATA_DIRECT_KEY, <span class="literal">NULL</span>);</span><br><span class="line">                    <span class="comment">// atomic because may collide with concurrent ACQUIRE</span></span><br><span class="line">                    OSAtomicDecrement32Barrier(&amp;result-&gt;threadCount); <span class="comment">//threadCount-1ï¼Œå¾ˆé‡è¦</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CHECK:</span><br><span class="line">                <span class="comment">// do nothing</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check per-thread cache of already-owned locks for matching object</span></span><br><span class="line">    SyncCache *cache = fetch_cache(NO);</span><br><span class="line">    <span class="keyword">if</span> (cache) &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> i;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cache-&gt;used; i++) &#123;</span><br><span class="line">            SyncCacheItem *item = &amp;cache-&gt;<span class="built_in">list</span>[i];</span><br><span class="line">            <span class="keyword">if</span> (item-&gt;data-&gt;object != object) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Found a match.</span></span><br><span class="line">            result = item-&gt;data;</span><br><span class="line">            <span class="keyword">if</span> (result-&gt;threadCount &lt;= <span class="number">0</span>  ||  item-&gt;lockCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                _objc_fatal(<span class="string">&quot;id2data cache is buggy&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">switch</span>(why) &#123;</span><br><span class="line">            <span class="keyword">case</span> ACQUIRE:</span><br><span class="line">                item-&gt;lockCount++;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RELEASE:</span><br><span class="line">                item-&gt;lockCount--;</span><br><span class="line">                <span class="keyword">if</span> (item-&gt;lockCount == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// remove from per-thread cache</span></span><br><span class="line">                    cache-&gt;<span class="built_in">list</span>[i] = cache-&gt;<span class="built_in">list</span>[--cache-&gt;used];</span><br><span class="line">                    <span class="comment">// atomic because may collide with concurrent ACQUIRE</span></span><br><span class="line">                    OSAtomicDecrement32Barrier(&amp;result-&gt;threadCount);<span class="comment">//threadCount-1ï¼Œå¾ˆé‡è¦</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CHECK:</span><br><span class="line">                <span class="comment">// do nothing</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Thread cache didn&#x27;t find anything.</span></span><br><span class="line">    <span class="comment">// Walk in-use list looking for matching object</span></span><br><span class="line">    <span class="comment">// Spinlock prevents multiple threads from creating multiple </span></span><br><span class="line">    <span class="comment">// locks for the same new object.</span></span><br><span class="line">    <span class="comment">// We could keep the nodes in some hash table if we find that there are</span></span><br><span class="line">    <span class="comment">// more than 20 or so distinct locks active, but we don&#x27;t do that now.</span></span><br><span class="line">    </span><br><span class="line">    lockp-&gt;lock();</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        SyncData* p;</span><br><span class="line">        SyncData* firstUnused = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">for</span> (p = *listp; p != <span class="literal">NULL</span>; p = p-&gt;nextData) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( p-&gt;object == object ) &#123;</span><br><span class="line">                result = p;</span><br><span class="line">                <span class="comment">// atomic because may collide with concurrent RELEASE</span></span><br><span class="line">                OSAtomicIncrement32Barrier(&amp;result-&gt;threadCount);</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( (firstUnused == <span class="literal">NULL</span>) &amp;&amp; (p-&gt;threadCount == <span class="number">0</span>) )</span><br><span class="line">                firstUnused = p;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// no SyncData currently associated with object</span></span><br><span class="line">        <span class="keyword">if</span> ( (why == RELEASE) || (why == CHECK) )</span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// an unused one was found, use it</span></span><br><span class="line">        <span class="keyword">if</span> ( firstUnused != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">            result = firstUnused;</span><br><span class="line">            result-&gt;object = (objc_object *)object;</span><br><span class="line">            result-&gt;threadCount = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allocate a new SyncData and add to list.</span></span><br><span class="line">    <span class="comment">// XXX allocating memory with a global lock held is bad practice,</span></span><br><span class="line">    <span class="comment">// might be worth releasing the lock, allocating, and searching again.</span></span><br><span class="line">    <span class="comment">// But since we never free these guys we won&#x27;t be stuck in allocation very often.</span></span><br><span class="line">    posix_memalign((<span class="type">void</span> **)&amp;result, <span class="keyword">alignof</span>(SyncData), <span class="keyword">sizeof</span>(SyncData));</span><br><span class="line">    result-&gt;object = (objc_object *)object;</span><br><span class="line">    result-&gt;threadCount = <span class="number">1</span>;</span><br><span class="line">    new (&amp;result-&gt;mutex) <span class="type">recursive_mutex_t</span>(fork_unsafe_lock);</span><br><span class="line">    result-&gt;nextData = *listp;</span><br><span class="line">    *listp = result;</span><br><span class="line">    </span><br><span class="line"> done:</span><br><span class="line">    lockp-&gt;unlock();</span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">        <span class="comment">// Only new ACQUIRE should get here.</span></span><br><span class="line">        <span class="comment">// All RELEASE and CHECK and recursive ACQUIRE are </span></span><br><span class="line">        <span class="comment">// handled by the per-thread caches above.</span></span><br><span class="line">        <span class="keyword">if</span> (why == RELEASE) &#123;</span><br><span class="line">            <span class="comment">// Probably some thread is incorrectly exiting </span></span><br><span class="line">            <span class="comment">// while the object is held by another thread.</span></span><br><span class="line">            <span class="keyword">return</span> nil;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (why != ACQUIRE) _objc_fatal(<span class="string">&quot;id2data is buggy&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (result-&gt;object != object) _objc_fatal(<span class="string">&quot;id2data is buggy&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> SUPPORT_DIRECT_THREAD_KEYS</span></span><br><span class="line">        <span class="keyword">if</span> (!fastCacheOccupied) &#123;</span><br><span class="line">            <span class="comment">// Save in fast thread cache</span></span><br><span class="line">            tls_set_direct(SYNC_DATA_DIRECT_KEY, result);</span><br><span class="line">            tls_set_direct(SYNC_COUNT_DIRECT_KEY, (<span class="type">void</span>*)<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Save in thread cache</span></span><br><span class="line">            <span class="keyword">if</span> (!cache) cache = fetch_cache(YES);</span><br><span class="line">            cache-&gt;<span class="built_in">list</span>[cache-&gt;used].data = result;</span><br><span class="line">            cache-&gt;<span class="built_in">list</span>[cache-&gt;used].lockCount = <span class="number">1</span>;</span><br><span class="line">            cache-&gt;used++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> SyncCache *<span class="title function_">fetch_cache</span><span class="params">(<span class="type">bool</span> create)</span></span><br><span class="line">&#123;</span><br><span class="line">    _objc_pthread_data *data;</span><br><span class="line">    </span><br><span class="line">    data = _objc_fetch_pthread_data(create);</span><br><span class="line">    <span class="keyword">if</span> (!data) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!data-&gt;syncCache) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!create) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">int</span> count = <span class="number">4</span>;</span><br><span class="line">            data-&gt;syncCache = (SyncCache *)</span><br><span class="line">                <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(SyncCache) + count*<span class="keyword">sizeof</span>(SyncCacheItem));</span><br><span class="line">            data-&gt;syncCache-&gt;allocated = count;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure there&#x27;s at least one open slot in the list.</span></span><br><span class="line">    <span class="keyword">if</span> (data-&gt;syncCache-&gt;allocated == data-&gt;syncCache-&gt;used) &#123;</span><br><span class="line">        data-&gt;syncCache-&gt;allocated *= <span class="number">2</span>;</span><br><span class="line">        data-&gt;syncCache = (SyncCache *)</span><br><span class="line">            <span class="built_in">realloc</span>(data-&gt;syncCache, <span class="keyword">sizeof</span>(SyncCache) </span><br><span class="line">                    + data-&gt;syncCache-&gt;allocated * <span class="keyword">sizeof</span>(SyncCacheItem));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> data-&gt;syncCache;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* _objc_fetch_pthread_data</span></span><br><span class="line"><span class="comment">* Fetch objc&#x27;s pthread data for this thread.</span></span><br><span class="line"><span class="comment">* If the data doesn&#x27;t exist yet and create is NO, return NULL.</span></span><br><span class="line"><span class="comment">* If the data doesn&#x27;t exist yet and create is YES, allocate and return it.</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line">_objc_pthread_data *_objc_fetch_pthread_data(<span class="type">bool</span> create)</span><br><span class="line">&#123;</span><br><span class="line">    _objc_pthread_data *data;</span><br><span class="line"></span><br><span class="line">    data = (_objc_pthread_data *)tls_get(_objc_pthread_key);</span><br><span class="line">    <span class="keyword">if</span> (!data  &amp;&amp;  create) &#123;</span><br><span class="line">        data = (_objc_pthread_data *)</span><br><span class="line">            <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(_objc_pthread_data));</span><br><span class="line">        tls_set(_objc_pthread_key, data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// objc&#x27;s key for pthread_getspecific</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> SUPPORT_DIRECT_THREAD_KEYS</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _objc_pthread_key TLS_DIRECT_KEY</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">tls_key_t</span> _objc_pthread_key;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>è¯¥å‡½æ•°çš„å®ç°æ¯”è¾ƒå¤æ‚ï¼Œå¤§ä½“ä¸Šåˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ï¼š</p>
<p>1 å¦‚æœæ”¯æŒSUPPORT_DIRECT_THREAD_KEYSï¼Œåˆ™å…ˆä»TLSï¼ˆThread Local Storageï¼Œçº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼‰ä¸­çš„FastCacheç¼“å­˜ä¸­è·å–é”ã€‚</p>
<p>2 ä»TLSä¸­çš„SyncCacheç¼“å­˜ä¸­è·å–é”ã€‚</p>
<p>3 ä»å…¨å±€å˜é‡sDataListså“ˆå¸Œè¡¨ä¸­è·å–é”ï¼Œå¹¶ä¼˜å…ˆåŠ å…¥åˆ°FastCacheç¼“å­˜(SUPPORT_DIRECT_THREAD_KEYSå¹¶ä¸”FastCacheç©ºé—²)ï¼Œå¦‚æœFastCacheå·²ç»å ç”¨åˆ™åŠ å…¥åˆ°SyncCacheç¼“å­˜ã€‚</p>
<p>4 æ–°åˆ›å»ºä¸€æŠŠé”ï¼Œå¹¶æ·»åŠ åˆ°sDataListsä¸­çš„å¯¹åº”å•é“¾è¡¨ä¸­ä»¥åŠåŠ å…¥åˆ°FastCacheç¼“å­˜æˆ–SyncCacheç¼“å­˜ã€‚</p>
<h5 id="ä»TLSä¸­çš„FastCacheç¼“å­˜é‡Œè·å–é”"><a href="#ä»TLSä¸­çš„FastCacheç¼“å­˜é‡Œè·å–é”" class="headerlink" title="ä»TLSä¸­çš„FastCacheç¼“å­˜é‡Œè·å–é”"></a>ä»TLSä¸­çš„FastCacheç¼“å­˜é‡Œè·å–é”</h5><p>å¦‚æœå®šä¹‰äº†SUPPORT_DIRECT_THREAD_KEYSåˆ™å…ˆä»Fast cacheé‡Œè·å–ï¼ŒFast cacheè§£é‡Šå¦‚ä¸‹ï¼š</p>
<figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  Fast cache: two fixed pthread keys store a single SyncCacheItem. </span></span><br><span class="line"><span class="comment">  This avoids malloc of the SyncCache for threads that only synchronize </span></span><br><span class="line"><span class="comment">  a single object at a time.</span></span><br><span class="line"><span class="comment">  SYNC_DATA_DIRECT_KEY  == SyncCacheItem.data</span></span><br><span class="line"><span class="comment">  SYNC_COUNT_DIRECT_KEY == SyncCacheItem.lockCount</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>FastCacheä¹Ÿæ˜¯ç³»ç»Ÿä¸ºäº†æé«˜è·å–é”çš„æ•ˆç‡åšçš„ä¸€ä¸ªä¼˜åŒ–ã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹åªåŒæ­¥ä¸€ä¸ªå¯¹è±¡å°±æ²¡å¿…è¦ä¸ºå®ƒå†åˆ†é…SyncCacheå†…å­˜ï¼Œç³»ç»Ÿä¸ºè¿™ç§æƒ…å†µåœ¨TLSä¸­ä¿ç•™äº†ä¸€ä¸ªå­˜å‚¨SyncCacheItemçš„ç©ºé—´ï¼Œé€šè¿‡SYNC_DATA_DIRECT_KEYå’ŒSYNC_COUNT_DIRECT_KEYæ¥è·å–ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> SUPPORT_DIRECT_THREAD_KEYS</span></span><br><span class="line">    <span class="comment">// Check per-thread single-entry fast cache for matching object</span></span><br><span class="line">    <span class="type">bool</span> fastCacheOccupied = NO;</span><br><span class="line">    SyncData *data = (SyncData *)tls_get_direct(SYNC_DATA_DIRECT_KEY);</span><br><span class="line">    <span class="keyword">if</span> (data) &#123;</span><br><span class="line">        fastCacheOccupied = YES;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (data-&gt;object == object) &#123;</span><br><span class="line">            <span class="comment">// Found a match in fast cache.</span></span><br><span class="line">            <span class="type">uintptr_t</span> lockCount;</span><br><span class="line"></span><br><span class="line">            result = data;</span><br><span class="line">            lockCount = (<span class="type">uintptr_t</span>)tls_get_direct(SYNC_COUNT_DIRECT_KEY);</span><br><span class="line">            <span class="keyword">if</span> (result-&gt;threadCount &lt;= <span class="number">0</span>  ||  lockCount &lt;= <span class="number">0</span>) &#123; <span class="comment">//ä»ç¼“å­˜ä¸­æ‹¿å‡ºæ¥çš„SyncDataï¼Œå®ƒçš„threadCountï¼ŒlockCountä¸å¯èƒ½ä¸º0ï¼Œå› ä¸ºæ–°å»ºé”æ—¶ä¼šè®¾ç½®ä¸º1ï¼Œç„¶åæ‰ä¸¢åˆ°ç¼“å­˜ä¸­å»çš„ã€‚ä¸‹é¢çš„SyncCacheåŒæ ·çš„é“ç†ã€‚</span></span><br><span class="line">                _objc_fatal(<span class="string">&quot;id2data fastcache is buggy&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span>(why) &#123;</span><br><span class="line">            <span class="keyword">case</span> ACQUIRE: &#123;</span><br><span class="line">                lockCount++;</span><br><span class="line">                tls_set_direct(SYNC_COUNT_DIRECT_KEY, (<span class="type">void</span>*)lockCount);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> RELEASE:</span><br><span class="line">                lockCount--;</span><br><span class="line">                tls_set_direct(SYNC_COUNT_DIRECT_KEY, (<span class="type">void</span>*)lockCount);</span><br><span class="line">                <span class="keyword">if</span> (lockCount == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// remove from fast cache</span></span><br><span class="line">                    tls_set_direct(SYNC_DATA_DIRECT_KEY, <span class="literal">NULL</span>);</span><br><span class="line">                    <span class="comment">// atomic because may collide with concurrent ACQUIRE</span></span><br><span class="line">                    OSAtomicDecrement32Barrier(&amp;result-&gt;threadCount);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CHECK:</span><br><span class="line">                <span class="comment">// do nothing</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœåœ¨TLSçš„FastCacheä¸­æ‰¾åˆ°ä¸€ä¸ªSyncDataï¼Œå³<code>if (data-&gt;object == object)</code>ä¸ºçœŸã€‚</p>
<p>åˆ™æ ¹æ®æ˜¯åŠ é”è¿˜æ˜¯è§£é”æ“ä½œlockCountè®¡æ•°å™¨ã€‚å½“lockCountç­‰äº0æ—¶ä¹Ÿå°±æ˜¯å½“å‰çº¿ç¨‹å³å°†é‡Šæ”¾è¯¥é”ï¼Œå°†SyncDataä»FastCacheä¸­ç§»é™¤ï¼ŒFastCacheé‡æ–°å˜ä¸ºç©ºçš„ï¼ŒåŒæ—¶å°†SyncDataçš„threadCountå‡1ã€‚</p>
<p>æ‰§è¡Œå®Œswitchåè¿”å›æ‰¾åˆ°çš„SyncDataã€‚</p>
<p>å¦‚æœ<code>if (data-&gt;object == object)</code>ä¸ºå‡ï¼Œè¡¨æ˜FastCacheä¸­è™½ç„¶å­˜åœ¨SyncDataå¯¹è±¡ä½†æ˜¯åŒæ­¥å¯¹è±¡ä¸ä¸€æ ·ï¼Œæ­¤æ—¶ä¼šæ‰§è¡Œåç»­ä»£ç ã€‚</p>
<p>è¿™ç§æƒ…å†µå°±æ˜¯synchronizedåµŒå¥—ä½†ä¼ å…¥çš„åŒæ­¥å¯¹è±¡ä¸ä¸€æ ·ï¼š</p>
<figure class="highlight wren"><table><tr><td class="code"><pre><span class="line">@<span class="title function_">synchronized</span>(<span class="params">A</span>) &#123;</span><br><span class="line">		<span class="operator">...</span><span class="operator">...</span></span><br><span class="line">		@<span class="title function_">synchronized</span>(<span class="params">B</span>) &#123;</span><br><span class="line">				<span class="operator">...</span>.</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ä»TLSä¸­çš„SyncCacheç¼“å­˜ä¸­è·å–é”"><a href="#ä»TLSä¸­çš„SyncCacheç¼“å­˜ä¸­è·å–é”" class="headerlink" title="ä»TLSä¸­çš„SyncCacheç¼“å­˜ä¸­è·å–é”"></a>ä»TLSä¸­çš„SyncCacheç¼“å­˜ä¸­è·å–é”</h5><p>å¦‚æœåœ¨FastCacheä¸­æ²¡æœ‰æ‰¾åˆ°ä¸åŒæ­¥å¯¹è±¡å…³è”çš„é”ï¼Œåˆ™ç»§ç»­åœ¨SyncCacheç¼“å­˜ä¸­æŸ¥æ‰¾ã€‚</p>
<p>SyncCacheä¹Ÿæ˜¯å­˜å‚¨äºTLSä¸­çš„ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„SyncCacheã€‚å¦‚æœçº¿ç¨‹ä¹‹å‰ä¸ºåŒæ­¥å¯¹è±¡åˆ†é…è¿‡é”é‚£ä¹ˆä¸‹ä¸€æ¬¡å†è·å–æ—¶ç›´æ¥ä»ç¼“å­˜ä¸­è·å–ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Check per-thread cache of already-owned locks for matching object</span></span><br><span class="line">SyncCache *cache = fetch_cache(NO);</span><br><span class="line"><span class="keyword">if</span> (cache) &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cache-&gt;used; i++) &#123;</span><br><span class="line">        SyncCacheItem *item = &amp;cache-&gt;<span class="built_in">list</span>[i];</span><br><span class="line">        <span class="keyword">if</span> (item-&gt;data-&gt;object != object) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Found a match.</span></span><br><span class="line">        result = item-&gt;data;</span><br><span class="line">        <span class="keyword">if</span> (result-&gt;threadCount &lt;= <span class="number">0</span>  ||  item-&gt;lockCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            _objc_fatal(<span class="string">&quot;id2data cache is buggy&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span>(why) &#123;</span><br><span class="line">        <span class="keyword">case</span> ACQUIRE:</span><br><span class="line">            item-&gt;lockCount++;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> RELEASE:</span><br><span class="line">            item-&gt;lockCount--;</span><br><span class="line">            <span class="keyword">if</span> (item-&gt;lockCount == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// remove from per-thread cache</span></span><br><span class="line">                cache-&gt;<span class="built_in">list</span>[i] = cache-&gt;<span class="built_in">list</span>[--cache-&gt;used];</span><br><span class="line">                <span class="comment">// atomic because may collide with concurrent ACQUIRE</span></span><br><span class="line">                OSAtomicDecrement32Barrier(&amp;result-&gt;threadCount);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CHECK:</span><br><span class="line">            <span class="comment">// do nothing</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€»è¾‘å’ŒFastCacheå·®ä¸å¤šã€‚å½“lockCountç­‰äº0æ—¶ï¼Œå°†SyncCacheItemä»SyncCacheä¸­ç§»é™¤ï¼ŒåŒæ—¶å°†SyncDataçš„threadCountå‡1ï¼š</p>
<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line"><span class="comment">// remove from per-thread cache</span></span><br><span class="line"><span class="function"><span class="title">cache</span>-&gt;</span><span class="function"><span class="title">list</span>[i] = cache-&gt;</span><span class="function"><span class="title">list</span>[--cache-&gt;</span>used];</span><br><span class="line"><span class="comment">// atomic because may collide with concurrent ACQUIRE</span></span><br><span class="line">OSA<span class="function"><span class="title">tomicDecrement32Barrier</span>(&amp;result-&gt;</span>threadCount);</span><br></pre></td></tr></table></figure>
<p>å®ƒè¿™é‡Œç§»é™¤æœ‰ç‚¹æ„æ€ï¼Œå› ä¸ºlistæ˜¯ä¸ªcæ•°ç»„ï¼Œå¦‚æœçœŸçš„åˆ é™¤æŸä¸ªå…ƒç´ çš„è¯ï¼Œé‚£åé¢çš„å…ƒç´ è¿˜å¾—å¾€å‰æŒªåŠ¨ï¼Œç„¶è€Œè¯¥åœºæ™¯ä¸‹å¹¶ä¸éœ€è¦è¿™ä¹ˆä¸¥æ ¼çš„åˆ é™¤ï¼Œæ‰€ä»¥è¿™é‡Œå°±ç”¨æœ€åä¸€ä¸ªSyncCacheItemæ›¿æ¢æ‰å½“å‰SyncCacheItemå°±å¯ä»¥äº†ã€‚</p>
<h5 id="ä»å…¨å±€å˜é‡sDataListså“ˆå¸Œè¡¨ä¸­è·å–"><a href="#ä»å…¨å±€å˜é‡sDataListså“ˆå¸Œè¡¨ä¸­è·å–" class="headerlink" title="ä»å…¨å±€å˜é‡sDataListså“ˆå¸Œè¡¨ä¸­è·å–"></a>ä»å…¨å±€å˜é‡sDataListså“ˆå¸Œè¡¨ä¸­è·å–</h5><p>å¦‚æœæ²¡èƒ½åœ¨ä¸Šè¿°ç¼“å­˜ä¸­æ‰¾åˆ°ï¼Œåˆ™ç»§ç»­åœ¨sDataListsåˆ—è¡¨ä¸­æŸ¥æ‰¾ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Thread cache didn&#x27;t find anything.</span></span><br><span class="line"><span class="comment">// Walk in-use list looking for matching object</span></span><br><span class="line"><span class="comment">// Spinlock prevents multiple threads from creating multiple </span></span><br><span class="line"><span class="comment">// locks for the same new object.</span></span><br><span class="line"><span class="comment">// We could keep the nodes in some hash table if we find that there are</span></span><br><span class="line"><span class="comment">// more than 20 or so distinct locks active, but we don&#x27;t do that now.</span></span><br><span class="line"></span><br><span class="line">lockp-&gt;lock();</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    SyncData* p;</span><br><span class="line">    SyncData* firstUnused = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">for</span> (p = *listp; p != <span class="literal">NULL</span>; p = p-&gt;nextData) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( p-&gt;object == object ) &#123;</span><br><span class="line">            result = p;</span><br><span class="line">            <span class="comment">// atomic because may collide with concurrent RELEASE</span></span><br><span class="line">            OSAtomicIncrement32Barrier(&amp;result-&gt;threadCount);</span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( (firstUnused == <span class="literal">NULL</span>) &amp;&amp; (p-&gt;threadCount == <span class="number">0</span>) )</span><br><span class="line">            firstUnused = p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// no SyncData currently associated with object</span></span><br><span class="line">    <span class="keyword">if</span> ( (why == RELEASE) || (why == CHECK) )</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// an unused one was found, use it</span></span><br><span class="line">    <span class="keyword">if</span> ( firstUnused != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">        result = firstUnused;</span><br><span class="line">        result-&gt;object = (objc_object *)object;</span><br><span class="line">        result-&gt;threadCount = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>åˆšå¼€å§‹çš„å‡ ä¸ªå˜é‡å®šä¹‰ï¼š</p>
<figure class="highlight isbl"><table><tr><td class="code"><pre><span class="line"><span class="variable">spinlock_t</span> *<span class="variable">lockp</span> = &amp;<span class="function"><span class="title">LOCK_FOR_OBJ</span>(<span class="variable"><span class="class">object</span></span>);</span></span><br><span class="line"><span class="function"><span class="variable">SyncData</span> **<span class="variable">listp</span> = &amp;<span class="title">LIST_FOR_OBJ</span>(<span class="variable"><span class="class">object</span></span>);</span></span><br><span class="line"><span class="function"><span class="variable">SyncData</span>* <span class="variable"><span class="class">result</span></span> = <span class="variable"><span class="literal">NULL</span></span>;</span></span><br></pre></td></tr></table></figure>
<p>ä»å…¨å±€çš„sDataListsä¸­æ ¹æ®ä¼ å…¥çš„objectæ‰¾åˆ°ä¸€ä¸ªSyncListæ²¡æœ‰å°±åˆ›å»ºã€‚</p>
<p>ä¸åŒäºåœ¨TLSä¸­çš„æŸ¥æ‰¾ï¼Œè¿™é‡ŒæŸ¥æ‰¾å’Œæ“ä½œçš„æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæ‰€ä»¥ä»£ç é¦–å…ˆä½¿ç”¨SyncListé‡Œçš„è‡ªæ—‹é”è¿›è¡ŒåŠ é”ï¼Œä¿è¯åç»­çš„æŸ¥æ‰¾ä¸æ“ä½œåŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚</p>
<p>ç„¶ååœ¨SyncDataè¿™ä¸ªå•é“¾è¡¨ä¸Šå¼€å§‹æŸ¥æ‰¾ï¼š</p>
<p>å¦‚æœæ‰¾åˆ°ä¸€ä¸ªä¸objectç›¸ç­‰çš„SyncDataï¼Œåˆ™threadCountåŠ 1å¹¶æ‰§è¡Œåç»­doneæ“ä½œã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">SyncData* p;</span><br><span class="line">SyncData* firstUnused = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">for</span> (p = *listp; p != <span class="literal">NULL</span>; p = p-&gt;nextData) &#123;</span><br><span class="line">    <span class="keyword">if</span> ( p-&gt;object == object ) &#123;</span><br><span class="line">        result = p;</span><br><span class="line">        <span class="comment">// atomic because may collide with concurrent RELEASE</span></span><br><span class="line">        <span class="built_in">OSAtomicIncrement32Barrier</span>(&amp;result-&gt;threadCount);</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (firstUnused == <span class="literal">NULL</span>) &amp;&amp; (p-&gt;threadCount == <span class="number">0</span>) )</span><br><span class="line">        firstUnused = p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ²¡æ‰¾åˆ°ä¸objectç›¸ç­‰çš„SyncDataï¼Œä½†æ‰¾åˆ°ä¸€ä¸ªæœªä½¿ç”¨çš„SyncDataé‚£å°±ä½¿ç”¨å®ƒï¼Œå¤ç”¨äº†ã€‚</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// an unused one was found, use it</span></span><br><span class="line"><span class="keyword">if</span> ( firstUnused != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">    result = firstUnused;</span><br><span class="line">    result-&gt;<span class="keyword">object</span> = (objc_object *)<span class="keyword">object</span>;</span><br><span class="line">    result-&gt;threadCount = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">goto</span> done;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SyncDataä¸­çš„objectæ›´æ–°ä¸ºä¼ å…¥objectï¼ŒthreadCountæ›´æ–°ä¸º1ã€‚æ‰§è¡Œåç»­doneæ“ä½œã€‚</p>
<p>ä»å…¨å±€å˜é‡sDataListsåˆ—è¡¨ä¸­çš„æŸ¥æ‰¾å°±ç»“æŸäº†ï¼Œå¦‚æœä¾ç„¶æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„SyncDataåˆ™åªèƒ½åˆ›å»ºæ–°çš„SyncDataäº†ã€‚</p>
<p>SyncDataä½¿ç”¨åå®ƒçš„objectå€¼æ˜¯æ²¡æœ‰æ“¦é™¤çš„ï¼Œèƒ½ä¸èƒ½å¤ç”¨çœ‹çš„æ˜¯threadCountæ˜¯å¦ç­‰äº0ï¼Œç­‰äº0è¯´æ˜å¯ä»¥å¤ç”¨ï¼Œobjectå°±ä¼šè¢«èµ‹å€¼ä¸€ä¸ªæ–°çš„å¯¹è±¡åœ°å€ã€‚</p>
<h5 id="æ–°åˆ›å»ºé”"><a href="#æ–°åˆ›å»ºé”" class="headerlink" title="æ–°åˆ›å»ºé”"></a>æ–°åˆ›å»ºé”</h5><p>æœ€åæ˜¯æ–°åˆ›å»ºä¸€æŠŠé”ï¼Œå¹¶æ·»åŠ åˆ°sDataListsä¸­çš„æŸä¸ªå•é“¾è¡¨ä¸­ä»¥åŠåŠ å…¥åˆ°FastCacheç¼“å­˜æˆ–SyncCacheç¼“å­˜ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Thread cache didn&#x27;t find anything.</span></span><br><span class="line"><span class="comment">// Walk in-use list looking for matching object</span></span><br><span class="line"><span class="comment">// Spinlock prevents multiple threads from creating multiple </span></span><br><span class="line"><span class="comment">// locks for the same new object.</span></span><br><span class="line"><span class="comment">// We could keep the nodes in some hash table if we find that there are</span></span><br><span class="line"><span class="comment">// more than 20 or so distinct locks active, but we don&#x27;t do that now.</span></span><br><span class="line"></span><br><span class="line">lockp-&gt;lock();</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    SyncData* p;</span><br><span class="line">    SyncData* firstUnused = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">for</span> (p = *listp; p != <span class="literal">NULL</span>; p = p-&gt;nextData) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( p-&gt;object == object ) &#123;</span><br><span class="line">            result = p;</span><br><span class="line">            <span class="comment">// atomic because may collide with concurrent RELEASE</span></span><br><span class="line">            OSAtomicIncrement32Barrier(&amp;result-&gt;threadCount);</span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( (firstUnused == <span class="literal">NULL</span>) &amp;&amp; (p-&gt;threadCount == <span class="number">0</span>) )</span><br><span class="line">            firstUnused = p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// no SyncData currently associated with object</span></span><br><span class="line">    <span class="keyword">if</span> ( (why == RELEASE) || (why == CHECK) )</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// an unused one was found, use it</span></span><br><span class="line">    <span class="keyword">if</span> ( firstUnused != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">        result = firstUnused;</span><br><span class="line">        result-&gt;object = (objc_object *)object;</span><br><span class="line">        result-&gt;threadCount = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Allocate a new SyncData and add to list.</span></span><br><span class="line"><span class="comment">// XXX allocating memory with a global lock held is bad practice,</span></span><br><span class="line"><span class="comment">// might be worth releasing the lock, allocating, and searching again.</span></span><br><span class="line"><span class="comment">// But since we never free these guys we won&#x27;t be stuck in allocation very often.</span></span><br><span class="line">posix_memalign((<span class="type">void</span> **)&amp;result, <span class="keyword">alignof</span>(SyncData), <span class="keyword">sizeof</span>(SyncData));</span><br><span class="line">result-&gt;object = (objc_object *)object;</span><br><span class="line">result-&gt;threadCount = <span class="number">1</span>;</span><br><span class="line">new (&amp;result-&gt;mutex) <span class="type">recursive_mutex_t</span>(fork_unsafe_lock);</span><br><span class="line">result-&gt;nextData = *listp;</span><br><span class="line">*listp = result;</span><br><span class="line"></span><br><span class="line">done:</span><br><span class="line">lockp-&gt;unlock();</span><br><span class="line"><span class="keyword">if</span> (result) &#123;</span><br><span class="line">    <span class="comment">// Only new ACQUIRE should get here.</span></span><br><span class="line">    <span class="comment">// All RELEASE and CHECK and recursive ACQUIRE are </span></span><br><span class="line">    <span class="comment">// handled by the per-thread caches above.</span></span><br><span class="line">    <span class="keyword">if</span> (why == RELEASE) &#123;</span><br><span class="line">        <span class="comment">// Probably some thread is incorrectly exiting </span></span><br><span class="line">        <span class="comment">// while the object is held by another thread.</span></span><br><span class="line">        <span class="keyword">return</span> nil;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (why != ACQUIRE) _objc_fatal(<span class="string">&quot;id2data is buggy&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (result-&gt;object != object) _objc_fatal(<span class="string">&quot;id2data is buggy&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> SUPPORT_DIRECT_THREAD_KEYS</span></span><br><span class="line">    <span class="keyword">if</span> (!fastCacheOccupied) &#123;</span><br><span class="line">        <span class="comment">// Save in fast thread cache</span></span><br><span class="line">        tls_set_direct(SYNC_DATA_DIRECT_KEY, result);</span><br><span class="line">        tls_set_direct(SYNC_COUNT_DIRECT_KEY, (<span class="type">void</span>*)<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Save in thread cache</span></span><br><span class="line">        <span class="keyword">if</span> (!cache) cache = fetch_cache(YES);</span><br><span class="line">        cache-&gt;<span class="built_in">list</span>[cache-&gt;used].data = result;</span><br><span class="line">        cache-&gt;<span class="built_in">list</span>[cache-&gt;used].lockCount = <span class="number">1</span>;</span><br><span class="line">        cache-&gt;used++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> result;</span><br></pre></td></tr></table></figure>
<p>åŒæ ·åˆ›å»ºæ–°çš„SyncDataæ—¶ä¹Ÿæ˜¯åœ¨è‡ªæ—‹é”ä¿æŠ¤åŒºé‡Œçš„ï¼Œä¸»è¦çš„åˆ›å»ºä»£ç ä¸ºï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Allocate a new SyncData and add to list.</span></span><br><span class="line"><span class="comment">// XXX allocating memory with a global lock held is bad practice,</span></span><br><span class="line"><span class="comment">// might be worth releasing the lock, allocating, and searching again.</span></span><br><span class="line"><span class="comment">// But since we never free these guys we won&#x27;t be stuck in allocation very often.</span></span><br><span class="line">posix_memalign((<span class="type">void</span> **)&amp;result, <span class="keyword">alignof</span>(SyncData), <span class="keyword">sizeof</span>(SyncData));</span><br><span class="line">result-&gt;object = (objc_object *)object; <span class="comment">//è®°å½•ä¼ å…¥çš„å¯¹è±¡åœ°å€</span></span><br><span class="line">result-&gt;threadCount = <span class="number">1</span>; </span><br><span class="line">new (&amp;result-&gt;mutex) <span class="type">recursive_mutex_t</span>(fork_unsafe_lock); <span class="comment">//åˆ›å»ºä¸€æŠŠæ–°é”</span></span><br><span class="line">result-&gt;nextData = *listp; <span class="comment">//æ·»åŠ åˆ°é“¾è¡¨é‡Œï¼Œæ³¨æ„è¿™é‡Œæ˜¯æ·»åŠ åˆ°é“¾è¡¨å¤´éƒ¨</span></span><br><span class="line">*listp = result;</span><br></pre></td></tr></table></figure>
<p>æ–°åˆ›å»ºçš„SyncDataä¼šä½œä¸ºå¤´ç»“ç‚¹æ·»åŠ åˆ°å½“å‰SyncListä¸­ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">result-&gt;nextData = *listp;</span><br><span class="line">*listp = result;</span><br></pre></td></tr></table></figure>
<p>æœ€åæ˜¯doneæ“ä½œäº†ï¼š</p>
<p>å‰é¢åœ¨TLSçš„ç¼“å­˜ä¸­å¦‚æœæŸ¥æ‰¾åˆ°å¯ç”¨çš„SyncDataæ˜¯ä¸ä¼šèµ°åˆ°doneæ“ä½œçš„ï¼Œåªæœ‰åœ¨å“ˆå¸Œè¡¨é‡Œæ‰¾åˆ°çš„æˆ–è€…æ–°åˆ›å»ºçš„SyncDataæ‰ä¼šèµ°åˆ°doneã€‚</p>
<p>doneçš„ä½œç”¨å°±æ˜¯æŠŠä»å“ˆå¸Œè¡¨é‡Œæˆ–è€…æ–°åˆ›å»ºçš„SyncDataåŠ å…¥åˆ°TLSä¸­çš„FastCacheæˆ–SyncCacheã€‚</p>
<p>åˆ°æ­¤ä¸ºæ­¢id2dataå‡½æ•°çš„å·¥ä½œæµç¨‹å°±ç»“æŸäº†ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼š</p>
<p>id2dataå‡½æ•°æ ¹æ®ä¼ å…¥çš„åŒæ­¥å¯¹è±¡è·å–é”çš„è¿‡ç¨‹å¤§ä½“ä¸Šåˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ï¼š</p>
<p>1 ä»TLSï¼ˆThread Local Storageï¼Œçº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼‰ä¸­çš„FastCacheç¼“å­˜ä¸­è·å–é”</p>
<p>2 ä»TLSä¸­çš„SyncCacheï¼ˆæ™®é€šæ•°ç»„ï¼‰ç¼“å­˜ä¸­è·å–é”</p>
<p>3 ä»å…¨å±€å˜é‡sDataListså“ˆå¸Œè¡¨ä¸­è·å–é”ï¼Œå¹¶åŠ å…¥åˆ°FastCacheç¼“å­˜æˆ–SyncCacheç¼“å­˜</p>
<p>4 æ–°åˆ›å»ºä¸€æŠŠé”ï¼Œå¹¶æ·»åŠ åˆ°sDataListså“ˆå¸Œè¡¨ä¸­çš„å¯¹åº”å•é“¾è¡¨ä¸­ä»¥åŠåŠ å…¥åˆ°FastCacheç¼“å­˜æˆ–SyncCacheç¼“å­˜</p>
<p>id2dataå‡½æ•°ä¸­ä¸ºäº†èƒ½å¤Ÿæ›´é«˜æ•ˆçš„æ ¹æ®åŒæ­¥å¯¹è±¡è·å¾—ä¸€æŠŠé”ï¼Œç³»ç»Ÿåšäº†ç¼“å­˜ã€‚1å’Œ2æ˜¯TLSä¸­çš„ç¼“å­˜ï¼Œ3æ˜¯å“ˆå¸Œè¡¨ä¸­çš„ç¼“å­˜ã€‚</p>
<p>1å’Œ2å¯¹synchronizedåµŒå¥—ä½¿ç”¨æƒ…å†µä¼˜åŒ–æå‡è¾ƒå¤§ï¼Œä½†å¦‚æœä¸´ç•ŒåŒºä¸éœ€è¦é€’å½’é”çš„ç‰¹æ€§ï¼Œé‚£ä¹ˆ1å’Œ2çš„ç¼“å­˜å¯¹æ€§èƒ½æå‡ä¸æ˜¯é‚£ä¹ˆå¤§ã€‚</p>
<p>å³ä½¿ç³»ç»Ÿåšäº†å¦‚æ­¤å¤šçš„ä¼˜åŒ–ï¼Œä½†æ˜¯synchronizedé”åœ¨æ•ˆç‡ä¸Šä¾ç„¶æ˜¯æ‰€æœ‰é”ä¸­æœ€ä½çš„ï¼Œæ¯•ç«Ÿé‡Œé¢ç¼“å­˜æ“ä½œä¹Ÿæ˜¯è¦æ¶ˆè€—æ—¶é—´çš„ã€‚</p>
<h4 id="objc-sync-exit"><a href="#objc-sync-exit" class="headerlink" title="objc_sync_exit"></a>objc_sync_exit</h4><p>æœ€åæ˜¯objc_sync_exit()çš„å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// End synchronizing on &#x27;obj&#x27;. </span></span><br><span class="line"><span class="comment">// Returns OBJC_SYNC_SUCCESS or OBJC_SYNC_NOT_OWNING_THREAD_ERROR</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">objc_sync_exit</span><span class="params">(id obj)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> result = OBJC_SYNC_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (obj) &#123;</span><br><span class="line">        SyncData* data = id2data(obj, RELEASE); </span><br><span class="line">        <span class="keyword">if</span> (!data) &#123;</span><br><span class="line">            result = OBJC_SYNC_NOT_OWNING_THREAD_ERROR;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">bool</span> okay = data-&gt;mutex.tryUnlock();</span><br><span class="line">            <span class="keyword">if</span> (!okay) &#123;</span><br><span class="line">                result = OBJC_SYNC_NOT_OWNING_THREAD_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// @synchronized(nil) does nothing</span></span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»è¿‡ä¸Šè¿°çš„id2dataå‡½æ•°çš„åˆ†æï¼Œè¿™é‡Œå°±å¾ˆç®€å•äº†ã€‚</p>
<p>å°±æ˜¯æ ¹æ®ä¼ å…¥çš„objè·å–åˆ°SyncDataåï¼Œè¿›è¡Œè§£é”ï¼Œä¼ å…¥nilåˆ™ä»€ä¹ˆä¹Ÿä¸åšã€‚ä½¿ç”¨<code>@synchronized (obj)&#123;...&#125;</code>æ—¶ï¼Œobjc_sync_enterå’Œobjc_sync_exitçš„å‚æ•°objå¿…ç„¶æ˜¯åŒä¸€ä¸ªobjï¼Œå› æ­¤è·å–åˆ°çš„è‡ªç„¶ä¹Ÿæ˜¯åŒä¸€æŠŠé”ã€‚</p>
<p>å†™åˆ°è¿™é‡Œçªç„¶æœ‰ä¸€ä¸ªç–‘é—®ï¼ŒSyncDataä¼šè¢«æ·»åŠ åˆ°å“ˆå¸Œè¡¨é‡Œï¼Œè²Œä¼¼æ˜¯æ²¡çœ‹åˆ°é”€æ¯çš„ï¼ˆå› ä¸ºé‡Œé¢æœ‰å¤ç”¨é€»è¾‘ï¼‰ï¼Œé‚£ä¹ˆSyncDataä¼šä¸ä¼šä¸€ç›´æŒæœ‰åŒæ­¥å¯¹è±¡ï¼Œå¯¼è‡´åŒæ­¥å¯¹è±¡æ— æ³•é”€æ¯å‘¢ï¼Ÿå®é™…ä¸Šæ˜¯ä¸ä¼šæŒæœ‰åŒæ­¥å¯¹è±¡çš„ï¼ŒåŒæ­¥å¯¹è±¡èƒ½æ­£å¸¸é”€æ¯ï¼Œä½†åˆæ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title function_">alignas</span><span class="params">(CacheLineSize)</span> SyncData &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">SyncData</span>* <span class="title">nextData</span>;</span></span><br><span class="line">    DisguisedPtr&lt;objc_object&gt; object;</span><br><span class="line">    <span class="type">int32_t</span> threadCount;  <span class="comment">// number of THREADS using this block</span></span><br><span class="line">    <span class="type">recursive_mutex_t</span> mutex;</span><br><span class="line">&#125; SyncData;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°SyncDataçš„objectçš„ç±»å‹æ˜¯DisguisedPtr<objc_object>ç±»å‹ã€‚</p>
<p>DisguisedPtrï¼šå¯¹æŒ‡é’ˆè¿›è¡Œä¼ªè£…çš„ç±»ï¼Œå°†æŒ‡é’ˆå¼ºè½¬ä¸º uintptr_t ï¼ˆunsigned longï¼‰ç±»å‹çš„è´Ÿå€¼ï¼Œè¿™æ ·ç±»ä¼¼ leaks è¿™æ ·çš„æŸ¥å†…å­˜æ³„æ¼çš„å·¥å…·ä¾¿æ— æ³•è·Ÿè¸ªåˆ°å¯¹è±¡ã€‚</p>
<p>æŸ¥çœ‹DisguisedPtræ¨¡æ¿ç±»çš„å®ç°ï¼Œå…¶å†…éƒ¨å¹¶æ²¡æœ‰ä¸€ä¸ªTç±»å‹çš„æŒ‡é’ˆæŒ‡å‘ä¼ å…¥çš„objectï¼Œåœ¨ç»™DisguisedPtrå˜é‡èµ‹å€¼æ—¶ï¼Œå…¶å®æ˜¯å°†ä¼ å…¥çš„å¯¹è±¡çš„åœ°å€è½¬åŒ–ä¸ºä¸€ä¸ªæ— ç¬¦å·æ•´æ•°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">DisguisedPtr&lt;T&gt;&amp; operator = (T* rhs) &#123;</span><br><span class="line">    value = disguise(rhs);</span><br><span class="line">    <span class="keyword">return</span> *this;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">uintptr_t</span> <span class="title function_">disguise</span><span class="params">(T* ptr)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> -(<span class="type">uintptr_t</span>)ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> T* <span class="title function_">undisguise</span><span class="params">(<span class="type">uintptr_t</span> val)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (T*)-val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸¾ä¾‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> SyncDisguise &#123;</span><br><span class="line">    DisguisedPtr&lt;Person&gt; object;</span><br><span class="line">    int32_t threadCount;</span><br><span class="line">&#125; SyncDisguise;</span><br><span class="line">    </span><br><span class="line">SyncDisguise myStruct;</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">XQContainer</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)testDisguise &#123;</span><br><span class="line">    Person *li = [Person new];</span><br><span class="line">    li.name = <span class="string">@&quot;li&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    myStruct.threadCount = <span class="number">1</span>;</span><br><span class="line">    myStruct.object = li;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;disguise1: %p&quot;</span>, &amp;myStruct);</span><br><span class="line">    </span><br><span class="line">    Person *pox = (Person *)myStruct.object; <span class="comment">//éœ€è¦åœ¨MRCä¸‹ï¼ŒARCä¸‹ç¼–è¯‘é€šä¸è¿‡</span></span><br><span class="line">    </span><br><span class="line">    [li release];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>DisguisedPtré‡è½½äº†èµ‹å€¼æ“ä½œç¬¦ï¼Œå› æ­¤myStruct.object = li;ä¼šè°ƒç”¨<code>DisguisedPtr&lt;T&gt;&amp; operator = (T* rhs)</code>ï¼Œè€Œè¯¥å‡½æ•°å†…éƒ¨æ˜¯å°†ä¼ å…¥çš„å¯¹è±¡åœ°å€è½¬åŒ–ä¸ºäº†ä¸€ä¸ªæ— ç¬¦å·æ•´æ•°ï¼Œè¿™æ ·å°±æŠŠä¸€ä¸ªå¯¹è±¡çš„åœ°å€ç»™éšè—èµ·æ¥äº†ã€‚ä¸ä¹‹ç›¸åçš„æ“ä½œæ˜¯è§£ä¼ªè£…ï¼šå°†ä¸€ä¸ªæ— ç¬¦å·æ•´æ•°è½¬åŒ–ä¸ºä¸€ä¸ªå¯¹è±¡åœ°å€</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> T* <span class="title function_">undisguise</span><span class="params">(<span class="type">uintptr_t</span> val)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (T*)-val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨<code>Person *pox = (Person *)myStruct.object;</code>ä¼šè°ƒç”¨<code>undisguise</code>å‡½æ•°è¿›è¡Œè§£ä¼ªè£…ï¼Œäºæ˜¯åˆå¯ä»¥é‡æ–°è·å–åˆ°å¯¹è±¡çš„åœ°å€ã€‚</p>
<p><code>DisguisedPtr&lt;Person&gt; object;</code>ç±»ä¼¼äº<code>Person *</code>ä½†å¹¶ä¸æ˜¯çœŸæ­£çš„<code>Person *</code>ï¼Œå› æ­¤myStructå¹¶ä¸ä¼šæŒæœ‰ä¼ å…¥çš„å¯¹è±¡ï¼Œåœ¨ARCä¸‹testDisguiseæ–¹æ³•æ‰§è¡Œå®ŒåPersonå¯¹è±¡å°±é‡Šæ”¾é”€æ¯äº†ã€‚</p>
<p>æ€»ç»“ï¼šSyncDataå¯¹è±¡è™½ç„¶ä¼šè¢«ç¼“å­˜è€Œä¸€ç›´å­˜æ´»ï¼Œä½†SyncDataå¯¹è±¡å¹¶æ²¡æœ‰æŒæœ‰ä¼ å…¥çš„objectå¯¹è±¡ï¼Œå› æ­¤objectå¯¹è±¡ä¼šæ­£å¸¸çš„é‡Šæ”¾ã€‚</p>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p><code>@synchronized (obj)&#123;...&#125;</code>å°±æ˜¯æ ¹æ®ä¼ å…¥çš„objè·å–åˆ°ä¸€æŠŠé€’å½’é”ï¼Œåœ¨ä»£ç å—å¼€å§‹å¤„å…ˆåŠ é”ï¼Œä»£ç å—æ‰§è¡Œå®Œåå†è§£é”ã€‚ä¼ nilï¼Œåˆ™ä¸åŠ é”ã€‚</p>
<p>åˆ°æ­¤ä¸ºæ­¢æˆ‘ä»¬å¯ä»¥å›ç­”ä¸€ä¸‹å¼€å¤´çš„å‡ ä¸ªé—®é¢˜</p>
<p>1.é”æ˜¯å¦‚ä½•ä¸ä½ ä¼ å…¥ <code>@synchronized</code> çš„å¯¹è±¡å…³è”ä¸Šçš„ï¼Ÿ</p>
<p>è¿™ä¸ªå°±æ˜¯id2dataå‡½æ•°çš„å·¥ä½œæµç¨‹äº†ï¼š</p>
<ul>
<li><p>ä»TLSï¼ˆThread Local Storageï¼Œçº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼‰ä¸­çš„FastCacheç¼“å­˜ä¸­è·å–é”</p>
</li>
<li><p>ä»TLSä¸­çš„SyncCacheç¼“å­˜ä¸­è·å–é”</p>
</li>
<li><p>ä»å…¨å±€å˜é‡sDataListså“ˆå¸Œè¡¨ä¸­è·å–é”ï¼ˆå¤ç”¨çš„å¯¹è±¡ï¼‰ï¼Œå¹¶åŠ å…¥åˆ°FastCacheç¼“å­˜æˆ–SyncCacheç¼“å­˜</p>
</li>
<li><p>éƒ½æ²¡æœ‰åˆ™æ–°åˆ›å»ºä¸€æŠŠé”ï¼Œå¹¶æ·»åŠ åˆ°sDataListså“ˆå¸Œè¡¨ä¸­çš„å¯¹åº”å•é“¾è¡¨ä¸­ä»¥åŠåŠ å…¥åˆ°FastCacheç¼“å­˜æˆ–SyncCacheç¼“å­˜</p>
</li>
</ul>
<p>å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/%E6%88%AA%E5%B1%8F2023-03-27%2021.58.52.png" style="zoom: 50%;" /></p>
<p>2.<code>@synchronized</code>ä¼šä¿æŒï¼ˆretainï¼Œå¢åŠ å¼•ç”¨è®¡æ•°ï¼‰è¢«é”ä½çš„å¯¹è±¡ä¹ˆï¼Ÿ</p>
<p>MRCä¸‹ä¸ä¼šï¼ŒARCä¸‹ä¼šã€‚</p>
<p>å› ä¸º@synchronized{â€¦}ç­‰ä»·äº</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="type">id</span> _rethrow = <span class="number">0</span>; </span><br><span class="line">    <span class="type">id</span> _sync_obj = (<span class="type">id</span>)obj; </span><br><span class="line">    objc_sync_enter(_sync_obj);</span><br><span class="line">    try &#123;</span><br><span class="line">        <span class="keyword">struct</span> _SYNC_EXIT &#123;</span><br><span class="line">            _SYNC_EXIT(<span class="type">id</span> arg) : sync_exit(arg) &#123;&#125;</span><br><span class="line">            ~_SYNC_EXIT() &#123;objc_sync_exit(sync_exit);&#125;</span><br><span class="line">            <span class="type">id</span> sync_exit;</span><br><span class="line">        &#125; _sync_exit(_sync_obj);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NSLog</span>((<span class="built_in">NSString</span> *)&amp;__NSConstantStringImpl__var_folders_5z_1pxqzfcn77s2n7z4gmr63sdr0000gn_T_main_4eec76_mi_0);</span><br><span class="line">    &#125; catch (<span class="type">id</span> e) &#123;</span><br><span class="line">      _rethrow = e;</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">struct</span> _FIN &#123;</span><br><span class="line">            _FIN(<span class="type">id</span> reth) : rethrow(reth) &#123;&#125;</span><br><span class="line">            ~_FIN() &#123; <span class="keyword">if</span> (rethrow) objc_exception_throw(rethrow); &#125;</span><br><span class="line">            <span class="type">id</span> rethrow;</span><br><span class="line">        &#125; _fin_force_rethow(_rethrow);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€Œid _sync_obj = (id)obj;åœ¨MRCä¸‹è¿™ä»…ä»…æ˜¯ä¸€ä¸ªèµ‹å€¼è¯­å¥å› æ­¤objçš„å¼•ç”¨è®¡æ•°ä¸å˜ï¼Œä½†åœ¨ARCä¸‹ç¼–è¯‘åä¼šæ’å…¥ä¸€æ¡retainè¯­å¥ã€‚å½“@synchronizedä»£ç å—æ‰§è¡Œå®Œåï¼Œä¸´æ—¶å˜é‡é”€æ¯æ—¶åˆä¼šé‡Šæ”¾å¯¹è±¡ã€‚å› æ­¤ARCä¸‹åœ¨@synchronizedä»£ç å—å†…åŒæ­¥å¯¹è±¡æ˜¯è¢«å¼ºå¼•ç”¨çš„ï¼Œä»£ç å—æ²¡æ‰§è¡Œå®ŒåŒæ­¥å¯¹è±¡æ˜¯ä¸ä¼šè¢«é”€æ¯çš„ã€‚</p>
<p>å¯ä»¥æ‰“å°ä¸‹å¼•ç”¨è®¡æ•°ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)test_synchronized_retain_obj1 &#123;</span><br><span class="line">    <span class="built_in">NSObject</span> *obj = [<span class="built_in">NSObject</span> new];</span><br><span class="line">    printf(<span class="string">&quot;1retain count = %ld\n&quot;</span>, <span class="built_in">CFGetRetainCount</span>((__bridge <span class="built_in">CFTypeRef</span>)(obj))); <span class="comment">//1</span></span><br><span class="line">    <span class="keyword">@synchronized</span> (obj) &#123;</span><br><span class="line">        printf(<span class="string">&quot;2retain count = %ld\n&quot;</span>, <span class="built_in">CFGetRetainCount</span>((__bridge <span class="built_in">CFTypeRef</span>)(obj))); <span class="comment">//2</span></span><br><span class="line">    &#125;</span><br><span class="line">    printf(<span class="string">&quot;3retain count = %ld\n&quot;</span>, <span class="built_in">CFGetRetainCount</span>((__bridge <span class="built_in">CFTypeRef</span>)(obj))); <span class="comment">//1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.å‡å¦‚ä½ ä¼ å…¥ <code>@synchronized</code> çš„å¯¹è±¡åœ¨ <code>@synchronized</code> çš„ä»£ç å—é‡Œé¢è¢«èµ‹å€¼ä¸º <code>nil</code> å°†ä¼šæ€ä¹ˆæ ·ï¼Ÿ</p>
<p>å¯¹æœ¬æ¬¡åŠ è§£é”ä¸ä¼šé€ æˆå½±å“ï¼Œä½†æ˜¯å½“è¢«ç½®ä¸ºnilåï¼Œå¦‚æœæ­¤æ—¶æ°å¥½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°@synchronizedï¼Œé‚£ä¹ˆ@synchronized(obj) ç›¸å½“äº@synchronized(nil)å³æ— é”çŠ¶æ€ï¼Œäºæ˜¯ä¼šå¯¼è‡´å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ä¸´ç•ŒåŒºä»£ç ï¼Œé€ æˆçº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</p>
<p>4.ç»™@synchronized()ä¼ å…¥nilä¼šæ€æ ·ï¼Ÿ</p>
<p>@synchronized(nil)ç­‰äºæ²¡åŠ é”ï¼Œä»£ç å—å†…çš„ä»£ç å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼Œä¼šé€ æˆçº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</p>
<h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><p><a href="https://jianli2017.top/wiki/IOS/Runtime/objc/18_syncsize/">@synchronized å†…å¹•æ­ç§˜</a>   synchronizedé”çš„æºç åˆ†æ</p>
<p><a href="http://yulingtianxia.com/blog/2015/11/01/More-than-you-want-to-know-about-synchronized/">å…³äº @synchronizedï¼Œè¿™å„¿æ¯”ä½ æƒ³çŸ¥é“çš„è¿˜è¦å¤š </a>   å¾ˆä¸é”™ï¼Œå›½å¤–çš„ç¨‹åºå‘˜å†™çš„ï¼Œå°¤å…¶æ˜¯æå‡ºçš„å‡ ä¸ªé—®é¢˜</p>
<p>å…³äºtry-catchå†…å­˜ç®¡ç†çš„</p>
<p><a href="https://blog.csdn.net/lvmaker/article/details/88723115">iOS try-catch memory leakè¯¦è§£</a></p>
<p><a href="https://yingkong1987.github.io/blog/2014/01/11/bewareofmemorymanagementwithexception-safe.html">å¼‚å¸¸å®‰å…¨ä»£ç çš„å†…å­˜ç®¡ç†éœ€è°¨æ…!</a></p>
<p>å…³äºTLSçš„</p>
<p><a href="https://yq.aliyun.com/articles/691215">çº¿ç¨‹å±€éƒ¨å­˜å‚¨</a></p>
]]></content>
      <categories>
        <category>å¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>synchronized</tag>
      </tags>
  </entry>
  <entry>
    <title>MacBook Proå¤–æ¥æ˜¾ç¤ºå™¨(äº”)ä¹‹æˆ‘çš„ç”µè„‘çƒ§åäº†</title>
    <url>/2021/07/28/MacBook%20Pro%E5%A4%96%E6%8E%A5%E6%98%BE%E7%A4%BA%E5%99%A8(%E4%BA%94)%E4%B9%8B%E6%88%91%E7%9A%84%E7%94%B5%E8%84%91%E7%83%A7%E5%9D%8F%E4%BA%86/</url>
    <content><![CDATA[<p>åˆæ˜¯ä¸€ä¸ªå®‰é™çš„æ™šä¸Šï¼Œæˆ‘çš„MacBook Proå’Œå¾€å¸¸ä¸€æ ·å¤–æ¥ç€ä¸€ä¸ª4kçš„æ˜¾ç¤ºå±çœ‹ç€ç”µè§†ï¼Œçªç„¶å±å¹•é»‘å±ï¼Œæ‘¸äº†ä¸€ä¸‹ç”µè„‘ã€æ‰©å±•åéƒ½æŒºçƒ­çš„ï¼Œç„¶åèµ¶ç´§æ‹”æ‰å¤–æ¥æ˜¾ç¤ºå™¨ï¼ŒæŒ‰äº†å‡ ä¸‹å¼€æœºé”®å‘ç°å¼€ä¸äº†æœºäº†ã€‚</p>
<p>ç­‰ç”µè„‘å‡‰ä¸‹æ¥åï¼Œå°è¯•äº†ç½‘ä¸Šè¯´çš„å„ç§ç»„åˆé”®åï¼Œè¿˜æ˜¯å¼€ä¸äº†æœºã€‚é¡¿æ„Ÿå¤§äº‹ä¸å¦™ï¼Œå¤§æ¦‚ç‡æ˜¯ä¸»æ¿çƒ§åäº†ã€‚é¢„çº¦äº†å‘¨æœ«å»å¤©æ‰å§ï¼Œåˆ°äº†ä¹‹åç»™å·¥ä½œäººå‘˜è¯´æ˜äº†ä¸‹æƒ…å†µï¼Œå·¥ä½œäººå‘˜è¯´è¦å»æ£€æŸ¥ä¸‹æ‰çŸ¥é“ï¼Œå¤§æ¦‚20åˆ†é’Ÿåå·¥ä½œäººå‘˜å‘Šè¯‰æˆ‘ç¡®å®æ˜¯ä¸»æ¿çƒ§åäº†ï¼Œæˆ‘é—®è¿˜èƒ½ä¸èƒ½ä¿®ï¼Œä»–å›å¤è¯´å› ä¸ºæ˜¯14å¹´çš„æ—§æ¬¾äº†å·²ç»æ²¡æœ‰é…ä»¶ä¿®äº†ã€‚æˆ‘åˆé—®å¦‚æœåˆ°å¤–é¢ä¿®å¤§æ¦‚è¦å¤šå°‘é’±ï¼Œä»–è¯´ä»–ä¹Ÿä¸æ¸…æ¥šï¼Œè¯´å¦‚æœå¤ªè´µçš„è¯ä¸å»ºè®®æˆ‘ä¿®ï¼Œå»ºè®®æˆ‘ä¹°æ–°çš„ç”µè„‘ã€‚</p>
<p>æƒ³åˆ°ç”µè„‘ä¹Ÿç”¨äº†å·®ä¸å¤š6å¹´åŠäº†ï¼Œä¹Ÿå¯ä»¥æ¢ä¸€å°æ–°çš„äº†ï¼Œä½†çœŸè¦æ¢è¿˜æ˜¯æœ‰ç‚¹è‚‰ç–¼çš„ï¼Œçœ‹äº†ä¸€ä¸‹ä»·æ ¼åŸºæœ¬ä¸Šè¦1wå·¦å³ã€‚è€ƒè™‘äº†å‡ åˆ†é’Ÿï¼Œå†³å®šè¿˜æ˜¯å…ˆå›å»å§ï¼Œæ¢ç”µè„‘çš„äº‹å¾€åç¨ç¨ã€‚</p>
<p>å“ï¼Œä»4æœˆä»½ä¹°äº†4kæ˜¾ç¤ºå±åˆ°ç°åœ¨ä¸€å…±ç”¨äº†å·®ä¸å¤š3ä¸ªæœˆï¼Œç»“æœè·Ÿéšæˆ‘6å¹´åŠçš„ç”µè„‘æ²¡äº†ã€‚æˆ‘æƒ³äº†ä¸‹çƒ§åçš„åŸå› å¤§æ¦‚æœ‰è¿™ä¹ˆå‡ ç‚¹ï¼š</p>
<ol>
<li>ç”µè„‘ç¡®å®æœ‰ç‚¹æ—§äº†ã€‚å°±æ˜¯ä¸å¤–æ¥æ˜¾ç¤ºå™¨ï¼Œæµè§ˆå™¨çœ‹è§†é¢‘å¤šæ‰“å¼€å‡ ä¸ªï¼Œç”µè„‘éƒ½æœ‰äº›çƒ«æ‰‹ã€‚å¤–æ¥æ˜¾ç¤ºå™¨åå±å®å‹‰å¼ºå¸¦åŠ¨ï¼Œæ•£çƒ­è·Ÿä¸ä¸Šã€‚</li>
<li>ç”µè„‘è¿æ¥åˆ°å¤–æ¥æ˜¾ç¤ºå™¨é“¾è·¯å¤ªé•¿ã€‚ç”µè„‘â€”è½¬æ¥å¤´â€”æ‰©å±•åâ€”æ˜¾ç¤ºå™¨ã€‚å› ä¸ºä¹°æ‰©å±•åçš„æ—¶å€™æ²¡æ³¨æ„æ¥å£çš„é—®é¢˜ï¼Œå¯¼è‡´ä¸­é—´è¿˜æ¥äº†æ ¹è½¬æ¥å¤´ï¼Œé“¾è·¯å¤ªé•¿å„è®¾å¤‡çš„ç¨³å®šæ€§ï¼Œæ•£çƒ­ï¼Œå…¼å®¹æ€§é—®é¢˜éšæ‚£å°±ä¼šå¾ˆå¤§ã€‚</li>
<li>æ‰©å±•åä¸æ˜¯è‹¹æœåŸè£…çš„ï¼Œç”¨çš„å›½äº§çš„ç»¿è”ã€‚æ€ä¹ˆè¯´å‘¢æœ‰é’±çš„è¯æ‰©å±•åä¹‹ç±»çš„æœ€å¥½ç”¨åŸè£…çš„ï¼Œå›½äº§çš„é™¤äº†ä¾¿å®œå…¶ä»–çœŸä¸å¥½è¯´ï¼ŒæŠŠç”µè„‘çƒ§åäº†æ˜¯çœŸä¼¤ä¸èµ·ã€‚åæ¥æœäº†ä¸€ä¸‹ï¼Œç”¨ç»¿è”å¤–æ¥æ˜¾ç¤ºå™¨çƒ§åä¸»æœºçš„ä¸æ˜¯ä»€ä¹ˆç¨€å¥‡äº‹ï¼Œæ…é‡ã€‚</li>
</ol>
<p>æ€»ç»“ï¼š</p>
<ol>
<li>ç”µè„‘å¦‚æœç”¨äº†4,5å¹´äº†æœ€å¥½ä¸è¦å†å¤–æ¥å•¥è®¾å¤‡äº†ï¼Œç‰¹åˆ«æ˜¯ç”µè„‘ç¨å¾®å¤šå¼€å‡ ä¸ªåº”ç”¨å°±å‘çƒ­å‰å®³çš„è¯æœ€å¥½åˆ«å¤–æ¥äº†ã€‚</li>
<li>å¤–æ¥è®¾å¤‡æ—¶é“¾è·¯æœ€å¥½æœ€çŸ­ï¼Œæœ€å¥½æ˜¯ç”µè„‘â€”çº¿â€”æ˜¾ç¤ºå™¨å°±å®Œäº†ã€‚</li>
<li>å¦‚æœçœŸè¦æ‰©å±•åå•¥çš„é¦–é€‰åŸè£…ï¼Œæ¬¡é€‰å›½å¤–å¤§å“ç‰Œæ¯”å¦‚moshiå•¥çš„ã€‚</li>
</ol>
<p>åè®°ï¼š8æœˆä»½æ¢äº†æ–°ç”µè„‘ï¼Œå› ä¸ºç©·ä¹°çš„æ˜¯ä½é…ç‰ˆï¼Œæ¥å£ä¸€ç‚¹éƒ½ä¸ä¸°å¯Œï¼Œå°±ä¸¤ä¸ªé›·ç”µå£ï¼Œäºæ˜¯ä¹°äº†ä¸ªè‹¹æœåŸè£…çš„è½¬æ¥å¤´ï¼Œä¹‹å‰å¤–æ¥æ˜¯æ‰©å±•åï¼Œç”µè„‘éƒ½çƒ«æ‰‹ï¼Œç°åœ¨é™¤äº†è½¬æ¥å¤´æœ‰ç‚¹å‘çƒ­ï¼Œç”µè„‘å·²ç»ä¸å‘çƒ­äº†ã€‚ç°åœ¨å¤–æ¥æ˜¾ç¤ºå™¨ç»ˆäºæ˜¯4k@60hzäº†ï¼Œçºµäº«ä¸æ»‘ã€‚</p>
]]></content>
      <categories>
        <category>Life</category>
      </categories>
  </entry>
  <entry>
    <title>iOSæ¨é€è¯ä¹¦æ›´æ–°</title>
    <url>/2021/07/09/iOS%E6%8E%A8%E9%80%81%E8%AF%81%E4%B9%A6%E6%9B%B4%E6%96%B0/</url>
    <content><![CDATA[<p>é¦–å…ˆç¡®ä¿ä½ ç™»å½•çš„è´¦å·æƒé™è¦èƒ½å¤Ÿä¿®æ”¹è¯ä¹¦ã€‚</p>
<p><strong>å¯¼å‡ºp12æ–‡ä»¶</strong></p>
<p>æ‰“å¼€é’¥åŒ™ä¸²è®¿é—®ï¼Œç‚¹â€œç™»é™†â€”&gt;æˆ‘çš„è¯ä¹¦â€ï¼Œé€‰ä¸­åˆšå®‰è£…çš„é€šç”¨è¯ä¹¦ï¼ˆä¸å¸¦developmentçš„æ˜¯é€šç”¨ç¯å¢ƒï¼ˆå¼€å‘ï¼Œç”Ÿäº§éƒ½å¯ä»¥ç”¨ï¼‰ï¼‰ï¼Œå¯¼å‡ºä¸ºp12ï¼Œè®¾ç½®å¥½å¯†ç ï¼Œä¸Šä¼ åˆ°ä¸ªæ¨ç½‘ç«™ä¸Šã€‚ä¹Ÿå¯ä»¥åŒæ—¶ä¸Šä¼ ä¸“é—¨ç”¨äºå¼€å‘çš„p12ã€‚</p>
<p><strong>æ›´æ–°profilesæ–‡ä»¶</strong></p>
<p>æ›´æ–°æ¨é€è¯ä¹¦ååˆ«å¿˜äº†æ›´æ–°profileæ–‡ä»¶ã€‚é€‰ä¸­ä¾§è¾¹æ Profilesï¼Œé€‰ä¸­å¯¹åº”profileï¼Œè¿›å…¥åç‚¹å‡»editeï¼Œç„¶åå‹¾é€‰select allï¼Œç‚¹å‡»ä¿å­˜ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/iotjin/article/details/118302860">iOS - æ¨é€è¯ä¹¦æ›´æ–°ï¼ˆApple Developmentå’Œæå…‰ï¼‰</a></p>
<p><a href="https://www.jianshu.com/p/be9415a0a6fb?from=timeline">iOS æ¨é€è¯ä¹¦åŠ å…¥åˆ°é’¥åŒ™ä¸²å,æ— æ³•å¯¼å‡ºP12æ–‡ä»¶</a></p>
]]></content>
      <categories>
        <category>APPä¸Šæ¶</category>
      </categories>
      <tags>
        <tag>æ¨é€è¯ä¹¦æ›´æ–°</tag>
      </tags>
  </entry>
  <entry>
    <title>åšå®¢æ”¶è—</title>
    <url>/2021/07/08/%E5%8D%9A%E5%AE%A2%E6%94%B6%E8%97%8F/</url>
    <content><![CDATA[<p><a href="https://github.com/ming1016/study/wiki">ming1016-study</a>  ç½‘å‹ä¸ªäººæ”¶é›†çš„æ¯”è¾ƒå…¨çš„iOSå¼€å‘æŠ€æœ¯ç‚¹</p>
<p><a href="https://github.com/iOS-Mayday/heji">Mayday-heji</a>  iOSé¢è¯•ç›¸å…³çš„ï¼Œæœ‰åŠ ç¾¤å–å¹¿å‘Šå«Œç–‘</p>
<p><a href="https://xiaozhuanlan.com/">å°ä¸“æ </a> è´¨é‡è¾ƒé«˜ï¼Œä¸è¿‡å¤§éƒ¨åˆ†éƒ½è¦æ”¶è´¹ã€‚</p>
<h3 id="ä¸ªäººåšå®¢"><a href="#ä¸ªäººåšå®¢" class="headerlink" title="ä¸ªäººåšå®¢"></a>ä¸ªäººåšå®¢</h3><p><a href="http://oncenote.com/">Jamin</a></p>
<p><a href="https://www.desgard.com">Gua</a></p>
<p><a href="https://kingcos.me/">kingcos</a> </p>
<p><a href="https://tbfungeek.github.io">Edgar</a>  å®‰å“iOSä¸€ç³»åˆ—æ–‡ç« </p>
<p><a href="http://yulingtianxia.com/">yulingtianxiaâ€™s blog</a>  messageThrottleä½œè€…</p>
<p><a href="https://ai-chan.top/">é…·é…·çš„å“€æ®¿</a>   llvmã€æ±‡ç¼–ã€ç¼–è¯‘ã€åº•å±‚</p>
<p><a href="https://cloud.tencent.com/developer/user/2586061">çµé­‚ç”»å¸ˆç‰§ç </a>  åå°å¼€å‘ï¼ŒçŸ¥è¯†é¢å¹¿ï¼Œå­¦ä¹ è·¯çº¿</p>
<p><a href="https://www.junmajinlong.com/">éªé©¬é‡‘é¾™</a>  linuxï¼Œshell</p>
<p><a href="https://xaoxuu.com/">XAOXUU</a>  ç•Œé¢ä¸é”™</p>
<p><a href="https://wuqiuhao.github.io/">Haleâ€™s Blog</a> ç•Œé¢ä¸é”™</p>
<h3 id="å…¬å¸åšå®¢"><a href="#å…¬å¸åšå®¢" class="headerlink" title="å…¬å¸åšå®¢"></a>å…¬å¸åšå®¢</h3><p><a href="https://techblog.toutiao.com/">ä»Šæ—¥å¤´æ¡</a></p>
<p><a href="https://tech.meituan.com/">ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ</a></p>
<p><a href="https://buglydevteam.github.io/">BuglyæŠ€æœ¯å›¢é˜Ÿ</a></p>
<p><a href="https://sq.163yun.com/blog">ç½‘æ˜“äº‘</a></p>
<h3 id="ç®—æ³•"><a href="#ç®—æ³•" class="headerlink" title="ç®—æ³•"></a>ç®—æ³•</h3><p><a href="https://wizardforcel.gitbooks.io/the-art-of-programming-by-july/content/00.01.html">ç¼–ç¨‹çš„è‰ºæœ¯â€”gitbook</a></p>
]]></content>
      <categories>
        <category>å‚è€ƒèµ„æ–™</category>
      </categories>
      <tags>
        <tag>åšå®¢</tag>
      </tags>
  </entry>
  <entry>
    <title>MacBook Proå¤–æ¥æ˜¾ç¤ºå™¨(å››)ä¹‹4Kå±60Hzçš„è‰°éš¾æ—…ç¨‹</title>
    <url>/2021/04/20/MacBook%20Pro%E5%A4%96%E6%8E%A5%E6%98%BE%E7%A4%BA%E5%99%A8(%E5%9B%9B)%E4%B9%8B4K%E5%B1%8F60Hz%E7%9A%84%E8%89%B0%E9%9A%BE%E6%97%85%E7%A8%8B/</url>
    <content><![CDATA[<p>ä¸ºä»€ä¹ˆè¦è®©å¤–æ¥æ˜¾ç¤ºå™¨è¾¾åˆ°4K@60Hzçš„åˆ·æ–°ç‡ï¼Ÿ</p>
<p>å› ä¸º4K@30Hzçš„åˆ·æ–°ç‡é¼ æ ‡ç§»åŠ¨æ—¶ä¼šæœ‰æ˜æ˜¾çš„å»¶è¿Ÿæ„Ÿã€‚åˆ·æ–°ç‡è¶Šé«˜ç”»é¢æ‰èƒ½è¶Šä¸æ»‘ã€‚4Kçš„æ˜¾ç¤ºå±è‡³å°‘éœ€è¦60Hzçš„åˆ·æ–°ç‡ï¼Œå½“ç„¶å¦‚æœæ”¯æŒ144Hzçš„é‚£æ›´å¥½ã€‚å¯¹äºä¸€èˆ¬ç”¨æˆ·60HzåŸºæœ¬è¶³å¤Ÿã€‚</p>
<p>å¤–æ¥æ˜¾ç¤ºå™¨è¾¾åˆ°4K@60Hzåˆ·æ–°ç‡çš„æ¡ä»¶</p>
<p>ä¸»æœºæ”¯æŒï¼ˆä¸»è¦æ˜¯ä¸»æœºçš„æ˜¾å¡ï¼‰ï¼Œæ˜¾ç¤ºå™¨æ”¯æŒï¼Œçº¿ææ”¯æŒã€‚è¯¥æ¡ä»¶ç¬¦åˆæœ¨æ¡¶åŸç†åªè¦å…¶ä¸­ä¸€ä¸ªä¸æ»¡è¶³å°±æ— æ³•è¾¾åˆ°4K@60Hzçš„åˆ·æ–°ç‡ã€‚ä¸ºäº†åˆ°è¾¾è¿™ä¸ªç›®æ ‡éœ€è¦æˆ‘ä»¬å¯¹ä¸»æœºçš„ç«¯å£ï¼Œæ˜¾ç¤ºå™¨å‚æ•°ï¼Œçº¿æç­‰æœ‰ä¸€ä¸ªåŸºæœ¬çš„äº†è§£ã€‚ä¸‹é¢ä¸€ä¸ªä¸ªä»‹ç»ã€‚</p>
<p><strong>ä¸»æœºæ”¯æŒ</strong></p>
<p>æˆ‘çš„ç”µè„‘æ˜¯MacBook Pro 13å¯¸ 2014midçš„ã€‚å¯ä»¥ä»è‹¹æœå®˜ç½‘ <a href="https://support.apple.com/kb/sp703?locale=zh_CN">macbook pro 2014mid</a> æŸ¥åˆ°è¿™æ¬¾ç”µè„‘çš„å‚æ•°è¯´æ˜ï¼Œå¦‚ä¸‹ç«¯å£éƒ¨åˆ†æ˜¯æˆ‘ä»¬é‡ç‚¹å…³æ³¨çš„ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/1C147D43EA0F9787EC5FA06822136426.jpg" style="zoom:50%;" /></p>
<p>å¯ä»¥çœ‹åˆ°HDMIç«¯å£åªèƒ½è¾“å‡º60Hzçš„1080pã€‚è€Œ4Kçš„åªèƒ½åˆ°30Hzæˆ–24Hzã€‚æ‰€ä»¥æˆ‘ä»¬å°±ä¸èƒ½ä½¿ç”¨è¯¥ç«¯å£ä½œä¸ºè§†é¢‘è¾“å‡ºã€‚ç›¸åº”çš„æˆ‘ä»¬å°±ä¸èƒ½ä¹°HDMIï¼ˆä¸»æœºï¼‰â€”HDMIï¼ˆæ˜¾ç¤ºå™¨ï¼‰çº¿æˆ–HDMIâ€”DPçº¿æã€‚ä¸ç®¡è¿™æ ¹HDMIçº¿æ”¯æŒçš„ç‰ˆæœ¬æ˜¯å¤šå°‘éƒ½ä¸èƒ½ä¹°ã€‚ï¼ˆps:è¿™é‡Œçº¿æä½¿ç”¨â€ä¸»æœºç«¯å£â€”æ˜¾ç¤ºå™¨ç«¯å£â€œè¡¨ç¤ºï¼Œä¸‹åŒï¼‰</p>
<p>è€Œå¯¹äºThunderbolt2ç«¯å£æ”¯æŒåŸç”ŸMiniDPè¾“å‡ºï¼Œä½†æ²¡æœ‰å†™æ˜èƒ½å¦æ”¯æŒåˆ°4K@60Hzã€‚æå¾—æˆ‘ä¸€åº¦ä»¥ä¸ºé€šè¿‡MiniDPâ€”DPèƒ½è¾¾åˆ°4K@60Hzï¼Œç„¶è€Œæ¢äº†å‡ æ¬¡çº¿åå‘ç°è¿˜æ˜¯ä¸è¡Œï¼Œæœ€ååˆæœç´¢äº†å¥½ä¹…çš„èµ„æ–™åŸºæœ¬å¯ä»¥ç¡®å®šè¿™æ¬¾æœºå™¨ä¸ç®¡é€šè¿‡ä»€ä¹ˆç«¯å£éƒ½ä¸èƒ½è¾¾åˆ°4K@60Hzã€‚æ‰€ä»¥å¦‚æœæŠ€æœ¯è§„æ ¼é‡Œæ²¡å†™æ˜çš„è¯åŸºæœ¬ä¸Šæ˜¯æ”¯æŒä¸äº†çš„ã€‚</p>
<p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹2015å¹´ä¸­çš„15å¯¸çš„mbpçš„æŠ€æœ¯è§„æ ¼ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20210420095501.png" alt=""></p>
<p>è¿™é‡Œé€šè¿‡é›·é›³æ•°å­—è§†é¢‘è¾“å‡ºå†™äº†æ”¯æŒé«˜è¾¾5K@60Hzçš„å¤–æ¥æ˜¾ç¤ºå±å¹¶ä¸”è¿˜å¾—æ˜¯é…å¤‡AMDçš„æœºå‹ï¼Œå› æ­¤è¿™æ¬¾ç”µè„‘æ‰æœ‰å¯èƒ½é€šè¿‡é›·ç”µç«¯å£è¾¾åˆ°4K@60Hzï¼ŒåŒæ ·å¦‚æœä½¿ç”¨HDMIç«¯å£åˆ™åªèƒ½åˆ°4K@30Hzã€‚ç›¸åº”çš„çº¿æåªèƒ½ä¹°MiniDPâ€”DPæˆ–MiniDPâ€”HDMIã€‚</p>
<p>å°ç»“ï¼šç”±äºä¸»æœºä¸æ”¯æŒï¼Œæ‰€ä»¥åé¢æŠ˜è…¾äº†å¥½å‡ æ ¹MiniDPâ€”DPçº¿æè¿˜æ˜¯æ²¡ç”¨ï¼Œæå¾—å¿ƒåŠ›äº¤ç˜ã€‚</p>
<p><strong>æ˜¾ç¤ºå™¨æ”¯æŒ</strong></p>
<p>æˆ‘çš„æ˜¾ç¤ºå™¨æ˜¯ä¸‰æ˜Ÿçš„LU28R55ï¼Œå¯ä»¥å»å®˜ç½‘æŸ¥ä¸€ä¸‹å®ƒçš„å‚æ•°ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20210418000306.png" style="zoom:50%;" /></p>
<p>å¯ä»¥çœ‹åˆ°æ˜¾ç¤ºå™¨æ˜¯æ”¯æŒ4K@60Hzçš„ã€‚å†çœ‹ä¸€ä¸‹æ˜¾ç¤ºå™¨æä¾›çš„ç«¯å£ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20210418000540.png" style="zoom:50%;" /></p>
<p>æä¾›ä¸€ä¸ª1.2ç‰ˆæœ¬çš„DPæ¥å£ï¼Œå’Œä¸¤ä¸ª2.0ç‰ˆæœ¬çš„HDMIç«¯å£ã€‚æä¾›çš„é…ä»¶ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20210418000742.png" style="zoom:50%;" /></p>
<p>åªæä¾›äº†ä¸€æ ¹HDMIâ€”HDMIçº¿ã€‚</p>
<p><strong>çº¿ææ”¯æŒ</strong></p>
<p>å¦‚æœä½ çš„mbpæ˜¯æ—§æ¬¾çš„å¹¶ä¸”ç¡®å®šæ”¯æŒ4K@60Hzï¼Œé‚£ä¹ˆä¸»æœºæœ€å¥½ä½¿ç”¨MiniDPç«¯å£è¾“å‡ºï¼Œè€Œæ˜¾ç¤ºå™¨å¯ä»¥ä½¿ç”¨DPæˆ–HDMIç«¯å£ã€‚å› æ­¤çº¿æçš„é€‰æ‹©åŸºæœ¬å°±å¾ˆæ˜ç¡®äº†ï¼šéœ€è¦ä¸€æ ¹MiniDPâ€”DPçš„çº¿æˆ–MiniDPâ€”HDMIçš„çº¿ã€‚è¿™æ ¹çº¿çš„DPéœ€è¦æ˜¯1.2ç‰ˆæœ¬åŠä»¥ä¸Šï¼Œæˆ–è€…HDMIéœ€è¦2.0ç‰ˆæœ¬åŠä»¥ä¸Šã€‚å…·ä½“ä¹°å“ªç§ä¸»è¦çœ‹ä½ çš„æ˜¾ç¤ºå™¨æä¾›çš„ç«¯å£ä¸°ä¸ä¸°å¯Œï¼Œæ‰€ä»¥ä¹°æ˜¾ç¤ºå™¨æˆ–ç”µè„‘çš„æ—¶å€™ç«¯å£çš„ä¸°å¯Œç¨‹åº¦ä¹Ÿæ˜¯ä¸€ä¸ªé‡è¦çš„è€ƒè™‘ç‚¹ã€‚</p>
<p>ä¹°çº¿ç»å†ï¼š<br>ä¹°æ˜¾ç¤ºå™¨çš„æ—¶å€™æ²¡æœ‰æ³¨æ„æ˜¾ç¤ºå™¨æ˜¯é™„å¸¦ä¸€æ¡HDMIâ€”HDMIçº¿çš„ï¼Œç„¶åå¤šä¹°äº†ä¸€æ ¹HDMIâ€”HDMI2.0ç‰ˆæœ¬çš„çº¿30Â¥ã€‚å¤–æ¥é”®ç›˜å’Œé¼ æ ‡åå‘ç°USBç«¯å£ç”¨å®Œäº†ï¼Œäºæ˜¯æƒ³ä¹°ä¸ªæ‰©å±•åä½†å½“æ—¶å¹¶ä¸æ¸…æ¥šç«¯å£çš„ç§ç±»ï¼Œä¹°äº†ä¸ªtype-cå…¬å¤´çš„æ‰©å±•å149Â¥ï¼Œç»“æœå‘ç°ç”µè„‘æ²¡æœ‰Type-Cå£ï¼Œä¸æƒ³é€€äº†ï¼Œäºæ˜¯åˆä¹°äº†ä¸ªUSBè½¬Type-Cæ¯çš„è½¬æ¥å™¨30Â¥ã€‚å¤šèŠ±äº†130Â¥ã€‚</p>
<p>ç”±äºåˆšå¼€å§‹çš„æ—¶å€™ä¸çŸ¥é“ä¸»æœºä¸æ”¯æŒ4K@60Hzï¼Œç„¶åè¯•äº†ç»¿è”å’Œmoshiçš„MiniDPâ€”DPçº¿ç»“æœè‡ªç„¶æ˜¯éƒ½ä¸è¡Œï¼Œåªå¥½éƒ½é€€äº†ã€‚å¦å¤–ä¹°çº¿æˆ–æ‰©å±•åçš„æ—¶å€™ä¸€å®šè¦çœ‹æ¸…æ¥šèƒ½åˆ°å¤šå°‘Hzå’Œçº¿ç«¯å£çš„ç‰ˆæœ¬ã€‚æ‰¾çº¿æœŸé—´çœ‹äº†ä¸€ä¸‹ç»¿è”çš„MiniDPâ€”HDMIçš„çº¿çš„ä»‹ç»åªèƒ½ç”¨å¾ˆè®²ç©¶æ¥å½¢å®¹äº†çœŸæ­£åšåˆ°äº†çœŸè¯è¯´ä¸€åŠï¼Œå‡è¯å…¨ä¸è¯´çš„å¢ƒç•Œã€‚ä»‹ç»è¯´æ˜¯æ”¯æŒ4Kä½†ä¸è¯´èƒ½åˆ°å¤šå°‘Hzåæ­£æˆ‘æ‰¾éæ•´ä¸ªè¯¦æƒ…ä¹Ÿæ²¡çœ‹åˆ°ã€‚äº‹å®ä¸Šå®ƒçš„å¤–åŒ…è£…æ ‡çš„æ˜¯åªæ”¯æŒ30Hzçš„ï¼Œä¸çŸ¥é“ä¸ºå•¥ä¸åœ¨è¯¦æƒ…é¡µæ ‡æ˜ã€‚</p>
<p>psï¼šæ˜¾ç¤ºå™¨çš„ä¿¡æ¯é‡Œï¼š67.5kHz 30Hzçš„å«ä¹‰æ˜¯ï¼š67.5kHzï¼šè¡¨ç¤ºä¼ è¾“ç ç‡ï¼ˆåˆ†è¾¨ç‡è¶Šé«˜ç ç‡è¶Šé«˜ï¼‰ 30Hzï¼šè¡¨ç¤ºåˆ·æ–°ç‡ï¼Œå°±æ˜¯æ¯ç§’å¸§æ•°ã€‚</p>
<p>æ€»ç»“ï¼š</p>
<p>1.å¯¹äºæ¶ˆè´¹è€…è€Œè¨€ä¸è¦çœ‹å•†å®¶è¯´äº†ä»€ä¹ˆè€Œæ˜¯è¦çœ‹ä»–æ²¡è¯´ä»€ä¹ˆï¼Œè‡ªå·±çš„éœ€æ±‚æ˜¯ä»€ä¹ˆã€‚è¿™æ ·æ‰èƒ½ä¸è¢«é‚£äº›èŠ±é‡Œèƒ¡å“¨çš„ä¿¡æ¯æ·¹æ²¡è‡ªå·±ã€‚</p>
<p>ç›®å‰ç”¨ç€æ˜¾ç¤ºå™¨è‡ªå¸¦çš„HDMIâ€”HDMIçº¿ï¼Œåªèƒ½åˆ°4K@30Hzã€‚å› ä¸ºç”µè„‘ä¸æ”¯æŒ4K@60Hzï¼Œä¹Ÿå°±ä¸æŠ˜è…¾äº†ã€‚4Kå±çš„60Hzè‰°éš¾ä¹‹æ—…åˆ°æ­¤ç»“æŸã€‚</p>
<p><strong>å‚è€ƒ</strong></p>
<p><a href="https://helpdeskgeek.com/help-desk/how-is-4k-different-from-uhd-and-2160p/">How Is 4K Different From UHD and 2160p?</a></p>
<p><a href="https://support.apple.com/zh-cn/HT201736">è¯†åˆ« Mac ä¸Šçš„ç«¯å£</a></p>
<p><a href="https://www.mf8.biz/wo-de-4k-screen-biji/">æˆ‘çš„ 4K å¤–æ¥æ˜¾ç¤ºå™¨ç¬”è®°</a></p>
<p><a href="https://www.expreview.com/56309.html">æ˜¾ç¤ºå™¨åˆ·æ–°ç‡ä¸Šä¸å»ï¼Ÿå¯èƒ½æ˜¯çº¿æã€æ¥å£çš„é”…</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/268572741">Mac å¤–æ¥æ˜¾ç¤ºå™¨è¯¦ç»†åˆ†æä¸æ¨è 2021</a></p>
<p><a href="https://support.apple.com/zh-cn/HT201300">è¯†åˆ« MacBook Pro æœºå‹</a></p>
<p>â€‹                                    </p>
]]></content>
      <categories>
        <category>Life</category>
      </categories>
  </entry>
  <entry>
    <title>MacBook Proå¤–æ¥æ˜¾ç¤ºå™¨(ä¸‰)ä¹‹Macä¸Šçš„SwitchResXå®Œå…¨å¸è½½</title>
    <url>/2021/04/17/MacBook%20Pro%E5%A4%96%E6%8E%A5%E6%98%BE%E7%A4%BA%E5%99%A8(%E4%B8%89)%E4%B9%8BMac%E4%B8%8A%E7%9A%84SwitchResX%E5%AE%8C%E5%85%A8%E5%8D%B8%E8%BD%BD/</url>
    <content><![CDATA[<p>æœ€è¿‘åœ¨æŠ˜è…¾å¤–æ¥æ˜¾ç¤ºå™¨ï¼Œä¸€ç›´è¾¾ä¸åˆ°4k@60hzã€‚ç„¶åç¨€é‡Œç³Šæ¶‚å®‰è£…äº†SwitchResXã€‚SwitchResXæ˜¯å¹²ä»€ä¹ˆçš„è¿™é‡Œå°±ä¸å¤šè¯´äº†ï¼Œæœ¬æ–‡ä¸»è¦è®²ä¸€ä¸‹æ€ä¹ˆå¸è½½ã€‚</p>
<p>åœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­ç‚¹å‡»ç§»é™¤å°±å®Œäº‹äº†ï¼Œä½†äº‹å®å¹¶æ²¡æœ‰è¿™ä¹ˆç®€å•ã€‚è™½ç„¶å¸è½½äº†ä½†æ˜¯æ‰“å¼€æ˜¾ç¤ºå™¨ä¼šå‘ç°æ˜¾ç¤ºå™¨çš„åç§°ä¸­è¿˜æ˜¯å¸¦æœ‰SwitchResXè€Œä¸æ˜¯é»˜è®¤çš„ï¼š</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1503319-b237f40e28001761.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p>è¿™è¯´æ˜SwitchResXè™½ç„¶å¸è½½äº†ä½†æ˜¯è¿˜æ®‹ç•™äº†ä¸€äº›æ–‡ä»¶ã€‚é‚£ä¹ˆå¦‚ä½•æ¢å¤æ˜¾ç¤ºå™¨çš„é»˜è®¤åç§°å‘¢ï¼Ÿè¿™ä¸ªé—®é¢˜å®åœ¨æ˜¯æœ‰ç‚¹å†·é—¨ï¼ŒèŠ±äº†æˆ‘å¥½å‡ ä¸ªå°æ—¶æ‰æœåˆ°è§£å†³åŠæ³•ï¼Œä¸»è¦æ˜¯ä¸çŸ¥é“è¯¥æ€ä¹ˆæœé—®é¢˜çš„å…³é”®å­—ã€‚æœä¸ªå¸è½½å‡ºæ¥çš„éƒ½æ˜¯è®©ä½ å®‰è£…æ¸…ç†è½¯ä»¶APPçš„ã€‚</p>
<p>æœ€ç»ˆè§£å†³åŠæ³•å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç¡®ä¿å·²ç»é€€å‡ºSwitchResXï¼Œç„¶ååœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­ç‚¹å‡»ç§»é™¤åˆ é™¤APPåŒ…</li>
<li><code>/Library/Displays/Contents/Resources/Overrides</code> é‡Œçš„æ–‡ä»¶å…¨éƒ¨åˆ æ‰</li>
<li><code>/Library/Colorsync/Profiles/Displays</code> åˆ æ‰SwitchReså¼€å¤´çš„</li>
<li>é‡å¯ç”µè„‘</li>
</ol>
<p>psï¼šè¿å¸¦çš„MonitorControlçªç„¶æ— æ³•ä½¿ç”¨æç¤ºâ€œæœªå‘ç°æ”¯æŒçš„æ˜¾ç¤ºå™¨â€çš„é—®é¢˜ä¹Ÿè§£å†³äº†ï¼ˆä¸€åº¦ä»¥ä¸ºæ˜¯å‡çº§åˆ°Big Surç³»ç»Ÿå¯¼è‡´ï¼‰ã€‚çœŸæ­£åŸå› ä¼°è®¡å°±æ˜¯SwitchResXæ”¹äº†æ˜¾ç¤ºå™¨çš„åç§°å¯¼è‡´ã€‚</p>
<p>æ€»ç»“ï¼š<br>1.Macä¸­åˆ é™¤ä¸€ä¸ªAPPï¼Œç³»ç»Ÿåªæ˜¯åˆ æ‰äº†è¿™ä¸ªåº”ç”¨ï¼Œä½†æ˜¯è¿™ä¸ªåº”ç”¨åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸€äº›æ–‡ä»¶å¹¶ä¸ä¼šè¢«åˆ é™¤ã€‚<br>ä¸€ä¸ªAPPåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­æˆ–å¤šæˆ–å°‘ä¼šäº§ç”Ÿä¸€äº›æ–‡ä»¶æ¯”å¦‚ç¼“å­˜ï¼Œä½†è¿™äº›ç¼“å­˜ä¸€èˆ¬å¯¹æˆ‘ä»¬çš„ä½¿ç”¨ä¸ä¼šäº§ç”Ÿå½±å“é¡¶å¤šå ç”¨äº†ä¸€äº›ç£ç›˜ç©ºé—´ï¼Œä½†æœ‰äº›APPä¼šäº§ç”Ÿä¸€äº›é…ç½®æ–‡ä»¶è¿™å°±å¯¼è‡´å³ä½¿åˆ é™¤äº†è¿™ä¸ªAPPï¼Œåªè¦å®ƒçš„é…ç½®æ–‡ä»¶è¿˜åœ¨é‚£ä¹ˆå°±ä¼šå­˜åœ¨å‰¯ä½œç”¨ã€‚å› æ­¤è¦æƒ³å½»åº•å¸è½½ä¸€ä¸ªåº”ç”¨é™¤äº†åˆ æ‰è¿™ä¸ªåº”ç”¨è¿˜è¦æŠŠå®ƒä½¿ç”¨è¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ–‡ä»¶ä¹Ÿè¦åˆ é™¤æ‰æ‰è¡Œã€‚è‡³äºAPPä¼šåœ¨å“ªäº›ç›®å½•äº§ç”Ÿå“ªäº›æ–‡ä»¶é‚£å°±åªèƒ½ç½‘ä¸Šæœç´¢äº†ã€‚<br>2.å¦‚æœä½ æƒ³è®¾ç½®åˆ†è¾¨ç‡çš„è¯è¿˜ä¸å¦‚ç”¨EasyResï¼Œç›®å‰è¿˜æ²¡çœ‹åˆ°æœ‰å•¥é—®é¢˜ã€‚<br>3.è‹±è¯­å¥½è¿˜æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚åœ¨æœä¸€äº›é—®é¢˜çš„æ—¶å€™ç›´æ¥ä¸Šè‹±æ–‡å…³é”®å­—æ¯”ä¸­æ–‡çš„å¥½å¤šäº†ã€‚ç”¨ä¸­æ–‡æœå¯èƒ½æ¥æ¥å›å›éƒ½æ˜¯é‚£å‡ ç¯‡è¿˜æ˜¯æŠ„æ¥æŠ„å»çš„ã€‚</p>
<p><strong>å‚è€ƒ</strong><br><a href="https://discussions.apple.com/thread/7053660">how reset my display profile itâ€™s show â€œSwitchResX4 - Color LCDâ€</a><br>æœ‰ä¸€ä¸ªäººçš„å›ç­”ï¼š<br><figure class="highlight vbnet"><table><tr><td class="code"><pre><span class="line">It<span class="comment">&#x27;s not a problem. SwitchResX is doing that on purpose, and for absolutely no good reason.</span></span><br><span class="line"></span><br><span class="line">The app doesn<span class="comment">&#x27;t do anything useful. Correctly and entirely delete SwitchResX according to the instructions </span></span><br><span class="line"><span class="keyword">on</span> their site <span class="built_in">and</span> your issue should be solved. Though after its removal, you<span class="comment">&#x27;ll have to empty out the Displays </span></span><br><span class="line">profile folder again so the OS can pull another <span class="built_in">new</span> copy <span class="keyword">of</span> the <span class="keyword">default</span> display profile that won<span class="comment">&#x27;t be tagged </span></span><br><span class="line"><span class="keyword">with</span> their application name.</span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>Life</category>
      </categories>
  </entry>
  <entry>
    <title>MacBook Proå¤–æ¥æ˜¾ç¤ºå™¨(äºŒ)ä¹‹MacBook Proå¤–æ¥é”®ç›˜æ§åˆ¶å¤–æ¥æ˜¾ç¤ºå™¨äº®åº¦å’Œå£°éŸ³</title>
    <url>/2021/04/07/MacBook%20Pro%E5%A4%96%E6%8E%A5%E6%98%BE%E7%A4%BA%E5%99%A8(%E4%BA%8C)%E4%B9%8BMacBook%20Pro%E5%A4%96%E6%8E%A5%E9%94%AE%E7%9B%98%E6%8E%A7%E5%88%B6%E5%A4%96%E6%8E%A5%E6%98%BE%E7%A4%BA%E5%99%A8%E4%BA%AE%E5%BA%A6%E5%92%8C%E5%A3%B0%E9%9F%B3/</url>
    <content><![CDATA[<p>æœ€è¿‘ç»™æˆ‘çš„MacBook Proå¤–æ¥äº†æ˜¾ç¤ºå™¨å’Œé”®ç›˜ï¼Œæ˜¾ç¤ºå™¨æ˜¯ä¸‰æ˜Ÿçš„ LU28R55 ï¼Œé”®ç›˜æ˜¯æƒ æ™®çš„ã€‚<br>ä½†æ˜¯å‘ç°å¤–æ¥æ˜¾ç¤ºå™¨ã€é”®ç›˜åæœ‰å‡ ä¸ªå½±å“ä½“éªŒçš„é—®é¢˜ï¼š<br>1.å¤–æ¥çš„æ˜¾ç¤ºå™¨æ˜¯æ²¡æœ‰å†…ç½®æ‰¬å£°å™¨çš„éœ€è¦é¢å¤–æ¥ä¸ªéŸ³å“æ‰è¡Œï¼Œå¦åˆ™è®¾ç½®å£°éŸ³çš„è¾“å‡ºä¸ºå¤–æ¥æ˜¾ç¤ºå™¨ä¹Ÿæ²¡ç”¨ã€‚<br>2.å¤–æ¥çš„æ˜¾ç¤ºå™¨è°ƒèŠ‚äº®åº¦å’Œå£°éŸ³åªèƒ½ç”¨æ˜¾ç¤ºå™¨è‡ªå¸¦çš„æŒ‰é’®æŒ‰ï¼Œæ— æ³•é€šè¿‡é”®ç›˜æ§åˆ¶ã€‚</p>
<p>äºæ˜¯Googleäº†ä¸€ä¸‹å‘ç°ä½¿ç”¨ MonitorControl + Karabiner è¿™ä¸¤ä¸ªè½¯ä»¶å¯ä»¥è¾¾åˆ°å¤–æ¥é”®ç›˜æ§åˆ¶å¤–æ¥æ˜¾ç¤ºå™¨çš„äº®åº¦å’Œå£°éŸ³ã€‚<br>MonitorControlä¸‹è½½åœ°å€<br><a href="https://github.com/MonitorControl/MonitorControl/releases/tag/v2.1.0">https://github.com/MonitorControl/MonitorControl/releases/tag/v2.1.0</a></p>
<p>Karabinerä¸‹è½½åœ°å€<br><a href="https://github.com/pqrs-org/Karabiner-Elements/releases/tag/v13.4.0">https://github.com/pqrs-org/Karabiner-Elements/releases/tag/v13.4.0</a></p>
<p>MonitorControlçš„ä½œç”¨æ˜¯é€šè¿‡è½¯ä»¶æ§åˆ¶å¤–æ¥æ˜¾ç¤ºå™¨çš„äº®åº¦å’Œå£°éŸ³ã€‚</p>
<p>Karabinerçš„ä½œç”¨æ˜¯æŒ‰é”®æ˜ å°„ã€‚ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªAPPå‘¢ï¼Ÿå› ä¸ºå¤–æ¥æ˜¾ç¤ºå™¨åç¬”è®°æœ¬åŸºæœ¬ä¸Šæ˜¯åˆç›–ä½¿ç”¨çš„ï¼Œè‡ªç„¶å°±æ²¡æ³•ä½¿ç”¨ç¬”è®°æœ¬çš„é”®ç›˜äº†ï¼Œè€Œæˆ‘è¿™é‡Œå¤–æ¥çš„é”®ç›˜æ˜¯æƒ æ™®çš„é”®ç›˜è·Ÿè‹¹æœçš„é”®ç›˜æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥éœ€è¦æ˜ å°„ä¸€ä¸‹ã€‚å½“ç„¶å¦‚æœä½ çš„å¤–æ¥é”®ç›˜æ˜¯è‹¹æœçš„é…ä»¶é‚£ä½¿ç”¨MonitorControlå°±å¤Ÿäº†ã€‚</p>
<p>MonitorControlçš„å®‰è£…å¾ˆç®€å•ï¼Œè¿™é‡Œä¸»è¦è¯´ä¸€ä¸‹Karabinerï¼ŒKarabinerå®‰è£…åä¼šå¤šå‡ºä¸¤ä¸ªAPPï¼šKarabiner-Elements å’Œ Karabiner-EventViewerã€‚è¿™é‡Œä¸»è¦ä½¿ç”¨Karabiner-Elementsï¼Œè€ŒKarabiner-EventViewerè¿™é‡Œè™½ç„¶ä½¿ç”¨ä¸åˆ°ä½†éœ€è¦æ‰“å¼€ä¸€ä¸‹ä»¥å…è®¸ä¸€äº›æƒé™ã€‚è¦ä¸ç„¶ä»…ä½¿ç”¨Karabiner-Elementsåœ¨Macçš„ä¸€äº›ç³»ç»Ÿä¸Šå¯èƒ½ä¼šå‡ºç°å³ä½¿è®¾ç½®äº†ä½†å´æ²¡æ•ˆæœçš„ç°è±¡ã€‚<br><img src="https://upload-images.jianshu.io/upload_images/1503319-2105b2367d07d034.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p>Karabiner-Elementsçš„è®¾ç½®ä¹Ÿå¾ˆç®€å•ï¼Œå½“ç„¶å¯¹äºå°ç™½çš„æˆ‘æ¥è¯´ä¹Ÿæ˜¯æ•´äº†ä¸€ä¼šçš„ä¸»è¦æ˜¯æ²¡æ³¨æ„åˆ°Karabiner-EventViewerè¿˜è¦æ‰“å¼€ä¸€ä¸‹è¿™ä¸ªå‘ã€‚<br>Karabiner-Elementsæœ€å¥½å¤šè®¾ç½®å‡ ä¸ªprofileï¼Œæ–¹ä¾¿åˆ‡æ¢ï¼Œç”¨å›ç¬”è®°æœ¬è‡ªèº«çš„é”®ç›˜æ—¶å°±åˆ‡æ¢ä¸ºé»˜è®¤çš„ã€‚<br>profileï¼š<br><img src="https://upload-images.jianshu.io/upload_images/1503319-1bd699b1c59b2857.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p>æŒ‰é”®çš„æ˜ å°„ï¼š<br><img src="https://upload-images.jianshu.io/upload_images/1503319-7b901ef531d0eb63.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>è¿™æ ·å°±å¯ä»¥é€šè¿‡éè‹¹æœå¤–æ¥é”®ç›˜æ§åˆ¶è‹¹æœç”µè„‘çš„æ‰¬å£°å™¨äº†ã€‚</p>
<p>ç°åœ¨ï¼Œä½ å¯ä»¥é€šè¿‡å¤–æ¥é”®ç›˜æ§åˆ¶å£°éŸ³å’Œå¤–æ¥æ˜¾ç¤ºå™¨çš„äº®åº¦äº†ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰ä½“éªŒåº¦ç¬é—´ä¸Šå‡äº†å¥½å‡ æ¥¼äº†å‘¢ï¼Ÿ</p>
<p>å¦å¤–åæ§½ä¸‹ä¸‰æ˜Ÿçš„ LU28R55ï¼Œè¿™æ¬¾æ˜¾ç¤ºå™¨äº®åº¦è®¾ä¸º0äº†åæ„Ÿè§‰è¿˜æ˜¯æŒºäº®çš„ï¼ŒçœŸä¸çŸ¥é“å½“åˆè®¾è®¡çš„äººæ˜¯æ€ä¹ˆæƒ³çš„å°±ä¸èƒ½è®©å®ƒç»§ç»­è°ƒä½å—ï¼Ÿåœ¨æˆ‘çœ‹æ¥å®Œå…¨æ˜¯ä¸€ä¸ªç¼ºé™·ã€‚</p>
]]></content>
      <categories>
        <category>Life</category>
      </categories>
  </entry>
  <entry>
    <title>MacBook Proå¤–æ¥æ˜¾ç¤ºå™¨(ä¸€)ä¹‹ç½‘è´­æ˜¾ç¤ºå™¨</title>
    <url>/2021/04/05/MacBook%20Pro%E5%A4%96%E6%8E%A5%E6%98%BE%E7%A4%BA%E5%99%A8(%E4%B8%80)%E4%B9%8B%E7%BD%91%E8%B4%AD%E6%98%BE%E7%A4%BA%E5%99%A8/</url>
    <content><![CDATA[<p>MacBook Proç¬”è®°æœ¬çš„æ˜¾ç¤ºå™¨ç€å®æ˜¯å°äº†ç‚¹ï¼Œæƒ³ä¹°ä¸€ä¸ªå¤–æ¥æ˜¾ç¤ºå™¨ã€‚æ²¡æƒ³åˆ°ä¹°ä¸ªæ˜¾ç¤ºå™¨ä¹Ÿæ˜¯æœ‰å¾ˆå¤šçŸ¥è¯†æ˜¯éœ€è¦å­¦ä¹ çš„ã€‚åœ¨äº¬ä¸œä¸Šéšä¾¿æŒ‘äº†ä¸€ä¸ªå–çš„é å‰çš„æ˜¾ç¤ºå™¨ä¸‰æ˜ŸC24F390FHCï¼Œç‰Œå­æ˜¯ä¸‰æ˜Ÿçš„æ„Ÿè§‰é—®é¢˜ä¸å¤§ï¼Œä»·æ ¼999å—ä¹Ÿè¿˜èƒ½æ¥å—ã€‚å‚æ•°å•¥çš„çœ‹äº†ä¸€ä¸‹ï¼Œä½†å› ä¸ºä»€ä¹ˆéƒ½ä¸æ‡‚çœ‹äº†ä¹Ÿä»…ä»…æ˜¯çœ‹äº†ã€‚</p>
<p>ä¹°å›æ¥è£…å¥½ï¼Œå¿ƒæƒ…è¿˜æœ‰ç‚¹å°æ¿€åŠ¨ï¼Œè¿ä¸Šç”µè„‘åä¸€çœ‹æ•ˆæœå‚»äº†ï¼Œæ˜¾ç¤ºå™¨æ˜¾ç¤ºçš„æ–‡å­—æ¯›è¾¹å¤ªæ˜æ˜¾äº†ï¼Œçœ‹ç€å¤ªé—¹å¿ƒäº†ã€‚ç”¨ä¹…äº†è‹¹æœçš„äº§å“ä»¥ä¸ºæ˜¾ç¤ºå™¨éƒ½æ˜¯retinaå±çš„ã€‚ç„¶åçœ‹äº†ä¸€ä¸‹äº§å“å‚æ•°æ˜¯1920x1080pçš„ï¼Œä½†ä¸€èˆ¬å®£ä¼ ä¸Šå†™çš„æ˜¯â€œ1920x1080pï¼ˆå…¨é«˜æ¸…ï¼‰â€ï¼Œçœ‹åˆ°å…¨é«˜æ¸…ä¸‰ä¸ªå­—å¯¹äºå°ç™½çš„æˆ‘æ¥è¯´ä»¥ä¸ºå¦¥äº†ï¼Œè‚¯å®šå¤Ÿç”¨äº†ï¼Œæ®Šä¸çŸ¥ä¸Šé¢è¿˜æœ‰2Kå±ï¼Œ4Kå±ã€‚äº§å“è¥é”€æ–‡æ¡ˆç¡®å®æ˜¯ä¸€ä¸ªå€¼å¾—ç©å‘³çš„ä¸œè¥¿ï¼Œéšä¾¿ä¸€ä¸ªæœ¯è¯­å°±å¯ä»¥æŠŠä¸€ä¸ªå°ç™½å”¬çš„ä¸€æ„£ä¸€æ„£çš„ã€‚è£…å¥½ä½“éªŒäº†å‡ åˆ†é’Ÿå®åœ¨å—ä¸äº†è¿™ç§æ¨¡ç³Šçš„æ„Ÿè§‰ï¼Œåªèƒ½é€€äº†ï¼Œç­‰äº¬ä¸œé€€é’±åå†æ‰“ç®—åŠ ç‚¹é’±æ¢ä¸ª4Kå±çš„ã€‚</p>
<p>æ€»ç»“ï¼š<br>1.ä¹°ç”µå­äº§å“å‰æœ€å¥½åšä¸€ä¸‹åŠŸè¯¾ã€‚äº†è§£ä¸€ä¸‹ç”µå­äº§å“çš„å‚æ•°ï¼Œè¿™äº›å‚æ•°çš„å«ä¹‰ã€‚æ˜ç¡®å¥½è‡ªå·±çš„éœ€æ±‚ï¼ŒæŒ‘å‡ºèƒ½å¤Ÿæ»¡è¶³è‡ªå·±éœ€æ±‚çš„å‡ ä¸ªå…³é”®æ€§å‚æ•°ï¼Œå¦‚æœäº§å“è¾¾ä¸åˆ°è‡ªå·±çš„ç¡¬æ€§è¦æ±‚å°±ä¸è¦ä¹°äº†ã€‚<br>ä¸è¿‡è¿™ä¸€ç‚¹å¥½åƒæŒºéš¾ï¼Œå¯èƒ½å¤§å¤šæ•°äººéƒ½ä¸çŸ¥é“æœ‰å“ªäº›å…³é”®æ€§å‚æ•°éœ€è¦é‡ç‚¹è€ƒè™‘ã€‚æ¯”å¦‚æˆ‘è‡ªå·±ä»¥ä¸ºæ‰€æœ‰çš„æ˜¾ç¤ºå™¨éƒ½æ˜¯retinaå±çš„ï¼Œå‹æ ¹å°±æ²¡æƒ³åˆ°åŸæ¥è¿˜æœ‰å¾ˆå¤šä½åˆ†è¾¨ç‡çš„æ˜¾ç¤ºå™¨ã€‚éš¾é“æ˜¯æˆ‘è„±ç¦»ç”Ÿæ´»å¤ªä¹…å˜æˆäº†ä½•ä¸é£Ÿè‚‰ç³œçš„æ™‹æƒ å¸äº†ï¼Ÿæ‰€å¹¸åœ¨å‘è¾¾çš„äº’è”ç½‘æˆ‘ä»¬å¯ä»¥æœå‡ ç¯‡ç§‘æ™®æ–‡æ‰«æ‰«ç›²ï¼Œè¿™æ ·å°±èƒ½å¤Ÿç¡®å®šå¥½è‡ªå·±éœ€è¦å…³æ³¨çš„å‚æ•°äº†ã€‚<br>2.äº†è§£ä¸‹ç”µå­äº§å“çš„é™„ä»¶ã€‚æ˜¾ç¤ºå™¨æ˜¯é™„èµ HDMIçº¿çš„æœ‰çš„è¿˜é€DPçº¿çš„ï¼Œè¿™æ˜¯è¿æ¥ç”µè„‘å’Œæ˜¾ç¤ºå™¨çº¿çš„ã€‚å½“æ—¶ä¹°çš„æ—¶å€™ä¹Ÿæ²¡çœ‹ï¼Œé¢å¤–ä¹°äº†ä¸€æ ¹HDMIçº¿ã€‚<br>3.ç½‘è´­çš„æ—¶å€™æ˜¯å¦æœ‰å¿…è¦éšå¤§æµé€‰æ‰€è°“çš„çƒ­é”€çš„ã€çˆ†æ¬¾çš„ï¼Ÿ<br>è¿™ä¸ªæˆ‘ä¹Ÿä¸å¤ªæ¸…æ¥šï¼Œç½‘ä¸Šçš„ä¸œè¥¿å‡çš„å¤ªå¤šï¼Œå¥½è¯„åŸºæœ¬æ²¡æœ‰å‚è€ƒä»·å€¼ã€‚ä½†æ˜¯ä¹°ä¸œè¥¿å‰åšä¸‹åŠŸè¯¾ç¡®å®šå¥½è‡ªå·±æƒ³ä¹°ä»€ä¹ˆè€Œä¸æ˜¯å¤´è„‘å‘çƒ­æ‰è¿›å•†å®¶çš„å®£ä¼ ï¼Œåˆ·çˆ†äº†ä¿¡ç”¨å¡ï¼Œç©ºæ‚²åˆ‡ã€‚</p>
]]></content>
      <categories>
        <category>Life</category>
      </categories>
  </entry>
  <entry>
    <title>iOS stack overflowå¯¼è‡´çš„EXC_BAD_ACCESSå´©æºƒ</title>
    <url>/2021/03/28/iOS-stack-overflow%E5%AF%BC%E8%87%B4%E7%9A%84EXC_BAD_ACCESS%E5%B4%A9%E6%BA%83/</url>
    <content><![CDATA[<p>æœ€è¿‘æƒ³å­¦ä¹ ä¸€ä¸‹mmapçš„ä½¿ç”¨ï¼Œæ²¡æƒ³åˆ°ä¸€æ¥å°±æ‰å‘é‡Œäº†ã€‚</p>
<p>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)test_mmap &#123;</span><br><span class="line">    __autoreleasing <span class="built_in">NSError</span> *err = <span class="literal">nil</span>;</span><br><span class="line"><span class="comment">//    self.videoData = [NSData dataWithContentsOfFile:[[NSBundle mainBundle] pathForResource:@&quot;ddcada74ee08d06dda5cd13b4117ad30&quot; ofType:@&quot;mp4&quot;] options:0 error:&amp;er];</span></span><br><span class="line"><span class="comment">//    self.videoData = [NSData dataWithContentsOfFile:[[NSBundle mainBundle] pathForResource:@&quot;ddcada74ee08d06dda5cd13b4117ad30&quot; ofType:@&quot;mp4&quot;] options:NSDataReadingUncached error:&amp;er];</span></span><br><span class="line">    <span class="keyword">self</span>.videoData = [<span class="built_in">NSData</span> dataWithContentsOfFile:[[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@&quot;ddcada74ee08d06dda5cd13b4117ad30&quot;</span> ofType:<span class="string">@&quot;mp4&quot;</span>] options:<span class="built_in">NSDataReadingMappedIfSafe</span> error:&amp;err];  <span class="comment">//1</span></span><br><span class="line">    <span class="keyword">if</span> (err != <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;er:%@&quot;</span>, err);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;videoData:%lu&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span>)<span class="keyword">self</span>.videoData.length);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//    long bufferSize = 4096;</span></span><br><span class="line">    <span class="type">long</span> bufferSize = <span class="number">1000000</span>;</span><br><span class="line"><span class="comment">//    long bufferSize = 1024 * 1024 - 30 * 1024;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> buffer[bufferSize];</span><br><span class="line">    [<span class="keyword">self</span>.videoData getBytes:buffer range:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, bufferSize)]; <span class="comment">//2</span></span><br><span class="line">    <span class="built_in">NSData</span> *someData = [[<span class="built_in">NSData</span> alloc] initWithBytes:buffer length:bufferSize];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;someData:%lu&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span>)someData.length);</span><br><span class="line">    [<span class="keyword">self</span> saveDataToCaches:someData];</span><br><span class="line">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">5</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="keyword">self</span>.videoData = <span class="literal">nil</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)saveDataToCaches:(<span class="built_in">NSData</span> *)data &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *cachespath = <span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSCachesDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>).lastObject;</span><br><span class="line">    <span class="built_in">NSString</span> *fileName = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;%@&quot;</span>, <span class="built_in">NSDate</span>.date];</span><br><span class="line">    <span class="built_in">NSString</span> *filePath = [cachespath stringByAppendingPathComponent:fileName];</span><br><span class="line">    <span class="built_in">NSError</span> *err;</span><br><span class="line">    <span class="type">BOOL</span> ret = [data writeToFile:filePath options:<span class="built_in">NSDataWritingAtomic</span> error:&amp;err];</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;å†™å…¥é”™è¯¯ï¼š%@&quot;</span>, err);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;ret:%d&quot;</span>, ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1å¤„é€šè¿‡mmapçš„æ–¹å¼è¯»å–ä¸€ä¸ª500å¤šå…†çš„è§†é¢‘æ•°æ®ï¼Œ2å¤„è¯»å–è§†é¢‘ä¸­æŸä¸€æ®µçš„æ•°æ®ã€‚æœ€å¼€å§‹çš„æ—¶å€™bufferSizeè®¾ç½®çš„æ˜¯4096ï¼Œè¿è¡Œçš„æ—¶å€™ä¸€åˆ‡æ­£å¸¸ã€‚æ­£å¸¸ä¹‹åè‡ªç„¶æƒ³æ”¹ä¸ªå…¶ä»–çš„å€¼è¯•è¯•ï¼Œäºæ˜¯å°±è®¾ç½®bufferSizeä¸ºè§†é¢‘å¤§å°ï¼Œç»“æœä¸€è¿è¡Œå°±å´©æºƒäº†å¾ˆå¿«å•Šï¼Œç„¶åå°±æ˜¯æç¤ºEXC_BAD_ACCESSã€‚å½“æ—¶è§‰å¾—å¾ˆå¥‡æ€ªæ€ä¹ˆä¼šEXC_BAD_ACCESSå‘¢ï¼Ÿä¹Ÿæ²¡çœ‹åˆ°å“ªä¸ªåœ°æ–¹æœ‰è¿‡åº¦é‡Šæ”¾çš„å¯¹è±¡å•Šã€‚æœ€åä¸€ç‚¹ç‚¹ä¿®æ”¹bufferSizeçš„å¤§å°ï¼Œå‘ç°å°äº1000000ä»£ç å°±å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œè€Œè¶…è¿‡åˆ™ä¼šEXC_BAD_ACCESSã€‚ä¸è¿‡ä¾ç„¶æä¸æ‡‚ä¸ºå•¥ä¼šè¿™æ ·ã€‚ç™¾æ€ä¸å¾—å…¶è§£ä¹‹ååªèƒ½æ±‚åŠ©Googleï¼Œä¸è¿‡ä¹Ÿä¸çŸ¥é“æ€ä¹ˆæœç´¢å…³é”®å­—ï¼Œä¸€é€šæœç´¢ä¹‹åä¹Ÿæ²¡æ‰¾åˆ°æœ‰ç”¨çš„ä¸œè¥¿ï¼ŒæœŸé—´ä¸€åº¦æƒ³æ”¾å¼ƒï¼Œä¸è¿‡è¿˜æ˜¯åšæŒäº†ä¸‹æ¥ã€‚</p>
<p>ç›´æ¥ä¸Šç»“è®ºï¼šä¸Šè¿°å´©æºƒçš„åŸå› å°±æ˜¯stack overflowäº†ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥éªŒè¯ä¸€ä¸‹ï¼Œæ‰“å¥½æ–­ç‚¹ååˆ†åˆ«<strong>p &amp;err</strong>ï¼Œ<strong>p &amp;cachespath</strong>å¾—åˆ°ï¼š</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">(lldb) p <span class="operator">&amp;</span>err</span><br><span class="line">(<span class="type">NSError</span> <span class="operator">**</span>) <span class="variable">$0</span> <span class="operator">=</span> <span class="number">0x000000016f5b97d0</span></span><br><span class="line">(lldb) p <span class="operator">&amp;</span>cachespath</span><br><span class="line">(<span class="type">NSString</span> <span class="operator">**</span>) <span class="variable">$1</span> <span class="operator">=</span> <span class="number">0x000000016f4c5470</span></span><br></pre></td></tr></table></figure>
<p>$0 - $1 = 0xF4360 = 1000288 = 0.954Mï¼ŒåŸºæœ¬ä¸Šå¿«å æ»¡æ•´ä¸ªæ ˆç©ºé—´äº†ï¼ˆè¿™é‡Œæœ‰ç‚¹é©¬åç‚®äº†å› ä¸ºå¾ˆå¤šäººå¯èƒ½éƒ½ä¸çŸ¥é“ä¸»çº¿ç¨‹çš„æ ˆç©ºé—´æœ‰å¤šå¤§ï¼Œç”šè‡³éƒ½æ²¡æœ‰æ ˆæº¢å‡ºè¿™ä¸ªæ¦‚å¿µè‡ªç„¶ä¹Ÿä¸ä¼šå¾€è¿™ä¸ªæ–¹é¢æƒ³äº†ï¼‰ã€‚å› æ­¤ä»£ç å¯èƒ½ä¼šå´©æºƒåœ¨åé¢çš„ä»»æ„ä¸€è¡Œä»£ç ï¼Œå…·ä½“æ˜¯å“ªä¸€è¡Œè§†æ ˆçš„å‰©ä½™ç©ºé—´å¤§å°ã€‚æ¯”å¦‚æœ‰å¯èƒ½å´©æºƒåœ¨</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">NSError <span class="number">*e</span>rr;  Thread 1: EXC_BAD_ACCESS (<span class="attribute">code</span>=2, <span class="attribute">address</span>=0x16f4bfad0)</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿæœ‰å¯èƒ½ä¼šå´©æºƒåœ¨ï¼š</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">NSString <span class="number">*f</span>ileName = [NSString stringWithFormat:@<span class="string">&quot;%@&quot;</span>, NSDate.date];  Thread 1: EXC_BAD_ACCESS (<span class="attribute">code</span>=2, <span class="attribute">address</span>=0x16ebfbae0)</span><br></pre></td></tr></table></figure>
<p>å¦‚æœå¹³æ—¶ä¸å¤ªæ³¨æ„æ ˆç©ºé—´å¤§å°çš„è¯ï¼Œå‡ºç°è¿™æ ·çš„å´©æºƒå¾ˆå®¹æ˜“è®©äººæ‘¸ä¸ç€å¤´è„‘ã€‚æ¯”å¦‚å´©æºƒåœ¨fileNameè¿™ä¸€è¡Œï¼Œä½†è¿™ä¸€è¡Œæ˜¾ç„¶æ˜¯æ²¡æœ‰ä»€ä¹ˆé—®é¢˜çš„ã€‚é‡åˆ°è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å°±ä¸è¦æ­»æ­»ç›¯åœ¨è¿™ä¸€è¡Œä»£ç ä¸Šäº†ï¼Œå› ä¸ºå¾ˆæœ‰å¯èƒ½æ˜¯å…¶ä»–åœ°æ–¹çš„ä»£ç å‡ºäº†é—®é¢˜ï¼Œè€Œä»…ä»…åœ¨è¿™ä¸€è¡Œä½“ç°å‡ºäº†ç—‡çŠ¶ï¼ˆæ„Ÿè§‰è·Ÿäººç”Ÿç—…æœ‰ç‚¹ç›¸ä¼¼å‡ºç°ç—‡çŠ¶çš„åœ°æ–¹æœ‰å¯èƒ½å¹¶ä¸æ˜¯çœŸæ­£çš„ç—…å› ï¼‰ã€‚è¿™æ—¶åº”è¯¥å¾€ä¸Šä»”ç»†æŸ¥æ‰¾ï¼Œè¾¹æŸ¥æ‰¾è¾¹æ’é™¤æ‰é‚£äº›ä¸å¤ªå¯èƒ½å‡ºç°é—®é¢˜çš„ä»£ç ï¼Œç¼©å°èŒƒå›´ï¼Œæ‰¾å‡ºé‚£äº›æœ€æœ‰å¯èƒ½å‡ºç°é—®é¢˜çš„ä»£ç ã€‚å½“ç„¶è¿™ä¾ç„¶éœ€è¦ä½ æœ‰æ‰å®çš„åŸºç¡€ï¼Œæ¯”å¦‚è¿™é‡Œ</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> bufferSize = <span class="number">1000000</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> buffer[bufferSize];</span><br></pre></td></tr></table></figure>
<p>è°åˆèƒ½æƒ³å¾—åˆ°æ˜¯è¿™é‡Œç”³è¯·äº†å¤ªå¤šçš„æ ˆç©ºé—´å¯¼è‡´åé¢çš„éšæœºå´©æºƒå‘¢ï¼ŸEXC_BAD_ACCESSå´©æºƒæœ‰äº›ä¸æ˜¯å¿…ç°çš„è¿™å°±å¯¼è‡´å¤ç°å¾ˆå›°éš¾ï¼Œè€Œæœ‰äº›æ˜¯å´©æºƒçš„åœ°æ–¹æ˜¯ä¸å›ºå®šçš„ã€‚è¿™ä¹Ÿæ˜¯EXC_BAD_ACCESSå´©æºƒè®©äººæ„Ÿåˆ°å¯æ€•çš„åœ°æ–¹ã€‚</p>
<p>è§£å†³åŠæ³•ï¼šåœ¨å †ä¸Šç”³è¯·ç©ºé—´ã€‚</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> bufferSize = <span class="number">1000000</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> * buffer = <span class="built_in">malloc</span>(bufferSize * <span class="built_in">sizeof</span>(<span class="type">unsigned</span> <span class="type">char</span>));</span><br></pre></td></tr></table></figure>
<p>æœ€åè®°å¾—freeã€‚</p>
<p>æ€»ç»“ï¼š</p>
<p>1.å¯¹äºå¤§å†…å­˜å˜é‡æˆ–è€…æ— æ³•é¢„çŸ¥å¤§å°çš„å˜é‡å°½é‡åœ¨å †ä¸Šç”³è¯·ç©ºé—´è€Œä¸æ˜¯åœ¨æ ˆä¸Šç”³è¯·ç©ºé—´ï¼Œå§‹ç»ˆç‰¢è®°æ ˆç©ºé—´æ˜¯æœ‰å¤§å°é™åˆ¶çš„ã€‚</p>
<p>2.å°½é‡ä½¿ç”¨å¾ªç¯è€Œä¸æ˜¯é€’å½’ã€‚<br>è™½ç„¶ä»¥å‰å¹¶å¤ªä¸è®¤åŒè¿™ä¸€ç‚¹ï¼ŒåŠ³èµ„å°±ç”¨é€’å½’æ€ä¹ˆå•¦ã€‚ä¸è¿‡ç°åœ¨çœ‹æ¥é€’å½’ç¡®å®æ›´å®¹æ˜“å¯¼è‡´æ ˆæº¢å‡ºï¼Œèƒ½ç”¨å¾ªç¯çš„æ—¶å€™å°½é‡ç”¨å¾ªç¯ï¼Œç¡®å®å›°éš¾å†ç”¨é€’å½’ã€‚</p>
<p>3.iOSä¸»çº¿ç¨‹æ ˆç©ºé—´å¤§å°ä¸º1MiBï¼Œå­çº¿ç¨‹æ ˆç©ºé—´å¤§å°ä¸º512KiBã€‚</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://initlife.com/blog/2015/10/28/iosli-de-zhan-xian-zhi-yin-fa-de-crash/">iOSé‡Œçš„æ ˆé™åˆ¶å¼•å‘çš„crash</a>  </p>
<p><a href="https://xionghengheng.github.io/2019/01/06/%E4%B8%80%E4%B8%AA%E6%9C%89%E6%84%8F%E6%80%9D%E7%9A%84%E6%A0%88%E6%BA%A2%E5%87%BAcrash/">ä¸€ä¸ªæœ‰æ„æ€çš„æ ˆæº¢å‡ºcrash</a></p>
]]></content>
      <categories>
        <category>Bug</category>
      </categories>
      <tags>
        <tag>å†…å­˜ç®¡ç†</tag>
      </tags>
  </entry>
  <entry>
    <title>OCå†…å­˜ç®¡ç†ä¹‹å¯¹è±¡çš„å¼•ç”¨è®¡æ•°</title>
    <url>/2020/09/16/OC%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E4%B9%8B%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0/</url>
    <content><![CDATA[<p>æºç ç‰ˆæœ¬ï¼š<a href="https://opensource.apple.com/tarballs/objc4/objc4-781.tar.gz">objc4-781</a></p>
<p>æˆ‘ä»¬éƒ½çŸ¥é“OCçš„å†…å­˜ç®¡ç†æ˜¯é€šè¿‡å¼•ç”¨è®¡æ•°æ¥ç®¡ç†çš„ï¼Œå¯¹è±¡åˆšåˆ›å»ºæ—¶å¼•ç”¨è®¡æ•°ä¸º1ï¼Œretainå+1ï¼Œreleaseå-1ï¼Œå½“å¼•ç”¨è®¡æ•°å‡ä¸º0æ—¶å°±ä¼šè¢«é”€æ¯ã€‚é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œæ“ä½œçš„è¿™ä¸ªå¼•ç”¨è®¡æ•°å€¼æ˜¯ä¿å­˜åœ¨å“ªçš„ï¼Ÿä»Šå¤©å°±æ¥ç ”ç©¶ä¸€ä¸‹è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>å…ˆè¯´ç»“è®ºï¼šæ—©æœŸOCå¯¹è±¡çš„å¼•ç”¨è®¡æ•°éƒ½æ˜¯å­˜å‚¨åœ¨å¼•ç”¨è®¡æ•°è¡¨ä¸­çš„ï¼Œä½†æ˜¯åæ¥Appleçš„å·¥ç¨‹å¸ˆå¯èƒ½è§‰å¾—æ¯æ¬¡éƒ½ä»è¡¨ä¸­æŸ¥æ‰¾ä¿®æ”¹æ•ˆç‡æœ‰ç‚¹ä½ï¼Œäºæ˜¯åšäº†ä¸€äº›ä¼˜åŒ–ï¼Œå¦‚æœå¼•ç”¨è®¡æ•°å€¼è¾ƒå°æ—¶å°±ä¿å­˜åœ¨ <code>struct objc_object</code> çš„isaæˆå‘˜å˜é‡é‡Œï¼Œåªæœ‰å½“isaé‡Œè£…ä¸ä¸‹æ—¶æ‰å­˜æ”¾åˆ°å¼•ç”¨è®¡æ•°è¡¨é‡Œï¼Œè¿™ä¸€ç‚¹å¯ä»¥ä»isaçš„ç±»å‹å˜è¿çœ‹å‡ºã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè‹¹æœè¿˜å¼•å…¥äº†Tagged pointerå¯¹è±¡ï¼Œè¿™ç§å¯¹è±¡å®é™…ä¸Šå·²ç»æ²¡æœ‰åœ¨å †ä¸Šåˆ†é…å†…å­˜äº†ï¼Œå®ƒçš„å€¼å°±ä¿å­˜åœ¨æŒ‡é’ˆé‡Œï¼Œè¿™æ ·çš„å¯¹è±¡ç”±äºå¹¶æ²¡æœ‰çœŸæ­£åœ¨å †ä¸Šåˆ†é…å†…å­˜å› æ­¤è®¨è®ºå®ƒçš„å¼•ç”¨è®¡æ•°ä¹Ÿå°±æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰äº†ã€‚</p>
<p>ä¹‹å‰çš„æ–‡ç«  <code>runtimeæºç åˆ†æ(ä¸€)--ç±»å‹</code> é‡Œä¸“é—¨åˆ†æäº† <code>struct objc_object</code> ï¼Œ<code>struct objc_class</code>ï¼Œ<code>isa</code> ç±»å‹çš„å®šä¹‰ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œä»…åšç®€å•è¯´æ˜ã€‚</p>
<h3 id="isaçš„å®šä¹‰"><a href="#isaçš„å®šä¹‰" class="headerlink" title="isaçš„å®šä¹‰"></a>isaçš„å®šä¹‰</h3><p>æ—§ç‰ˆæœ¬çš„å®šä¹‰ï¼š</p>
<p>isaæ˜¯ä¸€ä¸ªæŒ‡é’ˆç±»å‹ <code>struct objc_class *</code> ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">/// An opaque type that represents an Objective-C class.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class *Class; </span><br><span class="line"></span><br><span class="line"><span class="comment">/// Represents an instance of a class.</span></span><br><span class="line"><span class="keyword">struct</span> objc_object &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> objc_class &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY; <span class="comment">//æ—§ç‰ˆæœ¬isaä¸ºä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘objc_classç»“æ„ä½“</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !__OBJC2__</span></span><br><span class="line">    Class _Nullable super_class                              OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">const</span> <span class="type">char</span> * _Nonnull name                               OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="type">long</span> version                                             OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="type">long</span> info                                                OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="type">long</span> instance_size                                       OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_ivar_list * _Nullable ivars                  OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_method_list * _Nullable * _Nullable methodLists                    OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_cache * _Nonnull cache                       OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_protocol_list * _Nullable protocols          OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125; OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="comment">/* Use `Class` instead of `struct objc_class *` */</span></span><br></pre></td></tr></table></figure>
<p>æ–°ç‰ˆæœ¬oc 2.0å®šä¹‰ï¼š</p>
<p>isaæ˜¯ä¸€ä¸ªè”åˆç±»å‹ <code>union isa_t</code> ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">//objc-private.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">objc_object</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">isa_t</span> isa; <span class="comment">//objc_objectä¸­æœ‰ä¸€ä¸ªisaï¼Œä½†ç±»å‹å·²ç»å˜æˆisa_t(unionç±»å‹)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ISA() assumes this is NOT a tagged pointer object</span></span><br><span class="line">    <span class="function">Class <span class="title">ISA</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// rawISA() assumes this is NOT a tagged pointer object or a non pointer ISA</span></span><br><span class="line">    <span class="function">Class <span class="title">rawISA</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// getIsa() allows this to be a tagged pointer object</span></span><br><span class="line">    <span class="function">Class <span class="title">getIsa</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">uintptr_t</span> <span class="title">isaBits</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">union</span> <span class="title class_">isa_t</span> &#123;</span><br><span class="line">    <span class="built_in">isa_t</span>() &#123; &#125;</span><br><span class="line">    <span class="built_in">isa_t</span>(<span class="type">uintptr_t</span> value) : <span class="built_in">bits</span>(value) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    Class cls;</span><br><span class="line">    <span class="type">uintptr_t</span> bits;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(ISA_BITFIELD)</span></span><br><span class="line">    <span class="keyword">struct</span> &#123;</span><br><span class="line">        ISA_BITFIELD;  <span class="comment">// defined in isa.h</span></span><br><span class="line">    &#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å±•å¼€isa_t</span></span><br><span class="line"><span class="keyword">union</span> <span class="title class_">isa_t</span> &#123;</span><br><span class="line">    <span class="built_in">isa_t</span>() &#123; &#125;</span><br><span class="line">    <span class="built_in">isa_t</span>(<span class="type">uintptr_t</span> value) : <span class="built_in">bits</span>(value) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    Class cls; <span class="comment">//ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘objc_classç»“æ„ä½“ã€‚è¿™æ ·å°±å¯ä»¥å…¼å®¹æ—§ç‰ˆæœ¬ã€‚</span></span><br><span class="line">    <span class="type">uintptr_t</span> bits;</span><br><span class="line">    <span class="comment">//è¿™é‡Œå±•å¼€çš„æ˜¯arm64çš„</span></span><br><span class="line">    <span class="keyword">struct</span> &#123;</span><br><span class="line">        <span class="type">uintptr_t</span> nonpointer        : <span class="number">1</span>; <span class="comment">//LSBã€‚0 is raw isa, 1 is non-pointer isa.                                      </span></span><br><span class="line">      	<span class="type">uintptr_t</span> has_assoc         : <span class="number">1</span>; <span class="comment">//å¯¹è±¡æ˜¯å¦æœ‰å…³è”å¯¹è±¡                                      </span></span><br><span class="line">        <span class="type">uintptr_t</span> has_cxx_dtor      : <span class="number">1</span>; <span class="comment">//å¯¹è±¡æ˜¯å¦æœ‰C++æˆ–ARCææ„å‡½æ•°                                      </span></span><br><span class="line">        <span class="type">uintptr_t</span> shiftcls          : <span class="number">33</span>; <span class="comment">/*MACH_VM_MAX_ADDRESS 0x1000000000*/</span> <span class="comment">//Classåœ°å€ã€‚</span></span><br><span class="line">        <span class="type">uintptr_t</span> magic             : <span class="number">6</span>;  <span class="comment">//ä¸€ä¸ªé­”æ³•æ•°ã€‚ç”¨äºåŒºåˆ†æ˜¯å¦åˆå§‹åŒ–                                     </span></span><br><span class="line">        <span class="type">uintptr_t</span> weakly_referenced : <span class="number">1</span>;  <span class="comment">//æ˜¯å¦æœ‰å¼±å¼•ç”¨æŒ‡é’ˆã€‚                                      </span></span><br><span class="line">        <span class="type">uintptr_t</span> deallocating      : <span class="number">1</span>; <span class="comment">//æ˜¯å¦æ­£åœ¨è¢«é”€æ¯                                      </span></span><br><span class="line">        <span class="type">uintptr_t</span> has_sidetable_rc  : <span class="number">1</span>; <span class="comment">//æ˜¯å¦æœ‰sidetableå¼•ç”¨è®¡æ•°ã€‚å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å¤ªå¤§è€Œä¸èƒ½åœ¨å†…éƒ¨ä¿å­˜æ—¶ä¼šå°†å¼•ç”¨è®¡æ•°ä¿å­˜åˆ°sidetable                                      </span></span><br><span class="line">        <span class="type">uintptr_t</span> extra_rc          : <span class="number">19</span> <span class="comment">//MSBã€‚å¯¹è±¡çš„å¼•ç”¨è®¡æ•°è¶…è¿‡1æ—¶ä¼šå­˜åœ¨è¿™é‡Œã€‚å› æ­¤extra_rcåŠ 1åå°±æ˜¯å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚ç”±äºåªæœ‰19ä½æ‰€ä»¥åªæœ‰å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸å¤ªå¤§çš„æ—¶å€™æ‰ä¿å­˜åœ¨è¿™é‡Œ</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="keyword">if</span> __arm64__</span></span><br><span class="line"><span class="meta">#   <span class="keyword">define</span> ISA_MASK        0x0000000ffffffff8ULL</span></span><br><span class="line"><span class="meta">#   <span class="keyword">define</span> ISA_MAGIC_MASK  0x000003f000000001ULL</span></span><br><span class="line"><span class="meta">#   <span class="keyword">define</span> ISA_MAGIC_VALUE 0x000001a000000001ULL</span></span><br><span class="line"><span class="meta">#   <span class="keyword">define</span> ISA_BITFIELD                                                      \</span></span><br><span class="line"><span class="meta">      uintptr_t nonpointer        : 1;                                       \</span></span><br><span class="line"><span class="meta">      uintptr_t has_assoc         : 1;                                       \</span></span><br><span class="line"><span class="meta">      uintptr_t has_cxx_dtor      : 1;                                       \</span></span><br><span class="line"><span class="meta">      uintptr_t shiftcls          : 33; <span class="comment">/*MACH_VM_MAX_ADDRESS 0x1000000000*/</span> \</span></span><br><span class="line"><span class="meta">      uintptr_t magic             : 6;                                       \</span></span><br><span class="line"><span class="meta">      uintptr_t weakly_referenced : 1;                                       \</span></span><br><span class="line"><span class="meta">      uintptr_t deallocating      : 1;                                       \</span></span><br><span class="line"><span class="meta">      uintptr_t has_sidetable_rc  : 1;                                       \</span></span><br><span class="line"><span class="meta">      uintptr_t extra_rc          : 19</span></span><br><span class="line"><span class="meta">#   <span class="keyword">define</span> RC_ONE   (1ULL&lt;&lt;45)  <span class="comment">//åˆšå¥½ä½äºextra_rcçš„æœ€ä½ä½ï¼Œå› æ­¤+RC_ONEï¼Œå°±è¡¨ç¤ºextra_rc+1</span></span></span><br><span class="line"><span class="meta">#   <span class="keyword">define</span> RC_HALF  (1ULL&lt;&lt;18)</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„æ³¨é‡Šå·²ç»å†™å¾—å¾ˆæ˜ç™½äº†ï¼Œè‡³äºisaä¸ºä»€ä¹ˆå¯ä»¥ç”¨ç»“æ„ä½“ä½åŸŸå®šä¹‰ï¼Œä¸»è¦æ˜¯å› ä¸ºåœ¨64ä½ç³»ç»Ÿä¸­æŒ‡é’ˆçš„é•¿åº¦ä¸º8ä¸ªå­—èŠ‚ï¼Œ64ä½ï¼Œè€Œç±»çš„åœ°å€é€šå¸¸å ä¸æ»¡64ä½å¯¼è‡´ä¼šç©ºå‡ºè®¸å¤šbitï¼Œäºæ˜¯è‹¹æœçš„å·¥ç¨‹å¸ˆå……åˆ†åˆ©ç”¨è¿™äº›bitï¼Œæå¤§çš„æé«˜äº†å¼•ç”¨è®¡æ•°çš„æ“ä½œæ•ˆç‡ã€‚ï¼ˆè‡³äºä¸ºå•¥ç±»çš„åœ°å€è¾¾ä¸åˆ°64ä½ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œä»ä¸Šé¢çš„å®šä¹‰çœ‹åº”è¯¥åªæœ‰33ä½æœ‰æ•ˆä½ã€‚ï¼‰</p>
<p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹retainå’Œreleaseçš„å®ç°ï¼Œè¿›ä¸€æ­¥éªŒè¯ã€‚</p>
<h3 id="retain"><a href="#retain" class="headerlink" title="retain"></a>retain</h3><p>æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Replaced by ObjectAlloc</span></span><br><span class="line">- (<span class="type">id</span>)<span class="keyword">retain</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> _objc_rootRetain(<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NEVER_INLINE <span class="type">id</span></span><br><span class="line">_objc_rootRetain(<span class="type">id</span> obj)</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(obj);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> obj-&gt;rootRetain();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ALWAYS_INLINE <span class="type">id</span> </span><br><span class="line">objc_object::rootRetain()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> rootRetain(<span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NEVER_INLINE <span class="type">id</span> </span><br><span class="line">objc_object::rootRetain_overflow(<span class="type">bool</span> tryRetain)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> rootRetain(tryRetain, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ALWAYS_INLINE <span class="type">id</span> </span><br><span class="line">objc_object::rootRetain(<span class="type">bool</span> tryRetain, <span class="type">bool</span> handleOverflow)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (isTaggedPointer()) <span class="keyword">return</span> (<span class="type">id</span>)<span class="variable language_">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> sideTableLocked = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">bool</span> transcribeToSideTable = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    isa_t oldisa;</span><br><span class="line">    isa_t newisa;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        transcribeToSideTable = <span class="literal">false</span>;</span><br><span class="line">        oldisa = LoadExclusive(&amp;isa.bits);</span><br><span class="line">        newisa = oldisa;</span><br><span class="line">        <span class="keyword">if</span> (slowpath(!newisa.nonpointer)) &#123; <span class="comment">//çº¯pointerçš„åˆ™è°ƒç”¨sidetable_retainï¼Œ</span></span><br><span class="line">            ClearExclusive(&amp;isa.bits);</span><br><span class="line">            <span class="keyword">if</span> (rawISA()-&gt;isMetaClass()) <span class="keyword">return</span> (<span class="type">id</span>)<span class="variable language_">this</span>;</span><br><span class="line">            <span class="keyword">if</span> (!tryRetain &amp;&amp; sideTableLocked) sidetable_unlock();</span><br><span class="line">            <span class="keyword">if</span> (tryRetain) <span class="keyword">return</span> sidetable_tryRetain() ? (<span class="type">id</span>)<span class="variable language_">this</span> : <span class="literal">nil</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">return</span> sidetable_retain();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// don&#x27;t check newisa.fast_rr; we already called any RR overrides</span></span><br><span class="line">        <span class="keyword">if</span> (slowpath(tryRetain &amp;&amp; newisa.deallocating)) &#123;</span><br><span class="line">            ClearExclusive(&amp;isa.bits);</span><br><span class="line">            <span class="keyword">if</span> (!tryRetain &amp;&amp; sideTableLocked) sidetable_unlock();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        uintptr_t carry;</span><br><span class="line">        newisa.bits = addc(newisa.bits, RC_ONE, <span class="number">0</span>, &amp;carry);  <span class="comment">// extra_rc++</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (slowpath(carry)) &#123;</span><br><span class="line">            <span class="comment">// newisa.extra_rc++ overflowed</span></span><br><span class="line">            <span class="keyword">if</span> (!handleOverflow) &#123;</span><br><span class="line">                ClearExclusive(&amp;isa.bits);</span><br><span class="line">                <span class="keyword">return</span> rootRetain_overflow(tryRetain);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Leave half of the retain counts inline and </span></span><br><span class="line">            <span class="comment">// prepare to copy the other half to the side table.</span></span><br><span class="line">            <span class="keyword">if</span> (!tryRetain &amp;&amp; !sideTableLocked) sidetable_lock();</span><br><span class="line">            sideTableLocked = <span class="literal">true</span>;</span><br><span class="line">            transcribeToSideTable = <span class="literal">true</span>;</span><br><span class="line">            newisa.extra_rc = RC_HALF;</span><br><span class="line">            newisa.has_sidetable_rc = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (slowpath(!StoreExclusive(&amp;isa.bits, oldisa.bits, newisa.bits)));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (slowpath(transcribeToSideTable)) &#123;</span><br><span class="line">        <span class="comment">// Copy the other half of the retain counts to the side table.</span></span><br><span class="line">        sidetable_addExtraRC_nolock(RC_HALF);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (slowpath(!tryRetain &amp;&amp; sideTableLocked)) sidetable_unlock();</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">id</span>)<span class="variable language_">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¤§è‡´æµç¨‹ï¼š</p>
<ol>
<li>é¦–å…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯TaggedPointerå¯¹è±¡ï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥è¿”å›ã€‚ä¸Šé¢ä¹Ÿè¯´äº†TaggedPointerå¯¹è±¡å¹¶æ²¡æœ‰çœŸæ­£åœ¨å †ä¸Šåˆ†é…å†…å­˜å­˜å‚¨å¯¹è±¡ï¼Œæ‰€ä»¥è¿™äº›retainï¼Œreleaseæ“ä½œéƒ½æ˜¯æ— æ„ä¹‰çš„ã€‚</li>
<li>å¦‚æœisaæ˜¯çº¯pointerç±»å‹åˆ™è°ƒç”¨sidetable_retainï¼ŒæŸ¥è¯¢åˆ°å¯¹è±¡çš„å¼•ç”¨è®¡æ•°è¡¨å+1ã€‚å¦ï¼šslowpathè¡¨ç¤ºè¯¥æ¡ä»¶ä¸€èˆ¬ä¸ä¼šæˆç«‹ï¼Œç”¨äºç¼–è¯‘å™¨ä¼˜åŒ–ã€‚</li>
<li>å¦‚æœæ˜¯tryRetainå¹¶ä¸”æ­£åœ¨é”€æ¯åˆ™è¿”å›nilï¼Œå³tryRetainå¤±è´¥ã€‚è¿™é‡Œç¨å¾®æä¸€å¥ <code>objc_loadWeakRetained</code> å‡½æ•°é‡Œé¢æœ‰è°ƒç”¨ <code>obj-&gt;rootTryRetain()</code> ï¼Œå¦‚æœtryRetainå¤±è´¥ï¼Œ <code>objc_loadWeakRetained</code> ä¼šè¿”å›nilã€‚</li>
<li>å¦‚æœisaæ˜¯nonpointerï¼Œåˆ™è°ƒç”¨<code>addc(newisa.bits, RC_ONE, 0, &amp;carry)</code> ,extra_rc++ã€‚ç”±äºextra_rcåªæœ‰19bitæ‰€ä»¥éœ€è¦å¤„ç†è¿›ä½çš„é—®é¢˜ã€‚åŒæ ·è¿›ä½ä¹Ÿä¸æ˜¯ç»å¸¸å‘ç”Ÿï¼Œæ‰€ä»¥è¿›ä½çš„å¤„ç†ä¹Ÿæ˜¯slowpathã€‚</li>
<li>å¤„ç†è¿›ä½æƒ…å†µï¼Œå½“å‘ç”Ÿè¿›ä½æ—¶ï¼Œå°±éœ€è¦æŠŠä¸€éƒ¨åˆ†å¼•ç”¨è®¡æ•°åŠ åˆ°å¼•ç”¨è®¡æ•°è¡¨é‡Œå»äº†ï¼Œæ‰€ä»¥å…ˆåŠ å¥½é”sidetable_lockã€‚æ›´æ–°transcribeToSideTableä¸ºtrueè¡¨ç¤ºéœ€è¦å°†ä¸€éƒ¨åˆ†å¼•ç”¨è®¡æ•°åŠ åˆ°sidetableï¼Œæ›´æ–°isa.extra_rc=RC_HALF, æ›´æ–°has_sidetable_rcä¸ºtrueè¡¨æ˜ä½¿ç”¨åˆ°äº†å¼•ç”¨è®¡æ•°è¡¨ã€‚</li>
</ol>
<p>ä»retainçš„å¤„ç†é€»è¾‘ä¸éš¾çœ‹å‡ºï¼Œå¼•ç”¨è®¡æ•°å€¼çš„ä¿å­˜ä¸æ“ä½œæ˜¯æœ‰ç»è¿‡ä¼˜åŒ–çš„ã€‚æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹sidetable_retainçš„æ“ä½œã€‚</p>
<h4 id="sidetable-retain"><a href="#sidetable-retain" class="headerlink" title="sidetable_retain"></a>sidetable_retain</h4><p>æºç ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="type">id</span></span><br><span class="line">objc_object::sidetable_retain()</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> SUPPORT_NONPOINTER_ISA</span></span><br><span class="line">    ASSERT(!isa.nonpointer);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    SideTable&amp; table = SideTables()[<span class="variable language_">this</span>];</span><br><span class="line">    </span><br><span class="line">    table.lock();</span><br><span class="line">    size_t&amp; refcntStorage = table.refcnts[<span class="variable language_">this</span>];</span><br><span class="line">    <span class="keyword">if</span> (! (refcntStorage &amp; SIDE_TABLE_RC_PINNED)) &#123;</span><br><span class="line">        refcntStorage += SIDE_TABLE_RC_ONE;</span><br><span class="line">    &#125;</span><br><span class="line">    table.unlock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="type">id</span>)<span class="variable language_">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> objc::ExplicitInit&lt;StripedMap&lt;SideTable&gt;&gt; SideTablesMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> StripedMap&lt;SideTable&gt;&amp; SideTables() &#123;</span><br><span class="line">    <span class="keyword">return</span> SideTablesMap.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¤§è‡´æµç¨‹ï¼š</p>
<ol>
<li>å°†å¯¹è±¡åœ°å€æ˜ å°„ä¸ºç´¢å¼•ï¼Œç„¶åä»SideTableså“ˆå¸Œæ•°ç»„é‡Œå–å¾—å¯¹è±¡çš„SideTable</li>
<li>å°†å¯¹è±¡åœ°å€æ˜ å°„ä¸ºç´¢å¼•ï¼Œä»SideTableçš„refcntså“ˆå¸Œæ•°ç»„é‡Œå–å¾—å½“å‰å¼•ç”¨è®¡æ•°å€¼</li>
<li>+1</li>
</ol>
<p>è¿™é‡Œç¨å¾®ä»‹ç»ä¸‹refcntsï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">SideTable</span> &#123;</span><br><span class="line">    <span class="type">spinlock_t</span> slock;</span><br><span class="line">    RefcountMap refcnts; <span class="comment">//æŒ‡å‘ä¸€ä¸ªå¼•ç”¨è®¡æ•°è¡¨</span></span><br><span class="line">    <span class="type">weak_table_t</span> weak_table; <span class="comment">//æŒ‡å‘ä¸€ä¸ªå¼±å¼•ç”¨è¡¨</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ–¹æ³•</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// RefcountMap disguises its pointers because we </span></span><br><span class="line"><span class="comment">// don&#x27;t want the table to act as a root for `leaks`.</span></span><br><span class="line"><span class="keyword">typedef</span> objc::DenseMap&lt;DisguisedPtr&lt;objc_object&gt;,<span class="type">size_t</span>,RefcountMapValuePurgeable&gt; RefcountMap;</span><br></pre></td></tr></table></figure>
<p>å®ƒæ˜¯SideTableçš„ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œæ˜¯ä¸€ä¸ªå“ˆå¸Œè¡¨DenseMapï¼ŒDenseMapç»§æ‰¿è‡ªDenseMapBaseã€‚DenseMapBaseé‡Œå®ç°äº†æ‰©å®¹æ“ä½œï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒå¼•ç”¨è®¡æ•°è¡¨å®¹é‡ä¸å¤Ÿçš„æƒ…å†µã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DenseMapBase</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> LookupKeyT&gt;</span><br><span class="line">    <span class="function">BucketT *<span class="title">InsertIntoBucketImpl</span><span class="params">(<span class="type">const</span> KeyT &amp;Key, <span class="type">const</span> LookupKeyT &amp;Lookup,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  BucketT *TheBucket)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// If the load of the hash table is more than 3/4, or if fewer than 1/8 of</span></span><br><span class="line">      <span class="comment">// the buckets are empty (meaning that many are filled with tombstones),</span></span><br><span class="line">      <span class="comment">// grow the table.</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// The later case is tricky.  For example, if we had one empty bucket with</span></span><br><span class="line">      <span class="comment">// tons of tombstones, failing lookups (e.g. for insertion) would have to</span></span><br><span class="line">      <span class="comment">// probe almost the entire table until it found the empty bucket.  If the</span></span><br><span class="line">      <span class="comment">// table completely filled with tombstones, no lookup would ever succeed,</span></span><br><span class="line">      <span class="comment">// causing infinite loops in lookup.</span></span><br><span class="line">      <span class="type">unsigned</span> NewNumEntries = <span class="built_in">getNumEntries</span>() + <span class="number">1</span>;</span><br><span class="line">      <span class="type">unsigned</span> NumBuckets = <span class="built_in">getNumBuckets</span>();</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">LLVM_UNLIKELY</span>(NewNumEntries * <span class="number">4</span> &gt;= NumBuckets * <span class="number">3</span>)) &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;<span class="built_in">grow</span>(NumBuckets * <span class="number">2</span>); <span class="comment">//æ‰©å®¹</span></span><br><span class="line">        <span class="built_in">LookupBucketFor</span>(Lookup, TheBucket);</span><br><span class="line">        NumBuckets = <span class="built_in">getNumBuckets</span>();</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">LLVM_UNLIKELY</span>(NumBuckets-(NewNumEntries+<span class="built_in">getNumTombstones</span>()) &lt;=</span><br><span class="line">                               NumBuckets/<span class="number">8</span>)) &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;<span class="built_in">grow</span>(NumBuckets);</span><br><span class="line">        <span class="built_in">LookupBucketFor</span>(Lookup, TheBucket);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">ASSERT</span>(TheBucket);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Only update the state after we&#x27;ve grown our bucket space appropriately</span></span><br><span class="line">      <span class="comment">// so that when growing buckets we have self-consistent entry count.</span></span><br><span class="line">      <span class="comment">// If we are writing over a tombstone or zero value, remember this.</span></span><br><span class="line">      <span class="keyword">if</span> (KeyInfoT::<span class="built_in">isEqual</span>(TheBucket-&gt;<span class="built_in">getFirst</span>(), <span class="built_in">getEmptyKey</span>())) &#123;</span><br><span class="line">        <span class="comment">// Replacing an empty bucket.</span></span><br><span class="line">        <span class="built_in">incrementNumEntries</span>();</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (KeyInfoT::<span class="built_in">isEqual</span>(TheBucket-&gt;<span class="built_in">getFirst</span>(), <span class="built_in">getTombstoneKey</span>())) &#123;</span><br><span class="line">        <span class="comment">// Replacing a tombstone.</span></span><br><span class="line">        <span class="built_in">incrementNumEntries</span>();</span><br><span class="line">        <span class="built_in">decrementNumTombstones</span>();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// we should be purging a zero. No accounting changes.</span></span><br><span class="line">        <span class="built_in">ASSERT</span>(ValueInfoT::<span class="built_in">isPurgeable</span>(TheBucket-&gt;<span class="built_in">getSecond</span>()));</span><br><span class="line">        TheBucket-&gt;<span class="built_in">getSecond</span>().~<span class="built_in">ValueT</span>();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> TheBucket;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœå¯¹SideTablesMapæ„Ÿå…´è¶£å¯ä»¥å‚è€ƒ</p>
<p><a href="https://cloud.tencent.com/developer/article/1586223">iOS SideTable</a></p>
<p>è¿™é‡Œç®€å•è¯´ä¸€ä¸‹ï¼ŒSideTablesMapå°±æ˜¯ä¸€ä¸ªå…¨å±€çš„å“ˆå¸Œè¡¨ï¼Œå®ƒçš„å…ƒç´ ä¸ªæ•°æ˜¯å›ºå®šçš„8ä¸ªæˆ–64ä¸ªï¼Œé‡Œé¢è£…çš„å°±æ˜¯SideTableå¯¹è±¡ã€‚</p>
<h3 id="release"><a href="#release" class="headerlink" title="release"></a>release</h3><p>å®ç°ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Replaced by ObjectAlloc</span></span><br><span class="line">- (<span class="keyword">oneway</span> <span class="type">void</span>)release &#123;</span><br><span class="line">    _objc_rootRelease(<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NEVER_INLINE <span class="type">void</span></span><br><span class="line">_objc_rootRelease(<span class="type">id</span> obj)</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(obj);</span><br><span class="line"></span><br><span class="line">    obj-&gt;rootRelease();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ALWAYS_INLINE <span class="type">bool</span> </span><br><span class="line">objc_object::rootRelease()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> rootRelease(<span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ALWAYS_INLINE <span class="type">bool</span> </span><br><span class="line">objc_object::rootRelease(<span class="type">bool</span> performDealloc, <span class="type">bool</span> handleUnderflow)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (isTaggedPointer()) <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">//TaggedPointerå¯¹è±¡ä¸å¤„ç†</span></span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> sideTableLocked = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    isa_t oldisa;</span><br><span class="line">    isa_t newisa;</span><br><span class="line"></span><br><span class="line"> retry:</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        oldisa = LoadExclusive(&amp;isa.bits);</span><br><span class="line">        newisa = oldisa;</span><br><span class="line">        <span class="keyword">if</span> (slowpath(!newisa.nonpointer)) &#123;</span><br><span class="line">            ClearExclusive(&amp;isa.bits);</span><br><span class="line">            <span class="keyword">if</span> (rawISA()-&gt;isMetaClass()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (sideTableLocked) sidetable_unlock();</span><br><span class="line">            <span class="keyword">return</span> sidetable_release(performDealloc);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// don&#x27;t check newisa.fast_rr; we already called any RR overrides</span></span><br><span class="line">        uintptr_t carry;</span><br><span class="line">        newisa.bits = subc(newisa.bits, RC_ONE, <span class="number">0</span>, &amp;carry);  <span class="comment">// extra_rc--</span></span><br><span class="line">        <span class="keyword">if</span> (slowpath(carry)) &#123;</span><br><span class="line">            <span class="comment">// don&#x27;t ClearExclusive()</span></span><br><span class="line">            <span class="keyword">goto</span> underflow;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (slowpath(!StoreReleaseExclusive(&amp;isa.bits, </span><br><span class="line">                                             oldisa.bits, newisa.bits)));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (slowpath(sideTableLocked)) sidetable_unlock();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"> underflow:</span><br><span class="line">    <span class="comment">// newisa.extra_rc-- underflowed: borrow from side table or deallocate</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// abandon newisa to undo the decrement</span></span><br><span class="line">    newisa = oldisa; <span class="comment">//å‘ç”Ÿä¸‹æº¢æ—¶å°±ä¿æŒisaä¸å˜äº†ã€‚</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (slowpath(newisa.has_sidetable_rc)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!handleUnderflow) &#123;</span><br><span class="line">            ClearExclusive(&amp;isa.bits);</span><br><span class="line">            <span class="keyword">return</span> rootRelease_underflow(performDealloc);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Transfer retain count from side table to inline storage.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!sideTableLocked) &#123;</span><br><span class="line">            ClearExclusive(&amp;isa.bits);</span><br><span class="line">            sidetable_lock();</span><br><span class="line">            sideTableLocked = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// Need to start over to avoid a race against </span></span><br><span class="line">            <span class="comment">// the nonpointer -&gt; raw pointer transition.</span></span><br><span class="line">            <span class="keyword">goto</span> retry;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Try to remove some retain counts from the side table.        </span></span><br><span class="line">        size_t borrowed = sidetable_subExtraRC_nolock(RC_HALF);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// To avoid races, has_sidetable_rc must remain set </span></span><br><span class="line">        <span class="comment">// even if the side table count is now zero.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (borrowed &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Side table retain count decreased.</span></span><br><span class="line">            <span class="comment">// Try to add them to the inline count.</span></span><br><span class="line">            newisa.extra_rc = borrowed - <span class="number">1</span>;  <span class="comment">// redo the original decrement too</span></span><br><span class="line">            <span class="type">bool</span> stored = StoreReleaseExclusive(&amp;isa.bits, </span><br><span class="line">                                                oldisa.bits, newisa.bits);</span><br><span class="line">            <span class="keyword">if</span> (!stored) &#123;</span><br><span class="line">                <span class="comment">// Inline update failed. </span></span><br><span class="line">                <span class="comment">// Try it again right now. This prevents livelock on LL/SC </span></span><br><span class="line">                <span class="comment">// architectures where the side table access itself may have </span></span><br><span class="line">                <span class="comment">// dropped the reservation.</span></span><br><span class="line">                isa_t oldisa2 = LoadExclusive(&amp;isa.bits);</span><br><span class="line">                isa_t newisa2 = oldisa2;</span><br><span class="line">                <span class="keyword">if</span> (newisa2.nonpointer) &#123;</span><br><span class="line">                    uintptr_t overflow;</span><br><span class="line">                    newisa2.bits = </span><br><span class="line">                        addc(newisa2.bits, RC_ONE * (borrowed<span class="number">-1</span>), <span class="number">0</span>, &amp;overflow);</span><br><span class="line">                    <span class="keyword">if</span> (!overflow) &#123;</span><br><span class="line">                        stored = StoreReleaseExclusive(&amp;isa.bits, oldisa2.bits, </span><br><span class="line">                                                       newisa2.bits);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!stored) &#123;</span><br><span class="line">                <span class="comment">// Inline update failed.</span></span><br><span class="line">                <span class="comment">// Put the retains back in the side table.</span></span><br><span class="line">                sidetable_addExtraRC_nolock(borrowed);</span><br><span class="line">                <span class="keyword">goto</span> retry;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Decrement successful after borrowing from side table.</span></span><br><span class="line">            <span class="comment">// This decrement cannot be the deallocating decrement - the side </span></span><br><span class="line">            <span class="comment">// table lock and has_sidetable_rc bit ensure that if everyone </span></span><br><span class="line">            <span class="comment">// else tried to -release while we worked, the last one would block.</span></span><br><span class="line">            sidetable_unlock();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Side table is empty after all. Fall-through to the dealloc path.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Really deallocate.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (slowpath(newisa.deallocating)) &#123;</span><br><span class="line">        ClearExclusive(&amp;isa.bits);</span><br><span class="line">        <span class="keyword">if</span> (sideTableLocked) sidetable_unlock();</span><br><span class="line">        <span class="keyword">return</span> overrelease_error();</span><br><span class="line">        <span class="comment">// does not actually return</span></span><br><span class="line">    &#125;</span><br><span class="line">    newisa.deallocating = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (!StoreExclusive(&amp;isa.bits, oldisa.bits, newisa.bits)) <span class="keyword">goto</span> retry;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (slowpath(sideTableLocked)) sidetable_unlock();</span><br><span class="line"></span><br><span class="line">    __c11_atomic_thread_fence(__ATOMIC_ACQUIRE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (performDealloc) &#123;</span><br><span class="line">        ((<span class="type">void</span>(*)(objc_object *, SEL))objc_msgSend)(<span class="variable language_">this</span>, <span class="keyword">@selector</span>(dealloc));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç å¾ˆå¤šä½†é€»è¾‘å¹¶ä¸å¤æ‚ï¼š</p>
<ol>
<li>å°†å¼•ç”¨è®¡æ•°-1</li>
<li>å½“å¼•ç”¨è®¡æ•°å‡ä¸ºâ€œ0â€æ—¶ï¼Œè°ƒç”¨å¯¹è±¡çš„deallocæ–¹æ³•ã€‚</li>
</ol>
<p>ä¸ºå•¥è¿™é‡Œ0æ‰“äº†å¼•å·ï¼Œè¿™æ˜¯å› ä¸ºå¯¹è±¡åˆšåˆ›å»ºå‡ºæ¥ä¸ç®¡æ˜¯å¼•ç”¨è®¡æ•°è¡¨é‡Œçš„å€¼è¿˜æ˜¯extra_rcçš„å€¼å…¶å®éƒ½æ˜¯0ï¼Œè¿™æ—¶å€™è°ƒç”¨releaseï¼Œé‚£å°±æ˜¯0-1ä¼šå‘ç”Ÿunderflowï¼Œæ‰€ä»¥è¿™ç§æƒ…å†µä¸‹å®é™…ä¸Šè¦å¤„ç†underflowï¼Œæ‰€ä»¥æºç é‡Œæœ‰æ³¨é‡Šï¼š</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">newisa.<span class="keyword">extra_rc-- </span>underflowed: <span class="keyword">borrow </span>from side table <span class="keyword">or </span>deallocate</span><br></pre></td></tr></table></figure>
<p>å› æ­¤å®é™…ä¸Šæ˜¯å¼•ç”¨è®¡æ•°å…ˆ-1ï¼Œå½“å‘ç”Ÿä¸‹æº¢æ—¶å¯èƒ½å°±ä¼šè°ƒç”¨deallocateï¼Œå½“ç„¶è¿™ç§æƒ…å†µä¸‹ä¹Ÿå°±ä¸æ›´æ–°å¼•ç”¨è®¡æ•°å€¼ä¸ºè´Ÿæ•°äº†ã€‚</p>
<h4 id="sidetable-release"><a href="#sidetable-release" class="headerlink" title="sidetable_release"></a>sidetable_release</h4><p>å®ç°ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// rdar://20206767</span></span><br><span class="line"><span class="comment">// return uintptr_t instead of bool so that the various raw-isa </span></span><br><span class="line"><span class="comment">// -release paths all return zero in eax</span></span><br><span class="line">uintptr_t</span><br><span class="line">objc_object::sidetable_release(<span class="type">bool</span> performDealloc)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> SUPPORT_NONPOINTER_ISA</span></span><br><span class="line">    ASSERT(!isa.nonpointer);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    SideTable&amp; table = SideTables()[<span class="variable language_">this</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> do_dealloc = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    table.lock();</span><br><span class="line">    auto it = table.refcnts.try_emplace(<span class="variable language_">this</span>, SIDE_TABLE_DEALLOCATING);</span><br><span class="line">    auto &amp;refcnt = it.first-&gt;second;</span><br><span class="line">    <span class="keyword">if</span> (it.second) &#123;</span><br><span class="line">        do_dealloc = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (refcnt &lt; SIDE_TABLE_DEALLOCATING) &#123;</span><br><span class="line">        <span class="comment">// SIDE_TABLE_WEAKLY_REFERENCED may be set. Don&#x27;t change it.</span></span><br><span class="line">        do_dealloc = <span class="literal">true</span>;</span><br><span class="line">        refcnt |= SIDE_TABLE_DEALLOCATING;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (! (refcnt &amp; SIDE_TABLE_RC_PINNED)) &#123;</span><br><span class="line">        refcnt -= SIDE_TABLE_RC_ONE;</span><br><span class="line">    &#125;</span><br><span class="line">    table.unlock();</span><br><span class="line">    <span class="keyword">if</span> (do_dealloc  &amp;&amp;  performDealloc) &#123;</span><br><span class="line">        ((<span class="type">void</span>(*)(objc_object *, SEL))objc_msgSend)(<span class="variable language_">this</span>, <span class="keyword">@selector</span>(dealloc));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> do_dealloc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="retainCount"><a href="#retainCount" class="headerlink" title="retainCount"></a>retainCount</h3><p>å®ç°ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">NSUInteger</span>)retainCount &#123;</span><br><span class="line">    <span class="keyword">return</span> _objc_rootRetainCount(<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uintptr_t</span><br><span class="line">_objc_rootRetainCount(<span class="type">id</span> obj)</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(obj);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> obj-&gt;rootRetainCount();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> uintptr_t </span><br><span class="line">objc_object::rootRetainCount()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (isTaggedPointer()) <span class="keyword">return</span> (uintptr_t)<span class="variable language_">this</span>;</span><br><span class="line"></span><br><span class="line">    sidetable_lock();</span><br><span class="line">    isa_t bits = LoadExclusive(&amp;isa.bits);</span><br><span class="line">    ClearExclusive(&amp;isa.bits);</span><br><span class="line">    <span class="keyword">if</span> (bits.nonpointer) &#123;</span><br><span class="line">        uintptr_t rc = <span class="number">1</span> + bits.extra_rc; <span class="comment">//åŠ 1åæ‰æ˜¯çœŸæ­£çš„å¼•ç”¨è®¡æ•°ï¼Œå› ä¸ºå¯¹è±¡åˆšåˆ›å»ºæ—¶extra_rcä¸º0</span></span><br><span class="line">        <span class="keyword">if</span> (bits.has_sidetable_rc) &#123;</span><br><span class="line">            rc += sidetable_getExtraRC_nolock();</span><br><span class="line">        &#125;</span><br><span class="line">        sidetable_unlock();</span><br><span class="line">        <span class="keyword">return</span> rc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sidetable_unlock();</span><br><span class="line">    <span class="keyword">return</span> sidetable_retainCount(); <span class="comment">//çº¯pointerçš„æƒ…å†µç›´æ¥ä»sidetableè·å–</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="sidetable-retainCount"><a href="#sidetable-retainCount" class="headerlink" title="sidetable_retainCount"></a>sidetable_retainCount</h4><p>å®ç°ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">uintptr_t</span><br><span class="line">objc_object::sidetable_retainCount()</span><br><span class="line">&#123;</span><br><span class="line">    SideTable&amp; table = SideTables()[<span class="variable language_">this</span>];</span><br><span class="line"></span><br><span class="line">    size_t refcnt_result = <span class="number">1</span>; <span class="comment">//é»˜è®¤æ˜¯1</span></span><br><span class="line">    </span><br><span class="line">    table.lock();</span><br><span class="line">    RefcountMap::iterator it = table.refcnts.find(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (it != table.refcnts.end()) &#123;</span><br><span class="line">        <span class="comment">// this is valid for SIDE_TABLE_RC_PINNED too</span></span><br><span class="line">        refcnt_result += it-&gt;second &gt;&gt; SIDE_TABLE_RC_SHIFT;</span><br><span class="line">    &#125;</span><br><span class="line">    table.unlock();</span><br><span class="line">    <span class="keyword">return</span> refcnt_result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å¦‚æœå¯¹è±¡æ˜¯ä¸€ä¸ªnonpointerå¯¹è±¡ï¼Œåˆ™å¼•ç”¨è®¡æ•°è¾ƒå°æ—¶ä¼šç›´æ¥ä¿å­˜åœ¨å¯¹è±¡çš„isaæˆå‘˜å˜é‡é‡Œï¼Œåªæœ‰å½“isaé‡Œè£…ä¸ä¸‹æ—¶æ‰å­˜æ”¾åˆ°å¼•ç”¨è®¡æ•°è¡¨é‡Œï¼Œå¼•ç”¨è®¡æ•°è¡¨æ˜¯ä¸€ä¸ªå“ˆå¸Œè¡¨keyä¸ºå¯¹è±¡çš„åœ°å€ï¼Œvalueå°±æ˜¯å¼•ç”¨è®¡æ•°å€¼ã€‚</p>
<p>å¦‚æœå¯¹è±¡æ˜¯ä¸€ä¸ªpointerå¯¹è±¡ï¼Œåˆ™å¼•ç”¨è®¡æ•°å°±å­˜å‚¨åœ¨å¼•ç”¨è®¡æ•°è¡¨é‡Œã€‚</p>
<p>æœ¬æ–‡æ²¡æœ‰å¯¹ä¸Šæº¢å’Œä¸‹æº¢çš„å¤„ç†ç»†èŠ‚åšè¿‡å¤šåˆ†æï¼Œæœ‰å…´è¶£çš„å¯ä»¥ç»†ç»†ç ”ç©¶ã€‚</p>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
      <tags>
        <tag>å†…å­˜ç®¡ç†</tag>
      </tags>
  </entry>
  <entry>
    <title>RSAç®—æ³•åŸç†ä»‹ç»</title>
    <url>/2020/08/24/RSA%E7%AE%97%E6%B3%95%E5%8E%9F%E7%90%86%E4%BB%8B%E7%BB%8D/</url>
    <content><![CDATA[<h2 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h2><p><strong>è´¨æ•°</strong></p>
<p><strong>è´¨æ•°</strong>åˆç§°ç´ æ•°ï¼ŒæŒ‡<strong>åœ¨å¤§äº1çš„è‡ªç„¶æ•°ä¸­</strong>ï¼Œé™¤äº†1å’Œè¯¥æ•°è‡ªèº«å¤–ï¼Œæ— æ³•è¢«å…¶ä»–è‡ªç„¶æ•°æ•´é™¤çš„æ•°ï¼ˆä¹Ÿå¯å®šä¹‰ä¸ºåªæœ‰1ä¸è¯¥æ•°æœ¬èº«ä¸¤ä¸ªæ­£å› æ•°çš„æ•°ï¼‰ã€‚å¤§äº1çš„è‡ªç„¶æ•°è‹¥ä¸æ˜¯ç´ æ•°ï¼Œåˆ™ç§°ä¹‹ä¸ºåˆæ•°ï¼ˆä¹Ÿç§°ä¸ºåˆæˆæ•°ï¼‰ã€‚æœ€å°çš„è´¨æ•°ä¸º2ã€‚</p>
<p><strong>äº’è´¨å…³ç³»</strong></p>
<p>å¦‚æœä¸¤ä¸ªæ­£æ•´æ•°ï¼Œé™¤äº†1ä»¥å¤–ï¼Œæ²¡æœ‰å…¶ä»–å…¬å› å­ï¼Œæˆ‘ä»¬å°±ç§°è¿™ä¸¤ä¸ªæ•°æ˜¯<a href="http://zh.wikipedia.org/zh-cn/äº’ç´ ">äº’è´¨å…³ç³»</a>ï¼ˆcoprimeï¼‰ã€‚æ¯”å¦‚ï¼Œ15å’Œ32æ²¡æœ‰å…¬å› å­ï¼Œæ‰€ä»¥å®ƒä»¬æ˜¯äº’è´¨å…³ç³»ã€‚è¿™è¯´æ˜ï¼Œä¸æ˜¯è´¨æ•°ä¹Ÿå¯ä»¥æ„æˆäº’è´¨å…³ç³»ã€‚</p>
<p>å…³äºäº’è´¨å…³ç³»ï¼Œä¸éš¾å¾—åˆ°ä»¥ä¸‹ç»“è®ºï¼š</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">1</span>. ä»»æ„ä¸¤ä¸ªè´¨æ•°æ„æˆäº’è´¨å…³ç³»ï¼Œæ¯”å¦‚<span class="number">13</span>å’Œ<span class="number">61</span>ã€‚important</span><br><span class="line"></span><br><span class="line"><span class="attribute">2</span>. ä¸€ä¸ªæ•°æ˜¯è´¨æ•°ï¼Œå¦ä¸€ä¸ªæ•°åªè¦ä¸æ˜¯å‰è€…çš„å€æ•°ï¼Œä¸¤è€…å°±æ„æˆäº’è´¨å…³ç³»ï¼Œæ¯”å¦‚<span class="number">3</span>å’Œ<span class="number">10</span>ã€‚</span><br><span class="line"></span><br><span class="line"><span class="attribute">3</span>. å¦‚æœä¸¤ä¸ªæ•°ä¹‹ä¸­ï¼Œè¾ƒå¤§çš„é‚£ä¸ªæ•°æ˜¯è´¨æ•°ï¼Œåˆ™ä¸¤è€…æ„æˆäº’è´¨å…³ç³»ï¼Œæ¯”å¦‚<span class="number">97</span>å’Œ<span class="number">57</span>ã€‚</span><br><span class="line"></span><br><span class="line"><span class="attribute">4</span>. <span class="number">1</span>å’Œä»»æ„ä¸€ä¸ªè‡ªç„¶æ•°æ˜¯éƒ½æ˜¯äº’è´¨å…³ç³»ï¼Œæ¯”å¦‚<span class="number">1</span>å’Œ<span class="number">99</span>ã€‚</span><br><span class="line"></span><br><span class="line"><span class="attribute">5</span>. pæ˜¯å¤§äº<span class="number">1</span>çš„æ•´æ•°ï¼Œåˆ™på’Œp-<span class="number">1</span>æ„æˆäº’è´¨å…³ç³»ï¼Œæ¯”å¦‚<span class="number">57</span>å’Œ<span class="number">56</span>ã€‚ important</span><br><span class="line"></span><br><span class="line"><span class="attribute">6</span>. pæ˜¯å¤§äº<span class="number">1</span>çš„å¥‡æ•°ï¼Œåˆ™på’Œp-<span class="number">2</span>æ„æˆäº’è´¨å…³ç³»ï¼Œæ¯”å¦‚<span class="number">17</span>å’Œ<span class="number">15</span>ã€‚</span><br></pre></td></tr></table></figure>
<h2 id="ç”ŸæˆRSAå¯†é’¥å¯¹ï¼Œå³å…¬é’¥å’Œç§é’¥"><a href="#ç”ŸæˆRSAå¯†é’¥å¯¹ï¼Œå³å…¬é’¥å’Œç§é’¥" class="headerlink" title="ç”ŸæˆRSAå¯†é’¥å¯¹ï¼Œå³å…¬é’¥å’Œç§é’¥"></a>ç”ŸæˆRSAå¯†é’¥å¯¹ï¼Œå³å…¬é’¥å’Œç§é’¥</h2><h3 id="1ï¼šéšæœºæ‰¾ä¸¤ä¸ªè´¨æ•°-p-å’Œ-q-p-ä¸-q-è¶Šå¤§ï¼Œè¶Šå®‰å…¨ã€‚"><a href="#1ï¼šéšæœºæ‰¾ä¸¤ä¸ªè´¨æ•°-p-å’Œ-q-p-ä¸-q-è¶Šå¤§ï¼Œè¶Šå®‰å…¨ã€‚" class="headerlink" title="1ï¼šéšæœºæ‰¾ä¸¤ä¸ªè´¨æ•° p å’Œ q ,p ä¸ q è¶Šå¤§ï¼Œè¶Šå®‰å…¨ã€‚"></a>1ï¼šéšæœºæ‰¾ä¸¤ä¸ªè´¨æ•° p å’Œ q ,p ä¸ q è¶Šå¤§ï¼Œè¶Šå®‰å…¨ã€‚</h3><p>æ¯”å¦‚ p = 3 ï¼Œq = 11ã€‚è¿™é‡Œä¸ºäº†æ–¹ä¾¿åé¢è®¡ç®—ï¼Œé€‰äº†2ä¸ªå¾ˆå°çš„è´¨æ•°ï¼Œå®é™…åº”ç”¨éœ€è¦é€‰æ‹©ä¸¤ä¸ªéå¸¸å¤§çš„è´¨æ•°ã€‚</p>
<h3 id="2ï¼šè®¡ç®—på’Œqçš„ä¹˜ç§¯nã€‚"><a href="#2ï¼šè®¡ç®—på’Œqçš„ä¹˜ç§¯nã€‚" class="headerlink" title="2ï¼šè®¡ç®—på’Œqçš„ä¹˜ç§¯nã€‚"></a>2ï¼šè®¡ç®—på’Œqçš„ä¹˜ç§¯nã€‚</h3><p>è®¡ç®—ä»–ä»¬çš„ä¹˜ç§¯ n = 3 * 11 = 33 ï¼Œè½¬åŒ–ä¸ºäºŒè¿›åˆ¶ 10 0001ï¼Œè¯¥åŠ å¯†ç®—æ³•å³ä¸º 6 ä½ï¼Œå®é™…ç®—æ³•æ˜¯ 1024 ä½ æˆ– 2048 ä½ï¼Œä½æ•°è¶Šé•¿ï¼Œç®—æ³•è¶Šéš¾è¢«ç ´è§£ã€‚</p>
<h3 id="3ï¼šè®¡ç®—-n-çš„æ¬§æ‹‰å‡½æ•°-Ï†-n-ã€‚"><a href="#3ï¼šè®¡ç®—-n-çš„æ¬§æ‹‰å‡½æ•°-Ï†-n-ã€‚" class="headerlink" title="3ï¼šè®¡ç®— n çš„æ¬§æ‹‰å‡½æ•° Ï†(n)ã€‚"></a>3ï¼šè®¡ç®— n çš„æ¬§æ‹‰å‡½æ•° Ï†(n)ã€‚</h3><p>Ï†(n) è¡¨ç¤ºåœ¨å°äºç­‰äº n çš„æ­£æ•´æ•°ä¹‹ä¸­ï¼Œä¸ n æ„æˆäº’è´¨å…³ç³»çš„æ•°çš„ä¸ªæ•°ã€‚ä¾‹å¦‚ï¼šåœ¨ 1 åˆ° 8 ä¹‹ä¸­ï¼Œä¸ 8 å½¢æˆäº’è´¨å…³ç³»çš„æ˜¯1ã€3ã€5ã€7ï¼Œæ‰€ä»¥ Ï†(n) = 4ã€‚ å¦‚æœ n = p <em> qï¼Œp ä¸ q å‡ä¸ºè´¨æ•°ï¼Œåˆ™ Ï†(n) = Ï†(p </em> q)= Ï†(p - 1)Ï†(q - 1) = (p - 1)<em>(q - 1) ã€‚ æœ¬ä¾‹ä¸­ Ï†(3 </em> 11) = 2 * 10 = 20ã€‚</p>
<h3 id="4ï¼šéšæœºé€‰æ‹©ä¸€ä¸ªæ•´æ•°-eï¼Œæ¡ä»¶æ˜¯1-lt-e-lt-Ï†-n-ï¼Œä¸”-e-ä¸-Ï†-n-äº’è´¨ã€‚"><a href="#4ï¼šéšæœºé€‰æ‹©ä¸€ä¸ªæ•´æ•°-eï¼Œæ¡ä»¶æ˜¯1-lt-e-lt-Ï†-n-ï¼Œä¸”-e-ä¸-Ï†-n-äº’è´¨ã€‚" class="headerlink" title="4ï¼šéšæœºé€‰æ‹©ä¸€ä¸ªæ•´æ•° eï¼Œæ¡ä»¶æ˜¯1&lt; e &lt; Ï†(n)ï¼Œä¸” e ä¸ Ï†(n) äº’è´¨ã€‚"></a>4ï¼šéšæœºé€‰æ‹©ä¸€ä¸ªæ•´æ•° eï¼Œæ¡ä»¶æ˜¯1&lt; e &lt; Ï†(n)ï¼Œä¸” e ä¸ Ï†(n) äº’è´¨ã€‚</h3><p>è¿™é‡Œæˆ‘ä»¬éšæœºé€‰æ‹© e = 7 è¯·æ³¨æ„ä¸è¦é€‰æ‹©19 (å³Ï†(n) - 1)è¿™æ ·çš„è¾¹ç•Œå€¼ï¼Œå®¹æ˜“è¢«äººç ´è§£ã€‚å®é™…åº”ç”¨ä¸­ï¼Œå¸¸å¸¸é€‰æ‹©65537ã€‚</p>
<h3 id="5ï¼šè®¡ç®—eå¯¹äºÏ†-n-çš„æ¨¡åå…ƒç´ dã€‚"><a href="#5ï¼šè®¡ç®—eå¯¹äºÏ†-n-çš„æ¨¡åå…ƒç´ dã€‚" class="headerlink" title="5ï¼šè®¡ç®—eå¯¹äºÏ†(n)çš„æ¨¡åå…ƒç´ dã€‚"></a>5ï¼šè®¡ç®—eå¯¹äºÏ†(n)çš„æ¨¡åå…ƒç´ dã€‚</h3><p>æ‰€è°“<a href="http://zh.wikipedia.org/wiki/æ¨¡åå…ƒç´ ">â€œæ¨¡åå…ƒç´ â€</a>å°±æ˜¯æŒ‡æœ‰ä¸€ä¸ªæ•´æ•°dï¼Œå¯ä»¥ä½¿å¾—e * dé™¤ä»¥Ï†(n)çš„ä½™æ•°ä¸º1ã€‚</p>
<p>å³ï¼š</p>
<figure class="highlight excel"><table><tr><td class="code"><pre><span class="line">e * d â‰¡ <span class="number">1</span> (<span class="built_in">mod</span> Ï†(<span class="built_in">n</span>))</span><br></pre></td></tr></table></figure>
<p>ç­‰ä»·äºï¼š</p>
<figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">e * d - <span class="number">1</span> <span class="operator">=</span> kÏ†(n)</span><br></pre></td></tr></table></figure>
<p>äºæ˜¯ï¼Œæ‰¾åˆ°æ¨¡åå…ƒç´ dï¼Œå®è´¨ä¸Šå°±æ˜¯å¯¹ä¸‹é¢è¿™ä¸ªäºŒå…ƒä¸€æ¬¡æ–¹ç¨‹æ±‚è§£ã€‚</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">ex</span> + Ï†(n)y = <span class="number">1</span>  </span><br></pre></td></tr></table></figure>
<p>å·²çŸ¥ e=7, Ï†(n)=20ï¼Œ</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">7x</span> + <span class="number">20</span>y = <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹ç¨‹å¯ä»¥ç”¨<a href="http://zh.wikipedia.org/wiki/æ‰©å±•æ¬§å‡ é‡Œå¾—ç®—æ³•">â€œæ‰©å±•æ¬§å‡ é‡Œå¾—ç®—æ³•â€</a>æ±‚è§£ï¼Œæ­¤å¤„çœç•¥å…·ä½“è¿‡ç¨‹ã€‚æ€»ä¹‹ï¼Œç®—å‡ºä¸€ç»„æ•´æ•°è§£ä¸º (x,y)=(3,-1)ï¼Œå³ d=3ã€‚ä¸åŒçš„ e ç”Ÿæˆä¸åŒçš„ dï¼Œå› æ­¤å¯ä»¥ç”Ÿæˆå¤šä¸ªå¯†é’¥å¯¹ã€‚</p>
<p>è‡³æ­¤æ‰€æœ‰è®¡ç®—å®Œæˆã€‚</p>
<h3 id="6ï¼šå°†nå’Œeå°è£…æˆå…¬é’¥ï¼Œnå’Œdå°è£…æˆç§é’¥ã€‚"><a href="#6ï¼šå°†nå’Œeå°è£…æˆå…¬é’¥ï¼Œnå’Œdå°è£…æˆç§é’¥ã€‚" class="headerlink" title="6ï¼šå°†nå’Œeå°è£…æˆå…¬é’¥ï¼Œnå’Œdå°è£…æˆç§é’¥ã€‚"></a>6ï¼šå°†nå’Œeå°è£…æˆå…¬é’¥ï¼Œnå’Œdå°è£…æˆç§é’¥ã€‚</h3><p>åœ¨çˆ±ä¸½ä¸çš„ä¾‹å­ä¸­ï¼Œn = 33ï¼Œe = 7ï¼Œd = 3ï¼Œæ‰€ä»¥å…¬é’¥ï¼ˆnï¼Œeï¼‰å°±æ˜¯ (33, 7ï¼‰ï¼Œç§é’¥ï¼ˆnï¼Œdï¼‰å°±æ˜¯ï¼ˆ33, 3ï¼‰ã€‚</p>
<p>å®é™…åº”ç”¨ä¸­ï¼Œå…¬é’¥å’Œç§é’¥çš„æ•°æ®éƒ½é‡‡ç”¨<a href="http://zh.wikipedia.org/zh-cn/ASN.1">ASN.1</a>æ ¼å¼è¡¨è¾¾ï¼ˆ<a href="http://hi.baidu.com/mathack/item/d0ad4cc1514a3663f7c95da2">å®ä¾‹</a>ï¼‰ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼š</p>
<p>éšæœºé€‰æ‹©ä¸¤ä¸ªéå¸¸å¤§çš„è´¨æ•°p,qâ€”-&gt;è®¡ç®—p,qçš„ä¹˜ç§¯nâ€”â€”&gt;è®¡ç®—Ï†(n)â€”-&gt;é€‰æ‹©ä¸€ä¸ªä¸Ï†(n)äº’è´¨çš„æ•´æ•° eâ€”â€”&gt;è®¡ç®—eå¯¹äºÏ†(n)çš„æ¨¡åå…ƒç´ dã€‚</p>
<p>å¾—åˆ°å…¬é’¥ï¼šï¼ˆnï¼Œeï¼‰,ç§é’¥ï¼šï¼ˆnï¼Œdï¼‰ã€‚</p>
<h2 id="åŠ å¯†æ˜æ–‡"><a href="#åŠ å¯†æ˜æ–‡" class="headerlink" title="åŠ å¯†æ˜æ–‡"></a>åŠ å¯†æ˜æ–‡</h2><p>å…¬é’¥åŠ å¯†å…¬å¼</p>
<blockquote>
<p>ã€€ã€€m^e â‰¡ c (mod n) </p>
<p>ä¹Ÿå¯ä»¥å†™ä¸º</p>
<p>ã€€ã€€c = m^e mod n</p>
</blockquote>
<p>ç§é’¥è§£å¯†å…¬å¼</p>
<blockquote>
<p>ã€€ã€€c^d â‰¡ m (mod n)</p>
<p>ä¹Ÿå¯ä»¥å†™ä¸º</p>
<p>ã€€ã€€m = c^d mod n</p>
</blockquote>
<p>å‚æ•°è¯´æ˜ï¼š</p>
<figure class="highlight avrasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">m:</span> æ˜æ–‡</span><br><span class="line"><span class="symbol">c:</span> å¯†æ–‡</span><br><span class="line"><span class="symbol">n:</span> æ¨¡æ•°ï¼Œä¸¤ä¸ªå¾ˆå¤§çš„è´¨æ•°çš„ä¹˜ç§¯</span><br><span class="line"><span class="symbol">e:</span> å…¬é’¥æŒ‡æ•°</span><br><span class="line"><span class="symbol">d:</span> ç§é’¥æŒ‡æ•°</span><br><span class="line">(n,e) æ˜¯å…¬é’¥</span><br><span class="line">(n,d) æ˜¯ç§é’¥</span><br><span class="line">dæ˜¯eå¯¹äºÏ†(n)çš„æ¨¡åå…ƒç´ </span><br></pre></td></tr></table></figure>
<p>æ³¨1ï¼šä»ä¸Šé¢çš„å…¬å¼å¯ä»¥çœ‹å‡ºä¸€ä¸ªæ•°æ¨¡nï¼Œé‚£ä¹ˆè¿™ä¸ªæ•°è‚¯å®šä¸èƒ½å¤§äºç­‰äºnï¼Œå¦åˆ™ç»“æœä¼šæ— æ„ä¹‰ã€‚æ¯”å¦‚n=13,é‚£ä¹ˆ13æ¨¡ä¸Š13ç»“æœä¸º0ï¼Œè§£å¯†ç»“æœè¿˜æ˜¯0ï¼Œå¾—ä¸åˆ°åŸæ¥çš„æ•´æ•°äº†ã€‚</p>
<p>æ³¨2ï¼šä¹Ÿå¯ä»¥ä½¿ç”¨ç§é’¥åŠ å¯†ï¼Œå…¬é’¥è§£å¯†ï¼Œè¿™ä¸€è¿‡ç¨‹é€šå¸¸ç§°ä¸ºç­¾åã€‚å› ä¸ºåªæœ‰æœ¬äººæ‰æœ‰ç§é’¥ï¼Œæ‰€ä»¥ä½¿ç”¨ç§é’¥åŠ å¯†å¾—åˆ°çš„å¯†æ–‡å¯ä»¥ä½œä¸ºæœ¬äººçš„ç­¾åã€‚å¦‚æœå…¬é’¥èƒ½è§£å¼€ä»£è¡¨ç¡®å®æ˜¯ç”±æœ¬äººæ“ä½œã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼šå¯¹[6, 14, 7, 32]è¿›è¡ŒåŠ å¯†ã€‚åº”ç”¨ä¸Šé¢çš„åŠ å¯†å…¬å¼å¾—åˆ°ï¼š</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">6</span>^<span class="number">7</span> % <span class="number">33</span> = <span class="number">30</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">14</span>^<span class="number">7</span> % <span class="number">33</span> = <span class="number">20</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">7</span>^<span class="number">7</span> % <span class="number">33</span> = <span class="number">28</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">32</span>^<span class="number">7</span> % <span class="number">33</span> = <span class="number">32</span></span><br></pre></td></tr></table></figure>
<p>å³[6, 14, 7, 32]åŠ å¯†åå¾—åˆ°å¯†æ–‡[30, 20, 28, 32]ï¼Œå¦‚æœæ²¡æœ‰ç§é’¥ d ,ç¥ä»™ä¹Ÿæ— æ³•ä»å¯†æ–‡[30, 20, 28, 32]ä¸­æ¢å¤å‡ºæ˜æ–‡[6, 14, 7, 32]ã€‚</p>
<h2 id="è§£å¯†å¯†æ–‡"><a href="#è§£å¯†å¯†æ–‡" class="headerlink" title="è§£å¯†å¯†æ–‡"></a>è§£å¯†å¯†æ–‡</h2><p>åº”ç”¨ä¸Šé¢çš„è§£å¯†å…¬å¼</p>
<figure class="highlight excel"><table><tr><td class="code"><pre><span class="line">m = c^d <span class="built_in">mod</span> <span class="built_in">n</span></span><br></pre></td></tr></table></figure>
<p>å¾—åˆ°ï¼š</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">30</span>^<span class="number">3</span> % <span class="number">33</span> = <span class="number">6</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">20</span>^<span class="number">3</span> % <span class="number">33</span> = <span class="number">14</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">28</span>^<span class="number">3</span> % <span class="number">33</span> = <span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">32</span>^<span class="number">3</span> % <span class="number">33</span> = <span class="number">32</span></span><br></pre></td></tr></table></figure>
<p>å³[30, 20, 28, 32]è§£å¯†åå¾—åˆ°æ˜æ–‡[6, 14, 7, 32]ã€‚</p>
<h2 id="RSAåº”ç”¨"><a href="#RSAåº”ç”¨" class="headerlink" title="RSAåº”ç”¨"></a>RSAåº”ç”¨</h2><p>ä¸Šé¢æˆ‘ä»¬çŸ¥é“è¦æƒ³ç”¨RSAåŠ å¯†ï¼Œéœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š</p>
<ol>
<li>è¢«åŠ å¯†çš„æ˜æ–‡å¿…é¡»æ˜¯æ•´æ•°</li>
<li>è¯¥æ•´æ•°å¿…é¡»å¤§äº0ä¸”å°äº nã€‚è¿™æ„å‘³ç€ä¸€æ¬¡åŠ å¯†çš„æ˜æ–‡ä¸èƒ½å¤ªå¤šã€‚æ‰€ä»¥RSAæ˜¯å—åŠ å¯†ã€‚å¦‚æœè¦åŠ å¯†çš„æ˜æ–‡å¾ˆé•¿åˆ™å¿…é¡»åˆ†å—åŠ å¯†ã€‚</li>
</ol>
<p>å› æ­¤æˆ‘ä»¬çš„æ˜æ–‡éœ€è¦è½¬åŒ–ä¸ºæ•´æ•°æ‰èƒ½ä½¿ç”¨RSAåŠ å¯†ï¼Œå¦‚æœæ˜æ–‡å°±æ˜¯æ•°å­—é‚£å°±ä¸ç”¨è½¬åŒ–ï¼Œå¦‚æœæ˜¯è‹±æ–‡æˆ–è€…ä¸­æ–‡è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿç®€å•ï¼šå„ç§ç¼–ç æ–¹å¼ï¼Œæ¯”å¦‚utf-8ï¼Œgb2312ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆå°†æ˜æ–‡ä½¿ç”¨æŸç§ç¼–ç æ–¹å¼ç¼–ç ä¸ºæ•°å­—ï¼Œç„¶åä½¿ç”¨RSAåŠ å¯†ã€‚</p>
<p>æ€ä¹ˆä¿è¯è¯¥æ•´æ•°ä¸€å®šå°äº nå‘¢ï¼Ÿè¿™ä¸ªä¹Ÿå¾ˆç®€å•ï¼Œåªè¦æ˜æ–‡é•¿åº¦å°äºnçš„é•¿åº¦å³å¯ã€‚</p>
<h2 id="Padding"><a href="#Padding" class="headerlink" title="Padding"></a>Padding</h2><p>paddingå°±æ˜¯é€šè¿‡ä¸€äº›å¡«å……æ–¹å¼ä¿è¯æ˜æ–‡cçš„ä½æ•°ï¼Œä¸”ä¸èƒ½ä½¿cå¤§äºn.</p>
<p>paddingå¯ä»¥è®©RSAå¯¹åŒä¸€æ˜æ–‡åŠ å¯†çš„ç»“æœæ¯æ¬¡éƒ½ä¸ä¸€æ ·ï¼Œæé«˜å®‰å…¨æ€§ï¼Œå› ä¸ºRSAåŠ å¯†æ˜¯ç¡®å®šçš„ï¼Œå³ç»™å®šä¸€ä¸ªå¯†é’¥ï¼Œç‰¹å®šæ˜æ–‡æ€»ä¼šæ˜ å°„åˆ°ç‰¹å®šçš„å¯†æ–‡ã€‚æ”»å‡»è€…å¯ä»¥æ ¹æ®å¯†æ–‡ä¸­ç»Ÿè®¡ä¿¡æ¯è·å–æ˜æ–‡çš„ä¸€äº›ä¿¡æ¯ã€‚</p>
<p>ç›¸åŒçš„æ˜æ–‡åœ¨ä¸ç®¡åŠ å¯†å¤šå°‘æ¬¡ï¼Œå®ƒçš„å¯†æ–‡éƒ½æ˜¯ä¸€æ ·çš„ã€‚è¿™åœ¨å¯†ç å­¦ä¸­æ˜¯ä¸€ä¸ªå¤§å¿Œï¼Œå¾ˆå®¹æ˜“è¢«ç ´è§£è€…çŒœåˆ°å†…å®¹ã€‚å¯¹ç§°åŠ å¯†ç®—æ³•ä¹Ÿæœ‰è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦ç”¨æ·»åŠ éšæœºåˆå§‹åŒ–å‘é‡IVï¼Œä»¥å®ç°ç›¸åŒçš„åŠ å¯†è¯·æ±‚ï¼Œæ¯ä¸€æ¬¡å‡ºæ¥çš„ç»“æœéƒ½è¦ä¸åŒã€‚æ‰€ä»¥åŠ å¯†ç³»ç»Ÿéƒ½ä¼šé‡‡å–ä¸€å®šçš„æ‰‹æ®µç¡®ä¿æ¯æ¬¡åŠ å¯†ç»“æœéƒ½ä¸ä¸€æ ·ã€‚</p>
<p>Paddingå¡«å……æ–¹å¼ï¼š</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>å¡«å……æ–¹å¼</th>
<th>è¾“å…¥</th>
<th>è¾“å‡º</th>
</tr>
</thead>
<tbody>
<tr>
<td>RSA_PKCS1_PADDING</td>
<td>å¿…é¡» æ¯” RSA é’¥æ¨¡é•¿(modulus) çŸ­è‡³å°‘11ä¸ªå­—èŠ‚, ä¹Ÿå°±æ˜¯ã€€RSA_size(rsa) â€“ 11</td>
<td>å’Œmodulusä¸€æ ·é•¿</td>
</tr>
<tr>
<td>RSA_PKCS1_OAEP_PADDING</td>
<td>RSA_size(rsa) â€“ 41</td>
<td>å’Œmodulusä¸€æ ·é•¿</td>
</tr>
<tr>
<td>RSA_NO_PADDING</td>
<td>å¯ä»¥å’ŒRSAé’¥æ¨¡é•¿ä¸€æ ·é•¿ï¼Œå¦‚æœè¾“å…¥çš„æ˜æ–‡è¿‡é•¿ï¼Œå¿…é¡»åˆ‡å‰²ï¼Œç„¶åå¡«å……</td>
<td>å’Œmodulusä¸€æ ·é•¿</td>
</tr>
</tbody>
</table>
</div>
<p>æ„Ÿå…´è¶£çš„å¯ä»¥ç ”ç©¶ä¸‹paddingæ˜¯å¦‚ä½•è®©rsaçš„åŠ å¯†ç»“æœå˜å¾—éšæœºçš„ã€‚ç®€å•æ¥è®²å°±æ˜¯padding+æ˜æ–‡ç»„æˆæ–°çš„æ˜æ–‡å†åŠ å¯†ã€‚</p>
<figure class="highlight xl"><table><tr><td class="code"><pre><span class="line"><span class="number">00</span> <span class="number">02</span> <span class="function"><span class="title">xx</span> xx xx xx xx xx xx xx 00 ---&gt;</span>padding</span><br><span class="line"><span class="function"><span class="title">yy</span> yy yy yy yy yy yy yy yy yy yy ---&gt;</span>åŸå§‹æ˜æ–‡</span><br><span class="line">yy yy yy yy yy yy yy yy yy yy yy</span><br><span class="line">yy yy yy yy yy yy yy yy yy yy yy</span><br><span class="line">yy yy yy yy yy yy yy yy yy yy yy</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>å‡å¦‚nä¸º1024ä½ï¼Œåˆ™ä¸€ä¸ªå—å°±æ˜¯128å­—èŠ‚ï¼Œç”±äºæœ€é«˜ä½æ˜¯00ï¼Œæ‰€ä»¥æ˜æ–‡çš„å¤§å°è‚¯å®šå°äºnã€‚åŠ å¯†åå¾—åˆ°å¯†æ–‡ä¹Ÿæ˜¯128å­—èŠ‚ï¼ˆä¸è¶³çš„æœ€é«˜ä½è¡¥0ï¼‰ï¼Œè§£å¯†åæ ¹æ®å¡«å……è§„åˆ™å»æ‰å¼€å¤´çš„11ä¸ªå­—èŠ‚å¾—åˆ°åŸå§‹æ˜æ–‡ã€‚</p>
<figure class="highlight brainfuck"><table><tr><td class="code"><pre><span class="line"><span class="comment">128å­—èŠ‚å—æ˜æ–‡</span> <span class="literal">---</span>&gt; <span class="comment">RSAåŠ è§£å¯†ç³»ç»Ÿ</span> <span class="literal">----</span>&gt; <span class="comment">128å­—èŠ‚å—å¯†æ–‡</span></span><br></pre></td></tr></table></figure>
<p>ç”±äºpaddingçš„å­˜åœ¨ï¼Œå®é™…çš„æœ‰æ•ˆæ˜æ–‡é•¿åº¦æ˜¯å°äº128å­—èŠ‚çš„ã€‚å› æ­¤RSAä¸€æ¬¡åŠ å¯†çš„æ˜æ–‡é•¿åº¦æ˜¯å—æ¨¡æ•°ä½é•¿åº¦å’Œpaddingå…±åŒå½±å“çš„ã€‚</p>
<h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><h3 id="1-ä¸ºä»€ä¹ˆè¯´RSAæ˜¯éš¾ä»¥ç ´è§£çš„ï¼Ÿ"><a href="#1-ä¸ºä»€ä¹ˆè¯´RSAæ˜¯éš¾ä»¥ç ´è§£çš„ï¼Ÿ" class="headerlink" title="1.ä¸ºä»€ä¹ˆè¯´RSAæ˜¯éš¾ä»¥ç ´è§£çš„ï¼Ÿ"></a>1.ä¸ºä»€ä¹ˆè¯´RSAæ˜¯éš¾ä»¥ç ´è§£çš„ï¼Ÿ</h3><p>æˆ‘ä»¬å·²ç»çŸ¥é“RSAæ˜¯å…¬é’¥ï¼ˆnï¼Œeï¼‰ï¼Œç§é’¥ï¼ˆnï¼Œdï¼‰åŠ å¯†ç³»ç»Ÿã€‚</p>
<p>é€šå¸¸å…¬é’¥ï¼ˆnï¼Œeï¼‰æ˜¯å¯¹å¤–å…¬å¼€çš„ï¼Œè¦æƒ³ç ´è§£å°±å¿…é¡»çŸ¥é“ç§é’¥ï¼ˆnï¼Œdï¼‰ï¼Œå…¶å®å°±æ˜¯è¦ç®—å‡ºdã€‚</p>
<p>dæ€ä¹ˆæ¥çš„å‘¢ï¼Ÿæ ¹æ®<code>e * d â‰¡ 1 (mod Ï†(n))</code> è®¡ç®—å¾—æ¥çš„ï¼Œå› æ­¤éœ€è¦çŸ¥é“Ï†(n)çš„å€¼ã€‚</p>
<p>Ï†(n)æ€ä¹ˆæ¥çš„å‘¢ï¼ŸÏ†(n) = (p - 1)*(q - 1)ã€‚pï¼Œqæ˜¯nçš„ä¸¤ä¸ªè´¨å› æ•°ã€‚ä¹Ÿå°±æ˜¯è¦å¯¹ä¸€ä¸ªè¶…å¤§æ•°nåšè´¨å› æ•°åˆ†è§£ã€‚ä»¥ç›®å‰çš„è®¡ç®—æœºæ¥è¯´ï¼Œè¿˜æ˜¯å¾ˆéš¾çš„ï¼Œæ‰€ä»¥è¯´RSAæ˜¯éš¾ä»¥ç ´è§£çš„ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.ruanyifeng.com/blog/2013/06/rsa_algorithm_part_one.html">RSAç®—æ³•åŸç†ï¼ˆä¸€ï¼‰</a></p>
<p><a href="https://www.ruanyifeng.com/blog/2013/07/rsa_algorithm_part_two.html">RSAç®—æ³•åŸç†ï¼ˆäºŒï¼‰</a>  </p>
<p><a href="https://www.cnblogs.com/isyaya/p/11073149.html">RSAåŠ å¯†é•¿åº¦é™åˆ¶é—®é¢˜</a></p>
<p><a href="https://blog.cnbluebox.com/blog/2014/03/19/rsajia-mi/">RSAåŠ å¯†</a>  </p>
<p><a href="https://zhuanlan.zhihu.com/p/44185847">ä¸€æ–‡ææ‡‚ RSA ç®—æ³•</a>  ä¸¾äº†ä¸€ä¸ªå°æ•´æ•°çš„ä¾‹å­</p>
<p><a href="https://en.wikipedia.org/wiki/RSA_(cryptosystem">RSA (cryptosystem)</a>) wikiè‹±è¯­ç‰ˆï¼Œå¿…é¡»æ˜¯è‹±æ–‡ç‰ˆçš„è¦ä¸ç„¶å…¬å¼ä¼šé”™ä¹±ã€‚</p>
<p><a href="https://cloud.tencent.com/developer/article/1199963">RSAå¯†é’¥é•¿åº¦ã€æ˜æ–‡é•¿åº¦å’Œå¯†æ–‡é•¿åº¦</a></p>
<p><a href="https://blog.csdn.net/makenothing/article/details/88429511">RSAéå¯¹ç§°åŠ è§£å¯†ç®—æ³•å¡«å……æ–¹å¼ï¼ˆPaddingï¼‰</a></p>
<p><a href="https://blog.csdn.net/notechsolution/article/details/106954496">ä¸€æ–‡è¯¦è§£éå¯¹ç§°åŠ å¯†ç®—æ³•ä¹‹RSA Padding</a>  è®²è§£äº†paddingæ˜¯å¦‚ä½•è®©RSAçš„åŠ å¯†ç»“æœéšæœºæ€§çš„ã€‚</p>
]]></content>
      <categories>
        <category>å¯†ç å­¦</category>
      </categories>
      <tags>
        <tag>RSA</tag>
      </tags>
  </entry>
  <entry>
    <title>å†…å­˜å¯¹é½</title>
    <url>/2020/07/20/%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/</url>
    <content><![CDATA[<h3 id="ä¸ºä»€ä¹ˆè¦è¿›è¡Œå†…å­˜å¯¹é½"><a href="#ä¸ºä»€ä¹ˆè¦è¿›è¡Œå†…å­˜å¯¹é½" class="headerlink" title="ä¸ºä»€ä¹ˆè¦è¿›è¡Œå†…å­˜å¯¹é½"></a>ä¸ºä»€ä¹ˆè¦è¿›è¡Œå†…å­˜å¯¹é½</h3><p>ä¸»è¦æœ‰ä¸¤ä¸ªåŸå› ï¼š1.å†…å­˜å¯¹é½åå¯ä»¥å‡å°‘å†…å­˜çš„è¯»å–æ¬¡æ•°ï¼Œæé«˜å†…å­˜çš„è®¿é—®æ•ˆç‡ã€‚2.æé«˜ç¨‹åºçš„å¯ç§»æ¤æ€§ï¼Œå› ä¸ºæœ‰çš„å¹³å°å¯¹å¯»å€çš„èµ·å§‹åœ°å€æœ‰è¦æ±‚ã€‚</p>
<p>ç°ä»£è®¡ç®—æœºä¸­å†…å­˜ç©ºé—´éƒ½æ˜¯æŒ‰ç…§ byte åˆ’åˆ†çš„ï¼Œä»ç†è®ºä¸Šè®²ä¼¼ä¹å¯¹ä»»ä½•ç±»å‹çš„å˜é‡çš„è®¿é—®å¯ä»¥ä»ä»»ä½•åœ°å€å¼€å§‹ï¼Œä½†æ˜¯å®é™…çš„è®¡ç®—æœºç³»ç»Ÿå¯¹æ•°æ®åœ¨å†…å­˜ä¸­å­˜æ”¾çš„ä½ç½®æ˜¯æœ‰é™åˆ¶çš„ï¼Œå®ƒä»¬ä¼šè¦æ±‚è¿™äº›æ•°æ®çš„å†…å­˜é¦–åœ°å€çš„å€¼æ˜¯æŸä¸ªæ•°kï¼ˆé€šå¸¸å®ƒä¸º4æˆ–8ï¼‰çš„å€æ•°ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„å†…å­˜å¯¹é½ã€‚<br>æ³¨ï¼šæŸä¸ªæ•°æ˜¯4çš„å€æ•°ï¼Œä¸ä¸€å®šå°±æ˜¯8çš„å€æ•°ï¼Œæ¯”å¦‚4ã€12ã€20ã€28ã€36ã€‚ä½†åè¿‡æ¥æ˜¯8çš„å€æ•°åˆ™å¿…å®šæ˜¯4çš„å€æ•°ã€‚</p>
<p>å†…å­˜å¯¹é½ä¸»è¦æ˜¯ä¸ºäº†æé«˜å†…å­˜çš„è®¿é—®æ•ˆç‡ï¼ŒCPUè®¿é—®å†…å­˜æ—¶ï¼Œå¹¶ä¸æ˜¯é€ä¸ªå­—èŠ‚è®¿é—®ï¼Œè€Œæ˜¯ä»¥å­—é•¿ï¼ˆword sizeï¼‰ä¸ºå•ä½è®¿é—®ã€‚æ¯”å¦‚32ä½çš„CPUï¼Œå­—é•¿ä¸º4å­—èŠ‚ï¼Œé‚£ä¹ˆCPUè®¿é—®å†…å­˜çš„å•ä½ä¹Ÿæ˜¯4å­—èŠ‚ï¼Œå³ä¸€æ¬¡è¯»å–4ä¸ªå­—èŠ‚çš„å†…å­˜ã€‚åˆæ¯”å¦‚intel 32ä½cpuï¼Œæ¯ä¸ªæ€»çº¿å‘¨æœŸéƒ½æ˜¯ä»å¶æ•°åœ°å€å¼€å§‹è¯»å–32ä½çš„å†…å­˜æ•°æ®ï¼Œå¦‚æœæ•°æ®å­˜æ”¾åœ°å€ä¸æ˜¯ä»å¶æ•°å¼€å§‹ï¼Œåˆ™å¯èƒ½å‡ºç°éœ€è¦ä¸¤ä¸ªæ€»çº¿å‘¨æœŸæ‰èƒ½è¯»å–åˆ°æƒ³è¦çš„æ•°æ®ï¼Œå› æ­¤éœ€è¦åœ¨å†…å­˜ä¸­å­˜æ”¾æ•°æ®æ—¶è¿›è¡Œå¯¹é½ã€‚</p>
<p>æ€»ä¹‹ä¸€å¥è¯ï¼Œåªæœ‰å½“æ•°æ®çš„é¦–åœ°å€ä¸ºæŸä¸ªæ•°kï¼ˆé€šå¸¸å®ƒä¸º4æˆ–8ï¼‰çš„å€æ•°æ—¶ï¼ˆå¶æ•°åœ°å€ï¼‰ï¼ŒCPUéœ€è¦è¿›è¡Œæ•°æ®å‰”é™¤çš„æƒ…å†µæ‰ä¼šè¶Šå°‘å‘ç”Ÿã€‚å½“å‰”é™¤æ“ä½œæ— æ³•é¿å…æ—¶ï¼Œå‰”é™¤æ¬¡æ•°è¶Šå°‘è¶Šå¥½ï¼Œå¦‚æœæ•°æ®çš„é¦–åœ°å€æ˜¯å¥‡æ•°ï¼Œé‚£ä¹ˆCPUéœ€è¦å‰”é™¤å‰åçš„æ•°æ®ã€‚è€Œå¦‚æœæ˜¯å¶æ•°åˆ™æœ€å¥½æƒ…å†µä¸‹åªéœ€è¦å‰”é™¤å‰é¢æˆ–åé¢çš„æ•°æ®ã€‚charç±»å‹çš„å˜é‡å› ä¸ºåªå 1ä¸ªå­—èŠ‚å°±éšä¾¿äº†ã€‚</p>
<p>å‡å¦‚æ²¡æœ‰å†…å­˜å¯¹é½æœºåˆ¶ï¼Œæ•°æ®å¯ä»¥åœ¨ä»»æ„å†…å­˜åœ°å€å¤„å¼€å§‹å­˜æ”¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20200925224735.png" alt=""></p>
<p>ç°åœ¨ä¸€ä¸ªintå˜é‡å­˜æ”¾åœ¨ä»åœ°å€1å¼€å§‹çš„è¿ç»­å››ä¸ªå­—èŠ‚åœ°å€ä¸­ï¼Œè¯¥å¤„ç†å™¨å»å–æ•°æ®æ—¶ï¼Œè¦å…ˆä»0åœ°å€å¼€å§‹è¯»å–ç¬¬ä¸€ä¸ª4å­—èŠ‚å—,å‰”é™¤ä¸æƒ³è¦çš„å­—èŠ‚ï¼ˆ0åœ°å€ï¼‰,ç„¶åä»åœ°å€4å¼€å§‹è¯»å–ä¸‹ä¸€ä¸ª4å­—èŠ‚å—,åŒæ ·å‰”é™¤ä¸è¦çš„æ•°æ®ï¼ˆ5ï¼Œ6ï¼Œ7åœ°å€ï¼‰,æœ€åç•™ä¸‹çš„ä¸¤å—æ•°æ®åˆå¹¶æ”¾å…¥å¯„å­˜å™¨.è¿™éœ€è¦åšå¾ˆå¤šå·¥ä½œ.</p>
<p>å¦‚æœintå˜é‡å­˜æ”¾åœ¨ä»åœ°å€4å¼€å§‹çš„è¿ç»­å››ä¸ªå­—èŠ‚åœ°å€ä¸­ï¼Œå°±å¯ä»¥ä¸€æ¬¡è¯»å–å®Œæ•°æ®ã€‚</p>
<p>æ‰€ä»¥intå˜é‡çš„å†…å­˜é¦–åœ°å€é€šå¸¸åœ¨4çš„å€æ•°çš„åœ°å€å¤„å¼€å§‹ï¼Œæ¯”å¦‚ä¸Šé¢çš„ç¼–å·ä¸º4æˆ–8çš„åœ°å€å¤„ï¼Œè€Œä¸å¯èƒ½æ˜¯2æˆ–5è¿™æ ·çš„åœ°å€å¤„ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;sizeof(char):%lu, sizeof(int):%lu\n&quot;</span>, <span class="keyword">sizeof</span>(<span class="type">char</span>), <span class="keyword">sizeof</span>(<span class="type">int</span>));</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> ch = <span class="string">&#x27;h&#x27;</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ch:%p\n&quot;</span>, &amp;ch);</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> ch1 = <span class="string">&#x27;d&#x27;</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ch1:%p\n&quot;</span>, &amp;ch1);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> integer = <span class="number">34</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;integer:%p\n&quot;</span>, &amp;integer);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> integer1 = <span class="number">34332321</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;integer1:%p\n&quot;</span>, &amp;integer1);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> integer2 = <span class="number">3433</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;integer2:%p\n&quot;</span>, &amp;integer2);</span><br></pre></td></tr></table></figure>
<p>æ‰“å°ï¼š</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">sizeof</span>(char):<span class="number">1</span>, sizeof(int):<span class="number">4</span></span><br><span class="line"><span class="attribute">ch</span>:<span class="number">0</span>x7ffeefbff34f 	//<span class="number">140732920755023</span></span><br><span class="line"><span class="attribute">ch1</span>:<span class="number">0</span>x7ffeefbff34e	//<span class="number">140732920755022</span></span><br><span class="line"><span class="attribute">integer</span>:<span class="number">0</span>x7ffeefbff348  //<span class="number">140732920755016</span></span><br><span class="line"><span class="attribute">integer1</span>:<span class="number">0</span>x7ffeefbff344 //<span class="number">140732920755012</span></span><br><span class="line"><span class="attribute">integer2</span>:<span class="number">0</span>x7ffeefbff340 //<span class="number">140732920755008</span></span><br></pre></td></tr></table></figure>
<p>ä¼šå‘ç°ï¼š</p>
<ol>
<li>æ ˆæ˜¯å¾€ä¸‹å¢é•¿çš„ï¼Œç”±é«˜åœ°å€åˆ°ä½åœ°å€ã€‚</li>
<li>charå 1ä¸ªå­—èŠ‚æ‰€ä»¥æ”¾å“ªé‡Œéƒ½æ˜¯ä¸€æ ·çš„ï¼Œintå 4ä¸ªå­—èŠ‚ä¸ºäº†æé«˜CPUå­˜å–æ•ˆç‡æ‰€ä»¥è¿›è¡Œäº†å†…å­˜å¯¹é½ï¼Œé¦–åœ°å€é€‰æ‹©äº†4çš„å€æ•°çš„åœ°å€ã€‚</li>
</ol>
<h3 id="sizeof"><a href="#sizeof" class="headerlink" title="sizeof"></a>sizeof</h3><p><strong>sizeof</strong> æ˜¯ä¸€ä¸ªå…³é”®å­—ï¼Œç”¨äºåˆ¤æ–­å˜é‡æˆ–æ•°æ®ç±»å‹çš„å­—èŠ‚å¤§å°ã€‚å®ƒå¹¶ä¸æ˜¯ä¸€ä¸ªå‡½æ•°è€Œæ˜¯ä¸€ä¸ª<strong>ç¼–è¯‘æ—¶</strong>è¿ç®—ç¬¦ã€‚å­—èŠ‚æ•°çš„è®¡ç®—åœ¨ç¨‹åºç¼–è¯‘æ—¶è¿›è¡Œï¼Œè€Œä¸æ˜¯åœ¨ç¨‹åºæ‰§è¡Œçš„è¿‡ç¨‹ä¸­æ‰è®¡ç®—å‡ºæ¥ã€‚</p>
<p>sizeof è¿ç®—ç¬¦å¯ç”¨äºè·å–ç±»ã€ç»“æ„ã€å…±ç”¨ä½“å’Œå…¶ä»–ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®ç±»å‹çš„å¤§å°ã€‚</p>
<h3 id="å†…å­˜å¯¹é½è§„åˆ™"><a href="#å†…å­˜å¯¹é½è§„åˆ™" class="headerlink" title="å†…å­˜å¯¹é½è§„åˆ™"></a>å†…å­˜å¯¹é½è§„åˆ™</h3><p>å¯¹é½ç³»æ•°:</p>
<p>æ¯ä¸ªç‰¹å®šå¹³å°ä¸Šçš„ç¼–è¯‘å™¨éƒ½æœ‰è‡ªå·±çš„é»˜è®¤â€œå¯¹é½ç³»æ•°â€ï¼ˆä¹Ÿå«å¯¹é½æ¨¡æ•°ï¼‰ã€‚gccä¸­é»˜è®¤#pragma pack(4)ï¼Œå¯ä»¥é€šè¿‡é¢„ç¼–è¯‘å‘½ä»¤#pragma pack(n)ï¼Œn = 1,2,4,8,16æ¥æ”¹å˜è¿™ä¸€ç³»æ•°ã€‚Xcodeé»˜è®¤çš„å¯¹é½ç³»æ•°æ˜¯8ï¼ˆä¸ç¡®å®šæ˜¯å¦è·ŸCPUçš„ä½æ•°æœ‰å…³ï¼Œ32ä½çš„å°±æ˜¯4ï¼Œ64ä½çš„å°±æ˜¯8ï¼‰ã€‚</p>
<p>å¯¹é½å•ä½:</p>
<p>ç»™å®šå€¼#pragma pack(n)å’Œç»“æ„ä½“ä¸­æœ€é•¿æ•°æ®ç±»å‹é•¿åº¦ä¸­è¾ƒå°çš„é‚£ä¸ªã€‚å³min(pack, ç»“æ„ä½“ä¸­æœ€é•¿æ•°æ®ç±»å‹çš„é•¿åº¦)ã€‚å¦‚æœæ˜¯åµŒå¥—ç»“æ„ä½“é‚£ä¹ˆè®¡ç®—å¯¹é½å•ä½æ—¶éœ€è¦ä¸è¦è€ƒè™‘è¿™ä¸ªåµŒå¥—çš„ç»“æ„ä½“é‡Œçš„æˆå‘˜ï¼Ÿå®éªŒäº†ä¸€ä¸‹ï¼Œè²Œä¼¼ä¸éœ€è¦è€ƒè™‘åµŒå¥—çš„ç»“æ„ä½“ã€‚</p>
<p>å†…å­˜å¯¹é½è§„åˆ™ï¼š</p>
<p> (1) å…ƒç´ å¯¹é½ã€‚ç»“æ„ä½“ç¬¬ä¸€ä¸ªæˆå‘˜çš„åç§»é‡ï¼ˆoffsetï¼‰ä¸º0ã€‚ä¸‹ä¸€ä¸ªæ•°æ®æˆå‘˜ä¸ºåŸºæœ¬æ•°æ®ç±»å‹çš„ï¼Œåˆ™offset=æ•´æ•°å€çš„min(d, sizeof(member))ã€‚æ•°æ®æˆå‘˜ä¸ºç»“æ„ä½“çš„ï¼Œåˆ™offset=æ•´æ•°å€çš„min(pack, ssä¸­æœ€é•¿æ•°æ®ç±»å‹çš„é•¿åº¦)ã€‚</p>
<p> (2) æ€»ä½“å¯¹é½ã€‚ç»“æ„ä½“çš„æ€»å¤§å°ä¸ºå¯¹é½å•ä½çš„æ•´æ•°å€ï¼Œå¦‚æœ‰éœ€è¦ç¼–è¯‘å™¨ä¼šåœ¨æœ€æœ«ä¸€ä¸ªæˆå‘˜ä¹‹ååŠ ä¸Šå¡«å……å­—èŠ‚ã€‚</p>
<p>ä¸Šé¢çš„æ–‡å­—ç”¨å…¬å¼è¡¨è¾¾å°±æ˜¯ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span>å·²çŸ¥å¯¹é½ç³»æ•°ä¸ºpã€‚</span><br><span class="line"><span class="number">2.</span>è®¡ç®—å¯¹é½å•ä½d<span class="operator">=</span><span class="built_in">min</span>(p, <span class="built_in">max</span>(s.member))ã€‚</span><br><span class="line"><span class="number">3.</span>å…ƒç´ å¯¹é½ï¼šç¬¬ä¸€ä¸ª<span class="keyword">member</span>çš„<span class="keyword">offset</span>ä¸º<span class="number">0</span>ï¼Œå…¶ä»–<span class="keyword">member</span>çš„<span class="keyword">offset</span><span class="operator">=</span>æ•´æ•°å€çš„<span class="built_in">min</span>(d, sizeof(<span class="keyword">member</span>))ï¼Œ<span class="keyword">member</span>ä¸ºåŸºç¡€ç±»å‹ã€‚</span><br><span class="line">																									<span class="operator">=</span>æ•´æ•°å€çš„<span class="built_in">min</span>(pack, ssä¸­æœ€é•¿æ•°æ®ç±»å‹çš„é•¿åº¦)ï¼Œ<span class="keyword">member</span>ä¸ºç»“æ„ä½“,ssä»£è¡¨è¯¥ç»“æ„ä½“ã€‚</span><br><span class="line"><span class="number">4.</span>æ€»ä½“å¯¹é½ï¼šæ•´æ•°å€çš„dã€‚</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥ä½¿ç”¨offsetof(type, member)æŸ¥çœ‹ç»“æ„ä½“æŸä¸ªæˆå‘˜å­˜å‚¨çš„ä½ç½®åç§»ç»“æ„ä½“é¦–åœ°å€å¤šå°‘ä¸ªå­—èŠ‚ã€‚</p>
<p>åŸºæœ¬æ•°æ®ç±»å‹éœ€è¦å¯¹é½ï¼Œç»“æ„ä½“å¯ä»¥çœ‹æˆæ˜¯ä¸€äº›åŸºæœ¬æ•°æ®ç±»å‹çš„é›†åˆï¼Œå› æ­¤ç»“æ„ä½“ä¸ä»…éœ€è¦æ•´ä½“å¯¹é½ï¼Œå…¶å†…éƒ¨å„å˜é‡çš„é¦–åœ°å€ä¹Ÿéœ€è¦å¯¹é½ã€‚</p>
<p>Qï¼šå¯¹é½è§„åˆ™ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·çš„ï¼Ÿä¸çŸ¥é“ã€‚ä¸ºä»€ä¹ˆè¦å®šä¹‰ä¸€ä¸ªå¯¹é½å•ä½ï¼Ÿ</p>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)test_memory_align &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> pack(4) <span class="comment">//å¯¹é½ç³»æ•°é»˜è®¤æ˜¯4,å¯ä»¥é€šè¿‡è¯¥å®ä¿®æ”¹</span></span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;char: %lu byte\n&quot;</span>,<span class="keyword">sizeof</span>(<span class="type">char</span>)); <span class="comment">//1</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;int: %lu byte\n&quot;</span>,<span class="keyword">sizeof</span>(<span class="type">int</span>)); <span class="comment">//4</span></span><br><span class="line">    </span><br><span class="line">  	<span class="comment">//å¯¹é½ç³»æ•°p=4</span></span><br><span class="line">  	<span class="comment">//å¯¹é½å•ä½d=min(p, max(s.member))=4ã€‚</span></span><br><span class="line">    <span class="comment">//å…ƒç´ å¯¹é½ï¼šç¬¬ä¸€ä¸ªmemberçš„offsetä¸º0ï¼Œå…¶ä»–memberçš„offsetç­‰äºæ•´æ•°å€çš„min(d, sizeof(member))ã€‚</span></span><br><span class="line">  	<span class="comment">//æ€»ä½“å¯¹é½ï¼šæ•´æ•°å€çš„dã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s1</span> &#123;</span></span><br><span class="line">        <span class="type">int</span> i; <span class="comment">//offset:0</span></span><br><span class="line">        <span class="type">char</span> c1; <span class="comment">//offset:4</span></span><br><span class="line">        <span class="type">char</span> c2; <span class="comment">//offset:5,æ€»ä½“é•¿åº¦5+sizeof(char)=5+1=6ã€‚--&gt;æ•´ä½“å¯¹é½å¾—åˆ°8</span></span><br><span class="line">    &#125;x1;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s2</span> &#123;</span></span><br><span class="line">        <span class="type">char</span> c1; <span class="comment">//offset:0</span></span><br><span class="line">        <span class="type">int</span> i; <span class="comment">//offset:4</span></span><br><span class="line">        <span class="type">char</span> c2; <span class="comment">//offset:8,æ€»ä½“é•¿åº¦8+sizeof(char)=8+1=9ã€‚--&gt;æ•´ä½“å¯¹é½å¾—åˆ°12</span></span><br><span class="line">    &#125;x2;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s3</span> &#123;</span></span><br><span class="line">        <span class="type">char</span> c1;  <span class="comment">//offset:0</span></span><br><span class="line">        <span class="type">char</span> c2; <span class="comment">//offset:1</span></span><br><span class="line">        <span class="type">int</span> i;  <span class="comment">//offset:4,æ€»ä½“é•¿åº¦4+sizeof(int)=4+4=8ã€‚å·²ç»æ•´ä½“å¯¹é½</span></span><br><span class="line">    &#125;x3;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//å‡è®¾å¯¹é½ç³»æ•°æ˜¯8ï¼Œåˆ™å¯¹é½å•ä½=min(8,16)=8</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s4</span> &#123;</span></span><br><span class="line">        <span class="type">char</span> c1;</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="type">short</span> a; <span class="comment">//offset:8. </span></span><br><span class="line">        <span class="type">double</span> b; <span class="comment">//offset:16. </span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">s2</span> <span class="title">c</span>;</span> <span class="comment">//offset:24. 24+16=40</span></span><br><span class="line">    &#125;x4; <span class="comment">//pack = 4ã€‚sizeof=32 //pack = 8ã€‚sizeof=40</span></span><br><span class="line">  </span><br><span class="line">  	<span class="class"><span class="keyword">struct</span> <span class="title">s5</span> &#123;</span></span><br><span class="line">      	<span class="type">double</span> a;</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="class"><span class="keyword">struct</span> <span class="title">s6</span> &#123;</span></span><br><span class="line">        <span class="type">int</span> a;</span><br><span class="line">      	<span class="class"><span class="keyword">struct</span> <span class="title">s5</span> <span class="title">b</span>;</span></span><br><span class="line">    &#125;x6;</span><br><span class="line">  </span><br><span class="line">  	<span class="class"><span class="keyword">struct</span> <span class="title">s5</span> &#123;</span>  <span class="comment">//8</span></span><br><span class="line">        <span class="type">double</span> a;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s51</span> &#123;</span>  <span class="comment">//12</span></span><br><span class="line">        <span class="type">short</span> a;</span><br><span class="line">        <span class="type">double</span> b;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s52</span> &#123;</span>  <span class="comment">//12</span></span><br><span class="line">        <span class="type">char</span> a;</span><br><span class="line">        <span class="type">double</span> b;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s6</span> &#123;</span> <span class="comment">//12</span></span><br><span class="line">        <span class="type">int</span> a;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">s5</span> <span class="title">b</span>;</span> <span class="comment">//offset=4è€Œä¸æ˜¯8.offsetåªéœ€è¦æ˜¯min(4,8)çš„å€æ•°å°±è¡Œäº†ã€‚</span></span><br><span class="line">    &#125;x6;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s61</span> &#123;</span></span><br><span class="line">        <span class="type">int</span> a; <span class="comment">//offset-0</span></span><br><span class="line">        <span class="type">short</span> b;<span class="comment">//offset-4</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">s52</span> <span class="title">c</span>;</span> <span class="comment">//offsetå¹¶ä¸æ˜¯6è€Œæ˜¯8ï¼Œå¹¶ä¸æ˜¯ç½‘ä¸Šè¯´çš„ç›´æ¥æŠŠs52ç®€å•å¹³é“ºã€‚</span></span><br><span class="line">    &#125;x61;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s7</span> &#123;</span></span><br><span class="line">        <span class="type">int</span> a;  <span class="comment">//offset-0</span></span><br><span class="line">        <span class="type">short</span> b; <span class="comment">//offset-4</span></span><br><span class="line">        <span class="type">char</span> c;  <span class="comment">//offset-6</span></span><br><span class="line">        <span class="type">double</span> d; <span class="comment">//offset-8</span></span><br><span class="line">    &#125;x7;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;s1-c1:%lu\n&quot;</span>, offsetof(<span class="keyword">struct</span> s1, c1));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;s3-c1:%lu\n&quot;</span>, offsetof(<span class="keyword">struct</span> s3, c1));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;s3-c2:%lu\n&quot;</span>, offsetof(<span class="keyword">struct</span> s3, c2));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;s3-i:%lu\n&quot;</span>, offsetof(<span class="keyword">struct</span> s3, i));</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%lu\n&quot;</span>,<span class="keyword">sizeof</span>(x1));  <span class="comment">// è¾“å‡º8</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%lu\n&quot;</span>,<span class="keyword">sizeof</span>(x2));  <span class="comment">// è¾“å‡º12</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%lu\n&quot;</span>,<span class="keyword">sizeof</span>(x3));  <span class="comment">// è¾“å‡º8</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%lu\n&quot;</span>,<span class="keyword">sizeof</span>(x4));  <span class="comment">// è¾“å‡º32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://blog.csdn.net/u012611878/article/details/52455576">32ä½ä¸64ä½ç³»ç»ŸåŸºæœ¬æ•°æ®ç±»å‹çš„å­—èŠ‚æ•°</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/30007037">C/C++å†…å­˜å¯¹é½è¯¦è§£</a></p>
<p><a href="https://www.pengrl.com/p/20020/">ä¸ºä»€ä¹ˆè¦å†…å­˜å¯¹é½</a></p>
<p>æ‹“å±•é˜…è¯»</p>
<p><a href="https://embeddedartistry.com/blog/2017/02/22/generating-aligned-memory/">Generating Aligned Memory</a>   æœ‰ç©ºçœ‹ä¸€ä¸‹ã€‚</p>
<p><a href="http://lanhin.xyz/2015/03/29/c-%E8%AF%AD%E8%A8%80%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%87%BD%E6%95%B0/">C è¯­è¨€å†…å­˜åˆ†é…å‡½æ•°</a></p>
<p><a href="https://blog.csdn.net/weixin_43679037/article/details/121853460">memalignå’Œposix_memalignçš„åŒºåˆ«</a></p>
<p><a href="https://www.cnblogs.com/sigma0/p/10837760.html">mallocåˆ†é…å†…å­˜è¿›è¡Œå¯¹é½çš„æ“ä½œ</a></p>
]]></content>
      <categories>
        <category>è®¡ç®—æœºåŸºç¡€</category>
      </categories>
      <tags>
        <tag>å†…å­˜å¯¹é½</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¸€ç§å¯è¡Œçš„è¾¹ä¸‹è¾¹æ’­æ–¹æ¡ˆfor AVPlayer</title>
    <url>/2020/07/18/%E4%B8%80%E7%A7%8D%E5%8F%AF%E8%A1%8C%E7%9A%84%E8%BE%B9%E4%B8%8B%E8%BE%B9%E6%92%AD%E6%96%B9%E6%A1%88for%20AVPlayer/</url>
    <content><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>ä»€ä¹ˆæ˜¯è¾¹ä¸‹è¾¹æ’­ï¼Ÿ</p>
<p>ä¸ªäººç†è§£è¾¹ä¸‹è¾¹æ’­æŒ‡çš„æ˜¯ä»æœåŠ¡å™¨è·å–åˆ°çš„æ•°æ®ä¸€è¾¹ä¾›ç»™æ’­æ”¾å™¨æ’­æ”¾ä¸€è¾¹ç¼“å­˜åˆ°æœ¬åœ°ï¼Œå³ä½¿ç”¨ä¸€éçš„æµé‡å®Œæˆæ’­æ”¾å’Œç¼“å­˜ã€‚ä¸‹æ¬¡æ’­æ”¾æ—¶æœ‰ç¼“å­˜çš„åœ°æ–¹åˆ™æ’­æ”¾ç¼“å­˜æ•°æ®ï¼Œæ²¡æœ‰ç¼“å­˜çš„åœ°æ–¹åˆ™ä»æœåŠ¡å™¨è·å–å†æ’­æ”¾ã€‚</p>
<h3 id="0-è¾¹ä¸‹è¾¹æ’­æ–¹æ¡ˆ"><a href="#0-è¾¹ä¸‹è¾¹æ’­æ–¹æ¡ˆ" class="headerlink" title="0.è¾¹ä¸‹è¾¹æ’­æ–¹æ¡ˆ"></a>0.è¾¹ä¸‹è¾¹æ’­æ–¹æ¡ˆ</h3><p>ç›®å‰çš„è¾¹ä¸‹è¾¹æ’­å®ç°æ–¹æ¡ˆå¤§è‡´æœ‰ä¸¤ç§ï¼šä¸€ç§æ˜¯ä½¿ç”¨æœ¬åœ°ä»£ç†æœåŠ¡å™¨ï¼Œä¸€ç§æ˜¯ä½¿ç”¨ç³»ç»Ÿçš„AVAssetResourceLoaderDelegateã€‚</p>
<h4 id="ä½¿ç”¨æœ¬åœ°ä»£ç†æœåŠ¡å™¨"><a href="#ä½¿ç”¨æœ¬åœ°ä»£ç†æœåŠ¡å™¨" class="headerlink" title="ä½¿ç”¨æœ¬åœ°ä»£ç†æœåŠ¡å™¨"></a>ä½¿ç”¨æœ¬åœ°ä»£ç†æœåŠ¡å™¨</h4><p>è¯¥æ–¹æ¡ˆæ˜¯åœ¨æ’­æ”¾å™¨ä¸è§†é¢‘æºæœåŠ¡å™¨ä¹‹é—´åŠ ä¸€å±‚ä»£ç†æœåŠ¡å™¨ï¼Œæ‹¦æˆªè§†é¢‘æ’­æ”¾å™¨å‘é€çš„è¯·æ±‚ï¼Œæ ¹æ®æ‹¦æˆªçš„è¯·æ±‚ï¼Œå‘ç½‘ç»œæœåŠ¡å™¨è¯·æ±‚æ•°æ®ï¼Œç„¶åå†™åˆ°æœ¬åœ°ã€‚æœ¬åœ°ä»£ç†æœåŠ¡å™¨ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®å¹¶å‘é€ç»™æ’­æ”¾å™¨è¿›è¡Œæ’­æ”¾ã€‚</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/E26B3DA6-54DC-499A-B2E1-937E65C93A8F.png" style="zoom:50%;" /></p>
<p>å¯¹äº iOS ç«¯ä»£ç†æœåŠ¡å™¨çš„å®ç°ï¼Œå¯ä»¥å‚è€ƒå’Œä½¿ç”¨ CocoaHTTPServerã€‚å¯¹äº iOS ç«¯çš„è§†é¢‘ç¼“å­˜ç®¡ç†ï¼Œå¯ä»¥å‚è€ƒå’Œä½¿ç”¨ KTVHTTPCacheã€‚è¿™ç§æ–¹æ¡ˆéš¾åº¦è¾ƒé«˜ï¼Œä½†è‡ªä¸»å¯æ§æ€§æ›´é«˜ã€‚</p>
<h4 id="ä½¿ç”¨ç³»ç»ŸåŸç”ŸAPIâ€”AVAssetResourceLoaderDelegate"><a href="#ä½¿ç”¨ç³»ç»ŸåŸç”ŸAPIâ€”AVAssetResourceLoaderDelegate" class="headerlink" title="ä½¿ç”¨ç³»ç»ŸåŸç”ŸAPIâ€”AVAssetResourceLoaderDelegate"></a>ä½¿ç”¨ç³»ç»ŸåŸç”ŸAPIâ€”AVAssetResourceLoaderDelegate</h4><p>æ–¹æ¡ˆä¸‰è·Ÿæ–¹æ¡ˆäºŒåŸç†åŸºæœ¬ä¸€è‡´ï¼Œä½†æ˜¯ä¸éœ€è¦æˆ‘ä»¬è‡ªå·±å¼€å¯æœ¬åœ°æœåŠ¡å™¨ï¼Œå®ç°ç›¸å¯¹ç®€å•ï¼Œåªéœ€è¦éµå®ˆç›¸å…³åè®®ï¼Œæä¾›æ’­æ”¾çš„æ•°æ®å³å¯ã€‚é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨AVPlayeræ’­æ”¾éŸ³è§†é¢‘ï¼Œç³»ç»Ÿæ˜¯ä¸ä¼šæŠŠæ•°æ®ç¼“å­˜åˆ°æœ¬åœ°çš„ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®AVAssetResourceLoaderçš„delegateæ¥ä»£ç†ç³»ç»Ÿçš„è¯·æ±‚ã€‚ä»£ç†ç³»ç»Ÿè¯·æ±‚åæˆ‘ä»¬å°±å¯ä»¥å¯¹æ•°æ®è¿›è¡Œç¼“å­˜ã€‚</p>
<p>æœ¬æ–‡é‡‡ç”¨åŸç”ŸAPIæ¥å®ç°è¾¹ä¸‹è¾¹æ’­ã€‚å…·ä½“å®ç°å‚è€ƒæˆ‘çš„å¼€æºåº“ï¼š<a href="https://xxx">GSDMediaCache</a></p>
<h3 id="1-è¾¹ä¸‹è¾¹æ’­çš„éš¾ç‚¹â€”ç©ºæ´"><a href="#1-è¾¹ä¸‹è¾¹æ’­çš„éš¾ç‚¹â€”ç©ºæ´" class="headerlink" title="1.è¾¹ä¸‹è¾¹æ’­çš„éš¾ç‚¹â€”ç©ºæ´"></a>1.è¾¹ä¸‹è¾¹æ’­çš„éš¾ç‚¹â€”ç©ºæ´</h3><p>ä¸€ä¸ªè§†é¢‘åœ¨æ’­æ”¾çš„æ—¶å€™ï¼Œç”¨æˆ·éš¾å…ä¼šå¿«è¿›æˆ–å¿«é€€ï¼Œé¢‘ç¹çš„å¿«è¿›æˆ–å¿«é€€ä¼šé€ æˆå¤§é‡çš„ç©ºæ´ï¼Œè¿™ç»™ç¼“å­˜å¸¦æ¥äº†å·¨å¤§çš„éº»çƒ¦ã€‚</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20210405172404.png" style="zoom:50%;" /></p>
<p>ç»¿è‰²çš„ä»£è¡¨å·²ç¼“å­˜ï¼Œçº¢è‰²çš„ä»£è¡¨æœªç¼“å­˜ã€‚</p>
<p>è¿™é‡Œç»™å‡ºçš„è§£å†³æ–¹æ¡ˆæ˜¯ç¨€ç–æ–‡ä»¶+åŒºé—´è®°å½•è¡¨ã€‚</p>
<p>ç¨€ç–æ–‡ä»¶ï¼ˆSparse Fileï¼‰å…¶å®å°±æ˜¯ä¸€ä¸ªæ™®é€šæ–‡ä»¶ï¼Œç”¨äºä¿å­˜éŸ³è§†é¢‘æ•°æ®ï¼Œå½“æ¥æ”¶åˆ°æ•°æ®æ—¶ï¼ŒæŒ‰åŒºé—´å¡«å……è¯¥æ–‡ä»¶ã€‚</p>
<p>åŒºé—´è®°å½•è¡¨ç”¨äºè®°å½•å“ªäº›åŒºé—´æ˜¯å·²ç»ç¼“å­˜å¥½çš„ã€‚åŒºé—´è®°å½•è¡¨é‡Œå¯èƒ½æœ‰å¤šä¸ªåŒºé—´ï¼Œä½†å½“è§†é¢‘å®Œå…¨ç¼“å­˜æ—¶åŒºé—´è®°å½•è¡¨é‡Œå°±åªå‰©ä¸€ä¸ªåŒºé—´ï¼š[0, n-1]ã€‚</p>
<p>è¿™æ ·æ•´ä¸ªå·¥ä½œæµç¨‹å°±å˜ä¸ºï¼š</p>
<p>1.æ ¹æ®ç³»ç»Ÿçš„è¯·æ±‚èŒƒå›´ï¼ŒæŸ¥æ‰¾åŒºé—´è®°å½•è¡¨ï¼Œå°†ç³»ç»Ÿè¯·æ±‚æ‹†åˆ†ä¸ºä¸€ä¸ªè¯·æ±‚åˆ—è¡¨ã€‚</p>
<p>å¦‚ï¼š[æœ¬åœ°è¯·æ±‚ï¼Œè¿œç¨‹è¯·æ±‚ï¼Œæœ¬åœ°è¯·æ±‚â€¦]ã€‚</p>
<p>2.ä¾æ¬¡æ‰§è¡Œè¯·æ±‚åˆ—è¡¨ä¸­çš„æ¯ä¸ªè¯·æ±‚ï¼Œå¹¶å°†è¯·æ±‚åˆ°çš„æ•°æ®ä¾›ç»™æ’­æ”¾å™¨ã€‚</p>
<p>åœ¨å¾—åˆ°è¯·æ±‚åˆ—è¡¨åï¼Œæˆ‘ä»¬å°±éœ€è¦æ‰§è¡Œè¿™äº›è¯·æ±‚ã€‚å¯¹äºæœ¬åœ°è¯·æ±‚åˆ™ç›´æ¥ä»æœ¬åœ°éŸ³è§†é¢‘ç¼“å­˜æ–‡ä»¶ä¸­æŸ¥æ‰¾è¯¥åŒºé—´çš„æ•°æ®å¹¶è¿”å›ã€‚å¯¹äºè¿œç¨‹è¯·æ±‚åˆ™å‘èµ·HTTP rangeè¯·æ±‚ï¼Œæ¥æ”¶åˆ°æ•°æ®åæä¾›ç»™æ’­æ”¾å™¨æ’­æ”¾å¹¶ç¼“å­˜åˆ°æœ¬åœ°ã€‚</p>
<p>3.å¯¹äºè¿œç¨‹è¯·æ±‚æ¥æ”¶åˆ°æ•°æ®åç¼“å­˜åˆ°éŸ³è§†é¢‘æ–‡ä»¶ï¼Œå¹¶<strong>åˆå¹¶å¼æ›´æ–°åŒºé—´è®°å½•è¡¨</strong>ã€‚</p>
<p>è¿œç¨‹è¯·æ±‚ä¼šå‘èµ·HTTP rangeè¯·æ±‚ï¼Œæ¥æ”¶åˆ°æ•°æ®åéœ€è¦å†™å…¥åˆ°éŸ³è§†é¢‘ç¼“å­˜æ–‡ä»¶ï¼Œä¸æ­¤åŒæ—¶éœ€è¦åˆå¹¶å¼æ›´æ–°åŒºé—´è®°å½•è¡¨ã€‚æ‰€è°“åˆå¹¶å¼æ›´æ–°ï¼š<br>æ¯”å¦‚åŒºé—´è®°å½•è¡¨é‡Œæœ‰ï¼š[0, 99]ã€[200, 299]ã€‚å¦‚æœä¸‹ä¸€æ¬¡å†™å…¥çš„æ˜¯[100, 199]ï¼Œåˆ™éœ€è¦èåˆåŒºé—´å˜ä¸º[0, 299]ã€‚</p>
<p>è¿™é‡Œçš„ä¸»è¦éš¾ç‚¹å°±æ˜¯ç³»ç»Ÿè¯·æ±‚çš„æ‹†åˆ†ä¸åŒºé—´è®°å½•è¡¨çš„ç»´æŠ¤äº†ã€‚å½“ç„¶å®é™…å¼€å‘ä¸­è¿˜ä¼šé‡åˆ°å„ç§å„æ ·çš„å°é—®é¢˜ï¼Œæ¯”å¦‚è¯»å†™é—®é¢˜ï¼Œå†…å­˜é—®é¢˜ï¼Œç”šè‡³æ˜¯ç³»ç»Ÿçš„å‘ã€‚</p>
<h3 id="2-GSDMediaCache"><a href="#2-GSDMediaCache" class="headerlink" title="2.GSDMediaCache"></a>2.GSDMediaCache</h3><p>ä¸€ä¸ªåŸºäºAVPlayerçš„è¾¹ä¸‹è¾¹æ’­ç¼“å­˜æ¡†æ¶ã€‚å…·æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p>
<ol>
<li>æ”¯æŒè¾¹ä¸‹è¾¹æ’­ï¼Œä¸€éçš„æµé‡å®Œæˆæ’­æ”¾å’Œç¼“å­˜ã€‚</li>
<li>æè‡´çš„ç¼“å­˜åˆ©ç”¨ï¼Œåªæœ‰æœªç¼“å­˜çš„åŒºé—´æ‰ä¼šä»æœåŠ¡å™¨è·å–ã€‚</li>
<li>çº¿ç¨‹å®‰å…¨ã€‚</li>
<li>é«˜æ€§èƒ½ï¼Œä½å†…å­˜ã€ä½CPUæ¶ˆè€—ã€‚</li>
<li>æœ€ä½æ”¯æŒiOS10ã€‚</li>
</ol>
<h4 id="2-1æ¡†æ¶ç¤ºæ„å›¾"><a href="#2-1æ¡†æ¶ç¤ºæ„å›¾" class="headerlink" title="2.1æ¡†æ¶ç¤ºæ„å›¾"></a>2.1æ¡†æ¶ç¤ºæ„å›¾</h4><p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20210404163913.png" style="zoom:50%;" /></p>
<h4 id="2-2ç±»å›¾"><a href="#2-2ç±»å›¾" class="headerlink" title="2.2ç±»å›¾"></a>2.2ç±»å›¾</h4><p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20220113113013.png" alt=""></p>
<p>è¯´æ˜ï¼š</p>
<p>ä¸€ä¸ªresource URLå¯¹åº”ä¸€ä¸ªloaderï¼Œä¸€ä¸ªloaderç®¡ç†å¤šä¸ªloadingRequestï¼Œæ¯ä¸ªloadingRequestå¯¹åº”ä¸€ä¸ªfetchOperationç”¨äºè·å–æ•°æ®ã€‚fetchOperationå†…éƒ¨æ ¹æ®åŒºé—´è®°å½•è¡¨å°†rangeè¯·æ±‚æ‹†åˆ†ä¸ºä¸€ä¸ªè¯·æ±‚åºåˆ—ï¼Œå¦‚ï¼š[RemoteRangeTask, LocalRangeTask, RemoteRangeTask, LocalRangeTask, â€¦]ã€‚ç„¶åä¾æ¬¡æ‰§è¡ŒRangeTaskå¹¶å°†è·å–åˆ°çš„æ•°æ®æä¾›ç»™æ’­æ”¾å™¨æ’­æ”¾ã€‚</p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨iOS10ä¸Šæœ€å¥½é™åˆ¶ä¸€ä¸ªloaderç®¡ç†çš„loadingRequestæ•°é‡ï¼Œå¿…è¦æ—¶æ‰‹åŠ¨å–æ¶ˆä¸€äº›loadingRequestï¼Œä¸€èˆ¬ä¿æŒåœ¨3ä¸ªå·¦å³ã€‚å¦åˆ™åœ¨é¢‘ç¹seekçš„æ—¶å€™å®¹æ˜“å‡ºç°ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜ã€‚</p>
<p>ç”±äºæœ¬SDKä½¿ç”¨ç³»ç»Ÿçš„APIæ¥å®ç°ï¼Œé‚£ä¹ˆè‡ªç„¶éœ€è¦å¯¹AVAssetResourceLoaderDelegateè¿›è¡Œä¸€ç•ªä»‹ç»ã€‚</p>
<h3 id="3-AVAssetResourceLoaderDelegate"><a href="#3-AVAssetResourceLoaderDelegate" class="headerlink" title="3. AVAssetResourceLoaderDelegate"></a>3. AVAssetResourceLoaderDelegate</h3><h4 id="3-1-ä»£ç†ç³»ç»Ÿçš„è¯·æ±‚"><a href="#3-1-ä»£ç†ç³»ç»Ÿçš„è¯·æ±‚" class="headerlink" title="3.1 ä»£ç†ç³»ç»Ÿçš„è¯·æ±‚"></a>3.1 ä»£ç†ç³»ç»Ÿçš„è¯·æ±‚</h4><p>åœ¨ä»£ç†ç³»ç»Ÿçš„è¯·æ±‚å‰ï¼Œå¯ä»¥é€šè¿‡æŠ“åŒ…ï¼Œå¤§è‡´äº†è§£ä¸‹AVPlayeræ’­æ”¾ä¸€ä¸ªURLæ—¶çš„è¯·æ±‚æœºåˆ¶ï¼š<br>AVPlayerä¼šå…ˆè¯·æ±‚0-1çš„æ•°æ®æ®µï¼ŒæˆåŠŸåå†è¯·æ±‚ä¸€å¤§æ®µæ•°æ®ï¼Œä½†åªæ¥æ”¶ä¸€å°æ®µæ•°æ®å°±cancelæ‰è¯·æ±‚ã€‚æ’­æ”¾ä¸€å°æ®µååˆè¯·æ±‚ä¸€å¤§æ®µæ•°æ®ï¼Œä½†æ¥æ”¶ä¸€å°æ®µæ•°æ®ååˆcancelæ‰è¯·æ±‚ï¼Œå¾ªç¯è¿™ä¸ªæ“ä½œç›´åˆ°æ¥æ”¶æ‰€æœ‰æ•°æ®ã€‚è€Œå½“ç”¨æˆ·seekæ—¶ä¼šå–æ¶ˆä¹‹å‰çš„è¯·æ±‚ï¼Œç„¶åä»seekå¤„å‘èµ·ä¸€ä¸ªæ–°è¯·æ±‚ã€‚åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­AVPlayerä¼šä¸æ–­çš„å‘èµ·æ–°è¯·æ±‚ï¼Œå–æ¶ˆæ—§çš„è¯·æ±‚ï¼Œå½“ç„¶æœ‰çš„è¯·æ±‚å¯èƒ½ä¸ä¼šè¢«å–æ¶ˆå› è€Œå¯ä»¥æ­£å¸¸å®Œæˆã€‚å‘èµ·ä¸å–æ¶ˆæ˜¯AVPlayerçš„å†…éƒ¨è¡Œä¸ºï¼Œå¤–éƒ¨åªèƒ½å¾—åˆ°é€šçŸ¥è€Œä¸èƒ½ä¸»åŠ¨å‘èµ·ä¸€ä¸ªAVAssetResourceLoadingRequestã€‚</p>
<p>äº†è§£è¿™ä¸€è¿‡ç¨‹å¯¹åé¢çš„å®ç°éå¸¸æœ‰å¸®åŠ©ï¼Œä¸‹é¢æ­£å¼ä»£ç†ç³»ç»Ÿçš„è¯·æ±‚ã€‚</p>
<p>ä»£ç†ç³»ç»Ÿçš„è¯·æ±‚éå¸¸ç®€å•ï¼Œåªéœ€è¦å°†æˆ‘ä»¬çš„å¯¹è±¡è®¾ç½®ä¸º <code>AVAssetResourceLoader</code> çš„ä»£ç†ï¼Œå¹¶å®ç° <code>AVAssetResourceLoaderDelegate</code> åè®®ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//1.å°†æ­£å¸¸çš„schemeæ›¿æ¢ä¸ºè‡ªå®šä¹‰çš„schemeï¼Œå¹¶å°†selfè®¾ç½®ä¸ºresourceLoaderçš„ä»£ç†</span></span><br><span class="line">- (<span class="built_in">AVURLAsset</span> *)customSchemeAssetWithURL:(<span class="built_in">NSURL</span> *)URL options:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *,<span class="type">id</span>&gt; *)options &#123;</span><br><span class="line">    <span class="built_in">NSURL</span> *customURL = [URL gsd_customSchemeURLByAppendingSuffix:kCustomSchemeSuffix];</span><br><span class="line">    <span class="built_in">AVURLAsset</span> *urlAsset = [[<span class="built_in">AVURLAsset</span> alloc] initWithURL:customURL options:options];</span><br><span class="line">    [urlAsset.resourceLoader setDelegate:<span class="keyword">self</span> queue:<span class="keyword">self</span>.assetDelegateQueue];</span><br><span class="line">    <span class="keyword">return</span> urlAsset;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//2.å®ç°`AVAssetResourceLoaderDelegate`åè®®ä¸­çš„å¦‚ä¸‹ä¸¤ä¸ªï¼Œå¦‚æœæœ‰å…¶ä»–çš„éœ€æ±‚å¯ä»¥å®ç°å…¶ä»–å‡ ä¸ªåè®®ã€‚</span></span><br><span class="line"><span class="comment">//æ¥æ”¶åˆ°ä¸€ä¸ªæ–°çš„loadingRequestã€‚è¯¥æ–¹æ³•ä»…åœ¨ç³»ç»Ÿä¸çŸ¥é“å¦‚ä½•å¤„ç†URLAssetèµ„æºæ—¶æ‰ä¼šå›è°ƒï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰schemeã€‚å¦‚æœschemeæ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„åˆ™è¿”å›YESè¡¨ç¤ºæˆ‘ä»¬å°†æ¥ç®¡èµ„æºçš„è¯·æ±‚ï¼Œå¦åˆ™è¿”å›NOã€‚</span></span><br><span class="line">- (<span class="type">BOOL</span>)resourceLoader:(<span class="built_in">AVAssetResourceLoader</span> *)resourceLoader shouldWaitForLoadingOfRequestedResource:(<span class="built_in">AVAssetResourceLoadingRequest</span> *)loadingRequest &#123;</span><br><span class="line">    <span class="built_in">NSURL</span> *resourceURL = loadingRequest.request.URL;</span><br><span class="line">    <span class="keyword">if</span> ([resourceURL gsd_isCustomSchemeURLByContainningSuffix:kCustomSchemeSuffix]) &#123;</span><br><span class="line">        <span class="built_in">NSURL</span> *originalURL = [resourceURL gsd_recoverCustomSchemeURLByRemovingSuffix:kCustomSchemeSuffix];</span><br><span class="line">        os_unfair_lock_lock(&amp;_loaderLock);</span><br><span class="line">        GSDResourceLoader *loader = <span class="keyword">self</span>.loaderDict[originalURL];</span><br><span class="line">        <span class="keyword">if</span> (loader == <span class="literal">nil</span>) &#123;</span><br><span class="line">            loader = [[GSDResourceLoader alloc] initWithResourceURL:originalURL inSession:<span class="keyword">self</span>.session];</span><br><span class="line">            <span class="keyword">self</span>.loaderDict[originalURL] = loader;</span><br><span class="line">        &#125;</span><br><span class="line">        os_unfair_lock_unlock(&amp;_loaderLock);</span><br><span class="line">        [loader addLoadingRequest:loadingRequest];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç³»ç»Ÿå–æ¶ˆåŠ è½½èµ„æºåå›è°ƒã€‚åœ¨è¯¥æ–¹æ³•é‡Œæˆ‘ä»¬éœ€è¦å–æ¶ˆæ‰æˆ‘ä»¬ä¹‹å‰å‘çš„è¯·æ±‚ã€‚</span></span><br><span class="line">- (<span class="type">void</span>)resourceLoader:(<span class="built_in">AVAssetResourceLoader</span> *)resourceLoader didCancelLoadingRequest:(<span class="built_in">AVAssetResourceLoadingRequest</span> *)loadingRequest &#123;</span><br><span class="line">    <span class="built_in">NSURL</span> *originalURL = [loadingRequest.request.URL gsd_recoverCustomSchemeURLByRemovingSuffix:kCustomSchemeSuffix];</span><br><span class="line">    os_unfair_lock_lock(&amp;_loaderLock);</span><br><span class="line">    GSDResourceLoader *loader = <span class="keyword">self</span>.loaderDict[originalURL];</span><br><span class="line">    os_unfair_lock_unlock(&amp;_loaderLock);</span><br><span class="line">    [loader cancelLoadingRequest:loadingRequest];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ URL å¿…é¡»æ˜¯è‡ªå®šä¹‰çš„ URLSchemeï¼Œæˆ‘ä»¬éœ€è¦æŠŠåŸå§‹ URL çš„ <code>http://</code> æˆ– <code>https://</code> æ›¿æ¢æˆ <code>xxx://</code>ï¼Œåè®®æ–¹æ³•æ‰ä¼šç”Ÿæ•ˆã€‚è¿™é‡Œæˆ‘ä»¬åœ¨åŸschemeåé¢æ‹¼æ¥â€œ-mineâ€ä½œä¸ºè‡ªå®šä¹‰çš„schemeã€‚é€‰æ‹©åœ¨åŸschemeåé¢æ‹¼æ¥çš„å¥½å¤„å°±æ˜¯å½“æˆ‘ä»¬è‡ªå·±å»æœåŠ¡å™¨è¯·æ±‚çš„æ—¶å€™èƒ½å¤Ÿå¾ˆæ–¹ä¾¿çš„è§£æå‡ºåŸschemeã€‚åˆ°æ­¤ä¸ºæ­¢æˆ‘ä»¬å°±æˆåŠŸæ‹¦æˆªäº†æ’­æ”¾å™¨çš„è¯·æ±‚ï¼Œæ‹¦æˆªè¯·æ±‚ä¹‹åæˆ‘ä»¬å°±éœ€è¦è·å–æ•°æ®å¹¶æä¾›ç»™æ’­æ”¾å™¨ã€‚æ•°æ®å¯ä»¥ä»æœ¬åœ°ç¼“å­˜è·å–ä¹Ÿå¯ä»¥ä»æœåŠ¡å™¨è·å–ï¼Œè¿™æ˜¯æˆ‘ä»¬åé¢è¦åšçš„äº‹ã€‚</p>
<p>ç„¶è€Œéå¸¸å‘äººçš„äº‹æƒ…æ¥äº†ï¼Œç»è¿‡æµ‹è¯•å‘ç°åœ¨iOS10.3.3ä¸­</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)resourceLoader:(<span class="built_in">AVAssetResourceLoader</span> *)resourceLoader didCancelLoadingRequest:(<span class="built_in">AVAssetResourceLoadingRequest</span> *)loadingRequest API_AVAILABLE(macos(<span class="number">10.9</span>), ios(<span class="number">7.0</span>), tvos(<span class="number">9.0</span>)) API_UNAVAILABLE(watchos);</span><br></pre></td></tr></table></figure>
<p>didCancelLoadingRequest:æ–¹æ³•é™¤äº†æ‰‹æœºé‡å¯åçš„ç¬¬ä¸€æ¬¡è¿è¡ŒAPPä¼šè¢«è°ƒç”¨ï¼Œå…¶ä»–æ—¶å€™éƒ½ä¸ä¼šè¢«è°ƒç”¨ï¼Œéå¸¸è¯¡å¼‚ã€‚è€Œåœ¨iOS14ä¸Šåˆ™æ­£å¸¸ï¼ŒAVAssetResourceLoaderä¼šæ—¶ä¸æ—¶è°ƒç”¨didCancelLoadingRequest:è®©ä½ æœ‰æœºä¼šcancelæ‰ä¹‹å‰çš„è¯·æ±‚ï¼Œä»è€Œä¸ä¼šå‡ºç°åŒæ—¶è¿›è¡Œçš„è¯·æ±‚æ•°è¿‡å¤šçš„æƒ…å†µã€‚ä¸ºäº†é€‚é…iOS10ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±è®¾è®¡ä¸€ç§è§„åˆ™é€‚æ—¶çš„å–æ¶ˆæ‰ä¸€äº›loadingRequestï¼Œè¿™é‡Œå¯è°“æ˜¯ä¸€ä¸ªå¤©å‘ã€‚</p>
<p>å‚è€ƒï¼š<a href="https://developer.apple.com/forums/thread/29039">AVAssetResourceLoaderDelegate -resourceLoader: didCancelLoadingRequest: naver called (in the Device only)</a></p>
<h4 id="3-2-å‘èµ·è¯·æ±‚"><a href="#3-2-å‘èµ·è¯·æ±‚" class="headerlink" title="3.2 å‘èµ·è¯·æ±‚"></a>3.2 å‘èµ·è¯·æ±‚</h4><p>åœ¨åè®®</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)resourceLoader:(<span class="built_in">AVAssetResourceLoader</span> *)resourceLoader shouldWaitForLoadingOfRequestedResource:(<span class="built_in">AVAssetResourceLoadingRequest</span> *)loadingRequest;</span><br></pre></td></tr></table></figure>
<p>ä¸­æ ¹æ®loadingRequestå‚æ•°è·å–æœ¬æ¬¡çš„rangeè¯·æ±‚èŒƒå›´ï¼Œç„¶åå‘æœ¬åœ°ç¼“å­˜æˆ–æœåŠ¡å™¨å‘èµ·è¯·æ±‚è·å–æ•°æ®ã€‚</p>
<p>ä»£ç†ç³»ç»Ÿçš„è¯·æ±‚åï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®è¯·æ±‚å»è·å–ç›¸åº”çš„æ•°æ®ï¼Œè€Œåœ¨shouldWaitForLoadingOfRequestedResourceä»£ç†æ–¹æ³•é‡Œï¼Œç³»ç»Ÿç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªAVAssetResourceLoadingRequestå¯¹è±¡ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ ¹æ®AVAssetResourceLoadingRequestç›¸å…³çš„APIæ¥è·å–æœ¬æ¬¡rangeè¯·æ±‚çš„èŒƒå›´ã€‚</p>
<p>AVAssetResourceLoadingRequestï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AVAssetResourceLoadingRequest</span> : <span class="title">NSObject</span> </span>&#123;</span><br><span class="line"><span class="keyword">@private</span></span><br><span class="line">	<span class="built_in">AVAssetResourceLoadingRequestInternal</span> *_loadingRequest;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">AV_INIT_UNAVAILABLE</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>, <span class="keyword">nullable</span>) <span class="built_in">AVAssetResourceLoadingContentInformationRequest</span> *contentInformationRequest API_AVAILABLE(macos(<span class="number">10.9</span>), ios(<span class="number">7.0</span>), tvos(<span class="number">9.0</span>)) API_UNAVAILABLE(watchos);</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>, <span class="keyword">nullable</span>) <span class="built_in">AVAssetResourceLoadingDataRequest</span> *dataRequest API_AVAILABLE(macos(<span class="number">10.9</span>), ios(<span class="number">7.0</span>), tvos(<span class="number">9.0</span>)) API_UNAVAILABLE(watchos);</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)finishLoading API_AVAILABLE(macos(<span class="number">10.9</span>), ios(<span class="number">7.0</span>), tvos(<span class="number">9.0</span>)) API_UNAVAILABLE(watchos); <span class="comment">//æœ¬æ¬¡LoadingRequestè¯·æ±‚å®Œæˆæ—¶è°ƒç”¨finishLoadingé€šçŸ¥ç³»ç»Ÿã€‚</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)finishLoadingWithError:(<span class="keyword">nullable</span> <span class="built_in">NSError</span> *)error; <span class="comment">//æœ¬æ¬¡LoadingRequestè¯·æ±‚å‡ºé”™æ—¶è°ƒç”¨finishLoadingWithError:é€šçŸ¥ç³»ç»Ÿã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>contentInformationRequestï¼šè§†é¢‘å…ƒæ•°æ®ä¿¡æ¯ã€‚å¦‚æœæ²¡è®¾ç½®è¿‡åˆ™ä¸ºnilï¼Œå¦åˆ™æ˜¯è®¾ç½®çš„å€¼ã€‚å› æ­¤éœ€è¦åœ¨æ¥æ”¶åˆ°0-1çš„rangeè¯·æ±‚æ—¶è®¾ç½®è¯¥å€¼å‘Šè¯‰AVPlayerè§†é¢‘çš„ç›¸å…³ä¿¡æ¯ã€‚</p>
<p>dataRequestï¼šæ•°æ®è¯·æ±‚ï¼Œé‡Œé¢åŒ…å«æœ¬æ¬¡rangeè¯·æ±‚çš„èŒƒå›´ã€‚</p>
<p>AVAssetResourceLoadingContentInformationRequestï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AVAssetResourceLoadingContentInformationRequest</span> : <span class="title">NSObject</span> </span>&#123;</span><br><span class="line"><span class="keyword">@private</span></span><br><span class="line">	<span class="built_in">AVAssetResourceLoadingContentInformationRequestInternal</span> *_contentInformationRequest;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">AV_INIT_UNAVAILABLE</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">nullable</span>) <span class="built_in">NSString</span> *contentType; <span class="comment">//å“åº”å¤´çš„content-typeï¼Œä½†è¦è½¬ä¸ºUTIæ‰èƒ½èµ‹å€¼ç»™contentType</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="type">long</span> <span class="type">long</span> contentLength; <span class="comment">//è§†é¢‘é•¿åº¦ï¼ˆbyteï¼‰</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">getter</span>=isByteRangeAccessSupported) <span class="type">BOOL</span> byteRangeAccessSupported; <span class="comment">//æ˜¯å¦æ”¯æŒrangeè¯·æ±‚ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>AVAssetResourceLoadingDataRequestï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AVAssetResourceLoadingDataRequest</span> : <span class="title">NSObject</span> </span>&#123;</span><br><span class="line"><span class="keyword">@private</span></span><br><span class="line">	<span class="built_in">AVAssetResourceLoadingDataRequestInternal</span> *_dataRequest;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">AV_INIT_UNAVAILABLE</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="type">long</span> <span class="type">long</span> requestedOffset;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSInteger</span> requestedLength;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="type">BOOL</span> requestsAllDataToEndOfResource API_AVAILABLE(macos(<span class="number">10.11</span>), ios(<span class="number">9.0</span>), tvos(<span class="number">9.0</span>)) API_UNAVAILABLE(watchos);</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="type">long</span> <span class="type">long</span> currentOffset;</span><br><span class="line">- (<span class="type">void</span>)respondWithData:(<span class="built_in">NSData</span> *)data; <span class="comment">//å°†è¯·æ±‚åˆ°çš„æ•°æ®å¡ç»™æ’­æ”¾å™¨ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>requestedOffsetï¼šæœ¬æ¬¡rangeè¯·æ±‚çš„èµ·å§‹å­—èŠ‚ä½ç½®ã€‚</p>
<p>requestedLengthï¼šæœ¬æ¬¡rangeè¯·æ±‚çš„é•¿åº¦ã€‚</p>
<p>currentOffsetï¼šå½“å‰å·²ä¸‹è½½çš„æ•°æ®çš„åç§»é‡ã€‚requestedOffset + data.length = currentOffsetã€‚æ¯æ¬¡è°ƒç”¨respondWithData:æ–¹æ³•åï¼ŒcurrentOffsetä¼šæ”¹å˜ã€‚</p>
<p>ç¤ºæ„å›¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20210404163714.png" alt=""></p>
<h4 id="3-3-å¡æ•°æ®ç»™æ’­æ”¾å™¨æ’­æ”¾"><a href="#3-3-å¡æ•°æ®ç»™æ’­æ”¾å™¨æ’­æ”¾" class="headerlink" title="3.3 å¡æ•°æ®ç»™æ’­æ”¾å™¨æ’­æ”¾"></a>3.3 å¡æ•°æ®ç»™æ’­æ”¾å™¨æ’­æ”¾</h4><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AVAssetResourceLoadingDataRequest</span> : <span class="title">NSObject</span> </span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)respondWithData:(<span class="built_in">NSData</span> *)data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨AVAssetResourceLoadingDataRequestçš„respondWithDataæ–¹æ³•å°†ä¸‹è½½çš„æ•°æ®æä¾›ç»™æ’­æ”¾å™¨æ’­æ”¾ã€‚</p>
<h4 id="3-4-å–æ¶ˆè¯·æ±‚"><a href="#3-4-å–æ¶ˆè¯·æ±‚" class="headerlink" title="3.4 å–æ¶ˆè¯·æ±‚"></a>3.4 å–æ¶ˆè¯·æ±‚</h4><p>ç³»ç»Ÿå†…éƒ¨ä¼šä¸æ–­çš„å‘èµ·è¯·æ±‚ä¸å–æ¶ˆè¯·æ±‚ï¼Œå½“æˆ‘ä»¬æ”¶åˆ°å–æ¶ˆè¯·æ±‚çš„é€šçŸ¥æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å–æ¶ˆæ‰å¯¹åº”çš„æ•°æ®è¯·æ±‚ï¼Œæ•°æ®çš„æ¥æºå¯èƒ½æ˜¯æœ¬åœ°ç¼“å­˜ä¹Ÿæœ‰å¯èƒ½æ˜¯æœåŠ¡å™¨ï¼Œå› æ­¤å–æ¶ˆè¯·æ±‚åˆ†ä¸ºä¸¤ç§ï¼šæœ¬åœ°è¯·æ±‚å–æ¶ˆä¸è¿œç¨‹è¯·æ±‚å–æ¶ˆã€‚è¯·æ±‚çš„å–æ¶ˆè‡³å…³é‡è¦æ¯”å¦‚ç³»ç»Ÿå‘èµ·ä¸€ä¸ª0-300Mçš„rangeè¯·æ±‚ï¼Œæ°å¥½æœ¬åœ°ç¼“å­˜æœ‰è¿™ä¸ªèŒƒå›´çš„æ•°æ®ï¼Œä½†ç³»ç»Ÿæ¥æ”¶äº†20Må°±å‘èµ·äº†å–æ¶ˆï¼Œæ­¤æ—¶å¦‚æœä½ çš„æœ¬åœ°è¯·æ±‚ä¸èƒ½å–æ¶ˆçš„è¯APPå¾ˆå¿«å°±ä¼šè€—å°½æ‰‹æœºçš„å†…å­˜ç›´è‡³OOMå´©æºƒã€‚</p>
<p>åœ¨åè®®</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)resourceLoader:(<span class="built_in">AVAssetResourceLoader</span> *)resourceLoader didCancelLoadingRequest:(<span class="built_in">AVAssetResourceLoadingRequest</span> *)loadingRequest;</span><br></pre></td></tr></table></figure>
<p>ä¸­å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„è¯·æ±‚ã€‚ä½†åœ¨iOS10ä¸Šè¯¥æ–¹æ³•ä¸ä¼šè¢«å›è°ƒï¼Œå› æ­¤å¯¹äºiOS10å¯ä»¥åœ¨å‘èµ·è¯·æ±‚çš„æ—¶æœºä¸­å–æ¶ˆæ‰ä¹‹å‰çš„ä¸€äº›loadingRequestï¼Œè¿™é‡Œä¸èƒ½ä¸å–æ¶ˆä¹Ÿä¸èƒ½å…¨å–æ¶ˆä¿ç•™2~3ä¸ªloadingRequestç›®å‰æ¥çœ‹æ•ˆæœæ¯”è¾ƒå¥½ã€‚</p>
<h4 id="3-5-å®Œæˆè¯·æ±‚"><a href="#3-5-å®Œæˆè¯·æ±‚" class="headerlink" title="3.5 å®Œæˆè¯·æ±‚"></a>3.5 å®Œæˆè¯·æ±‚</h4><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AVAssetResourceLoadingRequest</span> : <span class="title">NSObject</span> </span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)finishLoading API_AVAILABLE(macos(<span class="number">10.9</span>), ios(<span class="number">7.0</span>), tvos(<span class="number">9.0</span>)) API_UNAVAILABLE(watchos); <span class="comment">//æœ¬æ¬¡LoadingRequestè¯·æ±‚å®Œæˆæ—¶è°ƒç”¨finishLoadingé€šçŸ¥ç³»ç»Ÿã€‚</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)finishLoadingWithError:(<span class="keyword">nullable</span> <span class="built_in">NSError</span> *)error; <span class="comment">//æœ¬æ¬¡LoadingRequestè¯·æ±‚å‡ºé”™æ—¶è°ƒç”¨finishLoadingWithError:é€šçŸ¥ç³»ç»Ÿã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>æœ¬æ¬¡LoadingRequestè¯·æ±‚æˆåŠŸå®Œæˆæ—¶è°ƒç”¨ <code>finishLoading</code> é€šçŸ¥ç³»ç»Ÿï¼Œå¦‚æœå¤±è´¥åˆ™è°ƒç”¨ <code>finishLoadingWithError:</code> é€šçŸ¥ç³»ç»Ÿã€‚</p>
<h3 id="4-ç¼“å­˜æ•°æ®ï¼Œå¹¶å»ºç«‹åŒºé—´è®°å½•è¡¨"><a href="#4-ç¼“å­˜æ•°æ®ï¼Œå¹¶å»ºç«‹åŒºé—´è®°å½•è¡¨" class="headerlink" title="4.ç¼“å­˜æ•°æ®ï¼Œå¹¶å»ºç«‹åŒºé—´è®°å½•è¡¨"></a>4.ç¼“å­˜æ•°æ®ï¼Œå¹¶å»ºç«‹åŒºé—´è®°å½•è¡¨</h3><p>æ•°æ®çš„ç¼“å­˜ä¸»è¦æ¶‰åŠéŸ³é¢‘å…ƒæ•°æ®çš„ä¿å­˜ï¼ŒéŸ³é¢‘æ–‡ä»¶çš„ä¿å­˜ï¼ŒåŒºé—´è®°å½•è¡¨çš„ä¿å­˜ã€‚</p>
<p>åœ¨ç¬¬ä¸€æ¬¡æ’­æ”¾çš„æ—¶å€™ï¼Œæ˜¯æ²¡æœ‰ä»»ä½•ç¼“å­˜çš„ï¼ŒåŒºé—´è®°å½•è¡¨ä¹Ÿæ²¡æœ‰åˆ›å»ºï¼Œå½“è¿œç¨‹è¯·æ±‚å‘èµ·HTTP rangeè¯·æ±‚æ¥æ”¶åˆ°æ•°æ®åå¦‚ä½•ä¿å­˜å‘¢ï¼Ÿè¿™å°±éœ€è¦ç”¨åˆ° <code>NSFileHandle</code> ã€‚</p>
<p>å¯ä»¥è°ƒç”¨ <code>NSFileHandle</code> çš„ <code>truncateFileAtOffset:</code> ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)truncateFileAtOffset:(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)offset;</span><br><span class="line">- (<span class="type">void</span>)seekToFileOffset:(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)offset;</span><br><span class="line">- (<span class="type">void</span>)writeData:(<span class="built_in">NSData</span> *)data;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºä¸€ä¸ªä¸éŸ³è§†é¢‘å¤§å°ç›¸ç­‰çš„â€ç¨€ç–æ–‡ä»¶â€ï¼Œç„¶åå¾€é‡Œå¡«å……æ•°æ®å³å¯ã€‚å†™å…¥å®Œæˆåï¼ŒåŒæ­¥æ›´æ–°åŒºé—´è®°å½•è¡¨ï¼Œè®°å½•æœ¬æ¬¡å†™å…¥çš„æ•°æ®åŒºé—´ï¼Œæ¯”å¦‚[0, 99]è¿™100ä¸ªå­—èŠ‚ã€‚å¾€åå†™å…¥çš„æ—¶å€™éœ€è¦<strong>åˆå¹¶å¼æ›´æ–°</strong>åŒºé—´è®°å½•è¡¨ã€‚</p>
<p>æ¯”å¦‚åŒºé—´è®°å½•è¡¨é‡Œæœ‰ï¼š[0, 99]ã€[200, 299]ã€‚å¦‚æœä¸‹ä¸€æ¬¡å†™å…¥çš„æ˜¯[100, 199]ï¼Œåˆ™éœ€è¦èåˆåŒºé—´å˜ä¸º[0, 299]ã€‚</p>
<p>æ³¨æ„ï¼šåŒºé—´è®°å½•è¡¨éœ€è¦æ­£ç¡®ç»´æŠ¤å¦åˆ™ä¾æ®åŒºé—´è®°å½•è¡¨ä»ç¼“å­˜æ–‡ä»¶é‡Œè¯»å–ç›¸åº”çš„æ•°æ®ç»™æ’­æ”¾å™¨æ—¶ä¼šå‡ºç°å„ç§ç”»é¢é—®é¢˜æˆ–å£°éŸ³é—®é¢˜ã€‚</p>
<h3 id="5-ç¼“å­˜æ¸…é™¤ç­–ç•¥"><a href="#5-ç¼“å­˜æ¸…é™¤ç­–ç•¥" class="headerlink" title="5.ç¼“å­˜æ¸…é™¤ç­–ç•¥"></a>5.ç¼“å­˜æ¸…é™¤ç­–ç•¥</h3><p>ç¼“å­˜æ¸…é™¤å¯ä»¥æŒ‰ç…§æœ€å¤§æ—¶é—´å’Œæœ€å¤§ç©ºé—´ä¸¤ä¸ªç»´åº¦æ¥è¿›è¡Œæ¸…é™¤ã€‚è¿›å…¥åå°åä¼˜å…ˆåˆ é™¤è¾ƒæ—§çš„ç¼“å­˜ï¼Œå¦‚æœæ£€æµ‹è¶…å‡ºæœ€å¤§ç©ºé—´åˆ™è¿›ä¸€æ­¥åˆ é™¤æ—§ç¼“å­˜ç›´è‡³å°äºæœ€å¤§ç©ºé—´çš„0.5å€ã€‚å½“ç„¶ä¹Ÿå¯ä»¥å®ç°LFUç­–ç•¥ã€‚</p>
<p>æ³¨æ„ï¼šåœ¨åˆ é™¤ç¼“å­˜æ—¶è¦ç¡®ä¿éŸ³è§†é¢‘æ•°æ®æ–‡ä»¶å’ŒåŒºé—´è®°å½•è¡¨åŒæ—¶åˆ é™¤ã€‚å¦‚æœéŸ³è§†é¢‘æ•°æ®æ–‡ä»¶åˆ é™¤äº†ä½†å´é—ç•™ä¸‹äº†åŒºé—´è®°å½•è¡¨æ˜¾ç„¶ä¼šæœ‰é—®é¢˜ã€‚</p>
<h4 id="5-1-è®¡ç®—æ–‡ä»¶å¤§å°"><a href="#5-1-è®¡ç®—æ–‡ä»¶å¤§å°" class="headerlink" title="5.1 è®¡ç®—æ–‡ä»¶å¤§å°"></a>5.1 è®¡ç®—æ–‡ä»¶å¤§å°</h4><p>åœ¨å®ç°çš„è¿‡ç¨‹ä¸­å‘ç°æ–‡ä»¶çš„å¤§å°è®¡ç®—è·Ÿæƒ³è±¡ä¸­çš„è¿˜ä¸å¤ªä¸€æ ·ã€‚</p>
<p>ç³»ç»Ÿæä¾›äº†ä¸€äº›keyç”¨äºè·å–æ–‡ä»¶ä¿¡æ¯</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Resource keys applicable only to regular files</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSURLResourceKey</span> <span class="keyword">const</span> <span class="built_in">NSURLFileSizeKey</span>                    API_AVAILABLE(macos(<span class="number">10.6</span>), ios(<span class="number">4.0</span>), watchos(<span class="number">2.0</span>), tvos(<span class="number">9.0</span>)); <span class="comment">// Total file size in bytes (Read-only, value type NSNumber)</span></span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSURLResourceKey</span> <span class="keyword">const</span> <span class="built_in">NSURLFileAllocatedSizeKey</span>           API_AVAILABLE(macos(<span class="number">10.6</span>), ios(<span class="number">4.0</span>), watchos(<span class="number">2.0</span>), tvos(<span class="number">9.0</span>)); <span class="comment">// Total size allocated on disk for the file in bytes (number of blocks times block size) (Read-only, value type NSNumber)</span></span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSURLResourceKey</span> <span class="keyword">const</span> <span class="built_in">NSURLTotalFileSizeKey</span>               API_AVAILABLE(macos(<span class="number">10.7</span>), ios(<span class="number">5.0</span>), watchos(<span class="number">2.0</span>), tvos(<span class="number">9.0</span>)); <span class="comment">// Total displayable size of the file in bytes (this may include space used by metadata), or nil if not available. (Read-only, value type NSNumber)</span></span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSURLResourceKey</span> <span class="keyword">const</span> <span class="built_in">NSURLTotalFileAllocatedSizeKey</span>      API_AVAILABLE(macos(<span class="number">10.7</span>), ios(<span class="number">5.0</span>), watchos(<span class="number">2.0</span>), tvos(<span class="number">9.0</span>)); <span class="comment">// Total allocated size of the file in bytes (this may include space used by metadata), or nil if not available. This can be less than the value returned by NSURLTotalFileSizeKey if the resource is compressed. (Read-only, value type NSNumber)</span></span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSURLResourceKey</span> <span class="keyword">const</span> <span class="built_in">NSURLIsAliasFileKey</span>                 API_AVAILABLE(macos(<span class="number">10.6</span>), ios(<span class="number">4.0</span>), watchos(<span class="number">2.0</span>), tvos(<span class="number">9.0</span>)); <span class="comment">// true if the resource is a Finder alias file or a symlink, false otherwise ( Read-only, value type boolean NSNumber)</span></span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSURLResourceKey</span> <span class="keyword">const</span> <span class="built_in">NSURLFileProtectionKey</span>              API_AVAILABLE(macos(<span class="number">10.11</span>), ios(<span class="number">9.0</span>), watchos(<span class="number">2.0</span>), tvos(<span class="number">9.0</span>)); <span class="comment">// The protection level for this file</span></span><br></pre></td></tr></table></figure>
<p>æ³¨æ„NSURLTotalFileAllocatedSizeKeyçš„è¯´æ˜ï¼šThis can be less than the value returned by NSURLTotalFileSizeKey if the resource is compressed. ä¹Ÿå°±æ˜¯è¯´æ–‡ä»¶å¤§å°å’Œæ–‡ä»¶å®é™…å ç”¨çš„ç£ç›˜å¤§å°æœ‰å¯èƒ½ä¸ä¸€è‡´ï¼Œè¿™å¾—ç›ŠäºAPFSæ–‡ä»¶ç³»ç»Ÿã€‚</p>
<p>eg: ä¸€ä¸ª553Mçš„è§†é¢‘ï¼Œåœ¨ç¼“å­˜æ—¶ä¼šå…ˆåˆå§‹åŒ–ä¸€ä¸ª553Mçš„å ä½æ–‡ä»¶ï¼Œç„¶åè¾¹ä¸‹è½½è¾¹å¾€é‡Œé¢å¡«å……å®é™…æ•°æ®ã€‚å¦‚æœæ²¡æœ‰ç¼“å­˜å®Œå°±åœæ­¢ç¼“å­˜ï¼Œæ­¤æ—¶ç”¨NSURLFileSizeKey å’Œ NSURLTotalFileAllocatedSizeKeyå»è·å–æ–‡ä»¶å¤§å°å°±ä¼šå‘ç°äºŒè€…çš„å€¼ä¸ä¸€æ ·ã€‚</p>
<p>NSURLFileSizeKey è¿”å›çš„æ˜¯æ–‡ä»¶è‡ªèº«çš„å¤§å°ã€‚è€ŒNSURLTotalFileAllocatedSizeKey è¿”å›çš„æ˜¯è¯¥æ–‡ä»¶å ç”¨çš„ç£ç›˜å¤§å°ï¼Œå› ä¸ºå®é™…åªç¼“å­˜äº†ä¸€ç‚¹ç‚¹æ•°æ®ï¼Œç³»ç»Ÿä¼šå¯¹ä»–è¿›è¡Œå‹ç¼©ã€‚æ‰€ä»¥è¯¥å€¼ä¼šå°äºNSURLFileSizeKey è¿”å›çš„å€¼ã€‚å½“å®Œå…¨ç¼“å­˜æ—¶ï¼Œè¯¥å€¼å°±ä¼šçº¦ç­‰äºNSURLFileSizeKey è¿”å›çš„å€¼ï¼ˆå®é™…ä¼šç¨å¤§äºï¼Œå› ä¸ºNSURLTotalFileAllocatedSizeKey è¿˜ä¼šè®¡ç®—å…ƒæ•°æ®å ç”¨çš„ç©ºé—´ï¼‰ã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span><span class="number">-01</span><span class="number">-26</span> <span class="number">11</span>:<span class="number">01</span>:<span class="number">24.590838</span>+<span class="number">0800</span> AudioDemo[<span class="number">6292</span>:<span class="number">586528</span>] attrs:&#123;</span><br><span class="line">    <span class="built_in">NSFileCreationDate</span> = <span class="string">&quot;2021-01-25 09:31:02 +0000&quot;</span>;</span><br><span class="line">    <span class="built_in">NSFileExtensionHidden</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">NSFileGroupOwnerAccountID</span> = <span class="number">501</span>;</span><br><span class="line">    <span class="built_in">NSFileGroupOwnerAccountName</span> = mobile;</span><br><span class="line">    <span class="built_in">NSFileModificationDate</span> = <span class="string">&quot;2021-01-26 02:43:28 +0000&quot;</span>;</span><br><span class="line">    <span class="built_in">NSFileOwnerAccountID</span> = <span class="number">501</span>;</span><br><span class="line">    <span class="built_in">NSFileOwnerAccountName</span> = mobile;</span><br><span class="line">    <span class="built_in">NSFilePosixPermissions</span> = <span class="number">420</span>;</span><br><span class="line">    <span class="built_in">NSFileProtectionKey</span> = <span class="built_in">NSFileProtectionCompleteUntilFirstUserAuthentication</span>;</span><br><span class="line">    <span class="built_in">NSFileReferenceCount</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">NSFileSize</span> = <span class="number">553363384</span>;</span><br><span class="line">    <span class="built_in">NSFileSystemFileNumber</span> = <span class="number">4470737601</span>;</span><br><span class="line">    <span class="built_in">NSFileSystemNumber</span> = <span class="number">16777223</span>;</span><br><span class="line">    <span class="built_in">NSFileType</span> = <span class="built_in">NSFileTypeRegular</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">2021</span><span class="number">-01</span><span class="number">-26</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">29.875546</span>+<span class="number">0800</span> AudioDemo[<span class="number">6292</span>:<span class="number">586700</span>] æ–‡ä»¶ï¼šfile:<span class="comment">///private/var/mobile/Containers/Data/Application/407F45FC-F6D8-411F-89FA-F014ADC5F4EA/Library/Caches/com.xq.GSDMediaCache/data/ddcada74ee08d06dda5cd13b4117ad30.mp4ï¼ŒtotalAllocatedSizeï¼š553365504</span></span><br></pre></td></tr></table></figure>
<p>iOS 14.3ä¸Šâ€œ iPhoneå­˜å‚¨ç©ºé—´â€é‡Œçš„Appâ€œæ–‡ç¨¿ä¸æ•°æ®â€åªæ˜¾ç¤ºAppæ²™ç›’Documentsç›®å½•ä¸‹æ–‡ä»¶å ç”¨çš„ç©ºé—´ï¼Œå¹¶ä¸”å±•ç¤ºçš„æ˜¯æ–‡ä»¶å®é™…å ç”¨çš„ç£ç›˜å¤§å°å³NSURLTotalFileAllocatedSizeKeyçš„å€¼ï¼Œè€ŒCacheç›®å½•ä¸‹çš„æ–‡ä»¶å¹¶ä¸ä¼šè®¡ç®—åœ¨å†…ã€‚å¯èƒ½æ˜¯å› ä¸ºCacheç›®å½•ä¸‹çš„æ–‡ä»¶åœ¨ç£ç›˜ç©ºé—´ç´§å¼ æ—¶ç³»ç»Ÿä¼šè‡ªåŠ¨æ¸…ç†ã€‚</p>
<p>iOS 10.3.3ä¸Šâ€œ iPhoneå­˜å‚¨ç©ºé—´â€é‡Œçš„Appâ€œæ–‡ç¨¿ä¸æ•°æ®â€æ˜¾ç¤ºçš„æ˜¯æ‰€æœ‰æ²™ç›’ç›®å½•ä¸‹çš„æ–‡ä»¶å ç”¨çš„ç©ºé—´ã€‚</p>
<p><strong>æ–‡ä»¶ç³»ç»Ÿ</strong></p>
<p>å‘å±•è¿‡ç¨‹ï¼šåˆ†å±‚æ–‡ä»¶ç³»ç»Ÿï¼ˆHierarchical File Systemï¼ŒHFSï¼‰â€”&gt; HFS Plus â€”&gt; APFS ï¼ˆApple File Systemï¼‰</p>
<p>APFS :</p>
<p>Apple File System replaces HFS Plus as the default file system for iOS 10.3 and later, and for macOS High Sierra and later. Apple File System offers improved file system fundamentals as well as several new features, including cloning, snapshots, space sharing, fast directory sizing, atomic safe-save, and sparse files.</p>
<p>é‡Œé¢æåˆ°äº†sparse fileï¼ˆç¨€ç–æ–‡ä»¶ï¼‰ï¼Œæ­£æ˜¯ç”±äºAPFSæ–‡ä»¶ç³»ç»Ÿæ”¯æŒç¨€ç–æ–‡ä»¶ï¼Œæ‰€ä»¥ä¸€ä¸ªç¨€ç–æ–‡ä»¶å¦‚æœä¸å¾€é‡Œå¡«å……æ•°æ®é‚£ä¹ˆå®ƒå®é™…ä¸ä¼šå ç”¨é‚£ä¹ˆå¤§çš„ç£ç›˜ç©ºé—´ã€‚</p>
<p>å‚è€ƒï¼š</p>
<p><a href="https://developer.apple.com/documentation/foundation/file_system/about_apple_file_system?language=objc">About Apple File System</a></p>
<p><a href="https://stackoverflow.com/questions/43126760/what-is-a-sparse-file-and-why-do-we-need-it">What is a sparse file and why do we need it?</a></p>
<p><a href="https://stackoverflow.com/questions/2188469/how-can-i-calculate-the-size-of-a-folder/28660040#28660040">How can I calculate the size of a folder?</a></p>
<p><a href="https://blog.csdn.net/duyusean/article/details/78643475">â€œæ–‡ä»¶å¤§å°â€å’Œâ€œå ç”¨ç©ºé—´â€çš„åŒºåˆ«</a></p>
<h3 id="6-æœ€å"><a href="#6-æœ€å" class="headerlink" title="6.æœ€å"></a>6.æœ€å</h3><p>å¦‚æœè¿™ä¸ªåº“æœ‰å¸®åŠ©åˆ°ä½ ï¼Œæ¬¢è¿ç‚¹èµï¼Œæ”¶è—ï¼Œè½¬å‘ã€‚å½“ç„¶æ”¯æŒä¸€ä¸‹ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚æœ€åè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
<h3 id="7-å‚è€ƒ"><a href="#7-å‚è€ƒ" class="headerlink" title="7.å‚è€ƒ"></a>7.å‚è€ƒ</h3><p><a href="https://www.codeproject.com/Articles/875105/Audio-streaming-and-caching-in-iOS-using">Audio streaming and caching in iOS using AVAssetResourceLoader and AVPlayer</a></p>
<p><a href="http://sky-weihao.github.io/2015/10/06/Video-streaming-and-caching-in-iOS/">iOSéŸ³è§†é¢‘å®ç°è¾¹ä¸‹è½½è¾¹æ’­æ”¾</a></p>
<p><a href="https://codertw.com/%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80/690067/">AVPlayeræ”¯æŒçš„è§†é¢‘æ ¼å¼</a>  åŸå‡ºå¤„ï¼š <a href="https://www.jianshu.com/p/7373f07f1cbf">AVPlayeræ”¯æŒçš„è§†é¢‘æ ¼å¼</a></p>
<p><a href="https://www.jianshu.com/p/def926938398">éŸ³è§†é¢‘å°è£…æ ¼å¼ã€ç¼–ç æ ¼å¼</a>  </p>
<p><a href="http://chuquan.me/2019/12/03/ios-avplayer-support-cache/">iOS AVPlayer è§†é¢‘ç¼“å­˜çš„è®¾è®¡ä¸å®ç°</a></p>
<p><a href="https://mp.weixin.qq.com/s/v1sw_Sb8oKeZ8sWyjBUXGA">å¯èƒ½æ˜¯ç›®å‰æœ€å¥½çš„ AVPlayer éŸ³è§†é¢‘ç¼“å­˜æ–¹æ¡ˆ</a></p>
<p><a href="https://mochangxing.github.io/2018/08/11/AVPlayer%E7%BC%93%E5%AD%98%E7%9A%84%E5%AE%9E%E7%8E%B0/">AVPlayer è§†é¢‘ç¼“å­˜</a>  </p>
<p><a href="https://blog.csdn.net/szk972092933/article/details/82771631">iOSéŸ³è§†é¢‘å¼€å‘â€”â€”-æµåª’ä½“</a>  </p>
<p><a href="https://blog.csdn.net/kevinpake/article/details/25626587">iOS è·å–è§†é¢‘çš„ä»»æ„ä¸€å¸§</a></p>
<p><a href="https://juejin.cn/post/6844904115416334343">IOSéŸ³è§†é¢‘ï¼ˆå››åäº”ï¼‰HTTPS è‡ªç­¾åè¯ä¹¦ å®ç°è¾¹ä¸‹è¾¹æ’­</a> </p>
<p><a href="https://zltunes.github.io/2019/04/23/avplayer-best-practice/">AVPlayer è¾¹ä¸‹è¾¹æ’­ä¸æœ€ä½³å®è·µ</a></p>
<p><a href="https://caisanze.com/post/swift-avplayer/">åŸºäºAVPlayerå®ç°éŸ³è§†é¢‘æ’­æ”¾å’Œç¼“å­˜ï¼Œæ”¯æŒè§†é¢‘ç”»é¢çš„åŒæ­¥è¾“å‡º</a></p>
<p><a href="https://github.com/vitoziv/VIMediaCache/issues/19">å¦‚æœè§†é¢‘æ‹–åŠ¨å¿«è¿›è¿™æ—¶å€™ä¼šæœ‰å£°éŸ³ä½†ç”»é¢å¡ä½äº†</a>  </p>
<p><a href="https://www.mdeditor.tw/pl/ptm8">iOSæ€§èƒ½ä¼˜åŒ–å®è·µï¼šå¤´æ¡æŠ–éŸ³å¦‚ä½•å®ç°OOMå´©æºƒç‡ä¸‹é™50%+</a>  </p>
<p><a href="http://www.samirchen.com/video-playback-bandwidth-cost/">ç‚¹æ’­ä¸­çš„æµé‡æˆæœ¬ä¼˜åŒ–</a> </p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MjM5MDE0Mjc4MA==&amp;mid=2650997049&amp;idx=1&amp;sn=079d954687944e74778df58f31078bd3&amp;chksm=bdbef96a8ac9707cd094f3737f6a32ce849066f50857b0b260fc2804e2eda22d3f6452b3cbfa&amp;scene=27#wechat_redirect">è…¾è®¯ç ”å‘æ€»ç›‘ç‹è¾‰ï¼šåäº¿çº§è§†é¢‘æ’­æ”¾æŠ€æœ¯ä¼˜åŒ–æ­ç§˜</a>   </p>
<p><a href="https://cocoapods.org/pods/NicooM3u8Downloader">NicooM3u8Downloader</a>  </p>
]]></content>
      <categories>
        <category>éŸ³è§†é¢‘</category>
      </categories>
      <tags>
        <tag>è¾¹ä¸‹è¾¹æ’­</tag>
        <tag>AVPlayer</tag>
      </tags>
  </entry>
  <entry>
    <title>é¢„å¤„ç†å‘½ä»¤ä¹‹å®å®šä¹‰</title>
    <url>/2020/07/03/%E9%A2%84%E5%A4%84%E7%90%86%E5%91%BD%E4%BB%A4%E4%B9%8B%E5%AE%8F%E5%AE%9A%E4%B9%89/</url>
    <content><![CDATA[<p>è¿™é‡Œä¸è°ˆå®çš„ä½¿ç”¨ã€‚åªæ˜¯çªç„¶æƒ³çŸ¥é“å®šä¹‰ä¸€ä¸ªå®ä¹‹åï¼Œè¿™ä¸ªå®çš„ä½œç”¨åŸŸæœ‰å¤šå¤§ã€‚</p>
<h3 id="å®å®šä¹‰ä½œç”¨åŸŸ"><a href="#å®å®šä¹‰ä½œç”¨åŸŸ" class="headerlink" title="å®å®šä¹‰ä½œç”¨åŸŸ"></a>å®å®šä¹‰ä½œç”¨åŸŸ</h3><p>Cè¯­è¨€æ ‡å‡†ä¸­å®å®šä¹‰çš„ä½œç”¨åŸŸæ˜¯ï¼šå¦‚æœæ˜¯åœ¨å—ä½œç”¨åŸŸå†…ï¼Œåˆ™ä»å®šä¹‰ä½ç½®å¼€å§‹ï¼Œåˆ°å—ä½œç”¨åŸŸç»“æŸï¼Œå¦åˆ™åˆ°å…¶å½“å‰æ–‡ä»¶ç»“å°¾ï¼Œå…¶ä»–æ–‡ä»¶å¦‚æœæ²¡æœ‰é€šè¿‡#includeåŒ…å«è¿™ä¸ªæ–‡ä»¶ï¼Œåˆ™ä½¿ç”¨è¯¥å®æ˜¯æ— æ•ˆçš„ã€‚</p>
<p>æ¯”å¦‚æˆ‘åœ¨a.mé‡Œé¢å®šä¹‰äº†ä¸€ä¸ªå®<code>#define kCondTrue 1</code>ï¼Œåœ¨b.mé‡Œé¢æœ‰å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)btnDidClicked:(<span class="built_in">UIButton</span> *)sender &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;btnDidClicked&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> kCondTrue			<span class="comment">//ä¸ä¼šæœ‰ç¼–è¯‘é”™è¯¯</span></span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;111&quot;</span>);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±äºkCondTrueå®å¯¹b.mæ˜¯ä¸å¯è§çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸ä¼šæ‰“å°111ã€‚</p>
<p>é€šå¸¸ç¼–è¯‘å™¨ä¼šæœ‰ä¸€äº›é¢„å®šä¹‰å®ï¼Œé¢„å®šä¹‰çš„å®å¤§å¤šä¼šéµå®ˆå‘½åè§„åˆ™ï¼š<code>__xxx_yyy__</code>ï¼Œä»¥åŒä¸‹åˆ’çº¿å¼€å§‹å’Œç»“æŸã€‚æ¯”å¦‚<code>__OBJC2__</code>å°±æ˜¯ä¸€ä¸ªé¢„å®šä¹‰çš„å®ã€‚</p>
<p>å®å®šä¹‰å¾ˆå¼ºå¤§ï¼Œç»„åˆèµ·æ¥å¯ä»¥å®ç°ä¸€ä¸ªå¾ˆå¤æ‚çš„åŠŸèƒ½ã€‚but è¿™æ ·çš„å®å¯è¯»æ€§æ˜¯å¾ˆå·®çš„ï¼Œä½ å¯ä»¥æƒ³è±¡ä¸€ä¸‹ä¸€ä¸ªç”±åå‡ ä¸ªå®å…±åŒç»„åˆå®Œæˆçš„å®æœ‰å¤šä¹ˆå¯æ€•ï¼ŒOCå¼€æºæºç é‡Œé¢åŸå­æ“ä½œç›¸å…³çš„å®æ˜¯çœŸæ»´ææ€–ã€‚æ„Ÿè§‰å¦‚æœä¸€ä¸ªå®è¿‡äºå¤æ‚æœ€å¥½è¿˜æ˜¯ç”¨æ–¹æ³•ä»£æ›¿ã€‚</p>
<p>å®Œäº†ã€‚</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://www.cnblogs.com/jiuyi/archive/2018/12/20/10149625.html">C å’Œ Objective-Cä¸­çš„ #ifdef #ifndef</a></p>
<p><a href="https://onevcat.com/2014/01/black-magic-in-macro/">å®å®šä¹‰çš„é»‘é­”æ³• - å®èœé¸Ÿèµ·é£æ‰‹å†Œ</a></p>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
      <tags>
        <tag>é¢„å¤„ç†å‘½ä»¤</tag>
      </tags>
  </entry>
  <entry>
    <title>ä»æ±‡ç¼–è§’åº¦çœ‹ARCä¸­çš„æ‰€æœ‰æƒä¿®é¥°ç¬¦</title>
    <url>/2020/06/21/%E4%BB%8E%E6%B1%87%E7%BC%96%E8%A7%92%E5%BA%A6%E7%9C%8BARC%E4%B8%AD%E7%9A%84%E6%89%80%E6%9C%89%E6%9D%83%E4%BF%AE%E9%A5%B0%E7%AC%A6/</url>
    <content><![CDATA[<p>ç¯å¢ƒï¼šXcode11</p>
<h3 id="ARC"><a href="#ARC" class="headerlink" title="ARC"></a>ARC</h3><p>åœ¨MRCæ—¶ä»£ <code>id obj1 = obj;</code> è¿™ä¸€è¡Œä»£ç ä»…ä»…æ˜¯èµ‹å€¼ï¼Œä¸ä¼šå¼•èµ·objå¯¹è±¡å¼•ç”¨è®¡æ•°çš„ä»»ä½•å˜åŒ–ã€‚è€Œåœ¨ARCæ—¶ä»£è¿™ä¸€è¡Œä»£ç ä¼šå¯¼è‡´å¯¹è±¡çš„å¼•ç”¨è®¡æ•°+1ã€‚è¿™èƒŒåç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿæ¥ä¸‹æ¥è®©æˆ‘ä»¬ç ”ç©¶ä¸€ä¸‹ã€‚</p>
<p>ARCï¼šè‡ªåŠ¨å¼•ç”¨è®¡æ•°ã€‚ä¸å†éœ€è¦æ‰‹åŠ¨è°ƒç”¨ retain ã€releaseã€autorelease ç­‰æ–¹æ³•ï¼Œè€Œæ˜¯ç”±ç¼–è¯‘å™¨åœ¨åˆé€‚çš„åœ°æ–¹è‡ªåŠ¨æ·»åŠ ã€‚é‚£ä¹ˆç¼–è¯‘å™¨åˆæ˜¯æ€ä¹ˆçŸ¥é“æ˜¯æ·»åŠ retainè¿˜æ˜¯æ·»åŠ autoreleaseæˆ–è€…weakçš„å‘¢ï¼Ÿè¿™å°±éœ€è¦æ‰€æœ‰æƒä¿®é¥°ç¬¦äº†ã€‚é€šè¿‡ä¸åŒç±»å‹çš„æ‰€æœ‰æƒä¿®é¥°ç¬¦ï¼Œç¼–è¯‘å™¨å°±çŸ¥é“è¯¥æ·»åŠ ä»€ä¹ˆè¯­å¥äº†ã€‚</p>
<p>ARC æœ‰æ•ˆæ—¶ï¼Œ<strong>id ç±»å‹å’Œå¯¹è±¡ç±»å‹</strong>å¿…é¡»é™„åŠ æ‰€æœ‰æƒä¿®é¥°ç¬¦ï¼Œæœ‰å¦‚ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>__strong ä¿®é¥°ç¬¦</li>
<li>__weak ä¿®é¥°ç¬¦</li>
<li>__unsafe_unretained ä¿®é¥°ç¬¦</li>
<li>__autoreleasing ä¿®é¥°ç¬¦</li>
</ul>
<p>å…¶ä¸­ <code>__strong</code> ä¿®é¥°ç¬¦æ˜¯OCå¯¹è±¡ç±»å‹çš„é»˜è®¤ä¿®é¥°ç¬¦ã€‚</p>
<p>æ¥ä¸‹æ¥ä»æ±‡ç¼–è§’åº¦çœ‹ï¼Œå½“ä¸€ä¸ªæŒ‡é’ˆå˜é‡ä½¿ç”¨è¿™äº›ä¿®é¥°ç¬¦åï¼Œç¼–è¯‘å™¨ä¼šä½œä½•å¤„ç†ã€‚</p>
<h3 id="strong-ä¿®é¥°ç¬¦"><a href="#strong-ä¿®é¥°ç¬¦" class="headerlink" title="__strong ä¿®é¥°ç¬¦"></a>__strong ä¿®é¥°ç¬¦</h3><p>å¯¹äºä¸‹é¢çš„ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> * argv[])</span> &#123;</span><br><span class="line">   @autoreleasepool &#123;</span><br><span class="line">       id obj = [NSObject new];</span><br><span class="line">       &#123;</span><br><span class="line">         id __strong obj1 = obj; <span class="comment">//å¼•ç”¨è®¡æ•°ä¸º2</span></span><br><span class="line">         NSLog(@<span class="string">&quot;obj1:%@&quot;</span>, obj1);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹åº”æ±‡ç¼–ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Ltmp0:</span><br><span class="line">     .loc    1 12 22 prologue_end    ## WeakDemo/main.m:12:22</span><br><span class="line">     callq    _objc_autoreleasePoolPush</span><br><span class="line"> Ltmp1:</span><br><span class="line">     .loc    1 13 18                 ## WeakDemo/main.m:13:18</span><br><span class="line">     movq    _OBJC_CLASSLIST_REFERENCES_$_(%rip), %rcx</span><br><span class="line">     movq    _OBJC_SELECTOR_REFERENCES_(%rip), %rsi</span><br><span class="line">     movq    %rcx, %rdi</span><br><span class="line">     movq    %rax, -40(%rbp)         ## 8-byte Spill</span><br><span class="line">     callq    *_objc_msgSend@GOTPCREL(%rip)</span><br><span class="line">     .loc    1 13 12 is_stmt 0       ## WeakDemo/main.m:13:12</span><br><span class="line">     movq    %rax, -24(%rbp)</span><br><span class="line"> Ltmp2:</span><br><span class="line">     .loc    1 15 23 is_stmt 1       ## WeakDemo/main.m:15:23</span><br><span class="line">     movq    -24(%rbp), %rdi</span><br><span class="line">     callq    *_objc_retain@GOTPCREL(%rip)</span><br><span class="line">     leaq    L__unnamed_cfstring_(%rip), %rcx</span><br><span class="line">     movq    %rax, -32(%rbp)</span><br><span class="line">     .loc    1 16 29                 ## WeakDemo/main.m:16:29</span><br><span class="line">     movq    -32(%rbp), %rsi</span><br><span class="line">     .loc    1 16 11 is_stmt 0       ## WeakDemo/main.m:16:11</span><br><span class="line">     movq    %rcx, %rdi</span><br><span class="line">     movb    $0, %al</span><br><span class="line">     callq    _NSLog</span><br><span class="line">     xorl    %edx, %edx</span><br><span class="line">     movl    %edx, %esi</span><br><span class="line"> Ltmp3:</span><br><span class="line">     .loc    1 17 9 is_stmt 1        ## WeakDemo/main.m:17:9</span><br><span class="line">     leaq    -32(%rbp), %rdi</span><br><span class="line">     callq    _objc_storeStrong</span><br><span class="line">     xorl    %edx, %edx</span><br><span class="line">     movl    %edx, %esi</span><br><span class="line">     .loc    1 18 5                  ## WeakDemo/main.m:18:5</span><br><span class="line">     leaq    -24(%rbp), %rdi</span><br><span class="line">     callq    _objc_storeStrong</span><br><span class="line">     movq    -40(%rbp), %rdi         ## 8-byte Reload</span><br><span class="line">     callq    _objc_autoreleasePoolPop</span><br><span class="line">     xorl    %eax, %eax</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°æ±‡ç¼–å¯¹åº”çš„ç¼–è¯‘å™¨çš„æ¨¡æ‹Ÿæºä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">id obj = objc_msgSend(NSObject, <span class="string">&quot;new&quot;</span>);</span><br><span class="line"></span><br><span class="line">id obj1 = objc_retain(obj);  <span class="comment">//æ’å…¥objc_retain</span></span><br><span class="line">NSLog(@<span class="string">&quot;obj1:%@&quot;</span>, obj1);</span><br><span class="line">objc_storeStrong(&amp;obj1, nil); <span class="comment">//obj1ä½œç”¨åŸŸç»“æŸï¼Œé‡Šæ”¾å¯¹è±¡ï¼Œå¹¶å°†obj1ç½®ä¸ºnilã€‚</span></span><br><span class="line"></span><br><span class="line">objc_storeStrong(&amp;obj, nil);</span><br></pre></td></tr></table></figure>
<p><code>id __strong obj1 = obj;</code> è¿™å¥ä»£ç å®é™…ä¸Šè¢«ç¼–è¯‘å™¨è½¬æ¢ä¸ºï¼š<code>id obj1 = objc_retain(obj);</code> ã€‚ </p>
<p>çœ‹ä¸€ä¸‹å‡½æ•°objc_retainçš„å®ç°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">__attribute__((<span class="built_in">aligned</span>(<span class="number">16</span>), flatten, noinline))</span><br><span class="line"><span class="function">id </span></span><br><span class="line"><span class="function"><span class="title">objc_retain</span><span class="params">(id obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!obj) <span class="keyword">return</span> obj;</span><br><span class="line">    <span class="keyword">if</span> (obj-&gt;<span class="built_in">isTaggedPointer</span>()) <span class="keyword">return</span> obj;</span><br><span class="line">    <span class="keyword">return</span> obj-&gt;<span class="built_in">retain</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Equivalent to calling [this retain], with shortcuts if there is no override</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> id </span></span><br><span class="line"><span class="function"><span class="title">objc_object::retain</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">ASSERT</span>(!<span class="built_in">isTaggedPointer</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fastpath</span>(!<span class="built_in">ISA</span>()-&gt;<span class="built_in">hasCustomRR</span>())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">rootRetain</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ((<span class="built_in">id</span>(*)(objc_object *, SEL))objc_msgSend)(<span class="keyword">this</span>, @<span class="built_in">selector</span>(retain));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æŠ›å¼€é‚£äº›åˆ¤æ–­ï¼Œobjc_retainå‡½æ•°æœ€ç»ˆè°ƒç”¨äº† retain æ–¹æ³•ã€‚å¯¹è±¡çš„å¼•ç”¨è®¡æ•°åŠ  1 ã€‚è¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„åœ¨ ARC ä¸‹å°†ä¸€ä¸ªå¯¹è±¡èµ‹å€¼ç»™ä¸€ä¸ªå¼ºå¼•ç”¨çš„æŒ‡é’ˆå˜é‡æ—¶ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨æ’å…¥ä¸€æ¡ retain æ–¹æ³•ã€‚</p>
<p>æ¥ç€å¾€ä¸‹çœ‹ï¼Œå½“obj1ä½œç”¨åŸŸç»“æŸåä¼šæ‰§è¡Œä¸€å¥<code>objc_storeStrong(&amp;obj1, nil);</code>ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span></span></span><br><span class="line"><span class="function"><span class="title">objc_storeStrong</span><span class="params">(id *location, id obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    id prev = *location;</span><br><span class="line">    <span class="keyword">if</span> (obj == prev) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">objc_retain</span>(obj);</span><br><span class="line">    *location = obj;</span><br><span class="line">    <span class="built_in">objc_release</span>(prev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//objc_releaseçš„å®ç°ï¼ŒåŸºæœ¬ä¸Šç­‰ä»·äºè°ƒç”¨ releaseæ–¹æ³•ã€‚</span></span><br><span class="line">__attribute__((<span class="built_in">aligned</span>(<span class="number">16</span>), flatten, noinline))</span><br><span class="line"><span class="function"><span class="type">void</span> </span></span><br><span class="line"><span class="function"><span class="title">objc_release</span><span class="params">(id obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!obj) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (obj-&gt;<span class="built_in">isTaggedPointer</span>()) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">return</span> obj-&gt;<span class="built_in">release</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Equivalent to calling [this release], with shortcuts if there is no override</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span></span></span><br><span class="line"><span class="function"><span class="title">objc_object::release</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">ASSERT</span>(!<span class="built_in">isTaggedPointer</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fastpath</span>(!<span class="built_in">ISA</span>()-&gt;<span class="built_in">hasCustomRR</span>())) &#123;</span><br><span class="line">        <span class="built_in">rootRelease</span>();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((<span class="built_in">void</span>(*)(objc_object *, SEL))objc_msgSend)(<span class="keyword">this</span>, @<span class="built_in">selector</span>(release));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>objc_storeStrongå‡½æ•°çš„ä½œç”¨ï¼š</p>
<p>retainæ–°å¯¹è±¡ï¼Œå°†æŒ‡é’ˆå˜é‡æŒ‡å‘æ–°å¯¹è±¡ï¼Œreleaseæ—§å¯¹è±¡ã€‚ç‰¹åˆ«çš„ï¼Œå¦‚æœ obj ç­‰äº nil ï¼Œä¸Šè¿°é€»è¾‘ä»£è¡¨ç€å°†æŒ‡é’ˆå˜é‡èµ‹å€¼ä¸º nilï¼Œå¹¶ä¸” releaseä¹‹å‰æŒ‡å‘çš„å¯¹è±¡ã€‚å› æ­¤ <code>objc_storeStrong(&amp;obj1, nil);</code> ä»£è¡¨ç€ release obj1 æŒ‡å‘çš„å¯¹è±¡ï¼Œå¹¶å°†obj1ç½®ä¸ºnilã€‚</p>
<p>è¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„åœ¨ ARC ä¸‹ä¸€ä¸ªå¼ºå¼•ç”¨çš„æŒ‡é’ˆå˜é‡è¶…å‡ºä½œç”¨åŸŸè¢«åºŸå¼ƒæ—¶ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨æ’å…¥ä¸€æ¡ release æ–¹æ³•ï¼Œå¦å¤–å…¶å®è¿˜æŠŠå¼ºå¼•ç”¨çš„æŒ‡é’ˆå˜é‡ç½®ä¸ºniläº†ã€‚</p>
<p>ä¾‹å­2:</p>
<p>å°†ä¸€ä¸ªä½¿ç”¨newæ–¹æ³•åˆ›å»ºçš„å¯¹è±¡èµ‹å€¼ç»™ä¸€ä¸ª <code>__strong</code> ä¿®é¥°çš„æŒ‡é’ˆå˜é‡</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> * argv[])</span> &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        &#123;</span><br><span class="line">          id __strong obj1 = [NSObject new]; <span class="comment">//å¼•ç”¨è®¡æ•°ä¸º1è€Œä¸æ˜¯2</span></span><br><span class="line">          NSLog(@<span class="string">&quot;obj1:%@&quot;</span>, obj1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ±‡ç¼–ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Ltmp0:</span><br><span class="line">	.loc	1 30 22 prologue_end    ## WeakDemo/main.m:30:22</span><br><span class="line">	callq	_objc_autoreleasePoolPush</span><br><span class="line">Ltmp1:</span><br><span class="line">	.loc	1 32 30                 ## WeakDemo/main.m:32:30</span><br><span class="line">	movq	_OBJC_CLASSLIST_REFERENCES_$_(%rip), %rcx</span><br><span class="line">	movq	_OBJC_SELECTOR_REFERENCES_(%rip), %rsi</span><br><span class="line">	movq	%rcx, %rdi</span><br><span class="line">	movq	%rax, -32(%rbp)         ## 8-byte Spill</span><br><span class="line">	callq	*_objc_msgSend@GOTPCREL(%rip)</span><br><span class="line">	leaq	L__unnamed_cfstring_(%rip), %rcx</span><br><span class="line">	.loc	1 32 23 is_stmt 0       ## WeakDemo/main.m:32:23</span><br><span class="line">	movq	%rax, -24(%rbp)</span><br><span class="line">	.loc	1 33 29 is_stmt 1       ## WeakDemo/main.m:33:29</span><br><span class="line">	movq	-24(%rbp), %rsi</span><br><span class="line">	.loc	1 33 11 is_stmt 0       ## WeakDemo/main.m:33:11</span><br><span class="line">	movq	%rcx, %rdi</span><br><span class="line">	movb	$0, %al</span><br><span class="line">	callq	_NSLog</span><br><span class="line">	xorl	%edx, %edx</span><br><span class="line">	movl	%edx, %esi</span><br><span class="line">Ltmp2:</span><br><span class="line">	.loc	1 34 9 is_stmt 1        ## WeakDemo/main.m:34:9</span><br><span class="line">	leaq	-24(%rbp), %rdi</span><br><span class="line">	callq	_objc_storeStrong</span><br><span class="line">	movq	-32(%rbp), %rdi         ## 8-byte Reload</span><br><span class="line">	.loc	1 35 5                  ## WeakDemo/main.m:35:5</span><br><span class="line">	callq	_objc_autoreleasePoolPop</span><br><span class="line">	xorl	%eax, %eax</span><br></pre></td></tr></table></figure>
<p>ç­‰ä»·äºï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">id obj1 = objc_msgSend(NSObject, <span class="string">&quot;new&quot;</span>);</span><br><span class="line">NSLog(@<span class="string">&quot;obj1:%@&quot;</span>, obj1);</span><br><span class="line">objc_storeStrong(&amp;obj1, nil);</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘å™¨å‘ç°obj1å¯ä»¥æŒæœ‰å¯¹è±¡ï¼Œåˆæ˜¯åˆ›å»ºå¯¹è±¡ï¼Œäºæ˜¯ä¸å† retainã€‚</p>
<p>ä¾‹å­ 3ï¼š</p>
<p>å°†ä¸€ä¸ªä½¿ç”¨myPersonæ–¹æ³•åˆ›å»ºçš„å¯¹è±¡èµ‹å€¼ç»™ä¸€ä¸ª <code>__strong</code> ä¿®é¥°çš„æŒ‡é’ˆå˜é‡</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> main(<span class="type">int</span> argc, <span class="keyword">const</span> <span class="type">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="type">id</span> __<span class="keyword">strong</span> obj1 = [ARCPerson myPerson];</span><br><span class="line">          <span class="built_in">NSLog</span>(<span class="string">@&quot;obj1:%@&quot;</span>, obj1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)myPerson &#123;</span><br><span class="line">    ARCPerson *p = [ARCPerson new];</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ±‡ç¼–ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/20220210154059.png" alt=""></p>
<p>ä¸Šè¿°æ±‡ç¼–å¯¹åº”çš„ç¼–è¯‘å™¨çš„æ¨¡æ‹Ÿæºä»£ç ï¼š</p>
<figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">id obj1<span class="comment">;</span></span><br><span class="line">id tmp = objc_msgSend(<span class="name">ARCPerson</span>, <span class="string">&quot;myPerson&quot;</span>)<span class="comment">; </span></span><br><span class="line">tmp = objc_autoreleaseReturnValue(<span class="name">tmp</span>)<span class="comment">; //èµ°äº†ä¼˜åŒ–è·¯å¾„ï¼Œå¯¹è±¡å¹¶æ²¡æœ‰æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± </span></span><br><span class="line">obj1 = objc_retainAutoreleasedReturnValue(<span class="name">tmp</span>)<span class="comment">; //å’Œä¸Šé¢ä¸åŒï¼Œè¿™é‡Œæ’å…¥çš„æ˜¯objc_retainAutoreleasedReturnValueï¼Œè€Œä¸æ˜¯objc_retainã€‚ç”±äºä¸Šé¢ç”Ÿæˆçš„å¯¹è±¡æ²¡æœ‰æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿæ˜¯èµ°çš„ä¼˜åŒ–è·¯å¾„å¹¶æ²¡æœ‰å†retainå¯¹è±¡</span></span><br><span class="line">NSLog(@<span class="string">&quot;obj1:%@&quot;</span>, obj1)<span class="comment">;</span></span><br><span class="line">objc_storeStrong(<span class="name">&amp;obj1</span>, <span class="literal">nil</span>)<span class="comment">; //é‡Šæ”¾å¯¹è±¡ï¼Œèµ·åˆ°ä¼˜åŒ–ä½œç”¨ï¼Œè¿™æ ·å°±ä¸éœ€è¦ç­‰åˆ°runloopç»“æŸæ‰é‡Šæ”¾</span></span><br></pre></td></tr></table></figure>
<p>objc_autoreleaseReturnValueå®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Prepare a value at +1 for return through a +0 autoreleasing convention.</span></span><br><span class="line">id </span><br><span class="line"><span class="title function_">objc_autoreleaseReturnValue</span><span class="params">(id obj)</span></span><br><span class="line">&#123;</span><br><span class="line">  	<span class="comment">/**</span></span><br><span class="line"><span class="comment">  	prepareOptimizedReturn(ReturnAtPlus1)çš„ä½œç”¨å°±æ˜¯</span></span><br><span class="line"><span class="comment">  	æ£€æµ‹ç´§æ¥ç€è°ƒç”¨çš„æ˜¯ä¸æ˜¯objc_retainAutoreleasedReturnValueæˆ–objc_unsafeClaimAutoreleasedReturnValue</span></span><br><span class="line"><span class="comment">  	æ˜¯çš„è¯å°±å¾€çº¿ç¨‹çš„TLSä¸Šå†™å…¥ReturnAtPlus1å³1.è¿™æ ·åé¢ä¸¤ä¸ªå‡½æ•°è·å–TLSä¸Šçš„å€¼å¦‚æœå‘ç°æ˜¯1å°±çŸ¥é“èµ°äº†ä¼˜åŒ–è·¯å¾„äº†ã€‚</span></span><br><span class="line"><span class="comment">  	è¿™ç§ä¼˜åŒ–æ–¹å¼æœ‰ç‚¹ç‰¹åˆ«ï¼Œå¹³æ—¶æˆ‘ä»¬å¯èƒ½ç”¨ä¸ªå…¨å±€å˜é‡æ ‡è®°ä¸€ä¸‹ï¼Œä½†è¿™é‡Œä½¿ç”¨çš„æ˜¯çº¿ç¨‹çš„TLSåŒºåŸŸï¼Œå¦å¤–æ£€æµ‹åç»­è°ƒç”¨çš„å‡½æ•°åç§°ä¹Ÿæ˜¯åŠåˆ°ä¸è¡Œã€‚</span></span><br><span class="line"><span class="comment">  	*/</span></span><br><span class="line">    <span class="keyword">if</span> (prepareOptimizedReturn(ReturnAtPlus1)) <span class="keyword">return</span> obj; <span class="comment">//ä¼˜åŒ–è·¯å¾„ï¼Œä¸å°†å¯¹è±¡æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> objc_autorelease(obj); <span class="comment">//æ­£å¸¸è·¯å¾„ï¼Œæ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± ä¸­</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Try to prepare for optimized return with the given disposition (+0 or +1).</span></span><br><span class="line"><span class="comment">// Returns true if the optimized path is successful.</span></span><br><span class="line"><span class="comment">// Otherwise the return value must be retained and/or autoreleased as usual.</span></span><br><span class="line"><span class="type">static</span> ALWAYS_INLINE <span class="type">bool</span> </span><br><span class="line"><span class="title function_">prepareOptimizedReturn</span><span class="params">(ReturnDisposition disposition)</span></span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(getReturnDisposition() == ReturnAtPlus0);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (callerAcceptsOptimizedReturn(__builtin_return_address(<span class="number">0</span>))) &#123;</span><br><span class="line">        <span class="keyword">if</span> (disposition) setReturnDisposition(disposition);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Try to accept an optimized return.</span></span><br><span class="line"><span class="comment">// Returns the disposition of the returned object (+0 or +1).</span></span><br><span class="line"><span class="comment">// An un-optimized return is +0.</span></span><br><span class="line"><span class="type">static</span> ALWAYS_INLINE ReturnDisposition </span><br><span class="line"><span class="title function_">acceptOptimizedReturn</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    ReturnDisposition disposition = getReturnDisposition();</span><br><span class="line">    setReturnDisposition(ReturnAtPlus0);  <span class="comment">// reset to the unoptimized state</span></span><br><span class="line">    <span class="keyword">return</span> disposition;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¯»å–TLSä¸ŠRETURN_DISPOSITION_KEYçš„å€¼</span></span><br><span class="line"><span class="type">static</span> ALWAYS_INLINE ReturnDisposition </span><br><span class="line"><span class="title function_">getReturnDisposition</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (ReturnDisposition)(<span class="type">uintptr_t</span>)tls_get_direct(RETURN_DISPOSITION_KEY);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¾€TLSä¸Šå†™æ•°æ®RETURN_DISPOSITION_KEY--disposition</span></span><br><span class="line"><span class="type">static</span> ALWAYS_INLINE <span class="type">void</span> </span><br><span class="line"><span class="title function_">setReturnDisposition</span><span class="params">(ReturnDisposition disposition)</span></span><br><span class="line">&#123;</span><br><span class="line">    tls_set_direct(RETURN_DISPOSITION_KEY, (<span class="type">void</span>*)(<span class="type">uintptr_t</span>)disposition);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>objc_retainAutoreleasedReturnValueå®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">id</span><br><span class="line"><span class="title function_">objc_retainAutoreleasedReturnValue</span><span class="params">(id obj)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (acceptOptimizedReturn() == ReturnAtPlus1) <span class="keyword">return</span> obj; <span class="comment">//ä¼˜åŒ–è·¯å¾„ï¼Œä¸ retainè€Œæ˜¯ç›´æ¥è¿”å›å¯¹è±¡ã€‚</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> objc_retain(obj); <span class="comment">//æ­£å¸¸è·¯å¾„ï¼Œretain,å¼•ç”¨è®¡æ•°+1åï¼Œæ‰è¿”å›å¯¹è±¡ã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>objc_autoreleaseReturnValueä¼šåšä¸€ä¸ªä¼˜åŒ–ï¼Œå¦‚æœæ£€æµ‹åˆ°åç»­ç´§æ¥ç€è°ƒç”¨äº†objc_retainAutoreleasedReturnValueï¼Œåˆ™å¾€ TLS å†™ReturnAtPlus1æ ‡è¯†ï¼Œè¡¨æ˜è¿”å›çš„å¯¹è±¡çš„å†…å­˜ç®¡ç†æœ‰ä¼˜åŒ–ã€‚æ­¤æ—¶objc_autoreleaseReturnValueä¸ä¼šå†å°†ç”Ÿæˆçš„å¯¹è±¡çœŸçš„æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± ä¸­è€Œæ˜¯ç›´æ¥è¿”å›ã€‚å½“æ‰§è¡Œobjc_retainAutoreleasedReturnValueæ—¶ï¼Œä¼šå…ˆä»TLSä¸­å–å€¼æ£€æµ‹æ˜¯å¦ç­‰äºReturnAtPlus1ï¼Œç›¸ç­‰è¯´æ˜èµ°çš„æ˜¯ä¼˜åŒ–è·¯å¾„åˆ™ä¸ retainï¼Œé¿å…é‡å¤retainã€‚</p>
<p>å› æ­¤ä»¥å…¶ä»–å•è¯å‘½åå¼€å¤´çš„æ–¹æ³•åˆ›å»ºå¹¶è¿”å›çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æœ¬åº”è¯¥æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œä½†å¦‚æœåˆ›å»ºåé©¬ä¸Šå°±èµ‹å€¼ç»™ä¸€ä¸ª <code>__strong</code> ä¿®é¥°ç¬¦çš„æŒ‡é’ˆå˜é‡ï¼Œæ­¤æ—¶ç³»ç»Ÿä¼šåšä¸€ä¸ªä¼˜åŒ–ï¼Œè¯¥å¯¹è±¡å°†ä¸å†æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± ä¸­ï¼Œå› æ­¤èƒ½å¤ŸåŠæ—¶é‡Šæ”¾å¯¹è±¡ï¼Œèµ·åˆ°ä¼˜åŒ–ä½œç”¨ã€‚<br>noteï¼šä½¿ç”¨ç³»ç»Ÿçš„å¯¹è±¡ <code>id __strong obj1 = [NSArray array];</code>å¯èƒ½çœ‹ä¸åˆ°è¿™ç§ä¼˜åŒ–ã€‚</p>
<p>æ€»ç»“ï¼šå°†ä¸€ä¸ªå¯¹è±¡èµ‹å€¼ç»™ä¸€ä¸ª <code>__strong</code> ä¿®é¥°ç¬¦çš„æŒ‡é’ˆå˜é‡ï¼Œç¼–è¯‘å™¨ä¼šè§†æƒ…å†µæ’å…¥<code>objc_retain</code> æˆ–<code>objc_retainAutoreleasedReturnValue</code> å‡½æ•°çš„è°ƒç”¨ã€‚è€Œå½“æŒ‡é’ˆå˜é‡è¶…å‡ºä½œç”¨åŸŸåè¢«é”€æ¯æ—¶ï¼Œä¼šæ’å…¥<code>objc_storeStrong(&amp;obj, nil);</code> é‡Šæ”¾å¯¹è±¡ï¼Œå¹¶ç½®ä¸ºnilã€‚</p>
<p>objc_autoreleaseReturnValue å’Œ objc_retainAutoreleasedReturnValueæ˜¯ä¸€å¯¹ä¼˜åŒ–ã€‚</p>
<p>objc_retainAutoreleaseReturnValue å’Œ objc_unsafeClaimAutoreleasedReturnValue æ˜¯å¦ä¸€å¯¹ä¼˜åŒ–ã€‚</p>
<p>å¦‚æœä¼˜åŒ–æˆåŠŸï¼Œä»–ä»¬éƒ½é¿å…äº†å¤šä½™çš„æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± çš„è¿‡ç¨‹ï¼ŒåŠ å¿«äº†å¯¹è±¡çš„é‡Šæ”¾ã€‚</p>
<h3 id="weak-ä¿®é¥°ç¬¦"><a href="#weak-ä¿®é¥°ç¬¦" class="headerlink" title="__weak ä¿®é¥°ç¬¦"></a>__weak ä¿®é¥°ç¬¦</h3><p>å¯¹äºä¸‹é¢çš„ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> * argv[])</span> &#123;</span><br><span class="line">     @autoreleasepool &#123;</span><br><span class="line">         id obj = [NSObject new];</span><br><span class="line">         &#123;</span><br><span class="line">           id __weak obj1 = obj;</span><br><span class="line">           NSLog(@<span class="string">&quot;obj1:%@&quot;</span>, obj1);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹åº”çš„æ±‡ç¼–ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Ltmp3:</span><br><span class="line">     .loc    1 12 22 prologue_end    ## WeakDemo/main.m:12:22</span><br><span class="line">     callq    _objc_autoreleasePoolPush</span><br><span class="line"> Ltmp4:</span><br><span class="line">     .loc    1 13 18                 ## WeakDemo/main.m:13:18</span><br><span class="line">     movq    _OBJC_CLASSLIST_REFERENCES_$_(%rip), %rdi</span><br><span class="line">     movq    _OBJC_SELECTOR_REFERENCES_(%rip), %rsi</span><br><span class="line">     movq    _objc_msgSend@GOTPCREL(%rip), %rcx</span><br><span class="line">     movq    %rax, -56(%rbp)         ## 8-byte Spill</span><br><span class="line">     callq    *%rcx</span><br><span class="line">     .loc    1 13 12 is_stmt 0       ## WeakDemo/main.m:13:12</span><br><span class="line">     movq    %rax, -24(%rbp)</span><br><span class="line"> Ltmp5:</span><br><span class="line">     .loc    1 15 28 is_stmt 1       ## WeakDemo/main.m:15:28</span><br><span class="line">     movq    -24(%rbp), %rsi</span><br><span class="line">     leaq    -32(%rbp), %rax</span><br><span class="line">     .loc    1 15 21 is_stmt 0       ## WeakDemo/main.m:15:21</span><br><span class="line">     movq    %rax, %rdi</span><br><span class="line">     movq    %rax, -64(%rbp)         ## 8-byte Spill</span><br><span class="line">     callq    _objc_initWeak</span><br><span class="line">     movq    -64(%rbp), %rdi         ## 8-byte Reload</span><br><span class="line">     movq    %rax, -72(%rbp)         ## 8-byte Spill</span><br><span class="line">     .loc    1 16 29 is_stmt 1       ## WeakDemo/main.m:16:29</span><br><span class="line">     callq    _objc_loadWeakRetained</span><br><span class="line">     movq    %rax, %rcx</span><br><span class="line"> Ltmp0:</span><br><span class="line">     .loc    1 16 11 is_stmt 0       ## WeakDemo/main.m:16:11</span><br><span class="line">     leaq    L__unnamed_cfstring_(%rip), %rdi</span><br><span class="line">     xorl    %edx, %edx</span><br><span class="line">                                         ## kill: def $dl killed $dl killed $edx</span><br><span class="line">     movq    %rax, %rsi</span><br><span class="line">     movb    %dl, %al</span><br><span class="line">     movq    %rcx, -80(%rbp)         ## 8-byte Spill</span><br><span class="line">     callq    _NSLog</span><br><span class="line"> Ltmp1:</span><br><span class="line">     jmp    LBB0_1</span><br><span class="line"> LBB0_1:</span><br><span class="line">     .loc    1 0 11                  ## WeakDemo/main.m:0:11</span><br><span class="line">     movq    -80(%rbp), %rdi         ## 8-byte Reload</span><br><span class="line">     .loc    1 16 11                 ## WeakDemo/main.m:16:11</span><br><span class="line">     callq    *_objc_release@GOTPCREL(%rip)</span><br><span class="line"> Ltmp6:</span><br><span class="line">     .loc    1 17 9 is_stmt 1        ## WeakDemo/main.m:17:9</span><br><span class="line">     leaq    -32(%rbp), %rdi</span><br><span class="line">     callq    _objc_destroyWeak</span><br><span class="line">     xorl    %eax, %eax</span><br><span class="line">     movl    %eax, %esi</span><br><span class="line">     .loc    1 18 5                  ## WeakDemo/main.m:18:5</span><br><span class="line">     leaq    -24(%rbp), %rdi</span><br><span class="line">     callq    _objc_storeStrong</span><br><span class="line">     movq    -56(%rbp), %rdi         ## 8-byte Reload</span><br><span class="line">     callq    _objc_autoreleasePoolPop</span><br><span class="line">     xorl    %eax, %eax</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°æ±‡ç¼–å¯¹åº”çš„ç¼–è¯‘å™¨çš„æ¨¡æ‹Ÿæºä»£ç ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="type">id</span> obj = objc_msgSend(<span class="built_in">NSObject</span>, <span class="string">&quot;new&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">id</span> obj1 = objc_initWeak(&amp;obj1, obj);</span><br><span class="line"><span class="type">id</span> tmp = objc_loadWeakRetained(&amp;obj1);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;obj1:%@&quot;</span>, tmp);</span><br><span class="line">objc_release(tmp);</span><br><span class="line">objc_destroyWeak(&amp;obj1);</span><br><span class="line"></span><br><span class="line">objc_storeStrong(&amp;obj, <span class="literal">nil</span>);</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ° <code>id __weak obj1 = obj;</code>ï¼Œè¿™å¥ä»£ç å®é™…ä¸Šè¢«ç¼–è¯‘å™¨è½¬æ¢ä¸ºï¼š<code>id obj1 = objc_initWeak(&amp;obj1, obj);</code>ã€‚æ²¡æœ‰è°ƒç”¨ä»€ä¹ˆ retain æ–¹æ³•ï¼Œè¿™å°±æ˜¯ä½¿ç”¨__weakä¿®é¥°ç¬¦ä¸ä¼šå¯¼è‡´å¯¹è±¡å¼•ç”¨è®¡æ•°åŠ  1 çš„åŸå› ã€‚</p>
<p>butï¼Œobjc_initWeakå‡½æ•°åˆæ˜¯å¹²ä»€ä¹ˆçš„ï¼Œè¿™é‡Œä¸åšè¯¦è¿°ï¼Œæœ‰å…´è¶£çš„å¯ä»¥æŸ¥çœ‹ weak çš„å®ç°åŸç†ã€‚è¿™é‡Œç®€å•è¯´ä¸‹objc_initWeakçš„ä½œç”¨å°±æ˜¯å°†ä¸€ä¸ªæŒ‡é’ˆå˜é‡çš„åœ°å€ç™»è®°åˆ°å¯¹è±¡çš„ weak è¡¨ä¸­ã€‚å®ƒçš„å®ç°æ˜¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">id</span><br><span class="line"><span class="title function_">objc_initWeak</span><span class="params">(id *location, id newObj)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!newObj) &#123;</span><br><span class="line">        *location = nil;</span><br><span class="line">        <span class="keyword">return</span> nil;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> storeWeak&lt;DontHaveOld, DoHaveNew, DoCrashIfDeallocating&gt;</span><br><span class="line">        (location, (objc_object*)newObj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ç€å¾€ä¸‹çœ‹ï¼Œä¼šå‘ç° <code>NSLog(@&quot;obj1:%@&quot;, obj1);</code>ä»£ç å˜æˆäº†ä¸‰å¥ï¼š</p>
<figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">id tmp <span class="punctuation">=</span> objc_loadWeakRetained<span class="punctuation">(</span><span class="meta">&amp;obj1);  <span class="comment">//å°†å¯¹è±¡å¼•ç”¨è®¡æ•°åŠ  1</span></span></span><br><span class="line">NSLog<span class="punctuation">(</span>@<span class="string">&quot;obj1:%@&quot;</span><span class="punctuation">,</span> tmp<span class="punctuation">)</span><span class="punctuation">;</span></span><br><span class="line">objc_release<span class="punctuation">(</span>tmp<span class="punctuation">)</span><span class="punctuation">;</span>  <span class="comment">//å°†å¯¹è±¡å¼•ç”¨è®¡æ•°å‡ 1</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœå¯¹è±¡è¿˜å¯ç”¨æ—¶æ‰§è¡Œäº†<code>id tmp = objc_loadWeakRetained(&amp;obj1);</code>ï¼Œé‚£ä¹ˆå³ä½¿å¯¹è±¡åœ¨å…¶ä»–çº¿ç¨‹è¢«é‡Šæ”¾äº†ï¼Œå¯¹è±¡æ­¤åˆ»ä¹Ÿä¸ä¼šè¢«é”€æ¯ï¼Œèƒ½å¤Ÿä¿è¯<code>NSLog(@&quot;obj1:%@&quot;, obj1);</code>æ–¹æ³•åœ¨æ‰§è¡Œå®Œå‰å¯¹è±¡éƒ½æ˜¯å¯ç”¨çš„ã€‚</p>
<p>ä»¥å‰è¿™é‡Œæ˜¯å°†å¯¹è±¡æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± çš„ï¼Œå¯ä»¥å‚è€ƒï¼š<a href="https://stackoverflow.com/questions/40993809/why-weak-object-will-be-added-to-autorelease-pool">Why __weak object will be added to autorelease pool?</a> ã€‚ç»è¿‡æµ‹è¯•å‘ç°åœ¨MRCä¸­è¿˜æ˜¯å°†å¯¹è±¡æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± çš„ã€‚è¿™æ—¶ä»£ç ç­‰ä»·äºï¼š</p>
<figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line">id tmp <span class="punctuation">=</span> objc_loadWeakRetained<span class="punctuation">(</span><span class="meta">&amp;obj1);  <span class="comment">//å°†å¯¹è±¡å¼•ç”¨è®¡æ•°åŠ  1</span></span></span><br><span class="line">objc_autorelease<span class="punctuation">(</span>tmp<span class="punctuation">)</span><span class="punctuation">;</span> <span class="comment">//æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± .æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± ä»…ä»…æ˜¯æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œä¸ä¼šå¯¹å¯¹è±¡çš„å¼•ç”¨è®¡æ•°äº§ç”Ÿå½±å“ã€‚</span></span><br><span class="line">NSLog<span class="punctuation">(</span>@<span class="string">&quot;obj1:%@&quot;</span><span class="punctuation">,</span> tmp<span class="punctuation">)</span><span class="punctuation">;</span></span><br></pre></td></tr></table></figure>
<p>ä¸¾ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)hello &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        MRCCat *cat = [MRCCat new];</span><br><span class="line">        <span class="keyword">self</span>.cat = cat;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ 1&quot;</span>, <span class="keyword">self</span>.cat);</span><br><span class="line">        [cat release];</span><br><span class="line">    &#125; <span class="comment">//ä½¿ç”¨weakï¼Œcatå±…ç„¶è¿˜æ²¡æœ‰è¢«é”€æ¯ã€‚å› ä¸ºè¢«æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± é‡Œå»äº†</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ 2&quot;</span>, <span class="keyword">self</span>.cat);</span><br><span class="line">    [<span class="keyword">self</span>.cat hello];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ hello&quot;</span>, <span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä¼šå‘ç°åœ¨è°ƒç”¨ <code>[cat release];</code> åï¼Œcatå¯¹è±¡å¹¶æ²¡æœ‰é©¬ä¸Šé”€æ¯ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥åœ¨<code>NSLog(@&quot;%@ 1&quot;, self.cat);</code> è¿™ä¸€è¡Œæ‰“ä¸Šæ–­ç‚¹ï¼Œå¹¶æ‰§è¡Œ <code>po _objc_autoreleasePoolPrint()</code> :</p>
<figure class="highlight inform7"><table><tr><td class="code"><pre><span class="line">objc<span class="comment">[3377]</span>: <span class="comment">[0x7fcd70848230]</span>    0x7fcd6ef0a5c0  UIWindow</span><br><span class="line">objc<span class="comment">[3377]</span>: <span class="comment">[0x7fcd70848238]</span>    0x60000032c6c0  __NSArrayM</span><br><span class="line">objc<span class="comment">[3377]</span>: <span class="comment">[0x7fcd70848240]</span>    0x7fcd6ef09f20  ViewController</span><br><span class="line">objc<span class="comment">[3377]</span>: <span class="comment">[0x7fcd70848248]</span>    0x7fcd6ef0a5c0  UIWindow</span><br><span class="line">objc<span class="comment">[3377]</span>: <span class="comment">[0x7fcd70848250]</span>    0x60000032c8a0  __NSArrayM</span><br><span class="line">objc<span class="comment">[3377]</span>: <span class="comment">[0x7fcd70848258]</span>    0x7fcd6ef09f20  ViewController</span><br><span class="line">objc<span class="comment">[3377]</span>: <span class="comment">[0x7fcd70848260]</span>    0x7fcd6ef09f20  ViewController</span><br><span class="line">objc<span class="comment">[3377]</span>: ##############</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶AUTORELEASE POOLSé‡Œè¿˜æ²¡æœ‰MRCCatå¯¹è±¡ï¼Œæ¥ç€åœ¨ <code>[cat release];</code> æ‰“ä¸Šæ–­ç‚¹ï¼Œå†æ¬¡æ‰§è¡Œ <code>po _objc_autoreleasePoolPrint()</code> ï¼š</p>
<figure class="highlight clean"><table><tr><td class="code"><pre><span class="line">objc[<span class="number">3377</span>]: [<span class="number">0x7fcd70848248</span>]    <span class="number">0x7fcd6ef0a5c0</span>  UIWindow</span><br><span class="line">objc[<span class="number">3377</span>]: [<span class="number">0x7fcd70848250</span>]    <span class="number">0x60000032c8a0</span>  __NSArrayM</span><br><span class="line">objc[<span class="number">3377</span>]: [<span class="number">0x7fcd70848258</span>]    <span class="number">0x7fcd6ef09f20</span>  ViewController</span><br><span class="line">objc[<span class="number">3377</span>]: [<span class="number">0x7fcd70848260</span>]    <span class="number">0x7fcd6ef09f20</span>  ViewController</span><br><span class="line">objc[<span class="number">3377</span>]: [<span class="number">0x7fcd70848268</span>]    <span class="number">0x600000f747b0</span>  MRCCat</span><br><span class="line">objc[<span class="number">3377</span>]: ##############</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°MRCCatè¢«æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± é‡Œå»äº†ã€‚æ‰€ä»¥åé¢å³ä½¿è°ƒç”¨ <code>[cat release];</code> catå¯¹è±¡ä¹Ÿä¸ä¼šé©¬ä¸Šé”€æ¯ã€‚å¦‚æœä½ åœ¨<code>[self.cat hello];</code> æ‰“ä¸Šæ–­ç‚¹ï¼Œå†æ¬¡æ‰§è¡Œ <code>po _objc_autoreleasePoolPrint()</code> ï¼š</p>
<figure class="highlight inform7"><table><tr><td class="code"><pre><span class="line">objc<span class="comment">[3377]</span>: <span class="comment">[0x7fcd70848240]</span>    0x7fcd6ef09f20  ViewController</span><br><span class="line">objc<span class="comment">[3377]</span>: <span class="comment">[0x7fcd70848248]</span>    0x7fcd6ef0a5c0  UIWindow</span><br><span class="line">objc<span class="comment">[3377]</span>: <span class="comment">[0x7fcd70848250]</span>    0x60000032c8a0  __NSArrayM</span><br><span class="line">objc<span class="comment">[3377]</span>: <span class="comment">[0x7fcd70848258]</span>    0x7fcd6ef09f20  ViewController</span><br><span class="line">objc<span class="comment">[3377]</span>: <span class="comment">[0x7fcd70848260]</span>    0x7fcd6ef09f20  ViewController</span><br><span class="line">objc<span class="comment">[3377]</span>: <span class="comment">[0x7fcd70848268]</span>    0x600000f747b0  MRCCat</span><br><span class="line">objc<span class="comment">[3377]</span>: <span class="comment">[0x7fcd70848270]</span>    0x600000f747b0  MRCCat</span><br><span class="line">objc<span class="comment">[3377]</span>: ##############</span><br></pre></td></tr></table></figure>
<p>ä½ ä¼šå‘ç°catå¯¹è±¡è¢«æ³¨å†Œäº†ä¸¤æ¬¡ã€‚</p>
<p>å› æ­¤ä½¿ç”¨é™„æœ‰ <code>__weak</code> ä¿®é¥°ç¬¦çš„å˜é‡ï¼Œç­‰ä»·äºä½¿ç”¨retainå¹¶æ³¨å†Œåˆ°autoreleasepoolä¸­çš„å¯¹è±¡ã€‚å¦‚æœä½ æŸæ®µä»£ç éœ€è¦å¤šæ¬¡ä½¿ç”¨è¯¥weakå˜é‡ï¼Œæœ€å¥½å…ˆretainåèµ‹å€¼ç»™ä¸€ä¸ªå˜é‡ç„¶åä½¿ç”¨è¯¥å˜é‡ã€‚è¦ä¸ç„¶æ¯æ¬¡éƒ½ä¼šretain+æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± ã€‚æ‰€å¹¸çš„æ˜¯ç°åœ¨å‡ ä¹æ¥è§¦ä¸åˆ°MRCçš„ä»£ç ï¼Œå¹¶ä¸”åœ¨ARCä¸­ä½¿ç”¨é™„æœ‰ <code>__weak</code> ä¿®é¥°ç¬¦çš„å˜é‡ï¼Œç³»ç»Ÿä¹Ÿä¸ä¼šretainåå†å°†å…¶æ³¨å†Œåˆ°autoreleasepoolä¸­äº†ï¼Œè€Œæ˜¯åœ¨ä½¿ç”¨å‰è°ƒç”¨retainï¼Œä½¿ç”¨åè°ƒç”¨releaseé©¬ä¸Šé‡Šæ”¾ã€‚</p>
<p>å¦å¤–æˆ‘ä»¬å¯¹ä¸Šè¿°ä»£ç ç¨ä½œæ”¹åŠ¨ï¼Œæ·»åŠ ä¸€ä¸ª@autoreleasepoolï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)hello &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        MRCCat *cat = [MRCCat new];</span><br><span class="line">        <span class="keyword">self</span>.cat = cat;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ 1&quot;</span>, <span class="keyword">self</span>.cat);</span><br><span class="line">        [cat release];</span><br><span class="line">    &#125; <span class="comment">//è¿™é‡Œcatå°±ä¼šè¢«é”€æ¯äº†</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ 2&quot;</span>, <span class="keyword">self</span>.cat);</span><br><span class="line">    [<span class="keyword">self</span>.cat hello];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ hello&quot;</span>, <span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å°±ä¼šå‘ç°catå¯¹è±¡åœ¨autoreleasepoolå—æ‰§è¡Œå®Œæˆåé©¬ä¸Šå°±è¢«é”€æ¯äº†ã€‚</p>
<p>ç»§ç»­ï¼Œå½“ä½œç”¨åŸŸç»“æŸæ—¶ï¼Œobj1 å˜é‡è¢«åºŸå¼ƒï¼Œå› æ­¤ç¼–è¯‘å™¨æ’å…¥äº†ä¸€æ¡objc_destroyWeakå‡½æ•°çš„è°ƒç”¨ã€‚è¯¥æ–¹æ³•ä¼šå°† obj1å¼±å¼•ç”¨æŒ‡é’ˆå˜é‡ä»å¯¹è±¡çš„ weak è¡¨ä¸­ç§»é™¤ï¼ˆè¿™é‡Œobj1å˜é‡å…ˆäºobjå¯¹è±¡åºŸå¼ƒï¼Œå› æ­¤obj1ä¸ä¼šè¢«ç½®ä¸ºnilï¼‰ã€‚</p>
<p>objc_destroyWeak æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">objc_destroyWeak</span><span class="params">(id *location)</span></span><br><span class="line">&#123;</span><br><span class="line">    (<span class="type">void</span>)storeWeak&lt;DoHaveOld, DontHaveNew, DontCrashIfDeallocating&gt;</span><br><span class="line">        (location, nil); <span class="comment">//</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> id </span><br><span class="line"><span class="title function_">storeWeak</span><span class="params">(id *location, objc_object *newObj)</span> &#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Clean up old value, if any.</span></span><br><span class="line">  <span class="keyword">if</span> (haveOld) &#123;</span><br><span class="line">      weak_unregister_no_lock(&amp;oldTable-&gt;weak_table, oldObj, location);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> (id)newObj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Unregister an already-registered weak reference.</span></span><br><span class="line"><span class="comment"> * This is used when referrer&#x27;s storage is about to go away, but referent</span></span><br><span class="line"><span class="comment"> * isn&#x27;t dead yet. (Otherwise, zeroing referrer later would be a</span></span><br><span class="line"><span class="comment"> * bad memory access.)</span></span><br><span class="line"><span class="comment"> * Does nothing if referent/referrer is not a currently active weak reference.</span></span><br><span class="line"><span class="comment"> * Does not zero referrer.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * FIXME currently requires old referent value to be passed in (lame)</span></span><br><span class="line"><span class="comment"> * FIXME unregistration should be automatic if referrer is collected</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param weak_table The global weak table.</span></span><br><span class="line"><span class="comment"> * @param referent The object.</span></span><br><span class="line"><span class="comment"> * @param referrer The weak reference.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">weak_unregister_no_lock</span><span class="params">(<span class="type">weak_table_t</span> *weak_table, id referent_id, </span></span><br><span class="line"><span class="params">                        id *referrer_id)</span></span><br><span class="line">&#123;</span><br><span class="line">    objc_object *referent = (objc_object *)referent_id;</span><br><span class="line">    objc_object **referrer = (objc_object **)referrer_id;</span><br><span class="line"></span><br><span class="line">    <span class="type">weak_entry_t</span> *entry;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!referent) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((entry = weak_entry_for_referent(weak_table, referent))) &#123;</span><br><span class="line">        remove_referrer(entry, referrer); <span class="comment">//å°†referrerä»entryä¸­ç§»é™¤ã€‚</span></span><br><span class="line">        <span class="type">bool</span> empty = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (entry-&gt;out_of_line()  &amp;&amp;  entry-&gt;num_refs != <span class="number">0</span>) &#123;</span><br><span class="line">            empty = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; WEAK_INLINE_COUNT; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (entry-&gt;inline_referrers[i]) &#123;</span><br><span class="line">                    empty = <span class="literal">false</span>; </span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (empty) &#123;</span><br><span class="line">            weak_entry_remove(weak_table, entry);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do not set *referrer = nil. objc_storeWeak() requires that the </span></span><br><span class="line">    <span class="comment">// value not change.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">remove_referrer</span><span class="params">(<span class="type">weak_entry_t</span> *entry, objc_object **old_referrer)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (! entry-&gt;out_of_line()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; WEAK_INLINE_COUNT; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (entry-&gt;inline_referrers[i] == old_referrer) &#123;</span><br><span class="line">                entry-&gt;inline_referrers[i] = nil;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        _objc_inform(<span class="string">&quot;Attempted to unregister unknown __weak variable &quot;</span></span><br><span class="line">                     <span class="string">&quot;at %p. This is probably incorrect use of &quot;</span></span><br><span class="line">                     <span class="string">&quot;objc_storeWeak() and objc_loadWeak(). &quot;</span></span><br><span class="line">                     <span class="string">&quot;Break on objc_weak_error to debug.\n&quot;</span>, </span><br><span class="line">                     old_referrer);</span><br><span class="line">        objc_weak_error();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> begin = w_hash_pointer(old_referrer) &amp; (entry-&gt;mask);</span><br><span class="line">    <span class="type">size_t</span> index = begin;</span><br><span class="line">    <span class="type">size_t</span> hash_displacement = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (entry-&gt;referrers[index] != old_referrer) &#123;</span><br><span class="line">        index = (index+<span class="number">1</span>) &amp; entry-&gt;mask;</span><br><span class="line">        <span class="keyword">if</span> (index == begin) bad_weak_table(entry);</span><br><span class="line">        hash_displacement++;</span><br><span class="line">        <span class="keyword">if</span> (hash_displacement &gt; entry-&gt;max_hash_displacement) &#123;</span><br><span class="line">            _objc_inform(<span class="string">&quot;Attempted to unregister unknown __weak variable &quot;</span></span><br><span class="line">                         <span class="string">&quot;at %p. This is probably incorrect use of &quot;</span></span><br><span class="line">                         <span class="string">&quot;objc_storeWeak() and objc_loadWeak(). &quot;</span></span><br><span class="line">                         <span class="string">&quot;Break on objc_weak_error to debug.\n&quot;</span>, </span><br><span class="line">                         old_referrer);</span><br><span class="line">            objc_weak_error();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    entry-&gt;referrers[index] = nil;</span><br><span class="line">    entry-&gt;num_refs--;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>weak_unregister_no_lock</code> çš„ä½œç”¨ï¼šå°†å¼±å¼•ç”¨æŒ‡é’ˆå˜é‡ä»å¯¹è±¡çš„weakè¡¨é‡Œç§»é™¤ã€‚å¦‚æœweakè¡¨ä¸­å¯¹è±¡çš„weak_entryä¸ºç©ºï¼Œåˆ™å°†entryä¹Ÿç§»é™¤ã€‚</p>
<p>ä¸Šè¿°å°±æ˜¯ä½¿ç”¨ <code>__weak</code> ä¿®é¥°ç¬¦ä¿®é¥°æŒ‡é’ˆå˜é‡æ—¶ï¼ŒARC å¯¹å…¶çš„å¤„ç†ã€‚</p>
<p>å†æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p>
<p>å°†newæ–¹æ³•åˆšåˆ›å»ºçš„å¯¹è±¡èµ‹å€¼ç»™ä¸€ä¸ª__weakæŒ‡é’ˆå˜é‡</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> * argv[])</span> &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        &#123;</span><br><span class="line">          id __weak obj1 = [NSObject new];</span><br><span class="line">          NSLog(@<span class="string">&quot;obj1:%@&quot;</span>, obj1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½ å¯èƒ½çŸ¥é“æ‰“å°çš„ç»“æœä¸º nullï¼Œä½†å®ƒå¯¹åº”çš„æ±‡ç¼–åˆæ˜¯æ€æ ·çš„å‘¢ï¼Ÿ</p>
<p>å¯¹åº”çš„æ±‡ç¼–ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Ltmp3:</span><br><span class="line">	.loc	1 30 22 prologue_end    ## WeakDemo/main.m:30:22</span><br><span class="line">	callq	_objc_autoreleasePoolPush</span><br><span class="line">Ltmp4:</span><br><span class="line">	.loc	1 32 28                 ## WeakDemo/main.m:32:28</span><br><span class="line">	movq	_OBJC_CLASSLIST_REFERENCES_$_(%rip), %rdi</span><br><span class="line">	movq	_OBJC_SELECTOR_REFERENCES_(%rip), %rsi</span><br><span class="line">	movq	_objc_msgSend@GOTPCREL(%rip), %rcx</span><br><span class="line">	movq	%rax, -48(%rbp)         ## 8-byte Spill</span><br><span class="line">	callq	*%rcx</span><br><span class="line">	leaq	-24(%rbp), %rcx</span><br><span class="line">	.loc	1 32 21 is_stmt 0       ## WeakDemo/main.m:32:21</span><br><span class="line">	movq	%rcx, %rdi</span><br><span class="line">	movq	%rax, %rsi</span><br><span class="line">	movq	%rax, -56(%rbp)         ## 8-byte Spill</span><br><span class="line">	movq	%rcx, -64(%rbp)         ## 8-byte Spill</span><br><span class="line">	callq	_objc_initWeak</span><br><span class="line">	movq	_objc_release@GOTPCREL(%rip), %rcx</span><br><span class="line">	movq	-56(%rbp), %rdi         ## 8-byte Reload</span><br><span class="line">	movq	%rax, -72(%rbp)         ## 8-byte Spill</span><br><span class="line">	callq	*%rcx</span><br><span class="line">	movq	-64(%rbp), %rdi         ## 8-byte Reload</span><br><span class="line">	.loc	1 33 29 is_stmt 1       ## WeakDemo/main.m:33:29</span><br><span class="line">	callq	_objc_loadWeakRetained</span><br><span class="line">	movq	%rax, %rcx</span><br><span class="line">Ltmp0:</span><br><span class="line">	.loc	1 33 11 is_stmt 0       ## WeakDemo/main.m:33:11</span><br><span class="line">	leaq	L__unnamed_cfstring_(%rip), %rdi</span><br><span class="line">	xorl	%edx, %edx</span><br><span class="line">                                        ## kill: def $dl killed $dl killed $edx</span><br><span class="line">	movq	%rax, %rsi</span><br><span class="line">	movb	%dl, %al</span><br><span class="line">	movq	%rcx, -80(%rbp)         ## 8-byte Spill</span><br><span class="line">	callq	_NSLog</span><br><span class="line">Ltmp1:</span><br><span class="line">	jmp	LBB0_1</span><br><span class="line">LBB0_1:</span><br><span class="line">	.loc	1 0 11                  ## WeakDemo/main.m:0:11</span><br><span class="line">	movq	-80(%rbp), %rdi         ## 8-byte Reload</span><br><span class="line">	.loc	1 33 11                 ## WeakDemo/main.m:33:11</span><br><span class="line">	callq	*_objc_release@GOTPCREL(%rip)</span><br><span class="line">Ltmp5:</span><br><span class="line">	.loc	1 34 9 is_stmt 1        ## WeakDemo/main.m:34:9</span><br><span class="line">	leaq	-24(%rbp), %rdi</span><br><span class="line">	callq	_objc_destroyWeak</span><br><span class="line">	movq	-48(%rbp), %rdi         ## 8-byte Reload</span><br><span class="line">	.loc	1 35 5                  ## WeakDemo/main.m:35:5</span><br><span class="line">	callq	_objc_autoreleasePoolPop</span><br><span class="line">	xorl	%eax, %eax</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°æ±‡ç¼–å¯¹åº”çš„ç¼–è¯‘å™¨çš„æ¨¡æ‹Ÿæºä»£ç ï¼š</p>
<figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">id tmp = objc_msgSend(<span class="name">NSObject</span>, <span class="string">&quot;new&quot;</span>)<span class="comment">;</span></span><br><span class="line">id obj1 = objc_initWeak(<span class="name">&amp;obj1</span>, tmp)<span class="comment">; //æ³¨å†Œåˆ°å¯¹è±¡çš„ weak è¡¨ä¸­ï¼Œè¿™æ ·å¯¹è±¡é”€æ¯æ—¶æŒ‡é’ˆå˜é‡ä¼šè¢«ç½®ä¸º nilã€‚</span></span><br><span class="line">objc_release(<span class="name">tmp</span>)<span class="comment">;</span></span><br><span class="line">id tmp1 = objc_loadWeakRetained(<span class="name">&amp;obj1</span>)<span class="comment">;  </span></span><br><span class="line">NSLog(@<span class="string">&quot;obj1:%@&quot;</span>, tmp1)<span class="comment">;</span></span><br><span class="line">objc_release(<span class="name">tmp1</span>)<span class="comment">;  </span></span><br><span class="line">objc_destroyWeak(<span class="name">&amp;obj1</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°objc_initWeakåï¼Œé©¬ä¸Šè°ƒç”¨äº†objc_releaseï¼Œå¯¼è‡´å¯¹è±¡è¢«é‡Šæ”¾é”€æ¯ï¼ŒåŒæ—¶ obj1 ä¼šè¢«ç½®ä¸º nilï¼Œäºæ˜¯åé¢çš„ tmp1 ä¹Ÿæ˜¯ nilã€‚æ‰“å°ä¹Ÿæ˜¯ nilã€‚</p>
<p>å¯¹äºä»£ç <code>id __weak obj1 = [NSObject new];</code>ï¼Œç”±äº__weak ä¿®é¥°çš„æŒ‡é’ˆå˜é‡æ— æ³•æŒæœ‰å¯¹è±¡ï¼Œå› æ­¤å¯¹è±¡ä¸€åˆ›å»ºå°±è¢«é”€æ¯ã€‚</p>
<p>å¦å¤–ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> main(<span class="type">int</span> argc, <span class="keyword">const</span> <span class="type">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="type">id</span> obj = [<span class="built_in">NSObject</span> new];</span><br><span class="line">        <span class="type">id</span> __<span class="keyword">weak</span> ref = obj; <span class="comment">//_objc_initWeak(å†…éƒ¨è°ƒç”¨çš„æ˜¯storeWeak)</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;ref-1ï¼š%@&quot;</span>, ref);</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">id</span> obj2 = [<span class="built_in">NSObject</span> new];</span><br><span class="line">            ref = obj2; <span class="comment">//_objc_storeWeak (å†…éƒ¨è°ƒç”¨çš„ä¹Ÿæ˜¯storeWeak)</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;ref-2ï¼š%@&quot;</span>, ref);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ€»ç»“</strong></p>
<p> <code>__weak</code> ä¿®é¥°ç¬¦ä½œç”¨ï¼š</p>
<p>1.å½“æˆ‘ä»¬å°†ä¸€ä¸ªå¯¹è±¡èµ‹å€¼ç»™ä¸€ä¸ª <code>__weak</code> ä¿®é¥°ç¬¦çš„æŒ‡é’ˆå˜é‡æ—¶ï¼Œç¼–è¯‘å™¨ä¼šæ’å…¥ <code>objc_initWeak</code> æˆ– <code>objc_storeWeak</code> å‡½æ•°å°†è¯¥å¼±æŒ‡é’ˆå˜é‡ä»æ—§å¯¹è±¡çš„weakè¡¨å‰”é™¤ï¼ˆå¦‚æœä¹‹å‰æœ‰æŒ‡å‘å¯¹è±¡çš„è¯ï¼‰å¹¶æ³¨å†Œåˆ°æ–°å¯¹è±¡çš„weakè¡¨é‡Œï¼Œç„¶åå°†å¼±æŒ‡é’ˆæŒ‡å‘æ–°å¯¹è±¡ã€‚</p>
<p>2.å½“ä½¿ç”¨é™„æœ‰ <code>__weak</code> ä¿®é¥°ç¬¦çš„å˜é‡æ—¶ï¼Œç¼–è¯‘å™¨ä¼šåœ¨ä½¿ç”¨å‰æ’å…¥ <code>objc_loadWeakRetained</code> å‡½æ•°å°†å¯¹è±¡å¼•ç”¨è®¡æ•°+1ï¼Œä¿è¯å¯¹è±¡åœ¨åé¢çš„ä½¿ç”¨è¿‡ç¨‹ä¸­ä¸è¢«é‡Šæ”¾ã€‚å¹¶åœ¨ä½¿ç”¨åæ’å…¥ <code>objc_release(tmp1);</code> é‡Šæ”¾å¯¹è±¡ã€‚</p>
<p>3.å½“å¼±æŒ‡é’ˆå˜é‡è¶…å‡ºä½œç”¨åŸŸè¢«åºŸå¼ƒæ—¶ï¼Œç¼–è¯‘å™¨ä¼šæ’å…¥ <code>objc_destroyWeak</code> å°†è¯¥å˜é‡ä»å¯¹è±¡çš„weakè¡¨é‡Œå‰”é™¤ã€‚</p>
<p>4.å½“å¯¹è±¡é”€æ¯æ—¶ï¼Œå¯¹è±¡çš„weakè¡¨ä¸­çš„æ‰€æœ‰å¼±æŒ‡é’ˆå˜é‡ä¼šè¢«èµ‹å€¼ä¸ºnilï¼Œé¿å…äº†é‡æŒ‡é’ˆå´©æºƒï¼Œæ¯”å¦‚å¯¹nilå¯¹è±¡å‘é€æ¶ˆæ¯ä¸ä¼šæœ‰ä»»ä½•ååº”ï¼Œä½†æ˜¯å¦‚æœæ˜¯å¯¹nilè¿›è¡Œè§£å¼•ç”¨è¿˜æ˜¯ä¼šå´©æºƒçš„ã€‚</p>
<p>è¿™äº›åŠŸèƒ½æ˜¯assignæ‰€ä¸å…·å¤‡çš„ï¼Œassignå”¯ä¸€ä¸weakç›¸åŒçš„åœ°æ–¹å°±æ˜¯ä¸ä¼šå¯¼è‡´å¯¹è±¡çš„å¼•ç”¨è®¡æ•°+1ã€‚</p>
<h3 id="autoreleasingä¿®é¥°ç¬¦"><a href="#autoreleasingä¿®é¥°ç¬¦" class="headerlink" title="__autoreleasingä¿®é¥°ç¬¦"></a>__autoreleasingä¿®é¥°ç¬¦</h3><p>å¯¹äºä»£ç ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> main(<span class="type">int</span> argc, <span class="keyword">const</span> <span class="type">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="type">id</span> obj = [<span class="built_in">NSObject</span> new];</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="type">id</span> __autoreleasing obj1 = obj; <span class="comment">//2</span></span><br><span class="line">          <span class="built_in">NSLog</span>(<span class="string">@&quot;obj1:%@&quot;</span>, obj1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹åº”æ±‡ç¼–ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Ltmp0:</span><br><span class="line">	.loc	1 30 22 prologue_end    ## WeakDemo/main.m:30:22</span><br><span class="line">	callq	_objc_autoreleasePoolPush</span><br><span class="line">Ltmp1:</span><br><span class="line">	.loc	1 31 18                 ## WeakDemo/main.m:31:18</span><br><span class="line">	movq	_OBJC_CLASSLIST_REFERENCES_$_(%rip), %rcx</span><br><span class="line">	movq	_OBJC_SELECTOR_REFERENCES_(%rip), %rsi</span><br><span class="line">	movq	%rcx, %rdi</span><br><span class="line">	movq	%rax, -40(%rbp)         ## 8-byte Spill</span><br><span class="line">	callq	*_objc_msgSend@GOTPCREL(%rip)</span><br><span class="line">	.loc	1 31 12 is_stmt 0       ## WeakDemo/main.m:31:12</span><br><span class="line">	movq	%rax, -24(%rbp)</span><br><span class="line">Ltmp2:</span><br><span class="line">	.loc	1 33 30 is_stmt 1       ## WeakDemo/main.m:33:30</span><br><span class="line">	movq	-24(%rbp), %rdi</span><br><span class="line">	callq	_objc_retainAutorelease</span><br><span class="line">	leaq	L__unnamed_cfstring_(%rip), %rcx</span><br><span class="line">	movq	%rax, -32(%rbp)</span><br><span class="line">	.loc	1 34 29                 ## WeakDemo/main.m:34:29</span><br><span class="line">	movq	-32(%rbp), %rsi</span><br><span class="line">	.loc	1 34 11 is_stmt 0       ## WeakDemo/main.m:34:11</span><br><span class="line">	movq	%rcx, %rdi</span><br><span class="line">	movb	$0, %al</span><br><span class="line">	callq	_NSLog</span><br><span class="line">	xorl	%edx, %edx</span><br><span class="line">	movl	%edx, %esi</span><br><span class="line">Ltmp3:</span><br><span class="line">	.loc	1 36 5 is_stmt 1        ## WeakDemo/main.m:36:5</span><br><span class="line">	leaq	-24(%rbp), %rdi</span><br><span class="line">	callq	_objc_storeStrong</span><br><span class="line">	movq	-40(%rbp), %rdi         ## 8-byte Reload</span><br><span class="line">	callq	_objc_autoreleasePoolPop</span><br><span class="line">	xorl	%eax, %eax</span><br></pre></td></tr></table></figure>
<p>æ¨¡æ‹Ÿä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">id obj = msg_Send(NSObject, <span class="string">&quot;new&quot;</span>);</span><br><span class="line">id obj1 = objc_retainAutorelease(obj); <span class="comment">//retainå¯¹è±¡+æ³¨å†Œå¯¹è±¡åˆ°è‡ªåŠ¨é‡Šæ”¾æ± </span></span><br><span class="line">NSLog(@<span class="string">&quot;obj1:%@&quot;</span>, obj1);</span><br><span class="line">objc_storeStrong(&amp;obj, nil);</span><br></pre></td></tr></table></figure>
<p>objc_retainAutoreleaseå®ç°ï¼š</p>
<figure class="highlight isbl"><table><tr><td class="code"><pre><span class="line"><span class="variable">id</span></span><br><span class="line"><span class="function"><span class="title">objc_retainAutorelease</span>(<span class="variable">id</span> <span class="variable">obj</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">return</span> <span class="function"><span class="title">objc_autorelease</span>(<span class="title">objc_retain</span>(<span class="variable">obj</span>));</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<p>ä¼šå…ˆ retain å¯¹è±¡ï¼Œå†å°†å¯¹è±¡æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± é‡Œã€‚</p>
<p>æ‰€ä»¥<code>id __autoreleasing obj1 = obj;</code> æ‰§è¡Œå®Œåå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å…¶å®æ˜¯ 2ã€‚</p>
<p>ä¾‹å­ 2ï¼š</p>
<p>åˆ›å»ºä¸€ä¸ªå¯¹è±¡å¹¶èµ‹å€¼ç»™__autoreleasing çš„obj1</p>
<figure class="highlight aspectj"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">    <span class="meta">@autoreleasepool</span> &#123;</span><br><span class="line">        &#123;</span><br><span class="line">          id __autoreleasing obj1 = [NSObject <span class="keyword">new</span>];</span><br><span class="line">          NSLog(@<span class="string">&quot;obj1:%@&quot;</span>, obj1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ±‡ç¼–ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Ltmp0:</span><br><span class="line">	.loc	1 30 22 prologue_end    ## WeakDemo/main.m:30:22</span><br><span class="line">	callq	_objc_autoreleasePoolPush</span><br><span class="line">Ltmp1:</span><br><span class="line">	.loc	1 32 37                 ## WeakDemo/main.m:32:37</span><br><span class="line">	movq	_OBJC_CLASSLIST_REFERENCES_$_(%rip), %rcx</span><br><span class="line">	movq	_OBJC_SELECTOR_REFERENCES_(%rip), %rsi</span><br><span class="line">	movq	%rcx, %rdi</span><br><span class="line">	movq	%rax, -32(%rbp)         ## 8-byte Spill</span><br><span class="line">	callq	*_objc_msgSend@GOTPCREL(%rip)</span><br><span class="line">	.loc	1 32 30 is_stmt 0       ## WeakDemo/main.m:32:30</span><br><span class="line">	movq	%rax, %rdi</span><br><span class="line">	callq	_objc_autorelease</span><br><span class="line">	leaq	L__unnamed_cfstring_(%rip), %rcx</span><br><span class="line">	movq	%rax, -24(%rbp)</span><br><span class="line">	.loc	1 33 29 is_stmt 1       ## WeakDemo/main.m:33:29</span><br><span class="line">	movq	-24(%rbp), %rsi</span><br><span class="line">	.loc	1 33 11 is_stmt 0       ## WeakDemo/main.m:33:11</span><br><span class="line">	movq	%rcx, %rdi</span><br><span class="line">	movb	$0, %al</span><br><span class="line">	callq	_NSLog</span><br><span class="line">	movq	-32(%rbp), %rdi         ## 8-byte Reload</span><br><span class="line">Ltmp2:</span><br><span class="line">	.loc	1 35 5 is_stmt 1        ## WeakDemo/main.m:35:5</span><br><span class="line">	callq	_objc_autoreleasePoolPop</span><br><span class="line">	xorl	%eax, %eax</span><br></pre></td></tr></table></figure>
<p>æ¨¡æ‹Ÿä»£ç ï¼š</p>
<figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">id obj1 = msg_Send(<span class="name">NSObject</span>, <span class="string">&quot;new&quot;</span>)<span class="comment">;</span></span><br><span class="line">objc_autorelease(<span class="name">obj1</span>)<span class="comment">;</span></span><br><span class="line">NSLog(@<span class="string">&quot;obj1:%@&quot;</span>, obj1)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>objc_autoreleaseå®ç°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">__attribute__((<span class="built_in">aligned</span>(<span class="number">16</span>), flatten, noinline))</span><br><span class="line"><span class="function">id</span></span><br><span class="line"><span class="function"><span class="title">objc_autorelease</span><span class="params">(id obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!obj) <span class="keyword">return</span> obj;</span><br><span class="line">    <span class="keyword">if</span> (obj-&gt;<span class="built_in">isTaggedPointer</span>()) <span class="keyword">return</span> obj;</span><br><span class="line">    <span class="keyword">return</span> obj-&gt;<span class="built_in">autorelease</span>(); <span class="comment">//å°†å¯¹è±¡æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Equivalent to [this autorelease], with shortcuts if there is no override</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> id </span></span><br><span class="line"><span class="function"><span class="title">objc_object::autorelease</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">ASSERT</span>(!<span class="built_in">isTaggedPointer</span>());</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fastpath</span>(!<span class="built_in">ISA</span>()-&gt;<span class="built_in">hasCustomRR</span>())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">rootAutorelease</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ((<span class="built_in">id</span>(*)(objc_object *, SEL))objc_msgSend)(<span class="keyword">this</span>, @<span class="built_in">selector</span>(autorelease));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯åˆ›å»ºä¸€ä¸ªå¯¹è±¡å¹¶èµ‹å€¼ç»™__autoreleasing çš„æŒ‡é’ˆå˜é‡ï¼Œåˆ™ä»…ä»…æ˜¯å°†å¯¹è±¡æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± ã€‚</p>
<p>å› æ­¤<code>id __autoreleasing obj1 = [NSObject new];</code>æ‰§è¡Œå®Œæˆåï¼Œå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸º 1ã€‚</p>
<h3 id="unsafe-unretained-ä¿®é¥°ç¬¦"><a href="#unsafe-unretained-ä¿®é¥°ç¬¦" class="headerlink" title="__unsafe_unretained ä¿®é¥°ç¬¦"></a>__unsafe_unretained ä¿®é¥°ç¬¦</h3><p>ä»£ç ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> main(<span class="type">int</span> argc, <span class="keyword">const</span> <span class="type">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="type">id</span> obj = [<span class="built_in">NSObject</span> new];</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">id</span> __<span class="keyword">unsafe_unretained</span> obj1 = obj;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;obj1ï¼š%@&quot;</span>, obj1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹åº”çš„æ±‡ç¼–ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Ltmp0:</span><br><span class="line">	.loc	1 30 22 prologue_end    ## WeakDemo/main.m:30:22</span><br><span class="line">	callq	_objc_autoreleasePoolPush</span><br><span class="line">Ltmp1:</span><br><span class="line">	.loc	1 31 18                 ## WeakDemo/main.m:31:18</span><br><span class="line">	movq	_OBJC_CLASSLIST_REFERENCES_$_(%rip), %rcx</span><br><span class="line">	movq	_OBJC_SELECTOR_REFERENCES_(%rip), %rsi</span><br><span class="line">	movq	%rcx, %rdi</span><br><span class="line">	movq	%rax, -40(%rbp)         ## 8-byte Spill</span><br><span class="line">	callq	*_objc_msgSend@GOTPCREL(%rip)</span><br><span class="line">	leaq	L__unnamed_cfstring_(%rip), %rcx</span><br><span class="line">	.loc	1 31 12 is_stmt 0       ## WeakDemo/main.m:31:12</span><br><span class="line">	movq	%rax, -24(%rbp)</span><br><span class="line">Ltmp2:</span><br><span class="line">	.loc	1 33 43 is_stmt 1       ## WeakDemo/main.m:33:43</span><br><span class="line">	movq	-24(%rbp), %rax</span><br><span class="line">	.loc	1 33 36 is_stmt 0       ## WeakDemo/main.m:33:36</span><br><span class="line">	movq	%rax, -32(%rbp)</span><br><span class="line">	.loc	1 34 33 is_stmt 1       ## WeakDemo/main.m:34:33</span><br><span class="line">	movq	-32(%rbp), %rsi</span><br><span class="line">	.loc	1 34 13 is_stmt 0       ## WeakDemo/main.m:34:13</span><br><span class="line">	movq	%rcx, %rdi</span><br><span class="line">	movb	$0, %al</span><br><span class="line">	callq	_NSLog</span><br><span class="line">	xorl	%edx, %edx</span><br><span class="line">	movl	%edx, %esi</span><br><span class="line">Ltmp3:</span><br><span class="line">	.loc	1 36 5 is_stmt 1        ## WeakDemo/main.m:36:5</span><br><span class="line">	leaq	-24(%rbp), %rdi</span><br><span class="line">	callq	_objc_storeStrong</span><br><span class="line">	movq	-40(%rbp), %rdi         ## 8-byte Reload</span><br><span class="line">	callq	_objc_autoreleasePoolPop</span><br><span class="line">	xorl	%eax, %eax</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘å™¨æ¨¡æ‹Ÿä»£ç ï¼š</p>
<figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">id obj = objc_msgSend(<span class="name">NSObject</span>, <span class="string">&quot;new&quot;</span>)<span class="comment">;</span></span><br><span class="line">id obj1 = obj<span class="comment">;</span></span><br><span class="line">NSLog(@<span class="string">&quot;obj1ï¼š%@&quot;</span>, obj1)<span class="comment">;</span></span><br><span class="line">objc_storeStrong(<span class="name">&amp;obj</span>, <span class="literal">nil</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ä»…ä»…æ˜¯æŒ‡é’ˆå˜é‡é—´çš„èµ‹å€¼ï¼Œå…¶ä»–ä»€ä¹ˆæ“ä½œéƒ½æ²¡æœ‰ã€‚</p>
<p>ç¤ºä¾‹ 2ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> main(<span class="type">int</span> argc, <span class="keyword">const</span> <span class="type">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">id</span> __<span class="keyword">unsafe_unretained</span> obj1 = [<span class="built_in">NSObject</span> new];</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;obj1ï¼š%@&quot;</span>, obj1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘å™¨æ¨¡æ‹Ÿä»£ç ï¼š</p>
<figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">id tmp = objc_msgSend(<span class="name">NSObject</span>, <span class="string">&quot;new&quot;</span>)<span class="comment">;</span></span><br><span class="line">id obj1 = tmp<span class="comment">;</span></span><br><span class="line">objc_release(<span class="name">tmp</span>)<span class="comment">;</span></span><br><span class="line">NSLog(@<span class="string">&quot;obj1ï¼š%@&quot;</span>, obj1)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>è¿™ä¸€æ¬¡ä¼šå‘ç”Ÿå´©æºƒï¼Œå› ä¸ºobj1å·²ç»å˜æˆäº†ä¸€ä¸ªé‡æŒ‡é’ˆã€‚</p>
<p><code>__unsafe_unretained</code>çš„åŠŸèƒ½å’Œ assign æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡assign æ—¢å¯ä»¥ä¿®é¥°å¯¹è±¡ç±»å‹ä¹Ÿå¯ä»¥ä¿®é¥°åŸºç¡€ç±»å‹ã€‚æ³¨æ„ï¼šæ²¡æœ‰<code>__assign</code>.</p>
<p>psï¼šä¸ªäººæ„Ÿè§‰è™½ç„¶ ARC çš„ä¼˜ç‚¹æ˜¯åœ¨åˆé€‚çš„åœ°æ–¹è‡ªåŠ¨å¸®æˆ‘ä»¬æ·»åŠ  retain å’Œ releaseï¼Œä½†ä½œä¸ºå¼€å‘è€…çš„æˆ‘ä»¬å¦‚æœæ²¡æœ‰æŸ¥çœ‹æ±‡ç¼–ä»£ç å¹¶ä¸å¥½ç¡®å®šå®ƒç©¶ç«Ÿä¼šåœ¨å“ªäº›åœ°æ–¹æ·»åŠ ä»¥åŠæ·»åŠ çš„å•¥å‡½æ•°è°ƒç”¨ï¼Œæ‰€ä»¥ä¸€äº›å¥‡æ€ªçš„ç°è±¡å¯èƒ½ä¼šè®©ä½ å›°æƒ‘ã€‚å¦‚æœæ˜¯ MRC çš„è¯ï¼Œæˆ‘ä»¬å°±å¾ˆæ¸…æ¥šä¸€ä¸ªå¯¹è±¡çš„é‡Šæ”¾ä¸æŒæœ‰ï¼Œå¼Šç«¯å°±æ˜¯éº»çƒ¦å¹¶ä¸”å®¹æ˜“å¿˜è®° releaseå¯¼è‡´å†…å­˜æ³„æ¼ã€‚ä¸¤ç§æ–¹æ¡ˆå„æœ‰åˆ©å¼Šï¼Œä½†æ€»çš„æ¥è¯´è¿˜æ˜¯ ARC è¦æ›´å¥½ä¸€äº›ã€‚</p>
<h3 id="ç–‘é—®"><a href="#ç–‘é—®" class="headerlink" title="ç–‘é—®"></a>ç–‘é—®</h3><h4 id="Q0ï¼šARC-é€‚ç”¨èŒƒå›´ï¼Ÿæ˜¯å¦ä»…å¯¹-OC-æ–‡ä»¶èµ·ä½œç”¨ï¼Ÿ"><a href="#Q0ï¼šARC-é€‚ç”¨èŒƒå›´ï¼Ÿæ˜¯å¦ä»…å¯¹-OC-æ–‡ä»¶èµ·ä½œç”¨ï¼Ÿ" class="headerlink" title="Q0ï¼šARC é€‚ç”¨èŒƒå›´ï¼Ÿæ˜¯å¦ä»…å¯¹ OC æ–‡ä»¶èµ·ä½œç”¨ï¼Ÿ"></a>Q0ï¼šARC é€‚ç”¨èŒƒå›´ï¼Ÿæ˜¯å¦ä»…å¯¹ OC æ–‡ä»¶èµ·ä½œç”¨ï¼Ÿ</h4><p>è¿™ä¸ªæ²¡æŸ¥åˆ°èµ„æ–™ï¼Œä¹Ÿä¸æ•¢ç¡®å®šï¼Œä½†ä¸ªäººæ„Ÿè§‰ ARC å¼€å¯åï¼Œç¼–è¯‘å™¨åº”è¯¥åªå¯¹ OC æºæ–‡ä»¶åšå¤„ç†ã€‚æ¯•ç«Ÿ C++ä¹Ÿæœ‰å®ƒè‡ªå·±çš„å†…å­˜ç®¡ç†æ–¹å¼ã€‚å› æ­¤åˆ‡æ¢è¯­è¨€åè¿˜æ˜¯è¦æ³¨æ„å†…å­˜ç®¡ç†çš„ä¸åŒã€‚</p>
<h4 id="Q1ï¼šæŠŠä¸€ä¸ª-weak-æŒ‡é’ˆå˜é‡å½“åšå‚æ•°ä¼ ç»™ä¸€ä¸ªæ–¹æ³•ï¼Œå½“æ–¹æ³•å¼€å§‹è°ƒç”¨æ—¶ï¼Œå³ä½¿å¯¹è±¡è¢«å…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†ï¼Œæ­¤åˆ»å¯¹è±¡ä¹Ÿä¸ä¼šè¢«é”€æ¯ï¼ŒåŸå› æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯å½¢å‚è¿™ä¸ªæŒ‡é’ˆå˜é‡åˆå¼ºå¼•ç”¨äº†å¯¹è±¡ï¼Œå¯¼è‡´å¯¹è±¡ä¸ä¼šè¢«é”€æ¯ï¼Œè¿˜æ˜¯å› ä¸ºç¼–è¯‘å™¨æ’å…¥çš„objc-loadWeakRetainedå‡½æ•°ï¼Ÿè¿˜æ˜¯è¯´ä¸¤è€…éƒ½æœ‰ï¼Ÿ"><a href="#Q1ï¼šæŠŠä¸€ä¸ª-weak-æŒ‡é’ˆå˜é‡å½“åšå‚æ•°ä¼ ç»™ä¸€ä¸ªæ–¹æ³•ï¼Œå½“æ–¹æ³•å¼€å§‹è°ƒç”¨æ—¶ï¼Œå³ä½¿å¯¹è±¡è¢«å…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†ï¼Œæ­¤åˆ»å¯¹è±¡ä¹Ÿä¸ä¼šè¢«é”€æ¯ï¼ŒåŸå› æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯å½¢å‚è¿™ä¸ªæŒ‡é’ˆå˜é‡åˆå¼ºå¼•ç”¨äº†å¯¹è±¡ï¼Œå¯¼è‡´å¯¹è±¡ä¸ä¼šè¢«é”€æ¯ï¼Œè¿˜æ˜¯å› ä¸ºç¼–è¯‘å™¨æ’å…¥çš„objc-loadWeakRetainedå‡½æ•°ï¼Ÿè¿˜æ˜¯è¯´ä¸¤è€…éƒ½æœ‰ï¼Ÿ" class="headerlink" title="Q1ï¼šæŠŠä¸€ä¸ª weak æŒ‡é’ˆå˜é‡å½“åšå‚æ•°ä¼ ç»™ä¸€ä¸ªæ–¹æ³•ï¼Œå½“æ–¹æ³•å¼€å§‹è°ƒç”¨æ—¶ï¼Œå³ä½¿å¯¹è±¡è¢«å…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†ï¼Œæ­¤åˆ»å¯¹è±¡ä¹Ÿä¸ä¼šè¢«é”€æ¯ï¼ŒåŸå› æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯å½¢å‚è¿™ä¸ªæŒ‡é’ˆå˜é‡åˆå¼ºå¼•ç”¨äº†å¯¹è±¡ï¼Œå¯¼è‡´å¯¹è±¡ä¸ä¼šè¢«é”€æ¯ï¼Œè¿˜æ˜¯å› ä¸ºç¼–è¯‘å™¨æ’å…¥çš„objc_loadWeakRetainedå‡½æ•°ï¼Ÿè¿˜æ˜¯è¯´ä¸¤è€…éƒ½æœ‰ï¼Ÿ"></a>Q1ï¼šæŠŠä¸€ä¸ª weak æŒ‡é’ˆå˜é‡å½“åšå‚æ•°ä¼ ç»™ä¸€ä¸ªæ–¹æ³•ï¼Œå½“æ–¹æ³•å¼€å§‹è°ƒç”¨æ—¶ï¼Œå³ä½¿å¯¹è±¡è¢«å…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†ï¼Œæ­¤åˆ»å¯¹è±¡ä¹Ÿä¸ä¼šè¢«é”€æ¯ï¼ŒåŸå› æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯å½¢å‚è¿™ä¸ªæŒ‡é’ˆå˜é‡åˆå¼ºå¼•ç”¨äº†å¯¹è±¡ï¼Œå¯¼è‡´å¯¹è±¡ä¸ä¼šè¢«é”€æ¯ï¼Œè¿˜æ˜¯å› ä¸ºç¼–è¯‘å™¨æ’å…¥çš„objc_loadWeakRetainedå‡½æ•°ï¼Ÿè¿˜æ˜¯è¯´ä¸¤è€…éƒ½æœ‰ï¼Ÿ</h4><p>ä¸¤è€…éƒ½æœ‰ï¼Œå› ä¸ºå‡½æ•°è°ƒç”¨æ—¶ä¼šæœ‰ä¸€äº›å‹æ ˆæ“ä½œï¼Œå¦‚æœæ²¡æœ‰objc_loadWeakRetainedï¼Œé‚£ä¹ˆåœ¨å‹æ ˆæ“ä½œæœŸé—´ï¼Œå¯¹è±¡å¯èƒ½å°±é”€æ¯äº†ã€‚å¦å¤–å½¢å‚èµ‹å€¼çš„æ—¶å€™ç¼–è¯‘å™¨ä¹Ÿä¼šæ’å…¥objc_storeStrongè¿™æ—¶å½¢å‚æŒ‡å‘çš„å¯¹è±¡ä¼šè¢« retain ï¼Œå½“å‡½æ•°æ‰§è¡Œå®Œæˆæ—¶ï¼Œå½¢å‚è¢«åºŸå¼ƒä¼šè°ƒç”¨release æ–¹æ³•ã€‚å‡½æ•°è¿”å›åç»§ç»­æ‰§è¡Œ<code>objc_release(tmp);</code>ï¼Œé‡Šæ”¾å¯¹è±¡ã€‚</p>
<p>ç¼–è¯‘å™¨å¯¹æ–¹æ³•çš„å…¥å‚å¯¹è±¡è¿›è¡Œretainå’Œreleaseï¼š</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    [<span class="keyword">self</span> testOjcParamCompilerInsertRetain];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)testOjcParamCompilerInsertRetain &#123;</span><br><span class="line">    XQModel *obj = [XQModel new];</span><br><span class="line">    [<span class="keyword">self</span> hello:obj];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)hello:(XQModel *)model &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;model:%@&quot;</span>, model);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>NSLog(@&quot;model:%@&quot;, model);</code> å¤„æ‰“å¥½æ–­ç‚¹ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20200914173316.png" style="zoom:50%;" /></p>
<p>å¯ä»¥çœ‹åˆ°ç¼–è¯‘å™¨ä¼šæ’å…¥objc_storeStrongï¼Œä»è€Œå¯¹ä¼ å…¥çš„ model å¯¹è±¡è¿›è¡Œ retainï¼Œä¿è¯å‚æ•°æŒ‡å‘çš„å¯¹è±¡åœ¨ä½¿ç”¨æœŸé—´ä¸è¢«é”€æ¯ã€‚</p>
<p>å¯ä»¥poä¸€ä¸‹modelçš„å¼•ç”¨è®¡æ•°ï¼šå·²ç»å˜ä¸º2äº†ã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">(lldb) po <span class="built_in">NSLog</span>(<span class="string">@&quot;retain count = %ld\n&quot;</span>, <span class="built_in">CFGetRetainCount</span>((__bridge  <span class="built_in">CFTypeRef</span>)(model)));</span><br><span class="line"><span class="number">2020</span><span class="number">-09</span><span class="number">-14</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">20.496168</span>+<span class="number">0800</span> iOSWeakDemo[<span class="number">53997</span>:<span class="number">4829011</span>] <span class="keyword">retain</span> count = <span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>å½“æ–¹æ³•æ‰§è¡Œå®Œåï¼Œåˆä¼šæ‰§è¡Œobjc_storeStrong(&amp;model, nil); é‡Šæ”¾å¯¹è±¡ã€‚</p>
<p>è¿™ä¸ªå…¶å®åœ¨MRCä¸‹ä¼šç»å¸¸å†™è¿™æ ·çš„ä»£ç ï¼Œå¯¹å…¥å‚å¯¹è±¡retainï¼Œä½¿ç”¨å®Œåreleaseã€‚åªä¸è¿‡åœ¨ARCä¸‹ç¼–è¯‘å™¨å¸®ä½ è‡ªåŠ¨å®Œæˆäº†è¿™äº›æ“ä½œã€‚</p>
<h4 id="Q2ï¼šå‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ç©¶ç«Ÿæ˜¯æ€æ ·çš„ï¼Ÿ"><a href="#Q2ï¼šå‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ç©¶ç«Ÿæ˜¯æ€æ ·çš„ï¼Ÿ" class="headerlink" title="Q2ï¼šå‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ç©¶ç«Ÿæ˜¯æ€æ ·çš„ï¼Ÿ"></a>Q2ï¼šå‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ç©¶ç«Ÿæ˜¯æ€æ ·çš„ï¼Ÿ</h4><p>å‚è€ƒï¼š</p>
<p><a href="https://segmentfault.com/a/1190000007977460">Cå‡½æ•°è°ƒç”¨è¿‡ç¨‹åŸç†åŠå‡½æ•°æ ˆå¸§åˆ†æ</a></p>
<p><a href="https://www.cnblogs.com/dongzhiquan/p/7828667.html">X86-64å¯„å­˜å™¨å’Œæ ˆå¸§</a></p>
<h4 id="Q3ï¼šåœ¨-OC-ä¸­-obj-hello-å®é™…ä¸Šæ˜¯ä¼šå˜æˆobjc-msgSend-obj-quot-hello-quot-çš„è°ƒç”¨ï¼Œ-void-hello-æ–¹æ³•å…¶å®æ˜¯æš—å«äº†ä¸¤ä¸ªå‚æ•°çš„ä¸€ä¸ªæ˜¯-id-selfï¼Œä¸€ä¸ªæ˜¯-sel-cmdï¼Œé—®-self-æ˜¯å¦ä¼šå¼ºå¼•ç”¨å¯¹è±¡ï¼Ÿ"><a href="#Q3ï¼šåœ¨-OC-ä¸­-obj-hello-å®é™…ä¸Šæ˜¯ä¼šå˜æˆobjc-msgSend-obj-quot-hello-quot-çš„è°ƒç”¨ï¼Œ-void-hello-æ–¹æ³•å…¶å®æ˜¯æš—å«äº†ä¸¤ä¸ªå‚æ•°çš„ä¸€ä¸ªæ˜¯-id-selfï¼Œä¸€ä¸ªæ˜¯-sel-cmdï¼Œé—®-self-æ˜¯å¦ä¼šå¼ºå¼•ç”¨å¯¹è±¡ï¼Ÿ" class="headerlink" title="Q3ï¼šåœ¨ OC ä¸­ [obj hello]; å®é™…ä¸Šæ˜¯ä¼šå˜æˆobjc_msgSend(obj, &quot;hello&quot;)çš„è°ƒç”¨ï¼Œ-(void)hello;æ–¹æ³•å…¶å®æ˜¯æš—å«äº†ä¸¤ä¸ªå‚æ•°çš„ä¸€ä¸ªæ˜¯ id selfï¼Œä¸€ä¸ªæ˜¯ sel _cmdï¼Œé—® self æ˜¯å¦ä¼šå¼ºå¼•ç”¨å¯¹è±¡ï¼Ÿ"></a>Q3ï¼šåœ¨ OC ä¸­ <code>[obj hello];</code> å®é™…ä¸Šæ˜¯ä¼šå˜æˆ<code>objc_msgSend(obj, &quot;hello&quot;)</code>çš„è°ƒç”¨ï¼Œ<code>-(void)hello;</code>æ–¹æ³•å…¶å®æ˜¯æš—å«äº†ä¸¤ä¸ªå‚æ•°çš„ä¸€ä¸ªæ˜¯ <code>id self</code>ï¼Œä¸€ä¸ªæ˜¯ <code>sel _cmd</code>ï¼Œé—® self æ˜¯å¦ä¼šå¼ºå¼•ç”¨å¯¹è±¡ï¼Ÿ</h4><p>ä»è§‚å¯Ÿåˆ°çš„ç°è±¡æ¥çœ‹æ˜¯æ²¡æœ‰çš„ï¼Œä¸¾ä¾‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="variable language_">super</span> viewDidLoad];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    [<span class="keyword">self</span> testObjLife];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark- weak</span></span><br><span class="line">- (<span class="type">void</span>)testObjLife &#123;</span><br><span class="line">    <span class="keyword">self</span>.obj = [ARCPerson new];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;self.obj:%@&quot;</span>, _obj);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">self</span>.obj = <span class="literal">nil</span>; <span class="comment">//é‡Šæ”¾å¯¹è±¡</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;æ¸…é™¤&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="comment">//    [_obj doTask]; //å´©æºƒã€‚</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     ä½¿ç”¨[self.obj doTask];</span></span><br><span class="line"><span class="comment">     ä¸ä¼šé‡æŒ‡é’ˆå´©æºƒï¼Œå› ä¸ºæ±‡ç¼–ä»£ç é‡Œæ‰§è¡Œself.objåä¼šï¼Œæ¥ç€è°ƒç”¨çš„æ˜¯objc_retainAutoreleasedReturnValue</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  	<span class="comment">//è¿™é‡Œå…¶å®æ˜¯ä¸¤ä¸ªæ–¹æ³•çš„è°ƒç”¨:[[self obj] doTask];</span></span><br><span class="line">  	<span class="comment">//ç›¸å½“äºARCPerson *temp = [self obj]; //ç¼–è¯‘å™¨ä¼šæ’å…¥objc_retainAutoreleasedReturnValueã€‚</span></span><br><span class="line">  	<span class="comment">//[temp doTask];</span></span><br><span class="line">  	<span class="comment">//tempè¶…å‡ºä½œç”¨åŸŸåºŸå¼ƒæ—¶ç¼–è¯‘å™¨æ’å…¥objc_releaseï¼Œå¯¹åº”objc_retainAutoreleasedReturnValueã€‚</span></span><br><span class="line">    [<span class="keyword">self</span>.obj doTask]; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ARCPerson</span></span><br><span class="line">- (<span class="type">void</span>)doTask &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;å¼€å§‹è®¡ç®—&quot;</span>);</span><br><span class="line">    <span class="type">float</span> f = <span class="number">0.0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; <span class="number">60000000</span>; i ++)</span><br><span class="line">    &#123;</span><br><span class="line">       f = f + sin(sin(sin(time(<span class="literal">NULL</span>) + i )));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;è®¡ç®—å®Œæˆ&quot;</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;model:%@  rs:%ld&quot;</span>, <span class="keyword">self</span>, (<span class="type">long</span>)f);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“æ‰§è¡Œäº†<code>self.obj = nil; //é‡Šæ”¾å¯¹è±¡</code>åï¼Œå¯¹è±¡å°±é”€æ¯äº†ï¼Œç„¶åå´©æºƒåœ¨doTaské‡Œã€‚è¯´æ˜ self å¹¶æ²¡æœ‰å¼ºå¼•ç”¨å¯¹è±¡ã€‚</p>
<p>ä¸ºå•¥ä½¿ç”¨ <code>[self.obj doTask];</code> å°±ä¸ä¼šå´©æºƒå‘¢ï¼Ÿ</p>
<p>åœ¨ <code>[self.obj doTask];</code> å¤„æ‰“å¥½æ–­ç‚¹ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20200914152010.png" style="zoom:50%;" /></p>
<p>ä¼šå‘ç° <code>[self.obj doTask];</code> ç­‰ä»·äºï¼š</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">id tmp = objc_msgSend(<span class="variable language_">self</span>, <span class="string">&quot;obj&quot;</span>); </span><br><span class="line">objc_retainAutoreleasedReturnValue(tmp); <span class="regexp">//</span>è²Œä¼¼åªè¦å‰ä¸€å¥ä»£ç æ˜¯éå¸¸è§„è·å¾—çš„å¯¹è±¡éƒ½ä¼šæœ‰è¿™ä¸ªå‡½æ•°çš„å‡ºç°ã€‚</span><br><span class="line">objc_msgSend(tmp, <span class="string">&quot;doTask&quot;</span>);</span><br><span class="line">objc_release(tmp); <span class="regexp">//</span>è¿™é‡Œæ˜¯objc_releaseè€Œä¸æ˜¯objc_storeStrongæ˜¯å› ä¸ºæˆ‘ä»¬çš„ä»£ç ä¸æ˜¯<span class="string">&quot;id obj = [self obj]; [obj doTask];&quot;</span></span><br></pre></td></tr></table></figure>
<p>å•æ­¥æ‰§è¡Œï¼Œå¹¶è¿›å…¥åˆ°objc_retainAutoreleasedReturnValueå‡½æ•°é‡Œï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20200914153236.png" style="zoom:50%;" /></p>
<p>ä¼šå‘ç°objc_retainAutoreleasedReturnValueçš„å‚æ•°å°±æ˜¯tmpï¼Œç»§ç»­è·Ÿè¸ªçš„è¯ä¼šå‘ç°objc_retainAutoreleasedReturnValueå†…éƒ¨è°ƒç”¨äº†objc_retainï¼Œäºæ˜¯tmpçš„å¼•ç”¨è®¡æ•°+1ï¼Œæ‰€ä»¥ä½¿ç”¨ <code>[self.obj doTask];</code> ä¸ä¼šå´©æºƒã€‚</p>
<p>è€Œç›´æ¥ä½¿ç”¨ç¤ºä¾‹å˜é‡ <code>[_obj doTask];</code> </p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20200914153831.png" style="zoom:50%;" /></p>
<p>åˆ™æ²¡æœ‰ç±»ä¼¼çš„objc_retainAutoreleasedReturnValueå¤„ç†ï¼Œå› æ­¤2ç§’åå½“self.obj = nil;ç½®ä¸ºnilæ—¶ï¼Œobjå°±ä¼šé‡Šæ”¾å¹¶é”€æ¯ï¼ŒdoTaskå†…éƒ¨å†è®¿é—®selfæ—¶ä¼šé‡æŒ‡é’ˆå´©æºƒã€‚</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20200914154649.png" alt=""></p>
<p>æ‰“å°æ—¥å¿—ï¼š</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">2020</span>-<span class="number">09</span>-<span class="number">14</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">43</span>.<span class="number">518910</span>+<span class="number">0800</span> iOSWeakDemo[<span class="number">52902</span>:<span class="number">4783450</span>] self.obj:&lt;ARCPerson: <span class="number">0</span>x6000039dc500&gt;</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">09</span>-<span class="number">14</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">43</span>.<span class="number">519025</span>+<span class="number">0800</span> iOSWeakDemo[<span class="number">52902</span>:<span class="number">4783450</span>] å¼€å§‹è®¡ç®—</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">09</span>-<span class="number">14</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">45</span>.<span class="number">521771</span>+<span class="number">0800</span> iOSWeakDemo[<span class="number">52902</span>:<span class="number">4783607</span>] ARCPerson dealloc</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">09</span>-<span class="number">14</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">45</span>.<span class="number">521966</span>+<span class="number">0800</span> iOSWeakDemo[<span class="number">52902</span>:<span class="number">4783607</span>] (null) <span class="number">2</span></span><br><span class="line"><span class="attribute">2020</span>-<span class="number">09</span>-<span class="number">14</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">45</span>.<span class="number">522120</span>+<span class="number">0800</span> iOSWeakDemo[<span class="number">52902</span>:<span class="number">4783607</span>] æ¸…é™¤</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">09</span>-<span class="number">14</span> <span class="number">15</span>:<span class="number">45</span>:<span class="number">59</span>.<span class="number">732099</span>+<span class="number">0800</span> iOSWeakDemo[<span class="number">52902</span>:<span class="number">4783450</span>] è®¡ç®—å®Œæˆ</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è¿˜æ²¡è®¡ç®—å®Œæˆï¼ŒselfæŒ‡å‘çš„å¯¹è±¡å°±å·²ç»é”€æ¯äº†ã€‚</p>
<h4 id="Q4ï¼šMRCä¸‹deallocé‡å†™æ—¶superè°ƒç”¨çš„ä½ç½®ï¼Ÿ-super-dealloc-åˆ°åº•å¹²äº†å•¥ï¼Ÿ"><a href="#Q4ï¼šMRCä¸‹deallocé‡å†™æ—¶superè°ƒç”¨çš„ä½ç½®ï¼Ÿ-super-dealloc-åˆ°åº•å¹²äº†å•¥ï¼Ÿ" class="headerlink" title="Q4ï¼šMRCä¸‹deallocé‡å†™æ—¶superè°ƒç”¨çš„ä½ç½®ï¼Ÿ[super dealloc]åˆ°åº•å¹²äº†å•¥ï¼Ÿ"></a>Q4ï¼šMRCä¸‹deallocé‡å†™æ—¶superè°ƒç”¨çš„ä½ç½®ï¼Ÿ[super dealloc]åˆ°åº•å¹²äº†å•¥ï¼Ÿ</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)dealloc &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;MRCPerson dealloc&quot;</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ 4&quot;</span>, <span class="keyword">self</span>.cat);</span><br><span class="line">    [<span class="variable language_">super</span> dealloc]; <span class="comment">//è¦æ”¾åœ¨æœ€å</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å´©æºƒå†™æ³•</span></span><br><span class="line">- (<span class="type">void</span>)dealloc &#123;</span><br><span class="line">    [<span class="variable language_">super</span> dealloc];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;MRCPerson dealloc&quot;</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ 4&quot;</span>, <span class="keyword">self</span>.cat); <span class="comment">//è¿™é‡Œé‡æŒ‡é’ˆå´©æºƒã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>deallocæ–¹æ³•å°±æ˜¯é‡Šæ”¾å¯¹è±¡è‡ªèº«çš„å†…å­˜ï¼Œä»¥åŠææ„å®ƒæ‹¥æœ‰çš„æ‰€æœ‰èµ„æºï¼Œæ¯”å¦‚å®ä¾‹å˜é‡å¯¹è±¡ã€‚åœ¨MRCä¸‹ï¼Œ[super dealloc]å¿…é¡»æ”¾åœ¨æœ€åã€‚å¦‚æœä½ æ”¾æœ€å¼€å§‹çš„åœ°æ–¹ï¼Œé‚£ä¹ˆæ‰§è¡Œå®Œåå¯¹è±¡å°±å·²ç»è¢«é”€æ¯äº†ï¼Œåé¢å¦‚æœè¿˜æœ‰æ–¹æ³•å¯¹è±¡çš„åœ°æ–¹å°†å¯¼è‡´å´©æºƒã€‚</p>
<p>è¿˜æ˜¯è¦çœ‹æºç [super dealloc]ã€‚</p>
<p>å‚è€ƒï¼š</p>
<p><a href="https://stackoverflow.com/questions/4566453/correct-super-dealloc">Correct [super dealloc]</a></p>
<p><a href="https://blog.sunnyxx.com/2014/04/02/objc_dig_arc_dealloc/">ARCä¸‹deallocè¿‡ç¨‹åŠ.cxx_destructçš„æ¢ç©¶</a>  4æ˜Ÿ</p>
<h4 id="Q5ï¼šä¸€ä¸ªweakæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªMRCå¯¹è±¡ï¼Œè¯¥MRCå¯¹è±¡é‡å†™äº†deallocä½†ä¸è°ƒç”¨-super-dealloc-ï¼Œå½“è¯¥MRCå¯¹è±¡é”€æ¯åï¼Œå†æ‰“å°è¯¥weakæŒ‡é’ˆï¼Œä¼šè¾“å‡ºä»€ä¹ˆï¼Ÿnilè¿˜æ˜¯å¯¹è±¡åœ°å€ï¼Ÿ"><a href="#Q5ï¼šä¸€ä¸ªweakæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªMRCå¯¹è±¡ï¼Œè¯¥MRCå¯¹è±¡é‡å†™äº†deallocä½†ä¸è°ƒç”¨-super-dealloc-ï¼Œå½“è¯¥MRCå¯¹è±¡é”€æ¯åï¼Œå†æ‰“å°è¯¥weakæŒ‡é’ˆï¼Œä¼šè¾“å‡ºä»€ä¹ˆï¼Ÿnilè¿˜æ˜¯å¯¹è±¡åœ°å€ï¼Ÿ" class="headerlink" title="Q5ï¼šä¸€ä¸ªweakæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªMRCå¯¹è±¡ï¼Œè¯¥MRCå¯¹è±¡é‡å†™äº†deallocä½†ä¸è°ƒç”¨[super dealloc]ï¼Œå½“è¯¥MRCå¯¹è±¡é”€æ¯åï¼Œå†æ‰“å°è¯¥weakæŒ‡é’ˆï¼Œä¼šè¾“å‡ºä»€ä¹ˆï¼Ÿnilè¿˜æ˜¯å¯¹è±¡åœ°å€ï¼Ÿ"></a>Q5ï¼šä¸€ä¸ªweakæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªMRCå¯¹è±¡ï¼Œè¯¥MRCå¯¹è±¡é‡å†™äº†deallocä½†ä¸è°ƒç”¨[super dealloc]ï¼Œå½“è¯¥MRCå¯¹è±¡é”€æ¯åï¼Œå†æ‰“å°è¯¥weakæŒ‡é’ˆï¼Œä¼šè¾“å‡ºä»€ä¹ˆï¼Ÿnilè¿˜æ˜¯å¯¹è±¡åœ°å€ï¼Ÿ</h4><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="variable language_">super</span> viewDidLoad];</span><br><span class="line">    [<span class="keyword">self</span> test_subclass_do_not_call_super_dealloc];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;weakObj:%@&quot;</span>, _wobj);<span class="comment">//æ–­ç‚¹æ‰“åœ¨è¿™</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)test_subclass_do_not_call_super_dealloc &#123;</span><br><span class="line">    MRCPerson *per = [[MRCPerson alloc] init];</span><br><span class="line">    _wobj = per;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;_wobj:%@&quot;</span>, _wobj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//MRCPersonä¸è°ƒç”¨[super dealloc]</span></span><br><span class="line">- (<span class="type">void</span>)dealloc &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ dealloc&quot;</span>, <span class="keyword">self</span>.class);</span><br><span class="line"><span class="comment">//    [super dealloc];</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç­”æ¡ˆï¼šè¾“å‡ºnilã€‚</p>
<p>åˆ†æï¼šå¯¹è±¡é”€æ¯æ—¶å¦‚æœä¸è°ƒç”¨[super dealloc]ï¼Œç†è®ºä¸Šä¸ä¼šæ¸…é™¤å¯¹è±¡çš„weakè¡¨ï¼Œè‡ªç„¶weakæŒ‡é’ˆä¹Ÿä¸ä¼šè¢«ç½®ä¸ºnilï¼Œå› æ­¤åº”è¯¥è¾“å‡ºå¯¹è±¡çš„åœ°å€ï¼Œç„¶è€Œå´è¾“å‡ºäº†nilï¼Œè¿™è¯´æ˜æŸä¸ªåœ°æ–¹åšäº†ä¸€äº›å¤„ç†ã€‚ä»ä¸Šé¢çš„åˆ†ææˆ‘ä»¬å·²ç»çŸ¥é“ä½¿ç”¨weakæŒ‡é’ˆæ—¶ï¼Œç¼–è¯‘å™¨ä¼šåœ¨å‰é¢æ’å…¥ <code>objc_loadWeakRetained</code> ï¼Œä½¿ç”¨å®Œååœ¨åé¢æ’å…¥ <code>objc_release</code> ã€‚</p>
<p>å› æ­¤ <code>NSLog(@&quot;weakObj:%@&quot;, _wobj);//æ–­ç‚¹æ‰“åœ¨è¿™</code> ç­‰ä»·äºï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">id tmp = objc_loadWeakRetained(&amp;_wobj);  </span><br><span class="line">NSLog(@<span class="string">&quot;weakObj:%@&quot;</span>, tmp);</span><br><span class="line">objc_release(tmp);  </span><br></pre></td></tr></table></figure>
<p>è€Œ objc_loadWeakRetained æºç é‡Œä¼šrootTryRetainï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">id</span><br><span class="line"><span class="title function_">objc_loadWeakRetained</span><span class="params">(id *location)</span></span><br><span class="line">&#123;</span><br><span class="line">    id obj;</span><br><span class="line">    id result;</span><br><span class="line">    Class cls;</span><br><span class="line"></span><br><span class="line">    SideTable *table;</span><br><span class="line">    </span><br><span class="line"> retry:</span><br><span class="line">    <span class="comment">// fixme std::atomic this load</span></span><br><span class="line">    obj = *location;</span><br><span class="line">    <span class="keyword">if</span> (!obj) <span class="keyword">return</span> nil;</span><br><span class="line">    <span class="keyword">if</span> (obj-&gt;isTaggedPointer()) <span class="keyword">return</span> obj;</span><br><span class="line">    </span><br><span class="line">    table = &amp;SideTables()[obj];</span><br><span class="line">    </span><br><span class="line">    table-&gt;lock();</span><br><span class="line">    <span class="keyword">if</span> (*location != obj) &#123;</span><br><span class="line">        table-&gt;unlock();</span><br><span class="line">        <span class="keyword">goto</span> retry;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    result = obj;</span><br><span class="line"></span><br><span class="line">    cls = obj-&gt;ISA();</span><br><span class="line">    <span class="keyword">if</span> (! cls-&gt;hasCustomRR()) &#123;</span><br><span class="line">        <span class="comment">// Fast case. We know +initialize is complete because</span></span><br><span class="line">        <span class="comment">// default-RR can never be set before then.</span></span><br><span class="line">        ASSERT(cls-&gt;isInitialized());</span><br><span class="line">        <span class="keyword">if</span> (! obj-&gt;rootTryRetain()) &#123;  <span class="comment">//è¿™é‡ŒrootTryRetain</span></span><br><span class="line">            result = nil;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Slow case. We must check for +initialize and call it outside</span></span><br><span class="line">        <span class="comment">// the lock if necessary in order to avoid deadlocks.</span></span><br><span class="line">        <span class="keyword">if</span> (cls-&gt;isInitialized() || _thisThreadIsInitializingClass(cls)) &#123;</span><br><span class="line">            BOOL (*tryRetain)(id, SEL) = (BOOL(*)(id, SEL))</span><br><span class="line">                class_getMethodImplementation(cls, @selector(retainWeakReference));</span><br><span class="line">            <span class="keyword">if</span> ((IMP)tryRetain == _objc_msgForward) &#123;</span><br><span class="line">                result = nil;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (! (*tryRetain)(obj, @selector(retainWeakReference))) &#123; <span class="comment">//retainWeakReference</span></span><br><span class="line">                result = nil;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            table-&gt;unlock();</span><br><span class="line">            class_initialize(cls, obj);</span><br><span class="line">            <span class="keyword">goto</span> retry;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    table-&gt;unlock();</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>rootTryRetainé‡Œä¼šåˆ¤æ–­å¦‚æœå¯¹è±¡æ­£åœ¨é”€æ¯ï¼Œåˆ™è¿”å›nilï¼Œå› æ­¤å¯¼è‡´objc_loadWeakRetainedä¹Ÿè¿”å›nilã€‚äºæ˜¯tmpç­‰äºnilï¼Œè‡ªç„¶æ‰“å°çš„ä¹Ÿæ˜¯niläº†ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é‡å†™retainWeakReferenceï¼Œè¿”å›yesï¼Œå†è¿è¡Œä¸€ä¸‹ï¼Œè¿™æ—¶æ‰“å°çš„å°±æ˜¯å¯¹è±¡çš„åœ°å€äº†ã€‚æ‰€ä»¥è¿™é‡Œçš„nilå¹¶ä¸æ˜¯å› ä¸ºweakè¢«æ¸…ï¼ŒweakæŒ‡é’ˆè¢«ç½®ä¸ºnilï¼Œè€Œæ˜¯å› ä¸ºobjc_loadWeakRetainedè¿”å›äº†nilã€‚å¦å¤–å¯¹äºMRCæ¥è¯´é‡å†™deallocæ–¹æ³•ä¸€å®šè¦è°ƒç”¨superçš„deallocï¼Œå¦åˆ™é”€æ¯å·¥ä½œå¹¶æ²¡æœ‰å®Œå…¨ç»“æŸï¼Œå†…å­˜ä¼šæœ‰æ³„æ¼ã€‚</p>
<h4 id="Q6ï¼šå¦‚ä½•ç†è§£OCä¸­å†…å­˜ç®¡ç†ç›¸å…³çš„æ–¹æ³•å‘½åè§„åˆ™ï¼Ÿ"><a href="#Q6ï¼šå¦‚ä½•ç†è§£OCä¸­å†…å­˜ç®¡ç†ç›¸å…³çš„æ–¹æ³•å‘½åè§„åˆ™ï¼Ÿ" class="headerlink" title="Q6ï¼šå¦‚ä½•ç†è§£OCä¸­å†…å­˜ç®¡ç†ç›¸å…³çš„æ–¹æ³•å‘½åè§„åˆ™ï¼Ÿ"></a>Q6ï¼šå¦‚ä½•ç†è§£OCä¸­å†…å­˜ç®¡ç†ç›¸å…³çš„æ–¹æ³•å‘½åè§„åˆ™ï¼Ÿ</h4><p>åœ¨OCä¸­å¯¹äºä»¥alloc/init/new/copy/mutableCopyå¼€å¤´çš„æ–¹æ³•åˆ›å»ºè¿”å›çš„å¯¹è±¡ï¼Œæ˜¯è‡ªå·±æ‹¥æœ‰çš„å¯¹è±¡éœ€è¦è‡ªå·±é‡Šæ”¾ã€‚å…¶ä»–å¼€å¤´çš„æ–¹æ³•åˆ›å»ºè¿”å›çš„å¯¹è±¡ï¼Œåˆ™ä¸æ˜¯è‡ªå·±æ‹¥æœ‰çš„å¯¹è±¡ä¸èƒ½è‡ªå·±é‡Šæ”¾ï¼Œä¸€èˆ¬è€Œè¨€è¿™æ ·çš„å¯¹è±¡æ˜¯æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± çš„å¯¹è±¡ï¼Œä¼šåœ¨è‡ªåŠ¨é‡Šæ”¾æ± é”€æ¯æ—¶é‡Šæ”¾ï¼Œå½“ç„¶åœ¨ä¸€äº›ç‰¹å®šæƒ…å†µä¸‹ç³»ç»Ÿä¼šä¼˜åŒ–æ€§èƒ½é¿å…æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œè¿™ä¸€åˆ‡å¯¹äºå¼€å‘è€…è€Œè¨€æ˜¯æ— æ„ŸçŸ¥çš„ï¼Œå³ä½¿å¦‚æ­¤ä½ ä¾ç„¶æ²¡æœ‰æ‹¥æœ‰è¯¥å¯¹è±¡ä¸èƒ½è‡ªå·±é‡Šæ”¾ã€‚</p>
<p>æ¯”å¦‚myPersonæ–¹æ³•ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)myPerson &#123;</span><br><span class="line">    ARCPerson *p = [[ARCPerson alloc] init];</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>return p;</code> æ‰“å¥½æ–­ç‚¹ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20200914165036.png" style="zoom:50%;" /></p>
<p>åœ¨è¿”å›æ—¶ç³»ç»Ÿä¼šå°†å¯¹è±¡æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± é‡Œã€‚å› æ­¤è‡ªå·±ä¸æ‹¥æœ‰è¯¥å¯¹è±¡ï¼Œä¹Ÿå°±ä¸èƒ½è°ƒç”¨releaseæ–¹æ³•ã€‚</p>
<p>è€Œå¯¹äºnewPersonæ–¹æ³•ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)newPerson &#123;</span><br><span class="line">    ARCPerson *p = [[ARCPerson alloc] init];</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20200914165326.png" style="zoom:50%;" /></p>
<p>æ²¡æœ‰å…¶ä»–å¤„ç†ï¼Œè¿”å›çš„å¯¹è±¡æ˜¯è‡ªå·±æ‹¥æœ‰çš„ï¼Œå› æ­¤éœ€è¦è‡ªå·±é‡Šæ”¾ã€‚</p>
<p>å†æ¯”å¦‚getteræ–¹æ³•ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) MRCPerson *wobj;</span><br><span class="line"></span><br><span class="line">- (MRCPerson *)wobj &#123;</span><br><span class="line">    <span class="keyword">return</span> _wobj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹åº”çš„æ±‡ç¼–ï¼š</p>
<figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line">iOSWeakDemo`-[ViewController wobj]:</span><br><span class="line">    <span class="number">0x101e945e0</span> &lt;<span class="number">+0</span>&gt;:  pushq  <span class="variable">%rbp</span></span><br><span class="line">    <span class="number">0x101e945e1</span> &lt;<span class="number">+1</span>&gt;:  movq   <span class="variable">%rsp</span><span class="punctuation">,</span> <span class="variable">%rbp</span></span><br><span class="line">    <span class="number">0x101e945e4</span> &lt;<span class="number">+4</span>&gt;:  subq   $<span class="number">0x10</span><span class="punctuation">,</span> <span class="variable">%rsp</span></span><br><span class="line">    <span class="number">0x101e945e8</span> &lt;<span class="number">+8</span>&gt;:  movq   <span class="variable">%rdi</span><span class="punctuation">,</span> <span class="number">-0</span><span class="keyword">x</span><span class="number">8</span>(<span class="variable">%rbp</span>)</span><br><span class="line">    <span class="number">0x101e945ec</span> &lt;<span class="number">+12</span>&gt;: movq   <span class="variable">%rsi</span><span class="punctuation">,</span> <span class="number">-0</span><span class="keyword">x</span><span class="number">10</span>(<span class="variable">%rbp</span>)</span><br><span class="line">    <span class="number">0x101e945f0</span> &lt;<span class="number">+16</span>&gt;: movq   <span class="number">-0</span><span class="keyword">x</span><span class="number">8</span>(<span class="variable">%rbp</span>)<span class="punctuation">,</span> <span class="variable">%rax</span></span><br><span class="line">-&gt;  <span class="number">0x101e945f4</span> &lt;<span class="number">+20</span>&gt;: movq   <span class="number">0x968d</span>(<span class="variable">%rip</span>)<span class="punctuation">,</span> <span class="variable">%rcx</span>        <span class="comment">; ViewController._wobj</span></span><br><span class="line">    <span class="number">0x101e945fb</span> &lt;<span class="number">+27</span>&gt;: addq   <span class="variable">%rcx</span><span class="punctuation">,</span> <span class="variable">%rax</span></span><br><span class="line">    <span class="number">0x101e945fe</span> &lt;<span class="number">+30</span>&gt;: movq   <span class="variable">%rax</span><span class="punctuation">,</span> <span class="variable">%rdi</span></span><br><span class="line">    <span class="number">0x101e94601</span> &lt;<span class="number">+33</span>&gt;: callq  <span class="number">0x101e96024</span>               <span class="comment">; symbol stub for: objc_loadWeakRetained</span></span><br><span class="line">    <span class="number">0x101e94606</span> &lt;<span class="number">+38</span>&gt;: movq   <span class="variable">%rax</span><span class="punctuation">,</span> <span class="variable">%rdi</span></span><br><span class="line">    <span class="number">0x101e94609</span> &lt;<span class="number">+41</span>&gt;: addq   $<span class="number">0x10</span><span class="punctuation">,</span> <span class="variable">%rsp</span></span><br><span class="line">    <span class="number">0x101e9460d</span> &lt;<span class="number">+45</span>&gt;: popq   <span class="variable">%rbp</span></span><br><span class="line">    <span class="number">0x101e9460e</span> &lt;<span class="number">+46</span>&gt;: jmp    <span class="number">0x101e96006</span>               <span class="comment">; symbol stub for: objc_autoreleaseReturnValue</span></span><br></pre></td></tr></table></figure>
<p>å› ä¸ºè¿™é‡Œæ˜¯weakæŒ‡é’ˆï¼Œæ‰€ä»¥è¿™é‡Œè°ƒç”¨çš„objc_loadWeakRetainedå‡½æ•°ã€‚å¦å¤–è¿˜ä¼šè°ƒç”¨objc_autoreleaseReturnValueæ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± if neededã€‚</p>
<p>å¦‚æœæ˜¯strongå±æ€§ï¼š</p>
<figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line">iOSWeakDemo`-[ViewController wobj]:</span><br><span class="line">    <span class="number">0x10529c5f0</span> &lt;<span class="number">+0</span>&gt;:  pushq  <span class="variable">%rbp</span></span><br><span class="line">    <span class="number">0x10529c5f1</span> &lt;<span class="number">+1</span>&gt;:  movq   <span class="variable">%rsp</span><span class="punctuation">,</span> <span class="variable">%rbp</span></span><br><span class="line">    <span class="number">0x10529c5f4</span> &lt;<span class="number">+4</span>&gt;:  movq   <span class="variable">%rdi</span><span class="punctuation">,</span> <span class="number">-0</span><span class="keyword">x</span><span class="number">8</span>(<span class="variable">%rbp</span>)</span><br><span class="line">    <span class="number">0x10529c5f8</span> &lt;<span class="number">+8</span>&gt;:  movq   <span class="variable">%rsi</span><span class="punctuation">,</span> <span class="number">-0</span><span class="keyword">x</span><span class="number">10</span>(<span class="variable">%rbp</span>)</span><br><span class="line">    <span class="number">0x10529c5fc</span> &lt;<span class="number">+12</span>&gt;: movq   <span class="number">-0</span><span class="keyword">x</span><span class="number">8</span>(<span class="variable">%rbp</span>)<span class="punctuation">,</span> <span class="variable">%rax</span></span><br><span class="line">-&gt;  <span class="number">0x10529c600</span> &lt;<span class="number">+16</span>&gt;: movq   <span class="number">0x9689</span>(<span class="variable">%rip</span>)<span class="punctuation">,</span> <span class="variable">%rcx</span>        <span class="comment">; ViewController._wobj</span></span><br><span class="line">    <span class="number">0x10529c607</span> &lt;<span class="number">+23</span>&gt;: movq   (<span class="variable">%rax</span><span class="punctuation">,</span><span class="variable">%rcx</span>)<span class="punctuation">,</span> <span class="variable">%rdi</span></span><br><span class="line">    <span class="number">0x10529c60b</span> &lt;<span class="number">+27</span>&gt;: popq   <span class="variable">%rbp</span></span><br><span class="line">    <span class="number">0x10529c60c</span> &lt;<span class="number">+28</span>&gt;: jmp    <span class="number">0x10529e02c</span>               <span class="comment">; symbol stub for: objc_retainAutoreleaseReturnValue</span></span><br></pre></td></tr></table></figure>
<p>å°±åªæœ‰objc_retainAutoreleaseReturnValueäº†ã€‚è¯¥å‡½æ•°çš„ä½œç”¨å°±æ˜¯retain+autoreleaseã€‚</p>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
      <tags>
        <tag>å†…å­˜ç®¡ç†</tag>
      </tags>
  </entry>
  <entry>
    <title>OCå†…å­˜ç®¡ç†ä¹‹weakä¿®é¥°ç¬¦å®ç°åŸç†</title>
    <url>/2020/06/15/OC%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E4%B9%8Bweak%E4%BF%AE%E9%A5%B0%E7%AC%A6%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<p>æºç ç‰ˆæœ¬ï¼š<a href="https://opensource.apple.com/tarballs/objc4/objc4-781.tar.gz">objc4-781</a></p>
<h3 id="0-weak-ä¿®é¥°ç¬¦çš„ä½œç”¨"><a href="#0-weak-ä¿®é¥°ç¬¦çš„ä½œç”¨" class="headerlink" title="0.weak ä¿®é¥°ç¬¦çš„ä½œç”¨"></a>0.weak ä¿®é¥°ç¬¦çš„ä½œç”¨</h3><p>ä¹‹å‰çš„æ–‡ç« æåˆ°è¿‡ <code>__weak</code> ä¿®é¥°ç¬¦ä½œç”¨ï¼š</p>
<p>1.å½“æˆ‘ä»¬å°†ä¸€ä¸ªå¯¹è±¡èµ‹å€¼ç»™ä¸€ä¸ª <code>__weak</code> ä¿®é¥°ç¬¦çš„æŒ‡é’ˆå˜é‡æ—¶ï¼Œç¼–è¯‘å™¨ä¼šæ’å…¥ <code>objc_initWeak</code> æˆ– <code>objc_storeWeak</code> å‡½æ•°å°†è¯¥å¼±æŒ‡é’ˆå˜é‡ä»æ—§å¯¹è±¡çš„weakè¡¨å‰”é™¤ï¼ˆå¦‚æœä¹‹å‰æœ‰æŒ‡å‘å¯¹è±¡çš„è¯ï¼‰å¹¶æ³¨å†Œåˆ°æ–°å¯¹è±¡çš„weakè¡¨é‡Œï¼Œç„¶åå°†å¼±æŒ‡é’ˆæŒ‡å‘æ–°å¯¹è±¡ã€‚</p>
<p>2.å½“ä½¿ç”¨é™„æœ‰ <code>__weak</code> ä¿®é¥°ç¬¦çš„å˜é‡æ—¶ï¼Œç¼–è¯‘å™¨ä¼šåœ¨ä½¿ç”¨å‰æ’å…¥ <code>objc_loadWeakRetained</code> å‡½æ•°å°†å¯¹è±¡å¼•ç”¨è®¡æ•°+1ï¼Œä¿è¯å¯¹è±¡åœ¨åé¢çš„ä½¿ç”¨è¿‡ç¨‹ä¸­ä¸è¢«é‡Šæ”¾ã€‚å¹¶åœ¨ä½¿ç”¨åæ’å…¥ <code>objc_release(tmp1);</code> é‡Šæ”¾å¯¹è±¡ã€‚</p>
<p>3.å½“å¼±å¼•ç”¨æŒ‡é’ˆå˜é‡è¶…å‡ºä½œç”¨åŸŸè¢«åºŸå¼ƒæ—¶ï¼Œç¼–è¯‘å™¨ä¼šæ’å…¥ <code>objc_destroyWeak</code> å°†è¯¥æŒ‡é’ˆå˜é‡ä»weakè¡¨é‡Œç§»é™¤ã€‚</p>
<p>4.å½“å¯¹è±¡é”€æ¯æ—¶ï¼Œweakè¡¨ä¸­å¯¹è±¡çš„æ‰€æœ‰å¼±å¼•ç”¨æŒ‡é’ˆå˜é‡ä¼šè¢«èµ‹å€¼ä¸ºnilï¼Œé¿å…äº†é‡æŒ‡é’ˆå´©æºƒã€‚æ¯”å¦‚å¯¹nilå¯¹è±¡å‘é€æ¶ˆæ¯ä¸ä¼šæœ‰ä»»ä½•ååº”ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœæ˜¯å¯¹nilè¿›è¡Œè§£å¼•ç”¨è¿˜æ˜¯ä¼šå´©æºƒçš„ã€‚</p>
<p>è¿™äº›åŠŸèƒ½æ˜¯assignæ‰€ä¸å…·å¤‡çš„ï¼Œassignå”¯ä¸€ä¸weakç›¸åŒçš„åœ°æ–¹å°±æ˜¯ä¸ä¼šå¯¼è‡´å¯¹è±¡çš„å¼•ç”¨è®¡æ•°+1ã€‚</p>
<p>noteï¼šweak åªèƒ½ç”¨äºä¿®é¥°å¯¹è±¡ç±»å‹ã€‚å¹¶ä¸”åªèƒ½ç”¨äºiOS5åŠä»¥ä¸Šï¼Œåœ¨iOS4å¯ä»¥ä½¿ç”¨ <code>__unsafe_unretained</code> ä»£æ›¿.å¦å¤–weakåœ¨MRCä¸‹ä¹Ÿæ˜¯æœ‰æ•ˆæœçš„ï¼Œä¸è¿‡éœ€è¦è®¾ç½® <code>Weak References in Manual Retain Release</code> ä¸º YESã€‚</p>
<p>ä»Šå¤©å°±æ¥çœ‹ä¸€ä¸‹weakçš„ä¸Šè¿°åŠŸèƒ½æ˜¯å¦‚ä½•å®ç°çš„ï¼Œåœ¨çœ‹æºç ä¹‹å‰ï¼Œå¯ä»¥å¸¦ç€ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚ï¼š</p>
<p>1.ä½¿ç”¨weakåä¸ºå•¥å¯¹è±¡å°±ä¸ä¼šè¢«retainï¼Ÿ</p>
<p>2.ä¸ºäº†å®ç°å¯¹è±¡é”€æ¯æ—¶æ‰€æœ‰æŒ‡å‘å®ƒçš„å¼±å¼•ç”¨æŒ‡é’ˆå˜é‡å°†è¢«èµ‹å€¼ä¸ºnilã€‚ä½ æ˜¯ä¸æ˜¯å¾—ç™»è®°ä¿å­˜ä¸€ä¸‹è¿™äº›å¼±å¼•ç”¨æŒ‡é’ˆå˜é‡çš„åœ°å€ï¼Ÿæºç åˆæ˜¯å®šä¹‰äº†å“ªäº›æ•°æ®ç»“æ„å®Œæˆçš„ã€‚</p>
<p>3.ä¸€ä¸ª <code>__weak</code> æŒ‡é’ˆå˜é‡å¦‚æœä¹‹å‰æŒ‡å‘äº†Aï¼Œåé¢æ”¹ä¸ºæŒ‡å‘Bï¼Œä½ æ˜¯ä¸æ˜¯å¾—æŠŠä¹‹å‰ç™»è®°çš„ç»™åˆ é™¤ï¼ˆä¸åˆ é™¤çš„è¯ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼‰ï¼Œç„¶åç™»è®°åˆ°æ–°çš„å¯¹è±¡ä¸‹ï¼Œè¿™é‡Œå°±æ¶‰åŠåˆ°æŸ¥æ‰¾ï¼Œæºç ä¸ºäº†æé«˜æŸ¥æ‰¾æ•ˆç‡åˆæ˜¯å¦‚ä½•ä¼˜åŒ–çš„ã€‚</p>
<h3 id="1-objc-initWeak"><a href="#1-objc-initWeak" class="headerlink" title="1.objc_initWeak"></a>1.objc_initWeak</h3><p>å¯¹å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="variable language_">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    XQPerson *p = [XQPerson new];</span><br><span class="line">    </span><br><span class="line">    __<span class="keyword">weak</span> XQPerson *wp = p;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;hello:%@&quot;</span>, wp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>__weak XQPerson *wp = p;</code>è¿™ä¸€è¡Œæ‰“å¥½æ–­ç‚¹ã€‚</p>
<p>è¿è¡Œåå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/weak%E6%96%AD%E7%82%B9.jpg" style="zoom:50%;" /></p>
<p>ç»™æŒ‡é’ˆå˜é‡æ·»åŠ __weakä¿®é¥°ç¬¦åï¼Œç³»ç»Ÿä¼šè°ƒç”¨ä¸€ä¸ªobjc_initWeakçš„å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">id</span><br><span class="line"><span class="title function_">objc_initWeak</span><span class="params">(id *location, id newObj)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!newObj) &#123;</span><br><span class="line">        *location = nil;</span><br><span class="line">        <span class="keyword">return</span> nil;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> storeWeak&lt;DontHaveOld, DoHaveNew, DoCrashIfDeallocating&gt;</span><br><span class="line">        (location, (objc_object*)newObj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥å‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°ï¼š</p>
<p>locationï¼šåŒé‡æŒ‡é’ˆå˜é‡ï¼Œå¯¹è±¡æŒ‡é’ˆçš„æŒ‡é’ˆã€‚</p>
<p>newObjï¼šæŒ‡é’ˆå˜é‡ï¼ŒæŒ‡å‘ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒçš„å€¼æ˜¯å¯¹è±¡çš„åœ°å€ã€‚</p>
<p>å½“ä¼ å…¥çš„newObjç­‰äºnilæ—¶ï¼Œå°†å¯¹è±¡æŒ‡é’ˆå˜é‡ç½®ä¸ºnilã€‚åœ¨ä¸Šè¿°ç¤ºä¾‹ä»£ç ä¸­<code>*location = nil;</code>å°±ç›¸å½“äº<code>wp = nil;</code>ã€‚</p>
<p>æ¥ä¸‹æ¥å¯ä»¥çœ‹ä¸‹å¦‚æœæ˜¯å°†pèµ‹å€¼ç»™ä¸€ä¸ª__strongç±»å‹çš„æŒ‡é’ˆå˜é‡ä¼šå‘ç”Ÿä»€ä¹ˆï¼š</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight fsharp"><table><tr><td class="code"><pre><span class="line"><span class="operator">-</span> (<span class="keyword">void</span>)<span class="keyword">viewDidLoad</span> &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line"></span><br><span class="line">    XQModel <span class="operator">*</span>model <span class="operator">=</span> [XQModel <span class="keyword">new</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">id</span> tmp <span class="operator">=</span> model;</span><br><span class="line">    </span><br><span class="line">    NSLog(<span class="string">@&quot;tmp:%@&quot;</span>, model);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰“å¥½æ–­ç‚¹åè¿è¡Œï¼Œä¼šçœ‹åˆ°å¦‚ä¸‹æ±‡ç¼–ä»£ç ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/strong%E6%B1%87%E7%BC%96.png" style="zoom:50%;" /></p>
<p>å¯ä»¥çœ‹åˆ°å¦‚æœæ˜¯å°†modelèµ‹å€¼ç»™ä¸€ä¸ª <code>__strong</code> ç±»å‹çš„æŒ‡é’ˆå˜é‡ï¼Œç³»ç»Ÿä¼šè°ƒç”¨åˆ°<code>objc_retain</code>å‡½æ•°ï¼Œå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å°±ä¼šåŠ 1ã€‚</p>
<p>ç¨å¾®æ€»ç»“ä¸€ä¸‹ï¼š</p>
<p>ä½¿ç”¨ <code>__weak</code> ä¿®é¥°ç¬¦æ—¶ï¼Œç³»ç»Ÿä¼šè°ƒç”¨objc_initWeakå‡½æ•°è€Œæ²¡æœ‰è°ƒç”¨ç±»ä¼¼<code>objc_retain</code>è¿™æ ·çš„å‡½æ•°ï¼Œå› æ­¤å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸ä¼šå‘ç”Ÿæ”¹å˜ã€‚</p>
<p>ä½¿ç”¨ <code>__strong</code> ä¿®é¥°ç¬¦æ—¶ï¼Œç³»ç»Ÿä¼šè°ƒç”¨<code>objc_retain</code>å‡½æ•°ï¼Œå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¼šåŠ 1ã€‚</p>
<p>åœ¨ç»§ç»­ weak çš„å®ç°åŸç†ä¹‹å‰ï¼Œéœ€è¦åŒºåˆ†<strong>æŒ‡å‘å¯¹è±¡çš„æŒ‡é’ˆå˜é‡</strong>å’Œ<strong>å¯¹è±¡</strong>ä¹‹é—´çš„å…³ç³»ï¼š</p>
<p>æŒ‡å‘å¯¹è±¡çš„æŒ‡é’ˆå˜é‡æ˜¯ä¸€ä¸ªå˜é‡ï¼Œå®ƒçš„å€¼æ˜¯ä¸€ä¸ªåœ°å€ï¼Œè¿™ä¸ªåœ°å€æŒ‡å‘æŸä¸€æ®µå†…å­˜ç©ºé—´ã€‚åœ¨ä¸Šè¿°ä»£ç ä¸­æŒ‡é’ˆå˜é‡ wp æ˜¯åˆ†é…åœ¨æ ˆä¸Šçš„ï¼Œè€Œ wpæŒ‡å‘çš„å¯¹è±¡æ˜¯åˆ†é…åœ¨å †ä¸Šçš„ã€‚</p>
<p>å¯¹è±¡ï¼šåˆ†é…åœ¨å †ä¸Šçš„ä¸€æ®µå†…å­˜ç©ºé—´ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæŒ‡é’ˆå˜é‡æ¥å¼•ç”¨å®ƒï¼Œæ‰å¯ä»¥æ‰¾åˆ°å¹¶è®¿é—®è¿™ä¸ªå¯¹è±¡ã€‚</p>
<p>å®ƒä»¬ä¹‹é—´çš„å…³ç³»ç±»ä¼¼äºäººå’Œäººåä¹‹é—´çš„å…³ç³»ï¼Œä½ å¯ä»¥é€šè¿‡äººåæ‰¾åˆ°è¿™ä¸ªäººï¼Œä½†äººåä¸ç­‰äºäººã€‚</p>
<p>åç»­å®ç° weak çš„æ•°æ®ç»“æ„é‡Œé¢è¦ä¿å­˜çš„å‡ ä¸ªå…³é”®ä¿¡æ¯ä¸­å°±åŒ…å«æŒ‡é’ˆå˜é‡çš„å€¼ï¼ˆå³å¯¹è±¡çš„åœ°å€ï¼‰å’ŒæŒ‡é’ˆå˜é‡çš„åœ°å€ã€‚åœ¨ç¤ºä¾‹ä»£ç ä¸­å°±æ˜¯ä¿å­˜ wp çš„å€¼å’Œ wpè‡ªèº«çš„åœ°å€ã€‚</p>
<p>ä¸ºä»€ä¹ˆéœ€è¦ä¿å­˜æŒ‡é’ˆå˜é‡çš„åœ°å€å‘¢ï¼Ÿå› ä¸º weak ä¿®é¥°ç¬¦çš„åŠŸèƒ½ä¹‹ä¸€å°±æ˜¯å½“å¯¹è±¡é”€æ¯æ—¶å°†æ‰€æœ‰æŒ‡å‘å®ƒçš„å¼±å¼•ç”¨æŒ‡é’ˆå˜é‡èµ‹å€¼ä¸ºnilã€‚å½“ä¿å­˜äº†è¿™äº›æŒ‡é’ˆå˜é‡çš„åœ°å€æˆ‘ä»¬å°±å¯ä»¥å¾ˆæ–¹ä¾¿çš„å°†è¿™äº›æŒ‡é’ˆå˜é‡èµ‹å€¼ä¸º nil ï¼Œè€Œåœ¨è¿™ä¸ªè¯­å¢ƒä¸‹ä¸å¤ªå¯èƒ½é€šè¿‡æŒ‡é’ˆå˜é‡åæ¥å°†å…¶ç½®ä¸º nilã€‚</p>
<p>ä¸ºäº†å®ç°weak ä¿®é¥°ç¬¦çš„åŠŸèƒ½ï¼Œæºç ä¸­å®šä¹‰äº†ä¸€ç³»åˆ—çš„æ•°æ®ç»“æ„ã€‚åªæœ‰å……åˆ†ç†è§£äº†è¦å¹²å˜›ï¼Œåœ¨çœ‹æºç æ—¶æ‰æ›´æœ‰ä½“ä¼šã€‚</p>
<h3 id="2-æ•°æ®ç»“æ„"><a href="#2-æ•°æ®ç»“æ„" class="headerlink" title="2.æ•°æ®ç»“æ„"></a>2.æ•°æ®ç»“æ„</h3><p>åœ¨ä»‹ç» weak çš„å®ç°å‰ï¼Œæœ‰ä¸€äº›ç›¸å…³çš„æ•°æ®ç»“æ„éœ€è¦è¯´æ˜ä¸€ä¸‹ï¼š</p>
<h4 id="StripedMap"><a href="#StripedMap" class="headerlink" title="StripedMap"></a>StripedMap</h4><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum</span> &#123; CacheLineSize = <span class="number">64</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StripedMap&lt;T&gt; is a map of void* -&gt; T, sized appropriately </span></span><br><span class="line"><span class="comment">// for cache-friendly lock striping. </span></span><br><span class="line"><span class="comment">// For example, this may be used as StripedMap&lt;spinlock_t&gt;</span></span><br><span class="line"><span class="comment">// or as StripedMap&lt;SomeStruct&gt; where SomeStruct stores a spin lock.</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StripedMap</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> TARGET_OS_IPHONE &amp;&amp; !TARGET_OS_SIMULATOR</span></span><br><span class="line">    <span class="keyword">enum</span> &#123; StripeCount = <span class="number">8</span> &#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="keyword">enum</span> &#123; StripeCount = <span class="number">64</span> &#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">PaddedT</span> &#123;</span><br><span class="line">        <span class="function">T value <span class="title">alignas</span><span class="params">(CacheLineSize)</span></span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    PaddedT array[StripeCount];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">int</span> <span class="title">indexForPointer</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *p)</span> </span>&#123;</span><br><span class="line">        <span class="type">uintptr_t</span> addr = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uintptr_t</span>&gt;(p);</span><br><span class="line">        <span class="keyword">return</span> ((addr &gt;&gt; <span class="number">4</span>) ^ (addr &gt;&gt; <span class="number">9</span>)) % StripeCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">    T&amp; <span class="keyword">operator</span>[] (<span class="type">const</span> <span class="type">void</span> *p) &#123; </span><br><span class="line">        <span class="keyword">return</span> array[<span class="built_in">indexForPointer</span>(p)].value; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> T&amp; <span class="keyword">operator</span>[] (<span class="type">const</span> <span class="type">void</span> *p) <span class="type">const</span> &#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">const_cast</span>&lt;StripedMap&lt;T&gt;&gt;(<span class="keyword">this</span>)[p]; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Shortcuts for StripedMaps of locks.</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">lockAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; StripeCount; i++) &#123;</span><br><span class="line">            array[i].value.<span class="built_in">lock</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">unlockAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; StripeCount; i++) &#123;</span><br><span class="line">            array[i].value.<span class="built_in">unlock</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">forceResetAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; StripeCount; i++) &#123;</span><br><span class="line">            array[i].value.forceReset();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">defineLockOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">1</span>; i &lt; StripeCount; i++) &#123;</span><br><span class="line">            <span class="built_in">lockdebug_lock_precedes_lock</span>(&amp;array[i<span class="number">-1</span>].value, &amp;array[i].value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">precedeLock</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *newlock)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// assumes defineLockOrder is also called</span></span><br><span class="line">        <span class="built_in">lockdebug_lock_precedes_lock</span>(&amp;array[StripeCount<span class="number">-1</span>].value, newlock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">succeedLock</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *oldlock)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// assumes defineLockOrder is also called</span></span><br><span class="line">        <span class="built_in">lockdebug_lock_precedes_lock</span>(oldlock, &amp;array[<span class="number">0</span>].value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">const</span> <span class="type">void</span> *<span class="title">getLock</span><span class="params">(<span class="type">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; StripeCount) <span class="keyword">return</span> &amp;array[i].value;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> nil;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">    <span class="built_in">StripedMap</span>() &#123;</span><br><span class="line">        <span class="comment">// Verify alignment expectations.</span></span><br><span class="line">        <span class="type">uintptr_t</span> base = (<span class="type">uintptr_t</span>)&amp;array[<span class="number">0</span>].value;</span><br><span class="line">        <span class="type">uintptr_t</span> delta = (<span class="type">uintptr_t</span>)&amp;array[<span class="number">1</span>].value - base;</span><br><span class="line">        <span class="built_in">ASSERT</span>(delta % CacheLineSize == <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">ASSERT</span>(base % CacheLineSize == <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="function"><span class="keyword">constexpr</span> <span class="title">StripedMap</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>StripedMap å­—é¢æ„æ€æ˜¯æ¡çº¹mapï¼Œæ˜¯ä¸€ä¸ªå“ˆå¸Œè¡¨æ¨¡æ¿ç±»ï¼Œkey æ˜¯å¯¹è±¡åœ°å€ï¼Œvalue æ˜¯ T ç±»å‹å®ä¾‹ï¼ŒT é‡Œé¢éœ€è¦æœ‰ä¸€æŠŠè‡ªæ—‹é”ã€‚StripedMapé‡Œé¢å®šä¹‰äº†ä¸€ä¸ªé•¿åº¦ä¸º 8æˆ–è€…64çš„æ•°ç»„ï¼Œæ•°ç»„å…ƒç´ æ˜¯T ç±»å‹å®ä¾‹ã€‚</p>
<p>ä¸»è¦çš„ä¸€ä¸ªå‡½æ•°ï¼šå°†ä¸€ä¸ªåœ°å€æ˜ å°„ä¸ºæ•°ç»„çš„ä¸‹æ ‡ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">indexForPointer</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *p)</span> &#123;</span><br><span class="line">    <span class="type">uintptr_t</span> addr = reinterpret_cast&lt;<span class="type">uintptr_t</span>&gt;(p);</span><br><span class="line">    <span class="keyword">return</span> ((addr &gt;&gt; <span class="number">4</span>) ^ (addr &gt;&gt; <span class="number">9</span>)) % StripeCount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="SideTablesMap"><a href="#SideTablesMap" class="headerlink" title="SideTablesMap"></a>SideTablesMap</h4><p>è¾¹è¡¨map</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> objc::ExplicitInit&lt;StripedMap&lt;SideTable&gt;&gt; SideTablesMap;</span><br><span class="line"><span class="function"><span class="type">static</span> StripedMap&lt;SideTable&gt;&amp; <span class="title">SideTables</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> SideTablesMap.<span class="built_in">get</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Type&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExplicitInit</span> &#123;</span><br><span class="line">    <span class="built_in">alignas</span>(Type) <span class="type">uint8_t</span> _storage[<span class="built_in">sizeof</span>(Type)]; <span class="comment">//ExplicitInité‡Œæœ‰ä¸€ä¸ªæ•°ç»„,æ•°ç»„çš„é•¿åº¦æ˜¯sizeof(Type)ï¼Œè€Œsizeof(StripedMap&lt;SideTable&gt;)åœ¨iOSä¸Šç­‰äº512ï¼ˆ8*64ï¼‰ï¼Œmacä¸Šä¸º4096ï¼ˆ64*64ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span>... Ts&gt;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(Ts &amp;&amp;... Args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> (_storage) <span class="built_in">Type</span>(std::forward&lt;Ts&gt;(Args)...);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Type &amp;<span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> *<span class="built_in">reinterpret_cast</span>&lt;Type *&gt;(_storage);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>SideTablesMapæ˜¯ä¸€ä¸ªé™æ€å…¨å±€å˜é‡ï¼Œå®ƒæ˜¯åœ¨arr_initå‡½æ•°ä¸­åˆå§‹åŒ–çš„ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">arr_init</span><span class="params">(<span class="type">void</span>)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AutoreleasePoolPage::<span class="built_in">init</span>();</span><br><span class="line">    SideTablesMap.<span class="built_in">init</span>();</span><br><span class="line">    _objc_associations_init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€Œarr_initå‡½æ•°æ˜¯åœ¨map_images_nolockä¸­è¢«è°ƒç”¨çš„ï¼Œmap_images_nolockåˆæ˜¯åœ¨map_imagesä¸­è¢«è°ƒç”¨çš„ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> </span></span><br><span class="line"><span class="function"><span class="title">map_images_nolock</span><span class="params">(<span class="type">unsigned</span> mhCount, <span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> mhPaths[],</span></span></span><br><span class="line"><span class="params"><span class="function">                  <span class="type">const</span> <span class="keyword">struct</span> mach_header * <span class="type">const</span> mhdrs[])</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="type">void</span> <span class="title">map_images</span><span class="params">(<span class="type">unsigned</span> count, <span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> paths[],</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="type">const</span> <span class="keyword">struct</span> mach_header * <span class="type">const</span> mhdrs[])</span></span>;</span><br></pre></td></tr></table></figure>
<p>ç®€è€Œè¨€ä¹‹ï¼Œåœ¨ runtime å¯åŠ¨æ—¶ä¼šåˆå§‹åŒ–ä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± AutoreleasePoolPageï¼Œä¸€ä¸ªé™æ€å…¨å±€å˜é‡SideTablesMapï¼Œä¸€ä¸ªå…³è”å¯¹è±¡ç®¡ç†å™¨AssociationsManagerï¼ˆä¿å­˜ç±»åˆ«ä¸­å…³è”çš„å®ä¾‹å˜é‡ï¼‰ã€‚</p>
<p>SideTablesMapçš„ç±»å‹ä¸º <code>ExplicitInit&lt;StripedMap&lt;SideTable&gt;&gt;</code> ï¼ŒC++çš„ç±»ä¹Ÿæ²¡æ€ä¹ˆçœ‹æ‡‚ï¼Œå¤§è‡´å¯ä»¥æŠŠSideTablesMapç†è§£ä¸ºä¸€ä¸ªå…¨å±€çš„hashæ•°ç»„ï¼Œæ•°ç»„é•¿åº¦ä¸º8ï¼ˆiPhone ï¼‰æˆ–64ï¼ˆMacï¼‰ï¼Œé‡Œé¢å­˜å‚¨çš„æ˜¯SideTableï¼Œå› æ­¤SideTableä¸æ­¢ä¸€ä¸ªã€‚</p>
<p>æºç é‡Œä¸€èˆ¬é€šè¿‡ <code>&amp;SideTables()</code> è·å–ä¸€ä¸ªSideTable</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line">static StripedMap&lt;SideTable&gt;&amp; <span class="built_in">SideTables</span>() &#123;</span><br><span class="line">    return SideTablesMap<span class="selector-class">.get</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¯”å¦‚ï¼š<code>SideTable *newTable = &amp;SideTables()[newObj];</code></p>
<p>é€šè¿‡å°†ä¼ å…¥çš„å¯¹è±¡åœ°å€æ˜ å°„ä¸ºæ•°ç»„indexï¼Œç„¶åä»æ•°ç»„ä¸­å–å‡ºå¯¹åº”çš„SideTableã€‚</p>
<h4 id="SideTable"><a href="#SideTable" class="headerlink" title="SideTable"></a>SideTable</h4><p>è¾¹è¡¨</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">SideTable</span> &#123;</span><br><span class="line">    <span class="type">spinlock_t</span> slock;</span><br><span class="line">    RefcountMap refcnts;</span><br><span class="line">    <span class="type">weak_table_t</span> weak_table;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SideTable</span>() &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;weak_table, <span class="number">0</span>, <span class="built_in">sizeof</span>(weak_table));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">SideTable</span>() &#123;</span><br><span class="line">        _objc_fatal(<span class="string">&quot;Do not delete SideTable.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123; slock.<span class="built_in">lock</span>(); &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123; slock.<span class="built_in">unlock</span>(); &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">forceReset</span><span class="params">()</span> </span>&#123; slock.forceReset(); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Address-ordered lock discipline for a pair of side tables.</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;HaveOld, HaveNew&gt;</span></span><br><span class="line"><span class="function">    <span class="type">static</span> <span class="type">void</span> <span class="title">lockTwo</span><span class="params">(SideTable *lock1, SideTable *lock2)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;HaveOld, HaveNew&gt;</span></span><br><span class="line"><span class="function">    <span class="type">static</span> <span class="type">void</span> <span class="title">unlockTwo</span><span class="params">(SideTable *lock1, SideTable *lock2)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>slockï¼šè‡ªæ—‹é”</p>
<p>refcntsï¼šå¼•ç”¨è®¡æ•°è¡¨ã€‚<strong>å“ˆå¸Œè¡¨</strong></p>
<p>weak_tableï¼šå¼±å¼•ç”¨è¡¨ã€‚é‡Œé¢æœ‰ä¸€ä¸ªæˆå‘˜å˜é‡æŒ‡å‘ä¸€ä¸ªå“ˆå¸Œè¡¨</p>
<p>RefcountMapæ˜¯ä¸€ä¸ªç±»å‹åˆ«åï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// RefcountMap disguises its pointers because we </span></span><br><span class="line"><span class="comment">// don&#x27;t want the table to act as a root for `leaks`.</span></span><br><span class="line"><span class="keyword">typedef</span> objc::DenseMap&lt;DisguisedPtr&lt;objc_object&gt;,<span class="type">size_t</span>,RefcountMapValuePurgeable&gt; RefcountMap;</span><br></pre></td></tr></table></figure>
<h4 id="DisguisedPtr"><a href="#DisguisedPtr" class="headerlink" title="DisguisedPtr"></a>DisguisedPtr</h4><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// DisguisedPtr&lt;T&gt; acts like pointer type T*, except the </span></span><br><span class="line"><span class="comment">// stored value is disguised to hide it from tools like `leaks`.</span></span><br><span class="line"><span class="comment">// nil is disguised as itself so zero-filled memory works as expected, </span></span><br><span class="line"><span class="comment">// which means 0x80..00 is also disguised as itself but we don&#x27;t care.</span></span><br><span class="line"><span class="comment">// Note that weak_entry_t knows about this encoding.</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DisguisedPtr</span> &#123;</span><br><span class="line">    <span class="type">uintptr_t</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">uintptr_t</span> <span class="title">disguise</span><span class="params">(T* ptr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> -(<span class="type">uintptr_t</span>)ptr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">static</span> T* <span class="title">undisguise</span><span class="params">(<span class="type">uintptr_t</span> val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (T*)-val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">DisguisedPtr</span>() &#123; &#125;</span><br><span class="line">    <span class="built_in">DisguisedPtr</span>(T* ptr) </span><br><span class="line">        : <span class="built_in">value</span>(<span class="built_in">disguise</span>(ptr)) &#123; &#125;</span><br><span class="line">    <span class="built_in">DisguisedPtr</span>(<span class="type">const</span> DisguisedPtr&lt;T&gt;&amp; ptr) </span><br><span class="line">        : <span class="built_in">value</span>(ptr.value) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    DisguisedPtr&lt;T&gt;&amp; <span class="keyword">operator</span> = (T* rhs) &#123;</span><br><span class="line">        value = <span class="built_in">disguise</span>(rhs);</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DisguisedPtr&lt;T&gt;&amp; <span class="keyword">operator</span> = (<span class="type">const</span> DisguisedPtr&lt;T&gt;&amp; rhs) &#123;</span><br><span class="line">        value = rhs.value;</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">operator</span> T* () <span class="type">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">undisguise</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line">    T* <span class="keyword">operator</span> -&gt; () <span class="type">const</span> &#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">undisguise</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line">    T&amp; <span class="keyword">operator</span> * () <span class="type">const</span> &#123; </span><br><span class="line">        <span class="keyword">return</span> *<span class="built_in">undisguise</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line">    T&amp; <span class="keyword">operator</span> [] (<span class="type">size_t</span> i) <span class="type">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">undisguise</span>(value)[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// pointer arithmetic operators omitted </span></span><br><span class="line">    <span class="comment">// because we don&#x27;t currently use them anywhere</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æŒ‡é’ˆä¼ªè£…æ¨¡æ¿ç±»ï¼Œ<code>DisguisedPtr&lt;T&gt;</code>çš„ä½œç”¨ç±»ä¼¼äº<code>T *</code>ï¼Œä½†ä¸æ˜¯çœŸæ­£çš„<code>T *</code>ï¼Œå®ƒé‡Œé¢åªæœ‰ä¸€ä¸ªæ— ç¬¦å·æ•´å‹å±æ€§valueï¼Œå¹¶æ²¡æœ‰ä¸€ä¸ªçœŸçš„æŒ‡é’ˆæˆå‘˜<code>T *</code>ã€‚ç†è®ºä¸Š value çš„å€¼ä¿å­˜è¢«å¼•ç”¨å¯¹è±¡çš„åœ°å€å°±å¯ä»¥äº†ï¼Œæœ‰äº†å¯¹è±¡çš„åœ°å€åˆæœ‰å¯¹è±¡çš„ç±»å‹ï¼ŒDisguisedPtrçš„åŠŸèƒ½å·²ç»ç±»ä¼¼äºä¸€ä¸ªæŒ‡é’ˆå˜é‡<code>T *</code>äº†ã€‚</p>
<p>ä½†æ˜¯DisguisedPtrå¹¶æ²¡æœ‰ç›´æ¥ä¿å­˜è¢«å¼•ç”¨å¯¹è±¡çš„åœ°å€ï¼Œè€Œæ˜¯å°†å…¶å–è´Ÿåå†å¼ºè½¬ä¸ºæ— ç¬¦å·æ•´æ•°ã€‚è¿™ä¹ˆåšçš„ç›®çš„å°±æ˜¯è®©ç±»ä¼¼äºleaksè¿™æ ·çš„å·¥å…·æ£€æµ‹ä¸åˆ°æœ‰è¿™ä¹ˆä¸ªä¸œè¥¿ä¹Ÿä¿å­˜äº†å¯¹è±¡çš„åœ°å€ã€‚</p>
<p>DisguisedPträ¸­çš„ä¸¤ä¸ªé‡è¦æ–¹æ³•ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ä¼ªè£…å¯¹è±¡çš„åœ°å€</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">uintptr_t</span> <span class="title">disguise</span><span class="params">(T* ptr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> -(<span class="type">uintptr_t</span>)ptr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è§£ä¼ªè£…å¯¹è±¡çš„åœ°å€</span></span><br><span class="line"><span class="function"><span class="type">static</span> T* <span class="title">undisguise</span><span class="params">(<span class="type">uintptr_t</span> val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (T*)-val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="weak-entry-t"><a href="#weak-entry-t" class="headerlink" title="weak_entry_t"></a>weak_entry_t</h4><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// The address of a __weak variable.</span></span><br><span class="line"><span class="comment">// These pointers are stored disguised so memory analysis tools</span></span><br><span class="line"><span class="comment">// don&#x27;t see lots of interior pointers from the weak table into objects.</span></span><br><span class="line"><span class="keyword">typedef</span> DisguisedPtr&lt;objc_object *&gt; <span class="type">weak_referrer_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __LP64__</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTR_MINUS_2 62</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTR_MINUS_2 30</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The internal structure stored in the weak references table. </span></span><br><span class="line"><span class="comment"> * It maintains and stores</span></span><br><span class="line"><span class="comment"> * a hash set of weak references pointing to an object.</span></span><br><span class="line"><span class="comment"> * If out_of_line_ness != REFERRERS_OUT_OF_LINE then the set</span></span><br><span class="line"><span class="comment"> * is instead a small inline array.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEAK_INLINE_COUNT 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// out_of_line_ness field overlaps with the low two bits of inline_referrers[1].</span></span><br><span class="line"><span class="comment">// inline_referrers[1] is a DisguisedPtr of a pointer-aligned address.</span></span><br><span class="line"><span class="comment">// The low two bits of a pointer-aligned DisguisedPtr will always be 0b00</span></span><br><span class="line"><span class="comment">// (disguised nil or 0x80..00) or 0b11 (any other address).</span></span><br><span class="line"><span class="comment">// Therefore out_of_line_ness == 0b10 is used to mark the out-of-line state.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REFERRERS_OUT_OF_LINE 2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">weak_entry_t</span> &#123;</span><br><span class="line">    DisguisedPtr&lt;objc_object&gt; referent;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            <span class="type">weak_referrer_t</span> *referrers; <span class="comment">//å“ˆå¸Œè¡¨ï¼ŒåŠ¨æ€æ•°ç»„</span></span><br><span class="line">            <span class="type">uintptr_t</span>        out_of_line_ness : <span class="number">2</span>; </span><br><span class="line">            <span class="type">uintptr_t</span>        num_refs : PTR_MINUS_2;</span><br><span class="line">            <span class="type">uintptr_t</span>        mask;</span><br><span class="line">            <span class="type">uintptr_t</span>        max_hash_displacement;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            <span class="comment">// out_of_line_ness field is low bits of inline_referrers[1]</span></span><br><span class="line">            <span class="type">weak_referrer_t</span>  inline_referrers[WEAK_INLINE_COUNT]; <span class="comment">//æ™®é€šæ•°ç»„ï¼Œå¯ä»¥å­˜å‚¨4ä¸ªå…ƒç´ ï¼Œå¼±å¼•ç”¨&lt;=4æ—¶ä¿å­˜åœ¨è¿™é‡Œã€‚èµ·åˆ°ä¼˜åŒ–ä½œç”¨ã€‚</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">out_of_line</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (out_of_line_ness == REFERRERS_OUT_OF_LINE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">weak_entry_t</span>&amp; <span class="keyword">operator</span>=(<span class="type">const</span> <span class="type">weak_entry_t</span>&amp; other) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(<span class="keyword">this</span>, &amp;other, <span class="built_in">sizeof</span>(other));</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">weak_entry_t</span>(objc_object *newReferent, objc_object **newReferrer)</span><br><span class="line">        : <span class="built_in">referent</span>(newReferent)</span><br><span class="line">    &#123;</span><br><span class="line">        inline_referrers[<span class="number">0</span>] = newReferrer;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; WEAK_INLINE_COUNT; i++) &#123;</span><br><span class="line">            inline_referrers[i] = nil;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>weak_entry_t ä¸»è¦ä¿å­˜äº†è¢«å¼•ç”¨å¯¹è±¡è‡ªèº«ä»¥åŠæŒ‡å‘å®ƒçš„æ‰€æœ‰å¼±å¼•ç”¨æŒ‡é’ˆå˜é‡çš„åœ°å€ã€‚weak entryå®ä½“è‡ªèº«è¢«ä¿å­˜åœ¨weakè¡¨ä¸­ã€‚</p>
<p>referentï¼šç”¨äºä¿å­˜å¯¹è±¡çš„åœ°å€ï¼ŒDisguisedPtr<objc_object>ç±»å‹ï¼Œæ•ˆæœç±»ä¼¼äºobjc_object <em>ä½†å¹¶ä¸æ˜¯çœŸæ­£çš„objc_object </em>ç±»å‹ã€‚</p>
<p>æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ªè”åˆï¼Œä¸»è¦ç”¨äºä¿å­˜è¯¥å¯¹è±¡çš„æ‰€æœ‰å¼±å¼•ç”¨æŒ‡é’ˆå˜é‡çš„åœ°å€ã€‚ä½¿ç”¨è”åˆä¸»è¦æ˜¯ä¸ºäº†ä¼˜åŒ–å­˜å‚¨ã€‚</p>
<p>å¦‚æœå¼±å¼•ç”¨ä¸ªæ•°&lt;=4ï¼Œåˆ™ä½¿ç”¨inline_referrerså›ºå®šæ•°ç»„ä¿å­˜ã€‚ </p>
<p>å¦‚æœå¼±å¼•ç”¨ä¸ªæ•°&gt;4ï¼Œåˆ™ä½¿ç”¨åŠ¨æ€æ•°ç»„weak_referrer_t *referrersã€‚referrerså…¶å®æ˜¯ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œå­˜å‚¨åœ¨é‡Œé¢çš„å¼±å¼•ç”¨æŒ‡é’ˆå˜é‡çš„åœ°å€å¹¶ä¸æ˜¯æŒ‰é¡ºåºä¾æ¬¡æ’åˆ—çš„ï¼Œè€Œæ˜¯å°†å¼±å¼•ç”¨æŒ‡é’ˆå˜é‡çš„åœ°å€æ˜ å°„ä¸ºä¸€ä¸ª indexï¼Œç„¶åå­˜å‚¨åœ¨ index ä¸Šï¼Œè¿™æ ·åšçš„å¥½å¤„å°±æ˜¯å¯ä»¥å¿«é€ŸæŸ¥æ‰¾å‡ºå®ƒåœ¨referrersä¸­çš„ä½ç½®ï¼Œå¦åˆ™åªèƒ½éå†æ•´ä¸ªæ•°ç»„ã€‚è¿™é‡Œå°±æ˜¯æºç ä¸ºäº†æé«˜æŸ¥æ‰¾æ•ˆç‡åšçš„ä¼˜åŒ–ã€‚</p>
<p>out_of_line_nessï¼šæ˜¯å¦ä½¿ç”¨åŠ¨æ€hashæ•°ç»„æ ‡è®°ä½</p>
<p>num_refsï¼šhashæ•°ç»„referrersä¸­çš„å…ƒç´ ä¸ªæ•°</p>
<p>maskï¼šhashæ•°ç»„é•¿åº¦-1ã€‚ï¼ˆæ³¨æ„ï¼Œè¿™é‡Œæ˜¯hashæ•°ç»„çš„é•¿åº¦ï¼Œè€Œä¸æ˜¯å…ƒç´ ä¸ªæ•°ã€‚æ¯”å¦‚ï¼Œæ•°ç»„é•¿åº¦å¯èƒ½æ˜¯64ï¼Œè€Œå…ƒç´ ä¸ªæ•°ä»…å­˜äº†2ä¸ªï¼‰ã€‚</p>
<p>max_hash_displacementï¼šå¯èƒ½ä¼šå‘ç”Ÿçš„hashå†²çªçš„æœ€å¤§æ¬¡æ•°ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦å‡ºç°äº†é€»è¾‘é”™è¯¯ï¼ˆhashè¡¨ä¸­çš„å†²çªæ¬¡æ•°ç»ä¸ä¼šè¶…è¿‡è¯¥å€¼ï¼‰</p>
<h4 id="weak-table-t"><a href="#weak-table-t" class="headerlink" title="weak_table_t"></a>weak_table_t</h4><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The global weak references table. Stores object ids as keys,</span></span><br><span class="line"><span class="comment"> * and weak_entry_t structs as their values.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">weak_table_t</span> &#123;</span><br><span class="line">    <span class="type">weak_entry_t</span> *weak_entries; <span class="comment">//å“ˆå¸Œè¡¨ï¼Œå®¹é‡ä¸å¤Ÿäº†ä¼šæ‰©å®¹</span></span><br><span class="line">    <span class="type">size_t</span>    num_entries;</span><br><span class="line">    <span class="type">uintptr_t</span> mask;</span><br><span class="line">    <span class="type">uintptr_t</span> max_hash_displacement;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>weak_table_t weakè¡¨ï¼Œæ˜¯ä¸€ä¸ªå…¨å±€çš„å¼±å¼•ç”¨è¡¨ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå“ˆå¸Œè¡¨ã€‚è¢«å¼•ç”¨çš„å¯¹è±¡çš„åœ°å€ä½œä¸ºkeyï¼Œweak_entry_tç»“æ„ä½“ä½œä¸ºå€¼ã€‚</p>
<p>weak_entriesï¼š æŒ‡é’ˆå˜é‡ï¼ŒæŒ‡å‘ä¸€ä¸ªhashæ•°ç»„ï¼Œæ•°ç»„é‡Œå­˜å‚¨å¼±å¼•ç”¨å¯¹è±¡çš„ç›¸å…³ä¿¡æ¯weak_entry_tã€‚åˆå§‹æ—¶ä¸ºNULLï¼Œç¬¬ä¸€æ¬¡æ’å…¥æ—¶æ‰ä¼šåˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º64çš„æ•°ç»„å¹¶ç”¨weak_entriesæŒ‡å‘è¯¥æ•°ç»„ï¼Œç›¸å½“äºæ‡’åŠ è½½ã€‚å¦‚æœäº‹å…ˆåˆ†é…ä¸€ä¸ªé•¿åº¦ä¸º64çš„æ•°ç»„ï¼Œæ˜¾ç„¶æ˜¯ä¸å¿…è¦çš„ï¼Œå› ä¸ºæœ‰å¯èƒ½æ²¡æœ‰åœ°æ–¹ä½¿ç”¨åˆ°weakæŒ‡é’ˆã€‚</p>
<p>num_entriesï¼š hashæ•°ç»„ä¸­çš„å…ƒç´ ä¸ªæ•°</p>
<p>maskï¼šhashæ•°ç»„é•¿åº¦-1ï¼ˆæ³¨æ„ï¼Œè¿™é‡Œæ˜¯hashæ•°ç»„çš„é•¿åº¦ï¼Œè€Œä¸æ˜¯å…ƒç´ ä¸ªæ•°ã€‚æ¯”å¦‚ï¼Œæ•°ç»„é•¿åº¦å¯èƒ½æ˜¯64ï¼Œè€Œå…ƒç´ ä¸ªæ•°ä»…å­˜äº†2ä¸ªï¼‰    </p>
<p>max_hash_displacementï¼šå¯èƒ½ä¼šå‘ç”Ÿçš„hashå†²çªçš„æœ€å¤§æ¬¡æ•°ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦å‡ºç°äº†é€»è¾‘é”™è¯¯ï¼ˆhashè¡¨ä¸­çš„å†²çªæ¬¡æ•°ç»ä¸ä¼šè¶…è¿‡è¯¥å€¼ï¼‰</p>
<p>psï¼šåœ¨C++é‡Œé¢weak_entry_tå°±ç›¸å½“äºstruct weak_entry_tå¯ä»¥çœç•¥structï¼Œåœ¨Cä¸­è‚¯å®šæ˜¯æ²¡æœ‰è¿™æ ·çš„è¯­æ³•çš„ï¼Œæˆ‘è¯´æ€ä¹ˆçœ‹èµ·æ¥è¿™ä¹ˆå¥‡æ€ªã€‚</p>
<h3 id="3-weakçš„å®ç°"><a href="#3-weakçš„å®ç°" class="headerlink" title="3.weakçš„å®ç°"></a>3.weakçš„å®ç°</h3><h4 id="objc-initWeak"><a href="#objc-initWeak" class="headerlink" title="objc_initWeak"></a>objc_initWeak</h4><p>å‰é¢å·²ç»çŸ¥é“ï¼Œä½¿ç”¨__weakä¿®é¥°ç¬¦æ—¶ï¼Œç³»ç»Ÿå…¶å®æ˜¯è°ƒç”¨äº†objc_initWeakå‡½æ•°ï¼Œæœ¬èŠ‚å°±åˆ†æä¸€ä¸‹objc_initWeakçš„å…·ä½“å®ç°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">id</span></span><br><span class="line"><span class="function"><span class="title">objc_initWeak</span><span class="params">(id *location, id newObj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!newObj) &#123;</span><br><span class="line">        *location = nil;</span><br><span class="line">        <span class="keyword">return</span> nil;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">storeWeak</span>&lt;DontHaveOld, DoHaveNew, DoCrashIfDeallocating&gt;</span><br><span class="line">        (location, (objc_object*)newObj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>locationçš„å€¼å°±æ˜¯å¯¹è±¡æŒ‡é’ˆå˜é‡çš„åœ°å€ï¼Œ<code>*location</code> æŒ‡å‘æ—§å¯¹è±¡ï¼ŒnewObjæŒ‡å‘æ–°å¯¹è±¡ã€‚åé¢çš„å¤§éƒ¨åˆ†æ“ä½œéƒ½å’Œè¿™ä¸‰ä¸ªå€¼æœ‰å…³ã€‚</p>
<h4 id="storeweak"><a href="#storeweak" class="headerlink" title="storeweak"></a>storeweak</h4><p>objc_initWeakä¸»è¦è°ƒç”¨äº†storeweakå‡½æ•°ï¼Œå®ƒçš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> id </span></span><br><span class="line"><span class="function"><span class="title">storeWeak</span><span class="params">(id *location, objc_object *newObj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">ASSERT</span>(haveOld  ||  haveNew);</span><br><span class="line">    <span class="keyword">if</span> (!haveNew) <span class="built_in">ASSERT</span>(newObj == nil);</span><br><span class="line"></span><br><span class="line">    Class previouslyInitializedClass = nil;</span><br><span class="line">    id oldObj;</span><br><span class="line">    SideTable *oldTable;</span><br><span class="line">    SideTable *newTable;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Acquire locks for old and new values.</span></span><br><span class="line">    <span class="comment">// Order by lock address to prevent lock ordering problems. </span></span><br><span class="line">    <span class="comment">// Retry if the old value changes underneath us.</span></span><br><span class="line"> retry:</span><br><span class="line">    <span class="keyword">if</span> (haveOld) &#123;</span><br><span class="line">        oldObj = *location;</span><br><span class="line">        oldTable = &amp;<span class="built_in">SideTables</span>()[oldObj]; <span class="comment">//ä»SideTablesMapå“ˆå¸Œè¡¨ä¸­è·å–æ—§å¯¹è±¡çš„SideTable</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        oldTable = nil;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (haveNew) &#123;</span><br><span class="line">        newTable = &amp;<span class="built_in">SideTables</span>()[newObj]; <span class="comment">//ä»SideTablesMapå“ˆå¸Œè¡¨ä¸­è·å–æ–°å¯¹è±¡çš„SideTable</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        newTable = nil;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SideTable::<span class="built_in">lockTwo</span>&lt;haveOld, haveNew&gt;(oldTable, newTable);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (haveOld  &amp;&amp;  *location != oldObj) &#123;</span><br><span class="line">        SideTable::<span class="built_in">unlockTwo</span>&lt;haveOld, haveNew&gt;(oldTable, newTable);</span><br><span class="line">        <span class="keyword">goto</span> retry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prevent a deadlock between the weak reference machinery</span></span><br><span class="line">    <span class="comment">// and the +initialize machinery by ensuring that no </span></span><br><span class="line">    <span class="comment">// weakly-referenced object has an un-+initialized isa.</span></span><br><span class="line">    <span class="keyword">if</span> (haveNew  &amp;&amp;  newObj) &#123;</span><br><span class="line">        Class cls = newObj-&gt;<span class="built_in">getIsa</span>();</span><br><span class="line">        <span class="keyword">if</span> (cls != previouslyInitializedClass  &amp;&amp;  </span><br><span class="line">            !((objc_class *)cls)-&gt;<span class="built_in">isInitialized</span>()) </span><br><span class="line">        &#123;</span><br><span class="line">            SideTable::<span class="built_in">unlockTwo</span>&lt;haveOld, haveNew&gt;(oldTable, newTable);</span><br><span class="line">            <span class="built_in">class_initialize</span>(cls, (id)newObj);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If this class is finished with +initialize then we&#x27;re good.</span></span><br><span class="line">            <span class="comment">// If this class is still running +initialize on this thread </span></span><br><span class="line">            <span class="comment">// (i.e. +initialize called storeWeak on an instance of itself)</span></span><br><span class="line">            <span class="comment">// then we may proceed but it will appear initializing and </span></span><br><span class="line">            <span class="comment">// not yet initialized to the check above.</span></span><br><span class="line">            <span class="comment">// Instead set previouslyInitializedClass to recognize it on retry.</span></span><br><span class="line">            previouslyInitializedClass = cls;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> retry;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clean up old value, if any.</span></span><br><span class="line">    <span class="keyword">if</span> (haveOld) &#123;</span><br><span class="line">        <span class="built_in">weak_unregister_no_lock</span>(&amp;oldTable-&gt;weak_table, oldObj, location);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Assign new value, if any.</span></span><br><span class="line">    <span class="keyword">if</span> (haveNew) &#123;</span><br><span class="line">        newObj = (objc_object *)</span><br><span class="line">            <span class="built_in">weak_register_no_lock</span>(&amp;newTable-&gt;weak_table, (id)newObj, location, </span><br><span class="line">                                  crashIfDeallocating);</span><br><span class="line">        <span class="comment">// weak_register_no_lock returns nil if weak store should be rejected</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set is-weakly-referenced bit in refcount table.</span></span><br><span class="line">        <span class="keyword">if</span> (newObj  &amp;&amp;  !newObj-&gt;<span class="built_in">isTaggedPointer</span>()) &#123;</span><br><span class="line">            newObj-&gt;<span class="built_in">setWeaklyReferenced_nolock</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do not set *location anywhere else. That would introduce a race.</span></span><br><span class="line">        *location = (id)newObj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// No new value. The storage is not changed.</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SideTable::<span class="built_in">unlockTwo</span>&lt;haveOld, haveNew&gt;(oldTable, newTable);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (id)newObj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">static</span> objc::ExplicitInit&lt;StripedMap&lt;SideTable&gt;&gt; SideTablesMap;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> StripedMap&lt;SideTable&gt;&amp; <span class="title">SideTables</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> SideTablesMap.<span class="built_in">get</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>storeWeakçš„ä½œç”¨å¤§è‡´å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ ¹æ®æ—§å¯¹è±¡çš„åœ°å€ä»SideTablesMapä¸­æ‰¾åˆ°æ—§SideTableï¼Œæ ¹æ®æ–°å¯¹è±¡çš„åœ°å€ä»SideTablesMapä¸­æ‰¾åˆ°æ–°SideTable</li>
<li>åŠ é”ï¼Œé”ä¸Šæ–°æ—§SideTableã€‚å› ä¸ºåé¢è¦æ“ä½œè¡¨é‡Œé¢çš„ä¸œè¥¿äº†ï¼Œä¿è¯åŒä¸€æ—¶åˆ»åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹æ“ä½œè¯¥è¡¨ã€‚</li>
<li>unregisterï¼Œä»æ—§çš„è¡¨ä¸­ç§»é™¤å½“å‰æŒ‡é’ˆå˜é‡åœ°å€ã€‚</li>
<li>registerï¼Œåœ¨æ–°çš„è¡¨ä¸­ç™»è®°å½“å‰æŒ‡é’ˆå˜é‡åœ°å€ã€‚</li>
<li>å°†å¯¹è±¡çš„<code>weakly_referenced</code>æ ‡å¿—ä½ç½®ä¸º trueï¼Œè¯´æ˜è¯¥å¯¹è±¡æ˜¯æœ‰å¼±å¼•ç”¨æŒ‡é’ˆçš„ï¼Œé”€æ¯æ—¶éœ€è¦å°†å®ƒä»¬ç½®ä¸º nil å¹¶ç§»é™¤ã€‚å®Œæˆåå°†æŒ‡é’ˆå˜é‡çš„å€¼æŒ‡å‘æ–°å¯¹è±¡ã€‚</li>
<li>è§£é”SideTable</li>
</ol>
<p>å¦å¤–ï¼Œunregisteræˆ–registeræ—¶å¯èƒ½ä¼šè¿›è¡Œweakè¡¨çš„å‡å®¹æˆ–æ‰©å®¹ã€‚</p>
<p>è¿™é‡Œé¢ä¸»è¦çš„ä¸¤ä¸ªå‡½æ•°å°±æ˜¯weak_unregister_no_lockå’Œweak_register_no_lockäº†ã€‚</p>
<h4 id="weak-register-no-lock"><a href="#weak-register-no-lock" class="headerlink" title="weak_register_no_lock"></a>weak_register_no_lock</h4><p>å…ˆæ¥çœ‹weak_register_no_lock:</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Registers a new (object, weak pointer) pair. Creates a new weak</span></span><br><span class="line"><span class="comment"> * object entry if it does not exist.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param weak_table The global weak table.</span></span><br><span class="line"><span class="comment"> * @param referent The object pointed to by the weak reference.</span></span><br><span class="line"><span class="comment"> * @param referrer The weak pointer address.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">id</span> </span><br><span class="line">weak_register_no_lock(weak_table_t *weak_table, <span class="type">id</span> referent_id, </span><br><span class="line">                      <span class="type">id</span> *referrer_id, <span class="type">bool</span> crashIfDeallocating)</span><br><span class="line">&#123;</span><br><span class="line">    objc_object *referent = (objc_object *)referent_id;</span><br><span class="line">    objc_object **referrer = (objc_object **)referrer_id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!referent  ||  referent-&gt;isTaggedPointer()) <span class="keyword">return</span> referent_id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ensure that the referenced object is viable</span></span><br><span class="line">    <span class="type">bool</span> deallocating;</span><br><span class="line">    <span class="keyword">if</span> (!referent-&gt;ISA()-&gt;hasCustomRR()) &#123;</span><br><span class="line">        deallocating = referent-&gt;rootIsDeallocating();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">BOOL</span> (*allowsWeakReference)(objc_object *, SEL) = </span><br><span class="line">            (<span class="type">BOOL</span>(*)(objc_object *, SEL))</span><br><span class="line">            object_getMethodImplementation((<span class="type">id</span>)referent, </span><br><span class="line">                                           <span class="keyword">@selector</span>(allowsWeakReference));</span><br><span class="line">        <span class="keyword">if</span> ((IMP)allowsWeakReference == _objc_msgForward) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        deallocating =</span><br><span class="line">            ! (*allowsWeakReference)(referent, <span class="keyword">@selector</span>(allowsWeakReference));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (deallocating) &#123;</span><br><span class="line">        <span class="keyword">if</span> (crashIfDeallocating) &#123;</span><br><span class="line">            _objc_fatal(<span class="string">&quot;Cannot form weak reference to instance (%p) of &quot;</span></span><br><span class="line">                        <span class="string">&quot;class %s. It is possible that this object was &quot;</span></span><br><span class="line">                        <span class="string">&quot;over-released, or is in the process of deallocation.&quot;</span>,</span><br><span class="line">                        (<span class="type">void</span>*)referent, object_getClassName((<span class="type">id</span>)referent));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// now remember it and where it is being stored</span></span><br><span class="line">    weak_entry_t *entry;</span><br><span class="line">    <span class="keyword">if</span> ((entry = weak_entry_for_referent(weak_table, referent))) &#123;</span><br><span class="line">        append_referrer(entry, referrer);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        weak_entry_t new_entry(referent, referrer);</span><br><span class="line">        weak_grow_maybe(weak_table);</span><br><span class="line">        weak_entry_insert(weak_table, &amp;new_entry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do not set *referrer. objc_storeWeak() requires that the </span></span><br><span class="line">    <span class="comment">// value not change.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> referent_id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¤§æ¦‚è¿‡ç¨‹ï¼š</p>
<ol>
<li>æ ¹æ®å¯¹è±¡çš„åœ°å€ä»weak_tableä¸­æ‰¾åˆ°weak_entry_tï¼ŒæŠŠæŒ‡é’ˆå˜é‡çš„åœ°å€ä¿å­˜åˆ°weak_entry_té‡Œçš„æ•°ç»„ä¸­ã€‚</li>
<li>å¦‚æœåœ¨weak_tableæ²¡æœ‰æ‰¾åˆ°è¯¥å¯¹è±¡çš„weak_entry_tï¼Œåˆ™æ–°åˆ›å»ºä¸€ä¸ªweak_entry_tå¹¶æŠŠæŒ‡é’ˆå˜é‡çš„åœ°å€ä¿å­˜åˆ°weak_entry_té‡Œçš„æ•°ç»„ä¸­ï¼Œæ‰©å®¹weak_tableï¼ˆif neededï¼‰,å°†æ–°åˆ›å»ºçš„weak_entry_tæ’å…¥åˆ°weak_tableä¸­</li>
</ol>
<p>æ­£å¸¸ä¿å­˜ä¹‹å‰ä¼šæœ‰ä¸€äº›åˆ¤æ–­ï¼Œä¼šåˆ¤æ–­å½“å‰å¯¹è±¡æ˜¯å¦æ­£åœ¨é”€æ¯ï¼Œå¦‚æœæ­£åœ¨é”€æ¯åˆ™æ ¹æ®crashIfDeallocatingå†³å®šæ˜¯å´©æºƒè¿˜æ˜¯è¿”å› nilï¼Œå¦‚æœæ˜¯è¿”å› nilï¼Œåˆ™æŒ‡é’ˆå˜é‡å°±è¢«èµ‹å€¼ä¸ºnil äº†ã€‚å¯¹äº objc_initWeak å’Œ objc_storeWeakå‡½æ•°æ¥è¯´ä¼ å…¥çš„éƒ½æ˜¯DoCrashIfDeallocatingï¼Œå› æ­¤<strong>ä¸è¦åœ¨å¯¹è±¡çš„ dealloc æ–¹æ³•é‡Œå†å»å¼±å¼•ç”¨å®ƒ</strong>ã€‚æ¯”å¦‚ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)dealloc &#123;</span><br><span class="line">    <span class="type">id</span> __<span class="keyword">weak</span> obj = <span class="keyword">self</span>; <span class="comment">//å®é™…ä»£ç å½“ç„¶ä¸ä¼šè¿™ä¹ˆæ˜æ˜¾ï¼Œæ¯”è¾ƒéšè”½çš„ä¸€ç§æƒ…å†µæ˜¯æ‡’åŠ è½½çš„viewè®¾ç½®delegateä¸ºself</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å´©æºƒï¼š</p>
<figure class="highlight smali"><table><tr><td class="code"><pre><span class="line">objc[70479]: Cannot form weak reference to<span class="built_in"> instance </span>(0x600001778540) of class ARCPerson. It is possible that this object was over-released,<span class="built_in"> or </span>is in the process of deallocation.</span><br></pre></td></tr></table></figure>
<p>weak_register_no_locké‡Œé¢è°ƒç”¨äº†å¾ˆå¤šå‡½æ•°ï¼Œä¸è¿‡éƒ½æ˜¯å“ˆå¸Œè¡¨çš„æ“ä½œï¼Œä¸€ä¸ªä¸ªçœ‹ã€‚</p>
<h5 id="weak-entry-for-referent"><a href="#weak-entry-for-referent" class="headerlink" title="weak_entry_for_referent"></a>weak_entry_for_referent</h5><p>weak_entry_for_referentï¼šæ ¹æ®å¯¹è±¡çš„åœ°å€ä»weak_tableä¸­æ‰¾åˆ°weak_entry_t</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Return the weak reference table entry for the given referent. </span></span><br><span class="line"><span class="comment"> * If there is no entry for referent, return NULL. </span></span><br><span class="line"><span class="comment"> * Performs a lookup.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param weak_table </span></span><br><span class="line"><span class="comment"> * @param referent The object. Must not be nil.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @return The table of weak referrers to this object. </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> weak_entry_t *</span><br><span class="line">weak_entry_for_referent(weak_table_t *weak_table, objc_object *referent)</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(referent);</span><br><span class="line"></span><br><span class="line">    weak_entry_t *weak_entries = weak_table-&gt;weak_entries;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!weak_entries) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    size_t begin = hash_pointer(referent) &amp; weak_table-&gt;mask;</span><br><span class="line">    size_t index = begin;</span><br><span class="line">    size_t hash_displacement = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (weak_table-&gt;weak_entries[index].referent != referent) &#123;</span><br><span class="line">        index = (index+<span class="number">1</span>) &amp; weak_table-&gt;mask;</span><br><span class="line">        <span class="keyword">if</span> (index == begin) bad_weak_table(weak_table-&gt;weak_entries);</span><br><span class="line">        hash_displacement++;</span><br><span class="line">        <span class="keyword">if</span> (hash_displacement &gt; weak_table-&gt;max_hash_displacement) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &amp;weak_table-&gt;weak_entries[index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿‡ç¨‹ï¼š</p>
<ol>
<li>é¦–å…ˆåˆ¤æ–­weak_table_tçš„æˆå‘˜å˜é‡weak_entriesæ˜¯å¦ä¸ºNULLï¼Œå¦‚æœä¸ºNULLè¯´æ˜éœ€è¦åˆ›å»ºå“ˆå¸Œæ•°ç»„ã€‚</li>
<li>å°†å¯¹è±¡åœ°å€hash åŒ–å¹¶æŒ‰ä½ä¸weak_table-&gt;maskç¡®ä¿ä¸ä¼šæ•°ç»„è¶Šç•Œï¼Œè¿™æ ·å°±å¾—åˆ°ä¸€ä¸ªèµ·å§‹ indexã€‚</li>
<li>hashå†²çªè§£å†³ï¼Œå¦‚æœ index å¤„å·²ç»æœ‰å…ƒç´ ä½†å¹¶ä¸ç­‰äºå½“å‰å¯¹è±¡ï¼Œè¡¨æ˜å­˜åœ¨ hashå†²çªï¼Œåˆ™å’Œ index çš„ä¸‹ä¸€ä¸ªä½ç½®è¿›è¡Œæ¯”è¾ƒã€‚æœŸé—´å¦‚æœåˆæ‰¾åˆ°å¼€å§‹çš„ä½ç½®åˆ™è°ƒç”¨bad_weak_tableå‡½æ•°æŠ›å‡ºå¼‚å¸¸ã€‚å¦‚æœè¶…è¿‡äº†æœ€å¤§å“ˆå¸Œå†²çªmax_hash_displacementåˆ™åœæ­¢æŸ¥æ‰¾ä¹Ÿè¿”å› nilï¼Œè¡¨æ˜å“ˆå¸Œè¡¨å†²çªå¤ªå¤šäº†éœ€è¦æ‰©å®¹äº†ã€‚</li>
</ol>
<p>è¿™é‡Œå¯ä»¥çœ‹ä¸€ä¸‹å¯¹è±¡åœ°å€çš„hash åŒ–ï¼šhash_pointer(referent)ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uintptr_t</span> <span class="title function_">hash_pointer</span><span class="params">(objc_object *key)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ptr_hash((<span class="type">uintptr_t</span>)key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Pointer hash function.</span></span><br><span class="line"><span class="comment">// This is not a terrific hash, but it is fast </span></span><br><span class="line"><span class="comment">// and not outrageously flawed for our purposes.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Based on principles from http://locklessinc.com/articles/fast_hash/</span></span><br><span class="line"><span class="comment">// and evaluation ideas from http://floodyberry.com/noncryptohashzoo/</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __LP64__</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint32_t</span> <span class="title function_">ptr_hash</span><span class="params">(<span class="type">uint64_t</span> key)</span></span><br><span class="line">&#123;</span><br><span class="line">    key ^= key &gt;&gt; <span class="number">4</span>;</span><br><span class="line">    key *= <span class="number">0x8a970be7488fda55</span>;</span><br><span class="line">    key ^= __builtin_bswap64(key);</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">uint32_t</span>)key;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint32_t</span> <span class="title function_">ptr_hash</span><span class="params">(<span class="type">uint32_t</span> key)</span></span><br><span class="line">&#123;</span><br><span class="line">    key ^= key &gt;&gt; <span class="number">4</span>;</span><br><span class="line">    key *= <span class="number">0x5052acdb</span>;</span><br><span class="line">    key ^= __builtin_bswap32(key);</span><br><span class="line">    <span class="keyword">return</span> key;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  Higher-quality hash function. This is measurably slower in some workloads.</span></span><br><span class="line"><span class="comment">#if __LP64__</span></span><br><span class="line"><span class="comment"> uint32_t ptr_hash(uint64_t key)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    key -= __builtin_bswap64(key);</span></span><br><span class="line"><span class="comment">    key *= 0x8a970be7488fda55;</span></span><br><span class="line"><span class="comment">    key ^= __builtin_bswap64(key);</span></span><br><span class="line"><span class="comment">    key *= 0x8a970be7488fda55;</span></span><br><span class="line"><span class="comment">    key ^= __builtin_bswap64(key);</span></span><br><span class="line"><span class="comment">    return (uint32_t)key;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">#else</span></span><br><span class="line"><span class="comment">static uint32_t ptr_hash(uint32_t key)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    key -= __builtin_bswap32(key);</span></span><br><span class="line"><span class="comment">    key *= 0x5052acdb;</span></span><br><span class="line"><span class="comment">    key ^= __builtin_bswap32(key);</span></span><br><span class="line"><span class="comment">    key *= 0x5052acdb;</span></span><br><span class="line"><span class="comment">    key ^= __builtin_bswap32(key);</span></span><br><span class="line"><span class="comment">    return key;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>ç³»ç»Ÿé‡‡ç”¨äº†ä¸€ä¸ªä¸æ˜¯å¾ˆæ£’ä½†æ˜¯é€Ÿåº¦å¾ˆå¿«çš„å“ˆå¸Œå‡½æ•°ï¼Œä¸æ˜¯å¾ˆæ£’è¡¨æ˜è¯¥å“ˆå¸Œå‡½æ•°å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›å“ˆå¸Œå†²çªï¼Œæ•£åˆ—çš„ä¸æ˜¯å¾ˆå‡åŒ€ã€‚åŒæ—¶æ³¨é‡Šé‡Œåˆ—ä¸¾äº†ä¸€ä¸ªé«˜è´¨é‡çš„å“ˆå¸Œå‡½æ•°ï¼Œä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹é€Ÿåº¦æ¯”è¾ƒæ…¢çš„å“ˆå¸Œå‡½æ•°ã€‚å¯ä»¥çœ‹åˆ°ç³»ç»Ÿå¯¹æ•£åˆ—å‡åŒ€ç¨‹åº¦ä¸é€Ÿåº¦ä¹‹é—´çš„æƒè¡¡ã€‚</p>
<h5 id="weak-entry-insert"><a href="#weak-entry-insert" class="headerlink" title="weak_entry_insert"></a>weak_entry_insert</h5><p>weak_entry_insertï¼šå¾€weakè¡¨ä¸­æ’å…¥ä¸€ä¸ªå…ƒç´ weak_entry_t</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">weak_entry_insert</span><span class="params">(<span class="type">weak_table_t</span> *weak_table, <span class="type">weak_entry_t</span> *new_entry)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">weak_entry_t</span> *weak_entries = weak_table-&gt;weak_entries;</span><br><span class="line">    ASSERT(weak_entries != nil);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> begin = hash_pointer(new_entry-&gt;referent) &amp; (weak_table-&gt;mask);</span><br><span class="line">    <span class="type">size_t</span> index = begin;</span><br><span class="line">    <span class="type">size_t</span> hash_displacement = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (weak_entries[index].referent != nil) &#123;</span><br><span class="line">        index = (index+<span class="number">1</span>) &amp; weak_table-&gt;mask;</span><br><span class="line">        <span class="keyword">if</span> (index == begin) bad_weak_table(weak_entries); <span class="comment">//bad_weak_tableå°±æ˜¯æŠ›å‡ºå¼‚å¸¸ã€‚ä¸€èˆ¬ä¸ä¼šåˆ°è¿™é‡Œ</span></span><br><span class="line">        hash_displacement++; <span class="comment">//è®°å½•å†²çªçš„æ¬¡æ•°</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    weak_entries[index] = *new_entry;</span><br><span class="line">    weak_table-&gt;num_entries++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hash_displacement &gt; weak_table-&gt;max_hash_displacement) &#123;</span><br><span class="line">        weak_table-&gt;max_hash_displacement = hash_displacement;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŒæ ·å…ˆå¾—åˆ°ä¸€ä¸ªèµ·å§‹ indexï¼Œå†è¿›è¡Œ hash å†²çªè§£å†³å¹¶è®°å½•å†²çªçš„æ¬¡æ•°ï¼Œç„¶åæ’å…¥åˆ°ç©ºä½ç½®ã€‚æœ€åæ›´æ–°å“ˆå¸Œè¡¨çš„æœ€å¤§å“ˆå¸Œå†²çªå€¼max_hash_displacementã€‚</p>
<h5 id="weak-grow-maybe"><a href="#weak-grow-maybe" class="headerlink" title="weak_grow_maybe"></a>weak_grow_maybe</h5><p>weak_grow_maybeï¼šæ‰©å®¹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Grow the given zone&#x27;s table of weak references if it is full.</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">weak_grow_maybe</span><span class="params">(<span class="type">weak_table_t</span> *weak_table)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> old_size = TABLE_SIZE(weak_table);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Grow if at least 3/4 full.</span></span><br><span class="line">    <span class="keyword">if</span> (weak_table-&gt;num_entries &gt;= old_size * <span class="number">3</span> / <span class="number">4</span>) &#123;</span><br><span class="line">        weak_resize(weak_table, old_size ? old_size*<span class="number">2</span> : <span class="number">64</span>); <span class="comment">//old_sizeä¸º0æ—¶ï¼Œåˆ™é»˜è®¤è®¾ç½®ä¸º64ä¸ªæ§½ã€‚</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾¾åˆ°æœ€å¤§ç©ºé—´çš„3/4æ—¶è¿›è¡Œæ‰©å®¹ã€‚æ‰©å®¹æ—¶æœºï¼šæ’å…¥å…ƒç´ å‰ï¼Œä¼šå…ˆåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ã€‚</p>
<h5 id="append-referrer"><a href="#append-referrer" class="headerlink" title="append_referrer"></a>append_referrer</h5><p>append_referrerï¼šå°†æŒ‡é’ˆå˜é‡åœ°å€æ·»åŠ åˆ°weak_entry_tçš„å“ˆå¸Œè¡¨é‡Œ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Add the given referrer to set of weak pointers in this entry.</span></span><br><span class="line"><span class="comment"> * Does not perform duplicate checking (b/c weak pointers are never</span></span><br><span class="line"><span class="comment"> * added to a set twice). </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param entry The entry holding the set of weak pointers. </span></span><br><span class="line"><span class="comment"> * @param new_referrer The new weak pointer to be added.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">append_referrer</span><span class="params">(<span class="type">weak_entry_t</span> *entry, objc_object **new_referrer)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (! entry-&gt;out_of_line()) &#123;</span><br><span class="line">        <span class="comment">// Try to insert inline.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; WEAK_INLINE_COUNT; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (entry-&gt;inline_referrers[i] == nil) &#123;</span><br><span class="line">                entry-&gt;inline_referrers[i] = new_referrer;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Couldn&#x27;t insert inline. Allocate out of line.</span></span><br><span class="line">        <span class="type">weak_referrer_t</span> *new_referrers = (<span class="type">weak_referrer_t</span> *)</span><br><span class="line">            <span class="built_in">calloc</span>(WEAK_INLINE_COUNT, <span class="keyword">sizeof</span>(<span class="type">weak_referrer_t</span>));</span><br><span class="line">        <span class="comment">// This constructed table is invalid, but grow_refs_and_insert</span></span><br><span class="line">        <span class="comment">// will fix it and rehash it.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; WEAK_INLINE_COUNT; i++) &#123;</span><br><span class="line">            new_referrers[i] = entry-&gt;inline_referrers[i];</span><br><span class="line">        &#125;</span><br><span class="line">        entry-&gt;referrers = new_referrers;</span><br><span class="line">        entry-&gt;num_refs = WEAK_INLINE_COUNT;</span><br><span class="line">        entry-&gt;out_of_line_ness = REFERRERS_OUT_OF_LINE;</span><br><span class="line">        entry-&gt;mask = WEAK_INLINE_COUNT<span class="number">-1</span>;</span><br><span class="line">        entry-&gt;max_hash_displacement = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ASSERT(entry-&gt;out_of_line());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (entry-&gt;num_refs &gt;= TABLE_SIZE(entry) * <span class="number">3</span>/<span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> grow_refs_and_insert(entry, new_referrer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">size_t</span> begin = w_hash_pointer(new_referrer) &amp; (entry-&gt;mask);</span><br><span class="line">    <span class="type">size_t</span> index = begin;</span><br><span class="line">    <span class="type">size_t</span> hash_displacement = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (entry-&gt;referrers[index] != nil) &#123;</span><br><span class="line">        hash_displacement++;</span><br><span class="line">        index = (index+<span class="number">1</span>) &amp; entry-&gt;mask;</span><br><span class="line">        <span class="keyword">if</span> (index == begin) bad_weak_table(entry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (hash_displacement &gt; entry-&gt;max_hash_displacement) &#123;</span><br><span class="line">        entry-&gt;max_hash_displacement = hash_displacement;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">weak_referrer_t</span> &amp;ref = entry-&gt;referrers[index];</span><br><span class="line">    ref = new_referrer;</span><br><span class="line">    entry-&gt;num_refs++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Grow the entry&#x27;s hash table of referrers. Rehashes each</span></span><br><span class="line"><span class="comment"> * of the referrers.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param entry Weak pointer hash set for a particular object.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">__attribute__((noinline, used))</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">grow_refs_and_insert</span><span class="params">(<span class="type">weak_entry_t</span> *entry, </span></span><br><span class="line"><span class="params">                                 objc_object **new_referrer)</span></span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(entry-&gt;out_of_line());</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> old_size = TABLE_SIZE(entry);</span><br><span class="line">    <span class="type">size_t</span> new_size = old_size ? old_size * <span class="number">2</span> : <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> num_refs = entry-&gt;num_refs;</span><br><span class="line">    <span class="type">weak_referrer_t</span> *old_refs = entry-&gt;referrers;</span><br><span class="line">    entry-&gt;mask = new_size - <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    entry-&gt;referrers = (<span class="type">weak_referrer_t</span> *)</span><br><span class="line">        <span class="built_in">calloc</span>(TABLE_SIZE(entry), <span class="keyword">sizeof</span>(<span class="type">weak_referrer_t</span>));</span><br><span class="line">    entry-&gt;num_refs = <span class="number">0</span>;</span><br><span class="line">    entry-&gt;max_hash_displacement = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; old_size &amp;&amp; num_refs &gt; <span class="number">0</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (old_refs[i] != nil) &#123;</span><br><span class="line">            append_referrer(entry, old_refs[i]);</span><br><span class="line">            num_refs--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Insert</span></span><br><span class="line">    append_referrer(entry, new_referrer);</span><br><span class="line">    <span class="keyword">if</span> (old_refs) <span class="built_in">free</span>(old_refs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„è¿™é‡Œçš„å‚æ•°æ˜¯ <code>new_referrer</code> ï¼Œå³æˆ‘ä»¬å°†è¦æŠŠå¯¹è±¡æŒ‡é’ˆå˜é‡çš„åœ°å€æ’å…¥åˆ°entryçš„å“ˆå¸Œè¡¨é‡Œã€‚</p>
<p>è¿™é‡Œä¼šå…ˆåˆ¤æ–­æœ‰æ²¡æœ‰è¶…å‡º <code>out_of_line</code> ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ’å…¥åˆ°ä¸€ä¸ªæ™®é€šæ•°ç»„ï¼Œå¦åˆ™æ’å…¥åˆ°ä¸€ä¸ªå“ˆå¸Œæ•°ç»„é‡Œã€‚</p>
<p>ä¸Šé¢æ˜¯ <code>weak_register_no_lock</code> çš„æ•´ä¸ªé€»è¾‘ã€‚ä¸‹é¢çœ‹ä¸€ä¸‹ <code>weak_unregister_no_lock</code> ã€‚</p>
<h4 id="weak-unregister-no-lock"><a href="#weak-unregister-no-lock" class="headerlink" title="weak_unregister_no_lock"></a>weak_unregister_no_lock</h4><p>weak_unregister_no_lockï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">weak_unregister_no_lock</span><span class="params">(<span class="type">weak_table_t</span> *weak_table, id referent_id, </span></span><br><span class="line"><span class="params">                        id *referrer_id)</span></span><br><span class="line">&#123;</span><br><span class="line">    objc_object *referent = (objc_object *)referent_id;</span><br><span class="line">    objc_object **referrer = (objc_object **)referrer_id;</span><br><span class="line"></span><br><span class="line">    <span class="type">weak_entry_t</span> *entry;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!referent) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((entry = weak_entry_for_referent(weak_table, referent))) &#123;</span><br><span class="line">        remove_referrer(entry, referrer);</span><br><span class="line">        <span class="type">bool</span> empty = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (entry-&gt;out_of_line()  &amp;&amp;  entry-&gt;num_refs != <span class="number">0</span>) &#123;</span><br><span class="line">            empty = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; WEAK_INLINE_COUNT; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (entry-&gt;inline_referrers[i]) &#123;</span><br><span class="line">                    empty = <span class="literal">false</span>; </span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (empty) &#123;</span><br><span class="line">            weak_entry_remove(weak_table, entry);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do not set *referrer = nil. objc_storeWeak() requires that the </span></span><br><span class="line">    <span class="comment">// value not change.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿‡ç¨‹ï¼š</p>
<ol>
<li>æ‰¾åˆ°weak_entry</li>
<li>è°ƒç”¨remove_referrerç§»é™¤æŒ‡é’ˆå˜é‡åœ°å€</li>
<li>åˆ¤æ–­weak_entryæ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™ä»weak_tableä¸­å°†weak_entryä¹Ÿç§»é™¤ã€‚weak_tableå‡å®¹å¦‚æœå¯èƒ½ã€‚</li>
</ol>
<p>è¿™é‡Œä¸»è¦æ˜¯remove_referrerå’Œweak_entry_removeçš„è°ƒç”¨ã€‚</p>
<h5 id="remove-referrer"><a href="#remove-referrer" class="headerlink" title="remove_referrer"></a>remove_referrer</h5><p>remove_referrerï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Remove old_referrer from set of referrers, if it&#x27;s present.</span></span><br><span class="line"><span class="comment"> * Does not remove duplicates, because duplicates should not exist. </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @todo this is slow if old_referrer is not present. Is this ever the case? </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param entry The entry holding the referrers.</span></span><br><span class="line"><span class="comment"> * @param old_referrer The referrer to remove. </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">remove_referrer</span><span class="params">(<span class="type">weak_entry_t</span> *entry, objc_object **old_referrer)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (! entry-&gt;out_of_line()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; WEAK_INLINE_COUNT; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (entry-&gt;inline_referrers[i] == old_referrer) &#123;</span><br><span class="line">                entry-&gt;inline_referrers[i] = nil;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        _objc_inform(<span class="string">&quot;Attempted to unregister unknown __weak variable &quot;</span></span><br><span class="line">                     <span class="string">&quot;at %p. This is probably incorrect use of &quot;</span></span><br><span class="line">                     <span class="string">&quot;objc_storeWeak() and objc_loadWeak(). &quot;</span></span><br><span class="line">                     <span class="string">&quot;Break on objc_weak_error to debug.\n&quot;</span>, </span><br><span class="line">                     old_referrer);</span><br><span class="line">        objc_weak_error();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> begin = w_hash_pointer(old_referrer) &amp; (entry-&gt;mask);</span><br><span class="line">    <span class="type">size_t</span> index = begin;</span><br><span class="line">    <span class="type">size_t</span> hash_displacement = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (entry-&gt;referrers[index] != old_referrer) &#123;</span><br><span class="line">        index = (index+<span class="number">1</span>) &amp; entry-&gt;mask;</span><br><span class="line">        <span class="keyword">if</span> (index == begin) bad_weak_table(entry);</span><br><span class="line">        hash_displacement++;</span><br><span class="line">        <span class="keyword">if</span> (hash_displacement &gt; entry-&gt;max_hash_displacement) &#123;</span><br><span class="line">            _objc_inform(<span class="string">&quot;Attempted to unregister unknown __weak variable &quot;</span></span><br><span class="line">                         <span class="string">&quot;at %p. This is probably incorrect use of &quot;</span></span><br><span class="line">                         <span class="string">&quot;objc_storeWeak() and objc_loadWeak(). &quot;</span></span><br><span class="line">                         <span class="string">&quot;Break on objc_weak_error to debug.\n&quot;</span>, </span><br><span class="line">                         old_referrer);</span><br><span class="line">            objc_weak_error();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    entry-&gt;referrers[index] = nil;</span><br><span class="line">    entry-&gt;num_refs--;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç å¾ˆå¤šï¼Œä½†é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯æ‰¾åˆ°old_referrerè¿™ä¸ªå…ƒç´ çš„ä½ç½®ï¼Œç„¶åå°†è¿™ä¸ªä½ç½®çš„å†…å®¹ç½®ä¸º nilã€‚æ³¨æ„è¿™é‡Œå¹¶æ²¡æœ‰å°†å¼±å¼•ç”¨æŒ‡é’ˆç½®ä½nilã€‚</p>
<h5 id="weak-entry-remove"><a href="#weak-entry-remove" class="headerlink" title="weak_entry_remove"></a>weak_entry_remove</h5><p>weak_entry_removeï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Remove entry from the zone&#x27;s table of weak references.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">weak_entry_remove</span><span class="params">(<span class="type">weak_table_t</span> *weak_table, <span class="type">weak_entry_t</span> *entry)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// remove entry</span></span><br><span class="line">    <span class="keyword">if</span> (entry-&gt;out_of_line()) <span class="built_in">free</span>(entry-&gt;referrers);</span><br><span class="line">    bzero(entry, <span class="keyword">sizeof</span>(*entry));</span><br><span class="line"></span><br><span class="line">    weak_table-&gt;num_entries--;</span><br><span class="line"></span><br><span class="line">    weak_compact_maybe(weak_table);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Shrink the table if it is mostly empty.</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">weak_compact_maybe</span><span class="params">(<span class="type">weak_table_t</span> *weak_table)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> old_size = TABLE_SIZE(weak_table);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Shrink if larger than 1024 buckets and at most 1/16 full.</span></span><br><span class="line">    <span class="keyword">if</span> (old_size &gt;= <span class="number">1024</span>  &amp;&amp; old_size / <span class="number">16</span> &gt;= weak_table-&gt;num_entries) &#123;</span><br><span class="line">        weak_resize(weak_table, old_size / <span class="number">8</span>);</span><br><span class="line">        <span class="comment">// leaves new table no more than 1/2 full</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿‡ç¨‹ï¼š</p>
<ol>
<li>å¦‚æœweak_entry_tä½¿ç”¨çš„æ˜¯å“ˆå¸Œæ•°ç»„åˆ™é‡Šæ”¾å“ˆå¸Œæ•°ç»„å†…å­˜</li>
<li>å°†weak_entry_tè‡ªèº«çš„å†…å­˜æ¸…é›¶ï¼Œè¿™æ ·weak_table_tä¸­å°±è…¾å‡ºæ¥ä¸€ä¸ªå¯ç”¨çš„ä½ç½®</li>
<li>å°†num_entrieså‡ 1ï¼Œå³weak_table_tå…ƒç´ ä¸ªæ•°å‡ 1</li>
<li>å¦‚æœweakè¡¨é‡Œé¢å…ƒç´ ä¸ªæ•°å°äºæŸä¸ªå€¼æ—¶ï¼Œåˆ™å°†weak_table_tè¿›è¡Œå‡å®¹</li>
</ol>
<p>å‡å®¹å’Œæ‰©å®¹éƒ½ä¼šè°ƒç”¨weak_resizeï¼š</p>
<h4 id="weak-resize"><a href="#weak-resize" class="headerlink" title="weak_resize"></a>weak_resize</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">weak_resize</span><span class="params">(<span class="type">weak_table_t</span> *weak_table, <span class="type">size_t</span> new_size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> old_size = TABLE_SIZE(weak_table);</span><br><span class="line"></span><br><span class="line">    <span class="type">weak_entry_t</span> *old_entries = weak_table-&gt;weak_entries;</span><br><span class="line">    <span class="type">weak_entry_t</span> *new_entries = (<span class="type">weak_entry_t</span> *)</span><br><span class="line">        <span class="built_in">calloc</span>(new_size, <span class="keyword">sizeof</span>(<span class="type">weak_entry_t</span>));</span><br><span class="line"></span><br><span class="line">    weak_table-&gt;mask = new_size - <span class="number">1</span>;</span><br><span class="line">    weak_table-&gt;weak_entries = new_entries;</span><br><span class="line">    weak_table-&gt;max_hash_displacement = <span class="number">0</span>;</span><br><span class="line">    weak_table-&gt;num_entries = <span class="number">0</span>;  <span class="comment">// restored by weak_entry_insert below</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (old_entries) &#123;</span><br><span class="line">        <span class="type">weak_entry_t</span> *entry;</span><br><span class="line">        <span class="type">weak_entry_t</span> *end = old_entries + old_size;</span><br><span class="line">        <span class="keyword">for</span> (entry = old_entries; entry &lt; end; entry++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (entry-&gt;referent) &#123;</span><br><span class="line">                weak_entry_insert(weak_table, entry);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">free</span>(old_entries);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿‡ç¨‹ï¼š</p>
<ol>
<li>å¼€è¾Ÿä¸€ä¸ªæ–°çš„é•¿åº¦ä¸ºnew_sizeçš„å†…å­˜ç©ºé—´</li>
<li>å°†æ—§çš„å“ˆå¸Œè¡¨old_entriesé‡Œçš„weak_entry_té‡æ–°æ’å…¥ï¼ˆå…¶å®å°±æ˜¯é‡æ–°æ•£åˆ—ï¼‰åˆ°æ–°çš„new_entriesé‡Œï¼Œæ’å…¥å‰åˆ¤æ–­entry-&gt;referentæ˜¯å¦æœ‰å€¼ã€‚è¿™æ ·å·²ç»æ¸…é›¶çš„å†…å­˜å°±ä¸ä¼šæ’å…¥ã€‚</li>
</ol>
<p>åˆ°æ­¤ä¸ºæ­¢objc_initWeakçš„ä½œç”¨å°±åˆ†æå®Œäº†ã€‚</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯æŸ¥çœ‹å½“å¯¹è±¡é”€æ¯æ—¶ï¼Œå¦‚ä½•å°†æ‰€æœ‰æŒ‡å‘å®ƒçš„å¼±å¼•ç”¨æŒ‡é’ˆå˜é‡èµ‹å€¼ä¸ºnilã€‚</p>
<h4 id="dealloc"><a href="#dealloc" class="headerlink" title="dealloc"></a>dealloc</h4><p>ä¸€ä¸ªå¯¹è±¡é”€æ¯æ—¶ä¼šè°ƒç”¨deallocæ–¹æ³•ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)dealloc &#123; <span class="comment">//NSObjectçš„deallocï¼Œæ‰€ä»¥åœ¨å­ç±»ä¸­éœ€è¦è°ƒç”¨superæ‰ä¼šæ‰§è¡Œå¦‚weakè¡¨çš„æ¸…é™¤ï¼Œå…³è”å¯¹è±¡çš„é‡Šæ”¾ç­‰ã€‚</span></span><br><span class="line">    _objc_rootDealloc(self);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line">_objc_rootDealloc(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">ASSERT</span>(obj);</span><br><span class="line"></span><br><span class="line">    obj-&gt;<span class="built_in">rootDealloc</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span></span></span><br><span class="line"><span class="function"><span class="title">objc_object::rootDealloc</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isTaggedPointer</span>()) <span class="keyword">return</span>;  <span class="comment">// fixme necessary?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fastpath</span>(isa.nonpointer  &amp;&amp;  </span><br><span class="line">                 !isa.weakly_referenced  &amp;&amp;  </span><br><span class="line">                 !isa.has_assoc  &amp;&amp;  </span><br><span class="line">                 !isa.has_cxx_dtor  &amp;&amp;  </span><br><span class="line">                 !isa.has_sidetable_rc))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">assert</span>(!<span class="built_in">sidetable_present</span>());</span><br><span class="line">        <span class="built_in">free</span>(<span class="keyword">this</span>);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">object_dispose</span>((id)<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* object_dispose</span></span><br><span class="line"><span class="comment">* fixme</span></span><br><span class="line"><span class="comment">* Locking: none</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function">id </span></span><br><span class="line"><span class="function"><span class="title">object_dispose</span><span class="params">(id obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!obj) <span class="keyword">return</span> nil;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">objc_destructInstance</span>(obj);    </span><br><span class="line">    <span class="built_in">free</span>(obj);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* objc_destructInstance</span></span><br><span class="line"><span class="comment">* Destroys an instance without freeing memory. </span></span><br><span class="line"><span class="comment">* Calls C++ destructors.</span></span><br><span class="line"><span class="comment">* Calls ARC ivar cleanup.</span></span><br><span class="line"><span class="comment">* Removes associative references.</span></span><br><span class="line"><span class="comment">* Returns `obj`. Does nothing if `obj` is nil.</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">objc_destructInstance</span><span class="params">(id obj)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj) &#123;</span><br><span class="line">        <span class="comment">// Read all of the flags at once for performance.</span></span><br><span class="line">        <span class="type">bool</span> cxx = obj-&gt;<span class="built_in">hasCxxDtor</span>();</span><br><span class="line">        <span class="type">bool</span> assoc = obj-&gt;<span class="built_in">hasAssociatedObjects</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This order is important.</span></span><br><span class="line">        <span class="keyword">if</span> (cxx) <span class="built_in">object_cxxDestruct</span>(obj);</span><br><span class="line">        <span class="keyword">if</span> (assoc) _object_remove_assocations(obj);</span><br><span class="line">        obj-&gt;<span class="built_in">clearDeallocating</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> </span></span><br><span class="line"><span class="function"><span class="title">objc_object::clearDeallocating</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">slowpath</span>(!isa.nonpointer)) &#123;</span><br><span class="line">        <span class="comment">// Slow path for raw pointer isa.</span></span><br><span class="line">        <span class="built_in">sidetable_clearDeallocating</span>(); <span class="comment">//è¿™é‡Œé¢ä¹Ÿæ˜¯æ¸…é™¤weakï¼Œæ¸…é™¤å¼•ç”¨è®¡æ•°</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">slowpath</span>(isa.weakly_referenced  ||  isa.has_sidetable_rc)) &#123;</span><br><span class="line">        <span class="comment">// Slow path for non-pointer isa with weak refs and/or side table data.</span></span><br><span class="line">        <span class="built_in">clearDeallocating_slow</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert</span>(!<span class="built_in">sidetable_present</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>objc_destructInstanceå‡½æ•°ä½œç”¨ï¼š</p>
<p>å¦‚æœæœ‰è‡ªå®šä¹‰çš„C++ææ„æ–¹æ³•ï¼Œåˆ™è°ƒç”¨C++ææ„å‡½æ•°ã€‚å¦‚æœæœ‰å…³è”å¯¹è±¡ï¼Œåˆ™ç§»é™¤å…³è”å¯¹è±¡å¹¶å°†å…¶è‡ªèº«ä»<code>Association Manager</code>çš„mapä¸­ç§»é™¤ã€‚è°ƒç”¨<code>clearDeallocating</code>æ–¹æ³•æ¸…é™¤å¯¹è±¡çš„ç›¸å…³å¼•ç”¨ã€‚</p>
<p>æœ€ç»ˆä¼šè°ƒç”¨clearDeallocating_slowï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Slow path of clearDeallocating() </span></span><br><span class="line"><span class="comment">// for objects with nonpointer isa</span></span><br><span class="line"><span class="comment">// that were ever weakly referenced </span></span><br><span class="line"><span class="comment">// or whose retain count ever overflowed to the side table.</span></span><br><span class="line"><span class="function">NEVER_INLINE <span class="type">void</span></span></span><br><span class="line"><span class="function"><span class="title">objc_object::clearDeallocating_slow</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">ASSERT</span>(isa.nonpointer  &amp;&amp;  (isa.weakly_referenced || isa.has_sidetable_rc));</span><br><span class="line"></span><br><span class="line">    SideTable&amp; table = <span class="built_in">SideTables</span>()[<span class="keyword">this</span>];</span><br><span class="line">    table.<span class="built_in">lock</span>();</span><br><span class="line">    <span class="keyword">if</span> (isa.weakly_referenced) &#123;</span><br><span class="line">        <span class="built_in">weak_clear_no_lock</span>(&amp;table.weak_table, (id)<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isa.has_sidetable_rc) &#123;</span><br><span class="line">        table.refcnts.<span class="built_in">erase</span>(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    table.<span class="built_in">unlock</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>clearDeallocating_slowåœ¨è·å–åˆ°SideTableåä¼šåŠ é”ï¼Œå®Œæˆæ¸…é™¤æ“ä½œåï¼ŒSideTableåˆä¼šé‡Šæ”¾é”ã€‚</p>
<h5 id="weak-clear-no-lock"><a href="#weak-clear-no-lock" class="headerlink" title="weak_clear_no_lock"></a>weak_clear_no_lock</h5><p>æ ¸å¿ƒå‡½æ•°weak_clear_no_lockï¼šå°†æ‰€æœ‰å¼±å¼•ç”¨è¯¥å¯¹è±¡çš„æŒ‡é’ˆå˜é‡çš„å€¼ç½®ä¸º nilï¼Œå¹¶å°†è¯¥ object çš„weak_entry_tä» weak è¡¨ä¸­ç§»é™¤ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Called by dealloc; nils out all weak pointers that point to the </span></span><br><span class="line"><span class="comment"> * provided object so that they can no longer be used.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param weak_table </span></span><br><span class="line"><span class="comment"> * @param referent The object being deallocated. </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> </span></span><br><span class="line"><span class="function"><span class="title">weak_clear_no_lock</span><span class="params">(<span class="type">weak_table_t</span> *weak_table, id referent_id)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    objc_object *referent = (objc_object *)referent_id;</span><br><span class="line"></span><br><span class="line">    <span class="type">weak_entry_t</span> *entry = <span class="built_in">weak_entry_for_referent</span>(weak_table, referent);</span><br><span class="line">    <span class="keyword">if</span> (entry == nil) &#123;</span><br><span class="line">        <span class="comment">/// XXX shouldn&#x27;t happen, but does with mismatched CF/objc</span></span><br><span class="line">        <span class="comment">//printf(&quot;XXX no entry for clear deallocating %p\n&quot;, referent);</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// zero out references</span></span><br><span class="line">    <span class="type">weak_referrer_t</span> *referrers;</span><br><span class="line">    <span class="type">size_t</span> count;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (entry-&gt;<span class="built_in">out_of_line</span>()) &#123;</span><br><span class="line">        referrers = entry-&gt;referrers;</span><br><span class="line">        count = <span class="built_in">TABLE_SIZE</span>(entry);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        referrers = entry-&gt;inline_referrers;</span><br><span class="line">        count = WEAK_INLINE_COUNT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</span><br><span class="line">        objc_object **referrer = referrers[i];</span><br><span class="line">        <span class="keyword">if</span> (referrer) &#123;</span><br><span class="line">            <span class="keyword">if</span> (*referrer == referent) &#123;</span><br><span class="line">                *referrer = nil; <span class="comment">//å¼±å¼•ç”¨æŒ‡é’ˆçš„å€¼è¢«ç½®ä½nil.</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (*referrer) &#123;</span><br><span class="line">                _objc_inform(<span class="string">&quot;__weak variable at %p holds %p instead of %p. &quot;</span></span><br><span class="line">                             <span class="string">&quot;This is probably incorrect use of &quot;</span></span><br><span class="line">                             <span class="string">&quot;objc_storeWeak() and objc_loadWeak(). &quot;</span></span><br><span class="line">                             <span class="string">&quot;Break on objc_weak_error to debug.\n&quot;</span>, </span><br><span class="line">                             referrer, (<span class="type">void</span>*)*referrer, (<span class="type">void</span>*)referent);</span><br><span class="line">                <span class="built_in">objc_weak_error</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">weak_entry_remove</span>(weak_table, entry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-æ€»ç»“"><a href="#4-æ€»ç»“" class="headerlink" title="4.æ€»ç»“"></a>4.æ€»ç»“</h3><p>SideTableç¤ºæ„å›¾</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/E011FE656F40C3CA194795B0CA107AA9.png" alt=""></p>
<p>è®©æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ä¸‹é¢çš„ä»£ç ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">XQPerson *p = XQPerson.new;</span><br><span class="line">__<span class="keyword">weak</span> XQPerson *wp = p;</span><br></pre></td></tr></table></figure>
<p>å¯¹äºä¸Šé¢ç®€å•çš„ä¸€å¥ <code>__weak XQPerson *wp = p;</code> èƒŒåæ‰§è¡Œçš„é€»è¾‘å¯ä¸å°‘ã€‚</p>
<p>é¦–å…ˆä¼šæ ¹æ®æ–°æ—§å¯¹è±¡çš„åœ°å€åˆ†åˆ«ä»SideTablesMapä¸­è·å–åˆ°æ–°æ—§å¯¹è±¡çš„SideTableï¼Œ</p>
<p>ç„¶åå†æ ¹æ®æ—§å¯¹è±¡çš„åœ°å€ä»æ—§å¯¹è±¡çš„SideTableçš„weak è¡¨ä¸­è·å–åˆ°weak entryï¼Œç„¶åä»weak entryçš„referrerså“ˆå¸Œè¡¨ä¸­æŠŠæŒ‡é’ˆå˜é‡ç§»é™¤ï¼Œ</p>
<p>æœ€åå†æ ¹æ®æ–°å¯¹è±¡çš„åœ°å€ä»æ–°å¯¹è±¡çš„SideTableçš„weak è¡¨ä¸­è·å–åˆ°weak entryï¼Œç„¶åå°†å¼±å¼•ç”¨æŒ‡é’ˆå˜é‡ç™»è®°åˆ°weak entryçš„referrerså“ˆå¸Œè¡¨ä¸­ã€‚</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://wangwangok.github.io/2018/05/18/source_code_objc_weak_t/">ç»†çœ‹objc-weakæºç </a></p>
<p><a href="https://juejin.im/post/5e7a322f6fb9a07ca24f79bb">iOSåº•å±‚åŸç†ï¼šweakçš„å®ç°åŸç†</a></p>
<p><a href="https://blog.csdn.net/u013378438/article/details/82790332">Objective-C runtimeæœºåˆ¶(7)â€”â€”SideTables, SideTable, weak_table, weak_entry_t</a></p>
<p>å“ˆå¸Œç®—æ³•ç›¸å…³</p>
<p><a href="https://blog.codinghorror.com/speed-hashing/">Speed Hashing</a></p>
<p><a href="http://blog.itpub.net/31557372/viewspace-2222260/">æ‰«ç›²ï¼Œé‚£äº›è®©äººè›‹ç–¼çš„Hashæ¦‚å¿µ</a></p>
<h3 id="ç–‘é—®"><a href="#ç–‘é—®" class="headerlink" title="ç–‘é—®"></a>ç–‘é—®</h3><p>Q1ï¼šOCå¯¹è±¡çš„å¼•ç”¨è®¡æ•°æ˜¯ä¿å­˜åœ¨å“ªçš„ï¼Ÿï¼ˆå·²å®Œæˆï¼‰</p>
<p>åˆ†æäº†å¥½å‡ å¤©çš„ weak å®ç°ï¼Œçªç„¶æƒ³çŸ¥é“OCå¯¹è±¡çš„å¼•ç”¨è®¡æ•°åˆ°åº•æ˜¯ä¿å­˜åœ¨å“ªçš„ï¼Œäºæ˜¯ä¾¿æœ‰äº†è¿™ä¸ªç–‘é—®ã€‚è¿™ä¸ªé—®é¢˜æ¯”è¾ƒå¤§ï¼Œå¯èƒ½éœ€è¦ä¸€æ•´ç¯‡æ–‡ç« æ‰èƒ½å›ç­”ã€‚</p>
<p>ç®€å•ç‚¹è®²å°±æ˜¯å­˜å‚¨åœ¨SideTableçš„RefcountMapï¼ˆä¹Ÿæ˜¯ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼‰é‡Œï¼Œä¸è¿‡å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯å­˜å‚¨åœ¨å¯¹è±¡çš„isaé‡Œã€‚</p>
<p>å‚è€ƒï¼š</p>
<p><a href="https://juejin.im/post/5b4c59a55188251ac9767872">è‹¹æœiOSç³»ç»Ÿæºç æ€è€ƒï¼šå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿâ€”ä»runtimeæºç å¾—åˆ°çš„å¯ç¤º</a></p>
<p><a href="http://yulingtianxia.com/blog/2015/12/06/The-Principle-of-Refenrence-Counting/">Objective-C å¼•ç”¨è®¡æ•°åŸç†</a></p>
<p><a href="https://juejin.im/post/5ce2b7386fb9a07eff005b4c">ç†è§£ ARC å®ç°åŸç†</a></p>
<p>Q2ï¼šä¸ºä»€ä¹ˆ weak æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Ÿï¼ˆå¾…è§£å†³ï¼‰</p>
<p>æºç é‡Œå¥½äº›weak ç›¸å…³çš„å‡½æ•°éƒ½æ³¨é‡Šç€è¯¥å‡½æ•°æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œå¦‚ï¼šobjc_initWeakï¼Œobjc_destroyWeakã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Destroys the relationship between a weak pointer</span></span><br><span class="line"><span class="comment"> * and the object it is referencing in the internal weak</span></span><br><span class="line"><span class="comment"> * table. If the weak pointer is not referencing anything, </span></span><br><span class="line"><span class="comment"> * there is no need to edit the weak table. </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This function IS NOT thread-safe with respect to concurrent </span></span><br><span class="line"><span class="comment"> * modifications to the weak variable. (Concurrent weak clear is safe.)</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param location The weak pointer address. </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">objc_destroyWeak</span><span class="params">(id *location)</span></span><br><span class="line">&#123;</span><br><span class="line">    (<span class="type">void</span>)storeWeak&lt;DoHaveOld, DontHaveNew, DontCrashIfDeallocating&gt;</span><br><span class="line">        (location, nil);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†æœ¬äººæ²¡é‡åˆ°è¿‡å› ä¸º weak å¯¼è‡´çš„å´©æºƒï¼Œä¹Ÿæ²¡è¯•å‡ºæ¥ï¼Œçœ‹æºç å‘ç°è¯¥åŠ é”çš„åœ°æ–¹ä¹Ÿéƒ½åŠ é”äº†ï¼Œå®åœ¨çœ‹ä¸å‡ºæ¥åˆ°åº•æ˜¯å“ªä¸ªåœ°æ–¹ä¼šå¯¼è‡´çº¿ç¨‹ä¸å®‰å…¨ã€‚</p>
<p>å‚è€ƒ</p>
<p><a href="https://suhou.github.io/2019/05/14/%E4%BB%8E%E4%B8%80%E4%B8%AAcrash%E7%90%86%E8%A7%A3weak%E7%9A%84%E5%BB%B6%E8%BF%9F%E9%87%8A%E6%94%BE/">ä»ä¸€ä¸ªcrashç†è§£weakçš„å»¶è¿Ÿé‡Šæ”¾</a>   ä½œè€…å…¶ä»–æ–‡ç« ä¹Ÿè¿˜ä¸é”™</p>
<p><a href="https://blog.csdn.net/rhythmkay/article/details/86539617">ä¸å®‰å…¨çš„weakå˜é‡</a>  ä¸å®‰å…¨çš„ä¸€ä¸ªä¾‹å­ï¼Œæ²¡æ€ä¹ˆçœ‹æ‡‚</p>
<p><a href="https://debugly.cn/2017/07/17-weakself-in-dealloc-cause-crash.html">åœ¨ dealloc é‡Œä½¿ç”¨ weak self å¼•èµ·å´©æºƒï¼Ÿ</a></p>
<p><a href="https://bugs.swift.org/browse/SR-192">Weak properties are not thread safe when reading</a>  ä¸è¿‡ç³»ç»Ÿå·²ç»è§£å†³äº†ã€‚</p>
<p><a href="https://github.com/apple/swift/pull/1454">[runtime] Thread safety for weak references #1454</a></p>
<p>æŸ¥éäº†Googleéƒ½æ˜¯è¯´å› ä¸ºobjc_loadWeakRetainedçš„é—®é¢˜å¯¼è‡´çš„å¤šçº¿ç¨‹ä¸‹è¿‡åº¦é‡Šæ”¾ï¼Œä½†ä»èµ„æ–™ä¸Šæ˜¾ç¤ºobjc_loadWeakRetainedå‡½æ•°å·²ç»ä¿®å¤äº†è¯¥é—®é¢˜ã€‚æ‰€ä»¥ä¸å¤ªæ¸…æ¥šåˆ°åº•è¿˜æœ‰å“ªäº›åŸå› å¯¼è‡´weakå¤šçº¿ç¨‹ä¸å®‰å…¨ã€‚</p>
<p>Q3ï¼šdealloc çš„æ—¶å€™å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œä¼šé˜²æ­¢å¯¹è±¡é”€æ¯å—ï¼Ÿ</p>
<p>ä¸èƒ½ã€‚åœ¨dealloc çš„æ—¶å€™è°ƒç”¨retainï¼Œå¼•ç”¨è®¡æ•°ç¡®å®ä¼šå¢åŠ ï¼Œä½†ä¸ä¼šé˜»æ­¢å¯¹è±¡é”€æ¯ã€‚å› ä¸ºdeallocæœ€ç»ˆä¼šè°ƒç”¨super-deallocï¼Œè€Œsuper-deallocä»ä¸Šé¢çš„å®ç°å¯ä»¥çœ‹åˆ°æœ€ç»ˆä¼šè°ƒç”¨freeé‡Šæ”¾å†…å­˜ã€‚å¯ä»¥è¯´deallocæ˜¯ä¸€ä¸ªä¸å¯é€†çš„è¡Œä¸ºã€‚</p>
<p>retainåªåœ¨å¯¹è±¡è¿˜æ²¡é”€æ¯çš„æ—¶å€™æ‰æœ‰ç”¨ã€‚</p>
<p>MRCï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)dealloc &#123;</span><br><span class="line">    <span class="comment">//åœ¨[super dealloc];å‰å†™æ²¡æœ‰é—®é¢˜ï¼Œè™½ç„¶æ­¤æ—¶å¼•ç”¨è®¡æ•°ä¼šå¢åŠ ï¼Œä½†å¯¹è±¡å·²ç»åœ¨é”€æ¯äº†ï¼Œsuper deallocé‡Œæœ€ç»ˆä¼šè°ƒç”¨freeã€‚</span></span><br><span class="line"><span class="comment">//    [self retain]; //å¼•ç”¨è®¡æ•°ä¼šå˜ä¸º2.ä½†æ²¡ç”¨ã€‚</span></span><br><span class="line"><span class="comment">//    NSLog(@&quot;retainCount:%lu&quot;, (unsigned long)[self retainCount]); </span></span><br><span class="line">    </span><br><span class="line">    [<span class="variable language_">super</span> dealloc];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åœ¨[super dealloc];åå†™ä¼šå´©æºƒï¼Œå› ä¸ºå¯¹è±¡çš„å†…å­˜å·²ç»freeäº†ï¼Œè¿™é‡Œä¼šé‡æŒ‡é’ˆå´©æºƒã€‚</span></span><br><span class="line">    [<span class="keyword">self</span> <span class="keyword">retain</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;retainCount:%lu&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span>)[<span class="keyword">self</span> retainCount]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ARCï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)dealloc &#123;</span><br><span class="line">    ARCPerson *obj = <span class="keyword">self</span>; <span class="comment">//è¿™é‡Œæ²¡äº‹ï¼Œå¼•ç”¨è®¡æ•°ä¼šå˜ä¸º2.</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;obj:%@&quot;</span>, obj);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;retain count = %ld\n&quot;</span>, <span class="built_in">CFGetRetainCount</span>((__bridge  <span class="built_in">CFTypeRef</span>)(<span class="keyword">self</span>)));</span><br><span class="line">    </span><br><span class="line">    __<span class="keyword">weak</span> ARCPerson *wObj = <span class="keyword">self</span>; <span class="comment">//è¿™é‡Œä¼šå´©æºƒã€‚</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;wObj:%@&quot;</span>, wObj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Q4ï¼šweakæ˜¯å¦é€‚ç”¨äºMRCï¼Ÿ</p>
<p>é€‚ç”¨ã€‚weakåœ¨MRCä¸‹ä¹Ÿæ˜¯æœ‰æ•ˆæœçš„ã€‚åªä¸è¿‡weakåªèƒ½åœ¨&gt;=iOS5ä¸Šæ‰èƒ½ä½¿ç”¨ã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)hello &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        MRCCat *cat = [MRCCat new];</span><br><span class="line">        <span class="keyword">self</span>.weakCat = cat;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ 1&quot;</span>, <span class="keyword">self</span>.weakCat);</span><br><span class="line">        [cat release];</span><br><span class="line">    &#125; <span class="comment">//weakåœ¨MRCä¸‹ä¹Ÿæ˜¯æœ‰æ•ˆæœçš„ã€‚åªä¸è¿‡weakåªèƒ½åœ¨&gt;=iOS5ä¸Šæ‰èƒ½ä½¿ç”¨ã€‚</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ 2&quot;</span>, <span class="keyword">self</span>.weakCat); <span class="comment">//è¿™é‡Œæ‰“å°ä¸ºï¼š(null) 2ã€‚è¯´æ˜weakCatè¢«ç½®ä¸ºniläº†ã€‚</span></span><br><span class="line">    [<span class="keyword">self</span>.weakCat hello];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ hello&quot;</span>, <span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><p>å¤ä¹  C è¯­è¨€é‡Œçš„æŒ‡é’ˆå’Œæ•°ç»„çš„ä¸€äº›è¯­æ³•</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> i = <span class="number">3</span>;</span><br><span class="line"><span class="type">int</span> *intPtr = &amp;i; <span class="comment">//å¯ä»¥æŒ‡å‘ä¸€ä¸ªintå˜é‡ï¼Œä¹Ÿå¯ä»¥æŒ‡å‘ä¸€ä¸ªå…ƒç´ ä¸ºintçš„æ•°ç»„</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> intArr[<span class="number">10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">intArr[<span class="number">0</span>] = i;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> *intPtrArr[<span class="number">10</span>] = &#123;&amp;i&#125;;</span><br><span class="line">*intPtrArr[<span class="number">0</span>] = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> *intPtrArr = intArr;</span><br><span class="line">*(intPtrArr+<span class="number">1</span>) = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">intPtr = intArr; <span class="comment">//è¿™é‡ŒintPtrå°±æŒ‡å‘äº†ä¸€ä¸ªæ•°ç»„</span></span><br><span class="line">*(intPtr + <span class="number">2</span>) = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> **ptrD = &amp;intPtr; <span class="comment">//ptrDæŒ‡é’ˆçš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="type">int</span> **arr[<span class="number">10</span>] = &#123;<span class="literal">NULL</span>&#125;; <span class="comment">//arræ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå…ƒç´ æ˜¯æŒ‡é’ˆçš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="type">int</span> ***ptrArr = arr; <span class="comment">//ptrArræ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„çš„å…ƒç´ æ˜¯æŒ‡é’ˆçš„æŒ‡é’ˆ</span></span><br><span class="line">arr[<span class="number">0</span>] = ptrD;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> a = *intPtr;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
      <tags>
        <tag>å†…å­˜ç®¡ç†</tag>
      </tags>
  </entry>
  <entry>
    <title>iOS ä¿¡å·é‡åŸç†ç¯‡</title>
    <url>/2020/06/06/iOS-%E4%BF%A1%E5%8F%B7%E9%87%8F%E5%8E%9F%E7%90%86%E7%AF%87/</url>
    <content><![CDATA[<h3 id="ä¿¡å·é‡åŸç†ç¯‡"><a href="#ä¿¡å·é‡åŸç†ç¯‡" class="headerlink" title="ä¿¡å·é‡åŸç†ç¯‡"></a>ä¿¡å·é‡åŸç†ç¯‡</h3><p>æºç ç‰ˆæœ¬ï¼šlibdispatch-1173.40.5</p>
<p>ä¿¡å·é‡çš„å®ç°ä¸»è¦æ˜¯åˆ›å»ºï¼Œé”€æ¯ï¼Œwaitå’Œsignalï¼Œå››ä¸ªæ–¹æ³•ã€‚</p>
<p>ä¿¡å·é‡ç»“æ„ä½“ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">DISPATCH_CLASS_DECL(semaphore, OBJECT);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dispatch_semaphore_s</span> &#123;</span></span><br><span class="line">	DISPATCH_OBJECT_HEADER(semaphore);</span><br><span class="line">	<span class="type">long</span> <span class="keyword">volatile</span> dsema_value;</span><br><span class="line">	<span class="type">long</span> dsema_orig;</span><br><span class="line">	<span class="type">_dispatch_sema4_t</span> dsema_sema;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">semaphore_t</span> <span class="type">_dispatch_sema4_t</span>;</span><br></pre></td></tr></table></figure>
<h4 id="ä¿¡å·é‡çš„åˆ›å»ºâ€”dispatch-semaphore-create"><a href="#ä¿¡å·é‡çš„åˆ›å»ºâ€”dispatch-semaphore-create" class="headerlink" title="ä¿¡å·é‡çš„åˆ›å»ºâ€”dispatch_semaphore_create"></a>ä¿¡å·é‡çš„åˆ›å»ºâ€”dispatch_semaphore_create</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">dispatch_semaphore_t</span></span><br><span class="line"><span class="title function_">dispatch_semaphore_create</span><span class="params">(<span class="type">long</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">dispatch_semaphore_t</span> dsema;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If the internal value is negative, then the absolute of the value is</span></span><br><span class="line">	<span class="comment">// equal to the number of waiting threads. Therefore it is bogus to</span></span><br><span class="line">	<span class="comment">// initialize the semaphore with a negative value.</span></span><br><span class="line">	<span class="keyword">if</span> (value &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> DISPATCH_BAD_INPUT;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	dsema = _dispatch_object_alloc(DISPATCH_VTABLE(semaphore),</span><br><span class="line">			<span class="keyword">sizeof</span>(<span class="keyword">struct</span> dispatch_semaphore_s));</span><br><span class="line">	dsema-&gt;do_next = DISPATCH_OBJECT_LISTLESS;</span><br><span class="line">	dsema-&gt;do_targetq = _dispatch_get_default_queue(<span class="literal">false</span>);</span><br><span class="line">	dsema-&gt;dsema_value = value;</span><br><span class="line">	_dispatch_sema4_init(&amp;dsema-&gt;dsema_sema, _DSEMA4_POLICY_FIFO);</span><br><span class="line">	dsema-&gt;dsema_orig = value;</span><br><span class="line">	<span class="keyword">return</span> dsema;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ä¸èƒ½ä¼ å…¥ä¸€ä¸ªå°äº0çš„å€¼ã€‚ä¿¡å·é‡æœ‰å‡ ä¸ªé‡è¦çš„å±æ€§ï¼š</p>
<p>dsema_valueï¼šè®°å½•å½“å‰è®¡æ•°å€¼ï¼Œåç»­çš„waitå’Œsignalå‡½æ•°ä¼šæ”¹å˜è¯¥å€¼ã€‚</p>
<p>dsema_semaï¼šä¿¡å·é‡ (çœŸæ­£å¹²äº‹æƒ…çš„)</p>
<p>dsema_origï¼šè®°å½•åˆ›å»ºæ—¶ä¼ å…¥çš„åˆå§‹è®¡æ•°å€¼ã€‚åœ¨ä¿¡å·é‡é”€æ¯æ—¶æœ‰ç”¨åˆ°ã€‚</p>
<h4 id="ä¿¡å·é‡waitæ“ä½œâ€”dispatch-semaphore-wait"><a href="#ä¿¡å·é‡waitæ“ä½œâ€”dispatch-semaphore-wait" class="headerlink" title="ä¿¡å·é‡waitæ“ä½œâ€”dispatch_semaphore_wait"></a>ä¿¡å·é‡waitæ“ä½œâ€”dispatch_semaphore_wait</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span></span><br><span class="line"><span class="title function_">dispatch_semaphore_wait</span><span class="params">(<span class="type">dispatch_semaphore_t</span> dsema, <span class="type">dispatch_time_t</span> timeout)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">long</span> value = os_atomic_dec2o(dsema, dsema_value, acquire);</span><br><span class="line">	<span class="keyword">if</span> (likely(value &gt;= <span class="number">0</span>)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> _dispatch_semaphore_wait_slow(dsema, timeout);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>os_atomic_dec2oæ˜¯ä¸€ä¸ªå®ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> os_atomic_dec2o(p, f, m) \</span></span><br><span class="line"><span class="meta">		os_atomic_sub2o(p, f, 1, m)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> os_atomic_sub2o(p, f, v, m) \</span></span><br><span class="line"><span class="meta">		os_atomic_sub(&amp;(p)-&gt;f, (v), m)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> os_atomic_sub(p, v, m) \</span></span><br><span class="line"><span class="meta">		_os_atomic_c11_op((p), (v), m, sub, -)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _os_atomic_c11_op(p, v, m, o, op) \</span></span><br><span class="line"><span class="meta">		(&#123; _os_atomic_basetypeof(p) _v = (v), _r = \</span></span><br><span class="line"><span class="meta">		atomic_fetch_##o##_explicit(_os_atomic_c11_atomic(p), _v, \</span></span><br><span class="line"><span class="meta">		memory_order_##m); (__typeof__(_r))(_r op _v); &#125;)</span></span><br><span class="line">		</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _os_atomic_basetypeof(p) \</span></span><br><span class="line"><span class="meta">		__typeof__(atomic_load_explicit(_os_atomic_c11_atomic(p), memory_order_relaxed))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _os_atomic_c11_atomic(p) \</span></span><br><span class="line"><span class="meta">		((__typeof__(*(p)) _Atomic *)(p))</span></span><br></pre></td></tr></table></figure>
<p>å±•å¼€åå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> value = (&#123; __typeof__(atomic_load_explicit(((__typeof__(*((&amp;(dsema)-&gt;dsema_value))) <span class="keyword">_Atomic</span> *)((&amp;(dsema)-&gt;dsema_value))), memory_order_relaxed)) _v = (((<span class="number">1</span>))), _r = atomic_fetch_sub_explicit(((__typeof__(*((&amp;(dsema)-&gt;dsema_value))) <span class="keyword">_Atomic</span> *)((&amp;(dsema)-&gt;dsema_value))), _v, memory_order_acquire); (__typeof__(_r))(_r - _v); &#125;);</span><br></pre></td></tr></table></figure>
<p>ç®€åŒ–ä¸‹å°±æ˜¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> value = (</span><br><span class="line">  &#123;</span><br><span class="line">    _v = <span class="number">1</span>, </span><br><span class="line">    _r = atomic_fetch_sub_explicit(*((&amp;(dsema)-&gt;dsema_value)), <span class="number">1</span>, memory_order_acquire);</span><br><span class="line">    _r - _v;</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>ç±»ä¼¼äºï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> value = (&#123;</span><br><span class="line">		<span class="type">int</span> a = <span class="number">3</span>; <span class="type">int</span> b = <span class="number">1</span>; a - b;</span><br><span class="line">&#125;); <span class="comment">//valueçš„å€¼å°±ç­‰äºa-b = 2;  æºç é‡Œå¥½å¤šè¿™æ ·çš„å®</span></span><br></pre></td></tr></table></figure>
<p>è€Œatomic_fetch_sub_explicitå‡½æ•°è¡¨ç¤ºdsema_value -= 1ï¼Œå¹¶è¿”å›dsema_valueåŸæ¥çš„å€¼ã€‚</p>
<p>å› æ­¤<code>long value = os_atomic_dec2o(dsema, dsema_value, acquire);</code></p>
<p>è¿™å¥ä»£ç çš„æ„æ€å°±æ˜¯ï¼š</p>
<p>åŸå­æ“ä½œï¼Œå°†ä¿¡å·é‡è‡ªå‡1ï¼Œå¹¶å°†ç»“æœèµ‹å€¼ç»™valueã€‚</p>
<p>ç”±äºæ˜¯åŸå­æ“ä½œï¼Œå› æ­¤åŒä¸€æ—¶åˆ»åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹dsema_valueè¿›è¡Œå‡1ã€‚å¤šçº¿ç¨‹ä¸‹ä¸ä¼šå‡ºé—®é¢˜ã€‚</p>
<p>å¦‚æœvalue&gt;=0ï¼Œåˆ™è¿”å›0ï¼Œè¿™ç§æƒ…å†µä¸ä¼šé˜»å¡çº¿ç¨‹ã€‚</p>
<p>å¦åˆ™è°ƒç”¨_dispatch_semaphore_wait_slowå‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">DISPATCH_NOINLINE</span><br><span class="line"><span class="type">static</span> <span class="type">long</span></span><br><span class="line">_dispatch_semaphore_wait_slow(<span class="type">dispatch_semaphore_t</span> dsema,</span><br><span class="line">		<span class="type">dispatch_time_t</span> timeout)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">long</span> orig;</span><br><span class="line"></span><br><span class="line">	_dispatch_sema4_create(&amp;dsema-&gt;dsema_sema, _DSEMA4_POLICY_FIFO);</span><br><span class="line">	<span class="keyword">switch</span> (timeout) &#123;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">if</span> (!_dispatch_sema4_timedwait(&amp;dsema-&gt;dsema_sema, timeout)) &#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Fall through and try to undo what the fast path did to</span></span><br><span class="line">		<span class="comment">// dsema-&gt;dsema_value</span></span><br><span class="line">	<span class="keyword">case</span> DISPATCH_TIME_NOW:</span><br><span class="line">		orig = dsema-&gt;dsema_value;</span><br><span class="line">		<span class="keyword">while</span> (orig &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (os_atomic_cmpxchgvw2o(dsema, dsema_value, orig, orig + <span class="number">1</span>,</span><br><span class="line">					&amp;orig, relaxed)) &#123; <span class="comment">//è¶…æ—¶çš„ç³»ç»Ÿæ‰ä¼šè‡ªåŠ¨+1</span></span><br><span class="line">				<span class="keyword">return</span> _DSEMA4_TIMEOUT();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Another thread called semaphore_signal().</span></span><br><span class="line">		<span class="comment">// Fall through and drain the wakeup.</span></span><br><span class="line">	<span class="keyword">case</span> DISPATCH_TIME_FOREVER:</span><br><span class="line">		_dispatch_sema4_wait(&amp;dsema-&gt;dsema_sema);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥æ–¹æ³•ä¼šæ ¹æ®ä¼ å…¥çš„dispatch_time_tè¿›è¡ŒåŒºåˆ†ï¼š</p>
<p>å…¶ä»–ç­‰å¾…æ—¶é—´ï¼šæ¯”å¦‚ä¼ å…¥dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2 * NSEC_PER_SEC))ï¼Œå³2sã€‚</p>
<p>è¯¥caseé‡Œä¸»è¦å°±æ˜¯_dispatch_sema4_timedwaitï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">bool</span></span><br><span class="line">_dispatch_sema4_timedwait(<span class="type">_dispatch_sema4_t</span> *sema, <span class="type">dispatch_time_t</span> timeout)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">mach_timespec_t</span> _timeout;</span><br><span class="line">	<span class="type">kern_return_t</span> kr;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="type">uint64_t</span> nsec = _dispatch_timeout(timeout);</span><br><span class="line">		_timeout.tv_sec = (__typeof__(_timeout.tv_sec))(nsec / NSEC_PER_SEC);</span><br><span class="line">		_timeout.tv_nsec = (__typeof__(_timeout.tv_nsec))(nsec % NSEC_PER_SEC);</span><br><span class="line">		kr = semaphore_timedwait(*sema, _timeout);</span><br><span class="line">	&#125; <span class="keyword">while</span> (unlikely(kr == KERN_ABORTED));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (kr == KERN_OPERATION_TIMED_OUT) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	DISPATCH_SEMAPHORE_VERIFY_KR(kr);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è®¡ç®—å‰©ä½™æ—¶é—´ï¼Œè°ƒç”¨machå†…æ ¸çš„ç­‰å¾…å‡½æ•°semaphore_timedwait()è¿›è¡Œç­‰å¾…ï¼Œçº¿ç¨‹è¿›å…¥ä¼‘çœ çŠ¶æ€ã€‚å¦‚æœåœ¨æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰å¾—åˆ°é€šçŸ¥ï¼Œåˆ™ä¼šä¸€ç›´é˜»å¡ä½ï¼Œç›‘å¬dsema_portç­‰å¾…å…¶é€šçŸ¥ã€‚</p>
<p>å¦‚æœkr == KERN_OPERATION_TIMED_OUTï¼Œä»£è¡¨ç­‰å¾…è¶…æ—¶ï¼Œåˆ™è¿”å›trueã€‚å…¶ä»–æƒ…å†µè¿”å›falseã€‚</p>
<p>å½“_dispatch_sema4_timedwaitè¿”å›trueæ—¶ï¼Œcaseä¼šæ‰å…¥åˆ°DISPATCH_TIME_NOWå¤„ç†ã€‚</p>
<p>å½“_dispatch_sema4_timedwaitè¿”å›falseæ—¶ï¼Œä»£è¡¨åœ¨ç­‰å¾…æœŸé—´æ”¶åˆ°äº†ä¸€ä¸ªä¿¡å·ï¼Œçº¿ç¨‹è¢«å”¤é†’ã€‚caseä¼šbreakï¼›dispatch_semaphore_waitä¹Ÿå°±è¿”å›0ã€‚</p>
<p>DISPATCH_TIME_NOWï¼šä¹Ÿå°±æ˜¯ä¸ç­‰å¾…ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">os_atomic_cmpxchgvw2o(dsema, dsema_value, orig, orig + <span class="number">1</span>,</span><br><span class="line">					&amp;orig, relaxed)</span><br></pre></td></tr></table></figure>
<p>è¯¥å®ç”±ä»¥ä¸‹å®ç»„æˆï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> os_atomic_cmpxchgvw2o(p, f, e, v, g, m) \</span></span><br><span class="line"><span class="meta">		os_atomic_cmpxchgvw(&amp;(p)-&gt;f, (e), (v), (g), m)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> os_atomic_cmpxchgvw(p, e, v, g, m) \</span></span><br><span class="line"><span class="meta">		(&#123; _os_atomic_basetypeof(p) _r = (e); _Bool _b = \</span></span><br><span class="line"><span class="meta">		atomic_compare_exchange_weak_explicit(_os_atomic_c11_atomic(p), \</span></span><br><span class="line"><span class="meta">		&amp;_r, v, memory_order_##m, memory_order_relaxed); *(g) = _r;  _b; &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _os_atomic_basetypeof(p) \</span></span><br><span class="line"><span class="meta">__typeof__(atomic_load_explicit(_os_atomic_c11_atomic(p), memory_order_relaxed))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _os_atomic_c11_atomic(p) \</span></span><br><span class="line"><span class="meta">		((__typeof__(*(p)) _Atomic *)(p))</span></span><br></pre></td></tr></table></figure>
<p>å°†å®å±•å¼€ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">(&#123; </span><br><span class="line">  __typeof__(atomic_load_explicit(((__typeof__(*(&amp;(dsema)-&gt;dsema_value)) <span class="keyword">_Atomic</span> *)(&amp;(dsema)-&gt;dsema_value)), memory_order_relaxed)) _r = ((orig)); </span><br><span class="line">  <span class="type">_Bool</span> _b = atomic_compare_exchange_weak_explicit(((__typeof__(*(&amp;(dsema)-&gt;dsema_value)) <span class="keyword">_Atomic</span> *)(&amp;(dsema)-&gt;dsema_value)), &amp;_r, (orig + <span class="number">1</span>), memory_order_relaxed, memory_order_relaxed); </span><br><span class="line">  *((&amp;orig)) = _r; </span><br><span class="line">  _b; </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>ä¸»è¦æ˜¯atomic_compare_exchange_weak_explicitå‡½æ•°çš„æ„æ€äº†ï¼š</p>
<p><code>_Bool atomic_compare_exchange_weak_explicitï¼ˆvolatile A * objï¼ŒC * expectedï¼ŒC desiredï¼Œmemory_order succï¼Œmemory_order failï¼‰;</code></p>
<p>æ¯”è¾ƒå¹¶äº¤æ¢è¢«å°è£…çš„å€¼(weak)ä¸å‚æ•° expected æ‰€æŒ‡å®šçš„å€¼æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœï¼š<br>ç›¸ç­‰ï¼Œåˆ™ç”¨ desired æ›¿æ¢åŸå­å¯¹è±¡çš„æ—§å€¼ã€‚<br>ä¸ç›¸ç­‰ï¼Œåˆ™ç”¨åŸå­å¯¹è±¡çš„æ—§å€¼æ›¿æ¢ expected ï¼Œå› æ­¤è°ƒç”¨è¯¥å‡½æ•°ä¹‹åï¼Œå¦‚æœè¢«è¯¥åŸå­å¯¹è±¡å°è£…çš„å€¼ä¸å‚æ•° expected æ‰€æŒ‡å®šçš„å€¼ä¸ç›¸ç­‰ï¼Œexpected ä¸­çš„å†…å®¹å°±æ˜¯åŸå­å¯¹è±¡çš„æ—§å€¼ã€‚<br>è¯¥å‡½æ•°é€šå¸¸ä¼šè¯»å–åŸå­å¯¹è±¡å°è£…çš„å€¼ï¼Œå¦‚æœæ¯”è¾ƒä¸º true(å³åŸå­å¯¹è±¡çš„å€¼ç­‰äº expected)ï¼Œåˆ™æ›¿æ¢åŸå­å¯¹è±¡çš„æ—§å€¼ï¼Œä½†æ•´ä¸ªæ“ä½œæ˜¯åŸå­çš„ï¼Œåœ¨æŸä¸ªçº¿ç¨‹è¯»å–å’Œä¿®æ”¹è¯¥åŸå­å¯¹è±¡æ—¶ï¼Œå¦å¤–çš„çº¿ç¨‹ä¸èƒ½è¯»å–å’Œä¿®æ”¹è¯¥åŸå­å¯¹è±¡ã€‚</p>
<p>æ¯”è¾ƒçš„ç»“æœï¼š<code>true</code>å¦‚æœ<code>*obj</code>ç­‰äº<code>*exp</code>ï¼Œå¦åˆ™<code>false</code>ã€‚</p>
<p>åœ¨è¿™é‡Œï¼Œorigè‚¯å®š&lt;0ï¼Œæ‰€ä»¥ä¼šè¿›å…¥whileå¾ªç¯ï¼Œ</p>
<p>å¦‚æœorigå’Œdsema_valueç›¸ç­‰ï¼ˆåœ¨è¿™é‡Œorigæ˜¯ç­‰äºdsema_valueçš„ï¼‰ï¼Œåˆ™dsema_valueåŠ 1ï¼Œos_atomic_cmpxchgvw2oè¿”å›trueï¼Œæœ€ç»ˆ<code>return _DSEMA4_TIMEOUT();</code></p>
<p>å› æ­¤DISPATCH_TIME_NOWçš„ä½œç”¨ï¼šå°†ä¿¡å·é‡è‡ªåŠ 1ï¼ˆæŠµæ¶ˆæ‰äº†å‰é¢çš„è‡ªå‡1ã€‚æ³¨æ„å³ä½¿è¿™é‡Œè‡ªåŠ 1ï¼Œdsema_valueçš„å€¼ä¹Ÿä¸ä¸€å®šå°±æ˜¯0ï¼‰ï¼Œç„¶åè¿”å›<code>_DSEMA4_TIMEOUT()</code>ä¸€ä¸ªé0æ•°ã€‚</p>
<p>DISPATCH_TIME_FOREVERï¼šæ°¸ä¹…ç­‰å¾…ä¸€ä¸ªä¿¡å·çš„å‘é€ã€‚</p>
<p>è¿™é‡Œä¸»è¦å°±æ˜¯_dispatch_sema4_waitçš„ä½œç”¨ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_dispatch_sema4_wait(<span class="type">_dispatch_sema4_t</span> *sema)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">kern_return_t</span> kr;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		kr = semaphore_wait(*sema);</span><br><span class="line">	&#125; <span class="keyword">while</span> (kr == KERN_ABORTED);</span><br><span class="line">	DISPATCH_SEMAPHORE_VERIFY_KR(kr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨machå†…æ ¸çš„ç­‰å¾…å‡½æ•°semaphore_wait()è¿›è¡Œç­‰å¾…ã€‚ç›´åˆ°æ”¶åˆ°ä¸€ä¸ªä¿¡å·è¢«å”¤é†’ã€‚</p>
<h4 id="ä¿¡å·é‡signalæ“ä½œâ€”dispatch-semaphore-signal"><a href="#ä¿¡å·é‡signalæ“ä½œâ€”dispatch-semaphore-signal" class="headerlink" title="ä¿¡å·é‡signalæ“ä½œâ€”dispatch_semaphore_signal"></a>ä¿¡å·é‡signalæ“ä½œâ€”dispatch_semaphore_signal</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span></span><br><span class="line"><span class="title function_">dispatch_semaphore_signal</span><span class="params">(<span class="type">dispatch_semaphore_t</span> dsema)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">long</span> value = os_atomic_inc2o(dsema, dsema_value, release);</span><br><span class="line">	<span class="keyword">if</span> (likely(value &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (unlikely(value == LONG_MIN)) &#123;</span><br><span class="line">		DISPATCH_CLIENT_CRASH(value,</span><br><span class="line">				<span class="string">&quot;Unbalanced call to dispatch_semaphore_signal()&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> _dispatch_semaphore_signal_slow(dsema);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DISPATCH_NOINLINE</span><br><span class="line"><span class="type">long</span></span><br><span class="line">_dispatch_semaphore_signal_slow(<span class="type">dispatch_semaphore_t</span> dsema)</span><br><span class="line">&#123;</span><br><span class="line">	_dispatch_sema4_create(&amp;dsema-&gt;dsema_sema, _DSEMA4_POLICY_FIFO);</span><br><span class="line">	_dispatch_sema4_signal(&amp;dsema-&gt;dsema_sema, <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line">_dispatch_sema4_signal(<span class="type">_dispatch_sema4_t</span> *sema, <span class="type">long</span> count)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		<span class="type">kern_return_t</span> kr = semaphore_signal(*sema);</span><br><span class="line">		DISPATCH_SEMAPHORE_VERIFY_KR(kr);</span><br><span class="line">	&#125; <span class="keyword">while</span> (--count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆæ˜¯å®os_atomic_inc2oï¼Œè¿™ä¸ªçœ‹å­—é¢æ„æ€å¾ˆå®¹æ˜“çŒœåˆ°æ˜¯åŸå­æ“ä½œå°†dsema_valueè‡ªåŠ 1ï¼Œå¹¶å°†ç»“æœèµ‹å€¼ç»™valueã€‚</p>
<p>å¦‚æœvalue &gt; 0,è¡¨ç¤ºä¿¡å·é‡è¶³å¤Ÿï¼Œç›´æ¥è¿”å›0ã€‚</p>
<p>å¦‚æœvalue == LONG_MINï¼Œåˆ™å´©æºƒã€‚åº”è¯¥æ˜¯è¿‡åº¦waitäº†ã€‚</p>
<p>å¦åˆ™è°ƒç”¨_dispatch_semaphore_signal_slowå‡½æ•°ï¼Œæœ€ç»ˆä¼šè°ƒç”¨å†…æ ¸å‡½æ•°<code>semaphore_signal(*sema);</code>å‘å‡ºä¸€ä¸ªä¿¡å·å”¤é†’ä¸€ä¸ªwaitçš„çº¿ç¨‹ï¼Œè¿”å›1ã€‚</p>
<p>å› æ­¤dispatch_semaphore_signalçš„ä½œç”¨å°±æ˜¯å°†ä¿¡å·é‡+1ï¼Œå¦‚æœåŠ 1åä¿¡å·é‡è¿˜æ˜¯&lt;=0ï¼Œè¯´æ˜æœ‰waitçš„çº¿ç¨‹ï¼Œé‚£å°±å”¤é†’æœ€å…ˆç­‰å¾…çš„çº¿ç¨‹ã€‚</p>
<h4 id="ä¿¡å·é‡çš„é”€æ¯â€”-dispatch-semaphore-dispose"><a href="#ä¿¡å·é‡çš„é”€æ¯â€”-dispatch-semaphore-dispose" class="headerlink" title="ä¿¡å·é‡çš„é”€æ¯â€”_dispatch_semaphore_dispose"></a>ä¿¡å·é‡çš„é”€æ¯â€”_dispatch_semaphore_dispose</h4><p>ä¿¡å·é‡å¯¹è±¡éµå®ˆARCå†…å­˜ç®¡ç†ï¼Œå½“ä¿¡å·é‡å¯¹è±¡å¼•ç”¨è®¡æ•°ä¸º0æ—¶ï¼Œæ¯”å¦‚å°†self.semaphore = nilï¼Œæˆ–è€…self.semaphore = æ–°ä¿¡å·é‡å¯¹è±¡ï¼Œé‚£ä¹ˆä¹‹å‰çš„ä¿¡å·é‡å¯¹è±¡å°†é”€æ¯ã€‚æ‰€ä»¥å½“è¿˜æœ‰waitä¸­çš„çº¿ç¨‹æ—¶åƒä¸‡ä¸è¦æŠŠä¿¡å·é‡å¯¹è±¡ç»™æ•´é”€æ¯äº†ã€‚</p>
<p>é”€æ¯æ—¶ç³»ç»Ÿä¼šè°ƒç”¨_dispatch_semaphore_disposeå‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_dispatch_semaphore_dispose(<span class="type">dispatch_object_t</span> dou,</span><br><span class="line">		DISPATCH_UNUSED <span class="type">bool</span> *allow_free)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">dispatch_semaphore_t</span> dsema = dou._dsema;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (dsema-&gt;dsema_value &lt; dsema-&gt;dsema_orig) &#123;</span><br><span class="line">		DISPATCH_CLIENT_CRASH(dsema-&gt;dsema_orig - dsema-&gt;dsema_value,</span><br><span class="line">				<span class="string">&quot;Semaphore object deallocated while in use&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_dispatch_sema4_dispose(&amp;dsema-&gt;dsema_sema, _DSEMA4_POLICY_FIFO);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DISPATCH_ALWAYS_INLINE</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line">_dispatch_sema4_dispose(<span class="type">_dispatch_sema4_t</span> *sema, <span class="type">int</span> policy)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (_dispatch_sema4_is_created(sema)) &#123;</span><br><span class="line">		_dispatch_sema4_dispose_slow(sema, policy);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line">_dispatch_sema4_dispose_slow(<span class="type">_dispatch_sema4_t</span> *sema, <span class="type">int</span> policy)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">semaphore_t</span> sema_port = *sema;</span><br><span class="line">	*sema = MACH_PORT_DEAD;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DISPATCH_USE_OS_SEMAPHORE_CACHE</span></span><br><span class="line">	<span class="keyword">if</span> (policy == _DSEMA4_POLICY_FIFO) &#123;</span><br><span class="line">		<span class="keyword">return</span> os_put_cached_semaphore((<span class="type">os_semaphore_t</span>)sema_port);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="type">kern_return_t</span> kr = semaphore_destroy(mach_task_self(), sema_port);</span><br><span class="line">	DISPATCH_SEMAPHORE_VERIFY_KR(kr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœdsema_value &lt; dsema_origï¼Œç¨‹åºä¼šå´©æºƒå¹¶æç¤ºSemaphore object deallocated while in useã€‚æç¤ºè¿™ä¸ªå¹¶ä¸ä¸€å®šè¯´æ˜è¿˜æœ‰çº¿ç¨‹é˜»å¡å’Œç­‰å¾…signalï¼Œè¿™æ˜¯ç³»ç»Ÿçš„ä¸€ç§è¿‡äºä¿å®ˆçš„ä¿æŠ¤æªæ–½ï¼Œç›®çš„å°±æ˜¯è¦è®©ä¸šåŠ¡å±‚å¹³è¡¡ä½¿ç”¨signalå’Œwaitã€‚æ‰€ä»¥å‡½æ•°è¯´æ˜æ‰æé†’æˆ‘ä»¬waitå’Œsignalè¦é…å¯¹ä½¿ç”¨ã€‚</p>
<p>æ¢å¥è¯ï¼Œåªæœ‰å½“signalæ¬¡æ•°&gt;=waitçš„æ¬¡æ•°ï¼Œdsema_valueæ‰ä¼š&gt;=dsema_origã€‚ä»å®ç°æ¥çœ‹ï¼Œæˆ‘ä»¬è¦ä¿è¯signalæ¬¡æ•°&gt;=waitçš„æ¬¡æ•°ã€‚</p>
<p>ç„¶åå°±æ˜¯è°ƒç”¨_dispatch_sema4_disposeè¿›è¡Œé”€æ¯æ“ä½œã€‚</p>
<p>egï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)test_semaphore_do_task_after_all_work1 &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     é”™è¯¯å®ç°ï¼Œæ²¡æœ‰ç†è§£dispatch_semaphore_signalçš„ä½œç”¨ã€‚</span></span><br><span class="line"><span class="comment">     signalå‡½æ•°çš„ä½œç”¨ï¼š1.å°†ä¿¡å·é‡åŠ 1ã€‚2.å¦‚æœä¹‹å‰æœ‰çº¿ç¨‹è¢«é˜»å¡ï¼Œåˆ™æŒ‰ä¼˜å…ˆçº§å”¤é†’ä¸€ä¸ªçº¿ç¨‹ã€‚</span></span><br><span class="line"><span class="comment">     ä¸‹é¢çš„å®ç°ä¸ä»…è¾¾ä¸åˆ°è¦æ±‚ï¼Œå¹¶ä¸”è¿˜ä¼šå´©æºƒ.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;current1:%@&quot;</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        </span><br><span class="line">        dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">2</span>); <span class="comment">//åˆå§‹åŒ–æ—¶ä¿¡å·é‡æ˜¯2.</span></span><br><span class="line">        </span><br><span class="line">        dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">        __block <span class="built_in">NSInteger</span> rs1 = <span class="number">0</span>;</span><br><span class="line">        [<span class="keyword">self</span> requestSomethingWithN:<span class="number">40</span> completion:^(<span class="built_in">NSInteger</span> result) &#123;</span><br><span class="line">            rs1 = result;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;40 rs = %ld&quot;</span>, (<span class="type">long</span>)result);</span><br><span class="line">            dispatch_semaphore_signal(semaphore);</span><br><span class="line">        &#125;];</span><br><span class="line">        </span><br><span class="line">        dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">        __block <span class="built_in">NSInteger</span> rs2 = <span class="number">0</span>;</span><br><span class="line">        [<span class="keyword">self</span> requestSomethingWithN:<span class="number">41</span> completion:^(<span class="built_in">NSInteger</span> result) &#123;</span><br><span class="line">            rs2 = result;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;41 rs = %ld&quot;</span>, (<span class="type">long</span>)result);</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             è¿™é‡Œsemaphoreæ˜¯ç­‰åˆ°blockæ‰§è¡Œå®Œæˆåæ‰é‡Šæ”¾çš„ã€‚è¿˜ä»¥ä¸ºblockæ²¡å¼ºå¼•ç”¨semaphoreå‘¢ã€‚</span></span><br><span class="line"><span class="comment">             å´©æºƒï¼š</span></span><br><span class="line"><span class="comment">             &quot;BUG IN CLIENT OF LIBDISPATCH: Semaphore object deallocated while in use (current value &lt; original value)&quot;</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            dispatch_semaphore_signal(semaphore); <span class="comment">//é”€æ¯æ—¶ï¼Œä¿¡å·é‡æ˜¯1ï¼Œå°äºåˆå§‹å€¼2ï¼Œå› æ­¤å´©æºƒã€‚</span></span><br><span class="line">        &#125;];</span><br><span class="line">        </span><br><span class="line">        dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">        <span class="built_in">NSInteger</span> rs = rs1 + rs2;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;==rs=%ld&quot;</span>, rs);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ€è€ƒ</strong></p>
<p>Q1ï¼šä½¿ç”¨äº’æ–¥é”å’Œæ¡ä»¶å˜é‡å®ç°ä¸€ä¸ªä¿¡å·é‡ï¼Ÿ</p>
<p>åœ¨å®ç°æ—¶ç‰¹åˆ«è¦æ³¨æ„æ¡ä»¶çš„åˆ¤æ–­ã€‚ä¸èƒ½ä½¿ç”¨ä¿¡å·é‡è®¡æ•°å€¼ä½œä¸ºæ¡ä»¶çš„åˆ¤æ–­æ¡ä»¶ï¼Œå¦åˆ™å¾ˆå®¹æ˜“å¯¼è‡´å¾ªç¯ç­‰å¾…ã€‚å¿…é¡»è¦é¢å¤–å®šä¹‰ä¸€ä¸ªå˜é‡ä¸“é—¨ç”¨äºæ¡ä»¶çš„åˆ¤æ–­ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">XQCustomSemaphore</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) pthread_mutex_t mutex;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) pthread_cond_t cond;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> value; <span class="comment">//ä¿¡å·é‡çš„å€¼</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> wakeups; <span class="comment">//è®°å½•å”¤é†’æ¬¡æ•°ï¼Œè¿™ä¸ªå˜é‡éå¸¸é‡è¦ï¼Œæ¡ä»¶åˆ¤æ–­æ—¶åº”è¯¥ä½¿ç”¨è¯¥å˜é‡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>å®ç°ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">XQCustomSemaphore</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)dealloc &#123;</span><br><span class="line">    pthread_mutex_destroy(&amp;_mutex);</span><br><span class="line">    pthread_cond_destroy(&amp;_cond);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithSemaphore:(<span class="built_in">NSInteger</span>)semaphore &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="variable language_">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        pthread_mutex_init(&amp;_mutex, <span class="literal">NULL</span>);</span><br><span class="line">        pthread_cond_init(&amp;_cond, <span class="literal">NULL</span>);</span><br><span class="line">        _value = semaphore;</span><br><span class="line">        _wakeups = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)signal &#123;</span><br><span class="line">    pthread_mutex_lock(&amp;_mutex);</span><br><span class="line">    _value++;</span><br><span class="line">    <span class="keyword">if</span> (_value &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        _wakeups++;</span><br><span class="line">        pthread_cond_signal(&amp;_cond);</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_unlock(&amp;_mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)wait &#123;</span><br><span class="line">    pthread_mutex_lock(&amp;_mutex);</span><br><span class="line">    _value--;</span><br><span class="line">    <span class="keyword">if</span> (_value &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            pthread_cond_wait(&amp;_cond, &amp;_mutex);</span><br><span class="line">        &#125; <span class="keyword">while</span> (_wakeups &lt; <span class="number">1</span>); <span class="comment">//å¦‚æœå› ä¸ºå…¶ä»–åŸå› è¢«å”¤é†’ï¼Œ_wakeupsçš„å€¼å¿…å®šå°äº 1ï¼Œäºæ˜¯åˆç­‰å¾…ã€‚</span></span><br><span class="line">        _wakeups--;</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_unlock(&amp;_mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//é”™è¯¯å®ç°</span></span><br><span class="line">- (<span class="type">void</span>)signal &#123;</span><br><span class="line">    pthread_mutex_lock(&amp;_mutex);</span><br><span class="line">    _value++;</span><br><span class="line">    <span class="keyword">if</span> (_value &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        pthread_cond_signal(&amp;_cond);</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_unlock(&amp;_mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)wait &#123;</span><br><span class="line">    pthread_mutex_lock(&amp;_mutex);</span><br><span class="line">    _value--;</span><br><span class="line">    <span class="keyword">while</span> (_value &lt; <span class="number">0</span>) &#123; <span class="comment">//wait--wait--signal.signalä¹‹åvalue=-1ï¼Œè¿˜æ˜¯å°äº0.æ‰€ä»¥å¿…é¡»å®šä¹‰ä¸€ä¸ªwakeupså˜é‡ç”¨äºæ¡ä»¶åˆ¤æ–­ã€‚</span></span><br><span class="line">        pthread_cond_wait(&amp;_cond, &amp;_mutex);</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_unlock(&amp;_mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‚è€ƒï¼š<a href="https://segmentfault.com/a/1190000005934154">æ“ä½œç³»ç»Ÿæ€è€ƒ ç¬¬åä¸€ç«  Cè¯­è¨€ä¸­çš„ä¿¡å·é‡</a></p>
<h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><p><a href="https://xiaozhuanlan.com/topic/4365017982">æ·±å…¥æµ…å‡º GCD ä¹‹ dispatch_semaphore</a>  ä»‹ç»ä¿¡å·é‡æºç å®ç°çš„ï¼Œä¸è¿‡ç‰ˆæœ¬è¾ƒä½</p>
<p><a href="https://www.shangmayuan.com/a/32031a7be207483dbf4c870c.html">å†™ç»™æœ¬èº«çœ‹çš„æºç ç³»åˆ—: GCDçš„ä¿¡å·é‡semaphore</a>   æ–°ç‰ˆæœ¬çš„</p>
]]></content>
      <categories>
        <category>å¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>ä¿¡å·é‡</tag>
        <tag>é”</tag>
      </tags>
  </entry>
  <entry>
    <title>iOS ä¿¡å·é‡ä½¿ç”¨ç¯‡</title>
    <url>/2020/06/06/iOS-%E4%BF%A1%E5%8F%B7%E9%87%8F%E4%BD%BF%E7%94%A8%E7%AF%87/</url>
    <content><![CDATA[<h3 id="ä¿¡å·é‡ä½¿ç”¨ç¯‡"><a href="#ä¿¡å·é‡ä½¿ç”¨ç¯‡" class="headerlink" title="ä¿¡å·é‡ä½¿ç”¨ç¯‡"></a>ä¿¡å·é‡ä½¿ç”¨ç¯‡</h3><h4 id="æ“ä½œGCDä¿¡å·é‡çš„å‡½æ•°"><a href="#æ“ä½œGCDä¿¡å·é‡çš„å‡½æ•°" class="headerlink" title="æ“ä½œGCDä¿¡å·é‡çš„å‡½æ•°"></a>æ“ä½œGCDä¿¡å·é‡çš„å‡½æ•°</h4><p>åœ¨iOSä¸­æœ‰ä¸‰ä¸ªå‡½æ•°å¯ä»¥æ“ä½œGCDä¿¡å·é‡ï¼š</p>
<p><code>dispatch_semaphore_t dispatch_semaphore_create(long value);</code> åˆ›å»ºä¸€ä¸ªä¿¡å·é‡ã€‚</p>
<p><code>long dispatch_semaphore_signal(dispatch_semaphore_t dsema);</code> å‘é€ä¸€ä¸ªä¿¡å·.</p>
<p><code>long dispatch_semaphore_wait(dispatch_semaphore_t dsema, dispatch_time_t timeout);</code> ç­‰å¾…ä¸€ä¸ªä¿¡å·ã€‚</p>
<h4 id="å‡½æ•°è¯´æ˜"><a href="#å‡½æ•°è¯´æ˜" class="headerlink" title="å‡½æ•°è¯´æ˜"></a>å‡½æ•°è¯´æ˜</h4><ol>
<li><p><code>dispatch_semaphore_t semaphoreTask1 = dispatch_semaphore_create(0);</code><br>åˆ›å»ºä¸€ä¸ªä¿¡å·é‡ï¼Œå¹¶èµ‹äºˆåˆå§‹å€¼(å¿…é¡»ä¼ ä¸€ä¸ª&gt;=0çš„å€¼)ã€‚egï¼šä¼ å…¥2åˆ™è¡¨ç¤ºåŒæ—¶æœ€å¤šä¸¤ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®ä¸´ç•ŒåŒºã€‚</p>
</li>
<li><p><code>long signalRs = dispatch_semaphore_signal(semaphoreTask1);</code><br>å‘å‡ºä¸€ä¸ªä¿¡å·ï¼Œå°†ä¿¡å·é‡åŠ 1ã€‚å¦‚æœä¹‹å‰çš„ä¿¡å·é‡å°äº0ï¼Œè¯´æ˜æœ‰ç­‰å¾…dispatch semaphoreçš„è®¡æ•°å€¼å¢åŠ çš„çº¿ç¨‹ï¼Œé‚£ä¹ˆè¯¥å‡½æ•°åœ¨è¿”å›å‰å°†å”¤é†’æœ€å…ˆå¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ã€‚</p>
<p>è¿”å›å€¼ï¼šThis function returns non-zero if a thread is woken. Otherwise, zero is returnedã€‚å¦‚æœæœ‰çº¿ç¨‹è¢«å”¤é†’åˆ™è¿”å›ä¸€ä¸ªé0å€¼ï¼Œå¦åˆ™è¿”å›0ã€‚</p>
</li>
<li><p><code>long waitRs = dispatch_semaphore_wait(semaphoreTask1, DISPATCH_TIME_FOREVER);</code><br>å°†ä¿¡å·é‡-1ã€‚å‡å»1åå¦‚æœå¾—åˆ°çš„å€¼<0ï¼Œåˆ™è¯¥å‡½æ•°åœ¨è¿”å›å‰å°†ä¸€ç›´ç­‰å¾…ä¿¡å·çš„å‘å‡ºï¼Œçº¿ç¨‹ä¼šè¢«é˜»å¡ã€‚å‡å»1åå¦‚æœå¾—åˆ°çš„å€¼>=0ï¼Œåˆ™æ­£å¸¸è¿”å›0ï¼Œä¸é˜»å¡çº¿ç¨‹ã€‚</p>
<p> timeoutï¼šæŒ‡å®šç­‰å¾…çš„æ—¶é—´ã€‚å¦‚æœçº¿ç¨‹è¦è¢«é˜»å¡è¯¥å€¼è¡¨æ˜å°†é˜»å¡è¯¥çº¿ç¨‹å¤šä¹…ã€‚ä¼ DISPATCH_TIME_FOREVERæ„å‘³ç€è¯¥çº¿ç¨‹æ°¸ä¹…ç­‰å¾…ä¸€ä¸ªä¿¡å·çš„å‘å‡ºã€‚ ä¼ ä¸€ä¸ªå…¶ä»–å€¼å¦‚ï¼šdispatch_time(DISPATCH_TIME_NOW, (int64_t)(2 * NSEC_PER_SEC))ï¼Œè¡¨æ˜å°†é˜»å¡è¯¥çº¿ç¨‹2sï¼Œ2såå‡½æ•°å°†è¿”å›ï¼Œçº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼ˆä¸ä¸€å®šå°±æ˜¯æ‰§è¡Œä¸´ç•ŒåŒºçš„ä»£ç ï¼Œå¯ä»¥åˆ¤æ–­å¦‚æœè¿”å›çš„æ˜¯é0è¡¨æ˜æ˜¯ç­‰å¾…è¶…æ—¶äº†å¯ä»¥åšå…¶ä»–å¤„ç†ï¼‰ã€‚</p>
<p>è¿”å›å€¼ï¼šReturns zero on success, or non-zero if the timeout occurredã€‚</p>
</li>
</ol>
<p>eg:ä½¿ç”¨ä¿¡å·é‡æ§åˆ¶å¤šçº¿ç¨‹æ·»åŠ æ•°ç»„å…ƒç´ ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)testSemaphoreLock &#123;</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> globalQueue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *arr = [[<span class="built_in">NSMutableArray</span> alloc] init];</span><br><span class="line">    <span class="keyword">self</span>.semaphoreLock = dispatch_semaphore_create(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">dispatch_async</span>(globalQueue, ^&#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;çº¿ç¨‹ï¼š%@ æ‰§è¡Œ  i = %d&quot;</span>, [<span class="built_in">NSThread</span> currentThread], i);</span><br><span class="line">            <span class="type">long</span> waitRs = dispatch_semaphore_wait(<span class="keyword">self</span>.semaphoreLock, DISPATCH_TIME_FOREVER);</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;çº¿ç¨‹ï¼š%@ï¼Œdispatch_semaphore_wait:%ld&quot;</span>, [<span class="built_in">NSThread</span> currentThread], waitRs);</span><br><span class="line">            <span class="built_in">NSNumber</span> *number = [<span class="built_in">NSNumber</span> numberWithInt:i];</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;çº¿ç¨‹ï¼š%@ï¼Œå°†è¦æ·»åŠ ï¼š%@&quot;</span>, [<span class="built_in">NSThread</span> currentThread], number);</span><br><span class="line">            [arr addObject:number];</span><br><span class="line">            <span class="type">long</span> signalRs = dispatch_semaphore_signal(<span class="keyword">self</span>.semaphoreLock);</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;çº¿ç¨‹ï¼š%@ï¼Œdispatch_semaphore_signal:%ld&quot;</span>, [<span class="built_in">NSThread</span> currentThread], signalRs);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">5</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;count:%ld, %@&quot;</span>,arr.count, arr);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰“å°ï¼š</p>
<figure class="highlight dns"><table><tr><td class="code"><pre><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.043402</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993600</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x6<span class="number">04000468580</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125; æ‰§è¡Œ  i = <span class="number">1</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.043669</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993602</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x60400046df80&gt;&#123;number = <span class="number">4</span>, name = (null)&#125; æ‰§è¡Œ  i = <span class="number">0</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.043674</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993599</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x<span class="number">604000861180</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125; æ‰§è¡Œ  i = <span class="number">2</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.043764</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993601</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x60<span class="number">40008688c0</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125; æ‰§è¡Œ  i = <span class="number">3</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.043824</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993710</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x6<span class="number">00000476f80</span>&gt;&#123;number = <span class="number">7</span>, name = (null)&#125; æ‰§è¡Œ  i = <span class="number">4</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.043892</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993711</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x60<span class="number">00004771c0</span>&gt;&#123;number = <span class="number">9</span>, name = (null)&#125; æ‰§è¡Œ  i = <span class="number">5</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.043892</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993712</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x604<span class="number">00086a3c0</span>&gt;&#123;number = <span class="number">8</span>, name = (null)&#125; æ‰§è¡Œ  i = <span class="number">6</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26:02.044138</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993600</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x6<span class="number">04000468580</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;ï¼Œdispatch_semaphore_wait:<span class="number">0</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.044284</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993713</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x60400086aa00&gt;&#123;number = <span class="number">10</span>, name = (null)&#125; æ‰§è¡Œ  i = <span class="number">7</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.044389</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993715</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x60400086aa40&gt;&#123;number = <span class="number">12</span>, name = (null)&#125; æ‰§è¡Œ  i = <span class="number">9</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.044352</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993714</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x60400086aac0&gt;&#123;number = <span class="number">11</span>, name = (null)&#125; æ‰§è¡Œ  i = <span class="number">8</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.045823</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993600</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x6<span class="number">04000468580</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;ï¼Œå°†è¦æ·»åŠ ï¼š<span class="number">1</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.047405</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993600</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x6<span class="number">04000468580</span>&gt;&#123;number = <span class="number">3</span>, name = (null)&#125;ï¼Œdispatch_semaphore_signal:<span class="number">1</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.047405</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993602</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x60400046df80&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;ï¼Œdispatch_semaphore_wait:<span class="number">0</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.049837</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993602</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x60400046df80&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;ï¼Œå°†è¦æ·»åŠ ï¼š<span class="number">0</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.050684</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993602</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x60400046df80&gt;&#123;number = <span class="number">4</span>, name = (null)&#125;ï¼Œdispatch_semaphore_signal:<span class="number">1</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.050684</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993599</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x<span class="number">604000861180</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125;ï¼Œdispatch_semaphore_wait:<span class="number">0</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26:02.051183</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993599</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x<span class="number">604000861180</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125;ï¼Œå°†è¦æ·»åŠ ï¼š<span class="number">2</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.055352</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993599</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x<span class="number">604000861180</span>&gt;&#123;number = <span class="number">5</span>, name = (null)&#125;ï¼Œdispatch_semaphore_signal:<span class="number">1</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.055352</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993601</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x60<span class="number">40008688c0</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125;ï¼Œdispatch_semaphore_wait:<span class="number">0</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.055915</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993601</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x60<span class="number">40008688c0</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125;ï¼Œå°†è¦æ·»åŠ ï¼š<span class="number">3</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.056057</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993601</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x60<span class="number">40008688c0</span>&gt;&#123;number = <span class="number">6</span>, name = (null)&#125;ï¼Œdispatch_semaphore_signal:<span class="number">1</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.056091</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993710</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x6<span class="number">00000476f80</span>&gt;&#123;number = <span class="number">7</span>, name = (null)&#125;ï¼Œdispatch_semaphore_wait:<span class="number">0</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.056829</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993710</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x6<span class="number">00000476f80</span>&gt;&#123;number = <span class="number">7</span>, name = (null)&#125;ï¼Œå°†è¦æ·»åŠ ï¼š<span class="number">4</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.057543</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993710</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x6<span class="number">00000476f80</span>&gt;&#123;number = <span class="number">7</span>, name = (null)&#125;ï¼Œdispatch_semaphore_signal:<span class="number">1</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.057543</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993711</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x60<span class="number">00004771c0</span>&gt;&#123;number = <span class="number">9</span>, name = (null)&#125;ï¼Œdispatch_semaphore_wait:<span class="number">0</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.058272</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993711</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x60<span class="number">00004771c0</span>&gt;&#123;number = <span class="number">9</span>, name = (null)&#125;ï¼Œå°†è¦æ·»åŠ ï¼š<span class="number">5</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.058587</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993712</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x604<span class="number">00086a3c0</span>&gt;&#123;number = <span class="number">8</span>, name = (null)&#125;ï¼Œdispatch_semaphore_wait:<span class="number">0</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.058612</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993711</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x60<span class="number">00004771c0</span>&gt;&#123;number = <span class="number">9</span>, name = (null)&#125;ï¼Œdispatch_semaphore_signal:<span class="number">1</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.058969</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993712</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x604<span class="number">00086a3c0</span>&gt;&#123;number = <span class="number">8</span>, name = (null)&#125;ï¼Œå°†è¦æ·»åŠ ï¼š<span class="number">6</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.059605</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993712</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x604<span class="number">00086a3c0</span>&gt;&#123;number = <span class="number">8</span>, name = (null)&#125;ï¼Œdispatch_semaphore_signal:<span class="number">1</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.059675</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993713</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x60400086aa00&gt;&#123;number = <span class="number">10</span>, name = (null)&#125;ï¼Œdispatch_semaphore_wait:<span class="number">0</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.060750</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993713</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x60400086aa00&gt;&#123;number = <span class="number">10</span>, name = (null)&#125;ï¼Œå°†è¦æ·»åŠ ï¼š<span class="number">7</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.061001</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993713</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x60400086aa00&gt;&#123;number = <span class="number">10</span>, name = (null)&#125;ï¼Œdispatch_semaphore_signal:<span class="number">1</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.061034</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993714</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x60400086aac0&gt;&#123;number = <span class="number">11</span>, name = (null)&#125;ï¼Œdispatch_semaphore_wait:<span class="number">0</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.061310</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993714</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x60400086aac0&gt;&#123;number = <span class="number">11</span>, name = (null)&#125;ï¼Œå°†è¦æ·»åŠ ï¼š<span class="number">8</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.061667</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993714</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x60400086aac0&gt;&#123;number = <span class="number">11</span>, name = (null)&#125;ï¼Œdispatch_semaphore_signal:<span class="number">1</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.061686</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993715</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x60400086aa40&gt;&#123;number = <span class="number">12</span>, name = (null)&#125;ï¼Œdispatch_semaphore_wait:<span class="number">0</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26:02.062198</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993715</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x60400086aa40&gt;&#123;number = <span class="number">12</span>, name = (null)&#125;ï¼Œå°†è¦æ·»åŠ ï¼š<span class="number">9</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">02.062506</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993715</span>] çº¿ç¨‹ï¼š&lt;NSThread: <span class="number">0</span>x60400086aa40&gt;&#123;number = <span class="number">12</span>, name = (null)&#125;ï¼Œdispatch_semaphore_signal:<span class="number">0</span></span><br><span class="line"><span class="number">2020-06-04</span> <span class="number">22</span>:<span class="number">26</span>:<span class="number">07.043709</span>+<span class="number">0800</span> multithreadDemo[<span class="number">71599</span>:<span class="number">7993539</span>] count:<span class="number">10</span>, (</span><br><span class="line">    <span class="number">1</span>,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    <span class="number">2</span>,</span><br><span class="line">    <span class="number">3</span>,</span><br><span class="line">    <span class="number">4</span>,</span><br><span class="line">    <span class="number">5</span>,</span><br><span class="line">    <span class="number">6</span>,</span><br><span class="line">    <span class="number">7</span>,</span><br><span class="line">    <span class="number">8</span>,</span><br><span class="line">    <span class="number">9</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>ä»æ‰“å°å¯ä»¥çœ‹åˆ°dispatch_semaphore_create(1)ä¿è¯äº†åŒä¸€æ—¶åˆ»ä»…æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®ä¸´ç•ŒåŒºã€‚ä¸è¿‡ä¸Šè¿°æ•°ç»„ä¸­æ·»åŠ çš„å…ƒç´ é¡ºåºä¸æ˜¯ä¾æ¬¡çš„ã€‚</p>
<h4 id="åº”ç”¨åœºæ™¯"><a href="#åº”ç”¨åœºæ™¯" class="headerlink" title="åº”ç”¨åœºæ™¯"></a>åº”ç”¨åœºæ™¯</h4><p>è¿›è¡Œçº¿ç¨‹åŒæ­¥ã€æ§åˆ¶çº¿ç¨‹çš„å¹¶å‘æ•°é‡ã€‚</p>
<p>egï¼šæ§åˆ¶ç½‘ç»œè¯·æ±‚çš„æ‰§è¡Œé¡ºåºã€‚</p>
<blockquote>
<p>Qï¼šæƒ³è®©è¯·æ±‚1å®Œæˆä¹‹åï¼Œå†è¿›è¡Œç½‘ç»œè¯·æ±‚2ï¼Œç„¶åè¿›è¡Œç½‘ç»œè¯·æ±‚Nï¼Œè¦æ±‚ä¸èƒ½é˜»å¡ä¸»çº¿ç¨‹ã€‚</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)testSemaphoreLock &#123;</span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;currentThread:%@&quot;</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        </span><br><span class="line">        dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        [<span class="keyword">self</span> requestSomethingWithN:<span class="number">40</span> completion:^(<span class="built_in">NSInteger</span> result) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;40 rs = %ld&quot;</span>, (<span class="type">long</span>)result);</span><br><span class="line">            dispatch_semaphore_signal(semaphore);</span><br><span class="line">        &#125;];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;===1&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//é˜»å¡ä½å­çº¿ç¨‹</span></span><br><span class="line">        dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;===2&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        [<span class="keyword">self</span> requestSomethingWithN:<span class="number">41</span> completion:^(<span class="built_in">NSInteger</span> result) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;41 rs = %ld&quot;</span>, (<span class="type">long</span>)result);</span><br><span class="line">            dispatch_semaphore_signal(semaphore);</span><br><span class="line">        &#125;];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;===3&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;===4&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        [<span class="keyword">self</span> requestSomethingWithN:<span class="number">42</span> completion:^(<span class="built_in">NSInteger</span> result) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;42 rs = %ld&quot;</span>, (<span class="type">long</span>)result);</span><br><span class="line">            dispatch_semaphore_signal(semaphore);</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸è¿‡ä¸Šé¢çš„æƒ…æ™¯ä¹Ÿå¯ä»¥ç›´æ¥åœ¨è¯·æ±‚å®Œæˆblocké‡Œå†å‘èµ·è¯·æ±‚ï¼Œä¿¡å·é‡éƒ½ä¸éœ€è¦äº†ã€‚å¯ä»¥çœ‹ä¸€ä¸ªç¨å¾®å¤æ‚ç‚¹çš„ï¼š</p>
<blockquote>
<p>Qï¼šè¯·æ±‚Aå’Œè¯·æ±‚BåŒæ—¶å‘èµ·ï¼Œä½†éœ€è¦äºŒè€…éƒ½å®Œæˆåå†å‘èµ·è¯·æ±‚Cã€‚è¦æ±‚ä¸èƒ½é˜»å¡ä¸»çº¿ç¨‹ï¼Œä»…ä½¿ç”¨ä¿¡å·é‡å®Œæˆã€‚</p>
</blockquote>
<p>è¿™ä¸ªå¦‚æœä½¿ç”¨dispatch_group_notifyå†é…åˆ<code>dispatch_group_enter/leave</code>å°±å¾ˆç®€å•ï¼Œä½†å¦‚æœä»…ä½¿ç”¨ä¿¡å·é‡è¯¥æ€ä¹ˆå®ç°å‘¢ï¼Ÿ</p>
<p>åªéœ€è¦åœ¨è¯·æ±‚Cå‘èµ·å‰ï¼Œwaitä¸¤æ¬¡é˜»å¡ä½å­çº¿ç¨‹ï¼Œè¯·æ±‚ABå®Œæˆåå‘å‡ºä¿¡å·å³å¯ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)testSemaphoreLock &#123;</span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;currentThread:%@&quot;</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">        </span><br><span class="line">        dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        __block <span class="built_in">NSInteger</span> rs1 = <span class="number">0</span>;</span><br><span class="line">        [<span class="keyword">self</span> requestSomethingWithN:<span class="number">40</span> completion:^(<span class="built_in">NSInteger</span> result) &#123;</span><br><span class="line">            rs1 = result;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;40 rs = %ld&quot;</span>, (<span class="type">long</span>)result);</span><br><span class="line">            dispatch_semaphore_signal(semaphore);</span><br><span class="line">        &#125;];</span><br><span class="line">        </span><br><span class="line">        __block <span class="built_in">NSInteger</span> rs2 = <span class="number">0</span>;</span><br><span class="line">        [<span class="keyword">self</span> requestSomethingWithN:<span class="number">41</span> completion:^(<span class="built_in">NSInteger</span> result) &#123;</span><br><span class="line">            rs2 = result;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;41 rs = %ld&quot;</span>, (<span class="type">long</span>)result);</span><br><span class="line">            dispatch_semaphore_signal(semaphore);</span><br><span class="line">        &#125;];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;===1&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;===2&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;===3&quot;</span>);</span><br><span class="line">        [<span class="keyword">self</span> requestSomethingWithN:<span class="number">42</span> completion:^(<span class="built_in">NSInteger</span> result) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;42 rs = %ld&quot;</span>, (<span class="type">long</span>)result);</span><br><span class="line">            <span class="built_in">NSInteger</span> total = rs1 + rs2 + result;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;totalï¼š%ld&quot;</span>, (<span class="type">long</span>)total);</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„äº‹é¡¹ï¼š</p>
<ul>
<li>dispatch_semaphore_signal() ä¸ dispatch_semaphore_wait() å¿…é¡»é…å¯¹ä½¿ç”¨ï¼Œå¦åˆ™åœ¨ä¿¡å·é‡é”€æ¯æ—¶å®¹æ˜“å¯¼è‡´<code>EXC_BAD_INSTRUCTION</code>å´©æºƒã€‚</li>
</ul>
<h4 id="é‡Šç–‘"><a href="#é‡Šç–‘" class="headerlink" title="é‡Šç–‘"></a>é‡Šç–‘</h4><p><strong>1. ä¿¡å·é‡ä¼šå‡ä¸ºè´Ÿæ•°å—ï¼Ÿä¼šå‡ä¸º-2ï¼Œ-3â€¦å—ï¼Ÿ</strong></p>
<p>ç»“è®ºï¼šä¼šï¼Œå¦‚æœå¾ˆå¤šçº¿ç¨‹è°ƒç”¨waitçš„è¯ï¼Œä¿¡å·é‡çš„å€¼ä¼šä¸€ç›´å‡ã€‚ä½†å¯¹äºwaitè¶…æ—¶è¿”å›çš„æƒ…å†µï¼Œç³»ç»Ÿä¼šè¿›è¡Œ+1æ“ä½œã€‚</p>
<p>ä»¥å‰ä¸€ç›´ä»¥ä¸ºä¿¡å·é‡å‡åˆ°0å°±ä¸ä¼šå†å‡äº†ï¼Œå…¶å®ä¸ç„¶ã€‚</p>
<p>é€šè¿‡poå¯ä»¥æŸ¥çœ‹ä¿¡å·é‡çš„å€¼ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">(lldb) po self.semaphoreLock</span><br><span class="line"><span class="tag">&lt;<span class="name">OS_dispatch_semaphore:</span> <span class="attr">semaphore</span>[<span class="attr">0x6000024960d0</span>] = <span class="string">&#123;</span> <span class="attr">xref</span> = <span class="string">4,</span> <span class="attr">ref</span> = <span class="string">1,</span> <span class="attr">port</span> = <span class="string">0x2403,</span> <span class="attr">value</span> = <span class="string">-3,</span> <span class="attr">orig</span> = <span class="string">1</span> &#125;&gt;</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥è®¾è®¡ä¸€ä¸ªæµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">self</span>.semaphoreLock = dispatch_semaphore_create(<span class="number">1</span>); </span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;---&quot;</span>);    <span class="comment">//è¿™é‡Œpoæ—¶ï¼Œvalue = 1</span></span><br><span class="line">dispatch_semaphore_wait(<span class="keyword">self</span>.semaphoreLock, DISPATCH_TIME_FOREVER); </span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;---&quot;</span>);    <span class="comment">//è¿™é‡Œpoæ—¶ï¼Œvalue = 0</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">3</span>; i++) &#123;</span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">        dispatch_time_t time = dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">3</span> * i * <span class="built_in">NSEC_PER_SEC</span>));</span><br><span class="line">        dispatch_semaphore_wait(<span class="keyword">self</span>.semaphoreLock, time);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">2</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;---&quot;</span>); <span class="comment">//è¿™é‡Œpoæ—¶ï¼Œvalue = -3ï¼Œå› ä¸ºä¸Šé¢å‡äº†ä¸‰æ¬¡ã€‚</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">12</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;---&quot;</span>); <span class="comment">//è¿™é‡Œpoæ—¶ï¼Œç”±äºä¸Šé¢ä¸‰æ¬¡waitè¶…æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨+1ä¸‰æ¬¡ï¼Œæ‰€ä»¥æœ€ç»ˆvalue = 0</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>ç†è§£äº†ä¿¡å·çš„å®ç°åŸç†ï¼Œä¸Šè¿°ä»£ç å°±å¾ˆå®¹æ˜“ç†è§£ã€‚</p>
<p><strong>2. dispatch_semaphore_signal() ä¸ dispatch_semaphore_wait() ä¸é…å¯¹ä¼šå¯¼è‡´ä»€ä¹ˆé—®é¢˜ï¼Ÿ</strong></p>
<p>ä»åº•å±‚å®ç°æ¥çœ‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">signalæ—¶çš„åˆ¤æ–­</span><br><span class="line"><span class="keyword">if</span> (unlikely(value == LONG_MIN)) &#123;</span><br><span class="line">  DISPATCH_CLIENT_CRASH(value,</span><br><span class="line">      <span class="string">&quot;Unbalanced call to dispatch_semaphore_signal()&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">é”€æ¯æ—¶çš„åˆ¤æ–­</span><br><span class="line"><span class="keyword">if</span> (dsema-&gt;dsema_value &lt; dsema-&gt;dsema_orig) &#123;</span><br><span class="line">  DISPATCH_CLIENT_CRASH(dsema-&gt;dsema_orig - dsema-&gt;dsema_value,</span><br><span class="line">      <span class="string">&quot;Semaphore object deallocated while in use&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1.ä¸èƒ½è¿‡åº¦waitï¼Œå¯¼è‡´è®¡æ•°å€¼å˜æˆLONG_MINï¼Œè¿™ä¸ªä¸€èˆ¬ä¸ä¼šå‡ºç°ã€‚</p>
<p>2.ä¿è¯signalçš„æ¬¡æ•°è¦&gt;=waitçš„æ¬¡æ•°ï¼Œå¦åˆ™ä¿¡å·é‡åœ¨é”€æ¯æ—¶ä¼šäº§ç”Ÿå´©æºƒã€‚</p>
<p>ä¸ºäº†é¿å…ä¸Šè¿°å´©æºƒï¼Œåº”è¯¥è®©signalå’Œwaitä¿æŒé…å¯¹ã€‚è¿™é‡Œå¤šsignalè²Œä¼¼ä¹Ÿæ²¡å•¥é—®é¢˜ã€‚</p>
<p><strong>3. å¤šçº¿ç¨‹è°ƒç”¨dispatch_semaphore_signal/waitä¸ºå•¥ä¸ä¼šå¯¼è‡´çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ</strong></p>
<p>å› ä¸ºdispatch_semaphore_signal/waité‡Œé¢æ“ä½œä¿¡å·é‡è®¡æ•°å€¼æ—¶æ˜¯åŸå­æ“ä½œçš„ã€‚</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> value = <span class="built_in">os_atomic_inc2o</span>(dsema, dsema_value, release); <span class="comment">//signal</span></span><br><span class="line"><span class="type">long</span> value = <span class="built_in">os_atomic_dec2o</span>(dsema, dsema_value, acquire); <span class="comment">//wait</span></span><br></pre></td></tr></table></figure>
<p><strong>4. ä¿¡å·é‡å˜ä¸º-3 åï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å‘é€ä¿¡å·è¿˜èƒ½å”¤é†’ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹å—ï¼Ÿ</strong></p>
<p>å¯ä»¥ã€‚dispatch_semaphore_signalçš„ä½œç”¨å°±æ˜¯å°†ä¿¡å·é‡+1ï¼Œå¦‚æœåŠ 1åä¿¡å·é‡è¿˜æ˜¯&lt;=0ï¼Œè¯´æ˜æœ‰waitçš„çº¿ç¨‹ï¼Œé‚£å°±å”¤é†’æœ€å…ˆç­‰å¾…çš„çº¿ç¨‹ã€‚</p>
<p><strong>5.ä¿¡å·é‡ä¸äº’æ–¥é”çš„åŒºåˆ«</strong></p>
<ol>
<li>äº’æ–¥é”çš„åŠ é”å’Œè§£é”<strong>å¿…é¡»ç”±åŒä¸€çº¿ç¨‹</strong>åˆ†åˆ«å¯¹åº”ä½¿ç”¨ï¼Œä¿¡å·é‡å¯ä»¥ç”±ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¾—åˆ°ã€‚</li>
<li>äº’æ–¥é‡å€¼åªèƒ½ä¸º0/1ï¼Œä¿¡å·é‡å€¼å¯ä»¥ä¸ºéè´Ÿæ•´æ•°ã€‚<strong>é”æ˜¯æœåŠ¡äºå…±äº«èµ„æºçš„ï¼›è€Œsemaphoreæ˜¯æœåŠ¡äºå¤šä¸ªçº¿ç¨‹é—´çš„æ‰§è¡Œçš„é€»è¾‘é¡ºåºçš„ã€‚</strong>semaphoreçš„æœ¬è´¨å°±æ˜¯<strong>è°ƒåº¦çº¿ç¨‹</strong>ã€‚</li>
</ol>
<p>ä¸€ä¸ªæœ€å…¸å‹çš„ä½¿ç”¨semaphoreçš„åœºæ™¯ï¼š aæºè‡ªä¸€ä¸ªçº¿ç¨‹ï¼Œbæºè‡ªå¦ä¸€ä¸ªçº¿ç¨‹ï¼Œè®¡ç®—c = a + bä¹Ÿæ˜¯ä¸€ä¸ªçº¿ç¨‹ã€‚ï¼ˆå³ä¸€å…±ä¸‰ä¸ªçº¿ç¨‹ï¼‰</p>
<p>æ˜¾ç„¶ï¼Œç¬¬ä¸‰ä¸ªçº¿ç¨‹å¿…é¡»ç­‰ç¬¬ä¸€ã€äºŒä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•å®ƒæ‰èƒ½æ‰§è¡Œã€‚ åœ¨è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦<strong>è°ƒåº¦çº¿ç¨‹</strong>äº†ï¼šè®©ç¬¬ä¸€ã€äºŒä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•åï¼Œå†æ‰§è¡Œç¬¬ä¸‰ä¸ªçº¿ç¨‹ã€‚ æ­¤æ—¶ï¼Œå°±éœ€è¦ç”¨semaphoreäº†ã€‚</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">int</span> a, b, c;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">geta</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    a = calculatea();</span><br><span class="line">    semaphore_increase();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getb</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    b = calculateb();</span><br><span class="line">    semaphore_increase();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getc</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    semaphore_decrease(); <span class="comment">//çº¿ç¨‹3åœ¨è¿™é‡Œå¯èƒ½ä¼šåœä½ç­‰å¾…</span></span><br><span class="line">    semaphore_decrease(); <span class="comment">//çº¿ç¨‹3åœ¨è¿™é‡Œå¯èƒ½ä¼šåœä½ç­‰å¾…</span></span><br><span class="line">    c = a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">t1 = thread_create(geta);</span><br><span class="line">t2 = thread_create(getb);</span><br><span class="line">t3 = thread_create(getc);</span><br><span class="line">thread_join(t3);</span><br></pre></td></tr></table></figure>
<p>å‚è€ƒï¼š<a href="https://www.cnblogs.com/zzdbullet/p/9822242.html">ä¿¡å·é‡ä¸äº’æ–¥é”çš„åŒºåˆ«</a></p>
]]></content>
      <categories>
        <category>å¤šçº¿ç¨‹</category>
      </categories>
      <tags>
        <tag>ä¿¡å·é‡</tag>
      </tags>
  </entry>
  <entry>
    <title>OC atomicä¿®é¥°ç¬¦</title>
    <url>/2020/06/06/OC-atomic%E4%BF%AE%E9%A5%B0%E7%AC%A6/</url>
    <content><![CDATA[<p>æºç ç‰ˆæœ¬ï¼šobjc4-781ï¼Œ<code>objc-accessors.mm</code>æ–‡ä»¶ä¸­ã€‚</p>
<p>åŸå­æ“ä½œæ˜¯æŒ‡æ“ä½œæ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œè¦ä¹ˆå‘ç”Ÿï¼Œè¦ä¹ˆä¸å‘ç”Ÿã€‚äº‹ç‰©åªä¼šå¤„äºåŸå§‹çŠ¶æ€å’ŒæˆåŠŸçŠ¶æ€ä¸¤ç§ä¸­çš„ä¸€ç§ï¼Œä¸ä¼šå¤„äºä¸€ç§åŠå®ŒæˆçŠ¶æ€ã€‚</p>
<h3 id="OC-ä¸­çš„atomicä¿®é¥°ç¬¦"><a href="#OC-ä¸­çš„atomicä¿®é¥°ç¬¦" class="headerlink" title="OC ä¸­çš„atomicä¿®é¥°ç¬¦"></a>OC ä¸­çš„atomicä¿®é¥°ç¬¦</h3><p>æºç å®ç°ï¼š</p>
<p>getter æ–¹æ³•ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">id <span class="title">objc_getProperty</span><span class="params">(id self, SEL _cmd, <span class="type">ptrdiff_t</span> offset, BOOL atomic)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (offset == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">object_getClass</span>(self);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Retain release world</span></span><br><span class="line">    id *slot = (id*) ((<span class="type">char</span>*)self + offset);</span><br><span class="line">    <span class="keyword">if</span> (!atomic) <span class="keyword">return</span> *slot;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// Atomic retain release world</span></span><br><span class="line">    <span class="type">spinlock_t</span>&amp; slotlock = PropertyLocks[slot];</span><br><span class="line">    slotlock.<span class="built_in">lock</span>();</span><br><span class="line">    id value = <span class="built_in">objc_retain</span>(*slot); <span class="comment">//+1</span></span><br><span class="line">    slotlock.<span class="built_in">unlock</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// for performance, we (safely) issue the autorelease OUTSIDE of the spinlock.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">objc_autoreleaseReturnValue</span>(value); <span class="comment">//æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± ä¸­ï¼Œå»¶è¿Ÿ-1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹äºnone atomicå±æ€§ï¼Œgetteræ–¹æ³•åªæ˜¯ç®€å•çš„è¿”å›å¯¹è±¡åœ°å€ã€‚<br>å¯¹äºatomicå±æ€§ï¼Œgetteræ–¹æ³•ä¼šåŠ é”è¿›è¡Œretainæ“ä½œï¼Œå¹¶è¿”å›ä¸€ä¸ªæ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± é‡Œçš„å¯¹è±¡åœ°å€ã€‚è¿™æ ·å°±å¯ä»¥é˜²æ­¢getterçš„å¯¹è±¡ä¸ä¼šå› ä¸ºå…¶ä»–çº¿ç¨‹çš„setteræ“ä½œå¯¼è‡´é”€æ¯ã€‚</p>
<p>setter æ–¹æ³•ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title">reallySetProperty</span><span class="params">(id self, SEL _cmd, id newValue, <span class="type">ptrdiff_t</span> offset, <span class="type">bool</span> atomic, <span class="type">bool</span> copy, <span class="type">bool</span> mutableCopy)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (offset == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">object_setClass</span>(self, newValue);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    id oldValue;</span><br><span class="line">    id *slot = (id*) ((<span class="type">char</span>*)self + offset);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (copy) &#123;</span><br><span class="line">        newValue = [newValue copyWithZone:nil];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mutableCopy) &#123;</span><br><span class="line">        newValue = [newValue mutableCopyWithZone:nil];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (*slot == newValue) <span class="keyword">return</span>;</span><br><span class="line">        newValue = <span class="built_in">objc_retain</span>(newValue); <span class="comment">//retainæ–°å€¼</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!atomic) &#123;</span><br><span class="line">        oldValue = *slot; <span class="comment">//è·å–æ—§å€¼</span></span><br><span class="line">        *slot = newValue; <span class="comment">//èµ‹äºˆæ–°å€¼</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">spinlock_t</span>&amp; slotlock = PropertyLocks[slot];</span><br><span class="line">        slotlock.<span class="built_in">lock</span>();  </span><br><span class="line">        oldValue = *slot; <span class="comment">//</span></span><br><span class="line">        *slot = newValue;        </span><br><span class="line">        slotlock.<span class="built_in">unlock</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">objc_release</span>(oldValue); <span class="comment">//release æ—§å€¼</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">objc_setProperty_atomic</span><span class="params">(id self, SEL _cmd, id newValue, <span class="type">ptrdiff_t</span> offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">reallySetProperty</span>(self, _cmd, newValue, offset, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">objc_setProperty_nonatomic</span><span class="params">(id self, SEL _cmd, id newValue, <span class="type">ptrdiff_t</span> offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">reallySetProperty</span>(self, _cmd, newValue, offset, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">objc_setProperty_atomic_copy</span><span class="params">(id self, SEL _cmd, id newValue, <span class="type">ptrdiff_t</span> offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">reallySetProperty</span>(self, _cmd, newValue, offset, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">objc_setProperty_nonatomic_copy</span><span class="params">(id self, SEL _cmd, id newValue, <span class="type">ptrdiff_t</span> offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">reallySetProperty</span>(self, _cmd, newValue, offset, <span class="literal">false</span>, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°é”ä»ä½•è€Œæ¥ï¼šä»objc-accessors.mmä¸­å®šä¹‰çš„å…¨å±€PropertyLockså“ˆå¸Œè¡¨ä¸­è·å–ã€‚</p>
<figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">StripedMap&lt;spinlock_t&gt; PropertyLocks<span class="comment">;</span></span><br><span class="line">StripedMap&lt;spinlock_t&gt; StructLocks<span class="comment">;</span></span><br><span class="line">StripedMap&lt;spinlock_t&gt; CppObjectLocks<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ä½¿ç”¨atomicä¿®é¥°çš„å±æ€§ï¼Œç¼–è¯‘å™¨åœ¨åˆæˆgetter/setteræ–¹æ³•æ—¶ï¼Œç›¸æ¯”äºnonatomicçš„å±æ€§ä¼šæœ‰é¢å¤–çš„å¤„ç†ï¼š</p>
<ol>
<li>åŠ é”ï¼ˆè‡ªæ—‹é”ï¼‰ï¼Œä¿è¯åŸå­æ€§ã€‚å…¶ä»–çº¿ç¨‹éœ€è¦ç­‰å¾…ã€‚</li>
<li>getteræ–¹æ³•è·å–åˆ°å¯¹è±¡åä¼šå…ˆretainå†æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± é‡Œæœ€åè¿”å›ç»™è°ƒç”¨è€…ï¼Œç¡®ä¿è°ƒç”¨è€…è·å–åˆ°çš„å¯¹è±¡ç”Ÿå‘½å‘¨æœŸä¸å—åç»­setterå½±å“ã€‚</li>
</ol>
<p><strong>atomicä¿è¯äº†èµ‹å€¼/å–å€¼çš„æ•´ä¸ªè¿‡ç¨‹çš„å®Œæ•´æ€§ï¼Œå¹¶ä¸”ä¸å—å…¶ä»–çº¿ç¨‹çš„å¹²æ‰°</strong>ã€‚æ¯”å¦‚çº¿ç¨‹Aåœ¨setteræ—¶ï¼Œçº¿ç¨‹Bå¦‚æœæƒ³setteré‚£ä¹ˆå°±éœ€è¦ç­‰å¾…ï¼Œçº¿ç¨‹Cæƒ³getterä¹Ÿéœ€è¦ç­‰å¾…ã€‚</p>
<p>å†æ¥çœ‹ä¸€ä¸‹ä½¿ç”¨nonatomicåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä¸‹é¢çš„åœºæ™¯ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼š</p>
<p>1ã€Aï¼ŒBçº¿ç¨‹åŒæ—¶è°ƒç”¨setteræ–¹æ³•ä¼šæ€æ ·ã€‚</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!atomic) &#123;</span><br><span class="line"><span class="number">1</span>    oldValue = *slot; <span class="comment">//è·å–æ—§å€¼</span></span><br><span class="line"><span class="number">2</span>    *slot = newValue; <span class="comment">//èµ‹äºˆæ–°å€¼</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="type">spinlock_t</span>&amp; slotlock = PropertyLocks[slot];</span><br><span class="line">    slotlock.<span class="built_in">lock</span>();  </span><br><span class="line">    oldValue = *slot; <span class="comment">//</span></span><br><span class="line">    *slot = newValue;        </span><br><span class="line">    slotlock.<span class="built_in">unlock</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">3</span> <span class="built_in">objc_release</span>(oldValue); <span class="comment">//release æ—§å€¼</span></span><br></pre></td></tr></table></figure>
<p>Aï¼ŒBåŒæ—¶æ‰§è¡Œ1ï¼Œå› æ­¤è·å¾—äº†åŒä¸€ä¸ªæ—§å€¼å¯¹è±¡ï¼Œç„¶åå„è‡ªæ‰§è¡Œ2å› æ­¤å±æ€§çš„å€¼æ˜¯ä¸ç¡®å®šçš„ï¼ˆè¿™é‡Œå€’æ²¡æœ‰ä»€ä¹ˆè‡´å‘½å…³ç³»ï¼‰ï¼Œæœ€åæ‰§è¡Œ3ï¼Œäºæ˜¯ä¸€ä¸ªå¯¹è±¡è¢«é‡Šæ”¾äº†ä¸¤æ¬¡ï¼Œè¿™æœ‰å¯èƒ½ä¼šå¯¼è‡´é‡æŒ‡é’ˆå´©æºƒã€‚è€Œatomicæœ‰åŠ é”ä¿æŠ¤æ‰€ä»¥ä¸ä¼šæœ‰é—®é¢˜ã€‚</p>
<p>2ã€çº¿ç¨‹Aè°ƒç”¨getteræ–¹æ³•è·å¾—å¯¹è±¡åœ°å€ï¼Œåœ¨å¯¹è±¡ä½¿ç”¨æœŸé—´ï¼Œçº¿ç¨‹Bè°ƒç”¨setteræ–¹æ³•ï¼Œä¼šæ€æ ·ï¼Ÿ</p>
<p>getteræ–¹æ³•å®ç°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">id <span class="title function_">objc_getProperty</span><span class="params">(id self, SEL _cmd, <span class="type">ptrdiff_t</span> offset, BOOL atomic)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (offset == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> object_getClass(self);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Retain release world</span></span><br><span class="line">    id *slot = (id*) ((<span class="type">char</span>*)self + offset);</span><br><span class="line">    <span class="keyword">if</span> (!atomic) <span class="keyword">return</span> *slot;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// Atomic retain release world</span></span><br><span class="line">    <span class="type">spinlock_t</span>&amp; slotlock = PropertyLocks[slot];</span><br><span class="line">    slotlock.lock();</span><br><span class="line">    id value = objc_retain(*slot); <span class="comment">//+1</span></span><br><span class="line">    slotlock.unlock();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// for performance, we (safely) issue the autorelease OUTSIDE of the spinlock.</span></span><br><span class="line">    <span class="keyword">return</span> objc_autoreleaseReturnValue(value);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹äºnonatomicï¼Œgetteræ–¹æ³•è·å–åˆ°æ—§å€¼ååªæ˜¯ç®€å•è¿”å›ã€‚ä¸Šè¿°æƒ…å†µnonatomicå¯èƒ½ä¼šå› ä¸ºçº¿ç¨‹Bè°ƒç”¨setteræ–¹æ³•é‡Šæ”¾æ—§å€¼è€Œé€ æˆçº¿ç¨‹Aæ½œåœ¨çš„é‡æŒ‡é’ˆè®¿é—®å´©æºƒé£é™©ã€‚è€Œatomicä¼šå…ˆretainå†æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± é‡Œæœ€åè¿”å›ç»™è°ƒç”¨è€…ï¼Œå› æ­¤ä¸ä¼šå­˜åœ¨è¿™ç§é£é™©ã€‚</p>
<p>iOS12.5.4 iPhone6plus</p>
<p>ä¾‹1ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/image-20210930112832606.png" alt=""></p>
<p>ä¾‹2ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20210930112345.png" alt=""></p>
<p>è¿™äº›éƒ½æ˜¯é‡æŒ‡é’ˆå´©æºƒï¼Œè®¿é—®äº†å·²ç»é”€æ¯çš„å¯¹è±¡ã€‚</p>
<p>å› æ­¤å¦‚æœå±æ€§å­˜åœ¨å¤šçº¿ç¨‹è®¿é—®çš„æƒ…å†µï¼Œåº”è¯¥ä½¿ç”¨atomicå¹¶ä½¿ç”¨å­˜å–å™¨è®¿é—®å®ä¾‹å˜é‡ï¼Œå¦‚æœæœ‰éœ€è¦è¿˜åº”è¯¥é…åˆé”ä½¿ç”¨ã€‚</p>
<p>æ³¨æ„ï¼šatomicæ— æ³•ä¿è¯å¯¹è±¡è‡ªèº«çš„çº¿ç¨‹å®‰å…¨ã€‚</p>
<p>å®˜æ–¹æ–‡æ¡£å¯¹atomicæ— æ³•ä¿è¯å¯¹è±¡çš„çº¿ç¨‹å®‰å…¨ä¸¾çš„ä¾‹å­ï¼š</p>
<p>è€ƒè™‘XYZPersonï¼Œæ‹¥æœ‰firstNameå’ŒlastNameä¸¤ä¸ªatomicå±æ€§ã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹Aæ­£åœ¨ä¿®æ”¹è¿™ä¸¤ä¸ªå±æ€§ï¼Œä¸æ­¤åŒæ—¶å¦ä¸€ä¸ªçº¿ç¨‹Bæ­£åœ¨è¯»å–è¿™ä¸¤ä¸ªå±æ€§ï¼Œé‚£ä¹ˆçº¿ç¨‹Bå¾—åˆ°çš„firstNameå’ŒlastNameçš„å€¼å°†ä¼šå‘ç”Ÿæ•°æ®ä¸åŒ¹é…çš„æƒ…å†µã€‚è¿™è™½ç„¶ä¸ä¼šå¯¼è‡´å´©æºƒé—®é¢˜ï¼Œä½†ç»“æœæ˜¯ä¸ç¬¦åˆé¢„æœŸçš„ã€‚</p>
<p>egï¼š</p>
<p>åˆå§‹æ—¶, firstName = @â€æâ€;  lastName = @â€å››â€;</p>
<p>çº¿ç¨‹Aæƒ³ä¿®æ”¹ä¸ºï¼šfirstName = @â€å¼ â€;  lastName = @â€ä¸‰â€;</p>
<p>ä¸æ­¤åŒæ—¶çº¿ç¨‹Båœ¨è¯»å–è¿™ä¸¤ä¸ªå±æ€§ï¼Œé‚£ä¹ˆçº¿ç¨‹Bæœ‰å¯èƒ½å¾—åˆ°ï¼š</p>
<p>å¼ å››ï¼Œæä¸‰ã€‚</p>
<p>è¦æƒ³è§£å†³çš„è¯å°±åº”è¯¥æŠŠ<code>firstName = @&quot;å¼ &quot;;  lastName = @&quot;ä¸‰&quot;;</code>è¿™ä¸€æ®µä»£ç ä¹ŸåŠ é”ã€‚</p>
<p>å¦å¤–ä¸€ä¸ªä¾‹å­ï¼šç»å…¸çš„i++é—®é¢˜ã€‚</p>
<p>i++å¯¹åº”çš„æ±‡ç¼–ï¼š</p>
<figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line"><span class="number">0x100368d83</span> &lt;<span class="number">+19</span>&gt;: movl   <span class="number">-0</span><span class="keyword">x</span><span class="number">14</span>(<span class="variable">%rbp</span>)<span class="punctuation">,</span> <span class="variable">%eax</span></span><br><span class="line"><span class="number">0x100368d86</span> &lt;<span class="number">+22</span>&gt;: addl   $<span class="number">0x1</span><span class="punctuation">,</span> <span class="variable">%eax</span></span><br><span class="line"><span class="number">0x100368d89</span> &lt;<span class="number">+25</span>&gt;: movl   <span class="variable">%eax</span><span class="punctuation">,</span> <span class="number">-0</span><span class="keyword">x</span><span class="number">14</span>(<span class="variable">%rbp</span>)</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå®Œæˆä¸€æ¬¡<code>i++</code>æ€»å…±åˆ†ä¸ºä¸‰æ­¥ï¼š</p>
<ul>
<li>ä»å†…å­˜ä¸­å–å‡º<code>i</code>çš„å€¼å­˜æ”¾åˆ°å¯„å­˜å™¨ä¸Š</li>
<li>å¯¹å¯„å­˜å™¨çš„å€¼<code>+1</code></li>
<li>å°†å¯„å­˜å™¨ä¸­çš„å€¼å­˜æ”¾å›<code>i</code>çš„å†…å­˜</li>
</ul>
<p>ç”±äºéœ€è¦ä¸‰æ¡æŒ‡ä»¤ï¼Œå› æ­¤åœ¨å¤šçº¿ç¨‹ä¸­æ˜¯ä¸å®‰å…¨çš„ã€‚æ¯”å¦‚çº¿ç¨‹Aåœ¨æ‰§è¡Œç¬¬äºŒæ­¥æ—¶ï¼Œçº¿ç¨‹Båˆšå¥½åœ¨æ‰§è¡Œç¬¬ä¸€æ­¥ï¼Œæ­¤æ—¶çº¿ç¨‹ B è·å–åˆ°çš„å°†æ˜¯æ—§çš„å€¼ï¼Œæœ€ç»ˆiçš„å€¼å°†åªåŠ äº†ä¸€æ¬¡ã€‚</p>
<p>å†æ¥çœ‹ä¸€ä¸‹OC ä¸­<code>self.i++;</code>çš„æ±‡ç¼–ï¼Œi ä¸º atomic å±æ€§ã€‚</p>
<p>æºç ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)test_atomic_xiushi &#123;</span><br><span class="line">    <span class="keyword">self</span>.i++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹åº”çš„æ±‡ç¼–ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">multithreadDemo`-[XQLockViewController test_atomic_xiushi]:</span><br><span class="line">    0x101c90d60 &lt;+0&gt;:  pushq  %rbp</span><br><span class="line">    0x101c90d61 &lt;+1&gt;:  movq   %rsp, %rbp</span><br><span class="line">    0x101c90d64 &lt;+4&gt;:  subq   $0x20, %rsp</span><br><span class="line">    0x101c90d68 &lt;+8&gt;:  movq   %rdi, -0x8(%rbp)</span><br><span class="line">    0x101c90d6c &lt;+12&gt;: movq   %rsi, -0x10(%rbp)</span><br><span class="line">    0x101c90d70 &lt;+16&gt;: movq   -0x8(%rbp), %rax</span><br><span class="line">    0x101c90d74 &lt;+20&gt;: movq   0x155f5(%rip), %rsi       ; &quot;&#x27;i&#x27;&quot;</span><br><span class="line">    0x101c90d7b &lt;+27&gt;: movq   %rax, %rcx</span><br><span class="line">    0x101c90d7e &lt;+30&gt;: movq   %rcx, %rdi</span><br><span class="line">    0x101c90d81 &lt;+33&gt;: movq   %rax, -0x18(%rbp)</span><br><span class="line">    0x101c90d85 &lt;+37&gt;: callq  *0xe2b5(%rip)             ; (void *)0x00000001025ec940: objc_msgSend   #è°ƒç”¨objc_msgSend(self, &quot;i&quot;ï¼‰</span><br><span class="line">    0x101c90d8b &lt;+43&gt;: addq   $0x1, %rax	#å°†å¯„å­˜å™¨ä¸­çš„å€¼åŠ  1</span><br><span class="line">    0x101c90d91 &lt;+49&gt;: movq   0x156c8(%rip), %rsi       ; &quot;setI:&quot;</span><br><span class="line">    0x101c90d98 &lt;+56&gt;: movq   -0x18(%rbp), %rcx</span><br><span class="line">    0x101c90d9c &lt;+60&gt;: movq   %rcx, %rdi</span><br><span class="line">    0x101c90d9f &lt;+63&gt;: movq   %rax, %rdx</span><br><span class="line">-&gt;  0x101c90da2 &lt;+66&gt;: callq  *0xe298(%rip)             ; (void *)0x00000001025ec940: objc_msgSend  #è°ƒç”¨objc_msgSend(self, &quot;setI:&quot;, %rdx)</span><br><span class="line">    0x101c90da8 &lt;+72&gt;: addq   $0x20, %rsp</span><br><span class="line">    0x101c90dac &lt;+76&gt;: popq   %rbp</span><br><span class="line">    0x101c90dad &lt;+77&gt;: retq </span><br></pre></td></tr></table></figure>
<p>æ­¥éª¤ï¼š</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>.è°ƒç”¨objc_msgSend(<span class="variable language_">self</span>, <span class="string">&quot;i&quot;</span>);  </span><br><span class="line"></span><br><span class="line"><span class="number">2</span>.æ‰§è¡Œaddq   <span class="variable">$0x1</span>, %rax	<span class="comment">#å°†å¯„å­˜å™¨ä¸­çš„å€¼åŠ  1</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span>.è°ƒç”¨objc_msgSend(<span class="variable language_">self</span>, <span class="string">&quot;setI:&quot;</span>, %rdx);</span><br></pre></td></tr></table></figure>
<p>è·Ÿä¸Šé¢çš„æ™®é€š i++å…¶å®æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡è¿™é‡Œ 1ï¼Œ3 æ‰§è¡Œåˆ° getter/setter æ—¶éƒ½ä¼šåŠ é”ï¼Œä½†é—®é¢˜è¿˜æ˜¯å‡ºåœ¨ç¬¬ 2 æ­¥ã€‚å½“çº¿ç¨‹ A æ­£åœ¨æ‰§è¡Œç¬¬2æ­¥è¿˜æ²¡æ¥å¾—åŠæ‰§è¡Œç¬¬ 3 æ­¥å°†å€¼å†™å…¥å†…å­˜æ—¶ï¼Œçº¿ç¨‹ B æ˜¯å¯ä»¥æ‰§è¡Œç¬¬ 1 æ­¥çš„ï¼Œæ­¤æ—¶çº¿ç¨‹ B å°†è·å–åˆ°æ—§çš„å€¼ã€‚äºæ˜¯æœ€ç»ˆåªåŠ äº†ä¸€æ¬¡ã€‚è¦æƒ³çº¿ç¨‹å®‰å…¨å¿…é¡»å°† 1ï¼Œ2ï¼Œ3éƒ½åŒ…åœ¨é”å†… ã€‚</p>
<p>å³ï¼š</p>
<figure class="highlight brainfuck"><table><tr><td class="code"><pre><span class="line"><span class="comment">åŠ é”</span></span><br><span class="line"><span class="comment">self</span><span class="string">.</span><span class="comment">i</span><span class="literal">++</span><span class="comment">;</span></span><br><span class="line"><span class="comment">è§£é”</span></span><br></pre></td></tr></table></figure>
<p>å› æ­¤å³ä½¿æ˜¯atomicçš„å±æ€§ä¹Ÿæ˜¯ä¸èƒ½ä¿è¯ä¸Šè¿°ä»£ç æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p><strong>atomicåªæ˜¯ä¿è¯äº†è®¾å€¼/å–å€¼çš„è¿‡ç¨‹æ˜¯å®Œæ•´çš„ï¼Œä¸å—å…¶ä»–çº¿ç¨‹çš„å¹²æ‰°ã€‚å®ƒæ— æ³•ä¿è¯å…¶ä»–ä½¿ç”¨é€»è¾‘æ˜¯çº¿ç¨‹å®‰å…¨çš„</strong>ã€‚</p>
<p>æ¯”å¦‚ä¸Šé¢çš„i++æ“ä½œã€‚</p>
<p>åœºæ™¯ï¼š ä½¿ç”¨<code>atomic</code>ä¿®é¥°å±æ€§ï¼Œå¦‚æœæœ‰Aã€Bå’ŒCä¸‰ä¸ªçº¿ç¨‹ã€‚å…¶ä¸­Aå’ŒBçº¿ç¨‹åŒæ—¶å¯¹ä¸€ä¸ªå±æ€§è¿›è¡Œèµ‹å€¼æ“ä½œï¼ŒCçº¿ç¨‹è¿›è¡Œå–å€¼æ“ä½œï¼Œé‚£ä¹ˆå¯ä»¥ä¿è¯Cçº¿ç¨‹ä¸€å®šå¯ä»¥å–åˆ°ä¸€ä¸ªå®Œæ•´çš„å€¼ï¼Œä½†æ˜¯è¿™ä¸ªå€¼çš„å†…å®¹å¯èƒ½æ˜¯Açº¿ç¨‹èµ‹çš„å€¼ï¼Œä¹Ÿå¯èƒ½æ˜¯Bçº¿ç¨‹èµ‹çš„å€¼ï¼Œä¹Ÿå¯èƒ½æ˜¯åŸå§‹å€¼ï¼Œè™½ç„¶å–å¾—äº†å®Œæ•´çš„å€¼ï¼Œä½†æ˜¯è¿™ä¸ªå€¼ä¸ä¸€å®šæ˜¯ç¨‹åºå‘˜æƒ³è¦çš„ï¼Œæ‰€ä»¥è¯´<code>atomic</code>å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå®ƒåªæ˜¯ä¿è¯äº†å±æ€§çš„setterå’Œgetteræ–¹æ³•å†…éƒ¨æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å¦‚æœä½ æƒ³è¦çœŸæ­£ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œé‚£ä¹ˆéœ€è¦åœ¨èµ‹å€¼æ“ä½œçš„å‰åè¿›è¡ŒåŠ é”å’Œè§£é”æ“ä½œï¼Œè¿˜æœ‰æ³¨æ„ä½¿ç”¨åŒä¸€æŠŠé”ã€‚</p>
<p>æœ‰æ²¡æœ‰ä»…ä½¿ç”¨atomicå°±èƒ½å¤Ÿæ»¡è¶³è¦æ±‚çš„åœºæ™¯ï¼Ÿæˆ‘æƒ³è±¡ä¸åˆ°ï¼Œå¦‚æœä½ åªéœ€è¦å±æ€§å­˜å–çº¿ç¨‹å®‰å…¨ï¼Œæˆ–è®¸ä»…ä½¿ç”¨atomicå°±å¯ä»¥äº†ã€‚æ¯”å¦‚ä¸Šé¢ä½¿ç”¨atomicå°±å¯ä»¥é¿å…å¤šçº¿ç¨‹ä¸‹çš„é‡æŒ‡é’ˆé—®é¢˜ã€‚å› æ­¤atomicçš„ä½¿ç”¨åœºæ™¯æœ‰é™ã€‚</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://sindrilin.com/2017/09/09/thread_safe.html">å¤šçº¿ç¨‹-çº¿ç¨‹å®‰å…¨</a></p>
<p><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ProgrammingWithObjectiveC/EncapsulatingData/EncapsulatingData.html#//apple_ref/doc/uid/TP40011210-CH5-SW37">Properties Are Atomic by Default</a>  å®˜æ–¹æ–‡æ¡£</p>
<p><a href="https://juejin.cn/post/6844904072475049992">OC åŸºç¡€ä¹‹atomicå’Œnonatomicå…³é”®å­—</a></p>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
      <tags>
        <tag>atomic</tag>
      </tags>
  </entry>
  <entry>
    <title>OCå†…å­˜ç®¡ç†ä¹‹è‡ªåŠ¨é‡Šæ”¾æ± å®ç°åŸç†</title>
    <url>/2020/05/22/OC%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E4%B9%8B%E8%87%AA%E5%8A%A8%E9%87%8A%E6%94%BE%E6%B1%A0%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<p>æ•´äº†8ä¸ªå°æ—¶ï¼ŒåŸºæœ¬ä¸Šç®—æ•´æ˜ç™½äº†ã€‚</p>
<p>ç¯å¢ƒï¼š</p>
<p><a href="https://opensource.apple.com/source/objc4/objc4-781/runtime/NSObject.mm.auto.html">NSObject.mmæºç </a> ç‰ˆæœ¬ä¸ºobjc4-781ã€‚</p>
<p>å¯¹ä»£ç </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> * argv[])</span> &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        NSLog(@<span class="string">&quot;Hello, World!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿›è¡Œ</p>
<figure class="highlight coq"><table><tr><td class="code"><pre><span class="line">clang -<span class="built_in">rewrite</span>-objc main.m</span><br></pre></td></tr></table></figure>
<p>å¾—åˆ°</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* @autoreleasepool */</span> </span><br><span class="line">    &#123; </span><br><span class="line">    __AtAutoreleasePool __autoreleasepool; </span><br><span class="line">        <span class="built_in">NSLog</span>((NSString *)&amp;__NSConstantStringImpl__var_folders_46_lys08y0137d41lbysrxxd0h80000gn_T_main_8ccfab_mi_0);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çœ‹ä¸€ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllimport) <span class="type">void</span> * <span class="title function_">objc_autoreleasePoolPush</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllimport) <span class="type">void</span> <span class="title function_">objc_autoreleasePoolPop</span><span class="params">(<span class="type">void</span> *)</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">AtAutoreleasePool</span> &#123;</span></span><br><span class="line">  __AtAutoreleasePool() &#123;atautoreleasepoolobj = objc_autoreleasePoolPush();&#125;</span><br><span class="line">  ~__AtAutoreleasePool() &#123;objc_autoreleasePoolPop(atautoreleasepoolobj);&#125;</span><br><span class="line">  <span class="type">void</span> * atautoreleasepoolobj;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>é‡Œé¢æœ‰ä¸€ä¸ªæ„é€ å‡½æ•°<code>__AtAutoreleasePool()</code>å’Œä¸€ä¸ªææ„å‡½æ•°<code>~__AtAutoreleasePool()</code>ã€‚</p>
<p>ä¸Šè¿°ä»£ç ç­‰ä»·äºï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> * argv[])</span> &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">void</span> * atautoreleasepoolobj = objc_autoreleasePoolPush();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// do whatever you want</span></span><br><span class="line"></span><br><span class="line">        objc_autoreleasePoolPop(atautoreleasepoolobj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1.è·å–å½“å‰è‡ªåŠ¨é‡Šæ”¾æ± çš„å“¨å…µå¯¹è±¡çš„æŒ‡é’ˆ 2.æŠŠå½“å‰è‡ªåŠ¨é‡Šæ”¾æ± é‡Œçš„è‡ªåŠ¨é‡Šæ”¾å¯¹è±¡æ¸…ç©ºç›´åˆ°å“¨å…µå¯¹è±¡ä¸ºæ­¢ã€‚</p>
<p>å³ä½ æ¯æ¬¡å†™@autoreleasepool </p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(@&quot;Hello, World!&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å°±ç­‰ä»·äº:ä¸€å¯¹èŠ±æ‹¬å·ï¼Œä¸ŠèŠ±æ‹¬å·ç´§æ¥ç€çš„æ˜¯objc_autoreleasePoolPushæ“ä½œï¼Œä¸‹æ‹¬å·ä¸Šé¢ç´§æ¥ç€çš„æ˜¯objc_autoreleasePoolPopæ“ä½œã€‚</p>
<figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    void * atautoreleasepoolobj <span class="operator">=</span> objc_autoreleasePoolPush()<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    // do whatever you want</span><br><span class="line"></span><br><span class="line">    objc_autoreleasePoolPop(atautoreleasepoolobj)<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è®°ä½è¿™ä¸€ç‚¹å¾ˆé‡è¦ã€‚</p>
<p>ä¸Šè¿°ä¸¤ä¸ªå‡½æ•°çš„å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> *</span><br><span class="line"><span class="title function_">objc_autoreleasePoolPush</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> AutoreleasePoolPage::push();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NEVER_INLINE</span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">objc_autoreleasePoolPop</span><span class="params">(<span class="type">void</span> *ctxt)</span></span><br><span class="line">&#123;</span><br><span class="line">    AutoreleasePoolPage::pop(ctxt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AutoreleasePoolPageç»“æ„"><a href="#AutoreleasePoolPageç»“æ„" class="headerlink" title="AutoreleasePoolPageç»“æ„"></a>AutoreleasePoolPageç»“æ„</h3><p>AutoreleasePoolPageçš„å®ç°æ³¨è§£ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">   Autorelease pool implementation</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   A thread&#x27;s autorelease pool is a stack of pointers. </span></span><br><span class="line"><span class="comment">   Each pointer is either an object to release, or POOL_BOUNDARY which is </span></span><br><span class="line"><span class="comment">     an autorelease pool boundary.</span></span><br><span class="line"><span class="comment">   A pool token is a pointer to the POOL_BOUNDARY for that pool. When </span></span><br><span class="line"><span class="comment">     the pool is popped, every object hotter than the sentinel is released.</span></span><br><span class="line"><span class="comment">   The stack is divided into a doubly-linked list of pages. Pages are added </span></span><br><span class="line"><span class="comment">     and deleted as necessary. </span></span><br><span class="line"><span class="comment">   Thread-local storage points to the hot page, where newly autoreleased </span></span><br><span class="line"><span class="comment">     objects are stored. </span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AutoreleasePoolPage</span> : <span class="keyword">private</span> AutoreleasePoolPageData </span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">friend</span> <span class="keyword">struct</span> <span class="title class_">thread_data_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="type">static</span> <span class="type">size_t</span> <span class="type">const</span> SIZE =</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> PROTECT_AUTORELEASEPOOL</span></span><br><span class="line">		PAGE_MAX_SIZE;  <span class="comment">// must be multiple of vm page size</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">		PAGE_MIN_SIZE;  <span class="comment">// size and alignment, power of 2 //4KB</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="type">static</span> <span class="type">pthread_key_t</span> <span class="type">const</span> key = AUTORELEASE_POOL_KEY; <span class="comment">//AUTORELEASE_POOL_KEYï¼š43</span></span><br><span class="line">	<span class="type">static</span> <span class="type">uint8_t</span> <span class="type">const</span> SCRIBBLE = <span class="number">0xA3</span>;  <span class="comment">// 0xA3A3A3A3 after releasing</span></span><br><span class="line">	<span class="type">static</span> <span class="type">size_t</span> <span class="type">const</span> COUNT = SIZE / <span class="built_in">sizeof</span>(id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// EMPTY_POOL_PLACEHOLDER is stored in TLS when exactly one pool is </span></span><br><span class="line">    <span class="comment">// pushed and it has never contained any objects. This saves memory </span></span><br><span class="line">    <span class="comment">// when the top level (i.e. libdispatch) pushes and pops pools but </span></span><br><span class="line">    <span class="comment">// never uses them.</span></span><br><span class="line"><span class="meta">#   <span class="keyword">define</span> EMPTY_POOL_PLACEHOLDER ((id*)1) <span class="comment">//å ä½æ± ï¼Œèµ·åˆ°ä¼˜åŒ–ä½œç”¨ã€‚å› ä¸ºå¾ˆå¯èƒ½åˆ›å»ºäº†è‡ªåŠ¨é‡Šæ”¾æ± ä½†å®é™…æ²¡æœ‰ä½¿ç”¨åˆ°è‡ªåŠ¨é‡Šæ”¾å¯¹è±¡ï¼Œä½¿ç”¨å ä½æ± å°±å¯ä»¥é¿å…è¿™ç§æŸè€—ã€‚</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#   <span class="keyword">define</span> POOL_BOUNDARY nil <span class="comment">//å“¨å…µå¯¹è±¡ï¼Œæ¸…ç©ºæœ¬æ¬¡è‡ªåŠ¨é‡Šæ”¾æ± é‡Œçš„å¯¹è±¡çš„æˆªæ­¢ä½ç½®ã€‚</span></span></span><br><span class="line">		...</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    <span class="function">id * <span class="title">begin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (id *) ((<span class="type">uint8_t</span> *)<span class="keyword">this</span>+<span class="built_in">sizeof</span>(*<span class="keyword">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">id * <span class="title">end</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (id *) ((<span class="type">uint8_t</span> *)<span class="keyword">this</span>+SIZE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">empty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> next == <span class="built_in">begin</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">full</span><span class="params">()</span> </span>&#123; </span><br><span class="line">        <span class="keyword">return</span> next == <span class="built_in">end</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">lessThanHalfFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (next - <span class="built_in">begin</span>() &lt; (<span class="built_in">end</span>() - <span class="built_in">begin</span>()) / <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">id *<span class="title">add</span><span class="params">(id obj)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">ASSERT</span>(!<span class="built_in">full</span>());</span><br><span class="line">        <span class="built_in">unprotect</span>();</span><br><span class="line">        id *ret = next;  <span class="comment">// faster than `return next-1` because of aliasing</span></span><br><span class="line">        *next++ = obj;</span><br><span class="line">        <span class="built_in">protect</span>();</span><br><span class="line">        <span class="keyword">return</span> ret; <span class="comment">//è¿”å›ä¸€ä¸ªåœ°å€</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AutoreleasePoolPage</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">AutoreleasePoolPageData</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">magic_t</span> <span class="type">const</span> magic;</span><br><span class="line">	__unsafe_unretained id *next;</span><br><span class="line">	<span class="type">pthread_t</span> <span class="type">const</span> thread;</span><br><span class="line">	AutoreleasePoolPage * <span class="type">const</span> parent;</span><br><span class="line">	AutoreleasePoolPage *child;</span><br><span class="line">	<span class="type">uint32_t</span> <span class="type">const</span> depth;</span><br><span class="line">	<span class="type">uint32_t</span> hiwat;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">AutoreleasePoolPageData</span>(__unsafe_unretained id* _next, <span class="type">pthread_t</span> _thread, AutoreleasePoolPage* _parent, <span class="type">uint32_t</span> _depth, <span class="type">uint32_t</span> _hiwat)</span><br><span class="line">		: <span class="built_in">magic</span>(), <span class="built_in">next</span>(_next), <span class="built_in">thread</span>(_thread),</span><br><span class="line">		  <span class="built_in">parent</span>(_parent), <span class="built_in">child</span>(nil),</span><br><span class="line">		  <span class="built_in">depth</span>(_depth), <span class="built_in">hiwat</span>(_hiwat)</span><br><span class="line">	&#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä¸€ä¸ªçº¿ç¨‹çš„è‡ªåŠ¨é‡Šæ”¾æ± ç™»è®°äº†ä¸€å †æŒ‡é’ˆï¼Œæ¯ä¸ªæŒ‡é’ˆæŒ‡å‘çš„è¦ä¹ˆæ˜¯ä¸€ä¸ªå¾…é‡Šæ”¾çš„å¯¹è±¡ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ªPOOL_BOUNDARYï¼ˆä¹Ÿç§°ä¸ºå“¨å…µå¯¹è±¡ï¼‰ï¼ŒPOOL_BOUNDARYæ˜¯ä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± çš„ç•Œé™ï¼Œè¿™è¡¨æ˜è‡ªåŠ¨é‡Šæ”¾æ± å¯ä»¥åµŒå¥—ã€‚æ¯ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± éƒ½æœ‰ä¸€ä¸ªtokenæŒ‡é’ˆæŒ‡å‘POOL_BOUNDARYã€‚å½“æ± å­è¢«popæ—¶ï¼Œæ¯”å“¨å…µå¯¹è±¡åç™»è®°çš„å¯¹è±¡éƒ½å°†è¢«é‡Šæ”¾ã€‚è‡ªåŠ¨é‡Šæ”¾æ± çš„åº•å±‚ç”±ä¸€ä¸ªåŒé“¾è¡¨ <code>AutoreleasePoolPage</code> å®ç°ã€‚æ¯ä¸€ä¸ªAutoreleasePoolPageå¯¹è±¡å ç”¨4KBï¼ˆä¹Ÿå°±æ˜¯æ¯ä¸€é¡µæœ€å¤šæ³¨å†Œ128*4=512ä¸ªå¯¹è±¡ï¼‰ã€‚pageæŒ‰éœ€æ·»åŠ æˆ–åˆ é™¤ã€‚Thread-local storageï¼ˆTLSï¼Œå³çº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼‰æŒ‡å‘ hot pageï¼Œhot page æ˜¯æŒ‡æœ€æ–°æ·»åŠ çš„ autorelease å¯¹è±¡æ‰€åœ¨çš„é‚£ä¸ª pageã€‚</p>
<p>magicï¼šç”¨äºå¯¹å½“å‰ <code>AutoreleasePoolPage</code> <strong>å®Œæ•´æ€§</strong>çš„æ ¡éªŒ</p>
<p>nextï¼šæŒ‡é’ˆå˜é‡ï¼Œå¯ä»¥æŒ‡å‘ä»»æ„ç±»å‹ï¼ŒæŒ‡é’ˆå˜é‡è‡ªç„¶å®ƒçš„å€¼å°±æ˜¯åœ°å€ã€‚å®ƒæŒ‡å‘çš„æ˜¯ä¸‹ä¸€æ¬¡æ·»åŠ å¯¹è±¡æ—¶çš„å­˜å‚¨ä½ç½®ã€‚</p>
<p>threadï¼šå½“å‰è‡ªåŠ¨é‡Šæ”¾æ± æ‰€åœ¨çš„çº¿ç¨‹</p>
<p>parentï¼šçˆ¶AutoreleasePoolPageï¼Œç¬¬ä¸€ä¸ªç»“ç‚¹çš„ <code>parent</code> å€¼ä¸º <code>nil</code>;</p>
<p>childï¼šå­AutoreleasePoolPageï¼Œæœ€åä¸€ä¸ªç»“ç‚¹çš„ <code>child</code> å€¼ä¸º <code>nil</code>;</p>
<p>depthï¼šåŒé“¾è¡¨çš„æ·±åº¦</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20200916214437.png" style="zoom:50%;" /></p>
<h3 id="push"><a href="#push" class="headerlink" title="push"></a>push</h3><p>å®ç°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> *<span class="title">push</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    id *dest;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">slowpath</span>(DebugPoolAllocation)) &#123;</span><br><span class="line">        <span class="comment">// Each autorelease pool starts on a new pool page.</span></span><br><span class="line">        dest = <span class="built_in">autoreleaseNewPage</span>(POOL_BOUNDARY);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dest = <span class="built_in">autoreleaseFast</span>(POOL_BOUNDARY); <span class="comment">//æ³¨æ„è¿™é‡Œçš„å‚æ•°æ˜¯POOL_BOUNDARY</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">ASSERT</span>(dest == EMPTY_POOL_PLACEHOLDER || *dest == POOL_BOUNDARY);</span><br><span class="line">    <span class="keyword">return</span> dest; <span class="comment">//è¿”å›çš„æ˜¯pageä¸Šçš„ä¸€ä¸ªåœ°å€ã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>pushæ“ä½œå°±æ˜¯è°ƒç”¨autoreleaseFastæ·»åŠ ä¸€ä¸ªPOOL_BOUNDARYå“¨å…µå¯¹è±¡å¹¶è¿”å›å“¨å…µå¯¹è±¡æ‰€åœ¨çš„å†…å­˜åœ°å€æˆ–è€…ä¸€ä¸ªEMPTY_POOL_PLACEHOLDERå ä½åœ°å€ã€‚æ‰€è°“çš„å“¨å…µå¯¹è±¡å°±æ˜¯ä¸€ä¸ªnilå¯¹è±¡ï¼Œå› æ­¤pageçš„è¿™ä¸€æ çš„å†…å®¹å…¶å®æ˜¯ç©ºçš„ã€‚</p>
<p>ç¬¬ä¸€æ¬¡æ‰§è¡Œpushçš„æ—¶å€™è¿”å›çš„å…¶å®æ˜¯ä¸€ä¸ªå ä½åœ°å€EMPTY_POOL_PLACEHOLDERï¼Œå…¶ä»–æ—¶å€™æ‰æ˜¯pageä¸ŠæŸä¸€æ çš„å†…å­˜åœ°å€äº†ã€‚è¿™é‡Œçš„EMPTY_POOL_PLACEHOLDERæ˜¯ä¸€ä¸ªæ€§èƒ½ä¼˜åŒ–ï¼Œå› ä¸ºæœ‰å¯èƒ½æˆ‘ä»¬è™½ç„¶å†™äº† <code>@autoreleasepool&#123;&#125;</code> ä½†é‡Œé¢ä¸ä¸€å®šä¼šä½¿ç”¨åˆ°è‡ªåŠ¨é‡Šæ”¾å¯¹è±¡ï¼Œè¿™ä¸ªæ—¶å€™å°±æ²¡å¿…è¦åˆ›å»ºä¸€ä¸ªpageï¼Œå³pageæ˜¯æ‡’åŠ è½½çš„ï¼ŒçœŸæ­£å¾€é‡Œé¢æ³¨å†Œæ—¶æ‰ä¼šåˆ›å»ºpageã€‚æ‡’åŠ è½½åï¼Œç³»ç»Ÿä¹Ÿæ˜¯å…ˆæ·»åŠ ä¸€ä¸ªå“¨å…µå¯¹è±¡å†æ·»åŠ ä¼ å…¥çš„å¯¹è±¡ã€‚</p>
<p>ä¸pushæ“ä½œç›¸å¯¹çš„æ˜¯popæ“ä½œï¼Œpopæ“ä½œä¼šä¸€ç›´releaseå¯¹è±¡ç›´åˆ°POOL_BOUNDARYå“¨å…µå¯¹è±¡ï¼ˆè¯¥å¯¹è±¡å°±æ˜¯pushæ“ä½œæ—¶è¿”å›çš„ï¼‰ã€‚</p>
<p>å®Œæˆæ·»åŠ æ“ä½œçš„å‡½æ•°autoreleaseFastï¼š</p>
<h3 id="autoreleaseFast"><a href="#autoreleaseFast" class="headerlink" title="autoreleaseFast"></a>autoreleaseFast</h3><p>å®ç°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> id *<span class="title">autoreleaseFast</span><span class="params">(id obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AutoreleasePoolPage *page = <span class="built_in">hotPage</span>();</span><br><span class="line">    <span class="keyword">if</span> (page &amp;&amp; !page-&gt;<span class="built_in">full</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> page-&gt;<span class="built_in">add</span>(obj);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (page) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">autoreleaseFullPage</span>(obj, page);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">autoreleaseNoPage</span>(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>autoreleaseFastå‡½æ•°è¿”å›çš„å°±æ˜¯å¯¹è±¡è¢«æ·»åŠ åˆ°pageä¸Šæ—¶çš„å†…å­˜åœ°å€ã€‚</p>
<p>æ•´ä¸ªé€»è¾‘åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li>é¦–å…ˆæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨hotPage</li>
<li>hotPageå­˜åœ¨ä¸”æ²¡æœ‰æ»¡ï¼Œåˆ™ç›´æ¥æ·»åŠ åˆ°pageä¸Š</li>
<li>hotPageå­˜åœ¨ä½†å·²ç»æ»¡äº†ï¼Œåˆ™è°ƒç”¨autoreleaseFullPageï¼Œåˆ›å»ºæ–°çš„ä¸€é¡µpageï¼Œç„¶åå°†objæ·»åŠ åˆ°æ–°çš„pageä¸Š</li>
<li>hotPageä¸å­˜åœ¨ï¼Œè¡¨æ˜å½“å‰è¿˜æ²¡æœ‰pageï¼Œåˆ™è°ƒç”¨autoreleaseNoPageï¼Œåˆ›å»ºç¬¬ä¸€ä¸ªpageï¼Œå°†objæ·»åŠ åˆ°pageä¸Š</li>
</ol>
<p>æ¥ä¸‹æ¥å…·ä½“çœ‹ä¸€ä¸‹å„å­å‡½æ•°ï¼š</p>
<h3 id="hotPage"><a href="#hotPage" class="headerlink" title="hotPage"></a>hotPage</h3><p>å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> AutoreleasePoolPage *<span class="title function_">hotPage</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">    AutoreleasePoolPage *result = (AutoreleasePoolPage *)</span><br><span class="line">        tls_get_direct(key);</span><br><span class="line">    <span class="keyword">if</span> ((id *)result == EMPTY_POOL_PLACEHOLDER) <span class="keyword">return</span> nil;</span><br><span class="line">    <span class="keyword">if</span> (result) result-&gt;fastcheck();</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">pthread_key_t</span> <span class="type">const</span> key = AUTORELEASE_POOL_KEY;</span><br><span class="line">define <span class="title function_">AUTORELEASE_POOL_KEY</span>  <span class="params">((<span class="type">tls_key_t</span>)__PTK_FRAMEWORK_OBJC_KEY3)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __PTK_FRAMEWORK_OBJC_KEY3	43</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// EMPTY_POOL_PLACEHOLDER is stored in TLS when exactly one pool is </span></span><br><span class="line"><span class="comment">// pushed and it has never contained any objects. This saves memory </span></span><br><span class="line"><span class="comment">// when the top level (i.e. libdispatch) pushes and pops pools but </span></span><br><span class="line"><span class="comment">// never uses them.</span></span><br><span class="line"><span class="meta">#   <span class="keyword">define</span> EMPTY_POOL_PLACEHOLDER ((id*)1)</span></span><br></pre></td></tr></table></figure>
<p>å¤§è‡´æµç¨‹ï¼š</p>
<ol>
<li>ä»çº¿ç¨‹çš„TLSè¯»å–AUTORELEASE_POOL_KEYçš„å€¼ï¼Œå¦‚æœç­‰äºEMPTY_POOL_PLACEHOLDERï¼Œè¡¨æ˜å½“å‰æ²¡æœ‰pageï¼Œå› æ­¤è¿”å›nilã€‚</li>
<li>å¦‚æœä¸æ˜¯EMPTY_POOL_PLACEHOLDERï¼Œåˆ™è¡¨æ˜å½“å‰çº¿ç¨‹æœ‰æ­£åœ¨ä½¿ç”¨çš„æœªæ»¡çš„pageï¼Œè¿”å›å®ƒã€‚æ­£åœ¨ä½¿ç”¨çš„æœªæ»¡çš„pageä¹Ÿå«åšhotPageã€‚hotPageä¸ä¸€å®šæ˜¯åŒé“¾è¡¨çš„æœ€åä¸€é¡µï¼Œå› ä¸ºpopçš„æ—¶å€™å¯èƒ½ä¼šä¿ç•™ä¸€é¡µç©ºçš„pageã€‚åªèƒ½è¯´hotPageè·ŸåŒé“¾è¡¨çš„æœ€åä¸€é¡µå¾ˆè¿‘ã€‚</li>
</ol>
<p>è¿™é‡Œæ˜¯get hotPageï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸‹æ˜¯å¦‚ä½•set hotPageçš„ï¼š</p>
<h3 id="setHotPage"><a href="#setHotPage" class="headerlink" title="setHotPage"></a>setHotPage</h3><p>å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">setHotPage</span><span class="params">(AutoreleasePoolPage *page)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (page) page-&gt;fastcheck();</span><br><span class="line">    tls_set_direct(key, (<span class="type">void</span> *)page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€»è¾‘å¾ˆç®€å•å°±æ˜¯æŠŠpageçš„åœ°å€å­˜å‚¨åˆ°çº¿ç¨‹çš„TLSã€‚</p>
<p>ä¸hotPageå¯¹åº”çš„æ˜¯codePage</p>
<h3 id="codePage"><a href="#codePage" class="headerlink" title="codePage"></a>codePage</h3><p>å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> AutoreleasePoolPage *<span class="title function_">coldPage</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">    AutoreleasePoolPage *result = hotPage();</span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">        <span class="keyword">while</span> (result-&gt;parent) &#123;</span><br><span class="line">            result = result-&gt;parent;</span><br><span class="line">            result-&gt;fastcheck();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶å®å°±æ˜¯æ‰¾åˆ°åŒé“¾è¡¨çš„ç¬¬ä¸€ä¸ªpageã€‚å³åŒé“¾è¡¨çš„ç¬¬ä¸€ä¸ªpageä¹Ÿå«coldPageã€‚</p>
<p>æ¥ç€æœªå®Œæˆçš„åˆ†æï¼ŒautoreleaseFullPage</p>
<h3 id="autoreleaseFullPage"><a href="#autoreleaseFullPage" class="headerlink" title="autoreleaseFullPage"></a>autoreleaseFullPage</h3><p>è‡ªåŠ¨é‡Šæ”¾æ± é¡µæ»¡äº†çš„å¤„ç†ã€‚</p>
<p>å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> __attribute__((noinline))</span><br><span class="line">id *<span class="title function_">autoreleaseFullPage</span><span class="params">(id obj, AutoreleasePoolPage *page)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// The hot page is full. </span></span><br><span class="line">    <span class="comment">// Step to the next non-full page, adding a new page if necessary.</span></span><br><span class="line">    <span class="comment">// Then add the object to that page.</span></span><br><span class="line">    ASSERT(page == hotPage());</span><br><span class="line">    ASSERT(page-&gt;full()  ||  DebugPoolAllocation);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (page-&gt;child) page = page-&gt;child;</span><br><span class="line">        <span class="keyword">else</span> page = new AutoreleasePoolPage(page);</span><br><span class="line">    &#125; <span class="keyword">while</span> (page-&gt;full());</span><br><span class="line"></span><br><span class="line">    setHotPage(page);</span><br><span class="line">    <span class="keyword">return</span> page-&gt;add(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¤§è‡´é€»è¾‘ï¼š</p>
<ol>
<li><p>ä»å½“å‰pageå¼€å§‹æ²¿ç€åŒé“¾è¡¨å¾€åæŸ¥æ‰¾ï¼Œç›´åˆ°æŸ¥æ‰¾åˆ°ä¸€ä¸ªæœªæ»¡çš„pageã€‚å¦‚æœæŸ¥æ‰¾åˆ°æœ«å°¾ä¹Ÿæ²¡æœ‰åˆ™æ–°åˆ›å»ºä¸€ä¸ªpageã€‚</p>
</li>
<li><p>è®¾ç½®pageä¸ºhotPageã€‚</p>
</li>
<li>å°†objæ·»åŠ åˆ°pageä¸Šã€‚</li>
</ol>
<p>ç”±æ­¤å¯ä»¥çœ‹åˆ°å¦‚æœæ³¨å†Œçš„å¯¹è±¡ç‰¹åˆ«å¤šï¼Œé‚£ä¹ˆä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± å¯ä»¥æ¨ªè·¨å¾ˆå¤šä¸ªpageã€‚</p>
<p>æ¥ç€åˆ†æautoreleaseNoPageï¼š</p>
<h3 id="autoreleaseNoPage"><a href="#autoreleaseNoPage" class="headerlink" title="autoreleaseNoPage"></a>autoreleaseNoPage</h3><p>æ²¡æœ‰è‡ªåŠ¨é‡Šæ”¾æ± é¡µçš„å¤„ç†ï¼Œéœ€è¦åŠ è½½ä¸€ä¸ªã€‚</p>
<p>å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> __attribute__((noinline))</span><br><span class="line">id *<span class="title function_">autoreleaseNoPage</span><span class="params">(id obj)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// &quot;No page&quot; could mean no pool has been pushed</span></span><br><span class="line">    <span class="comment">// or an empty placeholder pool has been pushed and has no contents yet</span></span><br><span class="line">    ASSERT(!hotPage());</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> pushExtraBoundary = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (haveEmptyPoolPlaceholder()) &#123;</span><br><span class="line">        <span class="comment">// We are pushing a second pool over the empty placeholder pool</span></span><br><span class="line">        <span class="comment">// or pushing the first object into the empty placeholder pool.</span></span><br><span class="line">        <span class="comment">// Before doing that, push a pool boundary on behalf of the pool </span></span><br><span class="line">        <span class="comment">// that is currently represented by the empty placeholder.</span></span><br><span class="line">        pushExtraBoundary = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (obj != POOL_BOUNDARY  &amp;&amp;  DebugMissingPools) &#123;</span><br><span class="line">        <span class="comment">// We are pushing an object with no pool in place, </span></span><br><span class="line">        <span class="comment">// and no-pool debugging was requested by environment.</span></span><br><span class="line">        _objc_inform(<span class="string">&quot;MISSING POOLS: (%p) Object %p of class %s &quot;</span></span><br><span class="line">                     <span class="string">&quot;autoreleased with no pool in place - &quot;</span></span><br><span class="line">                     <span class="string">&quot;just leaking - break on &quot;</span></span><br><span class="line">                     <span class="string">&quot;objc_autoreleaseNoPool() to debug&quot;</span>, </span><br><span class="line">                     objc_thread_self(), (<span class="type">void</span>*)obj, object_getClassName(obj));</span><br><span class="line">        objc_autoreleaseNoPool(obj);</span><br><span class="line">        <span class="keyword">return</span> nil;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (obj == POOL_BOUNDARY  &amp;&amp;  !DebugPoolAllocation) &#123;</span><br><span class="line">        <span class="comment">// We are pushing a pool with no pool in place,</span></span><br><span class="line">        <span class="comment">// and alloc-per-pool debugging was not requested.</span></span><br><span class="line">        <span class="comment">// Install and return the empty pool placeholder.</span></span><br><span class="line">        <span class="keyword">return</span> setEmptyPoolPlaceholder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We are pushing an object or a non-placeholder&#x27;d pool.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Install the first page.</span></span><br><span class="line">    AutoreleasePoolPage *page = new AutoreleasePoolPage(nil);</span><br><span class="line">    setHotPage(page);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Push a boundary on behalf of the previously-placeholder&#x27;d pool.</span></span><br><span class="line">    <span class="keyword">if</span> (pushExtraBoundary) &#123;</span><br><span class="line">        page-&gt;add(POOL_BOUNDARY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Push the requested object or pool.</span></span><br><span class="line">    <span class="keyword">return</span> page-&gt;add(obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">bool</span> <span class="title function_">haveEmptyPoolPlaceholder</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    id *tls = (id *)tls_get_direct(key);</span><br><span class="line">    <span class="keyword">return</span> (tls == EMPTY_POOL_PLACEHOLDER);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> id* <span class="title function_">setEmptyPoolPlaceholder</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(tls_get_direct(key) == nil);</span><br><span class="line">    tls_set_direct(key, (<span class="type">void</span> *)EMPTY_POOL_PLACEHOLDER);</span><br><span class="line">    <span class="keyword">return</span> EMPTY_POOL_PLACEHOLDER;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼š</p>
<ol>
<li>è°ƒç”¨haveEmptyPoolPlaceholderï¼Œå…ˆåˆ¤æ–­TLSä¸­å­˜å‚¨çš„æ˜¯å¦ç­‰äºEMPTY_POOL_PLACEHOLDERã€‚</li>
<li>å¦‚æœç­‰äºEMPTY_POOL_PLACEHOLDERï¼Œè¯´æ˜å¯ä»¥åˆ›å»ºç¬¬ä¸€ä¸ªpageäº†ã€‚</li>
<li>åˆ›å»ºä¸€ä¸ªpageï¼Œå¹¶è®¾ç½®ä¸ºhotPageã€‚</li>
<li>å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªpageåˆ™è¿˜éœ€è¦æ·»åŠ POOL_BOUNDARYç”¨äºpopçš„åœæ­¢æ ‡å¿—ã€‚</li>
<li>æ·»åŠ objåˆ°pageä¸Š</li>
<li>æ¥ç¬¬ä¸€æ­¥å¦‚æœä¸ç­‰äºEMPTY_POOL_PLACEHOLDERï¼Œè¯´æ˜å½“å‰åŒé“¾è¡¨ä¸ºç©ºæ²¡æœ‰pageã€‚å¦‚æœobjç­‰äºPOOL_BOUNDARYï¼Œåˆ™èµ° <code>else if (obj == POOL_BOUNDARY  &amp;&amp;  !DebugPoolAllocation)</code> åˆ†æ”¯ï¼Œè°ƒç”¨setEmptyPoolPlaceholderå¾€TLSä¸Šå†™å…¥å ä½ç¬¦EMPTY_POOL_PLACEHOLDERå¹¶è¿”å›EMPTY_POOL_PLACEHOLDERï¼Œç¬¬ä¸€æ¬¡pushçš„æ—¶å€™èµ°çš„å°±æ˜¯è¿™é‡Œã€‚æ¥ä¸‹æ¥æ˜¯æ¯”è¾ƒç‰¹æ®Šçš„ä¸€ç§æƒ…å†µï¼Œå¦‚æœobjä¸ç­‰äºPOOL_BOUNDARY ç”Ÿäº§ç¯å¢ƒä¸‹ä»£ç å¹¶ä¸ä¼šèµ° <code>else if (obj != POOL_BOUNDARY  &amp;&amp;  DebugMissingPools)</code> åˆ†æ”¯ï¼Œå› æ­¤ä¼šåˆ›å»ºä¸€ä¸ªpageï¼Œå¹¶å°†å¯¹è±¡æ·»åŠ åˆ°pageä¸Šï¼Œåªä¸è¿‡è¿™ç§æƒ…å†µä¸‹ä¸ä¼šæœ‰å“¨å…µå¯¹è±¡ã€‚æ²¡æœ‰å“¨å…µå¯¹è±¡ä¼šä¸ä¼šå‡ºé—®é¢˜å‘¢ï¼Ÿä»åç»­çš„popæ–¹æ³•å¯ä»¥çœ‹åˆ°ä¸ä¼šæœ‰é—®é¢˜ã€‚</li>
</ol>
<h4 id="setEmptyPoolPlaceholder"><a href="#setEmptyPoolPlaceholder" class="headerlink" title="setEmptyPoolPlaceholder"></a>setEmptyPoolPlaceholder</h4><p>å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">bool</span> <span class="title function_">haveEmptyPoolPlaceholder</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    id *tls = (id *)tls_get_direct(key);</span><br><span class="line">    <span class="keyword">return</span> (tls == EMPTY_POOL_PLACEHOLDER);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> id* <span class="title function_">setEmptyPoolPlaceholder</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(tls_get_direct(key) == nil);</span><br><span class="line">    tls_set_direct(key, (<span class="type">void</span> *)EMPTY_POOL_PLACEHOLDER);</span><br><span class="line">    <span class="keyword">return</span> EMPTY_POOL_PLACEHOLDER;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="autoreleaseâ€”ç»™å¯¹è±¡å‘é€ä¸€æ¡autoreleaseæ¶ˆæ¯"><a href="#autoreleaseâ€”ç»™å¯¹è±¡å‘é€ä¸€æ¡autoreleaseæ¶ˆæ¯" class="headerlink" title="autoreleaseâ€”ç»™å¯¹è±¡å‘é€ä¸€æ¡autoreleaseæ¶ˆæ¯"></a>autoreleaseâ€”ç»™å¯¹è±¡å‘é€ä¸€æ¡autoreleaseæ¶ˆæ¯</h3><p>å®ç°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> id <span class="title">autorelease</span><span class="params">(id obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">ASSERT</span>(obj);</span><br><span class="line">    <span class="built_in">ASSERT</span>(!obj-&gt;<span class="built_in">isTaggedPointer</span>());</span><br><span class="line">    id *dest __unused = <span class="built_in">autoreleaseFast</span>(obj);</span><br><span class="line">    <span class="built_in">ASSERT</span>(!dest  ||  dest == EMPTY_POOL_PLACEHOLDER  ||  *dest == obj);</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ç»™å¯¹è±¡å‘é€autoreleaseæ¶ˆæ¯æ—¶ï¼Œå°±æ˜¯è°ƒç”¨autoreleaseFast(obj)å°†å¯¹è±¡æ·»åŠ åˆ°åŒé“¾è¡¨ä¸Šã€‚æ³¨æ„æ²¡æœ‰retainæ“ä½œã€‚</p>
<h3 id="pop"><a href="#pop" class="headerlink" title="pop"></a>pop</h3><p>å®ç°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span></span></span><br><span class="line"><span class="function"><span class="title">pop</span><span class="params">(<span class="type">void</span> *token)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AutoreleasePoolPage *page;</span><br><span class="line">    id *stop;</span><br><span class="line">    <span class="keyword">if</span> (token == (<span class="type">void</span>*)EMPTY_POOL_PLACEHOLDER) &#123;</span><br><span class="line">        <span class="comment">// Popping the top-level placeholder pool.</span></span><br><span class="line">        page = <span class="built_in">hotPage</span>();</span><br><span class="line">        <span class="keyword">if</span> (!page) &#123;</span><br><span class="line">            <span class="comment">// Pool was never used. Clear the placeholder.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">setHotPage</span>(nil);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Pool was used. Pop its contents normally.</span></span><br><span class="line">        <span class="comment">// Pool pages remain allocated for re-use as usual.</span></span><br><span class="line">        page = <span class="built_in">coldPage</span>();</span><br><span class="line">        token = page-&gt;<span class="built_in">begin</span>(); <span class="comment">//coldPageæ˜¯åŒé“¾è¡¨çš„ç¬¬ä¸€é¡µï¼Œè¿™é‡Œå°†tokenè®¾ç½®ä¸ºbeginä½ç½®ã€‚</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        page = <span class="built_in">pageForPointer</span>(token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stop = (id *)token;</span><br><span class="line">    <span class="keyword">if</span> (*stop != POOL_BOUNDARY) &#123;</span><br><span class="line">        <span class="keyword">if</span> (stop == page-&gt;<span class="built_in">begin</span>()  &amp;&amp;  !page-&gt;parent) &#123;</span><br><span class="line">            <span class="comment">// Start of coldest page may correctly not be POOL_BOUNDARY:</span></span><br><span class="line">            <span class="comment">// 1. top-level pool is popped, leaving the cold page in place</span></span><br><span class="line">            <span class="comment">// 2. an object is autoreleased with no pool</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Error. For bincompat purposes this is not </span></span><br><span class="line">            <span class="comment">// fatal in executables built with old SDKs.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">badPop</span>(token);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">slowpath</span>(PrintPoolHiwat || DebugPoolAllocation || DebugMissingPools)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">popPageDebug</span>(token, page, stop);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">popPage</span>&lt;<span class="literal">false</span>&gt;(token, page, stop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>åˆ¤æ–­ä¼ å…¥çš„tokenæ˜¯å¦ç­‰äºEMPTY_POOL_PLACEHOLDERï¼Œç¬¬ä¸€æ¬¡pushçš„æ—¶å€™å°±æ˜¯EMPTY_POOL_PLACEHOLDERã€‚</li>
<li>å¦‚æœç­‰äºEMPTY_POOL_PLACEHOLDERï¼Œåˆ™è·å–hotPageï¼Œå¦‚æœhotPagç­‰äºnilï¼Œåˆ™è¡¨æ˜ <code>@autoreleasepool&#123;&#125;</code> å†…æ²¡æœ‰ä½¿ç”¨åˆ°è‡ªåŠ¨é‡Šæ”¾å¯¹è±¡ï¼Œä¼˜åŒ–æˆåŠŸã€‚å°†TLSå¯¹åº”keyç½®ä¸ºnilé€€å‡ºã€‚å¦‚æœhotPagä¸ç­‰äºnilï¼Œè¯´æ˜æœ‰ä½¿ç”¨åˆ°è‡ªåŠ¨é‡Šæ”¾å¯¹è±¡ã€‚åˆ™è·å–coldPageï¼ŒåŠtokenã€‚</li>
<li>æ¥ç¬¬ä¸€æ­¥å¦‚æœä¼ å…¥çš„tokenä¸ç­‰äºEMPTY_POOL_PLACEHOLDERï¼ˆè¿™ç§æƒ…å†µä¸€èˆ¬æ˜¯åµŒå¥—äº†è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œä¸Šé¢å·²ç»æåŠåªæœ‰ç¬¬ä¸€æ¬¡pushçš„æ—¶å€™æ‰ä¼šè¿”å›EMPTY_POOL_PLACEHOLDERï¼Œåé¢å†pushçš„æ—¶å€™è¿”å›çš„å°†æ˜¯pageä¸Šçš„ä¸€ä¸ªåœ°å€ï¼‰ï¼Œåˆ™æ ¹æ®tokenæ‰¾åˆ°å®ƒçš„é‚£ä¸€ä¸ªpageã€‚</li>
<li>åˆ¤æ–­tokenæ˜¯å¦æŒ‡å‘å“¨å…µå¯¹è±¡ï¼Œä¸€èˆ¬æƒ…å†µä¸‹éƒ½ä¼šæŒ‡å‘å“¨å…µå¯¹è±¡ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹ä¸ä¼šæŒ‡å‘å“¨å…µå¯¹è±¡ã€‚å…¶ä¸­ <code>if (stop == page-&gt;begin()  &amp;&amp;  !page-&gt;parent)</code> å³tokenæŒ‡å‘ç¬¬ä¸€ä¸ªå¯¹è±¡å¹¶ä¸”pageæ˜¯ç¬¬ä¸€é¡µåˆ™å¯ä»¥æ­£å¸¸popPageï¼ˆæ¯”å¦‚æ²¡æœ‰å…ˆpushæ“ä½œå°±å¼€å§‹æ³¨å†Œå¯¹è±¡ï¼‰ï¼Œå…¶ä»–æƒ…å†µå°±æ˜¯badPopã€‚</li>
<li>è°ƒç”¨popPageå¼€å§‹é‡Šæ”¾ã€‚</li>
</ol>
<p>popçš„ä¸»è¦é€»è¾‘å…¶å®æ˜¯æ ¹æ®ä¼ å…¥çš„tokenï¼Œæ‰¾åˆ°tokenæ‰€åœ¨çš„é‚£ä¸€ä¸ªpageã€‚è¿™ä¸ªpage+tokenå°±æ˜¯æœ¬æ¬¡é‡Šæ”¾çš„ç»“æŸåœ°ç‚¹ã€‚</p>
<h4 id="Qï¼šå¦‚ä½•æ ¹æ®ä¼ å…¥çš„tokenï¼Œæ‰¾åˆ°tokenæ‰€åœ¨çš„é‚£ä¸€ä¸ªpageï¼Ÿ"><a href="#Qï¼šå¦‚ä½•æ ¹æ®ä¼ å…¥çš„tokenï¼Œæ‰¾åˆ°tokenæ‰€åœ¨çš„é‚£ä¸€ä¸ªpageï¼Ÿ" class="headerlink" title="Qï¼šå¦‚ä½•æ ¹æ®ä¼ å…¥çš„tokenï¼Œæ‰¾åˆ°tokenæ‰€åœ¨çš„é‚£ä¸€ä¸ªpageï¼Ÿ"></a>Qï¼šå¦‚ä½•æ ¹æ®ä¼ å…¥çš„tokenï¼Œæ‰¾åˆ°tokenæ‰€åœ¨çš„é‚£ä¸€ä¸ªpageï¼Ÿ</h4><p>è¿™é‡Œç¨å¾®çœ‹ä¸€ä¸‹å¦‚ä½•æ ¹æ®tokenæŸ¥æ‰¾å‡ºtokenæ‰€åœ¨çš„pageï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ ¹æ®tokenæŸ¥æ‰¾å‡ºtokenæ‰€åœ¨çš„page</span></span><br><span class="line"><span class="function"><span class="type">static</span> AutoreleasePoolPage *<span class="title">pageForPointer</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *p)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">pageForPointer</span>((<span class="type">uintptr_t</span>)p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> AutoreleasePoolPage *<span class="title">pageForPointer</span><span class="params">(<span class="type">uintptr_t</span> p)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AutoreleasePoolPage *result;</span><br><span class="line">    <span class="type">uintptr_t</span> offset = p % SIZE;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ASSERT</span>(offset &gt;= <span class="built_in">sizeof</span>(AutoreleasePoolPage));</span><br><span class="line"></span><br><span class="line">    result = (AutoreleasePoolPage *)(p - offset);</span><br><span class="line">    result-&gt;<span class="built_in">fastcheck</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>result = p - (p % SIZE)ï¼›è¿™å°±æ˜¯tokenæ‰€åœ¨çš„pageçš„åœ°å€ã€‚ä¸ºä»€ä¹ˆå¯ä»¥è¿™ä¹ˆè®¡ç®—ï¼Ÿä¸»è¦è¿˜æ˜¯å¾—ç›Šäºå†…å­˜å¯¹é½ï¼Œpageçš„èµ·å§‹åœ°å€è‚¯å®šæ˜¯SIZEçš„æ•´æ•°å€ã€‚è¿™é‡Œä¸å¯è°“ä¸å¦™ã€‚</p>
<p>ä¸¾ä¸ªç®€å•çš„ä¾‹å­éªŒè¯ä¸€ä¸‹ï¼š</p>
<p>å‡è®¾ç¬¬ä¸€é¡µçš„åœ°å€ä¸º100ï¼Œä¸€é¡µå¯ä»¥ç™»è®°10ä¸ªå¯¹è±¡ï¼Œé—®tokenä¸º132æ‰€åœ¨çš„pageçš„åœ°å€æ˜¯å¤šå°‘ï¼Ÿ</p>
<p>å› ä¸ºç¬¬ä¸€é¡µæ˜¯100ï¼Œé‚£ä¹ˆç¬¬äºŒé¡µå°±æ˜¯110ï¼Œç¬¬ä¸‰é¡µå°±æ˜¯120ï¼Œç¬¬å››é¡µå°±æ˜¯130ï¼Œäºæ˜¯ç¬¬å››é¡µçš„ç¬¬äºŒä¸ªä½ç½®å°±æ˜¯132ã€‚å› æ­¤132æ‰€åœ¨çš„pageçš„åœ°å€å°±æ˜¯130ã€‚</p>
<p>æ ¹æ®ä¸Šé¢çš„ç®—æ³• 132 % 10 = 2ï¼Œ132-2 = 130ã€‚ä¹Ÿå¯ä»¥å¾—åˆ°130ã€‚</p>
<h4 id="Qï¼šä¸ºå•¥è¦å»æŸ¥æ‰¾tokenæ‰€åœ¨çš„page"><a href="#Qï¼šä¸ºå•¥è¦å»æŸ¥æ‰¾tokenæ‰€åœ¨çš„page" class="headerlink" title="Qï¼šä¸ºå•¥è¦å»æŸ¥æ‰¾tokenæ‰€åœ¨çš„page?"></a>Qï¼šä¸ºå•¥è¦å»æŸ¥æ‰¾tokenæ‰€åœ¨çš„page?</h4><p>è¿™é‡Œä¸æ˜¯å¾ˆç†è§£ï¼Œæˆ‘è·å–åˆ°hotPageåå°±å¼€å§‹æ¸…é™¤ï¼Œç„¶åæ ¹æ®åŒé“¾è¡¨ä¸€ç›´å¾€ä¸Šæ¸…é™¤ï¼Œæœ€ç»ˆè‚¯å®šä¼šåˆ°è¾¾tokenæ‰€åœ¨çš„pageçš„ã€‚æ„Ÿè§‰æ ¹æœ¬ä¸éœ€è¦å…ˆå»æŸ¥æ‰¾tokenæ‰€åœ¨çš„pageå•Šï¼Ÿ</p>
<p>å› ä¸ºåç»­è°ƒç”¨çš„releaseUntilæ˜¯å®šä¹‰åœ¨AutoreleasePoolPageé‡Œçš„æ–¹æ³•ï¼Œè€ŒreleaseUntilé‡Œçš„whileæ¡ä»¶æ˜¯this-&gt;next != stop.</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> (this-&gt;next != stop) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>thisæŒ‡ä»£çš„æ˜¯å½“å‰pageï¼Œæ‰€ä»¥æ–¹æ³•çš„å¯¹è±¡åªèƒ½æ˜¯tokenæ‰€åœ¨çš„pageï¼Œå¦‚æœæ˜¯å…¶ä»–çš„pageé‚£ä¹ˆåœæ­¢çš„ä½ç½®å°±ä¸å¯¹äº†ã€‚</p>
<h3 id="popPage"><a href="#popPage" class="headerlink" title="popPage"></a>popPage</h3><p>å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">template&lt;<span class="type">bool</span> allowDebug&gt;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">popPage</span><span class="params">(<span class="type">void</span> *token, AutoreleasePoolPage *page, id *stop)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (allowDebug &amp;&amp; PrintPoolHiwat) printHiwat();</span><br><span class="line"></span><br><span class="line">    page-&gt;releaseUntil(stop);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// memory: delete empty children</span></span><br><span class="line">    <span class="keyword">if</span> (allowDebug &amp;&amp; DebugPoolAllocation  &amp;&amp;  page-&gt;empty()) &#123;</span><br><span class="line">        <span class="comment">// special case: delete everything during page-per-pool debugging</span></span><br><span class="line">        AutoreleasePoolPage *parent = page-&gt;parent;</span><br><span class="line">        page-&gt;kill();</span><br><span class="line">        setHotPage(parent);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (allowDebug &amp;&amp; DebugMissingPools  &amp;&amp;  page-&gt;empty()  &amp;&amp;  !page-&gt;parent) &#123;</span><br><span class="line">        <span class="comment">// special case: delete everything for pop(top)</span></span><br><span class="line">        <span class="comment">// when debugging missing autorelease pools</span></span><br><span class="line">        page-&gt;kill();</span><br><span class="line">        setHotPage(nil);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (page-&gt;child) &#123; <span class="comment">//å‰é¢çš„åˆ†æ”¯æ˜¯debugç”¨çš„ï¼Œæ‰€ä»¥ä¸»è¦çœ‹è¿™é‡Œ</span></span><br><span class="line">        <span class="comment">// hysteresis: keep one empty child if page is more than half full</span></span><br><span class="line">        <span class="keyword">if</span> (page-&gt;lessThanHalfFull()) &#123;</span><br><span class="line">            page-&gt;child-&gt;kill();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (page-&gt;child-&gt;child) &#123;</span><br><span class="line">            page-&gt;child-&gt;child-&gt;kill();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯è°ƒç”¨releaseUntilè¿›è¡Œé‡Šæ”¾ï¼Œé‡Šæ”¾ä¹‹åå½“å‰pageåé¢çš„pageè‚¯å®šæ˜¯ç©ºçš„äº†ï¼Œå› æ­¤éœ€è¦æŠŠåé¢çš„ç©ºpageåˆ é™¤ï¼Œç›´è‡³å‰©ä¸€ä¸ªç©ºçš„pageã€‚</p>
<h3 id="releaseUntil"><a href="#releaseUntil" class="headerlink" title="releaseUntil"></a>releaseUntil</h3><p>å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">releaseUntil</span><span class="params">(id *stop)</span> </span><br><span class="line">&#123;</span><br><span class="line">  	<span class="comment">// æ³¨é‡Šå¾ˆæ¸…æ¥šï¼šä¸ä½¿ç”¨é€’å½’æ˜¯æ€•æŠŠæ ˆç»™æçˆ†äº†ï¼Œæ‰€ä»¥ä½¿ç”¨äº†å¾ªç¯ã€‚</span></span><br><span class="line">    <span class="comment">// Not recursive: we don&#x27;t want to blow out the stack </span></span><br><span class="line">    <span class="comment">// if a thread accumulates a stupendous amount of garbage</span></span><br><span class="line">		</span><br><span class="line">    <span class="keyword">while</span> (this-&gt;next != stop) &#123; <span class="comment">//ä¸€ç›´é‡Šæ”¾åˆ°stopçš„ä½ç½®ã€‚</span></span><br><span class="line">        <span class="comment">// Restart from hotPage() every time, in case -release </span></span><br><span class="line">        <span class="comment">// autoreleased more objects</span></span><br><span class="line">        AutoreleasePoolPage *page = hotPage(); <span class="comment">//å…ˆè·å–hotPage.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// fixme I think this `while` can be `if`, but I can&#x27;t prove it</span></span><br><span class="line">        <span class="keyword">while</span> (page-&gt;empty()) &#123; <span class="comment">//å¦‚æœæ˜¯ç©ºçš„ï¼Œè¯´æ˜è¿™ä¸€é¡µå·²ç»æ¸…ç©ºï¼Œåˆ™ç»§ç»­å¾€ä¸Šæ‰¾ï¼Œæœ€ç»ˆpageä¼šç­‰äºthisã€‚éšç€é‡Šæ”¾this-&gt;nextæœ€ç»ˆä¼šç­‰äºstop.</span></span><br><span class="line">            page = page-&gt;parent;</span><br><span class="line">            setHotPage(page);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        page-&gt;unprotect();</span><br><span class="line">        id obj = *--page-&gt;next; <span class="comment">//å› ä¸ºnextæŒ‡å‘çš„æ˜¯ä¸‹ä¸€ä¸ªç©ºçš„ä½ç½®ï¼Œæ‰€ä»¥è¿™é‡Œè¦å…ˆ--ï¼Œç§»åŠ¨åˆ°æœ‰æ³¨å†Œå¯¹è±¡çš„ä½ç½®ã€‚</span></span><br><span class="line">        <span class="built_in">memset</span>((<span class="type">void</span>*)page-&gt;next, SCRIBBLE, <span class="keyword">sizeof</span>(*page-&gt;next)); <span class="comment">//å°†è¿™ä¸€æ å¡«å……SCRIBBLE==0xA3</span></span><br><span class="line">        page-&gt;protect();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (obj != POOL_BOUNDARY) &#123; <span class="comment">//è¿™é‡Œå¾ˆå¦™ï¼Œå¦‚æœobjä¸æ˜¯nilä¹Ÿä¼šé‡Šæ”¾æ‰ã€‚å› ä¸ºæœ‰å¯èƒ½pageé‡Œå°±æ²¡æœ‰POOL_BOUNDARYå¯¹è±¡ã€‚ä¸è¿‡è¿™ç§æƒ…å†µä¸€èˆ¬ä¸ä¼šå‡ºç°ï¼Œå› ä¸ºç³»ç»Ÿåœ¨æ–°å¼€çº¿ç¨‹çš„æ—¶å€™ä¼šå¸®ä½ æ‰§è¡Œpushæ“ä½œæ‰€ä»¥åŸºæœ¬ä¸Šéƒ½ä¼šå­˜åœ¨POOL_BOUNDARYå¯¹è±¡ã€‚</span></span><br><span class="line">            objc_release(obj);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setHotPage(this);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> DEBUG</span></span><br><span class="line">    <span class="comment">// we expect any children to be completely empty</span></span><br><span class="line">    <span class="keyword">for</span> (AutoreleasePoolPage *page = child; page; page = page-&gt;child) &#123;</span><br><span class="line">        ASSERT(page-&gt;empty());</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¤§è‡´é€»è¾‘ï¼š</p>
<ol>
<li>è·å–hotPage</li>
<li>ç„¶åä»hotPageå¤„å¼€å§‹ä¸€ç›´é‡Šæ”¾æ³¨å†Œåˆ°pageä¸Šçš„å¯¹è±¡ï¼Œç›´åˆ°å“¨å…µå¯¹è±¡å¤„ç»“æŸã€‚æœ¬æ¬¡è‡ªåŠ¨é‡Šæ”¾æ± çš„ä½œç”¨åŸŸç»“æŸã€‚</li>
<li>è®¾ç½®å½“å‰pageä¸ºhotPageã€‚</li>
</ol>
<h3 id="autoreleasepoolåµŒå¥—æƒ…å†µ"><a href="#autoreleasepoolåµŒå¥—æƒ…å†µ" class="headerlink" title="autoreleasepoolåµŒå¥—æƒ…å†µ"></a>autoreleasepoolåµŒå¥—æƒ…å†µ</h3><figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(@&quot;Hello, World!&quot;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(@&quot;Hello, World!&quot;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(@&quot;Hello, World!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç­‰ä»·äºï¼š</p>
<figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">void * atautoreleasepoolobj1 <span class="operator">=</span> objc_autoreleasePoolPush()<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">void * atautoreleasepoolobj2 <span class="operator">=</span> objc_autoreleasePoolPush()<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">void * atautoreleasepoolobj3 <span class="operator">=</span> objc_autoreleasePoolPush()<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">objc_autoreleasePoolPop(atautoreleasepoolobj3)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">objc_autoreleasePoolPop(atautoreleasepoolobj2)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">objc_autoreleasePoolPop(atautoreleasepoolobj1)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>pop atautoreleasepoolobj3æ—¶ï¼Œå°±æ˜¯ä»hotPageåˆ°POOL_BOUNDARY3æˆªæ­¢ï¼Œ</p>
<p>pop atautoreleasepoolobj2æ—¶ï¼Œå°±æ˜¯ä»hotPageåˆ°POOL_BOUNDARY2æˆªæ­¢ï¼Œ</p>
<p>pop atautoreleasepoolobj1æ—¶ï¼Œå°±æ˜¯ä»hotPageåˆ°POOL_BOUNDARY1æˆªæ­¢ã€‚</p>
<p>åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œä¸»çº¿ç¨‹åœ¨è¿›å…¥runloopå‰ä¼šæ‰§è¡Œpushæ“ä½œåˆ›å»ºå¥½è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå½“é€€å‡ºrunloopæ—¶å°±ä¼šæ‰§è¡Œpopæ“ä½œé”€æ¯è‡ªåŠ¨é‡Šæ”¾æ± ã€‚è¿™é‡Œå¯ä»¥å‚è€ƒrunloopåŸç†ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>ç¨å¾®æ€»ç»“ä¸€ä¸‹ï¼š</p>
<p>è‡ªåŠ¨é‡Šæ”¾æ± åº•å±‚æ˜¯ç”±ä¸€ä¸ªåŒé“¾è¡¨æ•°æ®ç»“æ„å®ç°çš„ï¼ŒåŒé“¾è¡¨çš„æ¯ä¸€ä¸ªå…ƒç´ è¢«ç§°ä¸ºAutoreleasePoolPageï¼Œæ¯ä¸ªpageå¯ä»¥æ³¨å†Œä¸€å®šæ•°é‡çš„å¯¹è±¡ã€‚åœ¨MRCæ—¶ä»£æˆ‘ä»¬å¯ä»¥ç»™å¯¹è±¡å‘é€ä¸€æ¡autoreleaseæ¶ˆæ¯å°†å…¶æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± é‡Œï¼Œè€Œåœ¨ARCæ—¶ä»£æˆ‘ä»¬å¯ä»¥å°†ä¸€ä¸ªå¯¹è±¡èµ‹å€¼ç»™ä¸€ä¸ª <code>__autoreleasing</code> ä¿®é¥°ç¬¦çš„æŒ‡é’ˆå˜é‡ï¼š <code>id __autoreleasing obj1 = obj;</code> å°†å…¶æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± é‡Œã€‚</p>
<p>è€Œ <code>@autoreleasepool&#123;&#125;</code> å…¶å®æ˜¯push-popå¯¹çš„è¯­æ³•ç³–ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> * atautoreleasepoolobj = objc_autoreleasePoolPush();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// do whatever you want</span></span><br><span class="line"></span><br><span class="line">    objc_autoreleasePoolPop(atautoreleasepoolobj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>pushå‡½æ•°é™¤ç¬¬ä¸€æ¬¡è°ƒç”¨è¿”å›çš„æ˜¯å ä½ç¬¦å¤–ï¼Œåç»­è°ƒç”¨è¿”å›çš„æ˜¯pageä¸Šçš„ä¸€ä¸ªä½ç½®åœ°å€ã€‚ç¬¬ä¸€æ¬¡pushæ—¶ï¼Œç³»ç»Ÿå¹¶ä¸ä¼šé©¬ä¸Šåˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œè€Œæ˜¯ç­‰åˆ°çœŸæ­£æ³¨å†Œè‡ªåŠ¨é‡Šæ”¾çš„å¯¹è±¡æ—¶æ‰åˆ›å»ºã€‚</p>
<p>popå‡½æ•°å°±æ˜¯å°†hotpageåˆ°å“¨å…µå¯¹è±¡ä¹‹é—´çš„æ‰€æœ‰æ³¨å†Œçš„å¯¹è±¡æ¸…é™¤å¹¶å‘é€releaseæ¶ˆæ¯é‡Šæ”¾å¯¹è±¡ã€‚</p>
<p>åœ¨å­çº¿ç¨‹ä¸­ï¼Œç³»ç»Ÿä¼šåœ¨åˆ›å»ºçº¿ç¨‹æ—¶è°ƒç”¨pushï¼Œåœ¨çº¿ç¨‹é”€æ¯æ—¶è°ƒç”¨popï¼Œå› æ­¤å¦‚æœä½ æ²¡æœ‰æ˜¾ç¤ºåˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œé‚£ä¹ˆåœ¨è¿™æœŸé—´äº§ç”Ÿçš„è‡ªåŠ¨é‡Šæ”¾å¯¹è±¡éœ€è¦ç­‰åˆ°çº¿ç¨‹é”€æ¯æ—¶æ‰ä¼šè¢«é‡Šæ”¾ï¼Œè€Œè¿™å¯èƒ½ä¼šé€ æˆå†…å­˜å³°å€¼å‹åŠ›ã€‚</p>
<h3 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h3><h4 id="Q0ï¼šMRCä¸‹ç»™å¯¹è±¡å‘é€-autoreleaseæ¶ˆæ¯ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ"><a href="#Q0ï¼šMRCä¸‹ç»™å¯¹è±¡å‘é€-autoreleaseæ¶ˆæ¯ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ" class="headerlink" title="Q0ï¼šMRCä¸‹ç»™å¯¹è±¡å‘é€-autoreleaseæ¶ˆæ¯ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ"></a>Q0ï¼šMRCä¸‹ç»™å¯¹è±¡å‘é€-autoreleaseæ¶ˆæ¯ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</h4><p>è°ƒç”¨æ ˆï¼šæœ€ç»ˆå°±æ˜¯è¢«æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± é‡Œã€‚æ³¨æ„è¿™é‡Œå¹¶æ²¡æœ‰retainæ“ä½œã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">- (id)autorelease &#123;</span><br><span class="line">    <span class="keyword">return</span> _objc_rootAutorelease(self);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">id </span><br><span class="line"><span class="title function_">objc_object::rootAutorelease2</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(!isTaggedPointer());</span><br><span class="line">    <span class="keyword">return</span> AutoreleasePoolPage::autorelease((id)this);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> id *<span class="title function_">autoreleaseFast</span><span class="params">(id obj)</span></span><br><span class="line">&#123;</span><br><span class="line">    AutoreleasePoolPage *page = hotPage();</span><br><span class="line">    <span class="keyword">if</span> (page &amp;&amp; !page-&gt;full()) &#123;</span><br><span class="line">        <span class="keyword">return</span> page-&gt;add(obj);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (page) &#123;</span><br><span class="line">        <span class="keyword">return</span> autoreleaseFullPage(obj, page);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> autoreleaseNoPage(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)test_mrc_autorelease &#123;</span><br><span class="line">    XQUser *user = [[XQUser alloc] initWithName:<span class="string">@&quot;æç™½&quot;</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%ld&quot;</span>, (<span class="type">long</span>)<span class="built_in">CFGetRetainCount</span>(user)); <span class="comment">//1</span></span><br><span class="line">    </span><br><span class="line">    [user autorelease];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%ld&quot;</span>, (<span class="type">long</span>)<span class="built_in">CFGetRetainCount</span>(user)); <span class="comment">//1</span></span><br><span class="line">    </span><br><span class="line">    [user autorelease];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%ld&quot;</span>, (<span class="type">long</span>)<span class="built_in">CFGetRetainCount</span>(user)); <span class="comment">//1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//æœ€ç»ˆå´©æºƒï¼Œå› ä¸ºè¿‡åº¦é‡Šæ”¾ã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€Œåœ¨ARCä¸­<code>__autoreleasingä¿®é¥°ç¬¦</code>,å¦‚æœæ˜¯åˆ›å»ºä¸€ä¸ªå¯¹è±¡å¹¶èµ‹å€¼ç»™__autoreleasing çš„æŒ‡é’ˆå˜é‡ï¼Œåˆ™ä»…ä»…æ˜¯å°†å¯¹è±¡æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± ã€‚å…¶ä»–æƒ…å†µåˆ™ä¼šretainå¯¹è±¡å†æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± ä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">@autoreleasepool &#123;</span><br><span class="line">  id obj = [NSObject new];</span><br><span class="line">  &#123;</span><br><span class="line">    id __autoreleasing obj1 = obj; <span class="comment">//2</span></span><br><span class="line">    NSLog(@<span class="string">&quot;obj1:%@&quot;</span>, obj1);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">id obj = msg_Send(NSObject, <span class="string">&quot;new&quot;</span>);</span><br><span class="line">id obj1 = objc_retainAutorelease(obj); <span class="comment">//retainå¯¹è±¡+æ³¨å†Œå¯¹è±¡åˆ°è‡ªåŠ¨é‡Šæ”¾æ± </span></span><br><span class="line">NSLog(@<span class="string">&quot;obj1:%@&quot;</span>, obj1);</span><br><span class="line">objc_storeStrong(&amp;obj, nil);</span><br><span class="line"></span><br><span class="line">id</span><br><span class="line"><span class="title function_">objc_retainAutorelease</span><span class="params">(id obj)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> objc_autorelease(objc_retain(obj));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Q1ï¼šå¦‚ä½•è·å–åˆ›å»ºçš„è‡ªåŠ¨é‡Šæ”¾æ± ï¼Ÿ"><a href="#Q1ï¼šå¦‚ä½•è·å–åˆ›å»ºçš„è‡ªåŠ¨é‡Šæ”¾æ± ï¼Ÿ" class="headerlink" title="Q1ï¼šå¦‚ä½•è·å–åˆ›å»ºçš„è‡ªåŠ¨é‡Šæ”¾æ± ï¼Ÿ"></a>Q1ï¼šå¦‚ä½•è·å–åˆ›å»ºçš„è‡ªåŠ¨é‡Šæ”¾æ± ï¼Ÿ</h4><p>è‡ªåŠ¨é‡Šæ”¾æ± éƒ½æ˜¯newå‡ºæ¥çš„ï¼Œè·å–çš„æ—¶å€™æ€ä¹ˆæ‰¾åˆ°è¿™ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± å‘¢ï¼Ÿä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ°newäº†ä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± é¡µåï¼Œä¼šè°ƒç”¨setHotPage(page);è¿™ä¸ªå‡½æ•°å°±æ˜¯å¾€çº¿ç¨‹çš„TLSä¸Šå†™å…¥keyï¼ˆkey=43ï¼‰â€”pageåœ°å€ã€‚è¿™æ ·ä¸‹æ¬¡æˆ‘ä»¬åªéœ€è¦è¯»å–TLSä¸Šçš„keyå°±å¯ä»¥å¾—åˆ°å½“å‰æ­£åœ¨ä½¿ç”¨çš„è‡ªåŠ¨é‡Šæ”¾æ± é¡µã€‚ç³»ç»Ÿå†…éƒ¨ä¼šä¸€ç›´æ›´æ–°keyçš„å€¼ï¼Œç¡®ä¿keyå§‹ç»ˆæŒ‡å‘å½“å‰æ­£åœ¨ä½¿ç”¨çš„è‡ªåŠ¨é‡Šæ”¾æ± é¡µã€‚æœ‰äº†hotPageçš„åœ°å€ï¼Œå†åŠ ä¸ŠåŒé“¾è¡¨å°±å¯ä»¥æ‰¾åˆ°ç¬¬ä¸€é¡µcoldPageçš„åœ°å€ã€‚</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line">static inline void <span class="built_in">setHotPage</span>(AutoreleasePoolPage *page) </span><br><span class="line">&#123;</span><br><span class="line">    if (page) <span class="attribute">page</span>-&gt;<span class="built_in">fastcheck</span>();</span><br><span class="line">    <span class="built_in">tls_set_direct</span>(key, (void *)<span class="attribute">page</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ä¸€ä¸ªçº¿ç¨‹åªä¼šæœ‰ä¸€ä¸ªåŒé“¾è¡¨è‡ªåŠ¨é‡Šæ”¾æ± ã€‚pushçš„ä½œç”¨ï¼š</p>
<p>1.æ‡’åŠ è½½pageï¼Œå¦‚æœæ­¤æ—¶è¿˜æ²¡æœ‰pageæˆ–è€…pageæ»¡äº†åˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„pageé“¾æ¥åœ¨ä¹‹å‰çš„åŒé“¾è¡¨ä¸Šï¼Œè€Œä¸æ˜¯åˆ›å»ºå¦ä¸€ä¸ªåŒé“¾è¡¨ã€‚</p>
<p>2.è¿”å›ä¸€ä¸ªtokenåœ°å€ã€‚</p>
<p>@autoreleasepoolåµŒå¥—ï¼Œåªæ˜¯è¿”å›ä¸åŒçš„tokenåœ°å€ã€‚æ²¡æœ‰åˆ›å»ºå¾ˆå¤šä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ã€‚</p>
<h4 id="Q2ï¼šåœ¨å­çº¿ç¨‹ä¸­æ²¡æœ‰æ˜¾ç¤ºå†™-autoreleasepool-ç„¶ååˆ›å»ºäº†è‡ªåŠ¨é‡Šæ”¾å¯¹è±¡ï¼Œä¼šé€ æˆå†…å­˜æ³„æ¼å—ï¼Ÿ"><a href="#Q2ï¼šåœ¨å­çº¿ç¨‹ä¸­æ²¡æœ‰æ˜¾ç¤ºå†™-autoreleasepool-ç„¶ååˆ›å»ºäº†è‡ªåŠ¨é‡Šæ”¾å¯¹è±¡ï¼Œä¼šé€ æˆå†…å­˜æ³„æ¼å—ï¼Ÿ" class="headerlink" title="Q2ï¼šåœ¨å­çº¿ç¨‹ä¸­æ²¡æœ‰æ˜¾ç¤ºå†™ @autoreleasepool{} ç„¶ååˆ›å»ºäº†è‡ªåŠ¨é‡Šæ”¾å¯¹è±¡ï¼Œä¼šé€ æˆå†…å­˜æ³„æ¼å—ï¼Ÿ"></a>Q2ï¼šåœ¨å­çº¿ç¨‹ä¸­æ²¡æœ‰æ˜¾ç¤ºå†™ <code>@autoreleasepool&#123;&#125;</code> ç„¶ååˆ›å»ºäº†è‡ªåŠ¨é‡Šæ”¾å¯¹è±¡ï¼Œä¼šé€ æˆå†…å­˜æ³„æ¼å—ï¼Ÿ</h4><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)doSome &#123;</span><br><span class="line">    [<span class="built_in">NSThread</span> detachNewThreadSelector:<span class="keyword">@selector</span>(test_child_thread_autorelease_obj_dealloc) toTarget:<span class="keyword">self</span> withObject:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)test_child_thread_autorelease_obj_dealloc &#123;</span><br><span class="line">    __autoreleasing Animal *ani = [[Animal alloc] init];</span><br><span class="line">    [ani eat];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨NSThreadåˆ›å»ºçš„çº¿ç¨‹æˆ–è€…ä½¿ç”¨gcdï¼Œä½¿ç”¨pthreadç­‰é‡Œéƒ½ä¸ä¼šã€‚åŸºæœ¬ä¸Šä½¿ç”¨è‹¹æœçš„æ¡†æ¶éƒ½ä¸ä¼šã€‚</p>
<p>NSAutoreleasePoolçš„è¯´æ˜ï¼š</p>
<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line">Each thread (including <span class="keyword">the</span> main thread) maintains its own stack <span class="keyword">of</span> NSAutoreleasePool objects (see Threads). As <span class="built_in">new</span> pools are created, they <span class="built_in">get</span> added <span class="built_in">to</span> <span class="keyword">the</span> top <span class="keyword">of</span> <span class="keyword">the</span> stack. When pools are deallocated, they are removed <span class="built_in">from</span> <span class="keyword">the</span> stack. Autoreleased objects are placed <span class="keyword">into</span> <span class="keyword">the</span> top autorelease pool <span class="keyword">for</span> <span class="keyword">the</span> current thread. When <span class="keyword">a</span> thread terminates, <span class="keyword">it</span> automatically drains all <span class="keyword">of</span> <span class="keyword">the</span> autorelease pools associated <span class="keyword">with</span> itself.</span><br></pre></td></tr></table></figure>
<p>åœ¨runtimeåŠ è½½æ—¶ä¼šè°ƒç”¨AutoreleasePoolPageçš„é™æ€æ–¹æ³•initè¿›è¡Œåˆå§‹åŒ–ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">arr_init</span><span class="params">(<span class="type">void</span>)</span> </span><br><span class="line">&#123;</span><br><span class="line">    AutoreleasePoolPage::init();</span><br><span class="line">    SideTablesMap.init();</span><br><span class="line">    _objc_associations_init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‡ªåŠ¨é‡Šæ”¾æ± çš„initï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">init</span><span class="params">()</span> <span class="comment">//é™æ€æ–¹æ³•</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> r __unused = pthread_key_init_np(AutoreleasePoolPage::key, </span><br><span class="line">                                         AutoreleasePoolPage::tls_dealloc);</span><br><span class="line">    ASSERT(r == <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !VARIANT_DYLD</span></span><br><span class="line"><span class="comment">// <span class="doctag">XXX:</span> key should be pthread_key_t</span></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">pthread_key_init_np</span><span class="params">(<span class="type">int</span> key, <span class="type">void</span> (*destructor)(<span class="type">void</span> *))</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> res = EINVAL; <span class="comment">// Returns EINVAL if key is out of range.</span></span><br><span class="line">	<span class="keyword">if</span> (key &gt;= __pthread_tsd_first &amp;&amp; key &lt; __pthread_tsd_start) &#123;</span><br><span class="line">		_PTHREAD_LOCK(__pthread_tsd_lock);</span><br><span class="line">		_pthread_key_set_destructor(key, destructor);</span><br><span class="line">		<span class="keyword">if</span> (key &gt; __pthread_tsd_max) &#123;</span><br><span class="line">			__pthread_tsd_max = key;</span><br><span class="line">		&#125;</span><br><span class="line">		_PTHREAD_UNLOCK(__pthread_tsd_lock);</span><br><span class="line">		res = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !VARIANT_DYLD</span></span></span><br></pre></td></tr></table></figure>
<p>ç»‘å®šäº†ä¸€ä¸ªkeyâ€”tls_deallocï¼Œçº¿ç¨‹é€€å‡ºæ—¶ä¼šæ‰§è¡Œtls_deallocã€‚</p>
<p>çº¿ç¨‹é€€å‡ºæ—¶ä¼šè¿›è¡Œä¸€äº›æ¸…ç†å·¥ä½œï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">PTHREAD_NORETURN</span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line">_pthread_exit(<span class="type">pthread_t</span> self, <span class="type">void</span> *exit_value)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> __<span class="title">darwin_pthread_handler_rec</span> *<span class="title">handler</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Disable signal delivery while we clean up</span></span><br><span class="line">	__disable_threadsignal(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set cancel state to disable and type to deferred</span></span><br><span class="line">	_pthread_setcancelstate_exit(self, exit_value);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> ((handler = self-&gt;__cleanup_stack) != <span class="number">0</span>) &#123;</span><br><span class="line">		(handler-&gt;__routine)(handler-&gt;__arg);</span><br><span class="line">		self-&gt;__cleanup_stack = handler-&gt;__next;</span><br><span class="line">	&#125;</span><br><span class="line">	_pthread_tsd_cleanup(self); <span class="comment">//æ¸…é™¤tsd</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Clear per-thread semaphore cache</span></span><br><span class="line">	os_put_cached_semaphore(SEMAPHORE_NULL);</span><br><span class="line"></span><br><span class="line">	_pthread_terminate_invoke(self, exit_value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ä¸€ä¸ªå°±æ˜¯_pthread_tsd_cleanupï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_pthread_tsd_cleanup(<span class="type">pthread_t</span> self)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !VARIANT_DYLD</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// unless __pthread_key_legacy_behaviour == 1, use the new pthread key</span></span><br><span class="line">	<span class="comment">// destructor order: (dynamic -&gt; static) x5 -&gt; (GC x5)</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (__pthread_key_legacy_behaviour == <span class="number">0</span>) &#123;</span><br><span class="line">		_pthread_tsd_cleanup_new(self);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		_pthread_tsd_cleanup_legacy(self);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// !VARIANT_DYLD</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line">_pthread_tsd_cleanup_new(<span class="type">pthread_t</span> self)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> j;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// clean up all keys</span></span><br><span class="line">	<span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; PTHREAD_DESTRUCTOR_ITERATIONS; j++) &#123;</span><br><span class="line">		<span class="type">pthread_key_t</span> k;</span><br><span class="line">		<span class="keyword">for</span> (k = __pthread_tsd_start; k &lt;= self-&gt;max_tsd_key; k++) &#123;</span><br><span class="line">			_pthread_tsd_cleanup_key(self, k);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (k = __pthread_tsd_first; k &lt;= __pthread_tsd_max; k++) &#123;</span><br><span class="line">			_pthread_tsd_cleanup_key(self, k);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	self-&gt;max_tsd_key = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line">_pthread_tsd_cleanup_key(<span class="type">pthread_t</span> self, <span class="type">pthread_key_t</span> key)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">void</span> (*destructor)(<span class="type">void</span> *);</span><br><span class="line">	<span class="keyword">if</span> (_pthread_key_get_destructor(key, &amp;destructor)) &#123;</span><br><span class="line">		<span class="type">void</span> **ptr = &amp;self-&gt;tsd[key];</span><br><span class="line">		<span class="type">void</span> *value = *ptr;</span><br><span class="line">		<span class="keyword">if</span> (value) &#123;</span><br><span class="line">			*ptr = <span class="literal">NULL</span>;</span><br><span class="line">			<span class="keyword">if</span> (destructor) &#123; <span class="comment">//å…¶ä¸­ä¸€ä¸ªå°±æ˜¯tls_dealloc</span></span><br><span class="line">				destructor(value);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆä¼šè°ƒç”¨è‡ªåŠ¨é‡Šæ”¾æ± çš„tls_deallocï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">tls_dealloc</span><span class="params">(<span class="type">void</span> *p)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (p == (<span class="type">void</span>*)EMPTY_POOL_PLACEHOLDER) &#123;</span><br><span class="line">        <span class="comment">// No objects or pool pages to clean up here.</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// reinstate TLS value while we work</span></span><br><span class="line">    setHotPage((AutoreleasePoolPage *)p);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (AutoreleasePoolPage *page = coldPage()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!page-&gt;empty()) objc_autoreleasePoolPop(page-&gt;begin());  <span class="comment">// pop all of the pools</span></span><br><span class="line">        <span class="keyword">if</span> (slowpath(DebugMissingPools || DebugPoolAllocation)) &#123;</span><br><span class="line">            <span class="comment">// pop() killed the pages already</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            page-&gt;kill();  <span class="comment">// free all of the pages</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clear TLS value so TLS destruction doesn&#x27;t loop</span></span><br><span class="line">    setHotPage(nil);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨objc_autoreleasePoolPopå°†å…¶ä¸­çš„å¯¹è±¡é‡Šæ”¾æ‰ã€‚</p>
<p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå…³é”®ç‚¹ï¼Œä¸objc_autoreleasePoolPopç›¸å¯¹åº”çš„objc_autoreleasePoolPushæ˜¯ä»€ä¹ˆæ—¶å€™è°ƒç”¨çš„ï¼Ÿ</p>
<p>æˆ‘ä»¬å¯ä»¥æ‰“æ–­ç‚¹æŸ¥çœ‹ä¸€ä¸‹ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20200917095746.png" style="zoom:50%;" /></p>
<p>å¯ä»¥çœ‹åˆ°åœ¨å­çº¿ç¨‹å¯åŠ¨çš„æ—¶å€™ç³»ç»Ÿå†…éƒ¨ä¼šæ‰§è¡Œobjc_autoreleasePoolPushï¼Œå¸®ä½ åˆ›å»ºå¥½ä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ã€‚æ‰€ä»¥å³ä½¿åœ¨å­çº¿ç¨‹é‡Œä¸æ˜¾å¼ä½¿ç”¨ <code>@autorelease&#123;&#125;</code> ï¼Œåˆ›å»ºçš„è‡ªåŠ¨é‡Šæ”¾å¯¹è±¡æœ€ç»ˆä¹Ÿä¼šé”€æ¯ï¼Œä½†æ˜¯éœ€è¦ç­‰åˆ°çº¿ç¨‹é€€å‡ºæ—¶æ‰ä¼šè¿›è¡Œã€‚æ‰€ä»¥æœ€å¥½è¿˜æ˜¯åˆ›å»ºè‡ªå·±çš„è‡ªåŠ¨é‡Šæ”¾æ± ã€‚</p>
<h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><p>1ã€C++ä¸­ç»“æ„ä½“å¯ä»¥ç»§æ‰¿ç±»ï¼Œè€Œç±»ä¹Ÿå¯ä»¥ç»§æ‰¿ç»“æ„ä½“ï¼ˆå¤šå°‘æœ‰ç‚¹éœ‡æƒŠï¼‰ï¼Œè¿™æ—¶çš„è®¿é—®æƒé™å–å†³äºå­ç±»æˆ–å­ç»“æ„ä½“è€Œéçˆ¶ç±»æˆ–çˆ¶ç»“æ„ä½“ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<p>struct A {};</p>
<p>struct B : A {}; //publicç»§æ‰¿</p>
<p>class C : A {}; //privateç»§æ‰¿</p>
<p>2ã€C++å¯¹è±¡çš„åˆ›å»ºï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">    <span class="comment">// insert code here...</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Hello, World!\n&quot;</span>;</span><br><span class="line">   	&#123;</span><br><span class="line">    	 <span class="keyword">struct</span> <span class="title class_">MyStruct</span> &#123;</span><br><span class="line">        <span class="built_in">MyStruct</span>() &#123;std::cout &lt;&lt; <span class="string">&quot;åˆå§‹åŒ–\n&quot;</span>;&#125;</span><br><span class="line">        ~<span class="built_in">MyStruct</span>() &#123;std::cout &lt;&lt; <span class="string">&quot;é”€æ¯\n&quot;</span>;&#125;</span><br><span class="line">    	 &#125;;</span><br><span class="line">    	 <span class="keyword">struct</span> <span class="title class_">MyStruct</span> sd; <span class="comment">//è¿™é‡Œå°±å·²ç»åˆ†é…æ ˆå†…å­˜äº†ã€‚åˆå§‹åŒ–æ–¹æ³•ä¹Ÿä¼šè°ƒç”¨(å¤šå°‘æœ‰ç‚¹éœ‡æƒŠ)ã€‚ç±»ä¼¼äºint a;</span></span><br><span class="line">   	&#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ‰“å°</span></span><br><span class="line">Hello, World!</span><br><span class="line">åˆå§‹åŒ–</span><br><span class="line">é”€æ¯</span><br></pre></td></tr></table></figure>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://aevit.xyz/2017/03/12/iOS-autorelease/">iOS è‡ªåŠ¨é‡Šæ”¾æ± åŸç†æ¢ç©¶</a></p>
<p><a href="http://blog.sunnyxx.com/2014/10/15/behind-autorelease/">é»‘å¹•èƒŒåçš„Autorelease</a></p>
<p><a href="https://draveness.me/autoreleasepool#">è‡ªåŠ¨é‡Šæ”¾æ± çš„å‰ä¸–ä»Šç”Ÿ â€”â€” æ·±å…¥è§£æ autoreleasepool</a></p>
<p><a href="https://developer.apple.com/documentation/foundation/nsautoreleasepool?language=occ">NSAutoreleasePool</a></p>
<p><a href="https://www.jianshu.com/p/7bd2f85f03dc">iOSå†…å­˜ç®¡ç†-æ·±å…¥è§£æè‡ªåŠ¨é‡Šæ”¾æ± </a>  æŒºä¸é”™çš„</p>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
      <tags>
        <tag>å†…å­˜ç®¡ç†</tag>
      </tags>
  </entry>
  <entry>
    <title>NSMutableArrayå®ç°åŸç†</title>
    <url>/2020/05/17/NSMutableArray%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<p>æœ¬æ–‡åŸºäº<a href="https://ciechanow.ski/exposing-nsmutablearray/">Exposing NSMutableArray</a> ç†è§£å’Œæ‰©å±•ã€‚</p>
<p>Cè¯­è¨€ä¸­çš„æ•°ç»„å¯ä»¥è¯´æ˜¯æœ€åŸºæœ¬çš„æ•°æ®ç»“æ„äº†ï¼Œå…¶ä»–ä¸€äº›æ•°æ®ç»“æ„æ¯”å¦‚é˜Ÿåˆ—ï¼Œå¾ªç¯é˜Ÿåˆ—ç­‰éƒ½å¯ä»¥åŸºäºæ™®é€šCæ•°ç»„çš„è¿›ä¸€æ­¥å°è£…æ¥å®ç°ã€‚</p>
<h2 id="æ™®é€šCæ•°ç»„"><a href="#æ™®é€šCæ•°ç»„" class="headerlink" title="æ™®é€šCæ•°ç»„"></a>æ™®é€šCæ•°ç»„</h2><p>æ•°ç»„å æ®çš„æ˜¯ä¸€æ®µè¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œå¹¶æ ¹æ®é¡ºåºå­˜å‚¨æ•°æ®ã€‚</p>
<p>ä¼˜ç‚¹ï¼šæ—¶é—´æ•ˆç‡å¾ˆé«˜</p>
<p>ç”±äºæ•°ç»„ä¸­çš„å†…å­˜æ˜¯è¿ç»­çš„ï¼Œå› æ­¤å¯ä»¥æ ¹æ®ä¸‹æ ‡è¯»å†™ä»»ä½•å…ƒç´ ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(1)ã€‚</p>
<p>ç¼ºç‚¹ï¼šç©ºé—´æ•ˆç‡è¾ƒä½</p>
<p>åˆ›å»ºæ•°ç»„æ—¶éœ€è¦å…ˆæŒ‡å®šæ•°ç»„çš„å®¹é‡å¤§å°ï¼Œç„¶åæ ¹æ®å¤§å°åˆ†é…å†…å­˜ã€‚å³ä½¿åªåœ¨æ•°ç»„ä¸­å­˜å‚¨ä¸€ä¸ªå…ƒç´ ä¹Ÿéœ€è¦ä¸ºæ‰€æœ‰çš„æ•°æ®é¢„å…ˆåˆ†é…å†…å­˜ã€‚å› æ­¤å®ƒçš„ç©ºé—´æ•ˆç‡ä¸æ˜¯å¾ˆé«˜ï¼Œç»å¸¸ä¼šæœ‰ç©ºé—²åŒºåŸŸæ²¡æœ‰è¢«ä½¿ç”¨ã€‚</p>
<p>å¦ä¸€ä¸ªæ˜æ˜¾çš„ç¼ºç‚¹æ˜¯ï¼šåœ¨ä¸‹æ ‡ 0 å¤„æ’å…¥æˆ–åˆ é™¤ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œéœ€è¦ç§»åŠ¨å…¶å®ƒæ‰€æœ‰çš„å…ƒç´ ã€‚å½“æ•°æ®é‡å¾ˆå¤§æ—¶ï¼Œæ€§èƒ½å°±å˜å¾—å¾ˆå·®ã€‚</p>
<h2 id="å¾ªç¯é˜Ÿåˆ—"><a href="#å¾ªç¯é˜Ÿåˆ—" class="headerlink" title="å¾ªç¯é˜Ÿåˆ—"></a>å¾ªç¯é˜Ÿåˆ—</h2><p>å¦‚ä½•é¿å…è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯å¾ªç¯é˜Ÿåˆ—ã€‚å¾ªç¯é˜Ÿåˆ—åœ¨è¿›è¡Œå…¥é˜Ÿå’Œå‡ºé˜Ÿæ“ä½œæ—¶ï¼Œå…¶ä»–å…ƒç´ æ˜¯ä¸éœ€è¦ç§»åŠ¨çš„ã€‚å› æ­¤å¯ä»¥å€Ÿé‰´è¿™ä¸ªæ€æƒ³ã€‚ç†è§£äº†å¾ªç¯é˜Ÿåˆ—åŸºæœ¬ä¸Šå°±ç†è§£äº†NSMutableArrayçš„åº•å±‚æ•°æ®ç»“æ„ã€‚</p>
<p>å¾ªç¯é˜Ÿåˆ—é‡Œä¸€ä¸ªå¾ˆé‡è¦çš„æ“ä½œå°±æ˜¯å–æ¨¡ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå¯¹äºä»»ä½•ä¸€ä¸ªè‡ªç„¶æ•°ï¼Œæ¨¡ä¸Š5ï¼Œå¾—åˆ°çš„ç»“æœéƒ½ä¼šåœ¨[0,4]ä¹‹é—´ã€‚</p>
<p>0%5  = 0ï¼Œ1%5  = 1ï¼Œ2%5  = 2ï¼Œ3%5  = 3ï¼Œ4%5  = 4ï¼Œ5%5  = 0ï¼Œ6%5  = 1ï¼Œ7%5  = 2ï¼Œ â€¦â€¦ã€‚çœ‹åˆ°æ²¡æœ‰ï¼Œç»“æœå·²ç»å¼€å§‹å¾ªç¯äº†ã€‚</p>
<p>å¾ªç¯é˜Ÿåˆ—çš„å£°æ˜ï¼š</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CircularQueue</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">private(set)</span> <span class="keyword">var</span> size: <span class="type">Int</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">private(set)</span> <span class="keyword">var</span> count: <span class="type">Int</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">  <span class="keyword">var</span> head: <span class="type">Int</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">  <span class="keyword">var</span> tail: <span class="type">Int</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">  <span class="keyword">var</span> items: [<span class="type">Int</span>] <span class="operator">=</span> []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸€èˆ¬éƒ½ä¼šæœ‰headå’Œtailä¸¤ä¸ªæŒ‡é’ˆï¼Œheadæ€»æ˜¯æŒ‡å‘ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œtailæ€»æ˜¯æŒ‡å‘ä¸‹ä¸€ä¸ªå­˜å‚¨çš„å…ƒç´ çš„ä½ç½®ã€‚ä¹Ÿå¯ä»¥ä¸ä½¿ç”¨tailï¼Œè€Œä½¿ç”¨headå’Œcountï¼Œå› ä¸ºtail = head + countã€‚</p>
<p>åˆå§‹åŒ–æ—¶head==tailã€‚å¦å¤–headå¯ä»¥ç­‰äº0ä¹Ÿå¯ä»¥ä¸ç­‰äº0è¿™ä¸ªä¸é‡è¦ï¼Œå› ä¸ºæ˜¯å¾ªç¯çš„ï¼Œæ‰€ä»¥æ— è®ºä»å“ªä¸ªç‚¹å¼€å§‹éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p>
<p>è¿™é‡Œåˆå§‹åŒ–ï¼šhead==tail=0ã€‚</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/618F53DD5E0AC45A98E4192354D0F63E.jpg" style="zoom:50%;" /></p>
<p>å…¥é˜Ÿ1</p>
<p>æ¯æ¬¡å…¥é˜Ÿæ—¶ï¼Œtailå¾€åç§»åŠ¨ä¸€ä¸ªä½ç½®ã€‚</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/488D507C0EC5B5CDA656D769F25C9281.jpg" style="zoom:50%;" /></p>
<p>å…¥4</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20200517115455.png" style="zoom:50%;" /></p>
<p>å…¥5</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/8C560E41A5516F18BAE25E17928B9A3C.jpg" style="zoom:50%;" /></p>
<p>å…¥é˜Ÿ5æ—¶ï¼Œé˜Ÿåˆ—å°±æ»¡äº†ï¼Œtailçš„ä½ç½®åˆå›åˆ°äº†åŸç‚¹ã€‚æ­¤æ—¶å°±ä¸å†å…è®¸å…¥é˜Ÿäº†å› ä¸ºå·²ç»æ»¡äº†ã€‚</p>
<p>å› æ­¤æ¯æ¬¡å…¥é˜Ÿæ—¶ï¼Œtailå¾€åç§»åŠ¨ä¸€ä¸ªä½ç½®ï¼Œå¯¹åº”çš„ä»£ç ä¸ºï¼š</p>
<p>tail = (tail + 1) % sizeã€‚æ¨¡sizeæ„å‘³ç€è¶…å‡ºsizeæ—¶å›åˆ°åŸæ¥çš„ä½ç½®ã€‚å¼€å§‹å¾ªç¯ã€‚è¿™å°±æ˜¯å–æ¨¡çš„é­…åŠ›ã€‚</p>
<p>å†æ¥çœ‹å‡ºé˜Ÿï¼š</p>
<p>è¿™é‡Œè¿ç»­å‡ºé˜Ÿ1ï¼Œ2ï¼Œ3ã€‚æ¯æ¬¡å‡ºé˜Ÿåï¼Œheadå°±å¾€åç§»åŠ¨ä¸€ä¸ªä½ç½®ï¼ŒæŒ‡å‘æ–°çš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„ä½ç½®ï¼Œå¯¹åº”çš„ä»£ç ä¸ºï¼š</p>
<p>head = (head + 1) % sizeã€‚</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/6C548BF9E45EA310CDBF27701E5131E7.jpg" style="zoom:50%;" /></p>
<p>å†å…¥é˜Ÿ3ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/667D39026317F4D61F674BB94052BA4F.jpg" style="zoom:50%;" /></p>
<p>è¿™æ ·headå’Œtailå°±ä¸æ–­çš„å¾ªç¯ï¼Œå……åˆ†åˆ©ç”¨äº†ç©ºé—´ï¼Œå¹¶ä¸”æ¯æ¬¡æ“ä½œæ—¶å…¶ä»–å…ƒç´ æ˜¯ä¸åŠ¨çš„ã€‚</p>
<p>ä¸Šé¢çš„æ•°ç»„çš„å†…å®¹ä¸º[4,5,3]ã€‚å¦‚æœæˆ‘ä»¬æƒ³ç”¨ä¸‹æ ‡æ¥ç›´æ¥å–å‡ºä¸€ä¸ªå…ƒç´ è¯¥æ€ä¹ˆæ“ä½œå‘¢ã€‚æ¯”å¦‚a[2] = 3ã€‚</p>
<p>åˆ©ç”¨headå°±å¯ä»¥è½»æ¾è®¡ç®—å‡ºå®é™…çš„ä¸‹æ ‡ï¼šrealIndex = (head + index) % size ã€‚</p>
<p>å³realIndex = (3 + 2) % 5 = 0ï¼ŒåŸæ•°ç»„ä¸‹æ ‡0å³ä¸ºè¦å–çš„å…ƒç´ ã€‚</p>
<p>åˆ©ç”¨å¾ªç¯é˜Ÿåˆ—ç»“åˆå–æ¨¡æ“ä½œï¼Œæˆ‘ä»¬æ—¢åšåˆ°äº†æ’å…¥æˆ–åˆ é™¤ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œä¸ç§»åŠ¨å…¶å®ƒå…ƒç´ ã€‚åˆå¯ä»¥é€šè¿‡ä¸‹æ ‡æ¥å–å‡ºå…ƒç´ ã€‚</p>
<p>æœ‰å…´è¶£çš„å¯ä»¥åˆ·ä¸€ä¸‹LeetCodeçš„<a href="https://leetcode-cn.com/problems/design-circular-queue/">622. è®¾è®¡å¾ªç¯é˜Ÿåˆ—</a>ï¼ŒåŠ æ·±ç†è§£ã€‚</p>
<h2 id="å¾ªç¯åŒç«¯é˜Ÿåˆ—"><a href="#å¾ªç¯åŒç«¯é˜Ÿåˆ—" class="headerlink" title="å¾ªç¯åŒç«¯é˜Ÿåˆ—"></a>å¾ªç¯åŒç«¯é˜Ÿåˆ—</h2><p>ä¸Šé¢çš„å¾ªç¯é˜Ÿåˆ—ä¾ç„¶éµå®ˆé˜Ÿå¤´å‡ºï¼Œé˜Ÿå°¾å…¥çš„è§„åˆ™ã€‚æœ‰æ—¶å€™å°±ä¸å¤ªçµæ´»ï¼Œäºæ˜¯å°±æœ‰å¾ªç¯åŒç«¯é˜Ÿåˆ—è¿™ä¸€å˜ç§ï¼Œå®ƒå¯ä»¥åœ¨ä¸¤ç«¯è¿›è¡Œæ’å…¥å’Œåˆ é™¤æ“ä½œï¼Œä½†ä¸èƒ½åœ¨ä¸­é—´æ“ä½œã€‚</p>
<p>å¯ä»¥åˆ·ä¸€ä¸‹<a href="https://leetcode-cn.com/problems/design-circular-deque/">641. è®¾è®¡å¾ªç¯åŒç«¯é˜Ÿåˆ—</a>ï¼Œç”±äºå’Œå¾ªç¯é˜Ÿåˆ—å·®åˆ«ä¸å¤§ï¼Œè¿™é‡Œå°±ä¸åšä»‹ç»äº†ã€‚</p>
<p>å¾ªç¯åŒç«¯é˜Ÿåˆ—å’ŒNSMutableArrayçš„åº•å±‚æ•°æ®ç»“æ„å°±æ›´æ¥è¿‘äº†ã€‚</p>
<p>åœ¨å¤´éƒ¨æ’å…¥ï¼šhead = (head-1+size)%size</p>
<p>åœ¨å¤´éƒ¨ç§»é™¤ï¼šhead = (head+1)%size</p>
<p>åœ¨å°¾éƒ¨æ’å…¥ï¼štail = (tail+1)%size</p>
<p>åœ¨å°¾éƒ¨ç§»é™¤ï¼štail = (tail-1+size)%size</p>
<p>è®¿é—®å…ƒç´ ï¼šrealIndex = (head + index) % size ã€‚</p>
<h2 id="NSMutableArrayåº•å±‚æ•°æ®ç»“æ„"><a href="#NSMutableArrayåº•å±‚æ•°æ®ç»“æ„" class="headerlink" title="NSMutableArrayåº•å±‚æ•°æ®ç»“æ„"></a>NSMutableArrayåº•å±‚æ•°æ®ç»“æ„</h2><p>NSMutableArrayå€Ÿé‰´äº†å¾ªç¯åŒç«¯é˜Ÿåˆ—æ•°æ®ç»“æ„çš„æ€æƒ³ï¼Œåªä¸è¿‡NSMutableArrayè¿˜å…è®¸åœ¨ä¸­é—´è¿›è¡Œæ’å…¥åˆ é™¤ã€‚</p>
<p>NSMutableArrayæ˜¯ä¸€ä¸ªç±»ç°‡ï¼Œå®é™…çš„ç±»å‹æ˜¯__NSArrayMã€‚</p>
<p>__NSArrayMçš„å®ä¾‹å¸ƒå±€ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">__NSArrayM</span> : <span class="title">NSMutableArray</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> _used;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> _doHardRetain:<span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> _doWeakAccess:<span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> _size:<span class="number">62</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> _hasObjects:<span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> _hasStrongReferences:<span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> _offset:<span class="number">62</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> _mutations;</span><br><span class="line">    <span class="type">id</span> *_list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¯”è¾ƒé‡è¦çš„å‡ ä¸ªå±æ€§ï¼š</p>
<p>_usedï¼šå½“å‰å·²ä½¿ç”¨çš„å†…å­˜ç©ºé—´ä¸ªæ•°ï¼Œå³å½“å‰æ•°ç»„ä¸­å…ƒç´ çš„ä¸ªæ•°ã€‚</p>
<p>_sizeï¼šæ•°ç»„çš„å¤§å°</p>
<p>_offsetï¼šæ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ç´¢å¼•ï¼Œå§‹ç»ˆæŒ‡å‘æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚ç›¸å½“äºä¸Šé¢çš„head</p>
<p>_listï¼šç¼“å†²åŒºæŒ‡é’ˆï¼ŒæŒ‡å‘åˆ†é…çš„é‚£ä¸€æ®µè¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œå³å…ƒç´ å­˜å‚¨çš„åœ°æ–¹ã€‚ç›¸å½“äºä¸Šé¢çš„Arrayã€‚</p>
<p>_offset + _usedå°±ç›¸å½“äºä¸Šé¢çš„tailã€‚</p>
<p>ä¸‹æ ‡æŸ¥æ‰¾æ—¶realIndex = (_offset + index) % size ã€‚</p>
<p><strong>åœ¨ä¸¤ç«¯æ“ä½œï¼Œå…¶ä»–å…ƒç´ ä¸éœ€è¦ç§»åŠ¨</strong></p>
<p>åœ¨å¤´éƒ¨è¿›è¡Œæ’å…¥å’Œåˆ é™¤æ“ä½œåŠåœ¨å°¾éƒ¨è¿›è¡Œæ’å…¥å’Œåˆ é™¤æ“ä½œï¼ŒåŒå¾ªç¯åŒç«¯é˜Ÿåˆ—ï¼Œå…¶ä»–å…ƒç´ æ˜¯ä¸éœ€è¦ç§»åŠ¨çš„ï¼Œè¿™å°±æé«˜äº†æ€§èƒ½ã€‚</p>
<p><strong>åœ¨ä¸­é—´æ“ä½œ</strong></p>
<p>delete at middleæˆ–insert at middle</p>
<p>åŸåˆ™ï¼šç§»åŠ¨è¾ƒå°‘çš„ä¸€ç«¯çš„å…ƒç´ ã€‚</p>
<p>åœ¨ä¸­é—´æ’å…¥æˆ–åˆ é™¤æ—¶ä¸å¯é¿å…éœ€è¦ç§»åŠ¨å…ƒç´ å¦åˆ™å°±æ— æ³•é€šè¿‡ä¸‹æ ‡å®šä½å…ƒç´ äº†ï¼Œè¿™é‡Œé‡‡ç”¨ç§»åŠ¨è¾ƒå°‘çš„ä¸€ç«¯çš„å…ƒç´ æ¥æé«˜æ€§èƒ½ã€‚</p>
<p><strong>æ‰©å®¹</strong></p>
<p>æ™®é€šCæ•°ç»„åœ¨åˆå§‹åŒ–æ—¶å®¹é‡å°±å·²ç»ç¡®å®šäº†ï¼Œæ‰€è°“çš„æ’å…¥å’Œåˆ é™¤æ“ä½œå…¶å®éƒ½æ˜¯åœ¨è¿™ä¸ªç¡®å®šçš„å®¹é‡é‡Œè¿›è¡Œï¼Œå¹¶ä¸”æ’å…¥å’Œåˆ é™¤æ“ä½œå¹¶ä¸ä¼šå¯¹è¿™ä¸ªç¡®å®šçš„å®¹é‡æœ‰ä»€ä¹ˆå½±å“ï¼Œåªæœ‰åœ¨æ’å…¥æ—¶å®¹é‡ä¸è¶³äº†ï¼Œæ‰éœ€è¦æ‰©å®¹ã€‚</p>
<p>å®¹é‡ä¸å¤Ÿæ—¶ï¼ŒNSMutableArrayä¼šæ‰©å¤§åˆ°åŸæ¥çš„1.625å€ï¼Œå¹¶ä¸æ˜¯2å€ï¼Œè¿™ä¸ªéƒ½æ˜¯æœ‰è®²ç©¶çš„ã€‚æ‰©å¤§åå³ä½¿å…ƒç´ å…¨éƒ¨ç§»é™¤ä¹Ÿä¸ä¼šå†ç¼©å‡ç©ºé—´ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://ciechanow.ski/exposing-nsmutablearray/">Exposing NSMutableArray</a> è¯‘æ–‡ï¼š<a href="http://blog.joyingx.me/2015/05/03/NSMutableArray%20%E5%8E%9F%E7%90%86%E6%8F%AD%E9%9C%B2/">NSMutableArrayåŸç†æ­éœ²</a></p>
<p><a href="https://blog.csdn.net/Deft_MKJing/article/details/82732833">NSDictionaryå’ŒNSMutableArray</a></p>
<p><a href="https://www.jianshu.com/p/9ba8a65464dd">æ•°æ®ç»“æ„ ç¬¬7è®² å¾ªç¯é˜Ÿåˆ—</a></p>
<p><a href="https://juejin.im/post/5d5fb74fe51d45620346b8d0">çœ‹å®Œè¿™ç¯‡ä½ è¿˜ä¸çŸ¥é“è¿™äº›é˜Ÿåˆ—ï¼Œæˆ‘è¿™äº›å›¾ç™½ä½œäº†</a> è®²è§£äº†å„ç§é˜Ÿåˆ—ã€‚</p>
<p><a href="https://zhuanlan.zhihu.com/p/72007079">å †ã€æ ˆå’Œé˜Ÿåˆ—å¦‚ä½•ç†è§£ä¸åº”ç”¨ï¼Ÿ</a> ä¸»è¦è®²æ•°æ®ç»“æ„ä¸­çš„å †å’Œæ ˆã€‚</p>
<p><a href="https://zhuanlan.zhihu.com/p/66922957">æ€æ ·æ·±å…¥ç†è§£å †å’Œæ ˆ</a> ä¸»è¦è®²æ“ä½œç³»ç»Ÿä¸­<strong>å†…å­˜åˆ†é…æ–¹å¼</strong>çš„å †å’Œæ ˆã€‚</p>
<p><a href="https://juejin.im/entry/58330cbfa0bb9f005a0fed62">å¸¸è§æ•°æ®ç»“æ„ (ä¸€)- æ ˆ, é˜Ÿåˆ—, å †, å“ˆå¸Œè¡¨</a></p>
<p><strong>iOSé€†å‘</strong></p>
<p>çŸ¥è¯†å‚¨å¤‡</p>
<p><a href="https://chinafishnews.github.io/2018/05/29/class-dump%E5%92%8CMachO%E6%96%87%E4%BB%B6/">class-dumpå’ŒMachOæ–‡ä»¶</a></p>
<p><a href="https://www.jianshu.com/p/6b6691d52e8a">iOSé€†å‘å·¥å…·ä¹‹class-dump(MacOS)ä»‹ç»</a> æœ¬æ–‡ä½œè€…å¯¹iOSé€†å‘æœ‰è¾ƒæ·±å…¥ç ”ç©¶ã€‚</p>
<p>class-dumpå®‰è£…ç›®å½•ï¼š<code>/usr/local/bin</code></p>
<p><code>class-dump -H /System/Library/Frameworks/CoreFoundation.framework -o ç›®çš„æ–‡ä»¶å¤¹</code></p>
<p>Xcode11ä¸èƒ½ä½¿ç”¨ä¸‹é¢çš„CoreFoundationè·¯å¾„ã€‚ï¼ˆç½‘ä¸Šçš„æ•™ç¨‹éƒ½æ˜¯ä¸‹é¢çš„è·¯å¾„ï¼Œä½†å®éªŒè¯æ˜ä¸è¡Œï¼‰</p>
<p><code>/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk/System/Library/Frameworks/CoreFoundation.framework</code></p>
<p>åº“çš„è·¯å¾„æ•´äº†ä¸€å¤©ï¼Œçœ‹æ¥æ˜¯è·¯å¾„å˜äº†ã€‚</p>
<p>åˆ«äººæ•´å¥½çš„ï¼šå…³äºiOS SDKçš„æ‰€æœ‰å¤´æ–‡ä»¶ï¼Œæ—©æœ‰ä¸“äººå»ºç«‹äº†ä¸€ä¸ªåœ¨çº¿ç½‘ç«™å»åˆ†æï¼Œç‚¹å‡»è·³è½¬ï¼š<a href="http://developer.limneos.net/">iOS Runtime Headers</a></p>
<p><a href="https://github.com/w0lfschild/macOS_headers">macOS_headers</a> macOSä¸Šçš„Frameworks class-dumpã€‚</p>
<p>å¦ä¸€æ¬¾å·¥å…·ï¼š<a href="https://derekselander.github.io/dsdump/">dsdump</a>ï¼šAn improved nm + Objective-C &amp; Swift class-dump</p>
]]></content>
      <categories>
        <category>Foundation</category>
      </categories>
      <tags>
        <tag>NSMutableArray</tag>
      </tags>
  </entry>
  <entry>
    <title>OCç±»å‹è‡ªçœå‡½æ•°</title>
    <url>/2020/05/05/OC%E7%B1%BB%E5%9E%8B%E8%87%AA%E7%9C%81%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<p>å…ˆä¸Šæµ‹è¯•ä»£ç :</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">ZAEImageView *img = [ZAEImageView new];</span><br><span class="line"><span class="type">BOOL</span> isMember1 = [img isMemberOfClass:ZAEImageView.class];</span><br><span class="line"><span class="type">BOOL</span> isMember2 = [img isMemberOfClass:<span class="built_in">UIImageView</span>.class];</span><br><span class="line"><span class="type">BOOL</span> isMember3 = [ZAEImageView isMemberOfClass:ZAEImageView.class];</span><br><span class="line"><span class="type">BOOL</span> isMember4 = [ZAEImageView isMemberOfClass:<span class="built_in">UIImageView</span>.class];</span><br><span class="line"><span class="type">BOOL</span> isMember5 = [ZAEImageView isMemberOfClass:object_getClass(ZAEImageView.class)];</span><br><span class="line"><span class="type">BOOL</span> isMember6 = [ZAEImageView isMemberOfClass:object_getClass(<span class="built_in">UIImageView</span>.class)];</span><br><span class="line"><span class="type">BOOL</span> isKind1 = [img isKindOfClass:ZAEImageView.class];</span><br><span class="line"><span class="type">BOOL</span> isKind2 = [img isKindOfClass:<span class="built_in">UIImageView</span>.class];</span><br><span class="line"><span class="type">BOOL</span> isKind3 = [ZAEImageView isKindOfClass:ZAEImageView.class];</span><br><span class="line"><span class="type">BOOL</span> isKind4 = [ZAEImageView isKindOfClass:<span class="built_in">UIImageView</span>.class];</span><br><span class="line"><span class="type">BOOL</span> isKind5 = [ZAEImageView isKindOfClass:object_getClass(ZAEImageView.class)];</span><br><span class="line"><span class="type">BOOL</span> isKind6 = [ZAEImageView isKindOfClass:object_getClass(<span class="built_in">UIImageView</span>.class)];</span><br></pre></td></tr></table></figure>
<p>ç»“æœ:</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/OC%E7%B1%BB%E5%9E%8B%E8%87%AA%E7%9C%81_%E7%BB%93%E6%9E%9C.jpg" alt="ç»“æœ"></p>
<p>OCç±»å‹è‡ªçœçš„å‡½æ•°å¦‚ä¸‹:</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)isKindOfClass:(Class)aClass;</span><br><span class="line">- (<span class="type">BOOL</span>)isMemberOfClass:(Class)aClass;</span><br></pre></td></tr></table></figure>
<p>å®ƒä»¬å£°æ˜åœ¨<code>@protocol NSObject</code>ä¸­,NSObjectç±»å®ç°äº†NSObjectåè®®<code>@interface NSObject &lt;NSObject&gt;</code>.</p>
<p>å¯ä»¥çœ‹åˆ°å®ƒä»¬éƒ½æ˜¯å®ä¾‹æ–¹æ³•,ä½†æ˜¯ä¸ºä»€ä¹ˆå¯ä»¥å‘é€ç»™ç±»å¯¹è±¡?å’Œå…ƒç±»æœ‰å…³.</p>
<p><code>- (BOOL)isMemberOfClass:(Class)aClass;</code></p>
<p>Returns a Boolean value that indicates whether the receiver is an instance of a given class.</p>
<p>ç”¨äºæ£€æµ‹æ¶ˆæ¯æ¥æ”¶è€…æ˜¯å¦æ˜¯æŸä¸ªç±»çš„å®ä¾‹.</p>
<p><code>- (BOOL)isKindOfClass:(Class)aClass;</code></p>
<p>Returns a Boolean value that indicates whether the receiver is an instance of given class or an instance of any class that inherits from that class.</p>
<p>ç”¨äºæ£€æµ‹æ¶ˆæ¯æ¥æ”¶è€…æ˜¯å¦æ˜¯æŸä¸ªç±»çš„å®ä¾‹æˆ–è€…æ˜¯å…¶å­ç±»çš„å®ä¾‹.æ³¨æ„ä¸<code>isMemberOfClass</code>çš„åŒºåˆ«.</p>
<h4 id="å¯¹å®ä¾‹å¯¹è±¡è¿›è¡Œè‡ªçœ"><a href="#å¯¹å®ä¾‹å¯¹è±¡è¿›è¡Œè‡ªçœ" class="headerlink" title="å¯¹å®ä¾‹å¯¹è±¡è¿›è¡Œè‡ªçœ"></a>å¯¹å®ä¾‹å¯¹è±¡è¿›è¡Œè‡ªçœ</h4><p>ç¤ºä¾‹:<code>[img isKindOfClass:UIImageView.class];</code>è¿™ä¸ªå¾ˆå¥½ç†è§£,ä¸æ˜¯ä»Šå¤©çš„é‡ç‚¹.</p>
<h4 id="å¯¹ç±»å¯¹è±¡è¿›è¡Œè‡ªçœ"><a href="#å¯¹ç±»å¯¹è±¡è¿›è¡Œè‡ªçœ" class="headerlink" title="å¯¹ç±»å¯¹è±¡è¿›è¡Œè‡ªçœ"></a>å¯¹ç±»å¯¹è±¡è¿›è¡Œè‡ªçœ</h4><p>ç¤ºä¾‹:<code>[ZAEImageView isKindOfClass:object_getClass(UIImageView.class)];</code></p>
<p>å¯¹ç±»å¯¹è±¡è¿›è¡Œè‡ªçœæ—¶isKindOfClassçš„å‚æ•°ä¸ºå•¥æ˜¯<code>object_getClass(UIImageView.class)</code>è€Œä¸èƒ½æ˜¯<code>UIImageView.class</code>?</p>
<p>å…¶å®ä¹Ÿå¾ˆç®€å•:å®ä¾‹å¯¹è±¡çš„ç±»å‹æ˜¯ç±»å¯¹è±¡,ç±»å¯¹è±¡çš„ç±»å‹æ˜¯å…ƒç±»å¯¹è±¡.å› æ­¤å¯¹ç±»å¯¹è±¡è¿›è¡Œè‡ªçœæ—¶,isKindOfClassçš„å‚æ•°å°±éœ€è¦ä¼ å…¥ç±»å¯¹è±¡çš„ç±»å‹,é‚£å¦‚ä½•è·å–ç±»å¯¹è±¡çš„ç±»å‹å‘¢?ç­”æ¡ˆå°±æ˜¯<code>object_getClass()</code>.</p>
<p><code>OBJC_EXPORT Class _Nullable object_getClass(id _Nullable obj);</code></p>
<p>Returns the class of an object.</p>
<p>è¿”å›ä¸€ä¸ªå¯¹è±¡çš„ç±»å‹.æ³¨æ„è¿™é‡Œçš„å‚æ•°æ˜¯id.å› æ­¤å¯ä»¥æ˜¯ä»»ä½•OCå¯¹è±¡â€”å®ä¾‹å¯¹è±¡,ç±»å¯¹è±¡,å…ƒç±»å¯¹è±¡.</p>
<figure class="highlight smali"><table><tr><td class="code"><pre><span class="line">/// An opaque type that represents an Objective-C class.</span><br><span class="line">typedef struct objc_class *Class;</span><br><span class="line"></span><br><span class="line">/// Represents an<span class="built_in"> instance </span>of a class.</span><br><span class="line">struct objc_object &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAI<span class="class">LABILITY;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/// A pointer to an<span class="built_in"> instance </span>of a class.</span><br><span class="line">typedef struct objc_object *id;</span><br><span class="line"></span><br><span class="line">struct objc_class &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAI<span class="class">LABILITY;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#if !__OBJC2__</span></span><br><span class="line">    Class _Nullable super_class                              OBJC2_UNAVAI<span class="class">LABLE;</span></span><br><span class="line">   <span class="built_in"> const </span>char * _Nonnull name                               OBJC2_UNAVAI<span class="class">LABLE;</span></span><br><span class="line">   <span class="built_in"> long </span>version                                             OBJC2_UNAVAI<span class="class">LABLE;</span></span><br><span class="line">   <span class="built_in"> long </span>info                                                OBJC2_UNAVAI<span class="class">LABLE;</span></span><br><span class="line">   <span class="built_in"> long </span>instance_size                                       OBJC2_UNAVAI<span class="class">LABLE;</span></span><br><span class="line">    struct objc_ivar_list * _Nullable ivars                  OBJC2_UNAVAI<span class="class">LABLE;</span></span><br><span class="line">    struct objc_method_list * _Nullable * _Nullable method<span class="class">Lists                    OBJC2_UNAVAILABLE;</span></span><br><span class="line">    struct objc_cache * _Nonnull cache                       OBJC2_UNAVAI<span class="class">LABLE;</span></span><br><span class="line">    struct objc_protocol_list * _Nullable protocols          OBJC2_UNAVAI<span class="class">LABLE;</span></span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line">&#125; OBJC2_UNAVAI<span class="class">LABLE;</span></span><br></pre></td></tr></table></figure>
<p>è‡³äºä¸ºä»€ä¹ˆidå¯ä»¥æŒ‡å‘ä»»æ„OCå¯¹è±¡,ç®€å•ç‚¹è®²å°±æ˜¯å› ä¸ºæ‰€æœ‰OCå¯¹è±¡éƒ½æœ‰ä¸€ä¸ª<code>Class isa</code>æŒ‡é’ˆ.å› æ­¤éƒ½å¯ä»¥èµ‹å€¼ç»™idå˜é‡.å…·ä½“å¯ä»¥å‚è€ƒ:<a href="https://juejin.im/post/5ce9541bf265da1b6b1cb2c1">iOS OC idç±»å‹ä¸ºä»€ä¹ˆèƒ½æŒ‡å‘ä»»æ„ç±»</a></p>
<p>æµ‹è¯•:</p>
<figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">id cls1 <span class="operator">=</span> img.class<span class="comment">;</span></span><br><span class="line">id cls2 <span class="operator">=</span> object_getClass(img)<span class="comment">;</span></span><br><span class="line">id cls3 <span class="operator">=</span> ZAEImageView.class<span class="comment">;</span></span><br><span class="line">id cls4 <span class="operator">=</span> object_getClass(ZAEImageView.class)<span class="comment">;</span></span><br><span class="line">id cls5 <span class="operator">=</span> objc_getMetaClass(<span class="string">&quot;ZAEImageView&quot;</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>ç»“æœ:</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures//OC%E7%B1%BB%E5%9E%8B%E8%87%AA%E7%9C%81_%E7%BB%93%E6%9E%9C2.jpg" alt="ç»“æœ"></p>
<p>å¯ä»¥çœ‹åˆ°å½“ä¼ å…¥çš„æ˜¯å®ä¾‹å¯¹è±¡æ—¶,object_getClass()è¿”å›çš„æ˜¯å®ä¾‹å¯¹è±¡çš„ç±»å‹â€”ç±»å¯¹è±¡,å¦‚æœä¼ å…¥çš„æ˜¯ç±»å¯¹è±¡,åˆ™object_getClass()è¿”å›çš„æ˜¯ç±»å¯¹è±¡çš„ç±»å‹â€”å…ƒç±»å¯¹è±¡.æ‰€ä»¥cls4æŒ‡å‘çš„åœ°å€å’Œå‰é¢å‡ ä¸ªä¸åŒ.</p>
<p><strong>object_getClass()å®ç°</strong></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">Class <span class="title">object_getClass</span><span class="params">(id obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _object_getClass(obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> Class _object_getClass(id obj)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="meta">#<span class="keyword">if</span> SUPPORT_TAGGED_POINTERS</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">OBJC_IS_TAGGED_PTR</span>(obj)) &#123;</span><br><span class="line">      <span class="type">uint8_t</span> slotNumber = ((<span class="type">uint8_t</span>) (<span class="type">uint64_t</span>) obj) &amp; <span class="number">0x0F</span>;</span><br><span class="line">      Class isa = _objc_tagged_isa_table[slotNumber];</span><br><span class="line">      <span class="keyword">return</span> isa;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span> (obj) <span class="keyword">return</span> obj-&gt;isa;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> Nil;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°object_getClass()å°±æ˜¯è¿”å›å¯¹è±¡çš„isaæŒ‡é’ˆ.</p>
<p>å¦å¤–<code>+ (Class)class,- (Class)class</code>çš„å®ç°åˆ†åˆ«å¦‚ä¸‹:</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">//å£°æ˜äºNSObjectç±»ä¸­,ç±»æ–¹æ³•.è¿”å›è‡ªèº«æŒ‡é’ˆ</span><br><span class="line">+ (Class)<span class="class"><span class="keyword">class</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> //å£°æ˜äºNSObjectåè®®ä¸­,å®ä¾‹æ–¹æ³•.è°ƒç”¨object_getClassï¼Œè¿”å›isaæŒ‡é’ˆ</span><br><span class="line">- (Class)<span class="class"><span class="keyword">class</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> object_getClass(self);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çŸ¥é“äº†å®ç°å°±ä¸éš¾ç†è§£cls1=cls2=cls3=ç±»å¯¹è±¡ä¸ç­‰äºcls4=cls5=å…ƒç±»å¯¹è±¡äº†.</p>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
      <tags>
        <tag>OCç±»å‹è‡ªçœ</tag>
      </tags>
  </entry>
  <entry>
    <title>è‡ªå®šä¹‰Xcodeæ¨¡æ¿</title>
    <url>/2020/05/04/%E8%87%AA%E5%AE%9A%E4%B9%89Xcode%E6%A8%A1%E6%9D%BF/</url>
    <content><![CDATA[<p>å¾ˆå¤šæ—¶å€™æˆ‘ä»¬éœ€è¦ä¸€ä¸ªè¾ƒå¤æ‚åœºæ™¯çš„Demoå·¥ç¨‹æ¥éªŒè¯ç‚¹ä¸œè¥¿æˆ–è€…ç ”ç©¶æŸä¸ªæŠ€æœ¯ï¼Œç›´æ¥åœ¨å…¬å¸é¡¹ç›®å·¥ç¨‹ä¸­å®éªŒè¿è¡Œåˆå¤ªæ…¢ï¼Œå¹¶ä¸”è¿˜å¯èƒ½å—åˆ°å…¶ä»–ä»£ç çš„å½±å“ã€‚è€ŒXcodeè‡ªèº«æä¾›çš„å·¥ç¨‹æ¨¡æ¿åˆå¤ªè¿‡ç®€å•ï¼Œå¯¼è‡´æ¯æ¬¡éƒ½è¦æµªè´¹å¾ˆå¤šæ—¶é—´ç¼–å†™é‡å¤çš„ä»£ç æ¥æ­å»ºç¯å¢ƒã€‚ä¸ºäº†æé«˜æ•ˆç‡ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰å·¥ç¨‹æ¨¡æ¿å’Œæ–‡ä»¶æ¨¡æ¿ã€‚</p>
<p>å¦‚ä¸‹å›¾ï¼Œç³»ç»Ÿæä¾›çš„é»˜è®¤æ¨¡æ¿å…¶å®éƒ½åœ¨<code>Xcode.app</code>ä¸­ï¼Œè‡ªå®šä¹‰å·¥ç¨‹æ¨¡æ¿å’Œæ–‡ä»¶æ¨¡æ¿æœ€å¥½çš„åŠæ³•å°±æ˜¯å‚è€ƒç³»ç»Ÿçš„æ¨¡æ¿ã€‚</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/%E5%B7%A5%E7%A8%8B%E6%A8%A1%E6%9D%BF%E5%B1%95%E7%A4%BA%E6%95%88%E6%9E%9C.png" style="zoom:50%;" /></p>
<p>ç³»ç»Ÿçš„å·¥ç¨‹æ¨¡æ¿ä½ç½®:</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">/Applications/</span>Xcode.app<span class="regexp">/Contents/</span>Developer<span class="regexp">/Platforms/i</span>PhoneOS.platform<span class="regexp">/Developer/</span>Library<span class="regexp">/Xcode/</span>Templates<span class="regexp">/Project Templates/i</span>OS</span><br></pre></td></tr></table></figure>
<p>ç³»ç»Ÿçš„æ–‡ä»¶æ¨¡æ¿ä½ç½®:</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"><span class="regexp">/Applications/</span>Xcode.app<span class="regexp">/Contents/</span>Developer<span class="regexp">/Platforms/i</span>PhoneOS.platform<span class="regexp">/Developer/</span>Library<span class="regexp">/Xcode/</span>Templates/<span class="keyword">File</span> Templates</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šæ˜¯ç³»ç»Ÿé»˜è®¤çš„æ¨¡æ¿å­˜å‚¨è·¯å¾„ï¼Œå¯¹äºè‡ªå®šä¹‰çš„æ¨¡æ¿åˆ™éœ€è¦å­˜æ”¾åœ¨å…¶ä»–è·¯å¾„ï¼š</p>
<p>è‡ªå®šä¹‰å·¥ç¨‹æ¨¡æ¿çš„è·¯å¾„éœ€è¦å­˜æ”¾åœ¨:<code>~/Library/Developer/Xcode/Templates/Project Templates/Application/</code>.</p>
<p>è‡ªå®šä¹‰æ–‡ä»¶æ¨¡æ¿çš„è·¯å¾„éœ€è¦å­˜æ”¾åœ¨:<code>~/Library/Developer/Xcode/Templates/File Templates/</code>.</p>
<p>å½“åšå¥½è‡ªå·±çš„æ¨¡æ¿ååªéœ€è¦å­˜æ”¾åœ¨ä¸Šè¿°ä½ç½®ï¼Œé‡å¯Xcodeå°±èƒ½çœ‹åˆ°æˆ‘ä»¬è‡ªå·±çš„å·¥ç¨‹æ¨¡æ¿äº†ã€‚</p>
<p>æ³¨ï¼šå¦‚æœä¸Šè¿°è·¯å¾„ä¸å­˜åœ¨åˆ™éœ€è¦è‡ªå·±åˆ›å»ºå¥½ã€‚</p>
<h4 id="äº†è§£ç³»ç»Ÿçš„å·¥ç¨‹æ¨¡æ¿"><a href="#äº†è§£ç³»ç»Ÿçš„å·¥ç¨‹æ¨¡æ¿" class="headerlink" title="äº†è§£ç³»ç»Ÿçš„å·¥ç¨‹æ¨¡æ¿"></a>äº†è§£ç³»ç»Ÿçš„å·¥ç¨‹æ¨¡æ¿</h4><p>åœ¨åˆ¶ä½œè‡ªå·±çš„å·¥ç¨‹æ¨¡æ¿ä¹‹å‰ï¼Œå…ˆæ¥äº†è§£ä¸€ä¸‹ç³»ç»Ÿçš„å·¥ç¨‹æ¨¡æ¿éƒ½æœ‰äº›å•¥ï¼Œä»¥æœ€ç®€å•çš„Single View Appæ¨¡æ¿ä¸ºä¾‹ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/Single%20View%20App.png" style="zoom:50%;" /></p>
<p>æ¯ä¸ªæ¨¡æ¿æ–‡ä»¶å¤¹ä¸­éƒ½ä¼šåŒ…å«ä¸€ä¸ªæ¨¡æ¿ä¿¡æ¯çš„plistæ–‡ä»¶é‡Œé¢æ˜¯ä¸€äº›å…³äºæ¨¡æ¿çš„é…ç½®ã€‚æˆ‘ä»¬è¦åšçš„ä¹Ÿå°±æ˜¯ä¿®æ”¹TemplateInfo.plistæ–‡ä»¶ã€‚</p>
<p>ç®€å•ä»‹ç»ä¸€ä¸‹TemplateInfo.plistæ–‡ä»¶ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/TemplateInfo_plist.png" alt=""></p>
<p><strong>Kind</strong></p>
<p>åˆ†ä¸ºå·¥ç¨‹æ¨¡æ¿å’Œæ–‡ä»¶æ¨¡æ¿ï¼Œè¿™ä¸ªä¸ç”¨ä¿®æ”¹ä½¿ç”¨é»˜è®¤çš„å°±å¥½ã€‚</p>
<p>å·¥ç¨‹æ¨¡æ¿ï¼š<code>Xcode.Xcode3.ProjectTemplateUnitKind</code></p>
<p>æ–‡ä»¶æ¨¡æ¿ï¼š<code>Xcode.IDEFoundation.TextSubstitutionFileTemplateKind</code></p>
<p><strong>Identifier</strong></p>
<p>æ¨¡æ¿IDï¼Œç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªæ¨¡æ¿ã€‚ç±»ä¼¼äºç±»åã€‚</p>
<p><strong>Ancestors</strong></p>
<p>æ¨¡æ¿ç³»ç»Ÿå…è®¸æ¨¡æ¿ç»§æ‰¿å’Œé‡å†™å…¶ä»–æ¨¡æ¿ï¼ŒAncestorsé‡Œé¢åŒ…å«çš„å°±æ˜¯å½“å‰æ¨¡æ¿ç»§æ‰¿çš„å…¶ä»–æ¨¡æ¿çš„IDï¼ˆå°±æ˜¯ä¸Šé¢é‚£ä¸ªIdentifierï¼‰ã€‚</p>
<p>Single View Appæ¨¡æ¿çš„AncestorsåŒ…å«ä¸¤ä¸ªçˆ¶æ¨¡æ¿ï¼š</p>
<p><code>com.apple.dt.unit.coreDataCocoaTouchApplication</code>ï¼šå¦‚æœä½ åœ¨åˆ›å»ºå·¥ç¨‹æ—¶å‹¾çº¿äº†CoreDataï¼Œè¿™ä¸ªæ¨¡æ¿å°±ä¼šè®©Xcodeåœ¨AppDelegateä¸­æ·»åŠ CoreDataçš„æ ·æ¿æ–‡ä»¶ã€‚</p>
<p><code>com.apple.dt.unit.sceneLifecycleApplication</code>ï¼šè¿™ä¸ªæ˜¯iOS13å‡ºçš„ï¼Œä¼šè®©Xcodeåˆ›å»ºSceneDelegate.h/mã€‚</p>
<p>ä¸Šé¢ä¸¤ä¸ªæ¨¡æ¿åˆéƒ½ç»§æ‰¿è‡ªCocoa Touch Application Baseæ¨¡æ¿ï¼Œ</p>
<p><code>com.apple.dt.unit.cocoaTouchApplicationBase</code>ï¼šè¿™ä¸ªæ¨¡æ¿ä¸»è¦æ˜¯åœ¨AppDelegateä¸­æ·»åŠ ä¸€äº›æ ·æ¿ä»£ç å’ŒInfo.plistçš„ä¸€äº›è®¾ç½®ã€‚</p>
<p>å…è®¸æ¨¡æ¿çš„ç»§æ‰¿å’Œé‡å†™å°±å¯ä»¥è®©å„ä¸ªæ¨¡æ¿åŠŸèƒ½æ¸…æ™°ï¼Œä»£ç å¤ç”¨ï¼Œè¾¾åˆ°ç±»ä¼¼äºç±»çš„ç»§æ‰¿çš„æ•ˆæœã€‚</p>
<p><strong>Concrete</strong></p>
<p>å¿…é¡»è®¾ç½®ä¸ºYESæ‰èƒ½åœ¨Xcodeé¢æ¿ä¸­æ˜¾ç¤ºå‡ºæ¥ã€‚</p>
<p><strong>Description</strong></p>
<p>æ¨¡æ¿çš„æè¿°ã€‚</p>
<p><strong>SortOrder</strong></p>
<p>æ¨¡æ¿åœ¨Xcodeé¢æ¿ä¸­çš„æ˜¾ç¤ºä½ç½®ã€‚å€¼è¶Šå¤§æ˜¾ç¤ºåœ¨è¶Šåé¢ã€‚</p>
<p><strong>Options</strong></p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/option_item.png" style="zoom:50%;" /></p>
<p>è¿™ä¸ªå°±æ˜¯æ¨¡æ¿çš„ä¸»è¦å†…å®¹äº†ï¼Œé‡Œé¢åŒ…æ‹¬è¦åˆ›å»ºçš„ç±»æ–‡ä»¶ï¼Œå­˜æ ¹æ–¹æ³•çš„å®ç°ç­‰ã€‚Nodesé‡Œå®šä¹‰äº†ä¸€äº›keyï¼Œå®ƒçš„å€¼å°±æ˜¯Definitionsé‡Œçš„ä¸œè¥¿ã€‚å‚ç…§ç³»ç»Ÿçš„å†™æ³•æˆ‘ä»¬å°±å¯ä»¥ä¾è‘«èŠ¦ç”»ç“¢åˆ¶ä½œè‡ªå·±çš„æ¨¡æ¿äº†ã€‚</p>
<h4 id="åˆ¶ä½œè‡ªå·±çš„å·¥ç¨‹æ¨¡æ¿"><a href="#åˆ¶ä½œè‡ªå·±çš„å·¥ç¨‹æ¨¡æ¿" class="headerlink" title="åˆ¶ä½œè‡ªå·±çš„å·¥ç¨‹æ¨¡æ¿"></a>åˆ¶ä½œè‡ªå·±çš„å·¥ç¨‹æ¨¡æ¿</h4><p>æ¥ä¸‹æ¥åˆ¶ä½œè‡ªå·±çš„å·¥ç¨‹æ¨¡æ¿ï¼Œä½¿ç”¨è¯¥æ¨¡æ¿åˆ›å»ºçš„Demoå·¥ç¨‹å°†è‡ªåŠ¨åŒ…å«ä¸€ä¸ªtabBaræ§åˆ¶å™¨,åŠä¸‰ä¸ªå­navigationæ§åˆ¶å™¨ã€‚å…¶ä¸­çš„MATHomeViewControllerä¸Šæ·»åŠ äº†ä¸€ä¸ªtableView,MATMessageViewControllerä¸Šæ·»åŠ äº†ä¸€ä¸ªæŒ‰é’®ã€‚æ”¯æŒOCå’ŒSwiftã€‚</p>
<p>é¦–å…ˆæ‹·è´ä¸€ä»½ç³»ç»Ÿçš„Single View Appæ¨¡æ¿ï¼Œæˆ‘ä»¬ä¸»è¦åŸºäºSingle View Appæ¨¡æ¿è¿›è¡Œä¿®æ”¹ã€‚</p>
<p>ä¿®æ”¹æ–‡ä»¶åä¸º<code>Demo App.xctemplate</code>ï¼Œæ–‡ä»¶å¤¹ä¸‹çš„æ¨¡æ¿å›¾æ ‡å¯ä»¥æ¢ä¸€ä¸‹ã€‚æ¥ä¸‹æ¥å°±æ˜¯å¯¹TemplateInfo.plistæ–‡ä»¶çš„ä¿®æ”¹äº†ã€‚</p>
<p><strong>Identifier</strong></p>
<p>éšä¾¿å–ä¸ªåç§°ï¼Œ<code>com.apple.dt.unit.MATDemoApplication</code>ã€‚</p>
<p><strong>Ancestors</strong></p>
<p>ç”±äºä¸æƒ³è¦Storyboardï¼Œæ‰€ä»¥ç”¨<code>com.apple.dt.unit.cocoaTouchApplicationBase</code>æ›¿æ¢æ‰<code>com.apple.dt.unit.sceneLifecycleApplication</code>æ¨¡æ¿ã€‚</p>
<p><strong>SortOrder</strong></p>
<p>å–å€¼100ã€‚è®©å®ƒæ’åœ¨ç³»ç»Ÿçš„åé¢ã€‚</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯å¤§å¤´Optionsã€‚</p>
<p><strong>Options</strong></p>
<blockquote>
<p>æ›´æ”¹AppDelegate</p>
</blockquote>
<p>åœ¨Nodesé‡Œæ·»åŠ ä¸€ä¸ªitem <code>AppDelegate.m:imports:importHeader:MATTabBarController.h</code>ï¼šè¡¨ç¤ºåœ¨AppDelegate.mé‡Œé¢å¯¼å…¥MATTabBarController.hå¤´æ–‡ä»¶ï¼Œè¿™æ ·Xcodeåœ¨åˆ›å»ºå·¥ç¨‹æ—¶å°±ä¼šè‡ªåŠ¨åœ¨AppDelegate.mé‡Œæ·»åŠ <code>#import&quot;MATTabBarController.h&quot;</code>ã€‚</p>
<p>åœ¨Nodesé‡Œæ·»åŠ ä¸€ä¸ªitem <code>AppDelegate.m:implementation:methods:applicationdidFinishLaunchingWithOptions:body</code></p>
<p>å¹¶åœ¨Definitionsé‡Œæ·»åŠ å¯¹åº”çš„å€¼ï¼š</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">self</span>.window <span class="operator">=</span> [[<span class="type">UIWindow</span> alloc] initWithFrame:<span class="type">UIScreen</span>.mainScreen.bounds];</span><br><span class="line"><span class="keyword">self</span>.window.backgroundColor <span class="operator">=</span> [<span class="type">UIColor</span> whiteColor];</span><br><span class="line"><span class="type">MATTabBarController</span> <span class="operator">*</span>tabController <span class="operator">=</span> [[<span class="type">MATTabBarController</span> alloc] <span class="keyword">init</span>];</span><br><span class="line"><span class="keyword">self</span>.window.rootViewController <span class="operator">=</span> tabController;</span><br><span class="line">[<span class="keyword">self</span>.window makeKeyAndVisible];</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·Xcodeå°±ä¼šè‡ªåŠ¨åœ¨AppDelegate.mé‡ŒdidFinishLaunchingWithOptionsæ–¹æ³•é‡Œé¢æ·»åŠ ä¸Šè¿°ä»£ç ã€‚</p>
<p>å¦‚å›¾ï¼š</p>
<p>Nodes:</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/appDelegate_1.png" alt=""></p>
<p>Definitions:</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/appDelegate_2.png" alt=""></p>
<blockquote>
<p>æ·»åŠ å·²æœ‰çš„ç±»æ–‡ä»¶</p>
</blockquote>
<p>MATTabBarController.h/mæ˜¯æˆ‘ä»¬è‡ªå·±æä¾›çš„ç±»æ–‡ä»¶ï¼Œä¸ºäº†è®©Xcodeåœ¨åˆ›å»ºå·¥ç¨‹æ—¶èƒ½å¤Ÿæ‰¾åˆ°è¿™äº›ç±»ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ¨¡æ¿æ–‡ä»¶ä¸­æŒ‡æ˜ã€‚</p>
<p>åœ¨Nodesé‡Œæ·»åŠ ä¸¤ä¸ªitemï¼š<code>MATTabBarController.h</code>å’Œ<code>MATTabBarController.m</code></p>
<p>å¹¶åœ¨Definitionsé‡Œæ·»åŠ å¯¹åº”çš„å€¼ï¼š</p>
<p>key:<code>MATTabBarController.h</code>ï¼Œvalueç±»å‹é€‰æ‹©å­—å…¸ã€‚å­—å…¸ä¸­æ·»åŠ key:<code>Path</code>ï¼Œvalueä¸ºæ–‡ä»¶çš„è·¯å¾„ã€‚</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/%E6%B7%BB%E5%8A%A0%E6%96%87%E4%BB%B6.png" alt=""></p>
<blockquote>
<p>åŠ¨æ€åˆ›å»ºç±»</p>
</blockquote>
<p>è¿™ä¸ªå‚ç…§ç³»ç»Ÿçš„å°±å¯ä»¥äº†ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/%E5%8A%A8%E6%80%81%E5%88%9B%E5%BB%BA%E7%B1%BB.png" alt=""></p>
<p>çº¢è‰²åˆ’çº¿å¤„æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ç±»åå³å¯ã€‚</p>
<blockquote>
<p>æ·»åŠ æ–¹æ³•</p>
</blockquote>
<p>è®©Xcodeåœ¨åˆ›å»ºçš„ç±»ä¸­è‡ªåŠ¨æ·»åŠ ä¸€ä¸ªæ–¹æ³•ã€‚</p>
<p>åœ¨Nodesé‡Œæ·»åŠ ä¸¤ä¸ªitem:</p>
<p><code>MATMessageViewController.m:implementation:methods:btnDidClicked(- (void\)btnDidClicked:(UIButton *\)sender)</code> å’Œ</p>
<p><code>MATMessageViewController.m:implementation:methods:btnDidClicked:body</code></p>
<p>å³æ–¹æ³•å£°æ˜å’Œæ–¹æ³•å®ç°ã€‚</p>
<p>åœ¨Definitionsé‡Œæ·»åŠ <code>MATMessageViewController.m:implementation:methods:btnDidClicked:body</code>çš„å€¼ï¼Œè¿™é‡Œå°±æ˜¯btnDidClickedæ–¹æ³•çš„å®ç°ï¼š</p>
<figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">NSLog(@<span class="string">&quot;btnDidClicked&quot;</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ·»åŠ å±æ€§åŠæ‡’åŠ è½½å®ç°</p>
</blockquote>
<p>è®©Xcodeåœ¨åˆ›å»ºçš„ç±»ä¸­è‡ªåŠ¨æ·»åŠ ä¸€ä¸ªå±æ€§åŠå±æ€§çš„æ‡’åŠ è½½å®ç°ã€‚</p>
<p>åœ¨Nodesé‡Œæ·»åŠ ä¸‰ä¸ªitem</p>
<p><code>MATMessageViewController.m:extension:btn</code></p>
<p><code>MATMessageViewController.m:implementation:methods:btn(- (UIButton *\)btn)</code></p>
<p><code>MATMessageViewController.m:implementation:methods:btn:return</code></p>
<p>åœ¨Definitionsæ·»åŠ å¯¹åº”çš„å€¼ï¼š</p>
<p><code>MATMessageViewController.m:extension:btn</code>çš„å€¼ï¼š</p>
<p><code>@property (strong, nonatomic) UIButton *btn;</code></p>
<p><code>MATMessageViewController.m:implementation:methods:btn:return</code>çš„å€¼ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (_btn == <span class="literal">nil</span>) &#123;</span><br><span class="line">    <span class="built_in">UIButton</span> *btn = [<span class="built_in">UIButton</span> buttonWithType:<span class="built_in">UIButtonTypeCustom</span>];</span><br><span class="line">    btn.frame = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">44</span>);</span><br><span class="line">    btn.backgroundColor = [<span class="built_in">UIColor</span> redColor];</span><br><span class="line">    [btn setTitle:<span class="string">@&quot;button&quot;</span> forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">    [btn addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(btnDidClicked:) forControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>];</span><br><span class="line">    _btn = btn;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> _btn;</span><br></pre></td></tr></table></figure>
<p>åˆ°æ­¤ä¸ºæ­¢å·¥ç¨‹æ¨¡æ¿å°±å·®ä¸å¤šäº†ï¼Œå°†å…¶æ‹·è´åˆ°<code>~/Library/Developer/Xcode/Templates/Project Templates/Application/</code>ç›®å½•ä¸‹ï¼Œé‡å¯Xcodeå°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è‡ªå·±çš„æ¨¡æ¿äº†ã€‚</p>
<h4 id="åˆ¶ä½œè‡ªå·±çš„æ–‡ä»¶æ¨¡æ¿"><a href="#åˆ¶ä½œè‡ªå·±çš„æ–‡ä»¶æ¨¡æ¿" class="headerlink" title="åˆ¶ä½œè‡ªå·±çš„æ–‡ä»¶æ¨¡æ¿"></a>åˆ¶ä½œè‡ªå·±çš„æ–‡ä»¶æ¨¡æ¿</h4><p>åˆ¶ä½œæ–‡ä»¶æ¨¡æ¿æœ€å¥½ä¹Ÿæ˜¯å‚ç…§ç³»ç»Ÿçš„æ–‡ä»¶æ¨¡æ¿ã€‚</p>
<p>æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹å‘½åä¸º<code>ZACustom</code>,ç„¶åä»ç›®å½•ï¼š</p>
<p><code>/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/Library/Xcode/Templates/File Templates/Source</code></p>
<p>æ‹·è´ä¸€ä»½<code>Cocoa Touch Class.xctemplate</code>ï¼Œåˆ°è¯¥ç›®å½•ä¸‹ã€‚</p>
<p>ä¸€èˆ¬æ–°å»ºUIViewControllerå’ŒNSObjectè¾ƒå¤šï¼Œæ‰€ä»¥å¯ä»¥åªä¿ç•™è¿™ä¸¤ä¸ªç±»ï¼Œå…¶ä»–çš„ç±»æ–‡ä»¶å¤¹å¯ä»¥åˆ æ‰ã€‚</p>
<p>æ–‡ä»¶æ¨¡æ¿çš„TemplateInfo.plistæ–‡ä»¶åŸºæœ¬ä¸éœ€è¦ä¿®æ”¹ï¼Œåªéœ€è¦ä¿®æ”¹å„ç±»æ–‡ä»¶å¤¹ä¸‹çš„<code>___FILEBASENAME___.m</code>æ–‡ä»¶ã€‚</p>
<p>ä¿®æ”¹<code>UIViewControllerObjective-C</code>æ–‡ä»¶å¤¹ä¸‹çš„<code>___FILEBASENAME___.m</code>ï¼Œæ–°å¢ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">//___FILEHEADER___</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="string">&quot;___FILEBASENAME___.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">___FILEBASENAMEASIDENTIFIER___</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">___FILEBASENAMEASIDENTIFIER___</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// MARK:  life cycle</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="variable language_">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)viewWillAppear:(<span class="type">BOOL</span>)animated &#123;</span><br><span class="line">    [<span class="variable language_">super</span> viewWillAppear:animated];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)viewDidAppear:(<span class="type">BOOL</span>)animated &#123;</span><br><span class="line">    [<span class="variable language_">super</span> viewDidAppear:animated];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)viewWillDisappear:(<span class="type">BOOL</span>)animated &#123;</span><br><span class="line">    [<span class="variable language_">super</span> viewWillDisappear:animated];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)viewDidDisappear:(<span class="type">BOOL</span>)animated &#123;</span><br><span class="line">    [<span class="variable language_">super</span> viewDidDisappear:animated];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// MARK: system protocol</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// MARK: custom protocol</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// MARK: notification</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// MARK: event response</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// MARK: public method</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// MARK: private method</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// MARK: setter &amp; getter</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>è¿™æ ·åˆ›å»ºçš„UIViewControllerå­ç±»å°±è‡ªå¸¦è¿™äº›æ³¨é‡Šå’Œå®ç°çš„æ–¹æ³•ã€‚</p>
<p>å¯ä»¥ä¿®æ”¹<code>NSObjectObjective-C</code>æ–‡ä»¶å¤¹ä¸‹çš„<code>___FILEBASENAME___.h</code>ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">//___FILEHEADER___</span></span><br><span class="line"></span><br><span class="line">___IMPORTHEADER_cocoaTouchSubclass___</span><br><span class="line"></span><br><span class="line"><span class="built_in">NS_ASSUME_NONNULL_BEGIN</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">___FILEBASENAMEASIDENTIFIER___</span> : <span class="title">___VARIABLE_cocoaTouchSubclass___</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *&lt;#property1#&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *&lt;#property2#&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *&lt;#property3#&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *&lt;#property4#&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *&lt;#property5#&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> &lt;#property6#&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="type">float</span> &lt;#property7#&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NS_ASSUME_NONNULL_END</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>è¿™æ ·åˆ›å»ºçš„æ¨¡å‹ï¼Œè‡ªåŠ¨å°±æœ‰7ä¸ªå ä½å±æ€§äº†ã€‚</p>
<p>æœ€åå°†æ–‡ä»¶å¤¹<code>ZACustom</code>æ‹·è´åˆ°<code>~/Library/Developer/Xcode/Templates/File Templates/</code>ç›®å½•ä¸‹ï¼Œé‡å¯Xcodeå°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„æ–‡ä»¶æ¨¡æ¿äº†ã€‚</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/%E6%96%87%E4%BB%B6%E6%A8%A1%E6%9D%BF%E5%B1%95%E7%A4%BA%E6%95%88%E6%9E%9C.png" style="zoom:50%;" /></p>
<p>æœ‰éœ€è¦çš„æœ‹å‹å¯ä»¥ç‚¹å‡»ä¸‹æ–¹é“¾æ¥ä¸‹è½½ä½¿ç”¨ï¼š</p>
<p><a href="https://github.com/xq-120/FireDemoAppTemplate">FireDemoAppTemplate</a></p>
]]></content>
      <categories>
        <category>Xcode</category>
      </categories>
      <tags>
        <tag>Xcodeæ¨¡æ¿</tag>
      </tags>
  </entry>
  <entry>
    <title>Swiftæ•°ç»„æˆªå–</title>
    <url>/2020/05/03/Swift%E6%95%B0%E7%BB%84%E6%88%AA%E5%8F%96/</url>
    <content><![CDATA[<p>æ•°ç»„æˆªå–çš„ä¸€äº›æ–¹æ³•ï¼š</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> arr <span class="operator">=</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line"><span class="comment">//startIndex:0, endIndex:5</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;startIndex:<span class="subst">\(arr.startIndex)</span>, endIndex:<span class="subst">\(arr.endIndex)</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> slice1 <span class="operator">=</span> arr.dropFirst(<span class="number">2</span>)</span><br><span class="line"><span class="comment">//startIndex:2, endIndex:5</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;startIndex:<span class="subst">\(slice1.startIndex)</span>, endIndex:<span class="subst">\(slice1.endIndex)</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> slice2 <span class="operator">=</span> arr.dropFirst().dropLast()</span><br><span class="line"><span class="comment">//startIndex:1, endIndex:4</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;startIndex:<span class="subst">\(slice2.startIndex)</span>, endIndex:<span class="subst">\(slice2.endIndex)</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rs <span class="operator">=</span> arr.dropFirst().prefix(upTo: <span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(rs) <span class="comment">//[2, 3]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rs1 <span class="operator">=</span> arr.dropFirst().prefix(<span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(rs1) <span class="comment">//[2, 3, 4]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> fib <span class="operator">=</span> [<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">13</span>, <span class="number">21</span>]</span><br><span class="line"><span class="keyword">let</span> slfib <span class="operator">=</span> fib[<span class="number">1</span><span class="operator">...</span><span class="number">5</span>]</span><br><span class="line"><span class="comment">//startIndex:1, endIndex:6</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;startIndex:<span class="subst">\(slfib.startIndex)</span>, endIndex:<span class="subst">\(slfib.endIndex)</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(slfib) <span class="comment">//[1, 2, 3, 5, 8]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> prefix(upTo end: Int)</span></span><br><span class="line"><span class="comment"> è¡¨ç¤ºä»é›†åˆçš„ç´¢å¼•startIndexå¼€å§‹æˆªå–åˆ°ç´¢å¼•nä¹‹é—´çš„å…ƒç´ ï¼Œä¸åŒ…å«ç´¢å¼•nå…ƒç´ ã€‚nå–å€¼èŒƒå›´ï¼š[startIndex, endIndex]ï¼Œä¼ startIndexåˆ™è¿”å›ç©ºæ•°ç»„ï¼Œä¼ endIndexåˆ™è¿”å›æ•´ä¸ªæ•°ç»„ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">let</span> prefixArr0 <span class="operator">=</span> arr.prefix(upTo: arr.startIndex)</span><br><span class="line"><span class="built_in">print</span>(prefixArr0) <span class="comment">//[]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> prefixArr <span class="operator">=</span> arr.prefix(upTo: <span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(prefixArr) <span class="comment">//[1, 2, 3]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> prefixArr1 <span class="operator">=</span> arr.prefix(upTo: arr.endIndex)</span><br><span class="line"><span class="built_in">print</span>(prefixArr1) <span class="comment">//[1, 2, 3, 4, 5]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> prefixArr2 <span class="operator">=</span> slfib.prefix(upTo: <span class="number">3</span>) <span class="comment">//æ ¹æ®ä¸Šé¢è¯´æ˜è¿™é‡Œåªèƒ½å–[1, 6],å–0ä¼šå´©æºƒ</span></span><br><span class="line"><span class="built_in">print</span>(prefixArr2) <span class="comment">//[1, 2]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//prefix(_ maxLength: Int)ï¼Œè¡¨ç¤ºæˆªå–é›†åˆå‰nä¸ªå…ƒç´ ï¼Œnå–å€¼èŒƒå›´ï¼šn&gt;=0ï¼Œå½“n = 0æ—¶ï¼Œè¿”å›ç©ºæ•°ç»„ï¼›å½“n&gt;æ•°ç»„ä¸ªæ•°æ—¶ï¼Œåˆ™è¿”å›å…¨éƒ¨ã€‚</span></span><br><span class="line"><span class="keyword">let</span> preArr2 <span class="operator">=</span> arr.prefix(<span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(preArr2) <span class="comment">//[1, 2]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> prefix(through position: Int)</span></span><br><span class="line"><span class="comment"> è¡¨ç¤ºä»é›†åˆçš„ç´¢å¼•startIndexå¼€å§‹æˆªå–åˆ°ç´¢å¼•nä¹‹é—´çš„å…ƒç´ ï¼ŒåŒ…å«ç´¢å¼•nå…ƒç´ ã€‚nå–å€¼èŒƒå›´ï¼š[startIndex, endIndex)ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">let</span> preArr3 <span class="operator">=</span> arr.prefix(through: <span class="number">4</span>)</span><br><span class="line"><span class="built_in">print</span>(preArr3) <span class="comment">//[1, 2, 3, 4, 5]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//suffix(from start: Int)ï¼šä»é›†åˆçš„ç´¢å¼•nå…ƒç´ å¼€å§‹æˆªå–åˆ°æœ«å°¾ï¼ŒåŒ…å«ç´¢å¼•nå…ƒç´ ï¼Œnå–å€¼èŒƒå›´ï¼š[startIndex, endIndex]ï¼Œå½“nä¸ºendIndexæ—¶ï¼Œç»“æœä¸ºç©ºæ•°ç»„ã€‚</span></span><br><span class="line"><span class="keyword">let</span> suffixArr0 <span class="operator">=</span> arr.suffix(from: arr.startIndex)</span><br><span class="line"><span class="built_in">print</span>(suffixArr0) <span class="comment">//[1, 2, 3, 4, 5]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> suffixArr00 <span class="operator">=</span> arr.suffix(from: arr.endIndex)</span><br><span class="line"><span class="built_in">print</span>(suffixArr00) <span class="comment">//[]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> suffixArr <span class="operator">=</span> arr.suffix(from: <span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(suffixArr) <span class="comment">//[4, 5]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> suffixArr2 <span class="operator">=</span> slfib.suffix(from: <span class="number">3</span>) <span class="comment">//è¿™é‡Œå‚æ•°ä¹Ÿä¸èƒ½å–0ï¼Œå› ä¸ºstartIndex==1ã€‚</span></span><br><span class="line"><span class="built_in">print</span>(suffixArr2) <span class="comment">//[3, 5, 8]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//suffix(_ maxLength: Int)ï¼šæˆªå–é›†åˆçš„æœ€ånä¸ªå…ƒç´ ï¼Œnå–å€¼èŒƒå›´ï¼šn&gt;=0ï¼Œå½“n = 0æ—¶ï¼Œè¿”å›ç©ºæ•°ç»„ï¼›å½“n&gt;æ•°ç»„å…ƒç´ ä¸ªæ•°æ—¶ï¼Œåˆ™è¿”å›å…¨éƒ¨ã€‚</span></span><br><span class="line"><span class="keyword">let</span> suffixArr1 <span class="operator">=</span> arr.suffix(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(suffixArr1) <span class="comment">//[]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨rangeæ—¶ï¼Œå‚æ•°å–å€¼èŒƒå›´ä¸º[0, æ•°ç»„ä¸ªæ•°]ï¼Œä¸”start&lt;=endã€‚å½“start æˆ– end ç­‰äºcountæ—¶ï¼Œå³è¾¹åªèƒ½ç”¨&quot;&lt;&quot;æˆ–çœç•¥endäº†ã€‚ä¸èƒ½ç­‰äºï¼Œå¦åˆ™è¶Šç•Œäº†ã€‚</span></span><br><span class="line"><span class="keyword">let</span> rangeArr <span class="operator">=</span> arr[<span class="number">3</span><span class="operator">...</span><span class="number">3</span>]</span><br><span class="line"><span class="built_in">print</span>(rangeArr) <span class="comment">//[4]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rangeArr1 <span class="operator">=</span> arr[<span class="number">2</span><span class="operator">..&lt;</span><span class="number">4</span>]</span><br><span class="line"><span class="built_in">print</span>(rangeArr1) <span class="comment">//[3, 4]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rangeArr2 <span class="operator">=</span> arr[<span class="number">2</span><span class="operator">...</span>]</span><br><span class="line"><span class="built_in">print</span>(rangeArr2) <span class="comment">//[3, 4, 5]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rangeArr3 <span class="operator">=</span> arr[<span class="operator">..&lt;</span><span class="number">3</span>]</span><br><span class="line"><span class="built_in">print</span>(rangeArr3) <span class="comment">//[1, 2, 3]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rangeArr4 <span class="operator">=</span> arr[<span class="number">5</span><span class="operator">..&lt;</span><span class="number">5</span>]</span><br><span class="line"><span class="built_in">print</span>(rangeArr4) <span class="comment">//[]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rangeArr5 <span class="operator">=</span> arr[<span class="number">5</span><span class="operator">...</span>]</span><br><span class="line"><span class="built_in">print</span>(rangeArr5) <span class="comment">//[]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»å¤´éƒ¨å¼€å§‹åˆ é™¤nä¸ªå…ƒç´ ï¼Œå½“n&gt;æ•°ç»„å…ƒç´ ä¸ªæ•°æ—¶è¡¨ç¤ºåˆ é™¤å…¨éƒ¨ï¼Œç»“æœè¿”å›ç©ºæ•°ç»„ã€‚</span></span><br><span class="line"><span class="keyword">let</span> dropFirstArr <span class="operator">=</span> arr.dropFirst(<span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(dropFirstArr) <span class="comment">//[4, 5]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»å°¾éƒ¨å¼€å§‹åˆ é™¤nä¸ªå…ƒç´ ï¼Œå½“n&gt;æ•°ç»„å…ƒç´ ä¸ªæ•°æ—¶è¡¨ç¤ºåˆ é™¤å…¨éƒ¨ï¼Œç»“æœè¿”å›ç©ºæ•°ç»„ã€‚</span></span><br><span class="line"><span class="keyword">let</span> dropLastArr <span class="operator">=</span> arr.dropLast(<span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(dropLastArr) <span class="comment">//[1, 2]</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°æ“ä½œä¹‹åå¾—åˆ°çš„éƒ½æ˜¯æ•°ç»„åˆ‡ç‰‡ç±»å‹ï¼Œè€Œä¸æ˜¯æ•°ç»„ç±»å‹ã€‚è¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹<code>ArraySlice</code> ç±»å‹ï¼Œå› ä¸ºä¸Šé¢æœ‰äº›æ–¹æ³•æ˜¯è·Ÿç´¢å¼•ç›¸å…³çš„ï¼Œæ¯”å¦‚æ–¹æ³•<code>prefix(upTo end: Int)</code>ï¼Œè€Œ<code>ArraySlice</code> ç±»å‹çš„startIndexå¹¶ä¸æ€»æ˜¯ä»0å¼€å§‹ï¼Œæ‰€ä»¥å¾—åˆ°çš„ç»“æœå¯èƒ½å‡ºä¹ä½ çš„é¢„æ–™ã€‚</p>
<p><code>ArraySlice</code> ç±»å‹å®˜æ–¹æ–‡æ¡£ï¼š</p>
<p>The <code>ArraySlice</code> type makes it fast and efficient for you to perform operations on sections of a larger array. Instead of copying over the elements of a slice to new storage, an <code>ArraySlice</code>instance presents a view onto the storage of a larger array. And because <code>ArraySlice</code> presents the same interface as <code>Array</code>, you can generally perform the same operations on a slice as you could on the original array.</p>
<p>Unlike <code>Array</code> and <code>ContiguousArray</code>, the starting index for an <code>ArraySlice</code> instance isnâ€™t always zero. Slices maintain the same indices of the larger array for the same elements, so the starting index of a slice depends on how it was created, letting you perform index-based operations on either a full array or a slice.</p>
<p><code>ArraySlice</code>æ˜¯<code>Array</code>, <code>ContiguousArray</code>, or <code>ArraySlice</code> å®ä¾‹çš„ä¸€ä¸ªåˆ‡ç‰‡ã€‚ä½†æ˜¯å®ƒå¹¶ä¸ä¼šå°†åˆ‡ç‰‡ä¸­çš„å…ƒç´ æ‹·è´åˆ°ä¸€ä¸ªæ–°çš„å­˜å‚¨ç©ºé—´ï¼Œè€Œæ˜¯ä¾ç„¶æŒ‡å‘åŸå§‹æ•°ç»„ã€‚</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/ArraySlice1.jpg" style="zoom:50%;" /></p>
<p>æ³¨æ„ï¼šendIndexå§‹ç»ˆæŒ‡å‘é›†åˆæœ€åä¸€ä¸ªå…ƒç´ çš„åä¸€ä¸ªä½ç½®ã€‚ç³»ç»Ÿçš„å¾ˆå¤šæ–¹æ³•æ¶‰åŠåˆ°ç´¢å¼•æ—¶éƒ½ä¼šè·ŸstartIndexå’ŒendIndexç›¸å…³ã€‚è€Œä¸æ˜¯0å’Œæ•°ç»„ä¸ªæ•°ã€‚</p>
<p><strong><code>ArraySlice</code>çš„startIndexå¹¶ä¸æ€»æ˜¯ä»0å¼€å§‹</strong>ï¼Œè€Œæ˜¯å–å†³äºå®ƒçš„åˆ›å»ºæ–¹å¼ã€‚ä¸‹é¢çš„ä¾‹å­ä¸­å¯ä»¥çœ‹åˆ°slice1çš„startIndexæ˜¯2è€Œä¸æ˜¯0ã€‚</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> arr <span class="operator">=</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line"><span class="comment">//startIndex:0, endIndex:5</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;startIndex:<span class="subst">\(arr.startIndex)</span>, endIndex:<span class="subst">\(arr.endIndex)</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> slice1 <span class="operator">=</span> arr.dropFirst(<span class="number">2</span>)</span><br><span class="line"><span class="comment">//startIndex:2, endIndex:5</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;startIndex:<span class="subst">\(slice1.startIndex)</span>, endIndex:<span class="subst">\(slice1.endIndex)</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> slice2 <span class="operator">=</span> arr.dropFirst().dropLast()</span><br><span class="line"><span class="comment">//startIndex:1, endIndex:4</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;startIndex:<span class="subst">\(slice2.startIndex)</span>, endIndex:<span class="subst">\(slice2.endIndex)</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rs <span class="operator">=</span> arr.dropFirst().prefix(upTo: <span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(rs) <span class="comment">//[2, 3]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rs1 <span class="operator">=</span> arr.dropFirst().prefix(<span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(rs1) <span class="comment">//[2, 3, 4]</span></span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥è§£é‡Šä¸€ä¸‹<code>arr.dropFirst().prefix(upTo: 3)</code>çš„ç»“æœä¸ºä»€ä¹ˆæ˜¯[2, 3]ï¼Œè€Œä¸æ˜¯[2, 3, 4]ã€‚</p>
<p>é¦–å…ˆ<code>arr.dropFirst()</code>å°†å¾—åˆ°ä¸€ä¸ªåˆ‡ç‰‡[2, 3, 4, 5]ï¼Œå®ƒçš„startIndexä¸º1ï¼ŒendIndexä¸º5ã€‚<code>prefix(upTo: 3)</code>è¡¨ç¤ºä»startIndexå¼€å§‹å–åˆ°ç´¢å¼•ä¸º3çš„å…ƒç´ ï¼ˆä¸åŒ…æ‹¬ï¼‰ï¼Œè€Œåˆ‡ç‰‡çš„startIndexä¸º1ï¼Œæ‰€ä»¥è¿™é‡Œåªä¼šå–ç´¢å¼•ä¸º1ï¼Œ2çš„å…ƒç´ ï¼Œæ‰€ä»¥ç»“æœä¸º[2, 3]ã€‚è€Œ<code>prefix(3)</code>è¡¨ç¤ºå–å‰3ä¸ªï¼Œæ‰€ä»¥ç»“æœä¸º[2, 3, 4]ã€‚</p>
<p>å‚è€ƒ</p>
<p><a href="https://developer.apple.com/documentation/swift/arrayslice">ArraySlice</a></p>
<p><a href="https://juejin.im/post/5b20197cf265da6e083bf070">WWDC 2018ï¼šåœ¨Swiftä¸­å¦‚ä½•é«˜æ•ˆåœ°ä½¿ç”¨é›†åˆ</a></p>
]]></content>
      <categories>
        <category>Swift</category>
      </categories>
      <tags>
        <tag>æ•°ç»„æ“ä½œ</tag>
        <tag>æ•°ç»„æˆªå–</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¹°åŸºå®è·µæ€»ç»“</title>
    <url>/2020/05/01/%E4%B9%B0%E5%9F%BA%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<p>ä¹‹å‰ä¹°äº†ä¸ªåŸºé‡‘ï¼šå¤©æ·»é‡‘ç¨³å¥å‹ï¼Œåˆšå¼€å§‹è§‰å¾—è¿˜æŒºä¸é”™çš„ã€‚ä½†å‡ å¤©è¿‡åæ‰å‘ç°å¹¶ä¸æ˜¯é‚£ä¹ˆåˆ’ç®—ï¼Œä»Šå¤©å°±æ¥åˆ†æä¸€ä¸‹ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/IMG_2655.jpg" style="zoom:50%;" /></p>
<p>æˆç«‹ä»¥æ¥å¹´åŒ–4.53%ï¼Œè´­ä¹°è´¹ç‡0ï¼Œèµå›è´¹ç‡:æŒæœ‰<360æ—¥åˆ™0.1%ï¼Œ>=360æ—¥åˆ™0.05%ã€‚å³ä½¿å‡å»0.1%çš„èµå›è´¹ç‡ï¼Œä¹Ÿæœ‰4.43%ï¼Œçœ‹èµ·æ¥æŒºä¸é”™çš„ã€‚</p>
<p>å®é™…ä¸Š4.53%æ˜¯æˆç«‹ä»¥æ¥å¹´åŒ–ï¼Œå®ƒçš„è¿‘ä¸‰å¹´çš„ç´¯è®¡æ”¶ç›Šç‡ä¸º13.38%ï¼Œå¹³å‡æ¯å¹´ä¸º4.46%å°äºæˆç«‹ä»¥æ¥çš„4.53%ï¼Œè¯´æ˜è¯¥åŸºé‡‘æ²¡ä»¥å‰é‚£ä¹ˆå¥½äº†ï¼Œèµ°åŠ¿æœ‰ä¸‹é™çš„è¶‹åŠ¿ã€‚å†çœ‹ä¸€ä¸‹è¿‘1å¹´ç´¯è®¡æ”¶ç›Šç‡åªæœ‰3.8%ï¼Œå‡å»æ‰‹ç»­è´¹0.05%ï¼Œå°±åªæœ‰3.75%äº†ã€‚ä¹Ÿå°±æ˜¯ä½ æ”¾ä¸€å¹´åªæœ‰3.75%çš„æ”¶ç›Šç‡ï¼Œè¿™ä¸ªæ”¶ç›Šç‡å…¶å®è¿˜ç¨ç¨ä½äºå…¶ä»–çš„å®šæœŸåŸºé‡‘ã€‚è™½ç„¶å†™ç€éšæ—¶ç”³èµä½†æ˜¯å¦‚æœæ²¡æ»¡ä¸€å¹´çš„è¯æ˜¯å¾ˆäºçš„ã€‚</p>
<p>æ¯”å¦‚åªæŒæœ‰1ä¸ªæœˆé‚£ä¹ˆä½ çš„æœˆæ”¶ç›Šç‡ä¸º3.8% / 12 = 0.3167%ï¼Œå†æ‰£é™¤0.1%çš„èµå›è´¹ç‡é‚£ä¹ˆå°±åªæœ‰0.2167%ã€‚å¹´åŒ–ä¸€ä¸‹å°±æ˜¯2.6%ï¼Œå·²ç»éå¸¸ä½äº†ã€‚å¦‚æœä½ åªæŒæœ‰10å¤©ï¼Œé‚£ä¹ˆæ”¶ç›Šåˆšå¥½æŠµæ¶ˆæ‰‹ç»­è´¹ï¼Œä½ è¢«ç™½å«–ã€‚å¦‚æœå°äº10å¤©é‚£å°±æ˜¯åœ¨äºé’±äº†ã€‚</p>
<p>æ‰€ä»¥è¿™é‡Œçš„éšæ—¶ç”³èµå…¶å®å°±æ˜¯ä¸€ä¸ªè¯±é¥µï¼Œå¦‚æœä¸åŠ åˆ†æå¾ˆå®¹æ˜“ä¸Šé’©ã€‚å½“ç„¶ä¹Ÿä¸æ˜¯è¯´è¯¥åŸºé‡‘åœ¨éª—äººï¼Œè€Œæ˜¯ä¸åˆ’ç®—ã€‚æƒ³è¦è¾¾åˆ°å®ƒè¯´çš„4.53%ï¼Œä»¥R2è¾ƒä½é£é™©æ¥çœ‹ï¼ŒåŸºæœ¬ä¸Šè¦é•¿æœŸæŒæœ‰3å¹´å·¦å³ã€‚è¯´æ˜¯éšæ—¶ç”³èµå®é™…ä¸Šæ˜¯ä¸èƒ½â€œéšæ—¶ç”³èµâ€çš„ã€‚</p>
<p>ä¸Šè¿°çš„åˆ†æå‘Šè¯‰äº†æˆ‘ä»¬ï¼š</p>
<p>1.ä¹°åŸºé‡‘ä¸èƒ½åªçœ‹æˆç«‹ä»¥æ¥çš„å¹´åŒ–ï¼Œè¦çœ‹èµ°åŠ¿å›¾é‡Œçš„1æœˆï¼Œ3æœˆï¼Œ1å¹´ï¼Œ3å¹´ã€‚</p>
<p>2.æœ‰æ‰‹ç»­è´¹çš„åŸºé‡‘å¦‚æœæ”¶ç›Šç‡ä¸é«˜çš„è¯å°±ä¸è¦ä¹°äº†ã€‚å°±åƒä¸Šé¢çš„åŸºé‡‘æ»¡ä¸€å¹´æ‰£é™¤æ‰‹ç»­è´¹åè¿˜ä¸å¦‚å®šæœŸçš„åŸºé‡‘äº†ã€‚</p>
<p>ä¸ªäººå°†å¹´åŒ–3.65%ä½œä¸ºä¸€ä¸ªå‚è€ƒå€¼ï¼Œä¹Ÿå°±æ˜¯1ä¸‡å…ƒ1å¤©æ”¶ç›Š1å…ƒã€‚</p>
<p>åˆ™æœˆæ”¶ç›Šç‡ä¸ºï¼š3.65% / 12 = 0.3% </p>
<p>æ—¥æ”¶ç›Šç‡ä¸ºï¼š3.65% / 365 = 0.01%ï¼Œæ—¥æ”¶ç›Šç‡å¹³å‡éœ€è¦0.01%ï¼Œå¹´åŒ–æ‰æœ‰3.65%ã€‚</p>
]]></content>
      <categories>
        <category>ç»æµå­¦</category>
      </categories>
      <tags>
        <tag>ä¹°åŸºæ€»ç»“</tag>
      </tags>
  </entry>
  <entry>
    <title>åŸºé‡‘å¸¸è§æ¦‚å¿µ</title>
    <url>/2020/05/01/%E5%9F%BA%E9%87%91%E5%B8%B8%E8%A7%81%E6%A6%82%E5%BF%B5/</url>
    <content><![CDATA[<p><strong>åŸºé‡‘çš„ä¸€äº›æ¦‚å¿µ</strong></p>
<p>å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/5C9E117C940FCD96FFFDB344982570E9.png" style="zoom:25%;" /></p>
<p><strong>æ—¥æ¶¨å¹…</strong></p>
<p>ï¼ˆå½“æ—¥å‡€å€¼ - æ˜¨æ—¥å‡€å€¼ï¼‰/ æ˜¨æ—¥å‡€å€¼ x 100%</p>
<p>æ¯”å¦‚è¦è®¡ç®—4.30çš„æ—¥æ¶¨å¹…ï¼Œé‚£ä¹ˆå½“æ—¥å‡€å€¼éœ€è¦å–4.30çš„å‡€å€¼ï¼Œæ˜¨æ—¥å‡€å€¼å–çš„å°±æ˜¯4.29çš„å‡€å€¼ã€‚</p>
<p>eg:</p>
<p>4æœˆ29æ—¥çš„å•ä½å‡€å€¼ä¸º1.8470ï¼Œ4æœˆ30æ—¥çš„å•ä½å‡€å€¼ä¸º1.8450ï¼Œè¿™æ ·4æœˆ30æ—¥çš„æ—¥æ¶¨å¹…å°±æ˜¯ï¼š</p>
<p>ï¼ˆ1.8450 - 1.8470ï¼‰/ 1.8470 x 100% = -0.108284% â‰ˆ -0.11%ï¼Œè´Ÿæ•°è¯´æ˜äºäº†ã€‚</p>
<p><strong>æ˜¨æ—¥æ”¶ç›Š</strong></p>
<p>ç‰¹åˆ«æ³¨æ„ï¼Œä»Šå¤©çœ‹åˆ°çš„æ”¶ç›Šå…¶å®æ˜¯æ˜¨æ—¥çš„æ”¶ç›Šã€‚ä»Šå¤©éƒ½æ²¡ç»“æŸæ‰€ä»¥ä½ æ˜¯æ²¡åŠæ³•çœ‹åˆ°ä»Šå¤©çš„æ”¶ç›Šçš„ã€‚ä»”ç»†å“ä¸€ä¸‹è¿™é‡Œé¢çš„ä»£è¯ã€‚æ¯”å¦‚è¿™é‡Œ5æœˆ1æ—¥çœ‹åˆ°çš„å°±æ˜¯4æœˆ30æ—¥çš„æ”¶ç›Šã€‚</p>
<p>æ˜¨æ—¥æ”¶ç›Š =ï¼ˆå½“æ—¥å‡€å€¼ - æ˜¨æ—¥å‡€å€¼ï¼‰x ä»½é¢ã€‚è¿™é‡Œçš„æ˜¨æ—¥å‡€å€¼ç›¸å¯¹çš„æ˜¯å½“æ—¥å‡€å€¼ï¼Œå¹³æ—¶ç”Ÿæ´»é‡Œæˆ‘ä»¬è¯´æ˜¨æ—¥é»˜è®¤ç›¸å¯¹çš„æ˜¯ä»Šå¤©ã€‚</p>
<p>è¿™æ ·4æœˆ30æ—¥çš„æ”¶ç›Š =ï¼ˆ4.30çš„å‡€å€¼ - 4.29çš„å‡€å€¼ï¼‰x ä»½é¢ =ï¼ˆ1.8450 - 1.8470ï¼‰x 544.67 = -1.089ã€‚</p>
<p>æ ¹æ®æ—¥æ¶¨å¹…å’Œå½“æ—¥å‡€å€¼çš„å…³ç³»ä¹Ÿå¯ä»¥å¾—å‡ºæ˜¨æ—¥æ”¶ç›Šçš„å¦ä¸€ç§è®¡ç®—ï¼š</p>
<p>æ˜¨æ—¥æ”¶ç›Š  = æ˜¨æ—¥å‡€å€¼  x æ—¥æ¶¨å¹… x ä»½é¢ </p>
<p>è¿™æ ·4æœˆ30æ—¥çš„æ”¶ç›Š =  4.29çš„å‡€å€¼ x 4.30çš„æ—¥æ¶¨å¹… x ä»½é¢ = 1.8470  x -0.11% x 544.67 = -1.1066ï¼Œä¸-1.089æœ‰å‡ºå…¥æ˜¯å› ä¸ºæ—¥æ¶¨å¹…çš„ç²¾åº¦é—®é¢˜ã€‚</p>
<p><strong>æŒä»“æˆæœ¬ä»·</strong></p>
<p>å³è´­ä¹°å½“å¤©çš„å•ä½å‡€å€¼ã€‚</p>
<p><strong>ä»½é¢</strong></p>
<p>è´­ä¹°åŸºé‡‘çš„æœ¬é‡‘ / è´­ä¹°å½“å¤©çš„å•ä½å‡€å€¼ã€‚</p>
<p>è¿™é‡Œæ¶‰åŠåˆ°åŸºé‡‘äº¤æ˜“çš„æ—¶é—´ç‚¹ï¼Œæ¯æ—¥çš„15:00å‰ä¹°å…¥/å–å‡ºçš„åˆ™å•ä½å‡€å€¼ä¸ºå½“æ—¥çš„å•ä½å‡€å€¼ã€‚å¦åˆ™ä¸ºä¸‹ä¸€æ—¥çš„å•ä½å‡€å€¼ã€‚æ‰€ä»¥åœ¨ä¹°å…¥å–å‡ºæ—¶è¦æ³¨æ„ä¸€ä¸‹ã€‚</p>
<p><strong>æŒä»“æ”¶ç›Š</strong></p>
<p>ï¼ˆæœ€æ–°å‡€å€¼ - æŒä»“æˆæœ¬ä»·ï¼‰x ä»½é¢</p>
<p><strong>åŸºé‡‘çš„å†å²æ”¶ç›Šç‡</strong></p>
<p>å¦‚å›¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/RPReplay_Final1588308124.gif" alt=""></p>
<p>æœ‰è¿‘1ä¸ªæœˆï¼Œè¿‘3ä¸ªæœˆï¼Œè¿‘1å¹´ï¼Œæˆç«‹ä»¥æ¥ã€‚</p>
<p>è¿™ä¸ªå†å²æ”¶ç›Šç‡ï¼ˆä½™é¢å®ä¸­ç§°ä¸ºä¸šç»©èµ°åŠ¿ï¼Œå…¶å®éƒ½æ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼‰æ˜¯æ¯æ—¥æ”¶ç›Šç‡ç´¯åŠ çš„ç»“æœã€‚</p>
<p>è¿‘1ä¸ªæœˆï¼Œè¿‘3ä¸ªæœˆï¼Œè¿‘1å¹´ï¼Œæˆç«‹ä»¥æ¥è¿™äº›éƒ½æŒ‡çš„æ˜¯ç´¯è®¡å¤šä¹…ï¼Œæ¯”å¦‚è¿‘1ä¸ªæœˆçš„å†å²æ”¶ç›Šç‡ï¼Œè¿™é‡Œå°±æ˜¯3.30-4.30è¿™ä¸€æ®µæ—¶é—´ï¼Œé‚£ä¹ˆå°±ä»¥3.30ä¸ºåŸºå‡†0%å¼€å§‹ç´¯åŠ ã€‚3.30-4.30è¿™ä¸€æ®µæ—¶é—´çš„æ¯æ—¥æ”¶ç›Šç‡ç´¯åŠ ä¹‹åå°±æ˜¯è¿‘1ä¸ªæœˆçš„å†å²æ”¶ç›Šç‡ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæŸå‡ å¤©éƒ½åœ¨äºé’±ï¼Œä½†ä¸šç»©èµ°åŠ¿æ˜¾ç¤ºçš„æœ¬åŸºé‡‘è¿˜æ˜¯+1.07%ã€‚å¦‚æœä½ æŸ¥çœ‹ä¸šç»©èµ°åŠ¿ä¸­çš„æ¯ä¸ªç‚¹ï¼Œå°±ä¼šå‘ç°äºé’±çš„é‚£å¤©çš„å€¼æ˜¯æ¯”å®ƒä¹‹å‰çš„å€¼è¦å°çš„ã€‚</p>
<p>çœ‹é‚£ä¸ªå†å²æ”¶ç›Šç‡ï¼Œè¿™ä¸ªåŸºé‡‘è¦æ˜¯èƒ½é•¿æœŸæŒæœ‰æ”¶ç›Šç‡è¿˜æ˜¯æŒºä¸é”™çš„ï¼Œ14å¹´ç´¯è®¡398.91%çš„æ”¶ç›Šç‡ï¼Œå¹³å‡æ¯å¹´ä¸º28.5%è¿˜æ˜¯æŒºå¯è§‚çš„ã€‚è™½ç„¶è·Ÿè‚¡ç¥¨æ²¡æ³•æ¯”ï¼Œä½†æ˜¯è‚¡ç¥¨çš„é£é™©å°±å¤ªå¤§äº†ã€‚</p>
]]></content>
      <categories>
        <category>ç»æµå­¦</category>
      </categories>
      <tags>
        <tag>åŸºé‡‘æ¦‚å¿µ</tag>
      </tags>
  </entry>
  <entry>
    <title>UITableViewæ€§èƒ½ä¼˜åŒ–æ€»ç»“</title>
    <url>/2020/04/16/UITableView%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<p>è®¡ç®—æœºæœ€å®è´µçš„èµ„æºå°±æ˜¯CPUå’Œå†…å­˜ï¼Œå› æ­¤æ‰€è°“çš„ä¼˜åŒ–å…¶å®å°±æ˜¯åœ¨â€ç©ºé—´â€å’Œâ€æ—¶é—´â€ä¹‹é—´æƒè¡¡ã€‚ä»¥ç©ºé—´æ¢å–æ›´çŸ­çš„æ—¶é—´å“åº”ï¼Œè¡¨ç°åœ¨å¯èƒ½ä¼šå¢åŠ é¢å¤–çš„å†…å­˜å¼€é”€å¦‚ï¼šcellçš„é‡ç”¨ã€é«˜åº¦çš„ç¼“å­˜ç”šè‡³å¸ƒå±€çš„ç¼“å­˜ç­‰ã€‚</p>
<h3 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h3><h4 id="1-cellçš„é‡ç”¨"><a href="#1-cellçš„é‡ç”¨" class="headerlink" title="1.cellçš„é‡ç”¨"></a>1.cellçš„é‡ç”¨</h4><p>æ³¨æ„é‡ç”¨å¯èƒ½å¯¼è‡´çš„æ•°æ®é”™ä¹±é—®é¢˜ã€‚</p>
<p>å‚è€ƒï¼š<a href="https://xq-120.github.io/2016/04/24/UITableViewCell%E9%87%8D%E7%94%A8%E5%AF%BC%E8%87%B4%E7%9A%84%E5%9B%BE%E7%89%87%E9%94%99%E4%B9%B1%E9%97%AE%E9%A2%98/">UITableViewCellé‡ç”¨å¯¼è‡´çš„å›¾ç‰‡é”™ä¹±é—®é¢˜</a></p>
<h4 id="2-æå‰è®¡ç®—å¥½cellçš„é«˜åº¦å¹¶ä¸”ç¼“å­˜èµ·æ¥"><a href="#2-æå‰è®¡ç®—å¥½cellçš„é«˜åº¦å¹¶ä¸”ç¼“å­˜èµ·æ¥" class="headerlink" title="2.æå‰è®¡ç®—å¥½cellçš„é«˜åº¦å¹¶ä¸”ç¼“å­˜èµ·æ¥"></a>2.æå‰è®¡ç®—å¥½cellçš„é«˜åº¦å¹¶ä¸”ç¼“å­˜èµ·æ¥</h4><p>UITableViewä»£ç†æ–¹æ³•çš„æ‰§è¡Œé¡ºåºï¼š<br>ç³»ç»Ÿä¼šå…ˆè°ƒç”¨numberOfRowsInSectionæ¥è·å–cellçš„è¡Œæ•°,ç„¶åå†å¤šæ¬¡(å’ŒnumberOfRowæ­£ç›¸å…³)è°ƒç”¨heightForRowæ¥ç¡®å®šcontentSizeåŠcellçš„ä½ç½®,æœ€åæ‰ä¼šè°ƒç”¨cellForRowæ˜¾ç¤ºå½“å‰å±å¹•çš„cell. </p>
<p>ç”±äºheightForRowä¼šé¢‘ç¹çš„è°ƒç”¨,å› æ­¤è¯¥æ–¹æ³•é‡Œä¸€å®šä¸è¦è¿›è¡Œå¤§é‡é‡å¤çš„è®¡ç®—.æ‰€ä»¥cellçš„é«˜åº¦éœ€è¦è¿›è¡Œç¼“å­˜,ç„¶ååœ¨heightForRowæ–¹æ³•ä¸­ç›´æ¥è¿”å›.å¯é‡‡ç”¨çš„ç­–ç•¥:ç½‘ç»œè¯·æ±‚å®Œæˆåå°±è®¡ç®—å¥½æ¯ä¸ªcellçš„é«˜åº¦,å¹¶ç¼“å­˜åˆ°å¯¹åº”çš„modelä¸­.æ›´æœ‰ç”šè€…ä¼šåœ¨æ­¤æ—¶è¿cellçš„å­è§†å›¾å¸ƒå±€éƒ½è®¡ç®—å¥½.</p>
<p>cellçš„é«˜åº¦è®¡ç®—ä¸ç¼“å­˜æ—¶æ•ˆé—®é¢˜ï¼Ÿ</p>
<h4 id="3-é¿å…é˜»å¡ä¸»çº¿ç¨‹"><a href="#3-é¿å…é˜»å¡ä¸»çº¿ç¨‹" class="headerlink" title="3.é¿å…é˜»å¡ä¸»çº¿ç¨‹"></a>3.é¿å…é˜»å¡ä¸»çº¿ç¨‹</h4><p>æ¯”å¦‚å›¾ç‰‡çš„ä¸‹è½½ï¼Œå›¾ç‰‡çš„å¤„ç†ç­‰å…¶ä»–è€—æ—¶æ“ä½œåº”è¯¥æ”¾åœ¨å­çº¿ç¨‹æ‰§è¡Œï¼Œå¦‚æœå¯ä»¥åº”è¯¥ç¼“å­˜èµ·æ¥ã€‚</p>
<h4 id="4-æŒ‰éœ€åŠ è½½"><a href="#4-æŒ‰éœ€åŠ è½½" class="headerlink" title="4.æŒ‰éœ€åŠ è½½"></a>4.æŒ‰éœ€åŠ è½½</h4><p>æ¯”å¦‚è¿˜åœ¨æ»šåŠ¨æ—¶,ä¸å»åŠ è½½æ˜¾ç¤ºå›¾ç‰‡.å½“æ»šåŠ¨åœæ­¢æ—¶æ‰åŠ è½½æ˜¾ç¤ºå›¾ç‰‡.è¿™ç§æ–¹å¼åœ¨æ»šåŠ¨æ—¶ä¼šçœ‹ä¸åˆ°å›¾ç‰‡,å› æ­¤éœ€è¦ç»“åˆå®é™…éœ€æ±‚ä½¿ç”¨.</p>
<h4 id="5-ä¸è¦åŠ¨æ€çš„addæˆ–removeå­æ§ä»¶"><a href="#5-ä¸è¦åŠ¨æ€çš„addæˆ–removeå­æ§ä»¶" class="headerlink" title="5.ä¸è¦åŠ¨æ€çš„addæˆ–removeå­æ§ä»¶"></a>5.ä¸è¦åŠ¨æ€çš„addæˆ–removeå­æ§ä»¶</h4><p>å­æ§ä»¶æœ€å¥½åœ¨åˆå§‹åŒ–æ—¶å°±æ·»åŠ å®Œæˆ,å¯é‡‡ç”¨hiddenæ¥æ§åˆ¶æ˜¯å¦æ˜¾ç¤ºã€‚å¤æ‚çš„cellå¯ä»¥é‡‡ç”¨<a href="https://github.com/Instagram/IGListKit">IGListKit</a>ï¼Œè€Œä¸æ˜¯å„ç§remakeçº¦æŸã€‚</p>
<h4 id="6-å°½å¯èƒ½é‡ç”¨åˆ›å»ºæ—¶å¼€é”€æ¯”è¾ƒå¤§çš„å¯¹è±¡"><a href="#6-å°½å¯èƒ½é‡ç”¨åˆ›å»ºæ—¶å¼€é”€æ¯”è¾ƒå¤§çš„å¯¹è±¡" class="headerlink" title="6.å°½å¯èƒ½é‡ç”¨åˆ›å»ºæ—¶å¼€é”€æ¯”è¾ƒå¤§çš„å¯¹è±¡"></a>6.å°½å¯èƒ½é‡ç”¨åˆ›å»ºæ—¶å¼€é”€æ¯”è¾ƒå¤§çš„å¯¹è±¡</h4><p>æ¯”å¦‚NSDateFormatterå’ŒNSCalendarç­‰å¯¹è±¡.è¿™äº›å¯¹è±¡åˆå§‹åŒ–éå¸¸çš„æ…¢,æˆ‘ä»¬å¯ä»¥æŠŠå®ƒä»¬åŠ å…¥åˆ°ç±»çš„å±æ€§å½“ä¸­,æˆ–è€…åˆ›å»ºå•ä¾‹æ¥ä½¿ç”¨.</p>
<h4 id="7-æ³¨æ„é¿å…ç¦»å±æ¸²æŸ“"><a href="#7-æ³¨æ„é¿å…ç¦»å±æ¸²æŸ“" class="headerlink" title="7.æ³¨æ„é¿å…ç¦»å±æ¸²æŸ“"></a>7.æ³¨æ„é¿å…ç¦»å±æ¸²æŸ“</h4><p><strong>ä»€ä¹ˆæ˜¯ç¦»å±æ¸²æŸ“</strong></p>
<p>GPUæ¸²æŸ“æœºåˆ¶ï¼š</p>
<p>CPU è®¡ç®—å¥½æ˜¾ç¤ºå†…å®¹æäº¤åˆ° GPUï¼ŒGPU æ¸²æŸ“å®Œæˆåå°†æ¸²æŸ“ç»“æœæ”¾å…¥å¸§ç¼“å†²åŒºï¼Œéšåè§†é¢‘æ§åˆ¶å™¨ä¼šæŒ‰ç…§ VSync ä¿¡å·é€è¡Œè¯»å–å¸§ç¼“å†²åŒºçš„æ•°æ®ä¼ é€’ç»™æ˜¾ç¤ºå™¨æ˜¾ç¤ºã€‚</p>
<p>GPUå±å¹•æ¸²æŸ“æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š</p>
<p>On-Screen Renderingæ„ä¸ºå½“å‰å±å¹•æ¸²æŸ“ï¼ŒæŒ‡çš„æ˜¯GPUçš„æ¸²æŸ“æ“ä½œæ˜¯åœ¨å½“å‰ç”¨äºæ˜¾ç¤ºçš„å±å¹•ç¼“å†²åŒºä¸­è¿›è¡Œã€‚</p>
<p>Off-Screen Renderingæ„ä¸ºç¦»å±æ¸²æŸ“ï¼ŒæŒ‡çš„æ˜¯GPUåœ¨å½“å‰å±å¹•ç¼“å†²åŒºä»¥å¤–æ–°å¼€è¾Ÿä¸€ä¸ªç¼“å†²åŒºè¿›è¡Œæ¸²æŸ“æ“ä½œã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆä¼šå‡ºç°ç¦»å±æ¸²æŸ“</strong></p>
<p>å› ä¸ºæœ‰äº›æ•ˆæœä¸èƒ½ç›´æ¥åœ¨å½“å‰å±å¹•æ¸²æŸ“ï¼Œæ‰€ä»¥éœ€è¦æœ‰ç¦»å±æ¸²æŸ“ã€‚è²Œä¼¼æ˜¯åºŸè¯ã€‚ä¸ºä»€ä¹ˆåœ†è§’ï¼Œé˜´å½±ï¼Œé®ç½©ç­‰æ•ˆæœä¸èƒ½ç›´æ¥åœ¨å½“å‰å±å¹•æ¸²æŸ“ï¼Ÿ</p>
<p><strong>ç¦»å±æ¸²æŸ“ä»£ä»·</strong></p>
<p>ç›¸æ¯”äºå½“å‰å±å¹•æ¸²æŸ“ï¼Œç¦»å±æ¸²æŸ“çš„ä»£ä»·æ˜¯å¾ˆé«˜çš„ï¼Œä¸»è¦ä½“ç°åœ¨ä¸¤ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li>åˆ›å»ºæ–°ç¼“å†²åŒº</li>
</ul>
<p>è¦æƒ³è¿›è¡Œç¦»å±æ¸²æŸ“ï¼Œé¦–å…ˆè¦åˆ›å»ºä¸€ä¸ªæ–°çš„ç¼“å†²åŒºã€‚</p>
<ul>
<li>ä¸Šä¸‹æ–‡åˆ‡æ¢</li>
</ul>
<p>ç¦»å±æ¸²æŸ“çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œéœ€è¦å¤šæ¬¡åˆ‡æ¢ä¸Šä¸‹æ–‡ç¯å¢ƒï¼šå…ˆæ˜¯ä»å½“å‰å±å¹•ï¼ˆOn-Screenï¼‰åˆ‡æ¢åˆ°ç¦»å±ï¼ˆOff-Screenï¼‰ï¼›ç­‰åˆ°ç¦»å±æ¸²æŸ“ç»“æŸä»¥åï¼Œå°†ç¦»å±ç¼“å†²åŒºçš„æ¸²æŸ“ç»“æœæ˜¾ç¤ºåˆ°å±å¹•ä¸Šåˆéœ€è¦å°†ä¸Šä¸‹æ–‡ç¯å¢ƒä»ç¦»å±åˆ‡æ¢åˆ°å½“å‰å±å¹•ã€‚è€Œä¸Šä¸‹æ–‡ç¯å¢ƒçš„åˆ‡æ¢æ˜¯è¦ä»˜å‡ºå¾ˆå¤§ä»£ä»·çš„ã€‚</p>
<p><strong>å¼•èµ·ç¦»å±æ¸²æŸ“çš„å› ç´ </strong></p>
<ol>
<li><p>ä½¿ç”¨äº†Core Graphicsé‡Œçš„æ–¹æ³•.(ä»»ä½•CGå¼€å¤´çš„ç±»)</p>
</li>
<li><p>é‡å†™äº†- drawRectæ–¹æ³•ï¼Œå³ä½¿æ˜¯ç©ºå®ç°ã€‚</p>
</li>
<li><p>è®¾ç½®CALayersçš„ä»¥ä¸‹å±æ€§ï¼š</p>
<p>å…‰æ …åŒ–</p>
<p><code>@property BOOL shouldRasterize;</code> //shouldRasterizeå±æ€§è®¾ç½®ä¸ºYES.</p>
<p>é®ç½©</p>
<p><code>@property(nullable, strong) CALayer *mask;</code> //é®ç½©ç›¸å…³</p>
<p>é˜´å½±(shadow)</p>
<p><code>@property(nullable) CGColorRef shadowColor;</code>ç­‰</p>
<p>æŠ—é”¯é½¿</p>
<p><code>@property CAEdgeAntialiasingMask edgeAntialiasingMask;</code> //è¾¹ç¼˜æŠ—é”¯é½¿é®ç½© </p>
<p>ç»„ä¸é€æ˜ï¼ˆGroup opacityï¼‰<br><code>@property BOOL allowsGroupOpacity;</code></p>
</li>
<li><p>cornerRadiuså’ŒmaskToBounds=YESç»“åˆä½¿ç”¨å®ç°åœ†è§’.<br>æ³¨ï¼šlayer.cornerRadiusï¼Œlayer.borderWidthï¼Œlayer.borderColorå¹¶ä¸ä¼šå‘ç”ŸOffscreen Renderï¼Œå› ä¸ºè¿™äº›ä¸éœ€è¦åŠ å…¥Maskã€‚è®¾ç½®åœ†è§’åªéœ€è¦è®¾ç½®cornerRadiusçš„å€¼,ä½†æ˜¯ç”±äºcornerRadiusåªå¯¹èƒŒæ™¯é¢œè‰²å’Œlayerçš„borderèµ·ä½œç”¨,è€Œä¸ä¼šå¯¹layeré‡Œçš„å†…å®¹èµ·ä½œç”¨,æ‰€ä»¥ä¸€èˆ¬æ‰éœ€è¦å’ŒmasksToBoundsé…åˆä½¿ç”¨.å®ƒä»¬ç‹¬ç«‹ä½œç”¨çš„æ—¶å€™ä¸ä¼šå¼•èµ·ç¦»å±æ¸²æŸ“ã€‚</p>
</li>
</ol>
<p>ä¸ºäº†é¿å…ç¦»å±æ¸²æŸ“ï¼Œå¯¹äºåœ†è§’æ•ˆæœï¼Œæˆ‘ä»¬å¯ä»¥å°†å›¾ç‰‡è£å‰ªä¸ºåœ†å½¢å†æ˜¾ç¤ºã€‚</p>
<p>å‚è€ƒï¼š</p>
<p><a href="https://www.jianshu.com/p/aa8dc1a61c91">ä¸ºä»€ä¹ˆäº§ç”Ÿç¦»å±æ¸²æŸ“</a></p>
<p><a href="https://juejin.im/post/5d732ea96fb9a06b2d77f76a">OpenGL å›¾ç‰‡ä»æ–‡ä»¶æ¸²æŸ“åˆ°å±å¹•çš„è¿‡ç¨‹</a></p>
<p><a href="http://imgtec.eetrend.com/d6-imgtec/blog/2018-08/17019.html">GPUå±å¹•æ¸²æŸ“â€”â€”ç¦»å±æ¸²æŸ“</a></p>
<p><a href="https://xq-120.github.io/2020/04/07/iOS%E8%AE%BE%E7%BD%AE%E5%9C%86%E8%A7%92/">iOSè®¾ç½®åœ†è§’</a></p>
<h4 id="8-æ³¨æ„é¿å…å›¾å±‚æ··åˆ"><a href="#8-æ³¨æ„é¿å…å›¾å±‚æ··åˆ" class="headerlink" title="8.æ³¨æ„é¿å…å›¾å±‚æ··åˆ"></a>8.æ³¨æ„é¿å…å›¾å±‚æ··åˆ</h4><p><strong>ä»€ä¹ˆæ˜¯å›¾å±‚æ··åˆ</strong></p>
<p>å¦‚æœå±å¹•çš„ä¸€å—åŒºåŸŸä¸Šæœ‰å¤šä¸ªå›¾å±‚ï¼ˆlayerï¼‰ï¼Œæ¯ä¸ªå›¾å±‚éƒ½ä¼šæœ‰ä¸€å®šçš„é€æ˜åº¦ï¼Œé‚£ä¹ˆæœ€åè¿™å—åŒºåŸŸçš„æ˜¾ç¤ºæ•ˆæœå°±æ˜¯è¿™äº›å›¾å±‚å…±åŒä½œç”¨çš„ç»“æœï¼Œè¿™ç§ç»“æœéœ€è¦cpuå¯¹æ¯ä¸ªå›¾å±‚çš„é¢œè‰²è¿›è¡Œè®¡ç®—ï¼Œéœ€è¦æ¶ˆè€—æ›´å¤šçš„cpuèµ„æºã€‚å¦‚æœæˆ‘ä»¬æŠŠæœ€ä¸Šå±‚çš„layerè®¾å®šä¸ºä¸é€æ˜ï¼Œé‚£ä¹ˆcpuå°±ä¸éœ€è¦è®¡ç®—åº•å±‚çš„layerçš„è‰²å€¼ï¼Œè¿™æ ·å°±å¯ä»¥èŠ‚çº¦cpuçš„è®¡ç®—é‡ï¼ŒèŠ‚çº¦èµ„æºã€‚</p>
<p><strong>åº”å¯¹æªæ–½</strong></p>
<ol>
<li>ç¡®ä¿æ§ä»¶çš„opaqueå±æ€§è®¾ç½®ä¸ºtrueï¼Œç¡®ä¿backgroundColorä¸é€æ˜.å…³äºbackgroundColorè¯´æ˜:The default value is nil, which results in a transparent background color.  å¸¸è§çš„å°±æ˜¯æŠŠUILabelçš„èƒŒæ™¯è‰²è®¾ç½®ä¸ºç™½è‰²ï¼ˆé¢œè‰²æ ¹æ®åœºæ™¯éœ€è¦ï¼‰ã€‚</li>
<li>å¦‚æ— ç‰¹æ®Šéœ€è¦ï¼Œä¸è¦è®¾ç½®ä½äº1çš„alphaå€¼.  </li>
<li>ç¡®ä¿UIImageæ²¡æœ‰alphaé€šé“.  </li>
</ol>
<p>å‚è€ƒï¼š<a href="https://www.jianshu.com/p/b8ee7a40e219">iosæ€§èƒ½ä¼˜åŒ–â€”labelä¸Šæ±‰å­—å›¾å±‚æ··åˆé—®é¢˜</a></p>
<h4 id="9-å¼‚æ­¥ç»˜åˆ¶"><a href="#9-å¼‚æ­¥ç»˜åˆ¶" class="headerlink" title="9.å¼‚æ­¥ç»˜åˆ¶"></a>9.å¼‚æ­¥ç»˜åˆ¶</h4><p>é€‚åˆçº¯ä»£ç çš„å¼€å‘.ä½¿ç”¨AsyncDisplayKitç­‰å¼‚æ­¥ç»˜åˆ¶æ¡†æ¶ã€‚æé™ä¼˜åŒ–å¯ä»¥å°è¯•ä¸€ä¸‹ã€‚</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://github.com/facebookarchive/AsyncDisplayKit">AsyncDisplayKit</a></p>
<p><a href="https://github.com/ibireme/YYText">YYText</a></p>
<p><a href="https://medium.com/jike-engineering/asyncdisplaykit%E4%BB%8B%E7%BB%8D-%E4%B8%80-6b871d29e005">AsyncDisplayKitä»‹ç»ï¼ˆä¸€ï¼‰åŸç†å’Œæ€è·¯</a></p>
]]></content>
      <categories>
        <category>UIKit</category>
      </categories>
      <tags>
        <tag>UITableView</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆ¶ä½œCocoaPodså…¬å¼€åº“</title>
    <url>/2020/04/16/%E5%88%B6%E4%BD%9CCocoaPods%E5%85%AC%E5%BC%80%E5%BA%93/</url>
    <content><![CDATA[<p><strong>1. åˆ›å»ºè¦å…¬å¼€çš„podåº“</strong></p>
<p>ä¸»è¦åŒ…å«podæºç å’Œpod sepcæ–‡ä»¶ã€è®¸å¯è¯ç­‰ã€‚</p>
<p>è¿™ä¸ªè¿‡ç¨‹å¯ä»¥å…ˆåœ¨æœ¬åœ°åˆ›å»ºå¥½ï¼Œå†åˆ°GitHubåˆ›å»ºå¯¹åº”çš„ä»“åº“ï¼Œç„¶åå°†æœ¬åœ°podæ·»åŠ åˆ°è¿œç¨‹ä»“åº“ã€‚</p>
<p>ä¹Ÿå¯ä»¥å…ˆåœ¨GitHubåˆ›å»ºå¥½ä»“åº“ï¼Œå†cloneåˆ°æœ¬åœ°ï¼Œç„¶ååœ¨cloneçš„ç›®å½•ä¸‹åˆ›å»ºpodã€‚</p>
<p>pod sepcæ–‡ä»¶çš„è¯´æ˜å¯ä»¥å‚è€ƒï¼š</p>
<p><a href="https://www.jianshu.com/p/75e19c92df50">CocoaPods ç³»åˆ—ä¹‹ä¸‰ Podspec è¯­æ³•è¯´æ˜</a></p>
<p><a href="https://cocoapods.org/">cocoapodså®˜ç½‘æ–‡æ¡£</a> </p>
<p><a href="https://guides.cocoapods.org/syntax/podspec.html">Podspec Syntax Reference</a></p>
<p>åˆ›å»ºsepcæ–‡ä»¶ï¼š</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">pod <span class="keyword">spec</span> create åº“å</span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹sepcæ–‡ä»¶å¦‚ä¸‹:</p>
<figure class="highlight nsis"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  Be sure to run `pod spec lint Peanut.podspec&#x27; to ensure this is a</span></span><br><span class="line"><span class="comment">#  valid spec and to remove all comments including this before submitting the spec.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  To learn more about Podspec attributes see https://guides.cocoapods.org/syntax/podspec.html</span></span><br><span class="line"><span class="comment">#  To see working Podspecs in the CocoaPods repo see https://github.com/CocoaPods/Specs/</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">Pod::Spec</span>.new do |spec|</span><br><span class="line"></span><br><span class="line">  <span class="comment"># â€•â€•â€•  Spec Metadata  â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€• #</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#  These will help people to find your library, and whilst it</span></span><br><span class="line">  <span class="comment">#  can feel like a chore to fill in it&#x27;s definitely to your advantage. The</span></span><br><span class="line">  <span class="comment">#  summary should be tweet-length, and the description more in depth.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">  spec.<span class="keyword">name</span>         = <span class="string">&quot;Peanut&quot;</span></span><br><span class="line">  spec.version      = <span class="string">&quot;0.0.1&quot;</span></span><br><span class="line">  spec.summary      = <span class="string">&quot;A short description of Peanut.&quot;</span></span><br><span class="line">  spec.homepage     = <span class="string">&quot;http://EXAMPLE/Peanut&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment"># â€•â€•â€•  Spec License  â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€• #</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#  Licensing your code is important. See https://choosealicense.com for more info.</span></span><br><span class="line">  <span class="comment">#  CocoaPods will detect a license file if there is a named LICENSE*</span></span><br><span class="line">  <span class="comment">#  Popular ones are &#x27;MIT&#x27;, &#x27;BSD&#x27; and &#x27;Apache License, Version 2.0&#x27;.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">  spec.<span class="literal">license</span>      = &#123; :type =&gt; <span class="string">&quot;MIT&quot;</span>, :<span class="keyword">file</span> =&gt; <span class="string">&quot;LICENSE&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment"># â€•â€•â€• Author Metadata  â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€• #</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#  Specify the authors of the library, with email addresses. Email addresses</span></span><br><span class="line">  <span class="comment">#  of the authors are extracted from the SCM log. E.g. $ git log. CocoaPods also</span></span><br><span class="line">  <span class="comment">#  accepts just a name if you&#x27;d rather not provide an email address.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#  Specify a social_media_url where others can refer to, for example a twitter</span></span><br><span class="line">  <span class="comment">#  profile URL.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">  spec.author             = &#123; <span class="string">&quot;mt&quot;</span> =&gt; <span class="string">&quot;é‚®ç®±&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment"># â€•â€•â€• Platform Specifics â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€• #</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#  If this Pod runs only on iOS or OS X, then specify the platform and</span></span><br><span class="line">  <span class="comment">#  the deployment target. You can optionally include the target after the platform.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">  spec.platform     = :ios, <span class="string">&quot;10.0&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment"># â€•â€•â€• Source Location â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€• #</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#  Specify the location from where the source should be retrieved.</span></span><br><span class="line">  <span class="comment">#  Supports git, hg, bzr, svn and HTTP.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">  spec.source       = &#123; :git =&gt; <span class="string">&quot;http://EXAMPLE/Peanut.git&quot;</span>, :tag =&gt; <span class="string">&quot;#&#123;spec.version&#125;&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment"># â€•â€•â€• Source Code â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€• #</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#  CocoaPods is smart about how it includes source code. For source files</span></span><br><span class="line">  <span class="comment">#  giving a folder will include any swift, h, m, mm, c &amp; cpp files.</span></span><br><span class="line">  <span class="comment">#  For header files it will include any header in the folder.</span></span><br><span class="line">  <span class="comment">#  Not including the public_header_files will make all headers public.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">  spec.source_files  = <span class="string">&quot;Peanut/Classes/**/*&quot;</span></span><br><span class="line">  <span class="comment"># spec.exclude_files = &quot;Classes/Exclude&quot;</span></span><br><span class="line">  <span class="comment"># spec.public_header_files = &quot;Classes/**/*.h&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment"># â€•â€•â€• Resources â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€• #</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#  A list of resources included with the Pod. These are copied into the</span></span><br><span class="line">  <span class="comment">#  target bundle with a build phase script. Anything else will be cleaned.</span></span><br><span class="line">  <span class="comment">#  You can preserve files from being cleaned, please don&#x27;t preserve</span></span><br><span class="line">  <span class="comment">#  non-essential files like tests, examples and documentation.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">  spec.resources = <span class="string">&quot;Resources/*&quot;</span></span><br><span class="line">  <span class="comment"># spec.preserve_paths = &quot;FilesToSave&quot;, &quot;MoreFilesToSave&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment"># â€•â€•â€• Project Linking â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€• #</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#  Link your library with frameworks, or libraries. Libraries do not include</span></span><br><span class="line">  <span class="comment">#  the lib prefix of their name.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">  spec.frameworks = <span class="string">&quot;Foundation&quot;</span>, <span class="string">&quot;UIKit&quot;</span></span><br><span class="line">  <span class="comment"># spec.libraries = &quot;iconv&quot;, &quot;xml2&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment"># â€•â€•â€• Project Settings â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€• #</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#  If your library depends on compiler flags you can set them in the xcconfig hash</span></span><br><span class="line">  <span class="comment">#  where they will only apply to your library. If you depend on other Podspecs</span></span><br><span class="line">  <span class="comment">#  you can include multiple dependencies to ensure it works.</span></span><br><span class="line"></span><br><span class="line">  spec.requires_arc = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># spec.xcconfig = &#123; &quot;HEADER_SEARCH_PATHS&quot; =&gt; &quot;$(SDKROOT)/usr/include/libxml2&quot; &#125;</span></span><br><span class="line">  <span class="comment"># spec.dependency &quot;JSONKit&quot;, &quot;~&gt; 1.4&quot;</span></span><br><span class="line"></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>çœ‹ä¸Šé¢çš„æ³¨é‡Šå¾ˆå®¹æ˜“çœ‹æ‡‚ã€‚</p>
<p><strong>2. éªŒè¯podåº“</strong></p>
<p>podæºç å’Œpod sepcæ–‡ä»¶éƒ½å‡†å¤‡å¥½åï¼Œåˆ«ç€æ€¥å‘å¸ƒï¼Œå…ˆéªŒè¯podåº“çš„å¯ç”¨æ€§:</p>
<p><code>pod spec lint xxx.podsepc</code></p>
<p>éªŒè¯åº“å‘:</p>
<p><code>pod spec lint name.podsepc</code></p>
<p>ä¸€ç›´æç¤º:CDN: trunk URL couldnâ€™t be downloaded</p>
<figure class="highlight vhdl"><table><tr><td class="code"><pre><span class="line">-&gt; XQSheet (<span class="number">2.0</span>.<span class="number">0</span>)</span><br><span class="line">   - <span class="literal">ERROR</span> | [iOS] unknown: Encountered an unknown <span class="literal">error</span> (CDN: trunk URL couldn<span class="symbol">&#x27;t</span> be downloaded: https://raw.githubusercontent.com/CocoaPods/Specs/master/Specs/<span class="number">4</span>/<span class="number">2</span>/<span class="number">1</span>/JKPresentationController/<span class="number">1.0</span>.<span class="number">0</span>/JKPresentationController.podspec.json, <span class="literal">error</span>: Failed <span class="keyword">to</span> <span class="keyword">open</span> TCP connection <span class="keyword">to</span> raw.githubusercontent.com:<span class="number">443</span> (Connection refused - connect(<span class="number">2</span>) <span class="keyword">for</span> <span class="string">&quot;raw.githubusercontent.com&quot;</span> <span class="keyword">port</span> <span class="number">443</span>)) during validation.</span><br></pre></td></tr></table></figure>
<p>è§£å†³åŠæ³•ï¼šæŒ‡å®šsourceã€‚</p>
<p><code>pod spec lint name.podsepc --sources=&#39;https://github.com/CocoaPods/Specs.git&#39;</code></p>
<p>å…è®¸è­¦å‘Šå¯ä»¥æ·»åŠ ï¼šâ€”allow-warnings</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">pod spec lint GSDMediaCache<span class="selector-class">.podspec</span> <span class="attr">--allow-warnings</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœä½¿ç”¨podè¿˜ä¾èµ–äº†ç¬¬ä¸‰æ–¹åº“åˆ™è¿˜éœ€è¦æ·»åŠ â€”use-librariesï¼šè¡¨ç¤ºä½¿ç”¨é™æ€åº“æˆ–è€…æ˜¯frameworkï¼Œè¿™é‡Œä¸»è¦æ˜¯è§£å†³å½“æˆ‘ä»¬ä¾èµ–ä¸€äº›frameworkåº“åæ ¡éªŒæç¤ºæ‰¾ä¸åˆ°åº“çš„æ—¶å€™ç”¨åˆ°ã€‚</p>
<p>eg:</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">pod spec lint GSDMediaCache<span class="selector-class">.podspec</span> <span class="attr">--allow-warnings</span> <span class="attr">--use-libraries</span></span><br></pre></td></tr></table></figure>
<p><strong>3.æäº¤podåˆ°GitHubï¼Œå¹¶æ‰“tag</strong></p>
<p>è¿™ä¸ªå°±æ˜¯å¹³æ—¶å¼€å‘æäº¤ä»£ç ï¼Œæ‰“tagã€‚</p>
<p>å‰é¢è¿™å‡ æ­¥å’Œåˆ¶ä½œç§æœ‰åº“æ˜¯ä¸€æ ·çš„éƒ½æ˜¯å‡†å¤‡å·¥ä½œã€‚</p>
<p><strong>4. å‘å¸ƒ</strong></p>
<p>è¦æƒ³å‘å¸ƒä¸€ä¸ªå…¬å¼€åº“ï¼Œéœ€è¦å…ˆæ³¨å†Œä¸€ä¸ª CocoaPods è´¦å·ã€‚</p>
<p>æŸ¥çœ‹æœ‰æ²¡æœ‰æ³¨å†Œè¿‡ï¼š</p>
<p><code>pod trunk me</code></p>
<p>å¦‚æœæ²¡æœ‰é‚£ä¹ˆå…ˆæ³¨å†Œï¼š</p>
<p><code>pod trunk register EMAIL [NAME]</code></p>
<p>eg:</p>
<p><code>pod trunk register orta@cocoapods.org &#39;Orta Therox&#39; --description=&#39;macbook air&#39;</code></p>
<p>æ³¨å†Œå¥½åï¼Œå¼€å§‹å‘å¸ƒï¼Œä½¿ç”¨å‘½ä»¤ï¼š</p>
<p><code>pod trunk push xxx.podspec</code></p>
<p>å°†pod specæ–‡ä»¶æ¨é€åˆ°cocoapodsçš„å®˜æ–¹ä»“åº“ï¼Œè¿™æ ·åˆ«äººæ‰èƒ½æ‰¾å¾—åˆ°ã€‚</p>
<p>æ³¨æ„ï¼špod trunk pushä¹Ÿä¼šéªŒè¯åº“ï¼Œæ‰€ä»¥ä¸Šé¢é¢„éªŒè¯çš„å‚æ•°è¿˜å¾—åŠ ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">pod trunk push GSDMediaCache<span class="selector-class">.podspec</span> <span class="attr">--allow-warnings</span> <span class="attr">--use-libraries</span></span><br></pre></td></tr></table></figure>
<p>æ¨é€åº“å‘:</p>
<p><code>pod trunk push XQSheet.podspec</code></p>
<figure class="highlight vhdl"><table><tr><td class="code"><pre><span class="line">Updating spec repo `trunk`</span><br><span class="line"></span><br><span class="line">CocoaPods <span class="number">1.9</span>.<span class="number">1</span> <span class="keyword">is</span> available.</span><br><span class="line"><span class="keyword">To</span> update <span class="keyword">use</span>: `sudo gem install cocoapods`</span><br><span class="line"></span><br><span class="line"><span class="keyword">For</span> more information, see https://blog.cocoapods.org <span class="keyword">and</span> the CHANGELOG <span class="keyword">for</span> this version at https://github.com/CocoaPods/CocoaPods/releases/tag/<span class="number">1.9</span>.<span class="number">1</span></span><br><span class="line"></span><br><span class="line">Validating podspec</span><br><span class="line"> -&gt; XQSheet (<span class="number">2.0</span>.<span class="number">0</span>)</span><br><span class="line">    - <span class="literal">ERROR</span> | [iOS] unknown: Encountered an unknown <span class="literal">error</span> (CDN: trunk URL couldn<span class="symbol">&#x27;t</span> be downloaded: https://raw.githubusercontent.com/CocoaPods/Specs/master/Specs/<span class="number">4</span>/<span class="number">2</span>/<span class="number">1</span>/JKPresentationController/<span class="number">1.0</span>.<span class="number">0</span>/JKPresentationController.podspec.json, <span class="literal">error</span>: Failed <span class="keyword">to</span> <span class="keyword">open</span> TCP connection <span class="keyword">to</span> raw.githubusercontent.com:<span class="number">443</span> (Connection refused - connect(<span class="number">2</span>) <span class="keyword">for</span> <span class="string">&quot;raw.githubusercontent.com&quot;</span> <span class="keyword">port</span> <span class="number">443</span>)) during validation.</span><br><span class="line"></span><br><span class="line">[!] The spec did <span class="keyword">not</span> pass validation, due <span class="keyword">to</span> <span class="number">1</span> <span class="literal">error</span>.</span><br></pre></td></tr></table></figure>
<p>ä¸€ç›´å¡åœ¨è¿™é‡Œ,æœ€åè®©ç»ˆç«¯ç¿»å¢™åå¥½äº†.</p>
<p><strong>5. éªŒè¯ç»“æœ</strong></p>
<p>æ¨é€åˆ°CocoaPodsæˆåŠŸåï¼Œæˆ‘ä»¬å¯ä»¥æœç´¢åˆšæ‰åˆ¶ä½œçš„podã€‚æ­¤æ—¶ä¸€èˆ¬æ˜¯æœä¸åˆ°çš„ï¼Œå› ä¸ºä½ æœ¬åœ°çš„æœç´¢ç´¢å¼•æ–‡ä»¶ï¼Œpod specä»“åº“éƒ½æ˜¯æ—§çš„ã€‚</p>
<p>å‘å¸ƒæˆåŠŸåæœç´¢ä¸åˆ°è§£å†³åŠæ³•:</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ›´æ–°specä»“åº“ã€‚æ›´æ–°åå°è¯•æœç´¢ï¼Œå¦‚æœè¿˜æœä¸åˆ°å°±ç»§ç»­åé¢ä¸€æ­¥ã€‚</span></span><br><span class="line">pod repo <span class="keyword">update</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ é™¤æœ¬åœ°ç´¢å¼•</span></span><br><span class="line"><span class="keyword">rm</span> ~/Library/Caches/CocoaPods/search_index.json</span><br><span class="line"></span><br><span class="line"><span class="comment">//æœç´¢</span></span><br><span class="line">pod <span class="keyword">search</span> [åº“å]</span><br></pre></td></tr></table></figure>
<p><strong>æ‰©å±•</strong></p>
<p>ä¸Šè¿°æ­¥éª¤æ¯æ¬¡æ“ä½œä¹Ÿéƒ½æŒºç¹ççš„ï¼Œå¯ä»¥è€ƒè™‘è‡ªåŠ¨åŒ–ï¼Œå‚è€ƒï¼š<a href="https://ripperhe.com/2017/03/30/fastlane-pod/">ä¸€è¡Œå‘½ä»¤å‘å¸ƒ Pod æ¡†æ¶</a></p>
<p><strong>å…¶ä»–</strong></p>
<p>ä¸Šè¿°podæ˜¯æ‰˜ç®¡åˆ°æŸä¸ªå¹³å°ä¸Šçš„ï¼Œå¦‚æœä¸æƒ³ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥æ‰˜ç®¡åœ¨æœ¬åœ°ç©ç©ã€‚</p>
<p>å®‰è£…æœ¬åœ°pod</p>
<p>å‡è®¾å·²ç»æœ‰äº†ä¸€ä¸ªæœ¬åœ°podã€‚<code>JKPresentationController.podspec</code>å¦‚ä¸‹:</p>
<figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">spec.source       = &#123; :<span class="function"><span class="params">git</span> =&gt;</span> <span class="string">&quot;./JKPresentationController/&quot;</span>, :<span class="function"><span class="params">tag</span> =&gt;</span> <span class="string">&quot;#&#123;spec.version&#125;&quot;</span> &#125;</span><br><span class="line">spec.source_files  = <span class="string">&quot;JKPresentationController/*.swift&quot;</span></span><br></pre></td></tr></table></figure>
<p>gitåé¢æ˜¯æºç æœ¬åœ°è·¯å¾„.</p>
<p>Podfileæ–‡ä»¶:</p>
<figure class="highlight elixir"><table><tr><td class="code"><pre><span class="line">source <span class="string">&#x27;https://github.com/CocoaPods/Specs.git&#x27;</span></span><br><span class="line"></span><br><span class="line">platform <span class="symbol">:ios</span>, <span class="string">&#x27;10.0&#x27;</span></span><br><span class="line">use_frameworks!</span><br><span class="line"></span><br><span class="line">target <span class="string">&#x27;JKPresentationControllerDemo&#x27;</span> <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">pod <span class="string">&#x27;JKPresentationController&#x27;</span>, <span class="symbol">:path</span> =&gt; <span class="string">&#x27;../&#x27;</span></span><br><span class="line">pod <span class="string">&#x27;SnapKit&#x27;</span>, <span class="string">&#x27;~&gt; 5.0.0&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>pathåé¢æ˜¯<code>JKPresentationController.podspec</code>æ‰€åœ¨çš„è·¯å¾„.</p>
<p>æ‰§è¡Œpod installå,Podså·¥ç¨‹ä¸‹ä¼šå‡ºç°ä¸€ä¸ª<code>Development Pods</code>ç›®å½•.è¯¥ç›®å½•ä¸­åŒ…å«ä½ çš„æºç æ–‡ä»¶å¤¹.</p>
<p>ç›¸å…³é˜…è¯»ï¼š<a href="https://xq-120.github.io/2020/04/15/%E5%88%B6%E4%BD%9CCocoaPods%E7%A7%81%E6%9C%89%E5%BA%93/#more">åˆ¶ä½œCocoaPodsç§æœ‰åº“</a></p>
]]></content>
      <categories>
        <category>CocoaPods</category>
      </categories>
      <tags>
        <tag>å…¬å¼€åº“</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆ¶ä½œCocoaPodsç§æœ‰åº“</title>
    <url>/2020/04/15/%E5%88%B6%E4%BD%9CCocoaPods%E7%A7%81%E6%9C%89%E5%BA%93/</url>
    <content><![CDATA[<p><strong>1. åˆ›å»ºç§æœ‰pod specä»“åº“</strong></p>
<p>å› ä¸ºåˆ¶ä½œçš„æ˜¯ç§æœ‰åº“æ‰€ä»¥å°±ä¸èƒ½æŠŠpod sepcæ–‡ä»¶å­˜æ”¾åˆ°cocoapodsçš„å…¬å¼€ä»“åº“ä¸­äº†ï¼Œå› æ­¤éœ€è¦åœ¨GitHubä¸Šæ–°å»ºä¸€ä¸ªrepository <code>XQSpecs</code>ç”¨äºä¿å­˜æ‰€æœ‰çš„ç§æœ‰pod specã€‚</p>
<p>å¦‚æœå·²ç»æœ‰è‡ªå·±çš„ç§æœ‰pod specä»“åº“ï¼Œåˆ™è¿™ä¸€æ­¥å¯è·³è¿‡ã€‚</p>
<p><strong>2. åˆ›å»ºç§æœ‰podåº“</strong></p>
<p>ä¸»è¦åŒ…å«podæºç å’Œpod sepcæ–‡ä»¶ã€è®¸å¯è¯ç­‰ã€‚</p>
<p>åˆ›å»ºpodåº“,å¯ä»¥ä½¿ç”¨å‘½ä»¤ï¼š<code>pod lib create xxx</code>ï¼Œåˆ›å»ºå¥½æ¨¡æ¿podï¼Œç„¶ååŸºäºæ¨¡æ¿ä¿®æ”¹ã€‚ä¹Ÿå¯ä»¥å…¨éƒ¨è‡ªå·±æ‰‹åŠ¨åˆ›å»ºã€‚</p>
<p>è¿›å…¥æœ¬åœ°ç›®çš„ç›®å½•ï¼Œä½¿ç”¨å‘½ä»¤ï¼š<code>pod lib create xxx</code>ï¼Œç„¶ååŸºäºæ¨¡æ¿ä¿®æ”¹ã€‚</p>
<p><strong>3. éªŒè¯podåº“</strong></p>
<p>podæºç å’Œpod sepcæ–‡ä»¶éƒ½å‡†å¤‡å¥½åï¼Œåˆ«ç€æ€¥å‘å¸ƒï¼Œå…ˆéªŒè¯podåº“çš„å¯ç”¨æ€§:</p>
<p><code>pod lib lint xxx.podspec</code>æˆ–è€…ä½¿ç”¨ï¼š<code>pod lib lint AlgorithmUtils.podspec --allow-warnings</code>ï¼Œå¿½ç•¥è­¦å‘Šã€‚</p>
<p><strong>4. æäº¤podåˆ°GitHubï¼Œå¹¶æ‰“tag</strong></p>
<p>åœ¨GitHubä¸Šæ–°å»ºä¸€ä¸ªrepositoryç”¨äºä¿å­˜pod.</p>
<p>åˆ›å»ºå®Œæˆåï¼Œå›åˆ°æœ¬åœ°podç›®å½•æ‰§è¡Œï¼š</p>
<figure class="highlight armasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">git</span> remote <span class="keyword">add</span> origin https:<span class="comment">//github.com/xq-120/AlgorithmUtils.git</span></span><br><span class="line"><span class="symbol">git</span> <span class="keyword">push</span> -u origin master</span><br></pre></td></tr></table></figure>
<p>å°†å·²å­˜åœ¨çš„æœ¬åœ°gitç›®å½•å…³è”åˆ°è¿œç¨‹åœ°å€ã€‚</p>
<p>æäº¤ä»£ç åˆ°è¿œç¨‹ï¼š</p>
<figure class="highlight avrasm"><table><tr><td class="code"><pre><span class="line">git <span class="keyword">add</span> .</span><br><span class="line">git commit -a -m <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line">git <span class="keyword">push</span></span><br></pre></td></tr></table></figure>
<p>æ‰“tagå¹¶æ¨é€åˆ°è¿œç¨‹:</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">git</span> tag <span class="number">0</span>.<span class="number">1</span>.<span class="number">0</span></span><br><span class="line"><span class="attribute">git</span> push origin <span class="number">0</span>.<span class="number">1</span>.<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p><strong>5. å‘å¸ƒ</strong></p>
<p>å¦‚æœæœ¬åœ°è¿˜æ²¡æœ‰åˆšåˆ›å»ºçš„pod specç§æœ‰ä»“åº“ï¼Œé‚£ä¹ˆéœ€è¦æ‰§è¡Œï¼š</p>
<p><code>pod repo add XQSpecs https://github.com/xq-120/XQSpecs.git</code></p>
<p>åœ¨æœ¬åœ°ç”ŸæˆXQSpecsç›®å½•ã€‚</p>
<p>å‘å¸ƒpod:</p>
<p><code>pod repo push XQSpecs xxx.podspec</code></p>
<p>å°†.podspecæ–‡ä»¶æ¨é€åˆ°pod specä»“åº“ä¸­ï¼ŒæˆåŠŸä¹‹åå°±å¯ä»¥åœ¨å…¶ä»–é¡¹ç›®é‡Œä½¿ç”¨è¯¥podäº†ã€‚</p>
<p><strong>6. ä½¿ç”¨</strong></p>
<p>åœ¨å…¶ä»–é¡¹ç›®ä½¿ç”¨ï¼š</p>
<figure class="highlight delphi"><table><tr><td class="code"><pre><span class="line">source <span class="string">&#x27;https://github.com/xq-120/XQSpecs.git&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">platform</span> :ios,<span class="string">&#x27;10.0&#x27;</span></span><br><span class="line">use_frameworks!</span><br><span class="line"></span><br><span class="line">target <span class="string">&#x27;adsad&#x27;</span> <span class="keyword">do</span></span><br><span class="line">   pod <span class="string">&#x27;AlgorithmUtils&#x27;</span>, <span class="string">&#x27;~&gt; 0.1.0&#x27;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><strong>7. å‡çº§</strong><br>å¦‚æœæ–°å¢äº†åŠŸèƒ½æˆ–ä¿®å¤äº†æŸä¸ªbugï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦å‡çº§podç‰ˆæœ¬å¹¶å‘å¸ƒã€‚è¿™ä¸ªè¿‡ç¨‹åŸºæœ¬ä¸Šæ˜¯é‡å¤ä¸Šè¿°æ­¥éª¤ã€‚</p>
<ul>
<li>podæ–°å¢åŠŸèƒ½æºç å˜åŠ¨ï¼Œæ›´æ”¹pod sepcé‡Œçš„podç‰ˆæœ¬</li>
<li>æœ€å¥½å†éªŒè¯ä¸€ä¸‹podåº“</li>
<li>æäº¤podåˆ°GitHubï¼Œå¹¶æ‰“tag</li>
<li>å‘å¸ƒã€‚<code>pod repo push XQSpecs xxx.podspec</code></li>
</ul>
<p>å¦‚æœpodä¿®æ”¹é¢‘ç¹ï¼Œå°±éœ€è¦é¢‘ç¹å‡çº§ç‰ˆæœ¬ï¼Œè¿™æ— ç–‘éå¸¸éº»çƒ¦ï¼Œå› æ­¤å¯ä»¥ç›´æ¥æŒ‡å®šgitè·¯å¾„å’Œbranchï¼Œè¿™æ ·å°±å¯ä»¥é¿å…æ¯æ¬¡ä¿®æ”¹åéƒ½éœ€è¦å‡çº§ç‰ˆæœ¬äº†ï¼š</p>
<figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">source <span class="string">&#x27;https://github.com/xq-120/XQSpecs.git&#x27;</span></span><br><span class="line"></span><br><span class="line">platform :ios,<span class="string">&#x27;10.0&#x27;</span></span><br><span class="line">use_frameworks!</span><br><span class="line"></span><br><span class="line">target <span class="string">&#x27;adsad&#x27;</span> <span class="keyword">do</span></span><br><span class="line">  </span><br><span class="line">   pod <span class="string">&#x27;AlgorithmUtils&#x27;</span>, :<span class="function"><span class="params">git</span> =&gt;</span> <span class="string">&#x27;https://github.com/xq-120/AlgorithmUtils.git&#x27;</span>, :<span class="function"><span class="params">branch</span> =&gt;</span> <span class="string">&#x27;master&#x27;</span></span><br><span class="line">     </span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>è¿˜æœ‰ä¸€ç§æ“ä½œï¼š</p>
<ul>
<li><p>ä¿®æ”¹æºç æäº¤åï¼Œåˆ é™¤åŸæ¥tag</p>
</li>
<li><p>åœ¨æ–°çš„æäº¤è®°å½•ä¸Šæ‰“tagï¼ˆtagåç§°å’Œä¹‹å‰ä¸€æ ·ï¼‰</p>
</li>
<li><p>è¿›å…¥æœ¬åœ°<code>~/Library/Caches/CocoaPods/Pods/Release</code>æ‰¾åˆ°ä¹‹å‰ä¸‹è½½ç¼“å­˜çš„podæºç åˆ é™¤</p>
</li>
<li>è¿›å…¥Xcodeå·¥ç¨‹ç¼–è¾‘Podfileæ–‡ä»¶æ³¨é‡Šæ‰podï¼Œæ‰§è¡Œpod installï¼Œå†æ”¾å¼€æ³¨é‡Špodï¼Œæ‰§è¡Œpod installï¼ˆå³é‡æ–°å®‰è£…podï¼‰</li>
</ul>
<p>ç›¸å…³é˜…è¯»ï¼š<a href="https://xq-120.github.io/2020/04/16/%E5%88%B6%E4%BD%9CCocoaPods%E5%85%AC%E5%BC%80%E5%BA%93/#more">åˆ¶ä½œCocoaPodså…¬å¼€åº“</a></p>
<p>å‚è€ƒï¼š<a href="https://juejin.im/post/5accdbc86fb9a028ca534f2e">å¦‚ä½•åˆ¶ä½œä¸€ä¸ªCocoaPodsç§æœ‰åº“</a></p>
]]></content>
      <categories>
        <category>CocoaPods</category>
      </categories>
      <tags>
        <tag>ç§æœ‰åº“</tag>
      </tags>
  </entry>
  <entry>
    <title>iOSè®¾ç½®åœ†è§’</title>
    <url>/2020/04/07/iOS%E8%AE%BE%E7%BD%AE%E5%9C%86%E8%A7%92/</url>
    <content><![CDATA[<p>iOSä¸­è®¾ç½®åœ†è§’å¤§è‡´æœ‰ä¸‹é¢å‡ ç§åŠæ³•ï¼Œæ¯ä¸€ç§éƒ½æœ‰å„è‡ªçš„ä¼˜ç¼ºç‚¹ï¼Œç»“åˆåœºæ™¯é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆæ‰æ˜¯æœ€ä½³å¤„ç†ã€‚</p>
<h4 id="1-cornerRadius"><a href="#1-cornerRadius" class="headerlink" title="1.cornerRadius"></a>1.cornerRadius</h4><figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line">Setting <span class="keyword">the</span> radius <span class="keyword">to</span> a value <span class="keyword">greater than</span> <span class="number">0.0</span> causes <span class="keyword">the</span> layer <span class="keyword">to</span> begin drawing rounded corners <span class="keyword">on</span> <span class="keyword">its</span> background. By default, <span class="keyword">the</span> corner radius <span class="keyword">does</span> <span class="keyword">not</span> apply <span class="keyword">to</span> <span class="keyword">the</span> image <span class="keyword">in</span> <span class="keyword">the</span> layerâ€™s <span class="built_in">contents</span> <span class="keyword">property</span>; <span class="keyword">it</span> applies only <span class="keyword">to</span> <span class="keyword">the</span> background color <span class="keyword">and</span> border <span class="keyword">of</span> <span class="keyword">the</span> layer. However, setting <span class="keyword">the</span> masksToBounds <span class="keyword">property</span> <span class="keyword">to</span> YES causes <span class="keyword">the</span> content <span class="keyword">to</span> be clipped <span class="keyword">to</span> <span class="keyword">the</span> rounded corners.</span><br><span class="line">The default value <span class="keyword">of</span> this <span class="keyword">property</span> <span class="keyword">is</span> <span class="number">0.0</span>.</span><br></pre></td></tr></table></figure>
<p>ç”±äºcornerRadiusåªå¯¹èƒŒæ™¯è‰²å’Œè¾¹æ¡†æœ‰æ•ˆè€Œå¯¹layerçš„contentså¹¶ä¸èµ·ä½œç”¨ï¼Œå› æ­¤ä¸€èˆ¬éƒ½ä¼šé…åˆmasksToBoundsä½¿ç”¨ã€‚</p>
<p>è‹¹æœåœ¨iOS9åå¯¹cornerRadius+masksToBoundsåšäº†ä¼˜åŒ–ï¼Œå½“contentModeå’ŒbackgroundColorä¸ºé»˜è®¤å€¼æ—¶å³ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">imgView.contentMode = <span class="built_in">UIViewContentModeScaleToFill</span>;</span><br><span class="line">imgView.backgroundColor = [<span class="built_in">UIColor</span> clearColor];</span><br></pre></td></tr></table></figure>
<p>ä¸ä¼šå¯¼è‡´ç¦»å±æ¸²æŸ“ï¼Œå¦åˆ™è¿˜ä¼šç¦»å±æ¸²æŸ“ï¼Œç”¨View DebuggingæŸ¥çœ‹UIImageViewä¼šæœ‰é»„è‰²æ ‡è¯†ã€‚</p>
<p>ä¸‹é¢æµ‹è¯•ä¸‹cornerRadius+masksToBoundså¯¹FPSçš„å½±å“ã€‚</p>
<p>åœ¨iPhone5s,10.3.3ä¸Šè¿è¡Œä¸€ä¸ªä¸€å±cellä¸Šæœ‰36ä¸ªåœ†è§’çš„Demoï¼ŒimgViewçš„contentModeå’ŒbackgroundColoréƒ½ä¸ä½¿ç”¨é»˜è®¤å€¼ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/IMG_0031.PNG" style="zoom:33%;" /></p>
<p>æ»‘åŠ¨èµ·æ¥ä¾ç„¶å¾ˆé¡ºæ»‘FPSåŸºæœ¬åœ¨58å·¦å³ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/8E0CA66E-8879-4C90-B6D1-5CC0ADC9D9C8.png" style="zoom:50%;" /></p>
<p>å¯è§ä½¿ç”¨cornerRadius+masksToBoundsåˆ‡åœ†è§’å¯¹æ€§èƒ½çš„å½±å“å¹¶ä¸å¤§ã€‚å¯èƒ½åœ¨iOS9ä»¥å‰æ¯”è¾ƒå½±å“æ€§èƒ½ã€‚</p>
<p>è¯¥æ–¹æ¡ˆæœ€ç®€å•ï¼Œå¦‚æœé¡µé¢åœ†è§’ä¸å¤šï¼Œå¤§å¯ä»¥ä½¿ç”¨è¯¥æ–¹æ¡ˆã€‚</p>
<h4 id="2-å°†åŸå§‹å›¾ç‰‡å¤„ç†ä¸ºå¸¦åœ†è§’çš„å›¾ç‰‡"><a href="#2-å°†åŸå§‹å›¾ç‰‡å¤„ç†ä¸ºå¸¦åœ†è§’çš„å›¾ç‰‡" class="headerlink" title="2.å°†åŸå§‹å›¾ç‰‡å¤„ç†ä¸ºå¸¦åœ†è§’çš„å›¾ç‰‡"></a>2.å°†åŸå§‹å›¾ç‰‡å¤„ç†ä¸ºå¸¦åœ†è§’çš„å›¾ç‰‡</h4><p>å¦‚æœè¯´ä¸Šé¢æ˜¯å¯¹æ§ä»¶åˆ‡åœ†è§’é‚£ä¹ˆè¿™ç§åŠæ³•å°±æ˜¯å¯¹å›¾ç‰‡è¿›è¡Œåˆ‡åœ†è§’äº†ï¼Œè¯¥æ–¹æ³•ä¸ä¼šå¼•èµ·ç¦»å±æ¸²æŸ“ã€‚å¦‚æœç¡®å®šæ˜¯ç¦»å±æ¸²æŸ“é€ æˆæ€§èƒ½ä¸‹é™ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨è¯¥æ–¹æ³•ã€‚</p>
<p>å°†å›¾ç‰‡å¤„ç†ä¸ºåœ†è§’å¯ä»¥åœ¨å®¢æˆ·ç«¯åšä¹Ÿå¯ä»¥åœ¨æœåŠ¡å™¨ç«¯åšã€‚</p>
<blockquote>
<p>æœåŠ¡å™¨ç«¯å¤„ç†</p>
</blockquote>
<p>ä¸€èˆ¬åœ¨åŸå§‹å›¾ç‰‡URLä¸Šæ‹¼æ¥å‚æ•°å‘Šè¯‰åå°è¦åˆ‡å¤šå¤§çš„åœ†è§’ã€‚</p>
<blockquote>
<p>å®¢æˆ·ç«¯å¤„ç†</p>
</blockquote>
<p>å¦‚æœåå°ä¸æ”¯æŒï¼Œé‚£åªèƒ½è‡ªå·±å¤„ç†äº†ã€‚å®¢æˆ·ç«¯å¤„ç†çš„è¯ä¸€èˆ¬é€šè¿‡Core Graphics å®ç°:</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">UIImage</span> *)setRoundingCorners:(<span class="built_in">UIRectCorner</span>)corners radius:(<span class="built_in">CGFloat</span>)radius targetSize:(<span class="built_in">CGSize</span>)size &#123;</span><br><span class="line">    <span class="built_in">CGRect</span> rect = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, size.width, size.height);</span><br><span class="line">    <span class="built_in">UIGraphicsBeginImageContextWithOptions</span>(rect.size, <span class="literal">NO</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">CGContextRef</span> ctx = <span class="built_in">UIGraphicsGetCurrentContext</span>();</span><br><span class="line">    <span class="built_in">UIBezierPath</span> *path = [<span class="built_in">UIBezierPath</span> bezierPathWithRoundedRect:rect byRoundingCorners:corners cornerRadii:<span class="built_in">CGSizeMake</span>(radius, radius)];</span><br><span class="line">    <span class="built_in">CGContextAddPath</span>(ctx, path.CGPath);</span><br><span class="line">    <span class="built_in">CGContextClip</span>(ctx);</span><br><span class="line">    [<span class="keyword">self</span> drawInRect:rect];</span><br><span class="line">    <span class="built_in">CGContextDrawPath</span>(ctx, kCGPathFillStroke);</span><br><span class="line">    <span class="built_in">UIImage</span> *img = <span class="built_in">UIGraphicsGetImageFromCurrentImageContext</span>();</span><br><span class="line">    <span class="built_in">UIGraphicsEndImageContext</span>();</span><br><span class="line">    <span class="keyword">return</span> img;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ï¼ˆps:ä¸Šè¿°ä»£ç è™½ç„¶ç»™å›¾ç‰‡åŠ ä¸Šäº†åœ†è§’ï¼Œä½†å›¾ç‰‡çš„å¡«å……æ–¹å¼æ˜¯ç®€å•å¡«æ»¡å¤„ç†ï¼Œå› æ­¤å½“å›¾ç‰‡ä¸æ§ä»¶ä¸æˆæ¯”ä¾‹æ—¶ä¼šå¯¼è‡´å›¾ç‰‡å˜å½¢ï¼Œæœ€å¥½çš„åŠæ³•æ˜¯å…ˆç­‰æ¯”ä¾‹ç¼©æ”¾åŸå§‹å›¾ç‰‡åå†è°ƒç”¨ä¸Šè¿°ä»£ç æ·»åŠ åœ†è§’å¤„ç†ï¼‰</p>
<p>è¿™æ ·å°±å°†GPUçš„å·¥ä½œè½¬ç§»ç»™äº†CPUï¼Œå› æ­¤ä¼šå¯¹CPUé€ æˆä¸€å®šçš„è´Ÿæ‹…ï¼Œå¯ä»¥ç»“åˆSDWebImageå°†å¤„ç†å¥½çš„å›¾ç‰‡è¿›è¡Œç¼“å­˜é¿å…æ¯æ¬¡é‡å¤å¤„ç†ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)sd_setImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">          placeholderImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)placeholder</span><br><span class="line">           roundingCorners:(<span class="built_in">UIRectCorner</span>)corners</span><br><span class="line">                    radius:(<span class="built_in">CGFloat</span>)radius</span><br><span class="line">                targetSize:(<span class="built_in">CGSize</span>)size</span><br><span class="line">                 completed:(<span class="keyword">nullable</span> SDExternalCompletionBlock)completedBlock</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *cachedKey = [<span class="keyword">self</span> getCachedKeyWithURLString:url.absoluteString roundingCorners:corners radius:radius targetSize:size];</span><br><span class="line">    SDImageCacheType cacheType = SDImageCacheTypeNone;</span><br><span class="line">    <span class="built_in">UIImage</span> *cachedImage = [[SDImageCache sharedImageCache] imageFromMemoryCacheForKey:cachedKey];</span><br><span class="line">    <span class="keyword">if</span> (cachedImage) &#123;</span><br><span class="line">        cacheType = SDImageCacheTypeMemory;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cachedImage = [[SDImageCache sharedImageCache] imageFromDiskCacheForKey:cachedKey];</span><br><span class="line">        <span class="keyword">if</span> (cachedImage) &#123;</span><br><span class="line">            cacheType = SDImageCacheTypeDisk;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (cachedImage) &#123;</span><br><span class="line">        <span class="keyword">self</span>.image = cachedImage;</span><br><span class="line">        !completedBlock ?: completedBlock(cachedImage, <span class="literal">nil</span>, cacheType, url);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        __<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br><span class="line">        [<span class="keyword">self</span> sd_setImageWithURL:url placeholderImage:placeholder options:SDWebImageAvoidAutoSetImage context:@&#123;SDWebImageContextStoreCacheType:@(SDImageCacheTypeNone)&#125; progress:<span class="literal">nil</span> completed:^(<span class="built_in">UIImage</span> * _Nullable image, <span class="built_in">NSError</span> * _Nullable error, SDImageCacheType cacheType, <span class="built_in">NSURL</span> * _Nullable imageURL) &#123;</span><br><span class="line">            <span class="built_in">UIImage</span> *transformedImage = <span class="literal">nil</span>;</span><br><span class="line">            <span class="keyword">if</span> (!error &amp;&amp; image) &#123;</span><br><span class="line">                <span class="built_in">CGSize</span> targetSize = <span class="built_in">CGSizeEqualToSize</span>(size, <span class="built_in">CGSizeZero</span>) ? weakSelf.frame.size : size;</span><br><span class="line">                transformedImage = [image setRoundingCorners:corners radius:radius targetSize:targetSize];</span><br><span class="line">                weakSelf.image = transformedImage;</span><br><span class="line">                [[SDImageCache sharedImageCache] storeImage:transformedImage forKey:cachedKey completion:<span class="literal">nil</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            !completedBlock ?: completedBlock(transformedImage, error, cacheType, imageURL);</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)getCachedKeyWithURLString:(<span class="built_in">NSString</span> *)urlString roundingCorners:(<span class="built_in">UIRectCorner</span>)corners radius:(<span class="built_in">CGFloat</span>)radius targetSize:(<span class="built_in">CGSize</span>)size &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *cachedKey = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;%@?c=%lu&amp;r=%f&amp;w=%f&amp;h=%f&quot;</span>, urlString, (<span class="type">unsigned</span> <span class="type">long</span>)corners, radius, size.width, size.height];</span><br><span class="line">    <span class="keyword">return</span> cachedKey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥æ–¹æ¡ˆè¾ƒä¸ºå¤æ‚å¯ä»¥è¿›è¡Œä¸€å®šçš„å°è£…ï¼Œå¦‚æœç¡®å®šæ˜¯åœ†è§’ç¦»å±æ¸²æŸ“å¼•èµ·æ€§èƒ½é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨è¯¥æ–¹æ¡ˆè§£å†³ã€‚</p>
<h4 id="3-ä½¿ç”¨ç‰¹åˆ¶çš„åœ†è§’åˆ‡å›¾ç›–ä½åŸå§‹å›¾ç‰‡"><a href="#3-ä½¿ç”¨ç‰¹åˆ¶çš„åœ†è§’åˆ‡å›¾ç›–ä½åŸå§‹å›¾ç‰‡" class="headerlink" title="3.ä½¿ç”¨ç‰¹åˆ¶çš„åœ†è§’åˆ‡å›¾ç›–ä½åŸå§‹å›¾ç‰‡"></a>3.ä½¿ç”¨ç‰¹åˆ¶çš„åœ†è§’åˆ‡å›¾ç›–ä½åŸå§‹å›¾ç‰‡</h4><p>éšœçœ¼æ³•ï¼Œåœ¨æ»¡è¶³éœ€æ±‚å’Œæ•ˆæœçš„æƒ…å†µä¸‹è¿™ç§æ–¹æ¡ˆåº”è¯¥æ˜¯æ•ˆç‡æœ€é«˜çš„äº†ï¼Œæ—¢ä¸ä¼šäº§ç”Ÿç¦»å±æ¸²æŸ“ä¹Ÿä¸ä¼šåŠ é‡CPUçš„è´Ÿæ‹…ï¼Œç¼ºç‚¹æ˜¯åº”ç”¨åœºæ™¯æœ‰é™ã€‚</p>
<h4 id="4-ä½¿ç”¨ä¸€ä¸ªåœ†è§’è·¯å¾„çš„CAShapeLayerè®¾ç½®mask"><a href="#4-ä½¿ç”¨ä¸€ä¸ªåœ†è§’è·¯å¾„çš„CAShapeLayerè®¾ç½®mask" class="headerlink" title="4.ä½¿ç”¨ä¸€ä¸ªåœ†è§’è·¯å¾„çš„CAShapeLayerè®¾ç½®mask"></a>4.ä½¿ç”¨ä¸€ä¸ªåœ†è§’è·¯å¾„çš„CAShapeLayerè®¾ç½®mask</h4><p>åƒä¸‡ä¸è¦ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œä¼šå¯¼è‡´ç¦»å±æ¸²æŸ“è€Œä¸”ä¼šæ˜æ˜¾æ„Ÿè§‰åˆ°å¡ï¼Œæ€§èƒ½æ¯”cornerRadius+masksToBoundsè¿˜å·®ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">CAShapeLayer</span> *cornerLayer = [<span class="built_in">CAShapeLayer</span> layer];</span><br><span class="line">cornerLayer.frame = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, kImageWH, kImageWH);</span><br><span class="line">cornerLayer.path = [<span class="built_in">UIBezierPath</span> bezierPathWithRoundedRect:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, kImageWH, kImageWH) cornerRadius:kImageWH/<span class="number">2.0</span>].CGPath;</span><br><span class="line"><span class="keyword">self</span>.imgView.layer.mask = cornerLayer;</span><br></pre></td></tr></table></figure>
<h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><p><a href="https://awhisper.github.io/2016/03/12/æ»šåŠ¨åœ†è§’å¡é¡¿åˆ¨æ ¹é—®åº•/">åœ†è§’å¡é¡¿åˆ¨æ ¹é—®åº•</a></p>
<p><a href="http://www.cocoachina.com/articles/12873">å°å¿ƒåˆ«è®©åœ†è§’æˆäº†ä½ åˆ—è¡¨çš„å¸§æ•°æ€æ‰‹</a></p>
<p><a href="https://bestswifter.com/efficient-rounded-corner/">iOSé«˜æ•ˆæ·»åŠ åœ†è§’æ•ˆæœå®æˆ˜è®²è§£</a></p>
<p><a href="https://ronghaopger.github.io/2017/07/iOSä¼˜åŒ–ç•Œé¢æ¸²æŸ“å®è·µä¸­çš„å‡ ç‚¹ç»éªŒ/">iOSä¼˜åŒ–ç•Œé¢æ¸²æŸ“å®è·µä¸­çš„å‡ ç‚¹ç»éªŒ</a></p>
<p><a href="https://www.kancloud.cn/manual/ios/97828">Instrumentsä½¿ç”¨</a></p>
<p><a href="https://medium.com/@peteliev/diagnose-and-solve-performance-problem-with-xcode-instruments-5c25c27f21d5">Diagnose and solve performance problems with Xcode Instruments</a></p>
]]></content>
      <categories>
        <category>UIKit</category>
      </categories>
      <tags>
        <tag>UIImageView</tag>
        <tag>åœ†è§’</tag>
      </tags>
  </entry>
  <entry>
    <title>IRRå†…éƒ¨æ”¶ç›Šç‡</title>
    <url>/2020/04/06/IRR%E5%86%85%E9%83%A8%E6%94%B6%E7%9B%8A%E7%8E%87/</url>
    <content><![CDATA[<h4 id="ROI"><a href="#ROI" class="headerlink" title="ROI"></a>ROI</h4><p>return on investmentï¼ŒæŠ•èµ„å›æŠ¥ç‡ã€‚</p>
<p>æŠ•èµ„å›æŠ¥ç‡çš„è®¡ç®—å…¬å¼ï¼š</p>
<figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">æŠ•èµ„å›æŠ¥ç‡ <span class="operator">=</span> ï¼ˆæ”¶ç›Š - æˆæœ¬ï¼‰/ æˆæœ¬ * <span class="number">100</span>%</span><br></pre></td></tr></table></figure>
<p>eg:</p>
<p>é¡¹ç›®AæŠ•å…¥æœ¬é‡‘100ï¼Œæœ€åå¯ä»¥110ï¼Œé‚£ä¹ˆROI = ï¼ˆ110 - 100ï¼‰/ 100 * 100% = 10%</p>
<p>é¡¹ç›®BæŠ•å…¥æœ¬é‡‘100ï¼Œæœ€åå¯ä»¥105ï¼Œé‚£ä¹ˆROI = ï¼ˆ105 - 100ï¼‰/ 100 * 100% = 5%</p>
<p>é€šè¿‡è®¡ç®—åº”è¯¥é€‰æ‹©é¡¹ç›®Aã€‚</p>
<p><strong>æŠ•èµ„æŠ¥é…¬ç‡çš„ä¼˜ç¼ºç‚¹</strong></p>
<p>ä¼˜ç‚¹ï¼š</p>
<p>è®¡ç®—æ–¹ä¾¿ï¼Œå¯ä»¥ç®€å•ç²—æš´çš„å¯¹ä¸åŒé¡¹ç›®è¿›è¡Œæ¨ªå‘æ¯”è¾ƒã€‚</p>
<p>ç¼ºç‚¹ï¼š</p>
<p>æ²¡æœ‰è€ƒè™‘èµ„é‡‘æ—¶é—´ä»·å€¼å› ç´ ï¼Œä¸èƒ½æ­£ç¡®åæ˜ å»ºè®¾æœŸé•¿çŸ­åŠæŠ•èµ„æ–¹å¼ä¸åŒå’Œå›æ”¶é¢çš„æœ‰æ— ç­‰æ¡ä»¶å¯¹é¡¹ç›®çš„å½±å“ï¼Œåˆ†å­ã€åˆ†æ¯è®¡ç®—å£å¾„çš„å¯æ¯”æ€§è¾ƒå·®ï¼Œæ— æ³•ç›´æ¥åˆ©ç”¨<a href="https://wiki.mbalib.com/wiki/å‡€ç°é‡‘æµé‡">å‡€ç°é‡‘æµé‡</a>ä¿¡æ¯ã€‚ä¸€å¥è¯å°±æ˜¯å¤ªç²—ç³™äº†ï¼Œæ— æ³•ä½“ç°æŠ•èµ„æœŸé—´çš„ä¸€äº›ç»†èŠ‚ã€‚</p>
<p>ä¸ºäº†è§£å†³ROIçš„ç¼ºç‚¹ï¼Œéœ€è¦å¼•å…¥ä¸‹ä¸€ä¸ªæ¦‚å¿µNPVã€‚</p>
<h4 id="NPV"><a href="#NPV" class="headerlink" title="NPV"></a>NPV</h4><p><em>Net present value</em> å‡€ç°å€¼ï¼ŒæŒ‡ä¸€é¡¹æŠ•èµ„æ‰€äº§ç”Ÿçš„æœªæ¥ç°é‡‘æµçš„æŠ˜ç°å€¼ä¸é¡¹ç›®æŠ•èµ„æˆæœ¬ä¹‹é—´çš„å·®å€¼ã€‚å‡€ç°å€¼æŒ‡æ ‡æ˜¯åæ˜ é¡¹ç›®æŠ•èµ„è·åˆ©èƒ½åŠ›çš„æŒ‡æ ‡ï¼Œå‡€ç°å€¼&gt;=0è¡¨ç¤ºæ–¹æ¡ˆå¯è¡Œï¼Œ&lt;0è¡¨ç¤ºä¸å¯è¡Œï¼Œå‡€ç°å€¼è¶Šå¤§è¶Šå¥½ã€‚</p>
<p>ç®€å•ç‚¹è®²å°±æ˜¯å°†æœªæ¥çš„ç°é‡‘æŠ˜ç°ä¸ºå½“å‰çš„ç°é‡‘å†ä¸æœ¬é‡‘ç›¸æ¯”è¾ƒã€‚å‡è®¾æ‹¿100å—é’±å»åšæŠ•èµ„ï¼Œå¯ä»¥æ¥å—çš„æœ€ä½æ”¶ç›Šç‡æ˜¯5%ï¼ˆå³æŠ˜ç°ç‡ï¼‰ï¼Œä¸€å¹´åæ‹¿å›110å—åˆ™NPV = 110 / (1 + 5%) - 100 = 104.76 - 100 = 4.76ã€‚<code>110 / (1 + 5%)</code>è¡¨ç¤ºçš„å°±æ˜¯å°†æœªæ¥çš„ç°é‡‘æŠ˜ç°ä¸ºå½“å‰çš„ç°é‡‘ï¼Œè®¡ç®—è¿‡ç¨‹è·Ÿåˆ©æ¯ç›¸åï¼ˆè®¡ç®—åˆ©æ¯ï¼š100å…ƒï¼Œå‡è®¾æ”¶ç›Šç‡ä¸º5%åˆ™ä¸€å¹´åå¯è·å¾—100 * ï¼ˆ1 + 5%ï¼‰ = 105ï¼‰ã€‚</p>
<p>ä¸¾ä¸ªå¤æ‚ç‚¹çš„ä¾‹å­ï¼š</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">æœ¬é‡‘</th>
<th style="text-align:center">ç¬¬ä¸€å¹´å‡€ç°é‡‘æµ</th>
<th style="text-align:center">ç¬¬äºŒå¹´å‡€ç°é‡‘æµ</th>
<th style="text-align:center">æœ¬åˆ©å’Œ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">é¡¹ç›®A</td>
<td style="text-align:center">100</td>
<td style="text-align:center">80</td>
<td style="text-align:center">30</td>
<td style="text-align:center">110</td>
</tr>
<tr>
<td style="text-align:center">é¡¹ç›®B</td>
<td style="text-align:center">100</td>
<td style="text-align:center">4</td>
<td style="text-align:center">106</td>
<td style="text-align:center">110</td>
</tr>
</tbody>
</table>
</div>
<p>å¦‚æœé€šè¿‡ROIæ³•è®¡ç®—ï¼Œé¡¹ç›®Aå’Œé¡¹ç›®Bå¾—åˆ°çš„ç»“æœæ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œæ€»å›æŠ¥ç‡æ˜¯10%ï¼Œå¹´å‡å›æŠ¥ç‡æ˜¯5%ã€‚</p>
<p>é‚£ä¹ˆç©¶ç«Ÿå“ªä¸ªé¡¹ç›®å¥½ä¸€ç‚¹å‘¢ï¼Ÿæˆ‘æƒ³å¤§å¤šæ•°äººåº”è¯¥éƒ½ä¼šé€‰æ‹©é¡¹ç›®Aï¼Œå› ä¸ºå¦‚æœæˆ‘ä»¬æ‹¿é¡¹ç›®ç¬¬ä¸€å¹´çš„å›æ¬¾è¿›è¡Œå†æŠ•èµ„æ—¶é¡¹ç›®Aæ˜æ˜¾æ›´å¤šä¸€äº›ã€‚è¿™å°±æ˜¯è€ƒè™‘åˆ°äº†ç°é‡‘çš„æ—¶é—´ä»·å€¼ã€‚</p>
<p>æˆ‘ä»¬å†æ¥è®¡ç®—ä¸€ä¸‹NPVï¼Œå‡è®¾æŠ˜ç°ç‡ä¸º5%ã€‚</p>
<p>é¡¹ç›®Açš„NPV = 80 / (1 + 5% ) + 30 / (1 + 5%)Â² - 100 = 103.40 - 100 = 3.40</p>
<p>é¡¹ç›®Bçš„NPV = 4 / (1 + 5% ) + 106 / (1 + 5%)Â² - 100 = 99.95 - 100 = -0.05</p>
<p>åœ¨è€ƒè™‘åˆ°ç°é‡‘æ—¶é—´ä»·å€¼çš„æƒ…å†µä¸‹ï¼ŒæŠ•èµ„Aé¡¹ç›®å®é™…èƒ½å¤šèµš3.40å…ƒï¼ŒæŠ•èµ„Bé¡¹ç›®è¦å°‘èµš0.05å…ƒã€‚</p>
<h4 id="IRR"><a href="#IRR" class="headerlink" title="IRR"></a>IRR</h4><p>å†…éƒ¨æ”¶ç›Šç‡ï¼ˆInternal Rate of Returnï¼ŒIRRï¼‰å°±æ˜¯èµ„é‡‘æµå…¥ç°å€¼æ€»é¢ä¸èµ„é‡‘æµå‡ºç°å€¼æ€»é¢ç›¸ç­‰ï¼Œå³ä½¿å¾—NPVç­‰äº0æ—¶çš„é‚£ä¸ªæŠ˜ç°ç‡ã€‚</p>
<p>ä¸Šé¢è®¡ç®—NPVæ—¶æˆ‘ä»¬éƒ½å‡è®¾äº†ä¸€ä¸ªæŠ˜ç°ç‡ï¼Œä½†ç°å®åº”ç”¨ä¸­é€šå¸¸æ˜¯å·²çŸ¥å‡€ç°é‡‘æµå’Œæœ¬é‡‘è®¡ç®—æŠ˜ç°ç‡ï¼ˆæœ€å¸¸è§çš„å°±æ˜¯å•†å®¶çš„åˆ†æœŸå¥—è·¯ï¼‰ã€‚</p>
<p>è¿˜æ˜¯ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬è®¡ç®—ä¸€ä¸‹å„é¡¹ç›®çš„IRRã€‚</p>
<p>é¡¹ç›®Aï¼š</p>
<p>80 / (1 + x ) + 30 / (1 + x)Â² - 100 = 0</p>
<p>x = 0.07823ï¼Œå³IRR = 7.82%</p>
<p>é¡¹ç›®B: </p>
<p>4 / (1 + x ) + 106 / (1 + x)Â² - 100 = 0</p>
<p>x = 0.04976ï¼Œå³IRR = 4.98%</p>
<p>é€šè¿‡è®¡ç®—å¾—å‡ºï¼Œé¡¹ç›®Açš„IRRä¸º7.82%ï¼Œé¡¹ç›®Bçš„IRRä¸º4.98%ï¼Œäºæ˜¯æˆ‘ä»¬å‘ç°ï¼ŒæŒ‰ç…§ROIè®¡ç®—å‡ºçš„5%å¹¶ä¸å®Œå…¨é è°±ï¼ŒAé¡¹ç›®ç¡®å®è¦ä¼˜äºBé¡¹ç›®ã€‚</p>
<p>ç”±æ­¤å¯ä»¥çœ‹å‡ºIRRè€ƒè™‘äº†è´§å¸æ—¶é—´ä»·å€¼çš„æ”¶ç›Šç‡ï¼Œæ˜¯ç»¼åˆè€ƒè™‘äº†æ¯æœŸçš„æµå…¥æµå‡ºç°é‡‘çš„é‡å’Œæ—¶é—´ï¼ŒåŠ æƒå‡ºæ¥çš„ç»“æœã€‚</p>
<p>ä¸éš¾çœ‹å‡ºIRRçš„è®¡ç®—è¿˜æ˜¯æŒºå¤æ‚çš„ï¼Œä¸Šè¿°çš„ä¾‹å­è¿˜åªæ˜¯ä¸¤æœŸçš„ç°é‡‘æµï¼Œå¦‚æœæ˜¯3æœŸï¼Œ6æœŸæˆ–è€…12æœŸé‚£ä¹ˆæ‰‹å·¥è®¡ç®—å‡ ä¹ä¸å¤ªå¯èƒ½ï¼Œè¿™ä¸ªæ—¶å€™ä½¿ç”¨Excelçš„IRRè®¡ç®—å…¬å¼å°±å¯ä»¥è½»æ¾æå®šã€‚</p>
<h4 id="Numbersçš„IRRè®¡ç®—å™¨"><a href="#Numbersçš„IRRè®¡ç®—å™¨" class="headerlink" title="Numbersçš„IRRè®¡ç®—å™¨"></a>Numbersçš„IRRè®¡ç®—å™¨</h4><p>æˆ‘è¿™é‡Œæ˜¯Macç”µè„‘æ‰€ä»¥ä½¿ç”¨çš„æ˜¯Numbersè½¯ä»¶å¯¹åº”çš„PCç”µè„‘å°±æ˜¯Excelè½¯ä»¶ã€‚</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/IRRè®¡ç®—.jpg" style="zoom:50%;" /></p>
<p>è¾“å…¥ï¼šIRR(C32:C34)ï¼Œå¦‚ä¸‹ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/IRRè®¡ç®—æ­¥éª¤.jpg" style="zoom:50%;" /></p>
<p>ä½¿ç”¨åˆ°çš„å‡½æ•°ï¼š<strong>IRR</strong>(<em>ç°é‡‘æµèŒƒå›´, ä¼°è®¡</em>)</p>
<p>ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºç°é‡‘æµèŒƒå›´ï¼šåŒ…å«ç°é‡‘æµå€¼çš„é›†åˆã€‚ ç°é‡‘æµèŒƒå›´å¿…é¡»åŒ…å«æ•°å­—å€¼ã€‚æ”¶å…¥ï¼ˆç°é‡‘æµå…¥é‡ï¼‰æŒ‡å®šä¸ºæ­£æ•°ï¼Œè€Œæ”¯å‡ºï¼ˆç°é‡‘æµå‡ºé‡ï¼‰æŒ‡å®šä¸ºè´Ÿæ•°ã€‚é›†åˆä¸­å¿…é¡»è‡³å°‘åŒ…æ‹¬ä¸€ä¸ªæ­£å€¼å’Œä¸€ä¸ªè´Ÿå€¼ã€‚ç°é‡‘æµé‡å¿…é¡»æŒ‰æ—¶é—´é¡ºåºæŒ‡å®šï¼Œä¸”åœ¨æ—¶é—´ä¸Šç­‰è·ï¼ˆå¦‚æ¯æœˆï¼‰ã€‚å¦‚æœæŸä¸ªæœŸé—´æ²¡æœ‰ç°é‡‘æµé‡ï¼Œåˆ™è¯¥æœŸé—´ä½¿ç”¨ 0ã€‚</p>
<p>-100è¡¨ç¤ºæ˜¯æŠ•å…¥æ‰€ä»¥æ˜¯è´Ÿæ•°ã€‚</p>
<p>ç¬¬äºŒä¸ªå‚æ•°æ˜¯å¯é€‰çš„ã€‚æ‰€ä»¥è¿™é‡Œå°±ä¸å¡«äº†ã€‚</p>
<p>å­¦ä¼šäº†è®¡ç®—IRRï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¡ç®—å„ä¸ªå•†å®¶ç»™å‡ºçš„åˆ†æœŸç­–ç•¥çš„å®é™…å¹´åŒ–æ”¶ç›Šç‡äº†ï¼Œç»å¯¹ä¼šè®©ä½ æ„Ÿå¹ä¸€å¥ç¤¾ä¼šï¼Œç¤¾ä¼šï¼ç›¸ä¿¡ä½ å†ä¹Ÿä¸ä¼šè¢«å•†å®¶çš„åˆ†æœŸå¥—è·¯äº†ã€‚</p>
<p><strong>å…¶ä»–</strong></p>
<p>å•åˆ©ï¼š</p>
<p>å³åˆ©æ¯ä¸ä½œä¸ºä¸‹ä¸€æ¬¡çš„æŠ•èµ„ã€‚</p>
<p><code>åˆ°æœŸæ€»æ”¶ç›Š = æœ¬é‡‘ * (1 + æ”¶ç›Šç‡ * n)</code></p>
<p>å¤åˆ©ï¼š</p>
<p>å³åˆ©æ¯å†æŠ•èµ„ã€‚</p>
<p><code>åˆ°æœŸæ€»æ”¶ç›Š = æœ¬é‡‘ * (1 + æ”¶ç›Šç‡)^n</code></p>
<p>eg:</p>
<p>æœ¬é‡‘10000ï¼Œå¹´åˆ©ç‡10%ï¼Œåˆ†åˆ«è®¡ç®—å•åˆ©å’Œå¤åˆ©åˆ°æœŸåè·å¾—çš„æ€»æ”¶ç›Š</p>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th>æœ¬é‡‘</th>
<th>1å¹´</th>
<th>2å¹´</th>
<th>3å¹´</th>
<th>4å¹´</th>
<th>5å¹´</th>
</tr>
</thead>
<tbody>
<tr>
<td>å•åˆ©</td>
<td>10000</td>
<td>11000</td>
<td>12000</td>
<td>13000</td>
<td>14000</td>
<td>15000</td>
</tr>
<tr>
<td>å¤åˆ©</td>
<td>10000</td>
<td>11000</td>
<td>12100</td>
<td>13310</td>
<td>14641</td>
<td>16105</td>
</tr>
</tbody>
</table>
</div>
<p>æ„Ÿè§‰5å¹´ä¹Ÿå·®åˆ«ä¸æ˜¯å¾ˆå¤§ï¼Œä½†æ˜¯20å¹´å¤åˆ©å°±æ˜¯67275ï¼Œå•åˆ©å´åªæœ‰30000ï¼Œå·²ç»å·®äº†2å€å¤šäº†ã€‚å•åˆ©æ˜¯çº¿æ€§å¢é•¿çš„ï¼Œä½†å¤åˆ©å´æ˜¯æŒ‡æ•°å¢é•¿çš„ï¼Œè¶Šå¾€åç›¸å·®è¶Šå¤§ã€‚æ‰€ä»¥ä¸è¦å°çœ‹å¤åˆ©çš„æ•ˆæœã€‚</p>
]]></content>
      <categories>
        <category>ç»æµå­¦</category>
      </categories>
  </entry>
  <entry>
    <title>æ”¯ä»˜å®èŠ±å‘—ä¸å€Ÿå‘—èƒŒåçš„åˆ©ç‡</title>
    <url>/2020/04/06/%E6%94%AF%E4%BB%98%E5%AE%9D%E8%8A%B1%E5%91%97%E4%B8%8E%E5%80%9F%E5%91%97%E8%83%8C%E5%90%8E%E7%9A%84%E5%88%A9%E7%8E%87/</url>
    <content><![CDATA[<p>æœ¬æ–‡ä¸»è¦åˆ†ææ”¯ä»˜å®é‡Œçš„èŠ±å‘—ï¼Œå€Ÿå‘—ï¼Œå¤‡ç”¨é‡‘èƒŒåçš„å¹´åŒ–æ”¶ç›Šç‡ã€‚</p>
<p>åœ¨ä½¿ç”¨æ”¯ä»˜å®èŠ±å‘—çš„æ—¶å€™ï¼Œè¿˜æ¬¾é¡µé¢é™¤äº†æ­£å¸¸è¿˜æ¬¾å¤–è¿˜æœ‰ä¸€äº›ä»€ä¹ˆè´¦å•åˆ†æœŸã€æœ€ä½è¿˜æ¬¾ã€å»¶æœŸè¿˜æ¬¾ä¹‹ç±»çƒ‚ä¸ƒå…«ç³Ÿçš„ä¸œè¥¿ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/DBCA822F-CA14-4D45-BA99-5592A7D39D4A.png" style="zoom:50%;" /></p>
<p>ä¼¼ä¹æ˜¯åœ¨æ›¿ç”¨æˆ·ç€æƒ³ï¼Œä½†çœŸå®æƒ…å†µæ˜¯ä¸æ˜¯å¦‚æ­¤å‘¢ï¼Ÿä¸‹é¢å°†ä»”ç»†åˆ†æä¸€ä¸‹èŠ±å‘—åˆ†æœŸçš„çœŸå®å¹´åˆ©ç‡ã€‚</p>
<h4 id="è´¦å•åˆ†æœŸ"><a href="#è´¦å•åˆ†æœŸ" class="headerlink" title="è´¦å•åˆ†æœŸ"></a>è´¦å•åˆ†æœŸ</h4><p>èŠ±å‘—åˆ†æœŸæ•°ä¸æ‰‹ç»­è´¹ç‡å¦‚ä¸‹ï¼š</p>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th>èŠ±å‘—</th>
</tr>
</thead>
<tbody>
<tr>
<td>3æœŸ</td>
<td>2.50%</td>
</tr>
<tr>
<td>6æœŸ</td>
<td>4.50%</td>
</tr>
<tr>
<td>9æœŸ</td>
<td>6.50%</td>
</tr>
<tr>
<td>12æœŸ</td>
<td>8.80%</td>
</tr>
</tbody>
</table>
</div>
<p>æ¯æœŸæ‰‹ç»­è´¹ = åˆ†æœŸé‡‘é¢ / åˆ†æœŸæœŸæ•° * æ‰‹ç»­è´¹ç‡</p>
<p>æ¯æœŸè¿˜æ¬¾æ•° = åˆ†æœŸé‡‘é¢ / åˆ†æœŸæœŸæ•° + æ¯æœŸæ‰‹ç»­è´¹ = æ¯æœŸæ‰‹ç»­è´¹ * (1 + æ‰‹ç»­è´¹ç‡ ) / æ‰‹ç»­è´¹ç‡</p>
<p>æ€»æ‰‹ç»­è´¹ = åˆ†æœŸé‡‘é¢ * æ‰‹ç»­è´¹ç‡</p>
<p>ä»¥12æœŸä¸ºä¾‹ï¼Œåˆ†æœŸé‡‘é¢1244.55å…ƒï¼š</p>
<p>æ¯æœŸæ‰‹ç»­è´¹ = 1244.55  / 12 * 8.8% = 9.1267 â‰ˆ 9.13</p>
<p>æ¯æœŸè¿˜æ¬¾æ•° = 1244.55 / 12 + 9.13 = 112.8425 â‰ˆ 112.84</p>
<p>æ€»æ‰‹ç»­è´¹ = 1244.55 * 8.8% â‰ˆ 109.52</p>
<p>æ¯æœŸæœ¬é‡‘ = 1244.55 / 12 = 103.7125 â‰ˆ 103.71</p>
<p>èŠ±å‘—çš„12æœŸåˆ†æœŸï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/èŠ±å‘—åˆ†æœŸ.jpg" style="zoom:50%;" /></p>
<p>å‘ç°æ”¯ä»˜å®ç¬¬ä¸€æœŸå±…ç„¶æ˜¯112.87ï¼Œå…¶ä»–æœŸéƒ½æ˜¯112.84ï¼Œç¬¬ä¸€æœŸå¤šå‡ºçš„0.03å…ƒæ€ä¹ˆæ¥çš„å‘¢</p>
<p>äº‹å®å°±æ˜¯(112.8425 - 112.84 ) <em> 12 = 0.0025 </em> 12 = 0.03ï¼Œçœ‹æ¥è¢«å®‰æ’çš„æ˜æ˜ç™½ç™½ã€‚</p>
<p>1244.55å…ƒä¸€å¹´æ€»æ‰‹ç»­è´¹ = 1244.55 * 8.80% = 109.5204 â‰ˆ 109.52ã€‚</p>
<p>ç«™åœ¨èŠ±å‘—çš„è§’åº¦è²Œä¼¼å€Ÿæˆ‘1244.55å…ƒä¸€å¹´å¾—åˆ°åˆ©æ¯109.52å…ƒï¼Œå¹´åˆ©ç‡ = 109.52 / 1244.55 = 8.80% = æ‰‹ç»­è´¹ç‡ã€‚è¿™æ ·çœ‹æ¥èŠ±å‘—çš„å¹´åˆ©ç‡8.80%ä¼¼ä¹å¹¶ä¸å¤ªé«˜ã€‚</p>
<p>ä½†å®é™…æƒ…å†µå¹¶ä¸æ˜¯è¿™æ ·ï¼Œå› ä¸ºè¿™1244.55å…ƒä½ å¹¶æ²¡æœ‰çœŸæ­£ä½¿ç”¨ä¸€æ•´å¹´ï¼Œäº‹å®æ˜¯1244.55å…ƒä½ åªå æœ‰äº†ä¸€ä¸ªæœˆï¼ŒçœŸæ­£å æœ‰äº†ä¸€å¹´çš„æ˜¯æœ€åä¸€æœŸçš„103.71å…ƒã€‚éšç€æ¯ä¸€æœŸçš„è¿˜æ¬¾ï¼Œæ¬ æ¬¾ä¼šè¶Šæ¥è¶Šå°‘ä½†æ¯æœŸçš„æ‰‹ç»­è´¹å´è¿˜æ˜¯ä»¥æœ€åˆçš„åˆ†æœŸé‡‘é¢è®¡ç®—çš„ã€‚</p>
<p>å› æ­¤è¦æƒ³çŸ¥é“èŠ±å‘—åˆ†æœŸçš„çœŸå®å¹´åˆ©ç‡ï¼Œå°±éœ€è¦è®¡ç®—å®ƒçš„IRRï¼ˆå†…éƒ¨æ”¶ç›Šç‡ï¼‰å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20200406154713.png" style="zoom:50%;" /></p>
<p>å¯ä»¥çœ‹åˆ°èŠ±å‘—åˆ†æœŸ3æœŸå¹´åˆ©ç‡ä¸º14.95%ï¼Œ6æœŸå¹´åˆ©ç‡ä¸º15.26%ï¼Œ9æœŸå¹´åˆ©ç‡ä¸º15.34%ï¼Œ12æœŸå¹´åˆ©ç‡ä¸º15.87%ï¼Œè¿™ä¸ªæ”¶ç›Šç‡ä¼°è®¡å¤§å¤šæ•°äººéƒ½è¾¾ä¸åˆ°ï¼Œæˆ‘è‡ªå·±4%ï¼ˆ3.17%ï¼‰éƒ½ä¸åˆ°ï¼Œæ‰€ä»¥æœ€å¥½ä¸è¦ä½¿ç”¨ä»€ä¹ˆåˆ†æœŸæ”¯ä»˜ï¼Œè¿™åªä¼šæ…¢æ…¢ä¾µèš€æ‰ä½ çš„è´¢å¯Œã€‚</p>
<p>å†æ¥çœ‹ä¸€ä¸‹å»¶æœŸè¿˜æ¬¾</p>
<h4 id="å»¶æœŸè¿˜æ¬¾"><a href="#å»¶æœŸè¿˜æ¬¾" class="headerlink" title="å»¶æœŸè¿˜æ¬¾"></a>å»¶æœŸè¿˜æ¬¾</h4><p>å»¶æœŸè¿˜æ¬¾å°±æ˜¯å»¶æœŸåˆ°ä¸‹ä¸ªæœˆå†è¿˜ï¼Œæ”¯ä»˜å®æ”¶å–ä¸€å®šçš„æ‰‹ç»­è´¹ã€‚</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/8BED5EEF-7720-4D2F-A633-CCE525989358.png" style="zoom:50%;" /></p>
<p>å¯ä»¥è®¡ç®—ä¸€ä¸‹å®ƒçš„å¹´åŒ–æ”¶ç›Šç‡ï¼š20 / 1244.55 <em> 12 </em> 100% = 19.28%ï¼Œè™½ç„¶çœ‹ä¸Šå»åªæœ‰20å…ƒçš„æ‰‹ç»­è´¹ä½†å¯¹åº”åˆ°å¹´åŒ–æ”¶ç›Šç‡å°±æ˜¯19.28%å·²ç»è¶…è¿‡åˆ†æœŸæ”¯ä»˜äº†ï¼Œä½ è‡ªå·±æ‹¿1244.55å»æŠ•èµ„ä¸€ä¸ªæœˆåŸºæœ¬ä¸Šä¸å¯èƒ½å¾—åˆ°20å…ƒçš„æ”¶ç›Šï¼Œæƒ³ä¸€æƒ³ä½™é¢å®é‡Œçš„ä¸ƒæ—¥å¹´åŒ–æ‰1.89%ï¼Œ1ä¸‡å—é’±ä¸€ä¸ªæœˆä¹Ÿåªæœ‰15.5å…ƒçš„æ”¶ç›Šï¼Œæ‰€ä»¥ä¸è¦è¢«è¡¨é¢çš„æ•°å­—è¿·æƒ‘ã€‚</p>
<h4 id="æœ€ä½è¿˜æ¬¾"><a href="#æœ€ä½è¿˜æ¬¾" class="headerlink" title="æœ€ä½è¿˜æ¬¾"></a>æœ€ä½è¿˜æ¬¾</h4><p>æœ€ä½è¿˜æ¬¾è¯´æ˜æ˜¯è¿™æ ·çš„ï¼šå‰©ä½™xxxå…ƒä¸‹æœŸè¿˜ï¼Œæ—¥åˆ©ç‡0.05%è®¡æ¯ï¼Œå¯æå‰è¿˜æ¬¾ã€‚</p>
<p>è®¡ç®—ä¸€ä¸‹å®ƒçš„å¹´åŒ–æ”¶ç›Šç‡ï¼š0.05% <em> 12 </em> 100% = 18.25%ï¼Œåªæ¯”å»¶æœŸè¿˜æ¬¾ä½äº†ä¸€ç‚¹ç‚¹ã€‚</p>
<p>å°è®°ï¼šå¯¹äºèŠ±å‘—å°½é‡åœ¨è¿˜æ¬¾æ—¥å‰ä¸€æ¬¡æ€§è¿˜å®Œï¼Œè¿™æ ·ä½¿ç”¨èŠ±å‘—è¿˜æ˜¯ä¸é”™çš„ã€‚</p>
<h4 id="å€Ÿå‘—"><a href="#å€Ÿå‘—" class="headerlink" title="å€Ÿå‘—"></a>å€Ÿå‘—</h4><p>å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20200406163840.png" style="zoom:50%;" /></p>
<p>æ—¥åˆ©ç‡ä¸‡3ï¼ˆ1åƒå…ƒç”¨1å¤©åªéœ€0.3å…ƒï¼‰ï¼Œå…¶å®åé¢é‚£å¥â€œ1åƒå…ƒç”¨1å¤©åªéœ€0.3å…ƒâ€åªæ˜¯ç”¨æ¥è¿·æƒ‘ä½ çš„ï¼Œè®©ä½ è§‰å¾—ä¸€å¤©çš„åˆ©æ¯å¾ˆä½å•Šï¼Œä½†å‡¡äº‹éƒ½å¾—åŠ¨åŠ¨è„‘å­ã€‚è®¡ç®—ä¸€ä¸‹å®ƒçš„å¹´åŒ–æ”¶ç›Šç‡ï¼š3.65% * 3 = 10.95%ï¼Œå·®ä¸å¤š11ä¸ªç‚¹ï¼ŒåŸºæœ¬ä¸Šè¿˜ç®—å¯ä»¥ã€‚å¦‚æœä½ çš„æŠ•èµ„å¹´åŒ–æ”¶ç›Šç‡èƒ½å¤Ÿæœ‰20%ï¼Œé‚£ä¹ˆå€Ÿå‘—å°±æ˜¯ä½ çš„å•†æœºã€‚</p>
<h4 id="å¤‡ç”¨é‡‘"><a href="#å¤‡ç”¨é‡‘" class="headerlink" title="å¤‡ç”¨é‡‘"></a>å¤‡ç”¨é‡‘</h4><p>å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20200406164954.png" style="zoom:50%;" /></p>
<p>ç”¨7å¤©ï¼Œæ¨å¹¿ä»·1.99å…ƒï¼ˆåŸä»·2.29å…ƒï¼‰</p>
<p>è®¡ç®—ä¸€ä¸‹å®ƒçš„å¹´åŒ–æ”¶ç›Šç‡ï¼š</p>
<p>æ¨å¹¿ä»·çš„å¹´åŒ–æ”¶ç›Šç‡ï¼š1.99 / 7 / 500 <em> 365 </em> 100% = 20.75%</p>
<p>åŸä»·çš„å¹´åŒ–æ”¶ç›Šç‡ï¼š2.29 / 7 / 500 <em> 365 </em> 100% = 23.88%</p>
<p>å¹´åŒ–æ”¶ç›Šç‡23.88%ä»€ä¹ˆæ¦‚å¿µï¼Ÿ</p>
<p>å…ˆæ¥çœ‹ä¸€ä¸‹æ³•å¾‹å¯¹äºé«˜åˆ©è´·çš„å®šä¹‰ï¼š</p>
<p><strong>é«˜åˆ©è´·å®šä¹‰ï¼š</strong></p>
<p>å€Ÿè´·åŒæ–¹çº¦å®šçš„åˆ©ç‡ä¸å¾—è¶…è¿‡ä¸­å›½äººæ°‘é“¶è¡Œå…¬å¸ƒçš„é‡‘èæœºæ„åŒæœŸã€åŒæ¡£æ¬¡è´·æ¬¾åˆ©ç‡(ä¸å«æµ®åŠ¨)çš„4å€ã€‚è¶…è¿‡ä¸Šè¿°æ ‡å‡†çš„ï¼Œåº”ç•Œå®šä¸ºé«˜åˆ©å€Ÿè´·è¡Œä¸ºã€‚</p>
<p><strong>æ³•å¾‹è§„å®šï¼š</strong></p>
<p>1ã€å¯¹äºå¹´åˆ©ç‡åœ¨ç™¾åˆ†ä¹‹äºŒåå››åŠå…¶ä»¥ä¸‹çš„æ°‘é—´å€Ÿè´·åˆ©æ¯å±äºâ€œå¸æ³•ä¿æŠ¤åŒºâ€ï¼Œæ³•é™¢åº”å½“äºˆä»¥ä¿æŠ¤;</p>
<p>2ã€å¯¹äºå¹´åˆ©ç‡åœ¨ç™¾åˆ†ä¹‹äºŒåå››åˆ°ç™¾åˆ†ä¹‹ä¸‰åå…­ä¹‹é—´çš„éƒ¨åˆ†å±äºâ€œè‡ªç„¶ä¿æŠ¤åŒºâ€ï¼Œå¦‚æœå€Ÿæ¬¾äººå·²ç»å¿è¿˜ï¼Œæ³•é™¢ä¹Ÿä¸ä¼šåˆ¤å†³ä»–è®¨å›è¿™éƒ¨åˆ†åˆ©æ¯;</p>
<p>3ã€å¯¹äºå¹´åˆ©ç‡è¶…è¿‡ç™¾åˆ†ä¹‹ä¸‰åå…­çš„æ°‘é—´å€Ÿè´·åˆ©æ¯ï¼Œå…¶è¶…å‡ºéƒ¨åˆ†å±äºâ€œæ— æ•ˆåŒºâ€ï¼Œæ³•é™¢å°†å¯¹è¶…å‡ºéƒ¨åˆ†çš„çº¦å®šè®¤å®šä¸ºæ— æ•ˆï¼Œå³ä¾¿å€ºåŠ¡äººå·²ç»å¿è¿˜äº¦å¯è¯·æ±‚å€ºæƒäººäºˆä»¥è¿”è¿˜ï¼Œæƒ…èŠ‚ä¸¥é‡çš„ï¼Œå¯ä»¥å¤„ä»¥ä¸€å®šçš„ç½šæ¬¾ã€‚</p>
<p>ä½ ä»¥ä¸ºçš„ç”¨7å¤©æ‰2.29å…ƒå…¶å®å·²ç»å¡åœ¨é«˜åˆ©è´·çš„è¾¹ç¼˜äº†ï¼Œæ‰€ä»¥æ²¡äº‹å°±ä¸è¦ç”¨å¤‡ç”¨é‡‘ã€‚é™¤éä½ å®åœ¨å€Ÿä¸åˆ°é’±äº†ã€‚</p>
<p>åˆ°æ­¤ä¸ºæ­¢æ”¯ä»˜å®é‡Œé¢çš„å„ç§èŠ±æ‹›éƒ½åˆ†æå®Œäº†ï¼Œäº†è§£ä¸€ç‚¹ç»æµå­¦è¿˜æ˜¯æœ‰ç”¨çš„ï¼Œè‡³å°‘è®©ä½ æ˜ç™½å…è´¹çš„åˆé¤æ˜¯æ²¡æœ‰çš„ï¼Œä¸è¦è¢«è¡¨é¢çš„ç°è±¡è¿·æƒ‘ï¼Œå¤šåŠ¨è„‘åˆ†æï¼Œå¯ä»¥å°‘èµ°å¾ˆå¤šå¥—è·¯ã€‚</p>
]]></content>
      <categories>
        <category>ç»æµå­¦</category>
      </categories>
  </entry>
  <entry>
    <title>å­ç±»åŒåçˆ¶ç±»ç§æœ‰å±æ€§å’Œæ–¹æ³•</title>
    <url>/2020/03/23/%E5%AD%90%E7%B1%BB%E5%90%8C%E5%90%8D%E7%88%B6%E7%B1%BB%E7%A7%81%E6%9C%89%E5%B1%9E%E6%80%A7%E5%92%8C%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<p>å¯¹äºç§æœ‰å±æ€§å’Œæ–¹æ³•ï¼Œå­ç±»å’Œçˆ¶ç±»åŒååŸºæœ¬ä¸Šæ²¡æœ‰ä»€ä¹ˆå½±å“.ä½†æ˜¯æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼š</p>
<p>å¦‚æœæ˜¯å±æ€§åŒåï¼Œå­ç±»å’Œçˆ¶ç±»ä¼šæ‹¥æœ‰å„è‡ªç‹¬ç«‹çš„å®ä¾‹å˜é‡ã€‚</p>
<p>å¦‚æœæ˜¯æ–¹æ³•åŒåï¼ŒæŒ‰ç…§æ¶ˆæ¯å‘é€çš„è¿‡ç¨‹ï¼Œæ‰§è¡Œçš„è‡ªç„¶æ˜¯å­ç±»ä¸­çš„æ–¹æ³•ã€‚</p>
<p>ä¸¾ä¸ªæ —å­ï¼š</p>
<p>çˆ¶ç±»ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Animal</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> age;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithName:(<span class="built_in">NSString</span> *)name age:(<span class="built_in">NSInteger</span>)age;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)hello;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Animal</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *hobbit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Animal</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithName:(<span class="built_in">NSString</span> *)name age:(<span class="built_in">NSInteger</span>)age &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="variable language_">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _name = name;</span><br><span class="line">        _age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)hello &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;çˆ¶ç±»æ–¹æ³•ï¼Œ%@  %ld %@&quot;</span>, _name, (<span class="type">long</span>)_age, <span class="keyword">self</span>.hobbit);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)run &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;çˆ¶ç±»æ–¹æ³•run&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)hobbit &#123;</span><br><span class="line">    <span class="keyword">if</span> (_hobbit == <span class="literal">nil</span>) &#123;</span><br><span class="line">        _hobbit = <span class="string">@&quot;unknown&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _hobbit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>å­ç±»ï¼š</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">Person </span>: Animal</span><br><span class="line"></span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@interface</span> Person ()</span><br><span class="line"></span><br><span class="line"><span class="variable">@property</span> (nonatomic, copy) NSString *hobbit;</span><br><span class="line"></span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@implementation</span> Person</span><br><span class="line"></span><br><span class="line">- (void)hello &#123;</span><br><span class="line">    <span class="selector-attr">[super hello]</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="selector-tag">NSLog</span>(@<span class="string">&quot;å­ç±»æ–¹æ³•ï¼Œ%@ %ld %@&quot;</span>, self.name, (long)self.age, self.hobbit);</span><br><span class="line">    </span><br><span class="line">    <span class="selector-attr">[self performSelector:@selector(run)]</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="selector-tag">end</span></span><br></pre></td></tr></table></figure>
<p>å±æ€§åŒåï¼Œæ‹¥æœ‰å„è‡ªç‹¬ç«‹çš„å®ä¾‹å˜é‡ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/%E5%90%8C%E5%90%8D%E5%B1%9E%E6%80%A7.jpg" style="zoom:50%;" /></p>
<p>æ–¹æ³•åŒåï¼š</p>
<p>ä¸‹é¢ä»£ç ä¼šæ‰“å°ä»€ä¹ˆï¼Ÿ</p>
<figure class="highlight inform7"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Person</span> *p = <span class="comment">[<span class="comment">[Person alloc]</span> initWithName:@&quot;mattt&quot; age:3]</span>;</span><br><span class="line"><span class="comment">[p hello]</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Animal</span> *ani = <span class="comment">[<span class="comment">[Animal alloc]</span> initWithName:@&quot;sun&quot; age:3]</span>;</span><br><span class="line"><span class="comment">[ani hello]</span>;</span><br></pre></td></tr></table></figure>
<p>æ‰“å°ï¼š</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">2020</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">13</span>.<span class="number">648428</span>+<span class="number">0800</span> çˆ¶å­ç±»å±æ€§åŒå[<span class="number">47652</span>:<span class="number">6589153</span>] çˆ¶ç±»æ–¹æ³•ï¼Œmattt  <span class="number">3</span> (null)</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">13</span>.<span class="number">648780</span>+<span class="number">0800</span> çˆ¶å­ç±»å±æ€§åŒå[<span class="number">47652</span>:<span class="number">6589153</span>] å­ç±»æ–¹æ³•ï¼Œmattt <span class="number">3</span> (null)</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">13</span>.<span class="number">648815</span>+<span class="number">0800</span> çˆ¶å­ç±»å±æ€§åŒå[<span class="number">47652</span>:<span class="number">6589153</span>] çˆ¶ç±»æ–¹æ³•run</span><br><span class="line"><span class="attribute">2020</span>-<span class="number">03</span>-<span class="number">23</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">13</span>.<span class="number">648853</span>+<span class="number">0800</span> çˆ¶å­ç±»å±æ€§åŒå[<span class="number">47652</span>:<span class="number">6589153</span>] çˆ¶ç±»æ–¹æ³•ï¼Œsun  <span class="number">3</span> unknown</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°çˆ¶ç±»çš„hobbitå±æ€§æ˜¯å®ç°äº†æ‡’åŠ è½½çš„ï¼Œä½†å­ç±»æ‰§è¡Œåˆ°çˆ¶ç±»helloæ–¹æ³•é‡Œçš„self.hobbitæ—¶å¹¶æ²¡æœ‰æ‰§è¡Œæ‡’åŠ è½½ä»£ç ï¼Œæ‰“å°ä¾ç„¶ä¸ºnullã€‚è¿™æ˜¯å› ä¸ºæ‰§è¡Œself.hobbitæ—¶ï¼Œæ‰§è¡Œçš„æ˜¯å­ç±»è‡ªå·±çš„getter/setteræ–¹æ³•ã€‚</p>
<p>ä¹‹æ‰€ä»¥å†™è¿™ä¸ªï¼Œæ˜¯å› ä¸ºåœ¨é‡æ„çš„æ—¶å€™å‘ç°ä¸Šé¢çš„æ‡’åŠ è½½ä»£ç æ€ä¹ˆæ­»æ´»éƒ½ä¸æ‰§è¡Œã€‚</p>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
  </entry>
  <entry>
    <title>Swift æ•°æ®æ¨¡å‹è½¬æ¢æ¡†æ¶æ¯”è¾ƒ</title>
    <url>/2020/03/08/Swift%20%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E8%BD%AC%E6%8D%A2%E6%A1%86%E6%9E%B6%E6%AF%94%E8%BE%83/</url>
    <content><![CDATA[<p>Xcode11.3.1,Swift5ç¯å¢ƒ.</p>
<p>åœ¨Appå¼€å‘ä¸­ç»å¸¸éœ€è¦å°†æœåŠ¡ç«¯è¿”å›çš„JSONæ•°æ®è½¬åŒ–ä¸ºæ¨¡å‹ä½¿ç”¨,é€‰æ‹©ä¸€ä¸ªå¥½çš„æ•°æ®æ¨¡å‹è½¬æ¢æ¡†æ¶æœ‰åŠ©äºæé«˜å¼€å‘ä½“éªŒä»¥åŠå‡å°‘è½¬æ¢è¿‡ç¨‹ä¸­çš„é”™è¯¯.</p>
<p>æˆ‘ä»¬å¸Œæœ›æ¡†æ¶æ”¯æŒçº¯Swiftç±»,ç»“æ„ä½“,OCç±»,å› æ­¤YYModelå’ŒMJExtensionç­‰ä¸€ç³»åˆ—ä¼˜ç§€çš„OCæ•°æ®æ¨¡å‹è½¬æ¢æ¡†æ¶æ˜¯ä¸æ»¡è¶³è¦æ±‚çš„,å› ä¸ºå®ƒä»¬éƒ½éœ€è¦æ¨¡å‹ç»§æ‰¿è‡ªNSObject.</p>
<p>ç›®å‰ä½¿ç”¨è¾ƒå¤šçš„æ•°æ®æ¨¡å‹è½¬æ¢æ¡†æ¶æœ‰:</p>
<ol>
<li>ç³»ç»Ÿè‡ªå¸¦çš„åŸºäºCodableçš„JSONDecoder/JSONEncoder.</li>
<li>HandyJSON</li>
<li>ObjectMapper</li>
</ol>
<p>ä¸‹é¢ç®€å•ä»‹ç»ä¸€ä¸‹å„æ¡†æ¶çš„ä½¿ç”¨,å¹¶ä»æ¡†æ¶çš„ä½¿ç”¨ä¾¿æ·æ€§å’Œæ•°æ®å®¹é”™æ€§ä¸Šè¿›è¡Œä¸€ä¸ªæ¯”è¾ƒ.</p>
<h3 id="JSONDecoder-JSONEncoder"><a href="#JSONDecoder-JSONEncoder" class="headerlink" title="JSONDecoder/JSONEncoder"></a>JSONDecoder/JSONEncoder</h3><p>ä»‹ç»JSONDecoderä¹‹å‰,å…ˆæ¥çœ‹ä¸‹Codableæ˜¯ä»€ä¹ˆ.</p>
<p>Codableæ˜¯Swift 4.0å¼€å§‹å¼•å…¥çš„æ–°ç‰¹æ€§.Codableå®šä¹‰:<code>public typealias Codable = Decodable &amp; Encodable</code>,å¯ä»¥çœ‹åˆ°Codableæ˜¯ä¸€ä¸ªç±»å‹åˆ«å,ä»£è¡¨åŒæ—¶éµå®ˆDecodableå’ŒEncodableåè®®.</p>
<p>Decodableåè®®å®šä¹‰äº†ä¸€ä¸ªè§£ç å‡½æ•°:</p>
<p><code>init(from decoder: Decoder) throws</code></p>
<p>éµä»Decodableåè®®çš„ç±»å‹å¯ä»¥ä½¿ç”¨ä»»ä½•éµå®ˆäº†Decoderåè®®çš„å¯¹è±¡è¿›è¡Œåˆå§‹åŒ–,å®Œæˆä¸€ä¸ªè§£ç è¿‡ç¨‹ã€‚</p>
<p>Encodableåè®®å®šä¹‰äº†ä¸€ä¸ªç¼–ç å‡½æ•°:</p>
<p><code>func encode(to encoder: Encoder) throws</code></p>
<p>éµä»Encodableåè®®çš„ç±»å‹å¯ä»¥ä½¿ç”¨ä»»ä½•éµå®ˆäº†Encoderåè®®çš„å¯¹è±¡è¿›è¡Œç¼–ç ,å®Œæˆä¸€ä¸ªç¼–ç è¿‡ç¨‹ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°Codableåªæ˜¯è§„å®šäº†ç¼–è§£ç çš„ä¸€èˆ¬è§„åˆ™,å¹¶ä¸æ˜¯ä¸ºæŸä¸€ä¸ªå…·ä½“çš„æ•°æ®æ ¼å¼åè®®è®¾è®¡çš„.å› æ­¤å®ƒçš„æ‰©å±•æ€§æ˜¯å¾ˆå¼ºçš„.ç³»ç»Ÿæä¾›çš„<code>JSONDecoder,JSONEncoder</code>å°±æ˜¯å¯¹åº”äºå…·ä½“çš„JSONæ•°æ®æ ¼å¼çš„ç¼–è§£ç ç±».ç±»ä¼¼çš„è¿˜æœ‰<code>PropertyListEncoder,PropertyListDecoder</code>.å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å’Œåç«¯å•†å®šä¸€ç§è‡ªå®šä¹‰çš„æ•°æ®æ ¼å¼,ç„¶åå®šä¹‰ä¸¤ä¸ªç±»åˆ†åˆ«å®ç°Decoderå’ŒEncoderåè®®ç”¨äºç¼–è§£ç .</p>
<blockquote>
<p>æ³¨æ„:JSONEncoderè‡ªèº«å¹¶æ²¡æœ‰å®ç°Encoderåè®®ï¼Œè€Œæ˜¯å®ƒå†…éƒ¨çš„å¦ä¸€ä¸ªç±»_JSONEncoderå®ç°çš„.JSONEncoderèµ·åˆ°ä¸€ä¸ªå°è£…éšè—ç»†èŠ‚çš„ä½œç”¨.</p>
</blockquote>
<p>JSONDecoderçš„è§£ç æ–¹æ³•:</p>
<p><code>open func decode&lt;T&gt;(_ type: T.Type, from data: Data) throws -&gt; T where T : Decodable</code></p>
<p>è¢«è§£ç çš„ç±»å‹éœ€è¦éµå®ˆDecodableåè®®.</p>
<p>JSONEncoderçš„ç¼–ç æ–¹æ³•:</p>
<p><code>open func encode&lt;T&gt;(_ value: T) throws -&gt; Data where T : Encodable</code></p>
<p>è¢«ç¼–ç çš„ç±»å‹éœ€è¦éµå®ˆEncodableåè®®.</p>
<p>ä¸€ä¸ªæ¨¡å‹éµå®ˆCodableåè®®å,é€šè¿‡JSONDecoder,JSONEncoderæˆ‘ä»¬å°±å¯ä»¥è¿›è¡ŒJSONçš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–.</p>
<h4 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h4><p>json:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123456&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å°æ˜&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>æ¨¡å‹:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Student1</span>: <span class="title class_ inherited__">Decodable</span>, <span class="title class_ inherited__">Encodable</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> id: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> grade: <span class="type">Int</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">id</span>: <span class="type">String</span>, <span class="params">name</span>: <span class="type">String</span>, <span class="params">grade</span>: <span class="type">Int</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.id <span class="operator">=</span> id</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">        <span class="keyword">self</span>.grade <span class="operator">=</span> grade</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">enum</span> <span class="title class_">CodingKeys</span>: <span class="title class_ inherited__">String</span>, <span class="title class_ inherited__">CodingKey</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> id</span><br><span class="line">        <span class="keyword">case</span> name</span><br><span class="line">        <span class="keyword">case</span> grade</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">encode</span>(<span class="params">to</span> <span class="params">encoder</span>: <span class="type">Encoder</span>) <span class="keyword">throws</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> container <span class="operator">=</span> encoder.container(keyedBy: <span class="type">CodingKeys</span>.<span class="keyword">self</span>)</span><br><span class="line">        <span class="keyword">try</span> container.encode(id, forKey: .id)</span><br><span class="line">        <span class="keyword">try</span> container.encode(name, forKey: .name)</span><br><span class="line">        <span class="keyword">try</span> container.encode(grade, forKey: .grade)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">from</span> <span class="params">decoder</span>: <span class="type">Decoder</span>) <span class="keyword">throws</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> container <span class="operator">=</span> <span class="keyword">try</span> decoder.container(keyedBy: <span class="type">CodingKeys</span>.<span class="keyword">self</span>)</span><br><span class="line">        id <span class="operator">=</span> <span class="keyword">try</span> container.decode(<span class="type">String</span>.<span class="keyword">self</span>, forKey: <span class="type">CodingKeys</span>.id)</span><br><span class="line">        name <span class="operator">=</span> <span class="keyword">try</span> container.decode(<span class="type">String</span>.<span class="keyword">self</span>, forKey: <span class="type">CodingKeys</span>.name)</span><br><span class="line">        grade <span class="operator">=</span> <span class="keyword">try</span> container.decode(<span class="type">Int</span>.<span class="keyword">self</span>, forKey: <span class="type">CodingKeys</span>.grade)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†èƒ½å¤Ÿç¼–è§£ç ,æˆ‘ä»¬è®©æ¨¡å‹Student1éµå®ˆDecodable, Encodableåè®®,å¹¶å®ç°åè®®.</p>
<p>è¿™æ ·å°±å¯ä»¥ä½¿ç”¨JSONEncoder/JSONDecoderç¼–è§£ç äº†.</p>
<figure class="highlight julia"><table><tr><td class="code"><pre><span class="line">func testBaseCodable() &#123;</span><br><span class="line">    <span class="keyword">let</span> deJsonStr = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;id&quot;: &quot;123456&quot;,</span></span><br><span class="line"><span class="string">        &quot;name&quot;: &quot;å°æ˜&quot;,</span></span><br><span class="line"><span class="string">        &quot;grade&quot;: 1</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">let</span> deData = deJsonStr.data(<span class="keyword">using</span>: <span class="built_in">String</span>.Encoding.utf8)!</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> decoder = JSONDecoder.init()</span><br><span class="line">        <span class="keyword">let</span> object = <span class="keyword">try</span> decoder.decode(Student1.self, from: deData)</span><br><span class="line">        DLog(object)</span><br><span class="line">    &#125; <span class="keyword">catch</span> <span class="keyword">let</span> error as NSError &#123;</span><br><span class="line">        DLog(<span class="string">&quot;è§£ç å¤±è´¥:\(error.debugDescription)&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> student = Student1.init(id: <span class="string">&quot;127182781278&quot;</span>, name: <span class="string">&quot;å°çº¢&quot;</span>, grade: <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> jsonData2 = <span class="keyword">try</span> JSONEncoder.init().encode(student)</span><br><span class="line">        <span class="keyword">let</span> jsonString = <span class="built_in">String</span>.init(data: jsonData2, encoding: <span class="built_in">String</span>.Encoding.utf8)</span><br><span class="line">        DLog(jsonString!)</span><br><span class="line">    &#125; <span class="keyword">catch</span> <span class="keyword">let</span> error as NSError &#123;</span><br><span class="line">        DLog(<span class="string">&quot;ç¼–ç å¤±è´¥:\(error.debugDescription)&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç ä¸­æˆ‘ä»¬ä¸ºæ¨¡å‹å®ç°äº†Codableåè®®.åœ¨å®é™…ä½¿ç”¨æ—¶å¹¶ä¸éœ€è¦è¿™ä¹ˆéº»çƒ¦,å› ä¸ºSwiftæ ‡å‡†åº“ä¸­çš„ç±»å‹ï¼Œæ¯”å¦‚Stringï¼ŒIntï¼ŒDoubleå’Œ Foundation æ¡†æ¶ä¸­Dataï¼ŒDateï¼ŒURLéƒ½æ˜¯é»˜è®¤æ”¯æŒCodableåè®®çš„ï¼Œæ‰€ä»¥å¦‚æœä½ çš„æ¨¡å‹ä½¿ç”¨çš„éƒ½æ˜¯Swiftæ ‡å‡†åº“ä¸­çš„ç±»å‹,é‚£ä¹ˆåªéœ€å£°æ˜æ”¯æŒåè®®å³å¯ã€‚å¦‚ä¸‹:</p>
<figure class="highlight qml"><table><tr><td class="code"><pre><span class="line">struct <span class="attribute">Student</span>: <span class="title">Codable</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="attribute">id:</span><span class="string"> String</span></span><br><span class="line">    <span class="keyword">var</span> <span class="attribute">name</span>: <span class="built_in">String</span></span><br><span class="line">    <span class="keyword">var</span> <span class="attribute">grade</span>: Int</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åå°±å¯ä»¥é€šè¿‡JSONDecoderå°†jsonæ•°æ®è½¬æ¢ä¸ºæ¨¡å‹äº†.æ˜¯ä¸æ˜¯å¾ˆæ–¹ä¾¿?</p>
<blockquote>
<p>å®é™…ä¸Š,åœ¨ç¼–è¯‘ä»£ç æ—¶ç³»ç»Ÿä¼šæ ¹æ®ç±»å‹çš„å±æ€§ï¼Œè‡ªåŠ¨ç”Ÿæˆäº†ä¸€ä¸ª <code>CodingKeys</code> çš„æšä¸¾ç±»å‹å®šä¹‰ï¼Œè¿™æ˜¯ä¸€ä¸ªä»¥ <code>String</code> ç±»å‹ä½œä¸ºåŸå§‹å€¼çš„æšä¸¾ç±»å‹ï¼Œå¯¹åº”æ¯ä¸€ä¸ªå±æ€§çš„åç§°ã€‚ç„¶åå†ç»™æ¯ä¸€ä¸ªå£°æ˜å®ç° Codableåè®®çš„ç±»å‹è‡ªåŠ¨ç”Ÿæˆ <code>init(from:)</code> å’Œ <code>encode(to:)</code> ä¸¤ä¸ªå‡½æ•°çš„å…·ä½“å®ç°ï¼Œæœ€ç»ˆå®Œæˆäº†æ•´ä¸ªåè®®çš„å®ç°ã€‚</p>
</blockquote>
<h4 id="åµŒå¥—å¯¹è±¡ï¼Œæ•°ç»„å’Œå­—å…¸"><a href="#åµŒå¥—å¯¹è±¡ï¼Œæ•°ç»„å’Œå­—å…¸" class="headerlink" title="åµŒå¥—å¯¹è±¡ï¼Œæ•°ç»„å’Œå­—å…¸"></a>åµŒå¥—å¯¹è±¡ï¼Œæ•°ç»„å’Œå­—å…¸</h4><p>ä¸€èˆ¬æƒ…å†µä¸‹ä¼šé‡åˆ°åµŒå¥—çš„æƒ…æ™¯.è¿™ä¸ªæ—¶å€™è¯¥å¦‚ä½•å¤„ç†å‘¢?</p>
<p>éœ€è¦åƒYYModelé‚£æ ·å®ç°æ–¹æ³•<code>+ (nullable NSDictionary&lt;NSString *, id&gt; *)modelContainerPropertyGenericClass;</code>å—?</p>
<p>æˆ‘ä»¬çœ‹ä¸€ä¸‹Arrayå’ŒDictionaryçš„æ‰©å±•:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extension</span> <span class="title class_">Array</span> : <span class="title class_ inherited__">Encodable</span> <span class="keyword">where</span> <span class="title class_ inherited__">Element</span> : <span class="title class_ inherited__">Encodable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">encode</span>(<span class="params">to</span> <span class="params">encoder</span>: <span class="type">Encoder</span>) <span class="keyword">throws</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">Array</span> : <span class="title class_ inherited__">Decodable</span> <span class="keyword">where</span> <span class="title class_ inherited__">Element</span> : <span class="title class_ inherited__">Decodable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(<span class="params">from</span> <span class="params">decoder</span>: <span class="type">Decoder</span>) <span class="keyword">throws</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">Dictionary</span> : <span class="title class_ inherited__">Decodable</span> <span class="keyword">where</span> <span class="title class_ inherited__">Key</span> : <span class="title class_ inherited__">Decodable</span>, <span class="title class_ inherited__">Value</span> : <span class="title class_ inherited__">Decodable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(<span class="params">from</span> <span class="params">decoder</span>: <span class="type">Decoder</span>) <span class="keyword">throws</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">Dictionary</span> : <span class="title class_ inherited__">Encodable</span> <span class="keyword">where</span> <span class="title class_ inherited__">Key</span> : <span class="title class_ inherited__">Encodable</span>, <span class="title class_ inherited__">Value</span> : <span class="title class_ inherited__">Encodable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">encode</span>(<span class="params">to</span> <span class="params">encoder</span>: <span class="type">Encoder</span>) <span class="keyword">throws</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ éƒ½éµä»Codableåè®®ï¼Œå­—å…¸ä¸­å¯¹åº”çš„keyå’Œvalueéµä»Codableåè®®ï¼Œé‚£ä¹ˆæ•´ä¸ªå®¹å™¨å¯¹è±¡ä¹Ÿå°±éµä»Codableåè®®.</p>
<figure class="highlight wren"><table><tr><td class="code"><pre><span class="line"><span class="variable">struct</span> <span class="title class_">Class</span>: <span class="title class_">Codable</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> className: <span class="title class_">String</span></span><br><span class="line">    <span class="keyword">var</span> <span class="variable">students</span>: <span class="title class_">Array</span><span class="operator">&lt;</span><span class="title class_">Student</span><span class="operator">&gt;</span></span><br><span class="line">    <span class="keyword">var</span> <span class="variable">teacher</span>: <span class="title class_">Person</span>0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person0</span>: <span class="title class_">Codable</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">name</span>: <span class="title class_">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> <span class="variable">age</span>: <span class="title class_">Int</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> <span class="variable">motto</span>: <span class="title class_">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> <span class="variable">sex</span>: <span class="title class_">Bool</span> <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºStudentéµå®ˆCodableåè®®,å› æ­¤<code>Array&lt;Student&gt;</code>å®¹å™¨ä¹Ÿå°±éµå®ˆCodableåè®®.è¿™æ ·Classçš„æ¯ä¸ªå±æ€§éƒ½éµå®ˆCodableåè®®.å› æ­¤å¦‚å‰é¢æ‰€è¯´åªéœ€å£°æ˜Classæ”¯æŒCodableåè®®å³å¯.</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;className&quot;</span><span class="punctuation">:</span><span class="string">&quot;3å¹´Açµ„&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;students&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">             <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;13321&quot;</span><span class="punctuation">,</span></span><br><span class="line">             <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å°æ˜&quot;</span><span class="punctuation">,</span></span><br><span class="line">             <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">             <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;213&quot;</span><span class="punctuation">,</span></span><br><span class="line">             <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å°ç‹&quot;</span><span class="punctuation">,</span></span><br><span class="line">             <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;teacher&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å¼ ä¸‰ä¸°&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;motto&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nothing is impossible.&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>è§£ç :</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">let deData = deJsonStr<span class="selector-class">.data</span>(using: String<span class="selector-class">.Encoding</span>.utf8)!</span><br><span class="line">let <span class="selector-tag">object</span> = try! JSONDecoder<span class="selector-class">.init</span>()<span class="selector-class">.decode</span>(Class<span class="selector-class">.self</span>, from: deData)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(object)</span></span></span><br></pre></td></tr></table></figure>
<h4 id="é”®åå’Œå±æ€§åä¸ä¸€è‡´"><a href="#é”®åå’Œå±æ€§åä¸ä¸€è‡´" class="headerlink" title="é”®åå’Œå±æ€§åä¸ä¸€è‡´"></a>é”®åå’Œå±æ€§åä¸ä¸€è‡´</h4><p>ä¸€èˆ¬ä¼šé‡åˆ°å’ŒæœåŠ¡å™¨å­—æ®µåå®šä¹‰ä¸ä¸€è‡´çš„æƒ…å†µ.</p>
<p>jsonå¦‚ä¸‹:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å¼ ä¸‰ä¸°&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_age&quot;</span><span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;motto&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nothing is impossible.&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>æ¨¡å‹å¦‚ä¸‹:</p>
<figure class="highlight wren"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person1</span>: <span class="title class_">Codable</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">name</span>: <span class="title class_">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> <span class="variable">age</span>: <span class="title class_">Int</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> <span class="variable">motto</span>: <span class="title class_">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> <span class="variable">sex</span>: <span class="title class_">Bool</span> <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœä¸åšä»»ä½•å¤„ç†ä¼šæŠ¥é”™:</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">keyNotFound</span>(<span class="built_in">CodingKeys</span>(<span class="attribute">stringValue</span>: <span class="string">&quot;name&quot;</span>, <span class="attribute">intValue</span>: nil), Swift.DecodingError.<span class="built_in">Context</span>(<span class="attribute">codingPath</span>: [], <span class="attribute">debugDescription</span>: <span class="string">&quot;No value associated with key CodingKeys(stringValue: \&quot;</span>name\<span class="string">&quot;, intValue: nil) (\&quot;</span>name\<span class="string">&quot;).&quot;</span>, <span class="attribute">underlyingError</span>: nil))</span><br></pre></td></tr></table></figure>
<p>è§£å†³åŠæ³•ï¼š</p>
<p>å®šä¹‰ä¸€ä¸ªéµå®ˆCodingKey åè®®çš„æšä¸¾CodingKeys(åå­—å¿…é¡»æ˜¯<strong>CodingKeys</strong>)æŒ‡å®šä¸€ä¸ªæ˜ç¡®çš„æ˜ å°„ã€‚Swift ä¼šå¯»æ‰¾éµå®ˆCodingKey åè®®çš„åä¸º CodingKeys çš„å­ç±»å‹ã€‚è§£ç æ—¶Swiftåªè§£ç è¿™é‡Œé¢çš„å±æ€§,å…¶ä»–å±æ€§ä¼šè¢«å¿½ç•¥.</p>
<p>å¦‚ä¸‹:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person1</span>: <span class="title class_ inherited__">Codable</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> age: <span class="type">Int</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> motto: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> sex: <span class="type">Bool</span> <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">CodingKeys</span>: <span class="title class_ inherited__">String</span>, <span class="title class_ inherited__">CodingKey</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> name <span class="operator">=</span> <span class="string">&quot;_name&quot;</span></span><br><span class="line">        <span class="keyword">case</span> age <span class="operator">=</span> <span class="string">&quot;_age&quot;</span></span><br><span class="line">        <span class="keyword">case</span> motto <span class="operator">=</span> <span class="string">&quot;motto&quot;</span> </span><br><span class="line">        <span class="keyword">case</span> sex <span class="operator">=</span> <span class="string">&quot;sex&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å‘ç‚¹</strong>:åªè¦æœ‰ä¸€ä¸ªå­—æ®µåç§°ä¸åŒ¹é…,å°±å¾—å®šä¹‰ä¸€ä¸ªéµå®ˆCodingKey åè®®çš„æšä¸¾å¹¶æŠŠå…¶ä»–å±æ€§åç§°å…¨éƒ¨å†™è¿›æšä¸¾é‡Œ.</p>
<h4 id="é”®å€¼å¯¹å’Œå±æ€§æ•°é‡ä¸ä¸€è‡´"><a href="#é”®å€¼å¯¹å’Œå±æ€§æ•°é‡ä¸ä¸€è‡´" class="headerlink" title="é”®å€¼å¯¹å’Œå±æ€§æ•°é‡ä¸ä¸€è‡´"></a>é”®å€¼å¯¹å’Œå±æ€§æ•°é‡ä¸ä¸€è‡´</h4><ol>
<li>æœåŠ¡å™¨å°‘äºå®¢æˆ·ç«¯å­—æ®µæƒ…å†µ.</li>
</ol>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å¼ ä¸‰ä¸°&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">23</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœä¸åšå¤„ç†ä¼šæŠ¥é”™:</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">keyNotFound</span>(<span class="built_in">CodingKeys</span>(<span class="attribute">stringValue</span>: <span class="string">&quot;motto&quot;</span>, <span class="attribute">intValue</span>: nil), Swift.DecodingError.<span class="built_in">Context</span>(<span class="attribute">codingPath</span>: [], <span class="attribute">debugDescription</span>: <span class="string">&quot;No value associated with key CodingKeys(stringValue: \&quot;</span>motto\<span class="string">&quot;, intValue: nil) (\&quot;</span>motto\<span class="string">&quot;).&quot;</span>, <span class="attribute">underlyingError</span>: nil))</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯æœåŠ¡å™¨å°‘è¿”å›äº†æŸä¸ªå­—æ®µ,</p>
<p>è§£å†³åŠæ³•:å°†è¯¥å­—æ®µå®šä¹‰ä¸ºå¯é€‰ç±»å‹.</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person21</span>: <span class="title class_ inherited__">Codable</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> age: <span class="type">Int</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> motto: <span class="type">String</span>? <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> sex: <span class="type">Bool</span>? <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯æ¨¡å‹ä¸­å®šä¹‰äº†ä¸€äº›å…¶ä»–å­—æ®µè€ŒæœåŠ¡å™¨æ²¡æœ‰çš„,</p>
<p>è§£å†³åŠæ³•:å°†è¯¥å­—æ®µå®šä¹‰ä¸ºå¯é€‰ç±»å‹æˆ–è€…å®šä¹‰ä¸€ä¸ªéµå®ˆCodingKey åè®®çš„æšä¸¾,æŠŠéœ€è¦è§£ç çš„å±æ€§å†™ä¸Šå³å¯,å¦‚ä¸‹:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person2</span>: <span class="title class_ inherited__">Codable</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> age: <span class="type">Int</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> motto: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> sex: <span class="type">Bool</span> <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">CodingKeys</span>: <span class="title class_ inherited__">String</span>, <span class="title class_ inherited__">CodingKey</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> name</span><br><span class="line">        <span class="keyword">case</span> age</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å‘ç‚¹</strong>:æœ‰çš„åå°å¼€å‘è€…ä¼šå°†æ²¡æœ‰å€¼çš„å­—æ®µçœç•¥,æ‰€ä»¥ä½ æ ¹æœ¬ä¸çŸ¥é“å“ªä¸ªå­—æ®µä¼šä¸è¿”å›,ä¸å¯èƒ½æŠŠæ¯ä¸€ä¸ªå­—æ®µéƒ½å£°æ˜ä¸ºå¯é€‰å€¼,å¦åˆ™ä½ åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ç®€ç›´æ˜¯å™©æ¢¦.</p>
<ol>
<li>æœåŠ¡å™¨å¤šäºå®¢æˆ·ç«¯å­—æ®µæƒ…å†µ</li>
</ol>
<p>æœåŠ¡å™¨è¿”å›äº†è®¸å¤šæˆ‘ä»¬ä¸éœ€è¦çš„å­—æ®µ,è¿™ç§æƒ…å†µä¸‹,æ¨¡å‹åªéœ€è¦å®šä¹‰å¥½è¯¥æœ‰çš„å±æ€§,æ— éœ€å®šä¹‰ä¸€ä¸ªéµå®ˆCodingKey åè®®çš„æšä¸¾,Codableè§£ç æ—¶ä¼šè‡ªåŠ¨å¿½ç•¥æ‰å¤šä½™çš„é”®å€¼.</p>
<p>æ€»ä½“ä¸Šjsoné”®å€¼å¯¹è¦åŒ…å«æ¨¡å‹çš„å±æ€§.å±äºåŒ…å«å•æ˜ å°„å…³ç³».</p>
<h4 id="ç±»å‹ä¸ä¸€è‡´"><a href="#ç±»å‹ä¸ä¸€è‡´" class="headerlink" title="ç±»å‹ä¸ä¸€è‡´"></a>ç±»å‹ä¸ä¸€è‡´</h4><p>æœåŠ¡å™¨è¿”å›çš„æ˜¯Stringä½†å®¢æˆ·ç«¯å®šä¹‰çš„æ˜¯Int.</p>
<p>jsonå¦‚ä¸‹:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;å¼ ä¸‰ä¸°&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">23</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;motto&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nothing is impossible.&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;height&quot;</span><span class="punctuation">:</span> <span class="number">175</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>æ¨¡å‹å¦‚ä¸‹:</p>
<figure class="highlight wren"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person3</span>: <span class="title class_">Codable</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">name</span>: <span class="title class_">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> <span class="variable">age</span>: <span class="title class_">Int</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> <span class="variable">motto</span>: <span class="title class_">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> <span class="variable">sex</span>: <span class="title class_">Bool</span> <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœä¸åšä»»ä½•å¤„ç†åˆ™æŠ¥é”™:ç±»å‹ä¸åŒ¹é….</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">typeMismatch</span>(Swift.Int, Swift.DecodingError.<span class="built_in">Context</span>(<span class="attribute">codingPath</span>: [<span class="built_in">CodingKeys</span>(<span class="attribute">stringValue</span>: <span class="string">&quot;age&quot;</span>, <span class="attribute">intValue</span>: nil)], <span class="attribute">debugDescription</span>: <span class="string">&quot;Expected to decode Int but found a string/data instead.&quot;</span>, <span class="attribute">underlyingError</span>: nil))</span><br></pre></td></tr></table></figure>
<p>è§£å†³åŠæ³•:</p>
<p><a href="https://devkin.cc/2018/04/16/codable è¸©å‘/">Codable è¸©å‘</a></p>
<p><strong>Boolå€¼è§£æ</strong></p>
<p>Swifté‡ŒBoolå€¼åªæœ‰trueå’Œfalse,å¦‚æœåç«¯è¿”å›çš„æ˜¯0,1è¿™æ ·çš„æ•´å‹å€¼,Codableä¼šè§£æå‡ºé”™:ç±»å‹ä¸åŒ¹é….</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">typeMismatch</span>(Swift.Bool, Swift.DecodingError.<span class="built_in">Context</span>(<span class="attribute">codingPath</span>: [<span class="built_in">CodingKeys</span>(<span class="attribute">stringValue</span>: <span class="string">&quot;sex&quot;</span>, <span class="attribute">intValue</span>: nil)], <span class="attribute">debugDescription</span>: <span class="string">&quot;Expected to decode Bool but found a number instead.&quot;</span>, <span class="attribute">underlyingError</span>: nil))</span><br></pre></td></tr></table></figure>
<h4 id="æšä¸¾å€¼"><a href="#æšä¸¾å€¼" class="headerlink" title="æšä¸¾å€¼"></a>æšä¸¾å€¼</h4><ol>
<li><p>æœåŠ¡ç«¯ä½¿ç”¨æ•´å‹æšä¸¾</p>
</li>
<li><p>æœåŠ¡ç«¯ä½¿ç”¨å­—ç¬¦ä¸²æšä¸¾</p>
</li>
</ol>
<p>jsonå¦‚ä¸‹:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;feedID&quot;</span><span class="punctuation">:</span><span class="string">&quot;100000&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;template&quot;</span><span class="punctuation">:</span> <span class="string">&quot;video&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>templateæœ‰:video,pic,link.</p>
<p>genderæœ‰:0,1.</p>
<p>æ¨¡å‹:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TimeLine</span>: <span class="title class_ inherited__">Codable</span> &#123;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// æœåŠ¡ç«¯ä½¿ç”¨å­—ç¬¦ä¸²æšä¸¾</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">TimeLineTemplate</span>: <span class="title class_ inherited__">String</span>, <span class="title class_ inherited__">Codable</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> video <span class="operator">=</span> <span class="string">&quot;video&quot;</span></span><br><span class="line">        <span class="keyword">case</span> pic <span class="operator">=</span> <span class="string">&quot;pic&quot;</span></span><br><span class="line">        <span class="keyword">case</span> link <span class="operator">=</span> <span class="string">&quot;link&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æœåŠ¡ç«¯ä½¿ç”¨æ•´å‹æšä¸¾</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Gender</span>: <span class="title class_ inherited__">Int</span>, <span class="title class_ inherited__">Codable</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> female <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">case</span> male <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> feedID: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> template: <span class="type">TimeLineTemplate</span></span><br><span class="line">    <span class="keyword">var</span> gender: <span class="type">Gender</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è§£å†³åŠæ³•:è®©æšä¸¾ç±»å‹æ”¯æŒ Codable åè®®.</p>
<p>éœ€è¦å°†æšä¸¾å£°æ˜ä¸ºå…·æœ‰åŸå§‹å€¼çš„å½¢å¼ï¼Œå¹¶ä¸”åŸå§‹å€¼çš„ç±»å‹éœ€è¦æ”¯æŒ Codable åè®®.</p>
<ol>
<li>å®šä¹‰ä¸€ä¸ªå…·æœ‰åŸå§‹å€¼çš„æšä¸¾,æŒ‡å®šåŸå§‹å€¼ç±»å‹ä¸ºStringæˆ–Int.</li>
<li>è®©æšä¸¾éµå®ˆCodableåè®®.</li>
</ol>
<p>éœ€è¦æ³¨æ„çš„æ˜¯:æšä¸¾çš„åŸå§‹å€¼å¿…é¡»å’ŒæœåŠ¡å™¨ç«¯å•†å®šå¥½ä¿æŒä¸€è‡´.æ¯”å¦‚åŸæœ¬åªæœ‰0,1ä¸¤ä¸ªæšä¸¾å€¼,ä½†åå°å´è¿”å›3.è¿™å°±æ²¡æ³•å¯¹åº”ä¸Šäº†.è§£ç ä¼šæŠ¥é”™:</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">dataCorrupted</span>(Swift.DecodingError.<span class="built_in">Context</span>(<span class="attribute">codingPath</span>: [<span class="built_in">CodingKeys</span>(<span class="attribute">stringValue</span>: <span class="string">&quot;template&quot;</span>, <span class="attribute">intValue</span>: nil)], <span class="attribute">debugDescription</span>: <span class="string">&quot;Cannot initialize TimeLineTemplate from invalid String value videos&quot;</span>, <span class="attribute">underlyingError</span>: nil))</span><br></pre></td></tr></table></figure>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">dataCorrupted</span>(Swift.DecodingError.<span class="built_in">Context</span>(<span class="attribute">codingPath</span>: [<span class="built_in">CodingKeys</span>(<span class="attribute">stringValue</span>: <span class="string">&quot;gender&quot;</span>, <span class="attribute">intValue</span>: nil)], <span class="attribute">debugDescription</span>: <span class="string">&quot;Cannot initialize Gender from invalid Int value 4&quot;</span>, <span class="attribute">underlyingError</span>: nil))</span><br></pre></td></tr></table></figure>
<h4 id="æ¨¡å‹ä¸­æŸä¸ªå±æ€§çš„ç±»å‹ä¸æ”¯æŒCodableåè®®"><a href="#æ¨¡å‹ä¸­æŸä¸ªå±æ€§çš„ç±»å‹ä¸æ”¯æŒCodableåè®®" class="headerlink" title="æ¨¡å‹ä¸­æŸä¸ªå±æ€§çš„ç±»å‹ä¸æ”¯æŒCodableåè®®"></a>æ¨¡å‹ä¸­æŸä¸ªå±æ€§çš„ç±»å‹ä¸æ”¯æŒCodableåè®®</h4><p>æ¯”å¦‚modelä½¿ç”¨äº†ä¸€äº›ä¸å±äºæˆ‘ä»¬è‡ªå·±çš„ç±»å‹ï¼Œè¯¥ç±»å‹åˆæ²¡æœ‰éµå®ˆCodableåè®®.å¦‚ä½•è®©modelæ”¯æŒCodable?</p>
<p>æ¯”å¦‚CLLocationCoordinate2Då¹¶æ²¡æœ‰å®ç°Codableåè®®.</p>
<p>è§£å†³åŠæ³•æœ‰ä¸‰ç§:ä¸ªäººæ„Ÿè§‰æ— è®ºå“ªä¸€ç§éƒ½ä¸æ–¹ä¾¿.</p>
<ol>
<li><p>æ‰‹åŠ¨è®©CLLocationCoordinate2Dæ”¯æŒCodableåè®®.</p>
</li>
<li><p>æ‰‹åŠ¨è®©è‡ªèº«æ”¯æŒCodableåè®®.</p>
</li>
</ol>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person5</span>: <span class="title class_ inherited__">Codable</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> age: <span class="type">Int</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> motto: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> sex: <span class="type">Bool</span> <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">var</span> position: <span class="type">CLLocationCoordinate2D</span>?</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">enum</span> <span class="title class_">CodingKeys</span>: <span class="title class_ inherited__">String</span>, <span class="title class_ inherited__">CodingKey</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> name <span class="operator">=</span> <span class="string">&quot;_name&quot;</span></span><br><span class="line">        <span class="keyword">case</span> age <span class="operator">=</span> <span class="string">&quot;_age&quot;</span></span><br><span class="line">        <span class="keyword">case</span> motto</span><br><span class="line">        <span class="keyword">case</span> sex</span><br><span class="line">        <span class="keyword">case</span> position <span class="operator">=</span> <span class="string">&quot;position&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è‡ªå·±å®ç°Codableåè®®.ç¼ºç‚¹:éº»çƒ¦,ç¼–ç ,è§£ç éƒ½éœ€è¦å®ç°.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">enum</span> <span class="title class_">PositionCodingKeys</span>: <span class="title class_ inherited__">String</span>, <span class="title class_ inherited__">CodingKey</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> latitude</span><br><span class="line">        <span class="keyword">case</span> longitude</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">name</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init</span>(<span class="params">from</span> <span class="params">decoder</span>: <span class="type">Decoder</span>) <span class="keyword">throws</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> container <span class="operator">=</span> <span class="keyword">try</span> decoder.container(keyedBy: <span class="type">CodingKeys</span>.<span class="keyword">self</span>)</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> <span class="keyword">try</span> container.decode(<span class="type">String</span>.<span class="keyword">self</span>, forKey: .name)</span><br><span class="line">        <span class="keyword">self</span>.age <span class="operator">=</span> <span class="keyword">try</span> container.decode(<span class="type">Int</span>.<span class="keyword">self</span>, forKey: .age)</span><br><span class="line">        <span class="keyword">self</span>.motto <span class="operator">=</span> <span class="keyword">try</span> container.decode(<span class="type">String</span>.<span class="keyword">self</span>, forKey: .motto)</span><br><span class="line">        <span class="keyword">self</span>.sex <span class="operator">=</span> <span class="keyword">try</span> container.decode(<span class="type">Bool</span>.<span class="keyword">self</span>, forKey: .sex)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> posContainer <span class="operator">=</span> <span class="keyword">try</span> container.nestedContainer(keyedBy: <span class="type">PositionCodingKeys</span>.<span class="keyword">self</span>, forKey: .position)</span><br><span class="line">        <span class="keyword">self</span>.position <span class="operator">=</span> <span class="type">CLLocationCoordinate2D</span>.<span class="keyword">init</span>(latitude: <span class="keyword">try</span> posContainer.decode(<span class="type">Double</span>.<span class="keyword">self</span>, forKey: .latitude), longitude: <span class="keyword">try</span> posContainer.decode(<span class="type">Double</span>.<span class="keyword">self</span>, forKey: .longitude))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">encode</span>(<span class="params">to</span> <span class="params">encoder</span>: <span class="type">Encoder</span>) <span class="keyword">throws</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> container <span class="operator">=</span> encoder.container(keyedBy: <span class="type">CodingKeys</span>.<span class="keyword">self</span>)</span><br><span class="line">        <span class="keyword">try</span> container.encode(name, forKey: .name)</span><br><span class="line">        <span class="keyword">try</span> container.encode(age, forKey: .age)</span><br><span class="line">        <span class="keyword">try</span> container.encode(motto, forKey: .motto)</span><br><span class="line">        <span class="keyword">try</span> container.encode(sex, forKey: .sex)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> posContainer <span class="operator">=</span> container.nestedContainer(keyedBy: <span class="type">PositionCodingKeys</span>.<span class="keyword">self</span>, forKey: .position)</span><br><span class="line">        <span class="keyword">try</span> posContainer.encode(position<span class="operator">?</span>.latitude, forKey: .latitude)</span><br><span class="line">        <span class="keyword">try</span> posContainer.encode(position<span class="operator">?</span>.latitude, forKey: .longitude)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>ç»™CLLocationCoordinate2Då•ç‹¬åˆ›å»ºä¸€ä¸ªæ”¯æŒCodableçš„åŒ…è£…ç±».</li>
</ol>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person4</span>: <span class="title class_ inherited__">Codable</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> age: <span class="type">Int</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> motto: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> sex: <span class="type">Bool</span> <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">var</span> id: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> position: <span class="type">CLLocationCoordinate2D</span>? &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> _position <span class="operator">==</span> <span class="literal">nil</span> <span class="operator">?</span> <span class="literal">nil</span> : <span class="type">CLLocationCoordinate2D</span>.<span class="keyword">init</span>(latitude: _position<span class="operator">!</span>.latitude, longitude: _position<span class="operator">!</span>.longitude)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> newValue <span class="operator">==</span> <span class="literal">nil</span> &#123;</span><br><span class="line">                _position <span class="operator">=</span> <span class="literal">nil</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                _position <span class="operator">=</span> _CLLocationCoordinate2D.<span class="keyword">init</span>(latitude: newValue<span class="operator">!</span>.latitude, longitude: newValue<span class="operator">!</span>.longitude)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">struct</span> <span class="title class_">_CLLocationCoordinate2D</span>: <span class="title class_ inherited__">Codable</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> latitude: <span class="type">CLLocationDegrees</span></span><br><span class="line">        <span class="keyword">var</span> longitude: <span class="type">CLLocationDegrees</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">init</span>(<span class="params">latitude</span>: <span class="type">CLLocationDegrees</span>, <span class="params">longitude</span>: <span class="type">CLLocationDegrees</span>) &#123;</span><br><span class="line">            <span class="keyword">self</span>.latitude <span class="operator">=</span> latitude</span><br><span class="line">            <span class="keyword">self</span>.longitude <span class="operator">=</span> longitude</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> _position: _CLLocationCoordinate2D<span class="operator">?</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">enum</span> <span class="title class_">CodingKeys</span>: <span class="title class_ inherited__">String</span>, <span class="title class_ inherited__">CodingKey</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> name <span class="operator">=</span> <span class="string">&quot;_name&quot;</span></span><br><span class="line">        <span class="keyword">case</span> age <span class="operator">=</span> <span class="string">&quot;_age&quot;</span></span><br><span class="line">        <span class="keyword">case</span> motto</span><br><span class="line">        <span class="keyword">case</span> sex</span><br><span class="line">        <span class="keyword">case</span> _position <span class="operator">=</span> <span class="string">&quot;position&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ç¼–è§£ç æœ‰ç»§æ‰¿å…³ç³»çš„æ¨¡å‹"><a href="#ç¼–è§£ç æœ‰ç»§æ‰¿å…³ç³»çš„æ¨¡å‹" class="headerlink" title="ç¼–è§£ç æœ‰ç»§æ‰¿å…³ç³»çš„æ¨¡å‹"></a>ç¼–è§£ç æœ‰ç»§æ‰¿å…³ç³»çš„æ¨¡å‹</h4><p>é»˜è®¤æƒ…å†µä¸‹,åªæœ‰ç»§æ‰¿æ¥çš„å±æ€§æœ‰å€¼,å­ç±»è‡ªèº«çš„å±æ€§å°†ä¸ä¼šæœ‰å€¼.</p>
<p>æ¨¡å‹å¦‚ä¸‹:</p>
<figure class="highlight wren"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person0</span>: <span class="title class_">Codable</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">name</span>: <span class="title class_">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> <span class="variable">age</span>: <span class="title class_">Int</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> <span class="variable">motto</span>: <span class="title class_">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> <span class="variable">sex</span>: <span class="title class_">Bool</span> <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Teacher</span>: <span class="title class_">Person</span>0 &#123; </span><br><span class="line">    <span class="keyword">var</span> <span class="variable">course</span>: <span class="title class_">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœå†™ä¸º:<code>class Teacher: Person0, Codable</code>,ç¼–è¯‘ä¼šå‡ºé”™:Redundant conformance of â€˜Teacherâ€™ to protocol â€˜Decodableâ€™.å› ä¸ºTeacherçš„çˆ¶ç±»Person0å·²ç»éµå®ˆCodableäº†.</p>
<p>æµ‹è¯•ä»£ç :</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">codablePolymorphismType</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> deJsonStr <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;name&quot;: &quot;å¼ ä¸‰ä¸°&quot;,</span></span><br><span class="line"><span class="string">        &quot;age&quot;: 23,</span></span><br><span class="line"><span class="string">        &quot;motto&quot;: &quot;nothing is impossible.&quot;,</span></span><br><span class="line"><span class="string">        &quot;sex&quot;: true</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">let</span> deData <span class="operator">=</span> deJsonStr.data(using: <span class="type">String</span>.<span class="type">Encoding</span>.utf8)<span class="operator">!</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> decoder <span class="operator">=</span> <span class="type">JSONDecoder</span>.<span class="keyword">init</span>()</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> object <span class="operator">=</span> <span class="keyword">try</span> decoder.decode(<span class="type">Person0</span>.<span class="keyword">self</span>, from: deData)</span><br><span class="line">        <span class="type">DLog</span>(object)</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="type">DLog</span>(error)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> deTeacherJsonStr <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;name&quot;: &quot;å¼ ä¸‰ä¸°&quot;,</span></span><br><span class="line"><span class="string">        &quot;age&quot;: 23,</span></span><br><span class="line"><span class="string">        &quot;motto&quot;: &quot;nothing is impossible.&quot;,</span></span><br><span class="line"><span class="string">        &quot;sex&quot;: true,</span></span><br><span class="line"><span class="string">        &quot;course&quot;: &quot;è¯­æ–‡&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">let</span> deTeacherData <span class="operator">=</span> deTeacherJsonStr.data(using: <span class="type">String</span>.<span class="type">Encoding</span>.utf8)<span class="operator">!</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> object: <span class="type">Teacher</span>?</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        object <span class="operator">=</span> <span class="keyword">try</span> <span class="type">JSONDecoder</span>.<span class="keyword">init</span>().decode(<span class="type">Teacher</span>.<span class="keyword">self</span>, from: deTeacherData)</span><br><span class="line">        <span class="type">DLog</span>(object<span class="operator">!</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="type">DLog</span>(error)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> teacher <span class="operator">=</span> object &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> data <span class="operator">=</span> <span class="keyword">try</span> <span class="type">JSONEncoder</span>.<span class="keyword">init</span>().encode(teacher)</span><br><span class="line">            <span class="keyword">let</span> jsonString <span class="operator">=</span> <span class="type">String</span>.<span class="keyword">init</span>(data: data, encoding: <span class="type">String</span>.<span class="type">Encoding</span>.utf8)</span><br><span class="line">            <span class="type">DLog</span>(jsonString<span class="operator">!</span>)</span><br><span class="line">        &#125; <span class="keyword">catch</span> <span class="keyword">let</span> error <span class="keyword">as</span> <span class="type">NSError</span> &#123;</span><br><span class="line">            <span class="type">DLog</span>(<span class="string">&quot;ç¼–ç å¤±è´¥:<span class="subst">\(error.debugDescription)</span>&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šè§£ç æ—¶,Teacherå¯¹è±¡ç»§æ‰¿çš„çˆ¶ç±»çš„å±æ€§æœ‰å€¼ä½†è‡ªèº«courseå±æ€§å°†æ˜¯nil.å¯¹äºè¿™ç§æœ‰ç»§æ‰¿å…³ç³»çš„æ¨¡å‹çš„ç¼–è§£ç è¯¥æ€ä¹ˆåŠå‘¢?</p>
<p>è§£å†³åŠæ³•:å›åˆ°æœ€å¼€å§‹çš„åŸºæœ¬ä½¿ç”¨,è‡ªå·±æ‰‹åŠ¨å®ç°Codableåè®®.</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person0</span>: <span class="title class_ inherited__">Codable</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> age: <span class="type">Int</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> motto: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> sex: <span class="type">Bool</span> <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Teacher</span>: <span class="title class_ inherited__">Person0</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> course: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">CodingKeys</span>: <span class="title class_ inherited__">String</span>, <span class="title class_ inherited__">CodingKey</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> course</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init</span>(<span class="params">from</span> <span class="params">decoder</span>: <span class="type">Decoder</span>) <span class="keyword">throws</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> container <span class="operator">=</span> <span class="keyword">try</span> decoder.container(keyedBy: <span class="type">CodingKeys</span>.<span class="keyword">self</span>)</span><br><span class="line">        course <span class="operator">=</span> <span class="keyword">try</span> container.decode(<span class="type">String</span>.<span class="keyword">self</span>, forKey: .course)</span><br><span class="line">        <span class="keyword">try</span> <span class="keyword">super</span>.<span class="keyword">init</span>(from: decoder)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">encode</span>(<span class="params">to</span> <span class="params">encoder</span>: <span class="type">Encoder</span>) <span class="keyword">throws</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> container <span class="operator">=</span> encoder.container(keyedBy: <span class="type">CodingKeys</span>.<span class="keyword">self</span>)</span><br><span class="line">        <span class="keyword">try</span> container.encode(course, forKey: <span class="type">CodingKeys</span>.course)</span><br><span class="line">        <span class="keyword">try</span> <span class="keyword">super</span>.encode(to: encoder)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘ç‚¹:ä½¿ç”¨ä¸ä¾¿.</p>
<h4 id="ç¼–ç Any"><a href="#ç¼–ç Any" class="headerlink" title="ç¼–ç Any"></a>ç¼–ç Any</h4><h4 id="JSONDecoder-JSONEncoderæ€»ç»“"><a href="#JSONDecoder-JSONEncoderæ€»ç»“" class="headerlink" title="JSONDecoder/JSONEncoderæ€»ç»“"></a>JSONDecoder/JSONEncoderæ€»ç»“</h4><h5 id="ä¼˜åŠ¿"><a href="#ä¼˜åŠ¿" class="headerlink" title="ä¼˜åŠ¿"></a>ä¼˜åŠ¿</h5><ol>
<li>ç³»ç»Ÿæ”¯æŒ,å…¼å®¹æ€§é—®é¢˜å°.</li>
<li>å¦‚æœæ¨¡å‹ä¸­éƒ½æ˜¯åŸºç¡€ç±»å‹,<code>JSONDecoder/JSONEncoder</code>æ›´æ–¹ä¾¿.</li>
<li>å¯¹åŸç”Ÿç±»å‹æ”¯æŒæ›´å¥½</li>
</ol>
<h5 id="ä¸è¶³"><a href="#ä¸è¶³" class="headerlink" title="ä¸è¶³"></a>ä¸è¶³</h5><ol>
<li>åªè¦æœ‰ä¸€ä¸ªå±æ€§è§£æå¤±è´¥åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸å¯¼è‡´æ•´ä¸ªè§£æè¿‡ç¨‹å¤±è´¥ã€‚ä¸»è¦ä½“ç°åœ¨:</li>
</ol>
<ul>
<li><p>jsonä¸­å‡ºç°nullå€¼,ç©ºå¯¹è±¡,å­—æ®µç¼ºå¤±,å¦‚æœä¸åšå¤„ç†,å½“è§£æåˆ°è¯¥å­—æ®µæ—¶ç³»ç»Ÿä¼šæŠ¥é”™.</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">è§£ç å¤±è´¥:<span class="built_in">Error</span> <span class="attribute">Domain</span>=NSCocoaErrorDomain <span class="attribute">Code</span>=4865 <span class="string">&quot;No value associated with key CodingKeys(stringValue: &quot;</span>grade<span class="string">&quot;, intValue: nil) (&quot;</span>grade<span class="string">&quot;).&quot;</span> UserInfo=&#123;<span class="attribute">NSDebugDescription</span>=<span class="literal">No</span> value associated with key CodingKeys(stringValue: <span class="string">&quot;grade&quot;</span>, intValue: <span class="literal">nil</span>) (<span class="string">&quot;grade&quot;</span>)., NSCodingPath=(</span><br><span class="line">)&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">è§£ç å¤±è´¥:<span class="built_in">Error</span> <span class="attribute">Domain</span>=NSCocoaErrorDomain <span class="attribute">Code</span>=4865 <span class="string">&quot;Expected Int value but found null instead.&quot;</span> UserInfo=&#123;NSCodingPath=(</span><br><span class="line">    <span class="string">&quot;CodingKeys(stringValue: \&quot;grade\&quot;, intValue: nil)&quot;</span></span><br><span class="line">), <span class="attribute">NSDebugDescription</span>=Expected Int value but found <span class="literal">null</span> instead.&#125;</span><br></pre></td></tr></table></figure>
<p>è§£å†³åŠæ³•:å°†æ¨¡å‹ä¸­è¯¥å±æ€§è®¾ç½®ä¸ºå¯é€‰å€¼.ä½†æ­£å¦‚å‰æ–‡åˆ†æçš„é‚£æ ·,æœ‰çš„åå°å¼€å‘è€…ä¼šå°†æ²¡æœ‰å€¼çš„å­—æ®µçœç•¥,æ‰€ä»¥ä½ æ ¹æœ¬ä¸çŸ¥é“å“ªä¸ªå­—æ®µä¼šä¸è¿”å›,ä¸å¯èƒ½æŠŠæ¯ä¸€ä¸ªå­—æ®µéƒ½å£°æ˜ä¸ºå¯é€‰å€¼,å¦åˆ™ä½ åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ç®€ç›´æ˜¯å™©æ¢¦.</p>
</li>
<li><p>ç±»å‹ä¸åŒ¹é…æ—¶,å¦‚æœä¸åšå¤„ç†,å½“è§£æåˆ°è¯¥å­—æ®µæ—¶ç³»ç»Ÿä¼šæŠ¥é”™.</p>
<p>æ¯”å¦‚æœåŠ¡ç«¯å®šä¹‰ä¸ºString,è€Œä½ å®šä¹‰ä¸ºInt.</p>
<p><a href="https://www.jianshu.com/p/1f194f09599a">æµ…è°ˆ Swift JSON è§£æ</a>:ä¸»æµ JSON è§£ææ¡†æ¶æ¯”è¾ƒ,åˆ†æäº†Codableçš„ä¸è¶³,å¹¶æå‡ºäº†è§£å†³æ–¹æ¡ˆ<a href="https://github.com/Pircate/CleanJSON">CleanJSON</a></p>
</li>
</ul>
<ol>
<li>åªè¦æœ‰ä¸€ä¸ªå­—æ®µåç§°å’Œåå°ä¸ä¸€è‡´,å°±å¾—å®šä¹‰ä¸€ä¸ªéµå®ˆCodingKey åè®®çš„æšä¸¾å¹¶æŠŠå…¶ä»–å±æ€§åç§°å…¨éƒ¨å†™è¿›æšä¸¾é‡Œ,å¦‚æœä¸€ä¸ªæ¨¡å‹æœ‰å¾ˆå¤šå±æ€§,ä¼šå¾ˆç¹ç.</li>
<li>ç¼–è§£ç æœ‰ç»§æ‰¿å…³ç³»çš„æ¨¡å‹ä¸æ–¹ä¾¿,éœ€è¦æ‰‹åŠ¨å®ç°Codableåè®®.</li>
</ol>
<h3 id="HandyJSON"><a href="#HandyJSON" class="headerlink" title="HandyJSON"></a>HandyJSON</h3><p>alibabaå¼€æºçš„ä¸€ä¸ª json-object äº’è½¬çš„æ¡†æ¶.</p>
<h4 id="HandyJSONåŸç†"><a href="#HandyJSONåŸç†" class="headerlink" title="HandyJSONåŸç†"></a>HandyJSONåŸç†</h4><p>ä¸»è¦æ­¥éª¤:</p>
<ol>
<li>é€šè¿‡æŸç§æœºåˆ¶(æ¯”å¦‚Mirror)è·å–å±æ€§åã€ç±»å‹.</li>
<li>æ ¹æ®å±æ€§åä»JSONä¸²ä¸­è§£æå€¼.</li>
<li>æ‰¾åˆ°å®ä¾‹åœ¨å†…å­˜ä¸­çš„ headPointer, é€šè¿‡å±æ€§çš„ç±»å‹è®¡ç®—å†…å­˜ä¸­çš„åç§»å€¼, ç¡®å®šå±æ€§åœ¨å†…å­˜ä¸­çš„ä½ç½®.</li>
<li>åœ¨å†…å­˜ä¸­ä¸ºå±æ€§èµ‹å€¼.(è¿™ä¸€æ­¥ä¼šè¿›è¡Œç±»å‹çš„å®¹é”™å¤„ç†,æ¯”å¦‚å­—ç¬¦ä¸²è½¬æ•°å­—,æ•°å­—è½¬å­—ç¬¦ä¸²ç­‰ä¸€äº›ç®€å•çš„è½¬æ¢)</li>
</ol>
<p>ç”±äºè¿™ä¸ªç±»å®ä¾‹çš„å†…å­˜å¸ƒå±€å¯èƒ½ä¼šå˜,æ‰€ä»¥å®˜æ–¹æ–‡æ¡£ä¸­æœ‰æåˆ°â€HandyJSON is totally depend on the memory layout rules infered from Swift runtime code. <strong>We are watching it and will follow every bit if it changes.</strong>â€œ.</p>
<p>ä¸ºå•¥è¦åˆ†æç±»å®ä¾‹çš„å†…å­˜å¸ƒå±€è§„åˆ™å‘¢?</p>
<p>æˆ‘ä»¬çŸ¥é“OCé‡Œé¢å¯ä»¥é€šè¿‡runtimeè·å–ä¸€ä¸ªç±»æ‰€æœ‰çš„å±æ€§åå’Œç±»å‹,ç„¶åé€šè¿‡KVCå°±å¯ä»¥å®Œæˆèµ‹å€¼.ä½†æ˜¯Swiftçš„åå°„åŠŸèƒ½å¾ˆå¼±,Swiftçš„åå°„å®ç°ç±»Mirrorå®ƒåªèƒ½åœ¨è¿è¡Œæ—¶è·å–ä¸€ä¸ªModelå®ä¾‹çš„æ‰€æœ‰å­—æ®µã€å­—æ®µå€¼ï¼Œä½†å´æ— æ³•ç»™å®ƒèµ‹å€¼,ç¼ºå°‘ä¸€ä¸ªç±»ä¼¼OCé‡Œé¢KVCçš„è¿™ä¹ˆä¸€ä¸ªä¸œè¥¿,æ‰€ä»¥HandyJSONæ‰éœ€è¦åˆ†æç±»å®ä¾‹çš„å†…å­˜å¸ƒå±€è§„åˆ™,æ ¹æ®å¸ƒå±€è§„åˆ™ç›´æ¥åœ¨å†…å­˜ä¸­ä¸ºå±æ€§èµ‹å€¼.</p>
<p>å…·ä½“å¯ä»¥å‚è€ƒ<a href="https://www.jianshu.com/p/eac4a92b44ef">HandyJSON è®¾è®¡æ€è·¯ç®€æ</a>.</p>
<h4 id="HandyJSONä½¿ç”¨"><a href="#HandyJSONä½¿ç”¨" class="headerlink" title="HandyJSONä½¿ç”¨"></a>HandyJSONä½¿ç”¨</h4><p>HandyJSONçš„ä½¿ç”¨<a href="https://github.com/alibaba/HandyJSON">å®˜æ–¹æ–‡æ¡£</a>å…¶å®å·²ç»å¾ˆå…¨é¢äº†.</p>
<p>ä¸‹é¢é€šè¿‡ä¸€ä¸ªä¾‹å­å°†ä¸Šé¢æ‰€æœ‰çš„æƒ…å†µä¹Ÿæµ‹è¯•ä¸€ä¸‹:</p>
<p>æ¨¡å‹:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HJPerson</span>: <span class="title class_ inherited__">HandyJSON</span>  &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æœåŠ¡ç«¯ä½¿ç”¨æ•´å‹æšä¸¾</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Hobbit</span>: <span class="title class_ inherited__">Int</span>, <span class="title class_ inherited__">HandyJSONEnum</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> none <span class="operator">=</span> <span class="operator">-</span><span class="number">1</span></span><br><span class="line">        <span class="keyword">case</span> basketball <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">case</span> football <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Music</span>: <span class="title class_ inherited__">String</span>, <span class="title class_ inherited__">HandyJSONEnum</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> none</span><br><span class="line">        <span class="keyword">case</span> classic</span><br><span class="line">        <span class="keyword">case</span> modern</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> age: <span class="type">Int</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> motto: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> sex: <span class="type">Bool</span> <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">var</span> height: <span class="type">Float</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> id: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> hobbit: <span class="type">Hobbit</span> <span class="operator">=</span> .none</span><br><span class="line">    <span class="keyword">var</span> music: <span class="type">Music</span> <span class="operator">=</span> .none</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init</span>() &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åç§°ä¸åŒ¹é…æ—¶</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">mapping</span>(<span class="params">mapper</span>: <span class="type">HelpingMapper</span>) &#123;</span><br><span class="line">        mapper.specify(property: <span class="operator">&amp;</span>name, name: <span class="string">&quot;_name&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HJTeacher</span>: <span class="title class_ inherited__">HJPerson</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> course: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Student2</span>: <span class="title class_ inherited__">HandyJSON</span>  &#123;</span><br><span class="line">    <span class="keyword">init</span>() &#123;</span><br><span class="line">        id <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        name <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        grade <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> id: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> grade: <span class="type">Int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ä»£ç :</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">handyJsonStudent</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> deJsonStr <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;id&quot;: &quot;2323&quot;,</span></span><br><span class="line"><span class="string">        &quot;name&quot;: &quot;å°æ˜&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment">//        let student = JSONDeserializer&lt;Student2&gt;.deserializeFrom(json: deJsonStr)</span></span><br><span class="line">    <span class="keyword">let</span> student <span class="operator">=</span> <span class="type">Student2</span>.deserialize(from: deJsonStr)</span><br><span class="line">    <span class="type">DLog</span>(student)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">func</span> <span class="title function_">handyJsonKeyPropertyTypeNotMatch</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> deJsonStr <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;_name&quot;: &quot;å¼ ä¸‰ä¸°&quot;,</span></span><br><span class="line"><span class="string">        &quot;age&quot;: &quot;23&quot;,</span></span><br><span class="line"><span class="string">        &quot;motto&quot;: &quot;nothing is impossible.&quot;,</span></span><br><span class="line"><span class="string">        &quot;sex&quot;: 1,</span></span><br><span class="line"><span class="string">        &quot;height&quot;: &quot;172.4&quot;,</span></span><br><span class="line"><span class="string">        &quot;hobbit&quot;: &quot;1&quot;,</span></span><br><span class="line"><span class="string">        &quot;music&quot;: &quot;modern&quot;,</span></span><br><span class="line"><span class="string">        &quot;id&quot;: 345345131</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">let</span> student <span class="operator">=</span> <span class="type">HJPerson</span>.deserialize(from: deJsonStr)</span><br><span class="line">    <span class="type">DLog</span>(student)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> <span class="title function_">handyJsonPolymorphismType</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> deJsonStr <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;_name&quot;: &quot;å¼ ä¸‰ä¸°&quot;,</span></span><br><span class="line"><span class="string">        &quot;age&quot;: 23,</span></span><br><span class="line"><span class="string">        &quot;motto&quot;: &quot;nothing is impossible.&quot;,</span></span><br><span class="line"><span class="string">        &quot;hobbit&quot;: &quot;4&quot;,</span></span><br><span class="line"><span class="string">        &quot;sex&quot;: true</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">let</span> person <span class="operator">=</span> <span class="type">HJPerson</span>.deserialize(from: deJsonStr)</span><br><span class="line">    <span class="type">DLog</span>(person)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> deTeacherJsonStr <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;_name&quot;: &quot;å¼ ä¸‰ä¸°&quot;,</span></span><br><span class="line"><span class="string">        &quot;age&quot;: 23,</span></span><br><span class="line"><span class="string">        &quot;motto&quot;: &quot;nothing is impossible.&quot;,</span></span><br><span class="line"><span class="string">        &quot;sex&quot;: true,</span></span><br><span class="line"><span class="string">        &quot;course&quot;: &quot;è¯­æ–‡&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">let</span> teacher <span class="operator">=</span> <span class="type">HJTeacher</span>.deserialize(from: deTeacherJsonStr)</span><br><span class="line">    <span class="type">DLog</span>(teacher<span class="operator">!</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> string <span class="operator">=</span> teacher<span class="operator">!</span>.toJSONString()</span><br><span class="line">    <span class="type">DLog</span>(string<span class="operator">!</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“æœåŠ¡ç«¯è¿”å›çš„JSONæ ¼å¼ä¸è§„èŒƒæ—¶,æ¯”å¦‚åç§°ä¸åŒ¹é…,ç±»å‹ä¸åŒ¹é…,ç¼ºå¤±å­—æ®µ,å­—æ®µå€¼ä¸ºnull,Boolå€¼é—®é¢˜ç­‰,ä½¿ç”¨HandyJSONåŸºæœ¬ä¸Šä¸éœ€è¦é¢å¤–çš„å¤„ç†,éå¸¸æ–¹ä¾¿.</p>
<h4 id="HandyJSONä¼˜ç‚¹"><a href="#HandyJSONä¼˜ç‚¹" class="headerlink" title="HandyJSONä¼˜ç‚¹"></a>HandyJSONä¼˜ç‚¹</h4><ol>
<li>ä½¿ç”¨éå¸¸æ–¹ä¾¿</li>
<li>æ•°æ®å®¹é”™æ€§é«˜</li>
</ol>
<h4 id="HandyJSONç¼ºç‚¹"><a href="#HandyJSONç¼ºç‚¹" class="headerlink" title="HandyJSONç¼ºç‚¹"></a>HandyJSONç¼ºç‚¹</h4><ol>
<li>ä¾èµ–äºç±»å®ä¾‹çš„å†…å­˜å¸ƒå±€è§„åˆ™.</li>
<li>Swiftç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜.ä¸€æ—¦å‡ºé—®é¢˜å°±åªèƒ½ç­‰å®˜æ–¹å‡ºæ–°ç‰ˆæœ¬äº†.Swift4ä¹‹å‰æ¯”è¾ƒå‘,ä¸è¿‡ç°åœ¨éƒ½Swift5äº†,è¿™ä¸ªé—®é¢˜ä¼šå¥½ç‚¹.</li>
</ol>
<p>æ€»çš„æ¥è¯´è¿˜æ˜¯å€¼å¾—å…¥å‘çš„.</p>
<h3 id="ObjectMapper"><a href="#ObjectMapper" class="headerlink" title="ObjectMapper"></a>ObjectMapper</h3><p>åº”è¯¥æ˜¯æ¯”è¾ƒæ—©çš„ä¸€æ‰¹è½¬æ¢æ¡†æ¶äº†,ä½¿ç”¨ä¸Šç±»ä¼¼ <code>Codable</code>ï¼Œä½†æ˜¯éœ€è¦é¢å¤–å†™ map æ–¹æ³•ï¼Œé‡å¤åŠ³åŠ¨è¿‡å¤šã€‚ä¸æ˜¯å¾ˆæ¨è.</p>
<p>æ¨¡å‹:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">OMPerson</span>: <span class="title class_ inherited__">Mappable</span>   &#123;</span><br><span class="line">    <span class="comment">//æœåŠ¡ç«¯ä½¿ç”¨æ•´å‹æšä¸¾</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Hobbit</span>: <span class="title class_ inherited__">Int</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> none <span class="operator">=</span> <span class="operator">-</span><span class="number">1</span></span><br><span class="line">        <span class="keyword">case</span> basketball <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">case</span> football <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Music</span>: <span class="title class_ inherited__">String</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> none</span><br><span class="line">        <span class="keyword">case</span> classic</span><br><span class="line">        <span class="keyword">case</span> modern</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> age: <span class="type">Int</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> motto: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> sex: <span class="type">Bool</span> <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">var</span> height: <span class="type">Float</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> id: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> hobbit: <span class="type">Hobbit</span> <span class="operator">=</span> .none</span><br><span class="line">    <span class="keyword">var</span> music: <span class="type">Music</span> <span class="operator">=</span> .none</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init?</span>(<span class="params">map</span>: <span class="type">Map</span>) &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">mapping</span>(<span class="params">map</span>: <span class="type">Map</span>) &#123;</span><br><span class="line">        name <span class="operator">&lt;-</span> map[<span class="string">&quot;_name&quot;</span>]</span><br><span class="line">        age <span class="operator">&lt;-</span> map[<span class="string">&quot;age&quot;</span>]</span><br><span class="line">        motto <span class="operator">&lt;-</span> map[<span class="string">&quot;motto&quot;</span>]</span><br><span class="line">        sex <span class="operator">&lt;-</span> map[<span class="string">&quot;sex&quot;</span>]</span><br><span class="line">        height <span class="operator">&lt;-</span> map[<span class="string">&quot;height&quot;</span>]</span><br><span class="line">        id <span class="operator">&lt;-</span> map[<span class="string">&quot;id&quot;</span>]</span><br><span class="line">        hobbit <span class="operator">&lt;-</span> map[<span class="string">&quot;hobbit&quot;</span>]</span><br><span class="line">        music <span class="operator">&lt;-</span> map[<span class="string">&quot;music&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OMTeacher</span>: <span class="title class_ inherited__">OMPerson</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> course: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init?</span>(<span class="params">map</span>: <span class="type">Map</span>) &#123;</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(map: map)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">mapping</span>(<span class="params">map</span>: <span class="type">Map</span>) &#123;</span><br><span class="line">        <span class="keyword">super</span>.mapping(map: map)</span><br><span class="line">        course <span class="operator">&lt;-</span> map[<span class="string">&quot;course&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>éœ€è¦éµå®ˆå¹¶å®ç°Mappableåè®®çš„ä¿©å‡½æ•°,å°¤å…¶æ˜¯<code>func mapping(map: Map)</code>å‡½æ•°,æ¯”è¾ƒç¹ç.ç±»å‹ä¸åŒ¹é…æ—¶ä¸ä¼šèµ‹å€¼ç»™å±æ€§,ä¸åƒJSONDecoderé‚£æ ·ç›´æ¥æŠ¥é”™,ä½†ä¹Ÿä¸åƒHandyJSONä¼šå¸®ä½ å°è¯•åšä¸€ä¸‹è½¬æ¢.</p>
<p>æµ‹è¯•ä»£ç :</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">objectMapperStudent</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> deJsonStr <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;id&quot;: &quot;2323&quot;,</span></span><br><span class="line"><span class="string">        &quot;_name&quot;: &quot;å°æ˜&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">let</span> student <span class="operator">=</span> <span class="type">Student3</span>.<span class="keyword">init</span>(JSONString: deJsonStr)</span><br><span class="line">    <span class="type">DLog</span>(student)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">func</span> <span class="title function_">objectMapperKeyPropertyTypeNotMatch</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> deJsonStr <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;_name&quot;: &quot;å¼ ä¸‰ä¸°&quot;,</span></span><br><span class="line"><span class="string">        &quot;age&quot;: &quot;23&quot;,</span></span><br><span class="line"><span class="string">        &quot;motto&quot;: &quot;nothing is impossible.&quot;,</span></span><br><span class="line"><span class="string">        &quot;sex&quot;: 0,</span></span><br><span class="line"><span class="string">        &quot;height&quot;: &quot;172.4&quot;,</span></span><br><span class="line"><span class="string">        &quot;hobbit&quot;: 1,</span></span><br><span class="line"><span class="string">        &quot;music&quot;: &quot;modern&quot;,</span></span><br><span class="line"><span class="string">        &quot;id&quot;: 345345131</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">let</span> student <span class="operator">=</span> <span class="type">OMPerson</span>.<span class="keyword">init</span>(JSONString: deJsonStr)</span><br><span class="line">    <span class="type">DLog</span>(student)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> <span class="title function_">objectMapperPolymorphismType</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> deJsonStr <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;_name&quot;: &quot;å¼ ä¸‰ä¸°&quot;,</span></span><br><span class="line"><span class="string">        &quot;age&quot;: 23,</span></span><br><span class="line"><span class="string">        &quot;motto&quot;: &quot;nothing is impossible.&quot;,</span></span><br><span class="line"><span class="string">        &quot;hobbit&quot;: &quot;4&quot;,</span></span><br><span class="line"><span class="string">        &quot;sex&quot;: true</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">let</span> person <span class="operator">=</span> <span class="type">OMPerson</span>.<span class="keyword">init</span>(JSONString: deJsonStr)</span><br><span class="line">    <span class="type">DLog</span>(person)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> deTeacherJsonStr <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        &quot;_name&quot;: &quot;å¼ ä¸‰ä¸°&quot;,</span></span><br><span class="line"><span class="string">        &quot;age&quot;: 23,</span></span><br><span class="line"><span class="string">        &quot;motto&quot;: &quot;nothing is impossible.&quot;,</span></span><br><span class="line"><span class="string">        &quot;sex&quot;: true,</span></span><br><span class="line"><span class="string">        &quot;course&quot;: &quot;è¯­æ–‡&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">let</span> teacher <span class="operator">=</span> <span class="type">OMTeacher</span>.<span class="keyword">init</span>(JSONString: deTeacherJsonStr)</span><br><span class="line">    <span class="type">DLog</span>(teacher<span class="operator">!</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> string <span class="operator">=</span> <span class="type">Mapper</span>.<span class="keyword">init</span>().toJSONString(teacher<span class="operator">!</span>)</span><br><span class="line">	  <span class="type">DLog</span>(string<span class="operator">!</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th>JSONDecoder/JSONEncoder</th>
<th>HandyJSON</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ˜“ç”¨æ€§</td>
<td>è¾ƒå¥½</td>
<td>å¥½</td>
</tr>
<tr>
<td>æ•°æ®å®¹é”™æ€§</td>
<td>ä¸€èˆ¬</td>
<td>å¥½</td>
</tr>
<tr>
<td>å…¼å®¹æ€§</td>
<td>å¥½</td>
<td>ä¸€èˆ¬</td>
</tr>
</tbody>
</table>
</div>
<p>è€ƒè™‘åˆ°æ˜“ç”¨æ€§å’Œæ•°æ®å®¹é”™æ€§æ¨èä½¿ç”¨HandyJSON.ä½†æ˜¯åŸºäºCodableçš„<code>JSONDecoder/JSONEncoder</code>å¦‚æœèƒ½å¤Ÿå¾ˆå¥½çš„è§£å†³æ•°æ®å®¹é”™æ€§æ–¹é¢çš„é—®é¢˜è¿˜æ˜¯å¾ˆä¸é”™çš„,æ¯•ç«Ÿå¯ä»¥å°‘å¼•å…¥ä¸€ä¸ªå¤–éƒ¨æ¡†æ¶.</p>
]]></content>
      <categories>
        <category>Swift</category>
      </categories>
      <tags>
        <tag>Codable</tag>
        <tag>HandyJSON</tag>
        <tag>ObjectMapper</tag>
      </tags>
  </entry>
  <entry>
    <title>OCåå°„+å¤šæ€è°ƒç”¨ç±»æ–¹æ³•</title>
    <url>/2020/03/06/OC%E5%8F%8D%E5%B0%84+%E5%A4%9A%E6%80%81%E8%B0%83%E7%94%A8%E7%B1%BB%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<h4 id="å¤šæ€"><a href="#å¤šæ€" class="headerlink" title="å¤šæ€"></a>å¤šæ€</h4><p>å¤šæ€æŒ‡çš„æ˜¯å…è®¸çˆ¶ç±»çš„æŒ‡é’ˆæŒ‡å‘å­ç±»çš„å¯¹è±¡,å½“æŒ‡é’ˆæŒ‡å‘ä¸åŒçš„å­ç±»å¯¹è±¡æ—¶,ç»™å®ƒå‘é€åŒä¸€ä¸ªæ¶ˆæ¯å°±ä¼šæœ‰ä¸åŒçš„å“åº”.</p>
<p>å¦‚ä¸‹å®šä¹‰ä¸€ä¸ªçˆ¶ç±»Animalå’ŒäºŒä¸ªå­ç±»Dog,Cat.</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Animal</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)run;</span><br><span class="line"></span><br><span class="line">+ (<span class="type">void</span>)bark;</span><br><span class="line"></span><br><span class="line">+ (<span class="type">void</span>)canClimb:(<span class="type">void</span>(^)(<span class="type">BOOL</span> can))blk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Animal</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)run</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ run&quot;</span>, <span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="type">void</span>)bark &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ bark&quot;</span>, <span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="type">void</span>)canClimb:(<span class="type">void</span> (^)(<span class="type">BOOL</span>))blk &#123;</span><br><span class="line">    !blk ?: blk(<span class="literal">NO</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Dog</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)run</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ run&quot;</span>, <span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="type">void</span>)bark &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ bark&quot;</span>, <span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="type">void</span>)canClimb:(<span class="type">void</span> (^)(<span class="type">BOOL</span>))blk &#123;</span><br><span class="line">    !blk ?: blk(<span class="literal">NO</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Cat</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)run</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ run&quot;</span>, <span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="type">void</span>)bark &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ bark&quot;</span>, <span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="type">void</span>)canClimb:(<span class="type">void</span> (^)(<span class="type">BOOL</span>))blk &#123;</span><br><span class="line">    !blk ?: blk(<span class="literal">YES</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä¸ªåå°„+å¤šæ€:</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *clsArr = @[<span class="string">@&quot;Animal&quot;</span>, <span class="string">@&quot;Dog&quot;</span>, <span class="string">@&quot;Cat&quot;</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSString</span> *clsStr <span class="keyword">in</span> clsArr) &#123;</span><br><span class="line">    Class cls = <span class="built_in">NSClassFromString</span>(clsStr);</span><br><span class="line">    <span class="type">id</span> obj = [cls new];</span><br><span class="line">    [obj run];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSString</span> *clsStr <span class="keyword">in</span> clsArr) &#123;</span><br><span class="line">    Class cls = <span class="built_in">NSClassFromString</span>(clsStr);</span><br><span class="line">    [cls performSelector:<span class="keyword">@selector</span>(bark)];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ‰‹åŠ¨å†™å…¨</span></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSString</span> *clsStr <span class="keyword">in</span> clsArr) &#123;</span><br><span class="line">    Class cls = <span class="built_in">NSClassFromString</span>(clsStr);</span><br><span class="line">    [cls canClimb:^(<span class="type">BOOL</span> can)&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ can climb:%d&quot;</span>,cls, can);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨performSelector</span></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSString</span> *clsStr <span class="keyword">in</span> clsArr) &#123;</span><br><span class="line">    Class cls = <span class="built_in">NSClassFromString</span>(clsStr);</span><br><span class="line">    [cls performSelector:<span class="keyword">@selector</span>(canClimb:) withObject:^(<span class="type">BOOL</span> can)&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ can climb:%d&quot;</span>,cls, can);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šéœ€è¦æ³¨æ„çš„æ˜¯:</p>
<p>Xcodeå¯¹äºidç±»å‹è°ƒç”¨å®ä¾‹æ–¹æ³•,å®ä¾‹æ–¹æ³•ä¼šæœ‰è¡¥å…¨æç¤º.å¯¹äºClassç±»å‹è°ƒç”¨ç±»æ–¹æ³•,ç±»æ–¹æ³•å°±æ²¡æœ‰è¡¥å…¨æç¤º,ä½†ä½ å†™å…¨åä¹Ÿä¸ä¼šæŠ¥é”™.</p>
<p>å¯¹äºç±»æ–¹æ³•çš„åŠ¨æ€è°ƒç”¨å¯ä»¥ä½¿ç”¨<code>performSelector</code>,ä¹Ÿå¯ä»¥æ‰‹åŠ¨å†™å…¨,è¿™é‡ŒXcodeä¸ä¼šè‡ªåŠ¨è¡¥å…¨ä¸çŸ¥é“ä¸ºä»€ä¹ˆ.</p>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
  </entry>
  <entry>
    <title>github pages+hexo+nextæ­å»ºåšå®¢</title>
    <url>/2020/02/29/github%20pages+hexo+next%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/</url>
    <content><![CDATA[<h2 id="ä¸»è¦æ­¥éª¤"><a href="#ä¸»è¦æ­¥éª¤" class="headerlink" title="ä¸»è¦æ­¥éª¤"></a>ä¸»è¦æ­¥éª¤</h2><ul>
<li>å®‰è£…ç¯å¢ƒ</li>
<li>åˆå§‹åŒ–é¡¹ç›®</li>
<li>éƒ¨ç½²</li>
<li>é…ç½®ç«™ç‚¹ä¿¡æ¯</li>
<li>é…ç½®ä¸»é¢˜ä¿¡æ¯</li>
</ul>
<p>ä¸‹é¢æ˜¯å…·ä½“çš„æ­¥éª¤:</p>
<h3 id="å®‰è£…ç¯å¢ƒ"><a href="#å®‰è£…ç¯å¢ƒ" class="headerlink" title="å®‰è£…ç¯å¢ƒ"></a>å®‰è£…ç¯å¢ƒ</h3><p>å®‰è£…node.js</p>
<p>å®‰è£…hexo</p>
<h3 id="åˆå§‹åŒ–é¡¹ç›®"><a href="#åˆå§‹åŒ–é¡¹ç›®" class="headerlink" title="åˆå§‹åŒ–é¡¹ç›®"></a>åˆå§‹åŒ–é¡¹ç›®</h3><p>ä½¿ç”¨ Hexo çš„å‘½ä»¤è¡Œåˆ›å»ºä¸€ä¸ªé¡¹ç›®.</p>
<p><code>hexo init &quot;name&quot;</code></p>
<p>è°ƒç”¨ Hexo çš„ generate å‘½ä»¤ï¼Œå°† Hexo ç¼–è¯‘ç”Ÿæˆ HTML ä»£ç .</p>
<p><code>hexo generate</code></p>
<p>åˆ©ç”¨ Hexo æä¾›çš„ server å‘½ä»¤è®©åšå®¢åœ¨æœ¬åœ°è¿è¡Œèµ·æ¥.</p>
<p><code>hexo server</code></p>
<h3 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h3><p>å®‰è£…ä¸€ä¸ªæ”¯æŒ Git çš„éƒ¨ç½²æ’ä»¶ï¼Œåå­—å«åš hexo-deployer-gitï¼Œæœ‰äº†å®ƒæˆ‘ä»¬æ‰å¯ä»¥é¡ºåˆ©å°†å…¶éƒ¨ç½²åˆ° GitHub ä¸Šé¢ï¼Œå¦‚æœä¸å®‰è£…çš„è¯ï¼Œåœ¨æ‰§è¡Œéƒ¨ç½²å‘½ä»¤æ—¶ä¼šæŠ¥é”™è¯¯.</p>
<p><code>npm install hexo-deployer-git --save</code></p>
<p>éƒ¨ç½²</p>
<p><code>hexo deploy</code></p>
<p>éƒ¨ç½²æˆåŠŸä¹‹å,Hexoä¼šå°†ç¼–è¯‘ä¹‹åçš„é™æ€é¡µé¢å†…å®¹æ¨é€åˆ° GitHub ä»“åº“çš„ master åˆ†æ”¯.</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯é‡Œé¢æ˜¯æ²¡æœ‰åšå®¢æºç çš„.å¦‚æœæˆ‘ä»¬æ¢äº†ç”µè„‘å°±éœ€è¦å°†ä»¥å‰çš„åšå®¢æ‹·è´å›æ¥.è¿™æ ·æ˜¾ç„¶å¾ˆä¸æ–¹ä¾¿,å› æ­¤æˆ‘ä»¬éœ€è¦å°†åšå®¢æºç ä¹Ÿæ‰˜ç®¡åˆ° GitHub ä¸Šé¢.</p>
<p><strong>å°†åšå®¢æºç æ‰˜ç®¡åˆ° GitHub ä¸Šé¢</strong></p>
<p>å¯ä»¥æ–°å»ºä¸€ä¸ªsourceåˆ†æ”¯,ç”¨äºåšå®¢æºç çš„ç®¡ç†.</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">git init</span><br><span class="line">git checkout -<span class="keyword">b </span>source</span><br><span class="line">git <span class="keyword">add </span>-A</span><br><span class="line">git commit -m <span class="string">&quot;init blog&quot;</span></span><br><span class="line">git remote <span class="keyword">add </span><span class="keyword">origin </span><span class="string">&quot;https://github.com/xxx/xxx.github.io.git&quot;</span></span><br><span class="line">git push <span class="keyword">origin </span>source</span><br></pre></td></tr></table></figure>
<h3 id="é…ç½®ç«™ç‚¹ä¿¡æ¯"><a href="#é…ç½®ç«™ç‚¹ä¿¡æ¯" class="headerlink" title="é…ç½®ç«™ç‚¹ä¿¡æ¯"></a>é…ç½®ç«™ç‚¹ä¿¡æ¯</h3><p>ç«™ç‚¹ç®€ä»‹ä¿®æ”¹</p>
<h3 id="ä¿®æ”¹ä¸»é¢˜"><a href="#ä¿®æ”¹ä¸»é¢˜" class="headerlink" title="ä¿®æ”¹ä¸»é¢˜"></a>ä¿®æ”¹ä¸»é¢˜</h3><p>é€‰æ‹©ä¸€ä¸ªä¸»é¢˜ä½¿ç”¨.è¿™é‡Œé€‰æ‹©nextä¸»é¢˜.</p>
<h3 id="ä¸»é¢˜é…ç½®"><a href="#ä¸»é¢˜é…ç½®" class="headerlink" title="ä¸»é¢˜é…ç½®"></a>ä¸»é¢˜é…ç½®</h3><p>ä¸»é¢˜æ˜¾ç¤ºæ•ˆæœé…ç½®</p>
<h2 id="å†™æ–‡ç« "><a href="#å†™æ–‡ç« " class="headerlink" title="å†™æ–‡ç« "></a>å†™æ–‡ç« </h2><p>æ–°å¢æ–‡ç« </p>
<p><code>hexo new &quot;name&quot;</code></p>
<p>åˆ›å»ºçš„æ–‡ç« ä¼šå‡ºç°åœ¨ <code>source/_posts</code> æ–‡ä»¶å¤¹ä¸‹ï¼Œæ˜¯ MarkDown æ ¼å¼ã€‚</p>
<p>åœ¨æ–‡ç« å¼€å¤´é€šè¿‡å¦‚ä¸‹æ ¼å¼æ·»åŠ å¿…è¦ä¿¡æ¯ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">æ ‡é¢˜</span> <span class="comment"># è‡ªåŠ¨åˆ›å»ºï¼Œå¦‚ hello-world</span></span><br><span class="line"><span class="attr">date:</span> <span class="string">æ—¥æœŸ</span> <span class="comment"># è‡ªåŠ¨åˆ›å»ºï¼Œå¦‚ 2020-03-01 13:30:15</span></span><br><span class="line"><span class="attr">tags:</span> </span><br><span class="line"><span class="bullet">-</span> <span class="string">æ ‡ç­¾1</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">æ ‡ç­¾2</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">æ ‡ç­¾3</span></span><br><span class="line"><span class="attr">categories:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">åˆ†ç±»1</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">åˆ†ç±»2</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure>
<p>é»˜è®¤åªæœ‰titleå’Œdate,tagså­—æ®µ.å¯ä»¥æ‰“å¼€<code>\scaffolds\post.md</code>æ–‡ä»¶å¢åŠ ä¸€äº›å­—æ®µ,ä»¥åå°±ä¸è¦é‡å¤å†™äº†.</p>
<h3 id="æ ‡ç­¾"><a href="#æ ‡ç­¾" class="headerlink" title="æ ‡ç­¾"></a>æ ‡ç­¾</h3><p>å¢åŠ æ ‡ç­¾é¡µé¢</p>
<p><code>hexo new page tags</code></p>
<h3 id="åˆ†ç±»"><a href="#åˆ†ç±»" class="headerlink" title="åˆ†ç±»"></a>åˆ†ç±»</h3><p>å¢åŠ åˆ†ç±»é¡µé¢</p>
<p><code>hexo new page categories</code></p>
<h3 id="æœç´¢é¡µ"><a href="#æœç´¢é¡µ" class="headerlink" title="æœç´¢é¡µ"></a>æœç´¢é¡µ</h3><p>å®‰è£…æœç´¢æ’ä»¶</p>
<p><code>npm install hexo-generator-searchdb --save</code></p>
<p>åœ¨é¡¹ç›®çš„ _config.yml é‡Œé¢æ·»åŠ æœç´¢è®¾ç½®:</p>
<figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="symbol">search:</span></span><br><span class="line"><span class="symbol">  path:</span> search.xml</span><br><span class="line"><span class="symbol">  field:</span> post</span><br><span class="line"><span class="symbol">  format:</span> html</span><br><span class="line"><span class="symbol">  limit:</span> <span class="number">10000</span></span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸»é¢˜çš„ _config.yml é‡Œé¢ä¿®æ”¹å¦‚ä¸‹:</p>
<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Local search</span></span><br><span class="line"><span class="comment"># Dependencies: https://github.com/wzpan/hexo-generator-search</span></span><br><span class="line"><span class="params">local_search:</span></span><br><span class="line">  <span class="params">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># If auto, trigger search by changing input.</span></span><br><span class="line">  <span class="comment"># If manual, trigger search by pressing enter key or search button.</span></span><br><span class="line">  <span class="params">trigger:</span> auto</span><br><span class="line">  <span class="comment"># Show top n results per article, show all results by setting to -1</span></span><br><span class="line">  <span class="params">top_n_per_article:</span> <span class="number">5</span></span><br><span class="line">  <span class="comment"># Unescape html strings to the readable one.</span></span><br><span class="line">  <span class="params">unescape:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Preload the search data when the page loads.</span></span><br><span class="line">  <span class="params">preload:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h3 id="404é¡µé¢"><a href="#404é¡µé¢" class="headerlink" title="404é¡µé¢"></a>404é¡µé¢</h3><p>è®¾ç½®è‡ªå®šä¹‰çš„404é¡µé¢</p>
<p>å…¶ä»–è¿˜æœ‰å¾ˆå¤šå¯ä»¥é…ç½®çš„å¦‚è¯„è®ºç³»ç»Ÿ,ç»Ÿè®¡ç³»ç»Ÿ.</p>
<h3 id="æ–‡ç« æ‘˜è¦"><a href="#æ–‡ç« æ‘˜è¦" class="headerlink" title="æ–‡ç« æ‘˜è¦"></a>æ–‡ç« æ‘˜è¦</h3><p>å®˜æ–¹çš„æ¨è:åœ¨æ–‡ç« ä¸­ä½¿ç”¨ <code>&lt;!-- more --&gt;</code> æ‰‹åŠ¨è¿›è¡Œæˆªæ–­.å»ºè®®ä½¿ç”¨ <code>&lt;!-- more --&gt;</code>ï¼ˆå³ç¬¬ä¸€ç§æ–¹å¼ï¼‰ï¼Œé™¤äº†å¯ä»¥ç²¾ç¡®æ§åˆ¶éœ€è¦æ˜¾ç¤ºçš„æ‘˜å½•å†…å®¹ä»¥å¤–ï¼Œ è¿™ç§æ–¹å¼ä¹Ÿå¯ä»¥è®© Hexo ä¸­çš„æ’ä»¶æ›´å¥½çš„è¯†åˆ«ã€‚</p>
<p>ä¸è¿‡ä»¥å‰çš„æ–‡ç« ä¹Ÿä¸å¯èƒ½ä¸€ä¸€è®¾ç½®,å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„è‡ªåŠ¨è®¾ç½®.</p>
<p>è‡ªåŠ¨ç”Ÿæˆæ‘˜è¦çš„æ’ä»¶:</p>
<p><a href="https://github.com/chekun/hexo-excerpt">Automatic excerpt generator for Hexo</a></p>
<p>å®‰è£…:<code>npm install hexo-excerpt --save</code></p>
<h3 id="RSSè®¢é˜…"><a href="#RSSè®¢é˜…" class="headerlink" title="RSSè®¢é˜…"></a>RSSè®¢é˜…</h3><p>å®‰è£…æ’ä»¶:</p>
<p><code>npm install hexo-generator-feed --save</code></p>
<p>ç„¶ååœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶socialä¸€æ ä¸­æ–°å¢ä¸€è¡Œ<code>RSS: /atom.xml || rss</code>,å°±å¯ä»¥è®©rssæ˜¾ç¤ºåœ¨ä¾§è¾¹æ äº†.æ³¨æ„ä¸æ˜¯<code>follow_me:</code>é‚£é‡Œ(è¿™é‡Œå¼€å§‹æ—¶æ²¡æ˜ç™½,å¾ˆå¤šæ–‡ç« å†™çš„ä¹Ÿä¸æ˜¯å¾ˆæ¸…æ¥š,æµªè´¹äº†ä¸ªæŠŠå°æ—¶).</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Social Links</span></span><br><span class="line"><span class="comment"># Usage: `Key: permalink || icon`</span></span><br><span class="line"><span class="comment"># Key is the link label showing to end users.</span></span><br><span class="line"><span class="comment"># Value before `||` delimiter is the target permalink, value after `||` delimiter is the name of Font Awesome icon.</span></span><br><span class="line"><span class="attr">social:</span></span><br><span class="line">  <span class="attr">GitHub:</span> <span class="string">https://github.com/xq-120</span> <span class="string">||</span> <span class="string">github</span></span><br><span class="line">  <span class="comment">#E-Mail: mailto:yourname@gmail.com || envelope</span></span><br><span class="line">  <span class="comment">#Weibo: https://weibo.com/yourname || weibo</span></span><br><span class="line">  <span class="comment">#Google: https://plus.google.com/yourname || google</span></span><br><span class="line">  <span class="comment">#Twitter: https://twitter.com/yourname || twitter</span></span><br><span class="line">  <span class="comment">#FB Page: https://www.facebook.com/yourname || facebook</span></span><br><span class="line">  <span class="attr">StackOverflow:</span> <span class="string">https://stackoverflow.com/yourname</span> <span class="string">||</span> <span class="string">stack-overflow</span></span><br><span class="line">  <span class="comment">#YouTube: https://youtube.com/yourname || youtube</span></span><br><span class="line">  <span class="comment">#Instagram: https://instagram.com/yourname || instagram</span></span><br><span class="line">  <span class="comment">#Skype: skype:yourname?call|chat || skype</span></span><br><span class="line">  <span class="attr">RSS:</span> <span class="string">/atom.xml</span> <span class="string">||</span> <span class="string">rss</span></span><br></pre></td></tr></table></figure>
<h3 id="ä»£ç é«˜äº®"><a href="#ä»£ç é«˜äº®" class="headerlink" title="ä»£ç é«˜äº®"></a>ä»£ç é«˜äº®</h3><p>åæ§½ä¸€ç‚¹,è¦æƒ³OCä»£ç é«˜äº®éœ€è¦å†™objc,ä¸èƒ½å†™objective-c,å¦åˆ™ä¸ä¼šé«˜äº®æ¸²æŸ“.æˆ‘ä½›äº†,è¿˜ä»¥ä¸ºé…ç½®æœ‰é—®é¢˜å¿™æ´»åŠå¤©.</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;```objc&quot;</span></span><br><span class="line"><span class="type">signed</span> <span class="type">char</span> rs = <span class="number">240</span>;</span><br><span class="line"><span class="type">BOOL</span> rs1 = <span class="number">240</span>;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;%d %d&quot;</span>, rs, rs1);</span><br><span class="line"><span class="string">&quot;```&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>é»˜è®¤npmå®‰è£…çš„åŒ…åœ¨node_modulesæ–‡ä»¶å¤¹é‡Œï¼Œå…¨å±€çš„åŒ…å®‰è£…åœ¨ <code>~/.nvm/versions/node/v22.13.0/lib</code> ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://cuiqingcai.com/7625.html">åˆ©ç”¨ GitHub + Hexo + Next ä»é›¶æ­å»ºä¸€ä¸ªåšå®¢</a></p>
<p><a href="https://blog.csdn.net/u011475210/article/details/79023429">æˆ‘çš„ä¸ªäººåšå®¢ä¹‹æ—…ï¼šä»jekyllåˆ°hexo</a></p>
<p><a href="https://theme-next.iissnan.com/">nexté…ç½®å®˜æ–¹è¯´æ˜</a></p>
<p><a href="https://notes.iissnan.com/">nextä½œè€…åšå®¢</a></p>
<p><a href="https://guanqr.com/tech/website/hexo-theme-next-customization/">Hexo-NexT ä¸»é¢˜ä¸ªæ€§ä¼˜åŒ–</a>:è¿™ä¸ªå¾ˆè¯¦ç»†.</p>
<p><a href="[https://strivebo.com/2019/02/17/%E7%AF%87%E2%85%A1%EF%BC%9ANexT%E4%B8%BB%E9%A2%98%E7%9A%84%E9%85%8D%E7%BD%AE%E5%92%8C%E4%BC%98%E5%8C%96%E6%8C%87%E5%8D%97/](https://strivebo.com/2019/02/17/ç¯‡â…¡ï¼šNexTä¸»é¢˜çš„é…ç½®å’Œä¼˜åŒ–æŒ‡å—/">ç¯‡â…¡ï¼šNexTä¸»é¢˜çš„é…ç½®å’Œä¼˜åŒ–æŒ‡å—</a>)</p>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
  </entry>
  <entry>
    <title>æ¸…ç†ä½ çš„Xcode</title>
    <url>/2020/02/27/%E6%B8%85%E7%90%86%E4%BD%A0%E7%9A%84Xcode/</url>
    <content><![CDATA[<p>Xcodeç”¨ä¹…äº†åä¼šäº§ç”Ÿå¾ˆå¤šç¼“å­˜æ–‡ä»¶,è¿™äº›æ–‡ä»¶ä¼šå ç”¨å¾ˆå¤§çš„ç£ç›˜ç©ºé—´.</p>
<p>ä¸‹é¢åˆ—ä¸¾çš„æ˜¯ä¸€äº›å¯ä»¥åˆ é™¤çš„æ–‡ä»¶ç›®å½•.</p>
<ol>
<li><p><code>~/Library/Developer/Xcode/DerivedData</code>   </p>
<p>ä¸€äº›ä¸­é—´ç¼–è¯‘ä¿¡æ¯æ–‡ä»¶å’Œdebug/release ç¼–è¯‘ç”Ÿæˆçš„ targets.åˆ é™¤åä¼šé‡æ–°åˆ›å»º.è¿™é‡Œæ¸…ç†åè…¾å‡ºäº†7.81G </p>
</li>
<li><p><code>~/Library/Developer/Xcode/iOS DeviceSupport</code>  </p>
<p>æˆ‘ä»¬æ¯æ¬¡è¿ä¸Šæ–°è®¾å¤‡æ—¶çš„ã€Processing symbol filesã€å°±æ˜¯åœ¨å‘è¯¥æ–‡ä»¶å¤¹å†™å…¥æ–‡ä»¶ã€‚åˆ é™¤å,å†æ¬¡è¿ä¸Šæ‰‹æœºæ—¶ä¼šé‡æ–°åˆ›å»º.è¿™é‡Œæ¸…ç†åè…¾å‡ºäº†8.68G</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/Xcodeæ¸…ç†_DeviceSupport.png" alt="Xcodeæ¸…ç†_DeviceSupport"></p>
</li>
<li><p><code>~/Library/Developer/CoreSimulator</code>  </p>
<p>Apps åœ¨æ¨¡æ‹Ÿå™¨ä¸­çš„å­˜å‚¨æ–‡æ¡£çš„ä½ç½®.è¿™é‡Œæ¸…ç†åè…¾å‡ºäº†13.92G</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/Xcodeæ¸…ç†_CoreSimulator.png" alt="Xcodeæ¸…ç†_CoreSimulator"></p>
</li>
<li><p><code>/Library/Developer/CoreSimulator/Profiles/Runtimes</code></p>
<p>æ¨¡æ‹Ÿå™¨æ–‡ä»¶è·¯å¾„.é‡Œé¢æ˜¯ä¸‹è½½çš„å…¶ä»–ç‰ˆæœ¬çš„æ¨¡æ‹Ÿå™¨æ–‡ä»¶.å¯ä»¥åˆ é™¤ä¸€äº›ä½ç‰ˆæœ¬çš„æ¨¡æ‹Ÿå™¨.è¿™é‡Œæ¸…ç†åè…¾å‡ºäº†9.6G</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/å…¶ä»–ç‰ˆæœ¬æ¨¡æ‹Ÿå™¨æ–‡ä»¶è·¯å¾„.png" alt="å…¶ä»–ç‰ˆæœ¬æ¨¡æ‹Ÿå™¨æ–‡ä»¶è·¯å¾„"></p>
</li>
<li><p><code>~/Library/Developer/Xcode/Archives</code>   </p>
<p>å½’æ¡£é¡¹ç›®çš„å­˜å‚¨ä½ç½®.åˆ é™¤å‰ç¡®ä¿æœ‰ç”¨çš„Archiveå·²ç»å¤‡ä»½,å› ä¸ºåˆ†æçº¿ä¸Šå´©æºƒæ—¥å¿—éœ€è¦Archiveæ–‡ä»¶é‡Œçš„ä¸€äº›ä¸œè¥¿.</p>
</li>
</ol>
<p>å…¶ä»–ä¸€äº›ç¼“å­˜ç›®å½•ï¼š</p>
<p>ç³»ç»Ÿç¼“å­˜ä¿å­˜åœ¨ï¼š~/Library/Caches  ï¼ˆæŒ‰éœ€åˆ é™¤ï¼‰</p>
<p>ç³»ç»Ÿæ—¥å¿—ä¿å­˜åœ¨ï¼š~/Library/Logs</p>
<p>æ­¤å¤–ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤ï¼šâ€œsudo du -sh * â€æŸ¥çœ‹å½“å‰æ–‡ä»¶å¤¹ä¸‹å„ä¸ªæ–‡ä»¶å’Œæ–‡ä»¶å¤¹å ç”¨çš„ç©ºé—´å¤§å°ï¼Œè¿›è€Œä¸€æ­¥æ­¥æ‰¾åˆ°å ç”¨ç£ç›˜ç©ºé—´è¾ƒå¤šçš„æ–‡ä»¶ã€‚</p>
]]></content>
      <categories>
        <category>Xcode</category>
      </categories>
  </entry>
  <entry>
    <title>iOSå›¾ç‰‡çš„ç¼©æ”¾</title>
    <url>/2020/02/06/iOS%E5%9B%BE%E7%89%87%E7%9A%84%E7%BC%A9%E6%94%BE/</url>
    <content><![CDATA[<p>åœ¨ä¸€äº›æƒ…å†µä¸‹éœ€è¦å¯¹å›¾ç‰‡è¿›è¡Œç¼©æ”¾æ“ä½œ.æ¯”å¦‚ä½¿ç”¨iPhone6 Plusæ‹ç…§å¾—åˆ°çš„å°†æ˜¯ä¸€å¼ 2448x3264çš„å›¾ç‰‡,è¿™ä¹ˆå¤§åˆ†è¾¨ç‡çš„å›¾ç‰‡å·²ç»è¿œè¿œè¶…è¿‡äº†æ‰‹æœºæ˜¾ç¤ºå±çš„åˆ†è¾¨ç‡äº†,å¦‚æœç›´æ¥åŠ è½½åˆ°å†…å­˜ä¼šå ç”¨å¾ˆå¤§çš„ç©ºé—´,è¿™æ˜¾ç„¶æ˜¯ä¸€ç§æµªè´¹.è¿™ä¸ªæ—¶å€™å°±éœ€è¦ç­‰æ¯”ä¾‹ç¼©æ”¾å›¾ç‰‡ä»¥å‡å°å›¾ç‰‡åˆ†è¾¨ç‡.ä¸€èˆ¬æƒ…å†µä¸‹,å³æ—¶èŠå¤©é¡µé¢ç”¨æˆ·å‘é€çš„å›¾ç‰‡éƒ½ä¼šç»è¿‡åˆ†è¾¨ç‡å‹ç¼©å’Œä½“ç§¯å‹ç¼©åæ‰ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨.</p>
<p>ç”±äºå›¾ç‰‡çš„å¤§å°å’Œç›®æ ‡å¤§å°æ¯”ä¾‹å¯èƒ½ä¸ä¸€è‡´,å› æ­¤ç­‰æ¯”ä¾‹ç¼©æ”¾å›¾ç‰‡åˆ°ç›®æ ‡å°ºå¯¸æœ‰ä¸¤ç§å¡«å……æ–¹å¼:</p>
<p><strong>1.ç­‰æ¯”ä¾‹å¡«æ»¡ç›®æ ‡å¤§å°,å›¾ç‰‡å¯èƒ½å‘ç”Ÿè£å‰ª</strong></p>
<p>ä¸¤ç§æƒ…å†µ:</p>
<p>1.å›¾ç‰‡ä¸ç›®æ ‡å¤§å°å®½é«˜æ¯”ä¸€è‡´.</p>
<p>ç”±äºä¸ç›®æ ‡å¤§å°å®½é«˜æ¯”ä¸€è‡´,å›¾ç‰‡ç¼©æ”¾åä¼šæ°å¥½å¡«æ»¡æ•´ä¸ªç›®æ ‡å¤§å°,å›¾ç‰‡ä¸ä¼šå‘ç”Ÿè£å‰ª.</p>
<p>2.å›¾ç‰‡ä¸ç›®æ ‡å¤§å°å®½é«˜æ¯”ä¸ä¸€è‡´.</p>
<p>ç”±äºä¸ç›®æ ‡å¤§å°å®½é«˜æ¯”ä¸ä¸€è‡´,å›¾ç‰‡ç¼©æ”¾åä¼šè¶…å‡ºç›®æ ‡å¤§å°,å› æ­¤å›¾ç‰‡ä¼šå‘ç”Ÿè£å‰ª.</p>
<p>è¿™é‡Œåˆåˆ†ä¸ºä¸¤ç§æƒ…å†µ:</p>
<p>prate &lt; drate,å›¾ç‰‡ä¼šåœ¨yè½´å‘ç”Ÿè£å‰ª.</p>
<p>prate &gt; drate,å›¾ç‰‡ä¼šåœ¨xè½´å‘ç”Ÿè£å‰ª.</p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="http://m.qpic.cn/psc?/V1266oZg2CElNW/7o.xLwnHK.dZGyBaILrm9x8SHkc6Arj9o6cetKd7mYvokii*NVEUmq*onzjmLHZjLt.n1LKXB7MdsSoPvnlUakgsaGsU5WGJhixm4zx0eCs!/b&bo=ngSqAwAAAAADZ3E!&rf=viewer_4" alt="ç­‰æ¯”ä¾‹å¡«æ»¡" align="bottom" width="300" height="238" /></p>
<p>108*108</p>
<p>(CGSize) targetSize = (width = 81, height = 162)</p>
<p>(CGRect) rect = (origin = (x = -40.5, y = 0), size = (width = 162, height = 162))</p>
<p><strong>2.ç­‰æ¯”ä¾‹é€‚åº”ç›®æ ‡å¤§å°,å›¾ç‰‡å¯èƒ½ä¼šæœ‰ç©ºç™½éƒ¨åˆ†</strong></p>
<p>ä¸¤ç§æƒ…å†µ:</p>
<p>1.å›¾ç‰‡ä¸ç›®æ ‡å¤§å°å®½é«˜æ¯”ä¸€è‡´.</p>
<p>ç”±äºä¸ç›®æ ‡å¤§å°å®½é«˜æ¯”ä¸€è‡´,å›¾ç‰‡ç¼©æ”¾åä¼šæ°å¥½å¡«æ»¡æ•´ä¸ªç›®æ ‡å¤§å°,å›¾ç‰‡ä¸ä¼šæœ‰ç©ºç™½éƒ¨åˆ†.</p>
<p>2.å›¾ç‰‡ä¸ç›®æ ‡å¤§å°å®½é«˜æ¯”ä¸ä¸€è‡´.</p>
<p>ç”±äºä¸ç›®æ ‡å¤§å°å®½é«˜æ¯”ä¸ä¸€è‡´,å›¾ç‰‡ç¼©æ”¾åä¼šæœ‰ç©ºç™½éƒ¨åˆ†.</p>
<p>è¿™é‡Œåˆåˆ†ä¸ºä¸¤ç§æƒ…å†µ:</p>
<p>prate &lt; drate,å›¾ç‰‡ä¼šåœ¨xè½´äº§ç”Ÿç©ºç™½.</p>
<p>prate &gt; drate,å›¾ç‰‡ä¼šåœ¨yè½´äº§ç”Ÿç©ºç™½.</p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="http://m.qpic.cn/psc?/V1266oZg2CElNW/7o.xLwnHK.dZGyBaILrm9*kU6nfw39PIikWlllQzWPWFD7QaHyossY2yN9.bX3jksmDdE6kab7S7iQvvZ7abYT0LT3D*.8RAu9UTkPERrMo!/b&bo=IARqAwAAAAADB28!&rf=viewer_4" alt="ç­‰æ¯”ä¾‹é€‚åº”" align="bottom" width="300" height="238" /></p>
<p>108*108</p>
<p>(CGSize) targetSize = (width = 81, height = 162)</p>
<p>(CGRect) rect = (origin = (x = 0, y = 40.5), size = (width = 81, height = 81))</p>
<p>å®ç°:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// MARK: - ç¼©æ”¾å›¾ç‰‡</span><br><span class="line"></span><br><span class="line">typedef NS_ENUM(NSUInteger, ZAEImageScaleMode) &#123;</span><br><span class="line">    ZAEImageScaleModeFill = 0, //å¡«æ»¡</span><br><span class="line">    ZAEImageScaleModeAspectFit = 1, //ç­‰æ¯”ä¾‹é€‚åº”</span><br><span class="line">    ZAEImageScaleModeAspectFill = 2 //ç­‰æ¯”ä¾‹å¡«æ»¡</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">ç¼©æ”¾å›¾ç‰‡.è¿”å›çš„å›¾ç‰‡çš„scaleä¸ºå±å¹•scale.</span><br><span class="line"></span><br><span class="line">@param image åŸå§‹å›¾ç‰‡</span><br><span class="line">@param targetSize ç›®æ ‡å°ºå¯¸</span><br><span class="line">@param scaleMode ç¼©æ”¾æ¨¡å¼</span><br><span class="line">@return ç¼©æ”¾åçš„å›¾ç‰‡.</span><br><span class="line">*/</span><br><span class="line">+ (UIImage *)za_resizeImage:(UIImage *)image targetSize:(CGSize)targetSize scaleMode:(ZAEImageScaleMode)scaleMode;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">ç¼©æ”¾å›¾ç‰‡.</span><br><span class="line"></span><br><span class="line">@param image åŸå§‹å›¾ç‰‡</span><br><span class="line">@param targetSize ç›®æ ‡å°ºå¯¸</span><br><span class="line">@param scale ç›®æ ‡scale.[1,å±å¹•scale]</span><br><span class="line">@param scaleMode ç¼©æ”¾æ¨¡å¼</span><br><span class="line">@return ç¼©æ”¾åçš„å›¾ç‰‡.</span><br><span class="line">*/</span><br><span class="line">+ (UIImage *)za_resizeImage:(UIImage *)image targetSize:(CGSize)targetSize scale:(CGFloat)scale scaleMode:(ZAEImageScaleMode)scaleMode;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">+ (UIImage *)za_resizeImage:(UIImage *)image targetSize:(CGSize)targetSize scaleMode:(ZAEImageScaleMode)scaleMode</span><br><span class="line">&#123;</span><br><span class="line">    return [UIImage za_resizeImage:image targetSize:targetSize scale:[UIScreen mainScreen].scale scaleMode:scaleMode];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (UIImage *)za_resizeImage:(UIImage *)image targetSize:(CGSize)targetSize scale:(CGFloat)scale scaleMode:(ZAEImageScaleMode)scaleMode</span><br><span class="line">&#123;</span><br><span class="line">    if (targetSize.width &lt;= 0 || targetSize.height &lt;= 0 || image == nil) return nil;</span><br><span class="line">    </span><br><span class="line">    if (scale &lt; 1) &#123;</span><br><span class="line">        scale = 1;</span><br><span class="line">    &#125;</span><br><span class="line">    if (scale &gt; [UIScreen mainScreen].scale) &#123;</span><br><span class="line">        scale = [UIScreen mainScreen].scale;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    UIGraphicsBeginImageContextWithOptions(targetSize, NO, scale);</span><br><span class="line">    CGRect rect = [self CGRectFitWithRect:CGRectMake(0, 0, targetSize.width, targetSize.height) size:image.size scaleMode:scaleMode]; </span><br><span class="line">    [image drawInRect:rect];</span><br><span class="line">    UIImage *newImage = UIGraphicsGetImageFromCurrentImageContext();</span><br><span class="line">    if(newImage == nil) &#123;</span><br><span class="line">        NSLog(@&quot;scale image fail&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    UIGraphicsEndImageContext();</span><br><span class="line">    return newImage;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">+ (CGRect)CGRectFitWithRect:(CGRect)rect size:(CGSize)size scaleMode:(ZAEImageScaleMode)scaleMode &#123;</span><br><span class="line">    rect = CGRectStandardize(rect);</span><br><span class="line">    size.width = size.width &lt; 0 ? -size.width : size.width;</span><br><span class="line">    size.height = size.height &lt; 0 ? -size.height : size.height;</span><br><span class="line">    CGPoint center = CGPointMake(CGRectGetMidX(rect), CGRectGetMidY(rect));</span><br><span class="line">    switch (scaleMode) &#123;</span><br><span class="line">        case ZAEImageScaleModeAspectFit:</span><br><span class="line">        case ZAEImageScaleModeAspectFill: &#123;</span><br><span class="line">            if (rect.size.width &lt; 0.01 || rect.size.height &lt; 0.01 ||</span><br><span class="line">                size.width &lt; 0.01 || size.height &lt; 0.01) &#123;</span><br><span class="line">                rect.origin = center;</span><br><span class="line">                rect.size = CGSizeZero;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                CGFloat scale;</span><br><span class="line">                if (scaleMode == ZAEImageScaleModeAspectFit) &#123;</span><br><span class="line">                    if (size.width / size.height &lt; rect.size.width / rect.size.height) &#123; //å›¾ç‰‡å®½ä¸å¤Ÿ</span><br><span class="line">                        scale = rect.size.height / size.height; //æ‹‰ä¼¸é«˜</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        scale = rect.size.width / size.width;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    if (size.width / size.height &lt; rect.size.width / rect.size.height) &#123; //å›¾ç‰‡å®½ä¸å¤Ÿ</span><br><span class="line">                        scale = rect.size.width / size.width; //æ‹‰ä¼¸å®½</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        scale = rect.size.height / size.height;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                size.width *= scale;</span><br><span class="line">                size.height *= scale;</span><br><span class="line">                rect.size = size;</span><br><span class="line">                rect.origin = CGPointMake(center.x - size.width * 0.5, center.y - size.height * 0.5);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; break;</span><br><span class="line">        case ZAEImageScaleModeFill:</span><br><span class="line">        default: &#123;</span><br><span class="line">            rect = rect;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return rect;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>å›¾ç‰‡å¤„ç†</category>
      </categories>
  </entry>
  <entry>
    <title>å…³äºå£ç½©çš„å‡ ç‚¹æ„è§å’Œå»ºè®®</title>
    <url>/2020/02/02/%E5%85%B3%E4%BA%8E%E5%8F%A3%E7%BD%A9%E7%9A%84%E5%87%A0%E7%82%B9%E6%84%8F%E8%A7%81%E5%92%8C%E5%BB%BA%E8%AE%AE/</url>
    <content><![CDATA[<h3 id="å£ç½©ç±»å‹"><a href="#å£ç½©ç±»å‹" class="headerlink" title="å£ç½©ç±»å‹"></a>å£ç½©ç±»å‹</h3><p>çº¸å£ç½©,æ´»æ€§ç‚­å£ç½©,æ£‰å¸ƒå£ç½©,æµ·ç»µå£ç½©.è¿™äº›å£ç½©å› æè´¨ä¸å¤Ÿç´§å¯†,æ— æ³•èµ·åˆ°é˜²ç—…æ¯’çš„æ•ˆæœ.</p>
<p>èƒ½é˜²ç—…æ¯’çš„æœ‰:ä¸€æ¬¡æ€§åŒ»ç”¨å£ç½©,åŒ»ç”¨å¤–ç§‘å£ç½©,<strong>N95</strong>å£ç½©å’Œ<strong>N95</strong>åŒ»ç”¨é˜²æŠ¤å£ç½©ã€‚</p>
<p>é’Ÿå—å±±é™¢å£«çš„å»ºè®®æ˜¯:å¹¶ä¸ä¸€å®šéè¦æˆ´ N95ï¼Œå› ä¸ºè¿™äº›ç—…æ¯’å®é™…ä¸Šä¸æ˜¯å•ç‹¬çš„å­˜åœ¨ï¼Œå®ƒå¸¸å¸¸å­˜åœ¨åœ¨é£æ²«ä¸­ï¼Œä¸€èˆ¬çš„å£ç½©ã€å¤–ç§‘å£ç½©ç­‰ç­‰è¿™äº›è¿˜æ˜¯èƒ½å¤Ÿé˜» æŒ¡å¤§éƒ¨åˆ†å¸¦ç€é£æ²«çš„ç—…æ¯’è¿›å…¥å‘¼å¸é“ã€‚å¦‚æœæ˜¯å»ä¸€èˆ¬éœ²å¤©å…¬å…±åœºæ‰€ã€ä¸ä¸ç—…äººæ¥è§¦ï¼Œå¯ä»¥é€‰æ‹©ä½©æˆ´åŒ»ç”¨å¤–ç§‘å£ç½©ï¼Œä¸å¿…è¿‡åº¦é˜²æŠ¤ï¼Œä½†å¦‚æœä¼šæ¥è§¦ç–‘ä¼¼å‘¼å¸é“æ„ŸæŸ“çš„ç—…äººï¼Œåˆ™è¦ä½©æˆ´ N95 å‹å£ç½©ã€‚</p>
<h4 id="åŒ»ç”¨å¤–ç§‘å£ç½©"><a href="#åŒ»ç”¨å¤–ç§‘å£ç½©" class="headerlink" title="åŒ»ç”¨å¤–ç§‘å£ç½©"></a>åŒ»ç”¨å¤–ç§‘å£ç½©</h4><p>å¯é˜»æŒ¡è¡€æ¶²ã€ä½“æ¶²ç©¿è¿‡å£ç½©,èƒ½åœ¨ä¸€å®šç¨‹åº¦ä¸Šé¢„é˜²å‘¼å¸é“æ„ŸæŸ“.<br>è´­ä¹°è¿™ä¸€ç±»å£ç½©è¦æ³¨æ„åŒ…è£…ä¸Šä¼šæœ‰â€œå¤–ç§‘åŒ»ç”¨å£ç½©â€æˆ–è€…æ˜¯æ ‡å‡†ä¸ºYY-0469-2011.</p>
<blockquote>
<p> åŒ»ç”¨å¤–ç§‘å£ç½©çœŸå‡é‰´å®š</p>
</blockquote>
<p>å¦‚æœæ²¡æœ‰æ ‡æ³¨â€œåŒ»ç”¨å¤–ç§‘å£ç½©â€çš„å°±åˆ«ä¹°,<br>åœ¨â€œ<a href="http://www.nmpa.gov.cn/WS04/CL2042/">å›½å®¶è¯å“ç›‘ç£ç®¡ç†å±€</a>â€æœç´¢å£ç½©çš„æ¢°æ³¨å‡†å­—å·,è¯¥å­—å·ä¸‹çš„äº§å“è§„æ ¼ã€æ‰¹å‡†æ—¥æœŸã€æœ‰æ•ˆæ—¥æœŸç­‰éƒ½èƒ½è¢«æŸ¥åˆ°.</p>
<h4 id="N95å‹å£ç½©"><a href="#N95å‹å£ç½©" class="headerlink" title="N95å‹å£ç½©"></a>N95å‹å£ç½©</h4><p>N95å¹¶ä¸æ˜¯ç‰¹å®šçš„ç‰Œå­,N95å‹å£ç½©æ˜¯NIOSHï¼ˆç¾å›½å›½å®¶èŒä¸šå®‰å…¨å«ç”Ÿç ”ç©¶æ‰€ï¼ŒNational Institute for Occupational Safety and Healthï¼‰è®¤è¯çš„9ç§é¢—ç²’ç‰©é˜²æŠ¤å£ç½©ä¸­çš„ä¸€ç§ã€‚â€œNâ€è¡¨ç¤ºä¸è€æ²¹ï¼ˆnot resistant to oilï¼‰ã€‚â€œ95â€è¡¨ç¤ºæš´éœ²åœ¨è§„å®šæ•°é‡çš„ä¸“ç”¨è¯•éªŒç²’å­ä¸‹ï¼Œå£ç½©å†…çš„ç²’å­æµ“åº¦è¦æ¯”å£ç½©å¤–ç²’å­æµ“åº¦ä½95%ä»¥ä¸Šã€‚å…¶ä¸­95%è¿™ä¸€æ•°å€¼ä¸æ˜¯å¹³å‡å€¼ï¼Œè€Œæ˜¯æœ€å°å€¼ã€‚N95ä¸æ˜¯ç‰¹å®šçš„äº§å“åç§°ï¼Œåªè¦ç¬¦åˆN95æ ‡å‡†ï¼Œå¹¶ä¸”é€šè¿‡NIOSHå®¡æŸ¥çš„äº§å“å°±å¯ä»¥ç§°ä¸ºâ€œN95å‹å£ç½©â€ã€‚é˜²æŠ¤ç­‰çº§ä¸ºN95çº§è¡¨ç¤ºåœ¨NIOSHæ ‡å‡†è§„å®šçš„æ£€æµ‹æ¡ä»¶ä¸‹ï¼Œå£ç½©æ»¤æ–™å¯¹éæ²¹æ€§é¢—ç²’ç‰©ï¼ˆå¦‚ç²‰å°˜ã€é…¸é›¾ã€æ¼†é›¾ã€å¾®ç”Ÿç‰©ç­‰ï¼‰çš„è¿‡æ»¤æ•ˆç‡è¾¾åˆ°95%ã€‚</p>
<p>NIOSHè®¤è¯çš„å…¶ä»–é˜²é¢—ç²’ç‰©å£ç½©çº§åˆ«è¿˜åŒ…æ‹¬ï¼šN95ã€N99ã€N100ã€R95ã€R99ã€R100ã€P95ã€P99ã€P100ï¼Œå…±9ç§ã€‚è¿™äº›é˜²æŠ¤çº§åˆ«éƒ½èƒ½å¤Ÿè¦†ç›–N95çš„é˜²æŠ¤èŒƒå›´ã€‚<br>â€œNâ€è¡¨ç¤ºä¸è€æ²¹ï¼ˆnot resistant to oilï¼‰ï¼Œé€‚åˆéæ²¹æ€§é¢—ç²’ç‰©ã€‚<br>â€œRâ€è¡¨ç¤ºè€æ²¹ï¼ˆresistant to oilï¼‰ï¼Œé€‚åˆæ²¹æ€§æˆ–éæ²¹æ€§é¢—ç²’ç‰©ï¼Œè‹¥ç”¨äºæ²¹æ€§é¢—ç²’ç‰©çš„é˜²æŠ¤ï¼Œä½¿ç”¨æ—¶é—´ä¸è¶…è¿‡8å°æ—¶ã€‚<br>â€œPâ€è¡¨ç¤ºé˜²æ²¹ï¼ˆoil proofï¼‰ï¼Œé€‚åˆæ²¹æ€§æˆ–éæ²¹æ€§é¢—ç²’ç‰©ï¼Œè‹¥ç”¨äºæ²¹æ€§é¢—ç²’ç‰©ï¼Œä½¿ç”¨æ—¶é—´åº”éµå¾ªåˆ¶é€ å•†çš„å»ºè®®ã€‚<br>â€œ95â€ã€â€œ99â€å’Œâ€œ100â€æ˜¯æŒ‡ç”¨0.3å¾®ç±³é¢—ç²’è¿›è¡Œæµ‹è¯•æ—¶çš„è¿‡æ»¤æ•ˆç‡æ°´å¹³ã€‚â€œ95â€è¡¨ç¤ºè¿‡æ»¤æ•ˆç‡åœ¨95%ä»¥ä¸Šï¼Œâ€œ99â€è¡¨ç¤ºè¿‡æ»¤æ•ˆç‡åœ¨99%ä»¥ä¸Šï¼Œâ€œ100â€è¡¨ç¤ºè¿‡æ»¤æ•ˆç‡åœ¨99.7%ä»¥ä¸Šã€‚</p>
<blockquote>
<p> N95å’ŒKN95çš„åŒºåˆ«</p>
</blockquote>
<p>N95æ˜¯ç¾å›½NIOSHåˆ¶å®šçš„æ ‡å‡†,è€ŒKN95æ˜¯ä¸­å›½æ ‡å‡†å’ŒN95å‡ ä¹æ˜¯ä¸€æ ·çš„.è¿˜æœ‰å…¶ä»–çš„ä¸€äº›æ ‡å‡†æ¯”å¦‚æ—¥æœ¬DS2ã€æ¬§æ´²FFP2æ ‡å‡†ç­‰éƒ½å’ŒN95å£ç½©ç›¸å½“.åœ¨ä¹°ä¸åˆ°N95çš„æƒ…å†µä¸‹,KN90ä¹Ÿæ˜¯å¯ä»¥çš„,åªæ˜¯è¿‡æ»¤æ•ˆç‡æ¯”è¾ƒä½ä¸€ç‚¹ä½†ä¹Ÿæ˜¯æœ‰ç”¨çš„.</p>
<blockquote>
<p>N95å‹å£ç½©çœŸå‡é‰´å®š</p>
</blockquote>
<p>æ‰€æœ‰ NIOSH-Approved N95å£ç½©å“ ç‰Œå’Œå‹å·åœ¨ CDC è¿™ä¸ªç½‘é¡µ (<a href="https://www.cdc.gov/niosh/npptl/topics/respirators/disp_part/n95list1.html)ã€‚å¤§å®¶è´­ä¹°æ—¶æœç´¢ä¸€ä¸‹è¯¥äº§å“æœ‰æ²¡æœ‰åœ¨">https://www.cdc.gov/niosh/npptl/topics/respirators/disp_part/n95list1.html)ã€‚å¤§å®¶è´­ä¹°æ—¶æœç´¢ä¸€ä¸‹è¯¥äº§å“æœ‰æ²¡æœ‰åœ¨</a> CDC çš„ åå•ä¸Šã€‚</p>
<p>æ­£è§„å‚å®¶çš„ N95 å£ç½©ï¼Œæ¯ä¸€ä¸ªå£ç½©ä¸Šé¢éƒ½åº”è¯¥æœ‰å¦‚ä¸‹æ ‡è¯†:</p>
<p>NIOSH è®¤å¯çš„åˆ¶é€ å•†åå­—æˆ–æ³¨å†Œå•†æ ‡ã€‚</p>
<p>å¤§å†™ NIOSH å­—æ¯æˆ– Logoã€‚</p>
<p>NIOSH æµ‹è¯•å’Œè®¤è¯æ‰¹å‡†å·ï¼Œä¾‹å¦‚ TC-84A-XXXXã€‚</p>
<p>NIOSH è¿‡æ»¤å™¨ç³»åˆ—å’Œè¿‡æ»¤å™¨æ•ˆç‡ç­‰çº§ï¼Œä¾‹å¦‚ N95ï¼ŒN99ï¼ŒN100ï¼ŒR95ï¼Œ P95ï¼ŒP99ï¼ŒP100ã€‚</p>
<p>å£ç½©å‹å·ï¼Œå¦‚ 9010ã€1860ã€‚</p>
<h4 id="ä½¿ç”¨æ³¨æ„äº‹é¡¹"><a href="#ä½¿ç”¨æ³¨æ„äº‹é¡¹" class="headerlink" title="ä½¿ç”¨æ³¨æ„äº‹é¡¹"></a>ä½¿ç”¨æ³¨æ„äº‹é¡¹</h4><ol>
<li>æˆ´å£ç½©å‰åº”æ´—æ‰‹ï¼Œæˆ–è€…åœ¨æˆ´å£ç½©è¿‡ç¨‹ä¸­é¿å…æ‰‹æ¥è§¦åˆ°å£ç½©å†…ä¾§é¢ï¼Œå‡å°‘å£ç½©è¢«æ±¡æŸ“çš„å¯èƒ½ã€‚</li>
<li>åˆ†æ¸…æ¥šå£ç½©çš„å†…å¤–ã€ä¸Šä¸‹ã€‚</li>
<li>ä¸è¦ç”¨æ‰‹å»æŒ¤å‹å£ç½©ï¼ŒN95å£ç½©åªèƒ½æŠŠç—…æ¯’éš”ç¦»åœ¨å£ç½©è¡¨å±‚ï¼Œå¦‚æœç”¨æ‰‹æŒ¤å‹å£ç½©ï¼Œä½¿å¾—ç—…æ¯’éšé£æ²«æ¹¿é€å£ç½©ï¼Œå®¹æ˜“é€ æˆç—…æ¯’æ„ŸæŸ“ã€‚</li>
<li><strong>è¦å°½é‡ä½¿å£ç½©ä¸é¢éƒ¨æœ‰è‰¯å¥½çš„å¯†åˆ</strong>ã€‚ç®€å•çš„è¯•éªŒæ–¹æ³•æ˜¯ï¼šæˆ´ä¸Šå£ç½©åï¼Œç”¨åŠ›å‘¼æ°”ï¼Œç©ºæ°”ä¸èƒ½ä»å£ç½©è¾¹ç¼˜æ¼å‡ºã€‚</li>
<li>é˜²æŠ¤å£ç½©å¿…é¡»å’Œä½¿ç”¨è€…è„¸éƒ¨ç´§è´´ï¼Œä½¿ç”¨è€…å¿…é¡»åˆ®å‡€èƒ¡é¡»ï¼Œç¡®ä¿å£ç½©èƒ½å¤Ÿä¸è„¸éƒ¨å¯†åˆï¼Œèƒ¡é¡»ä»¥åŠå«åœ¨å£ç½©å¯†å°å«å’Œè„¸éƒ¨ä¹‹é—´çš„ä»»ä½•ä¸œè¥¿éƒ½ä¼šä½¿å£ç½©å‡ºç°æ³„æ¼ã€‚</li>
<li>æ ¹æ®è‡ªå·±çš„è„¸å‹è°ƒæ•´å¥½å£ç½©çš„ä½ç½®åï¼Œåº”ç”¨ä¸¤æ‰‹çš„é£ŸæŒ‡æ²¿ç€å£ç½©çš„ä¸Šç¼˜æŒ‰å‹é¼»å¤¹ï¼Œä½¿å®ƒä¸é¢éƒ¨ç´§è´´ ã€‚</li>
</ol>
<h4 id="æ›´æ¢å£ç½©"><a href="#æ›´æ¢å£ç½©" class="headerlink" title="æ›´æ¢å£ç½©"></a>æ›´æ¢å£ç½©</h4><p>ä¸€èˆ¬çš„å£ç½©å»ºè®®æ¯éš”2ï½4å°æ—¶æ¢ä¸€æ¬¡å£ç½©.</p>
<p>å½“å‡ºç°ä»¥ä¸‹æƒ…å†µæ—¶ï¼Œåº”åŠæ—¶æ›´æ¢å£ç½©ï¼š</p>
<ol>
<li>å‘¼å¸é˜»æŠ—æ˜æ˜¾å¢åŠ æ—¶ï¼›</li>
<li>å£ç½©æœ‰ç ´æŸæˆ–æŸåæ—¶ï¼›</li>
<li>å£ç½©ä¸é¢éƒ¨æ— æ³•å¯†åˆæ—¶ï¼›</li>
<li>å£ç½©å—æ±¡æŸ“ï¼ˆå¦‚æŸ“æœ‰è¡€æ¸æˆ–é£æ²«ç­‰å¼‚ç‰©æ—¶ï¼‰ï¼›</li>
<li>å£ç½©å·²è¢«æ±¡æŸ“ï¼ˆæ›¾ä½¿ç”¨äºä¸ªä¾‹ç—…æˆ¿æˆ–ç—…æ‚£æ¥è§¦ï¼‰ï¼›</li>
<li>è‹¥ä¸ºå«æœ‰æ´»æ€§ç‚­å£ç½©ï¼Œå£ç½©å†…æœ‰å¼‚å‘³æ—¶ï¼›</li>
<li>å£ç½©ä½¿ç”¨æ—¶é•¿è¶…è¿‡å»ºè®®æ—¶é•¿æ—¶ã€‚</li>
</ol>
]]></content>
      <categories>
        <category>Life</category>
      </categories>
  </entry>
  <entry>
    <title>Markdownæ›´æ”¹å›¾ç‰‡å¤§å°</title>
    <url>/2020/01/26/Markdown%E6%9B%B4%E6%94%B9%E5%9B%BE%E7%89%87%E5%A4%A7%E5%B0%8F/</url>
    <content><![CDATA[<h4 id="æ›´æ”¹å›¾ç‰‡é“¾æ¥ä¸Šçš„å®½å’Œé«˜-éœ€è¦æœåŠ¡å™¨æ”¯æŒ"><a href="#æ›´æ”¹å›¾ç‰‡é“¾æ¥ä¸Šçš„å®½å’Œé«˜-éœ€è¦æœåŠ¡å™¨æ”¯æŒ" class="headerlink" title="æ›´æ”¹å›¾ç‰‡é“¾æ¥ä¸Šçš„å®½å’Œé«˜(éœ€è¦æœåŠ¡å™¨æ”¯æŒ)"></a>æ›´æ”¹å›¾ç‰‡é“¾æ¥ä¸Šçš„å®½å’Œé«˜(éœ€è¦æœåŠ¡å™¨æ”¯æŒ)</h4><p>åŸå§‹å›¾åƒ:</p>
<p><code>![loading.png](http://upload-images.jianshu.io/upload_images/1503319-c696a9cd1495d68f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)</code></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1503319-c696a9cd1495d68f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="loading.png"></p>
<p>æ›´æ”¹å¤§å°:</p>
<p><code>![loading.png](http://upload-images.jianshu.io/upload_images/1503319-c696a9cd1495d68f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/200)</code></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1503319-c696a9cd1495d68f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/200" alt="loading.png">  </p>
<p>åªéœ€è¦å°†åé¢çš„å®½åº¦æ›´æ”¹å°±å¯ä»¥äº†.è¿™ç§æ”¹é“¾æ¥æœ‰æ•ˆæœçš„åŸå› æ˜¯å› ä¸ºæœåŠ¡å™¨æ ¹æ®å›¾ç‰‡é“¾æ¥å¯¹åŸå›¾è¿›è¡Œäº†ç¼©æ”¾å¹¶è¿”å›.è¿™ç§æ–¹æ¡ˆéœ€è¦æœåŠ¡å™¨æ”¯æŒå¯¹å›¾ç‰‡é“¾æ¥çš„è¯†åˆ«å¹¶è¿›è¡Œå¯¹åº”çš„ç¼©æ”¾.</p>
<h4 id="ä½¿ç”¨HTML-imgæ ‡ç­¾å¹¶è®¾ç½®widthå’Œheight"><a href="#ä½¿ç”¨HTML-imgæ ‡ç­¾å¹¶è®¾ç½®widthå’Œheight" class="headerlink" title="ä½¿ç”¨HTML imgæ ‡ç­¾å¹¶è®¾ç½®widthå’Œheight"></a>ä½¿ç”¨HTML imgæ ‡ç­¾å¹¶è®¾ç½®widthå’Œheight</h4><p>Markdownè¯­æ³•:</p>
<figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">&lt;img src<span class="operator">=</span><span class="string">&quot;http://p1-ks3.532106.com/33f925f1f92649678221088fdfb531a1.jpg&quot;</span> alt<span class="operator">=</span><span class="string">&quot;å›¾ç‰‡æ›¿æ¢æ–‡æœ¬&quot;</span> width<span class="operator">=</span><span class="string">&quot;500&quot;</span> height<span class="operator">=</span><span class="string">&quot;313&quot;</span> align<span class="operator">=</span><span class="string">&quot;bottom&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>
<p>åªéœ€è¦æ›´æ”¹ä¸Šé¢çš„å±æ€§widthæˆ–heightçš„å€¼å°±å¯ä»¥äº†,<code>align=&quot;bottom&quot;</code>å¯ä»¥çœç•¥æˆ–æ ¹æ®éœ€è¦è®¾ç½®å…¶ä»–å€¼å¦‚<code>top , bottom , middle , left , right</code>.</p>
<p>åŸå§‹å›¾åƒæ•ˆæœ:<br><img src="http://p1-ks3.532106.com/33f925f1f92649678221088fdfb531a1.jpg" alt="mytest.jpg"></p>
<p>æ›´æ”¹å</p>
<figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">&lt;img src<span class="operator">=</span><span class="string">&quot;http://p1-ks3.532106.com/33f925f1f92649678221088fdfb531a1.jpg&quot;</span> alt<span class="operator">=</span><span class="string">&quot;å›¾ç‰‡æ›¿æ¢æ–‡æœ¬&quot;</span> width<span class="operator">=</span><span class="string">&quot;200&quot;</span> height<span class="operator">=</span><span class="string">&quot;300&quot;</span> align<span class="operator">=</span><span class="string">&quot;bottom&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>
<p>æ•ˆæœ:</p>
<p><img src="http://p1-ks3.532106.com/33f925f1f92649678221088fdfb531a1.jpg" alt="å›¾ç‰‡æ›¿æ¢æ–‡æœ¬" width="200" height="300" align="bottom" /></p>
<h4 id="è‡ªå·±å¤„ç†å›¾ç‰‡å¤§å°-é‡æ–°ç”Ÿæˆå›¾ç‰‡é“¾æ¥"><a href="#è‡ªå·±å¤„ç†å›¾ç‰‡å¤§å°-é‡æ–°ç”Ÿæˆå›¾ç‰‡é“¾æ¥" class="headerlink" title="è‡ªå·±å¤„ç†å›¾ç‰‡å¤§å°,é‡æ–°ç”Ÿæˆå›¾ç‰‡é“¾æ¥"></a>è‡ªå·±å¤„ç†å›¾ç‰‡å¤§å°,é‡æ–°ç”Ÿæˆå›¾ç‰‡é“¾æ¥</h4><p>ç»ˆææ–¹æ¡ˆ,æ— éœ€è€ƒè™‘å„å¤§Markdownç¼–è¾‘å™¨å…¼å®¹æ€§é—®é¢˜.</p>
<h4 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h4><p>æ¯å®¶çš„Markdownç¼–è¾‘å™¨è¯­æ³•ä¼šæœ‰æ‰€ä¸åŒ,å› æ­¤åœ¨ä¸€ä¸ªç¼–è¾‘å™¨ä¸‹å†™çš„Markdownå¤åˆ¶åˆ°å¦ä¸€å®¶çš„ç¼–è¾‘å™¨ä¸‹,æ˜¾ç¤ºå¯èƒ½ä¼šæœ‰å·®å¼‚.</p>
]]></content>
      <categories>
        <category>Markdown</category>
      </categories>
  </entry>
  <entry>
    <title>OC BOOLç±»å‹</title>
    <url>/2019/11/25/OC%20BOOL%E7%B1%BB%E5%9E%8B/</url>
    <content><![CDATA[<p>ä¸‹é¢çš„ä»£ç :</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="type">signed</span> <span class="type">char</span> rs = <span class="number">240</span>;</span><br><span class="line"><span class="type">BOOL</span> rs1 = <span class="number">240</span>;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;%d %d&quot;</span>, rs, rs1);</span><br></pre></td></tr></table></figure>
<p>åœ¨32ä½æœº,å¦‚iPhone5cä¸Šè¾“å‡ºä¸º:<code>-16 -16</code>.<br>åœ¨64ä½æœº,å¦‚iPhone6sä¸Šè¾“å‡ºä¸º:<code>-16 1</code>.</p>
<p>åœ¨SDK <code>usr/include/objc/objc.h</code>é‡Œçš„å®šä¹‰:</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">/// Type to represent a boolean value.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__OBJC_BOOL_IS_BOOL)</span></span><br><span class="line">    <span class="comment">// Honor __OBJC_BOOL_IS_BOOL when available.</span></span><br><span class="line"><span class="meta">#   <span class="keyword">if</span> __OBJC_BOOL_IS_BOOL</span></span><br><span class="line"><span class="meta">#       <span class="keyword">define</span> OBJC_BOOL_IS_BOOL 1</span></span><br><span class="line"><span class="meta">#   <span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#       <span class="keyword">define</span> OBJC_BOOL_IS_BOOL 0</span></span><br><span class="line"><span class="meta">#   <span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="comment">// __OBJC_BOOL_IS_BOOL not set.</span></span><br><span class="line"><span class="meta">#   <span class="keyword">if</span> TARGET_OS_OSX || TARGET_OS_MACCATALYST || ((TARGET_OS_IOS || 0) &amp;&amp; !__LP64__ &amp;&amp; !__ARM_ARCH_7K)</span></span><br><span class="line"><span class="meta">#      <span class="keyword">define</span> OBJC_BOOL_IS_BOOL 0</span></span><br><span class="line"><span class="meta">#   <span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#      <span class="keyword">define</span> OBJC_BOOL_IS_BOOL 1</span></span><br><span class="line"><span class="meta">#   <span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> OBJC_BOOL_IS_BOOL</span></span><br><span class="line">    <span class="keyword">typedef</span> <span class="type">bool</span> <span class="type">BOOL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#   <span class="keyword">define</span> OBJC_BOOL_IS_CHAR 1</span></span><br><span class="line">    <span class="keyword">typedef</span> <span class="type">signed</span> <span class="type">char</span> <span class="type">BOOL</span>; </span><br><span class="line">    <span class="comment">// BOOL is explicitly signed so @encode(BOOL) == &quot;c&quot; rather than &quot;C&quot; </span></span><br><span class="line">    <span class="comment">// even if -funsigned-char is used.</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJC_BOOL_DEFINED</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __has_feature(objc_bool)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> YES __objc_yes</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NO  __objc_no</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> YES ((BOOL)1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NO  ((BOOL)0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å¤§æ¦‚æ„æ€å°±æ˜¯:<br>é»˜è®¤æƒ…å†µä¸‹,åœ¨32ä½iPhoneä¸Š,BOOLå°±æ˜¯signed charç±»å‹ï¼ˆ1ä¸ªå­—èŠ‚ã€‚-128 ~ 127ï¼‰<br>åœ¨64ä½iPhoneä¸Š,BOOLå°±æ˜¯boolç±»å‹.è€Œboolç±»å‹çš„å€¼æœ‰ä¸¤ç§true(1)å’Œfalse(0).ä»»ä½•ä¸ä¸º0çš„æ•°å¼ºè½¬ä¸ºboolç±»å‹ï¼Œå‡è½¬ä¸ºtrue(å³é0éƒ½ä¸ºçœŸ).</p>
<p>å¦å¤–:</p>
<p><code>- (id)performSelector:(SEL)aSelector withObject:(id)object;</code>å‚æ•°é—®é¢˜.<br>ç»“è®º:performSelectorçš„objectå‚æ•°åªèƒ½ä¸ºå¯¹è±¡ç±»å‹,å…¶selectorå‚æ•°å¯¹åº”æ–¹æ³•çš„å‚æ•°ä¹Ÿå¿…é¡»ä¸ºå¯¹è±¡ç±»å‹,å¦‚æœä¸ºåŸºæœ¬æ•°æ®ç±»å‹åˆ™å€¼ä¸å¯é¢„çŸ¥,è¿™ä¸ªæ—¶å€™åªèƒ½ä½¿ç”¨NSInvocation.</p>
<p>æµ‹è¯•ä»£ç å¦‚ä¸‹:</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&quot;ViewController.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="type">BOOL</span> val;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="type">int</span> num;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="variable language_">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.val= <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)changeMyVal:(<span class="type">BOOL</span>)param &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%d&quot;</span>, param);</span><br><span class="line">    <span class="keyword">self</span>.val = param;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%d&quot;</span>, <span class="keyword">self</span>.val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)changeNumber:(<span class="type">int</span>)param &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%d&quot;</span>, param);</span><br><span class="line">    <span class="keyword">self</span>.num = param;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%d&quot;</span>, <span class="keyword">self</span>.num);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)changeNumberObj:(<span class="built_in">NSNumber</span> *)param &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%d&quot;</span>, param.intValue);</span><br><span class="line">    <span class="keyword">self</span>.num = param.intValue;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%d&quot;</span>, <span class="keyword">self</span>.num);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="variable language_">super</span> touchesBegan:touches withEvent:event];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//performSelectorçš„objectå‚æ•°åªèƒ½ä¸ºå¯¹è±¡ç±»å‹,å…¶selectorå‚æ•°å¯¹åº”æ–¹æ³•çš„å‚æ•°ä¹Ÿå¿…é¡»ä¸ºå¯¹è±¡ç±»å‹,å¦‚æœä¸ºåŸºæœ¬æ•°æ®ç±»å‹åˆ™å€¼ä¸å¯é¢„çŸ¥.</span></span><br><span class="line">    [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(changeMyVal:) withObject:@(<span class="number">0</span>) afterDelay:<span class="number">2</span>]; <span class="comment">//self.valçš„å€¼æ¯æ¬¡è¿è¡Œéšæœº0æˆ–1</span></span><br><span class="line"><span class="comment">//    [self performSelector:@selector(changeMyVal:) withObject:@(1) afterDelay:2]; //self.valçš„å€¼æ¯æ¬¡è¿è¡Œéšæœº0æˆ–1.å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯0</span></span><br><span class="line"><span class="comment">//    [self performSelector:@selector(changeMyVal:) withObject:@(234) afterDelay:2]; //self.valçš„å€¼æ¯æ¬¡è¿è¡Œéšæœº0æˆ–1.</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//    [self performSelector:@selector(changeNumber:) withObject:@(25) afterDelay:2]; //self.num = -1985119076;(æ¯æ¬¡è¿è¡Œéƒ½ä¸ä¸€æ ·çš„)</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//    [self performSelector:@selector(changeNumberObj:) withObject:@(25) afterDelay:2]; //self.num = 25;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
      <tags>
        <tag>BOOLç±»å‹</tag>
      </tags>
  </entry>
  <entry>
    <title>pod installæ…¢è§£å†³</title>
    <url>/2019/11/06/pod%20install%E6%85%A2%E8%A7%A3%E5%86%B3/</url>
    <content><![CDATA[<p>ä»Šå¤©åœ¨å®‰è£…WCDBæ—¶,ä¸ç®¡æ˜¯pod install</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">-&gt; Installing WCDB <span class="params">(1.0.6)</span></span><br><span class="line"> &gt; Git download</span><br><span class="line"> &gt; Git download</span><br><span class="line">     $ <span class="string">/usr/local/bin/git</span> clone https:<span class="string">//github.com/Tencent/wcdb.git</span></span><br><span class="line">     <span class="string">/var/folders/5z/1pxqzfcn77s2n7z4gmr63sdr0000gn/T/d20191216-6636-ji8u78</span> <span class="params">--template=</span> <span class="params">--single-branch</span> <span class="params">--depth</span> 1 <span class="params">--branch</span> v1.0.6</span><br><span class="line">     Cloning into &#x27;<span class="string">/var/folders/5z/1pxqzfcn77s2n7z4gmr63sdr0000gn/T/d20191216-6636-ji8u78</span>&#x27;<span class="string">...</span></span><br><span class="line">     error: RPC failed; curl 18 transfer closed with outstanding read data remaining</span><br><span class="line">     fatal: The remote end hung up unexpectedly</span><br><span class="line">     fatal: early EOF</span><br><span class="line">     fatal: index-pack failed</span><br><span class="line"></span><br><span class="line">[!] Error installing WCDB</span><br><span class="line">[!] <span class="string">/usr/local/bin/git</span> clone https:<span class="string">//github.com/Tencent/wcdb.git</span> <span class="string">/var/folders/5z/1pxqzfcn77s2n7z4gmr63sdr0000gn/T/d20191216-6636-ji8u78</span> <span class="params">--template=</span> <span class="params">--single-branch</span> <span class="params">--depth</span> 1 <span class="params">--branch</span> v1.0.6</span><br><span class="line"></span><br><span class="line">Cloning into &#x27;<span class="string">/var/folders/5z/1pxqzfcn77s2n7z4gmr63sdr0000gn/T/d20191216-6636-ji8u78</span>&#x27;<span class="string">...</span></span><br><span class="line">error: RPC failed; curl 18 transfer closed with outstanding read data remaining</span><br><span class="line">fatal: The remote end hung up unexpectedly</span><br><span class="line">fatal: early EOF</span><br><span class="line">fatal: index-pack failed</span><br></pre></td></tr></table></figure>
<p>è¿˜æ˜¯ç›´æ¥git clone,éƒ½ä¸‹è½½ä¸äº†.</p>
<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">git clone https:<span class="symbol">//github.com/Tencent/wcdb.git</span></span><br><span class="line">Cloning into &#x27;wcdb&#x27;...</span><br><span class="line"><span class="params">remote:</span> Enumerating <span class="params">objects:</span> <span class="number">1704</span>, done.</span><br><span class="line"><span class="params">remote:</span> Counting <span class="params">objects:</span> <span class="number">100</span>% (<span class="number">1704</span><span class="operator">/</span><span class="number">1704</span>), done.</span><br><span class="line"><span class="params">remote:</span> Compressing <span class="params">objects:</span> <span class="number">100</span>% (<span class="number">1192</span><span class="operator">/</span><span class="number">1192</span>), done.</span><br><span class="line"><span class="params">error:</span> RPC failed; curl <span class="number">56</span> LibreSSL <span class="params">SSL_read:</span> SSL_ERROR_SYSCALL, errno <span class="number">54</span></span><br><span class="line"><span class="params">fatal:</span> The remote end hung up unexpectedly</span><br><span class="line"><span class="params">fatal:</span> early EOF</span><br><span class="line"><span class="params">fatal:</span> index-pack failed</span><br></pre></td></tr></table></figure>
<p>ä»é”™è¯¯åŸå› ä¸éš¾çœ‹å‡ºæ˜¯ç½‘ç»œçš„é—®é¢˜ï¼Œåº”è¯¥æ˜¯githubè¢«å¢™äº†ã€‚</p>
<p>æœ€åè§£å†³åŠæ³•:</p>
<ol>
<li><p><code>pod repo update</code>æ›´æ–°ä»“åº“ã€‚</p>
<p>è¿™ä¸€æ­¥ä¸æ˜¯å¿…é¡»ï¼Œé™¤éä½ çš„ä»“åº“å¾ˆæ—§ï¼Œæˆ–è€…ç¬¬äºŒæ­¥æ²¡æ•ˆæœã€‚è¿™ä¸€æ­¥ä¸ç¿»å¢™çš„è¯åŒæ ·å¾ˆæ…¢å¤§æ¦‚10kb/sçš„æ ·å­ï¼Œä½†æ˜¯æ¯”èµ·åé¢ä¸‹è½½æºç åº“å°¤å…¶æ˜¯ä¸€äº›å¿…é¡»è¦ç¿»å¢™æ‰èƒ½ä¸‹è½½çš„ï¼ˆæ¯”å¦‚libwebpï¼‰ï¼Œé‚£ç®€ç›´å°å·«è§å¤§å·«äº†ã€‚<code>pod repo update</code>ä¼šä»githubä¸ŠæŠŠæœ€æ–°çš„ä»“åº“æ›´æ–°åˆ°æœ¬åœ°ï¼š<code>~/.cocoapods/repos/master</code>ï¼Œé‡Œé¢ä¿å­˜äº†æ‰€æœ‰ç¬¬ä¸‰æ–¹åº“çš„specè¯´æ˜ä¹¦ã€‚</p>
</li>
<li><p>ä»åŒäº‹é‚£é‡Œæ‹·è´æºç åº“(è·¯å¾„ä¸º<code>~/Library/Caches/CocoaPods/Pods/Release</code>)å’Œæºç åº“çš„è¯´æ˜ä¹¦(è·¯å¾„ä¸º<code>~/Library/Caches/CocoaPods/Pods/Specs/Release</code>),ä¹Ÿåˆ†åˆ«æ”¾åœ¨è‡ªå·±çš„ä¸Šè¿°ä¸¤ä¸ªç›®å½•ä¸‹.å†pod installè§£å†³.</p>
</li>
</ol>
<p>ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºpod installéƒ½å¹²äº†äº›å•¥ã€‚</p>
<p>å‚è€ƒ:<a href="https://www.jianshu.com/p/e2947189c004">æ— æ³•Pod installç¬¬ä¸‰æ–¹åº“çš„è§£å†³åŠæ³•</a></p>
<p>ps:<br>pod installä¸‹è½½ä¸‹æ¥çš„åº“çš„æœ¬åœ°å­˜å‚¨è·¯å¾„ä¸º<br><code>~/Library/Caches/CocoaPods</code>,è¯¥ç›®å½•åŒ…å«ä¸€ä¸ªæœç´¢ç´¢å¼•jsonæ–‡ä»¶,ä»¥åŠä¸‹è½½è¿‡çš„åº“çš„æºä»£ç å’Œå¯¹åº”çš„Spec.<br>å¦‚æœPodfileæ–‡ä»¶ä¸­åº“çš„ç‰ˆæœ¬ä¸€è‡´åˆ™ä¸ä¼šå†ä»githubä¸‹è½½,è€Œæ˜¯ç›´æ¥ä½¿ç”¨ç¼“å­˜ä¸‹æ¥çš„åº“çš„æºç .å› æ­¤å¦‚æœæŸä¸ªåº“pod installå¾ˆæ…¢æ—¶,å¯ä»¥æ‹·è´åˆ«äººçš„ç‰ˆæœ¬ä¸€è‡´çš„åº“åˆ°è¯¥ç›®å½•ä¸‹,å‡å°‘ç­‰å¾…æ—¶é—´.<br>åœ¨æ¸…ç†Macç£ç›˜å­˜å‚¨ç©ºé—´æ—¶æœ€å¥½ä¸è¦åˆ é™¤<code>~/Library/Caches/CocoaPods</code>é‡Œé¢çš„ç¼“å­˜,å¦åˆ™ä¸‹æ¬¡pod installä¼šä»githubä¸Šé‡æ–°ä¸‹è½½æºç åº“,è¿™ä¸ªç­‰å¾…æ—¶é—´ä½ æ‡‚å¾—.</p>
<h4 id="è®©git-cloneèµ°ä»£ç†"><a href="#è®©git-cloneèµ°ä»£ç†" class="headerlink" title="è®©git cloneèµ°ä»£ç†"></a>è®©git cloneèµ°ä»£ç†</h4><p>æ…¢çš„æ ¹æœ¬åŸå› :github.global.ssl.fastly.netåŸŸåè¢«é™åˆ¶äº†,å¯¼è‡´git cloneä»ä¸Šé¢æ‹‰æºç åº“çš„æ—¶å€™éå¸¸æ…¢,å‘µå‘µ.<br>è§£å†³åŠæ³•:</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">git config <span class="params">--global</span> http.https:<span class="string">//github.com.proxy</span> https:<span class="string">//127.0.0.1</span><span class="function">:xxxxx</span></span><br><span class="line">git config <span class="params">--global</span> https.https:<span class="string">//github.com.proxy</span> https:<span class="string">//127.0.0.1</span><span class="function">:xxxxx</span></span><br></pre></td></tr></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">git config <span class="params">--global</span> http.https:<span class="string">//github.com.proxy</span> socks5:<span class="string">//127.0.0.1</span><span class="function">:xxxxx</span></span><br><span class="line">git config <span class="params">--global</span> https.https:<span class="string">//github.com.proxy</span> socks5:<span class="string">//127.0.0.1</span><span class="function">:xxxxx</span></span><br></pre></td></tr></table></figure>
<p><code>xxxxx</code>ä¸ºä½ çš„HTTP(S)ä»£ç†æœåŠ¡å™¨çš„ç«¯å£.ä¸ºä»€ä¹ˆæœ‰ä¸¤ç§è®¾ç½®,ä¸çŸ¥é“.åæ­£éƒ½è¯•ä¸€ä¸‹.</p>
<p>å¯¹åº”çš„å–æ¶ˆè®¾ç½®ä¸º:</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">git config <span class="attr">--global</span> <span class="attr">--unset</span> http<span class="selector-class">.https</span>:<span class="comment">//github.com.proxy</span></span><br><span class="line">git config <span class="attr">--global</span> <span class="attr">--unset</span> https<span class="selector-class">.https</span>:<span class="comment">//github.com.proxy</span></span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ—¶å€™git cloneå¯ä»¥è¾¾åˆ°500kb.</p>
<p>ps:</p>
<p>Git è‡ªå¸¦ä¸€ä¸ª git config çš„å·¥å…·æ¥å¸®åŠ©è®¾ç½®æ§åˆ¶ Git å¤–è§‚å’Œè¡Œä¸ºçš„é…ç½®å˜é‡ã€‚ è¿™äº›å˜é‡å­˜å‚¨åœ¨ä¸‰ä¸ªä¸åŒçš„ä½ç½®ï¼š</p>
<ol>
<li><p>/etc/gitconfig æ–‡ä»¶: åŒ…å«ç³»ç»Ÿä¸Šæ¯ä¸€ä¸ªç”¨æˆ·åŠä»–ä»¬ä»“åº“çš„é€šç”¨é…ç½®ã€‚ å¦‚æœä½¿ç”¨å¸¦æœ‰ â€”system é€‰é¡¹çš„ git config æ—¶ï¼Œå®ƒä¼šä»æ­¤æ–‡ä»¶è¯»å†™é…ç½®å˜é‡ã€‚</p>
</li>
<li><p>~/.gitconfig æˆ– ~/.config/git/config æ–‡ä»¶ï¼šåªé’ˆå¯¹å½“å‰ç”¨æˆ·ã€‚ å¯ä»¥ä¼ é€’ â€”global é€‰é¡¹è®© Git è¯»å†™æ­¤æ–‡ä»¶ã€‚</p>
</li>
<li><p>å½“å‰ä½¿ç”¨ä»“åº“çš„ Git ç›®å½•ä¸­çš„ config æ–‡ä»¶ï¼ˆå°±æ˜¯ .git/configï¼‰ï¼šé’ˆå¯¹è¯¥ä»“åº“ã€‚</p>
</li>
</ol>
<p>æ¯ä¸€ä¸ªçº§åˆ«è¦†ç›–ä¸Šä¸€çº§åˆ«çš„é…ç½®ï¼Œæ‰€ä»¥ .git/config çš„é…ç½®å˜é‡ä¼šè¦†ç›– /etc/gitconfig ä¸­çš„é…ç½®å˜é‡ã€‚</p>
<p>å‚è€ƒ:</p>
<p><a href="https://git-scm.com/book/zh/v2/%E8%B5%B7%E6%AD%A5-%E5%88%9D%E6%AC%A1%E8%BF%90%E8%A1%8C-Git-%E5%89%8D%E7%9A%84%E9%85%8D%E7%BD%AE">1.6 èµ·æ­¥ - åˆæ¬¡è¿è¡Œ Git å‰çš„é…ç½®</a></p>
<p><a href="https://git-scm.com/book/zh/v2/%E8%87%AA%E5%AE%9A%E4%B9%89-Git-%E9%85%8D%E7%BD%AE-Git">8.1 è‡ªå®šä¹‰ Git - é…ç½® Git</a></p>
<h4 id="è®©Macç»ˆç«¯èµ°ä»£ç†"><a href="#è®©Macç»ˆç«¯èµ°ä»£ç†" class="headerlink" title="è®©Macç»ˆç«¯èµ°ä»£ç†"></a>è®©Macç»ˆç«¯èµ°ä»£ç†</h4><p><code>vim ~/.zshrc</code>æ‰“å¼€<code>.zshrc</code>æ–‡ä»¶.(æˆ‘è¿™é‡Œç”¨çš„æ˜¯zsh)<br>æ·»åŠ </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">alias</span> proxy=<span class="string">&#x27;export all_proxy=socks5://127.0.0.1:xxxxx&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> unproxy=<span class="string">&#x27;unset all_proxy&#x27;</span></span><br></pre></td></tr></table></figure>
<p><code>proxy</code>å¼€å¯ä»£ç†.å¯¹åº”çš„<code>unproxy</code>æ˜¯å…³é—­.<br>æ‰§è¡Œ<code>curl cip.cc</code>æˆ–<code>curl  https://www.dropbox.com</code>æ£€æµ‹æ˜¯å¦ç¿»å¢™æˆåŠŸ.<br>ç»ˆç«¯æ²¡èµ°ä»£ç†å‰git cloneéƒ½æ˜¯å¤±è´¥çš„,èµ°ä»£ç†ågit cloneå¯ä»¥å·¥ä½œä½†åªæœ‰5kbå·¦å³.å› æ­¤è¿˜æ˜¯éœ€è¦å•ç‹¬é…ç½®ä¸Šé¢çš„git clone.</p>
<p>å‚è€ƒ: <a href="https://zhuanlan.zhihu.com/p/47849525">MaxOSXç»ˆç«¯èµ°shadowsocksä»£ç†</a>.<br>æˆ‘è‡ªå·±è¯•äº†ä¸€ä¸‹èƒ½ç”¨,ä½†æ™šä¸Š11ç‚¹çš„é€Ÿåº¦ä¹Ÿä¸æ˜¯å¾ˆå¿«,å¯èƒ½ä¸æ˜¯ç‹¬äº«ç½‘ç»œçš„åŸå› å§.æ—©ä¸Š6ç‚¹åˆè¯•äº†ä¸€ä¸‹å¾ˆå¿«. </p>
<p>å¦:CocoaPodså‡çº§åˆ°1.8.0+å,ç‰ˆæœ¬å˜åŒ–å¯¼è‡´çš„ä¸€äº›é—®é¢˜.<br>å‚è€ƒ:<a href="https://zhaoxin.pro/15695124897584.html">è„±ç¦»CocoaPods 1.8.0çš„trunk</a><br>åœ¨å›½å†…è¿˜æ˜¯æš‚æ—¶ä¸è¦ä½¿ç”¨trunk,å®ƒä¼šè®©ä½ å˜å¾—æ›´æ…¢è€Œä¸”è¿˜ä¼šå¤±è´¥.ç”±äºCocoaPodsåœ¨1.8.0åé»˜è®¤ä½¿ç”¨trunk,æˆ‘ä»¬å¯ä»¥ç§»é™¤trunk,ç»§ç»­ä½¿ç”¨master,ä½†æ­¤æ—¶éœ€è¦åœ¨Podfileæ–‡ä»¶ä¸­æŒ‡å®šæº<br><code>source &#39;https://github.com/CocoaPods/Specs.git&#39;</code>.</p>
<h4 id="ä¿®æ”¹è®¡ç®—æœºç½‘ç»œé…ç½®"><a href="#ä¿®æ”¹è®¡ç®—æœºç½‘ç»œé…ç½®" class="headerlink" title="ä¿®æ”¹è®¡ç®—æœºç½‘ç»œé…ç½®"></a>ä¿®æ”¹è®¡ç®—æœºç½‘ç»œé…ç½®</h4><p>å¦‚æœä¸Šè¿°ä¸¤ç§åŠæ³•æ•´äº†ä¹‹åè¿˜æ˜¯å¾ˆæ…¢ï¼Œå¯ä»¥å†ç»“åˆè¯•ä¸€è¯•è¿™ä¸ªã€‚</p>
<p>ç”±äºä½¿ç”¨ IPv6 çš„åŸå› ï¼Œå¯èƒ½ä¼šå¯¼è‡´è¿™ä¸€é—®é¢˜çš„å‡ºç°ã€‚å¯ä»¥é…ç½®è®¡ç®—æœºä¸ä½¿ç”¨ IPv6ï¼Œæ•…ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š</p>
<figure class="highlight crystal"><table><tr><td class="code"><pre><span class="line"><span class="variable">$ </span>networksetup -setv6off Wi-Fi</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæœ‰éœ€è¦ï¼Œå¯ä»¥å†å°†é…ç½®ä¿®æ”¹å›æ¥ï¼š</p>
<figure class="highlight crystal"><table><tr><td class="code"><pre><span class="line"><span class="variable">$ </span>networksetup -setv6automatic Wi-Fi</span><br></pre></td></tr></table></figure>
<p>ps:å…¬å¸ç½‘ç»œä»¥å‰é…ç½®ä¸Šé¢ä¸¤ç§åå°±å¾ˆå¿«äº†ï¼Œä¸çŸ¥é“ä»å“ªå¤©å¼€å§‹çªç„¶å°±ä¸ç®¡ç”¨äº†ï¼Œè¯•äº†ä¸€ä¸‹è¿™ä¸ªï¼Œåˆå¾ˆå¿«äº†ã€‚</p>
<h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><p><a href="https://blog.hyperzsb.tech/git-ssl-error/">Git - SSL_ERROR_SYSCALL é—®é¢˜è§£å†³</a></p>
]]></content>
      <categories>
        <category>CocoaPods</category>
      </categories>
  </entry>
  <entry>
    <title>ä»7æ—¥å¹´åŒ–æ”¶ç›Šç‡åˆ°ä¸‡ä»½æ”¶ç›Š</title>
    <url>/2019/10/13/%E4%BB%8E7%E6%97%A5%E5%B9%B4%E5%8C%96%E6%94%B6%E7%9B%8A%E7%8E%87%E5%88%B0%E4%B8%87%E4%BB%BD%E6%94%B6%E7%9B%8A/</url>
    <content><![CDATA[<h4 id="ä¸€ã€-7æ—¥å¹´åŒ–æ”¶ç›Šç‡"><a href="#ä¸€ã€-7æ—¥å¹´åŒ–æ”¶ç›Šç‡" class="headerlink" title="ä¸€ã€ 7æ—¥å¹´åŒ–æ”¶ç›Šç‡"></a>ä¸€ã€ 7æ—¥å¹´åŒ–æ”¶ç›Šç‡</h4><p>ä»Šå¤©æ—©ä¸Šè¢«ä¸€æ¡æ”¯ä»˜å®çš„é€šçŸ¥åµé†’,ç‚¹è¿›å»ä¸€çœ‹å‘ç°æ˜¯æœ‰æ–°çš„èŠ±å‘—è´¦å•éœ€è¦å¿è¿˜äº†,è¿˜å®ŒèŠ±å‘—,åˆ·äº†ä¸€ä¸‹ä½™é¢å®,æç¤ºæ˜¨æ—¥æ”¶ç›Š0.16å…ƒ,ä¸ƒæ—¥å¹´åŒ–2.3280%.7æ—¥å¹´åŒ–?æ€ä¹ˆè¿™ä¹ˆç†Ÿæ‚‰ä½†æ˜¯ç»†ç»†ä¸€æƒ³å´åˆä¸çŸ¥é“åˆ°åº•æ˜¯ä»€ä¹ˆä¸œè¥¿,è¿™è®©æˆ‘æ„Ÿåˆ°éš¾å—.çœ‹æ¥æœ‰å¿…è¦äº†è§£ä¸€ä¸‹7æ—¥å¹´åŒ–æ”¶ç›Šç‡ç©¶ç«Ÿæ˜¯ä»€ä¹ˆä¸œè¥¿?</p>
<p>ä¸è¿‡ä¸€ä¸Šæ¥å°±è®²7æ—¥å¹´åŒ–æ”¶ç›Šç‡ç•¥æ˜¾æ·±å¥¥,è¿˜æ˜¯å…ˆæ¥çœ‹ä¸€ä¸‹æ”¶ç›Šç‡æ˜¯ä»€ä¹ˆ?</p>
<p>å¤§å®¶éƒ½çŸ¥é“<code>æ”¶ç›Šç‡ = æ”¶ç›Š / æœ¬é‡‘</code>.å³æœ¬é‡‘åœ¨ä¸€æ®µæ—¶é—´åè·å¾—çš„æ”¶ç›Šé™¤ä»¥æœ¬é‡‘.æ”¶ç›Šç‡å¯ä»¥ç”¨æ¥è¡¡é‡ä¸€ä¸ªç†è´¢äº§å“çš„å¥½å.æ”¶ç›Šç‡è¶Šé«˜ä»£è¡¨åˆ°æœŸåè·å¾—çš„æ”¶ç›Šä¹Ÿè¶Šå¤š.</p>
<p>å¹´æ”¶ç›Šç‡å°±æ˜¯æœ¬é‡‘åœ¨ä¸€å¹´ä»¥åè·å¾—çš„æ”¶ç›Šé™¤ä»¥æœ¬é‡‘å¾—åˆ°çš„ä¸€ä¸ªæ¯”å€¼.æ¯”å¦‚é“¶è¡ŒæŸä¸ªå®šæœŸç†è´¢äº§å“æ‰¿è¯ºå­˜æ»¡ä¸€å¹´å°†è·å¾—4%çš„å¹´æ”¶ç›Šç‡.é‚£ä¹ˆä½ å­˜10000å…ƒ,åˆ°å¹´åº•çš„æ—¶å€™å–å‡ºæ¥å°†è·å¾—10000 x 4%=400å…ƒçš„æ€»æ”¶ç›Š.</p>
<p>ä¸å…¶å¯¹åº”çš„æ˜¯æ—¥æ”¶ç›Šç‡,å³æœ¬é‡‘åœ¨ä¸€å¤©åè·å¾—çš„æ”¶ç›Šé™¤ä»¥æœ¬é‡‘.è¿˜æ˜¯ä¸Šé¢çš„ä¾‹å­,10000å…ƒå­˜æ»¡ä¸€å¹´è·å¾—400å…ƒæ”¶ç›Š,é‚£ä¹ˆå­˜ä¸€å¤©è·å¾—çš„æ”¶ç›Šä¸º400 / 365 â‰ˆ 1.0959å…ƒ.äºæ˜¯R<sub>d</sub> = 1.0959 / 10000 = 0.010959% = 4% / 365.</p>
<p>å› æ­¤å¾ˆå®¹æ˜“å¾—å‡ºæ—¥æ”¶ç›Šç‡ä¸å¹´æ”¶ç›Šç‡å­˜åœ¨ä»¥ä¸‹å…³ç³»:</p>
<p>R<sub>d</sub> x 365 = R<sub>y</sub></p>
<p>R<sub>d</sub> x 365å°±è¡¨ç¤ºå°†æ—¥æ”¶ç›Šç‡è¿›è¡Œå¹´åŒ–,å¾—åˆ°çš„ç»“æœR<sub>y</sub>å°±æ˜¯å¹´åŒ–æ”¶ç›Šç‡.å¦‚æœä½ èƒ½ä¿è¯ä»¥åçš„æ—¥æ”¶ç›Šç‡éƒ½æ˜¯è¿™ä¹ˆå¤š,é‚£R<sub>y</sub>å°±æ˜¯å¹´æ”¶ç›Šç‡äº†,ä½†å¯¹äºåŸºé‡‘æ¥è¯´å®ƒæ¯å¤©çš„æ”¶ç›Šç‡æ˜¯åœ¨ä¸æ–­å˜åŒ–çš„,æ‰€ä»¥åªèƒ½ç§°ä¸ºå¹´åŒ–æ”¶ç›Šç‡.</p>
<p>OK,å‰æˆçš„éƒ¨åˆ†ç»ˆäºè®²å®Œäº†,ç°åœ¨å¼€å§‹æ­£å¼è¿›å…¥ä¸»é¢˜.</p>
<p>7æ—¥å¹´åŒ–æ”¶ç›Šç‡å…¶å®æ˜¯è¯´è¿‡å»ä¸ƒå¤©è´§å¸åŸºé‡‘çš„å¹³å‡æ”¶ç›Šç‡.ä¸¾ä¸ªä¾‹å­,10æœˆ11æ—¥æ˜¾ç¤ºçš„ä½™é¢å®ä¸ƒæ—¥å¹´åŒ–æ”¶ç›Šç‡æ˜¯2.3280%,æ˜¯æŒ‡10æœˆ4æ—¥-10æœˆ10æ—¥è¿‡å»è¿™ä¸ƒå¤©çš„å¹³å‡å¹´åŒ–æ”¶ç›Šç‡.å³è¿™7å¤©çš„æ€»æ”¶ç›Šé™¤ä»¥7å¾—åˆ°å¹³å‡æ¯å¤©çš„æ”¶ç›Š,ä¹Ÿå°±æ˜¯å¹³å‡æ—¥æ”¶ç›Š,é‚£ä¹ˆå¹³å‡æ—¥æ”¶ç›Šç‡ = å¹³å‡æ—¥æ”¶ç›Š / æœ¬é‡‘.æ¥ä¸‹æ¥å°±æ˜¯æŠŠå®ƒå¹´åŒ–ä¸€ä¸‹,æ ¹æ®ä¸Šé¢çš„å…¬å¼å¯å¾—ä¸ƒæ—¥å¹´åŒ–æ”¶ç›Šç‡ = å¹³å‡æ—¥æ”¶ç›Šç‡ x 365 = 7å¤©çš„æ€»æ”¶ç›Š / 7 / æœ¬é‡‘ x 365.</p>
<p>è®©æˆ‘ä»¬å†æ·±å…¥ä¸€ç‚¹:</p>
<p>å‡è®¾mä¸ºæœ¬é‡‘,å­˜nå¤©åè·å¾—çš„æ€»æ”¶ç›Šä¸ºi.é‚£ä¹ˆnæ—¥å¹´åŒ–æ”¶ç›Šç‡è®¡ç®—å¦‚ä¸‹:</p>
<p>å…ˆè®¡ç®—æ—¥æ”¶ç›Šç‡R<sub>d</sub> = i / n / m,</p>
<p>å†å¹´åŒ–å¾—åˆ°å¹´åŒ–æ”¶ç›Šç‡R<sub>y</sub> = R<sub>d</sub> x 365 = i / n / m x 365.</p>
<p>nä¸º7åˆ™R<sub>y</sub>å°±è¡¨ç¤º7æ—¥å¹´åŒ–æ”¶ç›Šç‡.<br>nä¸º15åˆ™R<sub>y</sub>å°±è¡¨ç¤º15æ—¥å¹´åŒ–æ”¶ç›Šç‡.<br>nä¸º30åˆ™R<sub>y</sub>å°±è¡¨ç¤º30æ—¥å¹´åŒ–æ”¶ç›Šç‡.<br>â€¦<br>nä¸º365åˆ™R<sub>y</sub>å°±è¡¨ç¤º365æ—¥å¹´åŒ–æ”¶ç›Šç‡.<br>nè¶Šå¤§è¡¨æ˜è¯¥ç†è´¢äº§å“è¿‡å»çš„æ”¶ç›Šè¶Šå¹³ç¨³.å€¼å¾—æ³¨æ„çš„æ˜¯ä¸ç®¡nä¸ºå¤šå¤§å®ƒéƒ½ä¸èƒ½é¢„ç¤ºæœªæ¥ä¹Ÿä¼šè¿™æ ·å¹³ç¨³,åªèƒ½è¯´å¯èƒ½æ€§ä¼šæ›´é«˜ä¸€ç‚¹.å› ä¸ºå®ƒåªä»£è¡¨è¿‡å»æ˜¯è¿™æ ·,å’Œé“¶è¡Œçš„å®šæœŸç†è´¢æ‰¿è¯º4%æ˜¯ä¸ä¸€æ ·çš„.</p>
<p>ä¸€åªåŸºé‡‘å®ƒçš„7æ—¥å¹´åŒ–æ”¶ç›Šç‡å’Œ30æ—¥å¹´åŒ–æ”¶ç›Šç‡å¯èƒ½ä¸ç›¸ç­‰,å¤§å¤šæ•°æƒ…å†µä¸‹ä¹Ÿä¸ä¼šç›¸ç­‰,å¦‚æœ30æ—¥å¹´åŒ–æ”¶ç›Šç‡å¤§äº7æ—¥å¹´åŒ–æ”¶ç›Šç‡è¯´æ˜è¯¥åŸºé‡‘è¿‘æœŸåœ¨ä¸‹è·Œ.åä¹‹åœ¨ä¸Šæ¶¨.</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬è®¡ç®—ä¸€ä¸‹,ä¸€ä¸ªåŸºé‡‘çš„å¹´åŒ–æ”¶ç›Šç‡è¦å¤šå°‘æ‰èƒ½â€ä¿è¯â€10000å…ƒ1å¤©èƒ½å¤Ÿæœ‰1å…ƒçš„æ”¶ç›Š,è¿™åº”è¯¥æ‰æ˜¯å¤§ä¼™å…³æ³¨çš„.</p>
<p>æœ‰äº†ä¸Šé¢çš„å…¬å¼,è¿™éƒ½ä¸å«äº‹.å…ˆç®—æ—¥æ”¶ç›Šç‡</p>
<p>R<sub>d</sub> = 1 / 10000,</p>
<p>å†å¹´åŒ–ä¸€ä¸‹</p>
<p>R<sub>y</sub> = R<sub>d</sub> x 365 = 3.65%.</p>
<p>å³ä¸€ä¸ªåŸºé‡‘çš„å¹´åŒ–æ”¶ç›Šç‡è¦3.65%æ‰èƒ½â€ä¿è¯â€10000å…ƒ1å¤©èƒ½å¤Ÿæœ‰1å…ƒçš„æ”¶ç›Š.æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ä½™é¢å®å€Ÿå‘—,å®ƒæ˜¾ç¤ºæ—¥åˆ©ç‡ä¸‡3ä¹Ÿå°±æ˜¯å€Ÿ1ä¸‡å…ƒç”¨ä¸€å¤©è¦è¿˜3å…ƒ.æˆ‘ä»¬å¯ä»¥ç®—ä¸€ä¸‹æ”¾è´·æ–¹çš„å¹´åŒ–æ”¶ç›Šç‡ = 3 / 10000 x 365 = 3 x 3.65% = 10.95%.å·®ä¸å¤š11%çš„å¹´åŒ–æ”¶ç›Šç‡.è¯•é—®ç°åœ¨è¿˜èƒ½æ‰¾åˆ°å‡ ä¸ªè¶…è¿‡4%çš„<strong>ç¨³å¥</strong>åŸºé‡‘,å¯è§æ”¾è´·çœŸçš„æ˜¯æš´åˆ©,å€Ÿè´·éœ€è°¨æ…å•Š!</p>
<h4 id="äºŒã€-ä¸‡ä»½æ”¶ç›Š"><a href="#äºŒã€-ä¸‡ä»½æ”¶ç›Š" class="headerlink" title="äºŒã€ ä¸‡ä»½æ”¶ç›Š"></a>äºŒã€ ä¸‡ä»½æ”¶ç›Š</h4><p>ä¸‡ä»½æ”¶ç›Šæ˜¯æŒ‡è´§å¸åŸºé‡‘1ä¸‡å—é’±1å¤©çš„æ”¶ç›Š.ä¸€èˆ¬åœ¨ä½™é¢å®çœ‹åˆ°çš„ä¸‡ä»½æ”¶ç›Šæ˜¯1ä¸‡å—é’±æ”¾åœ¨ä½™é¢å®é‡Œæ˜¨å¤©ä¸€å¤©æ‰€å¾—çš„æ”¶ç›Š,ä¸æ˜¯ä»Šå¤©çš„æ”¶ç›Š.</p>
<p>ä¸‡ä»½æ”¶ç›Šä¸7æ—¥å¹´åŒ–æ”¶ç›Šç‡æœ‰ä»€ä¹ˆå…³ç³»å‘¢?</p>
<p>å…ˆè¯´ç»“è®º:æ ¹æ®7æ—¥å¹´åŒ–æ”¶ç›Šç‡è®¡ç®—å‡ºçš„ä¸‡ä»½æ”¶ç›Šå…¶å®æ˜¯æœŸæœ›ä¸‡ä»½æ”¶ç›Šå¹¶ä¸ç­‰äº(å®é™…)ä¸‡ä»½æ”¶ç›Š.</p>
<blockquote>
<p>å£°æ˜:ä»¥ä¸‹çš„ä¸‡ä»½æ”¶ç›Šå’Œ7æ—¥å¹´åŒ–æ”¶ç›Šç‡éƒ½æ˜¯æŒ‡æ˜¨æ—¥çš„,å› ä¸ºä»Šæ—¥çš„ä¸‡ä»½æ”¶ç›Šä¸7æ—¥å¹´åŒ–æ”¶ç›Šç‡åœ¨æ²¡æ”¶å¸‚ä¹‹å‰æ˜¯æ— æ³•çŸ¥é“çš„,ä»Šå¤©å¯èƒ½æ¶¨,è·Œä¹Ÿå¯èƒ½æŒå¹³.</p>
</blockquote>
<p>ä¸¾ä¸ªä¾‹å­:</p>
<p>10æœˆ11æ—¥ä½™é¢å®æ˜¾ç¤ºçš„ä¸ƒæ—¥å¹´åŒ–æ”¶ç›Šç‡æ˜¯2.3280%(å³10æœˆ10æ—¥çš„7æ—¥å¹´åŒ–æ”¶ç›Šç‡ä¸º2.3280%),æˆ‘ä»¬å¯ä»¥ç®—ä¸€ä¸‹åœ¨è¿™ä¸ªæ”¶ç›Šç‡ä¸‹10000å…ƒ1å¤©åªèƒ½å¾—åˆ°2.3280% / 365 * 10000 = 0.6378å…ƒ.å¦‚æœä½ è¿˜è®°å¾—10000å…ƒ1å¤©èƒ½å¤Ÿæœ‰1å…ƒçš„æ”¶ç›Š,å¹´åŒ–æ”¶ç›Šç‡ä¸º3.65%çš„è¯,ä½ å¯ä»¥ä»¥è¿™ä¸ªä¸ºåŸºå‡†å¿«é€Ÿè®¡ç®—ä¸Šé¢çš„ç»“æœ2.3280% / 3.65% = 0.6378å…ƒ,å³ä¸º10æœˆ10æ—¥çš„â€ä¸‡ä»½æ”¶ç›Šâ€.ä¸è¿‡æˆ‘ä»¬ä¼šå‘ç°ä½™é¢å®å®é™…æ˜¾ç¤ºçš„10æœˆ10æ—¥ä¸‡ä»½æ”¶ç›Šä¸º0.6266å…ƒ,ç›¸å·®0.0112å…ƒ.</p>
<p>ä¸ºä»€ä¹ˆä¼šç›¸å·®0.0112å‘¢?</p>
<p>é™¤äº†è®¡ç®—ç²¾åº¦å½±å“å¤–,è¿˜æœ‰æ²¡æœ‰å…¶ä»–åŸå› å‘¢?æˆ‘ä»¬å¯ä»¥ç®—ä¸€ä¸‹10æœˆ10æ—¥çš„1æ—¥å¹´åŒ–æ”¶ç›Šç‡= 0.6266 x 3.65% = 2.2871% &lt; 2.3280%,è¯´æ˜å‰å…­å¤©çš„æ¯”10æœˆ10æ—¥çš„è¦é«˜,å¹³å‡ä¸‹æ¥åè®¡ç®—å‡º10æœˆ10æ—¥çš„ä¸ƒæ—¥å¹´åŒ–æ”¶ç›Šç‡æ¯”å½“å¤©çš„å¹´åŒ–æ”¶ç›Šç‡è¦é«˜,è¿™è¯´æ˜ä½™é¢å®å¯¹åº”çš„åŸºé‡‘å…¶å®æ˜¯åœ¨ä¸‹è·Œ.å› æ­¤å¦ä¸€ä¸ªåŸå› å°±æ˜¯10æœˆ10æ—¥çš„æ—¥æ”¶ç›Šç‡ä½äºå‰å‡ å¤©çš„æ—¥æ”¶ç›Šç‡,åŸºé‡‘åœ¨ä¸‹è·Œ.</p>
<p>è¿™è¯´æ˜äº†æ ¹æ®7æ—¥å¹´åŒ–æ”¶ç›Šç‡è®¡ç®—å‡ºçš„ä¸‡ä»½æ”¶ç›Šå…¶å®æ˜¯æœŸæœ›ä¸‡ä»½æ”¶ç›Šå¹¶ä¸ç­‰äº(å®é™…)ä¸‡ä»½æ”¶ç›Š.</p>
<p>å¼•ç”³ä¸€ä¸‹å¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®º:</p>
<ol>
<li>æ˜¨æ—¥çš„å¹´åŒ–æ”¶ç›Šç‡å¯ä»¥å¤§äºã€ç­‰äºã€å°äºæ˜¨æ—¥çš„7æ—¥å¹´åŒ–æ”¶ç›Šç‡.å¤§äºè¯´æ˜åŸºé‡‘æ˜¨æ—¥æ¶¨äº†,åä¹‹è¯´æ˜è·Œäº†.</li>
<li>æ˜¨æ—¥çš„ä¸‡ä»½æ”¶ç›Šå¯ä»¥å¤§äºã€ç­‰äºã€å°äºä»¥æ˜¨æ—¥çš„7æ—¥å¹´åŒ–æ”¶ç›Šç‡è®¡ç®—å‡ºçš„ä¸‡ä»½æ”¶ç›Š(ä¸ªäººæŠŠå®ƒå«åšæœŸæœ›ä¸‡ä»½æ”¶ç›Š,åæ­£æˆ‘å°±è¿™ä¹ˆå«äº†).</li>
<li>åŸºé‡‘çš„å¹´åŒ–æ”¶ç›Šç‡åªè¡¨æ˜è¿‡å»çš„æ”¶ç›Šæƒ…å†µ,å¹¶ä¸ä¿è¯æœªæ¥çš„æ”¶ç›Š.å› æ­¤åŸºé‡‘æ‰æœ‰å„ç§é£é™©ç­‰çº§,é£é™©è¶Šä½çš„åŸºé‡‘è¯´æ˜å®ƒå¾ˆç¨³ä½ åŸºæœ¬ä¸Šå¯ä»¥ç¡®å®šæ ¹æ®7æ—¥å¹´åŒ–æ”¶ç›Šç‡è®¡ç®—å‡ºçš„æ”¶ç›Šå°±æ˜¯æ˜å¤©çš„æ”¶ç›Š.åä¹‹é£é™©è¶Šé«˜,é‚£å®ƒçš„7æ—¥å¹´åŒ–æ”¶ç›Šç‡å°±çœŸçš„åªèƒ½å‚è€ƒäº†.æ‰€ä»¥ä¸èƒ½ç›²ç›®çœ‹å¹´åŒ–æ”¶ç›Šç‡ä¹Ÿè¦çœ‹ä¸€ä¸‹é£é™©ç­‰çº§.</li>
</ol>
<p>å†™åˆ°è¿™é‡Œç»ˆäºç»“æŸäº†,ä¸ç»æ„é—´ä¸€ç¼•é˜³å…‰æ‚„æ‚„çš„ç©¿è¿‡æ ‘å¶çš„ç¼éš™æ´’è½åœ¨ä¹¦æ¡Œä¸Š,å¿ƒé‡Œä¹Ÿä¸å†éš¾å—,ä½†çœ‹ç€ä½™é¢å®æ˜¨æ—¥çš„æ”¶ç›Š,ä¼¼ä¹æ„Ÿè§‰åˆ°å‰é¢çš„è·¯ä¾ç„¶å……æ»¡è†æ£˜.</p>
]]></content>
      <categories>
        <category>ç»æµå­¦</category>
      </categories>
  </entry>
  <entry>
    <title>VPNæ­å»º</title>
    <url>/2019/10/03/VPN%E6%90%AD%E5%BB%BA/</url>
    <content><![CDATA[<h3 id="IPåŠç«¯å£æ£€æµ‹"><a href="#IPåŠç«¯å£æ£€æµ‹" class="headerlink" title="IPåŠç«¯å£æ£€æµ‹"></a>IPåŠç«¯å£æ£€æµ‹</h3><blockquote>
<p>æ£€æµ‹è´­ä¹°çš„vps IPæ˜¯å¦è¢«å¢™</p>
</blockquote>
<p>æ£€æµ‹IPæ˜¯å¦è¢«å¢™:<a href="http://ping.chinaz.com">ç«™é•¿å·¥å…·</a>æˆ–è€…ä½¿ç”¨pingå‘½ä»¤ã€‚å»¶è¿Ÿå¤ªå¤§çš„IPï¼ˆ400+msï¼‰å»ºè®®è¿˜æ˜¯æ¢ä¸€ä¸ªã€‚</p>
<p>æ£€æµ‹ç«¯å£åœ¨å›½å†…æ˜¯å¦å¼€æ”¾:<a href="http://coolaf.com/tool/port">åœ¨çº¿æ£€æµ‹åŸŸåæˆ–è€…ipçš„ç«¯å£æ˜¯å¦å¼€æ”¾</a> ã€‚æ­å»ºå®Œåå¯ä»¥å†æ£€æŸ¥ä¸‹é…ç½®çš„ç«¯å£æ˜¯å¦åœ¨å›½å†…å¼€æ”¾ã€‚å…¶ä»–æ£€æµ‹ç½‘å€ï¼š<a href="https://www.toolsdaquan.com/ipcheck/">IPå¯ç”¨æ€§æ£€æµ‹å·¥å…·</a></p>
<p>æ£€æµ‹ç«¯å£åœ¨å›½å¤–æ˜¯å¦å¼€æ”¾:<a href="https://www.yougetsignal.com/tools/open-ports/">you get signal</a> ã€‚è¿™ä¸ªå…¶å®æ²¡ä»€ä¹ˆå¿…è¦ã€‚</p>
<h3 id="æ­å»ºss"><a href="#æ­å»ºss" class="headerlink" title="æ­å»ºss"></a>æ­å»ºss</h3><p>é¦–å…ˆä½ éœ€è¦ä¸€å°æœåŠ¡å™¨ï¼Œä»¥ä¾¿åœ¨æœåŠ¡å™¨ä¸Šæ­å»ºssã€‚å¯ä»¥åœ¨vulträ¸Šè´­ä¹°ä¸€ä¸ªvpsï¼Œä¹Ÿå¯ä»¥åœ¨å…¶ä»–ä¾›åº”å•†è´­ä¹°ã€‚ä¸‹é¢æ˜¯åŸºäºvultrçš„vpsæ­å»ºssï¼Œç”¨äºMacç«¯fq.</p>
<p>åœ¨æ­£å¼é…ç½®vpsä¹‹å‰,åŠ¡å¿…å…ˆç¡®ä¿vpsçš„IPåŠç«¯å£22æ²¡æœ‰è¢«å¢™.å¦åˆ™ä¸‹é¢çš„æ“ä½œç™½æ­.å› ä¸ºé¦–å…ˆä½ å¾—åœ¨å¢™å†…èƒ½å¤Ÿè®¿é—®ä½ çš„vps.</p>
<p>ç›®å‰æœ‰ä¸¤ç§æ–¹å¼æ­å»ºssï¼Œä¸€ç§æ˜¯åŸºäºCçš„shadowsocks-libevï¼ˆä»¥ä¸‹ç®€ç§°c-ssï¼‰ï¼Œä¸€ç§æ˜¯åŸºäºPythonçš„Shadowsocks-Pythonï¼ˆä»¥ä¸‹ç®€ç§°p-ssï¼‰ã€‚</p>
<h3 id="åŸºäºCçš„shadowsocks-libevï¼šï¼ˆæ¨èï¼‰"><a href="#åŸºäºCçš„shadowsocks-libevï¼šï¼ˆæ¨èï¼‰" class="headerlink" title="åŸºäºCçš„shadowsocks-libevï¼šï¼ˆæ¨èï¼‰"></a>åŸºäºCçš„shadowsocks-libevï¼šï¼ˆæ¨èï¼‰</h3><p>åŸºäºPythonçš„shadowsocks-server,ç›®å‰å·²ç»ä¸å†ç»´æŠ¤ï¼Œå› æ­¤å¾ˆå®¹æ˜“å°±è¢«qã€‚è¿™ä¸ªæ˜¯åŸºäºCçš„ã€‚</p>
<p>æ³¨æ„ï¼šä»¥ä¸‹å®‰è£…æ˜¯åœ¨centos7ä¸Šçš„ï¼Œä¸æ˜¯è¿™ä¸ªç³»ç»Ÿæˆ–ç‰ˆæœ¬çš„ä¸å»ºè®®å°è¯•ï¼Œè‚¯å®šä¼šæœ‰ä¸å…¼å®¹çš„åœ°æ–¹ã€‚å¦å¤–å®‰è£…çš„åº“çš„ç‰ˆæœ¬æœ€å¥½ä¹Ÿåˆ«éšæ„å‡çº§ï¼Œå¦åˆ™ä¹Ÿä¼šå‡ºå„ç§å…¼å®¹é—®é¢˜ï¼Œå¾ˆæµªè´¹æ—¶é—´ã€‚å½“ç„¶å¦‚æœä½ æ˜¯é«˜æ‰‹çˆ±æŠ˜è…¾å¯ä»¥è¯•è¯•è£…åœ¨centos9ä¸Šæˆ–è€…å‡çº§å®‰è£…åº“ç‰ˆæœ¬å•¥çš„ã€‚</p>
<p>ä¸»è¦å‚è€ƒï¼š</p>
<p><a href="http://fhaoer.com/20190617-shadowsocks-libev/">å®‰è£…å¹¶é…ç½®shadowsocks-libevï¼ˆyumæºæ–¹å¼ï¼‰</a>  æ²¡äº†</p>
<p><a href="https://www.shopee6.com/web/web-tutorial/centos7-bbr.html">CentOS7å‡çº§æ–°ç‰ˆå†…æ ¸å¼€å¯BBRåŠ é€Ÿæœ€æ–°å›¾æ–‡æ•™ç¨‹</a>  æ²¡äº†</p>
<p><a href="https://www.zhoulujun.cn/html/tools/NetTools/throughGFW/8459.html">ææ‡‚SSR(3)ï¼šCentos 7å®‰è£…é…ç½®shadowsocks-libevè®°å½•â€”éä¸€é”®è„šæœ¬</a></p>
<p><a href="https://tie.pub/2019/11/how-to-deploy-google-bbr-on-centos-7/">æ€æ ·åœ¨ CentOS 7 ä¸Šéƒ¨ç½² Google BBR</a></p>
<p>æ­¥éª¤ï¼š</p>
<ol>
<li>å®‰è£…å¸¸ç”¨å·¥å…·</li>
<li>å®‰è£…ç¼–è¯‘å·¥å…·gcc</li>
<li>å®‰è£…åŠ å¯†åº“libsodium</li>
<li>å®‰è£…tlsåº“mbedtls</li>
<li>å®‰è£…æ··æ·†æ’ä»¶ simple-obfs</li>
<li>å®‰è£…ss (é‡‡ç”¨çš„æ˜¯ç¼–è¯‘æºç çš„å®‰è£…æ–¹å¼ï¼Œå’Œå…¶ä»–åœ°æ–¹çš„å®‰è£…æ–¹å¼ä¸ä¸€æ ·)</li>
<li>åˆ›å»ºè´¦å·é…ç½®æ–‡ä»¶</li>
<li>å¼€æ”¾é˜²ç«å¢™ç«¯å£</li>
<li>å¼€å¯æœåŠ¡</li>
<li>åŠ é€Ÿä¼˜åŒ–bbr</li>
</ol>
<p>ps:æœ‰è¿™ä¹ˆå¤šæ­¥éª¤æ˜¯å› ä¸ºé‡‡ç”¨çš„æ˜¯æºç ç¼–è¯‘å®‰è£…çš„æ–¹å¼ã€‚</p>
<p>å…·ä½“å¦‚ä¸‹ï¼š</p>
<p>1.å®‰è£…å¸¸ç”¨å·¥å…·</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">yum <span class="keyword">install</span> git wget vim -y</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå®‰è£…äº†gitï¼Œwgetï¼Œvimã€‚</p>
<p>2.å®‰è£…ç¼–è¯‘å·¥å…·gcc</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">yum install epel-release gcc gettext <span class="built_in">auto</span>conf libtool <span class="built_in">auto</span>make make asciidoc xmlto c-ares-devel libev-devel pcre-devel -y</span><br></pre></td></tr></table></figure>
<p>ps:ä¸Šé¢æ˜¯ä¸€è¡Œå‘½ä»¤ã€‚å®‰è£…äº†å¾ˆå¤šä¸ªè½¯ä»¶åŒ…ã€‚</p>
<p>3.å®‰è£…åŠ å¯†åº“libsodium</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> LIBSODIUM_VER=1.0.17</span><br><span class="line">wget https://download.libsodium.org/libsodium/releases/libsodium-<span class="variable">$LIBSODIUM_VER</span>.tar.gz</span><br><span class="line">tar xvf libsodium-<span class="variable">$LIBSODIUM_VER</span>.tar.gz</span><br><span class="line"><span class="built_in">pushd</span> libsodium-<span class="variable">$LIBSODIUM_VER</span></span><br><span class="line">./configure --prefix=/usr &amp;&amp; make</span><br><span class="line"><span class="built_in">sudo</span> make install</span><br><span class="line"><span class="built_in">popd</span></span><br><span class="line"><span class="built_in">sudo</span> ldconfig</span><br></pre></td></tr></table></figure>
<p>4.å®‰è£…mbedtls</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">wget</span> https://github.com/Mbed-TLS/mbedtls/archive/refs/tags/mbedtls-<span class="number">2</span>.<span class="number">6</span>.<span class="number">0</span>.tar.gz</span><br><span class="line"><span class="attribute">tar</span> xvf mbedtls-<span class="number">2</span>.<span class="number">6</span>.<span class="number">0</span>.tar.gz</span><br><span class="line"><span class="attribute">pushd</span> mbedtls-mbedtls-<span class="number">2</span>.<span class="number">6</span>.<span class="number">0</span></span><br><span class="line"><span class="attribute">make</span> SHARED=<span class="number">1</span> CFLAGS=-fPIC</span><br><span class="line"><span class="attribute">sudo</span> make DESTDIR=/usr install</span><br><span class="line"><span class="attribute">popd</span></span><br><span class="line"><span class="attribute">sudo</span> ldconfig</span><br></pre></td></tr></table></figure>
<p>psï¼šmbedtlsçš„ç‰ˆæœ¬ä¸è¦ä¸‹æœ€æ–°çš„ï¼Œå¦åˆ™ç¼–è¯‘çš„æ—¶å€™ä¼šæŠ¥é”™ï¼šâ€œé”™è¯¯ï¼šåªå…è®¸åœ¨ C99 æ¨¡å¼ä¸‹ä½¿ç”¨â€˜forâ€™å¾ªç¯åˆå§‹åŒ–å£°æ˜â€ã€‚æœ‰æ—¶å€™è§£å†³äº†è¿™é‡Œä½†åé¢å®‰è£…ssçš„æ—¶å€™sudo make installä¸€ç›´æŠ¥é”™ã€‚é™¤éä½ æœ‰å¡«å‘çš„èƒ½åŠ›ï¼Œå¦åˆ™å»ºè®®è¿˜æ˜¯ä½¿ç”¨2.6.0ç‰ˆæœ¬çš„ã€‚</p>
<p>psï¼šå¡«å‘ç½‘ä¸Šæ•™ç¨‹ã€‚ä»¥ä¸‹æ˜¯ç½‘ä¸Šè¿‡æ—¶çš„å‘½ä»¤</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> MBEDTLS_VER=2.6.0</span><br><span class="line">wget https://tls.mbed.org/download/mbedtls-<span class="variable">$MBEDTLS_VER</span>-gpl.tgz</span><br><span class="line">tar xvf mbedtls-<span class="variable">$MBEDTLS_VER</span>-gpl.tgz</span><br><span class="line"><span class="built_in">pushd</span> mbedtls-<span class="variable">$MBEDTLS_VER</span></span><br><span class="line">make SHARED=1 CFLAGS=-fPIC</span><br><span class="line"><span class="built_in">sudo</span> make DESTDIR=/usr install</span><br><span class="line"><span class="built_in">popd</span></span><br><span class="line"><span class="built_in">sudo</span> ldconfig</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸€æ­¥<code>wget https://tls.mbed.org/download/mbedtls-$MBEDTLS_VER-gpl.tgz</code></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">root@Tokyo6Dollor ~</span>]<span class="meta"># file mbedtls-2.6.0-gpl.tgz</span></span><br><span class="line">mbedtls<span class="number">-2.6</span><span class="number">.0</span>-gpl.tgz: HTML document, ASCII text, <span class="keyword">with</span> very <span class="built_in">long</span> lines</span><br></pre></td></tr></table></figure>
<p>ä¸‹è½½åœ°å€æ— æ•ˆäº†ï¼Œå¯¼è‡´ä¸‹è½½çš„å…¶å®æ˜¯ä¸€ä¸ªç½‘é¡µã€‚åé¢è§£å‹ç¼©è‡ªç„¶å¤±è´¥ã€‚æ‰¾äº†ä¸€åœˆèµ„æ–™ï¼Œçœ‹åˆ°ä¸€ä¸ªå¤‡ç”¨ä¸‹è½½åœ°å€ï¼š</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">https</span>://down.<span class="number">24</span>kplus.com/linux/mbedtls/mbedtls-<span class="number">2</span>.<span class="number">16</span>.<span class="number">3</span>-gpl.tgz</span><br></pre></td></tr></table></figure>
<p>ç»“æœå‘ç°ç°åœ¨å¤‡ç”¨åœ°å€ä¹Ÿä¸è¡Œäº†ï¼Œå»ºè®®ç›´æ¥å»githubä¸Šä¸‹è½½ï¼Œ<a href="https://github.com/Mbed-TLS/mbedtls">Mbed-TLS</a> .</p>
<p>5.å®‰è£…æ··æ·†æ’ä»¶</p>
<p>é¦–å…ˆå®‰è£…ç¼–è¯‘å¿…é¡»çš„è½¯ä»¶</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">yum <span class="keyword">install</span> zlib-devel openssl-devel -y</span><br></pre></td></tr></table></figure>
<p>å®‰è£… simple-obfs</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">git clone https:<span class="string">//github.com/shadowsocks/simple-obfs.git</span></span><br><span class="line"><span class="keyword">cd</span> simple-obfs</span><br><span class="line">git submodule update <span class="params">--init</span> <span class="params">--recursive</span></span><br><span class="line"><span class="string">./autogen.sh</span></span><br><span class="line"><span class="string">./configure</span> &amp;&amp; make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>6.å®‰è£…ss</p>
<p>ä¸‹è½½æºç :</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">git clone https:<span class="string">//github.com/shadowsocks/shadowsocks-libev.git</span></span><br><span class="line"><span class="keyword">cd</span> shadowsocks-libev</span><br><span class="line">git submodule update <span class="params">--init</span> <span class="params">--recursive</span></span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘æºç å¹¶å®‰è£…:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> shadowsocks-libev //ç¡®ä¿æ˜¯åœ¨ ss ç›®å½•ä¸­æ‰§è¡Œç¼–è¯‘ã€‚å·²ç»åœ¨äº†å°±ä¸ç”¨ç®¡</span><br><span class="line">./autogen.sh &amp;&amp; ./configure &amp;&amp; make</span><br><span class="line"><span class="built_in">sudo</span> make install</span><br></pre></td></tr></table></figure>
<p>psï¼šsudo make install æç¤ºã€‚</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">[root@centos7<span class="number">-5</span> <span class="keyword">shadowsocks-libev]# </span>sudo make <span class="keyword">install</span></span><br><span class="line"><span class="keyword"></span><span class="symbol">make:</span> *** æ²¡æœ‰è§„åˆ™å¯ä»¥åˆ›å»ºç›®æ ‡â€œ<span class="keyword">installâ€ã€‚ </span>åœæ­¢ã€‚</span><br></pre></td></tr></table></figure>
<p>mbedtlsç‰ˆæœ¬ä¸å¯¹ï¼Œç”¨äº†æœ€æ–°ç‰ˆçš„v3.2.1ï¼Œæ¢å›2.6.0å°±æ²¡é—®é¢˜äº†ï¼Œè¿™é‡Œæäº†ä¸€å¤©ã€‚</p>
<p>7.åˆ›å»ºè´¦å·é…ç½®æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /etc/shadowsocks-libev</span><br><span class="line">vim /etc/shadowsocks-libev/config.json</span><br></pre></td></tr></table></figure>
<p>è¾“å…¥ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;server&quot;</span><span class="punctuation">:</span><span class="string">&quot;0.0.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;port_password&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;port1&quot;</span><span class="punctuation">:</span><span class="string">&quot;pass1&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;port2&quot;</span><span class="punctuation">:</span><span class="string">&quot;pass2&quot;</span></span><br><span class="line">     <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timeout&quot;</span><span class="punctuation">:</span><span class="number">300</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span><span class="string">&quot;chacha20-ietf-poly1305&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span><span class="string">&quot;tcp_and_udp&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;fast_open&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;workers&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;plugin&quot;</span><span class="punctuation">:</span><span class="string">&quot;obfs-server&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;plugin_opts&quot;</span><span class="punctuation">:</span><span class="string">&quot;obfs=http;fast-open&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>è¯¥æ›¿æ¢çš„æ›¿æ¢ã€‚è¿™é‡Œæ˜¯å¤šç«¯å£çš„é…ç½®ã€‚</p>
<p>æ³¨æ„ï¼šä¸Šé¢åŒ…å«äº† simple-obfs æ··æ·†æ’ä»¶ï¼Œå¦‚æœæ²¡æœ‰å®‰è£…è¯¥æ’ä»¶ï¼Œè¯·å»æ‰æœ€åä¸¤è¡Œã€‚</p>
<p>8.å¼€æ”¾é˜²ç«å¢™ç«¯å£</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">firewall-cmd --permanent <span class="attribute">--zone</span>=public <span class="attribute">--add-port</span>=xxx/udp </span><br><span class="line">firewall-cmd --permanent <span class="attribute">--zone</span>=public <span class="attribute">--add-port</span>=xxx/tcp </span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p>xxxä¸ºç«¯å£å·ï¼Œè¯·æ›¿æ¢ä¸ºä½ çš„å®é™…ç«¯å£ã€‚</p>
<p>9.å¼€å¯æœåŠ¡</p>
<p>é€šè¿‡ä½¿ç”¨åˆ›å»ºå¥½çš„é…ç½®æ–‡ä»¶æ¥å¯åŠ¨</p>
<p>å•ä¸ªç«¯å£å·é…ç½®ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">nohup</span> ss-server -c /etc/shadowsocks-libev/config.json &amp;</span><br></pre></td></tr></table></figure>
<p>å¤šä¸ªç«¯å£å·é…ç½®ï¼šï¼ˆä¸Šé¢é…çš„æ˜¯å¤šç«¯å£ï¼Œè¿™é‡Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼‰</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">nohup</span> ss-manager -c /etc/shadowsocks-libev/config.json &amp;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼šè¿™é‡Œå¹¶æ²¡æœ‰è®¾ç½®å¼€æœºè‡ªå¯åŠ¨ï¼Œå› æ­¤å¦‚æœé‡å¯äº†æœåŠ¡å™¨é‚£ä¹ˆå¿…é¡»è¦é‡æ–°å¯åŠ¨ssæœåŠ¡ã€‚</p>
<h4 id="c-sså¤šç«¯å£é…ç½®"><a href="#c-sså¤šç«¯å£é…ç½®" class="headerlink" title="c-sså¤šç«¯å£é…ç½®"></a>c-sså¤šç«¯å£é…ç½®</h4><p>ä¸Šé¢çœ‹åˆ°é‡‡ç”¨æºç çš„å®‰è£…æ–¹å¼å¯ä»¥æ”¯æŒå¤šç«¯å£çš„é…ç½®æ–‡ä»¶ã€‚</p>
<p>å¦‚æœä½¿ç”¨çš„æ˜¯åˆ«äººå°è£…çš„è„šæœ¬å®‰è£…å¯èƒ½ä¸æ”¯æŒå¤šç«¯å£ï¼Œè¿™æ—¶å¯ä»¥åˆ›å»ºå¤šä¸ªé…ç½®æ–‡ä»¶è¾¾åˆ°å¤šç«¯å£çš„æ•ˆæœã€‚è¿™é‡Œç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šæ•™ç¨‹ã€‚</p>
<h4 id="å‘"><a href="#å‘" class="headerlink" title="å‘"></a>å‘</h4><p>å‘1ï¼šshadowsocks-libevçš„é…ç½®æ–‡ä»¶çš„serverè¢«æˆ‘å†™æˆäº†127.0.0.1ç»“æœç¿»ä¸äº†å¢™ï¼Œå¤–éƒ¨æ£€æµ‹ç«¯å£çš„ç»“æœæ˜¯å…³é—­çš„ã€‚</p>
<p>æ­£ç¡®å¦‚ä¸‹ï¼Œè®¾ç½®ä¸º0.0.0.0å³å¯ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;server&quot;</span><span class="punctuation">:</span><span class="string">&quot;0.0.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>å‘2ï¼šæœ‰æ—¶å€™æ­å»ºå®Œæˆäº†ï¼Œipç«¯å£ä¹Ÿéƒ½æ²¡è¢«qï¼Œä½†æ˜¯å°±æ˜¯æ‰“ä¸å¼€Googleï¼Œæˆ–è€…éå¸¸æ…¢ã€‚ä¸å¤ªæ¸…æ¥šä»€ä¹ˆæƒ…å†µã€‚</p>
<p>æ„Ÿè§‰å¯èƒ½æ˜¯shadowsockså®¢æˆ·ç«¯æœ‰é—®é¢˜ï¼Œé‡å¯ç”µè„‘åï¼Œå¯ä»¥æ‰“å¼€Googleäº†ã€‚è¿˜é‡åˆ°ä¸€ä¸ªå¥‡è‘©é—®é¢˜ï¼Œé…ç½®å®Œåå¯ä»¥æ‰“å¼€Googleï¼Œä½†æ˜¯å¼€å¯bbråå°±å®Œå…¨ç¿»ä¸äº†å¢™ã€‚æ‰€ä»¥ç°åœ¨æš‚æ—¶å…ˆä¸å¼€èµ·bbräº†ã€‚ç”¨äº†ä¸€æ®µæ—¶é—´åå‘ç°è¿˜æ˜¯ä¸è¡Œäº†ï¼Œipå’Œç«¯å£ä¹Ÿéƒ½æ²¡è¢«å°ï¼Œä¸çŸ¥é“ä»€ä¹ˆåŸå› äº†ã€‚</p>
<h3 id="é˜²ç«å¢™"><a href="#é˜²ç«å¢™" class="headerlink" title="é˜²ç«å¢™"></a>é˜²ç«å¢™</h3><p><strong>æŸ¥çœ‹å¼€å¯çš„ç«¯å£:</strong>  </p>
<p><code>firewall-cmd --list-ports</code></p>
<p><strong>å¼€å¯ç‰¹å®šç«¯å£:</strong></p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">firewall-cmd --permanent <span class="attribute">--zone</span>=public <span class="attribute">--add-port</span>=4500/udp </span><br><span class="line">firewall-cmd --permanent <span class="attribute">--zone</span>=public <span class="attribute">--add-port</span>=4500/tcp </span><br></pre></td></tr></table></figure>
<p>å¯¹åº”çš„<strong>åˆ é™¤ç‰¹å®šç«¯å£:</strong></p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">firewall-cmd --permanent <span class="attribute">--zone</span>=public <span class="attribute">--remove-port</span>=4500/udp </span><br><span class="line">firewall-cmd --permanent <span class="attribute">--zone</span>=public <span class="attribute">--remove-port</span>=4500/tcp </span><br></pre></td></tr></table></figure>
<p><strong>ä½¿ç«¯å£ç”Ÿæ•ˆ</strong>ï¼š <code>firewall-cmd --reload</code> </p>
<p><strong>æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€</strong>ï¼š<code>firewall-cmd --state</code></p>
<p><strong>å¯åŠ¨é˜²ç«å¢™</strong>: <code>systemctl start firewalld.service</code>  </p>
<p><strong>é‡å¯é˜²ç«å¢™:</strong>  <code>systemctl restart firewalld.service</code></p>
<p>å¦‚æœæç¤º:</p>
<p><code>Failed to start firewalld.service: Unit is masked.</code></p>
<p>è¿™æ˜¯ç”±äºfirewalldæœåŠ¡è¢«é”å®šäº†.</p>
<p>å–æ¶ˆfirewalldçš„é”å®š: <code>systemctl unmask firewalld</code>.</p>
<p>é‡æ–°é”å®šfirewalldæ—¶æ‰§è¡Œå‘½ä»¤: <code>systemctl mask firewalld</code></p>
<p><strong>å‚è€ƒ</strong>:</p>
<p><a href="https://blog.csdn.net/zll_0405/article/details/81208606">CentOS7å¼€å¯é˜²ç«å¢™åŠç‰¹å®šç«¯å£</a></p>
<h3 id="BBRåŠ é€Ÿ"><a href="#BBRåŠ é€Ÿ" class="headerlink" title="BBRåŠ é€Ÿ"></a>BBRåŠ é€Ÿ</h3><p><a href="https://blog.naibabiji.com/skill/centos7-an-zhuang-bbr.html">CentOS7å®‰è£…æ–°ç‰ˆå†…æ ¸å’Œå¼€å¯BBRåŠ é€Ÿæ•™ç¨‹_BBR2ä¸€é”®åŒ…</a> </p>
<p>æ­¥éª¤ï¼š</p>
<p>1.å‡çº§æœåŠ¡å™¨å†…æ ¸ç‰ˆæœ¬</p>
<p>2.å®‰è£…BBR</p>
<p>å…·ä½“å¦‚ä¸‹ï¼š</p>
<p>1.å‡çº§æœåŠ¡å™¨å†…æ ¸ç‰ˆæœ¬</p>
<p>1.1é¦–å…ˆæ˜¯æŸ¥çœ‹å½“å‰æœåŠ¡å™¨çš„å†…æ ¸ç‰ˆæœ¬ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">uname</span> -sr</span><br></pre></td></tr></table></figure>
<p>BBRå†…æ ¸è¦æ±‚æ˜¯4.9+ï¼Œé€šå¸¸æ¥è¯´ä½ é€šè¿‡ä¸Šé¢è¿™ä¸ªå‘½ä»¤å‡ºæ¥çš„å†…æ ¸ç‰ˆæœ¬æ˜¯åœ¨3.å‡ ã€‚æ¯”å¦‚ï¼š</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Linux</span> <span class="number">3</span>.<span class="number">10</span>.<span class="number">0</span>-<span class="number">1160</span>.<span class="number">71</span>.<span class="number">1</span>.el7.x86_64</span><br></pre></td></tr></table></figure>
<p>1.2 å‡çº§</p>
<p>ç›´æ¥å‚è€ƒä¸Šé¢çš„é“¾æ¥ï¼Œå¾ˆè¯¦ç»†ã€‚</p>
<p>2.å®‰è£…BBR</p>
<p>è¦åœ¨æ–°å®‰è£…å¥½çš„CentOS7ä¸Šé¢å¯ç”¨æ–°å†…æ ¸ï¼Œåªéœ€è¦å¤åˆ¶ä¸‹é¢çš„ä»£ç æ‰§è¡Œå°±å¯ä»¥äº†ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;net.core.default_qdisc=fq&#x27;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> -a /etc/sysctl.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;net.ipv4.tcp_congestion_control=bbr&#x27;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> -a /etc/sysctl.conf</span><br><span class="line"><span class="built_in">sudo</span> sysctl -p</span><br></pre></td></tr></table></figure>
<p>ç„¶åè¾“å…¥ä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹æ˜¯å¦å¼€å¯BBRæˆåŠŸ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> sysctl net.ipv4.tcp_available_congestion_control</span><br></pre></td></tr></table></figure>
<p>æˆåŠŸçš„è¯åº”è¯¥æ˜¯ä¸‹é¢è¿™ç§è¾“å‡º</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">net.ipv4.tcp_available_congestion_control</span> = re<span class="literal">no</span> cubic bbr</span><br></pre></td></tr></table></figure>
<h3 id="iPhoneç¿»å¢™"><a href="#iPhoneç¿»å¢™" class="headerlink" title="iPhoneç¿»å¢™"></a>iPhoneç¿»å¢™</h3><p>æ‰‹æœºç¿»å¢™æœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<ol>
<li><p>é€šè¿‡åœ¨è®¾ç½®appé‡Œæ·»åŠ é…ç½®æ–‡ä»¶ã€‚è¿™ä¸ªæ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œå°±ä¸ä»‹ç»äº†ã€‚</p>
</li>
<li><p>å®‰è£…ä¸“é—¨çš„appï¼Œåœ¨appé‡Œå¡«ä¹‹å‰çš„é…ç½®ä¿¡æ¯ï¼Œè¿™ä¸ªæœ€ç®€å•ã€‚ï¼ˆæ¨èä½¿ç”¨ï¼‰</p>
</li>
</ol>
<p>ä¸‹é¢æ˜¯ç¬¬ä¸€ç§æ–¹å¼ï¼š</p>
<p>æ­å»ºIPsec/L2TP VPN</p>
<p><a href="https://wistbean.github.io/ipsec,l2tp_vpn.html#%E4%BD%BF%E7%94%A8-IPsec-L2TP-%E8%84%9A%E6%9C%AC%E6%90%AD%E5%BB%BA">CentOSå¿«é€Ÿæ­å»ºä¸€ä¸ªå±äºè‡ªå·±çš„IPsec/L2TP VPN</a></p>
<p>ç¬¬äºŒç§æ–¹å¼ï¼š</p>
<p>ä¸‹è½½APPï¼špotatso liteï¼Œéœ€è¦ç™»å½•ç¾åŒºè´¦å·ä¸‹è½½ã€‚ä¸‹è½½åå¡«å†™é…ç½®ä¿¡æ¯å³å¯ã€‚</p>
<h3 id="åŸºäºPythonçš„Shadowsocks-Pythonï¼ˆä¸æ¨èï¼Œå®¹æ˜“è¢«å°ç«¯å£ï¼‰"><a href="#åŸºäºPythonçš„Shadowsocks-Pythonï¼ˆä¸æ¨èï¼Œå®¹æ˜“è¢«å°ç«¯å£ï¼‰" class="headerlink" title="åŸºäºPythonçš„Shadowsocks-Pythonï¼ˆä¸æ¨èï¼Œå®¹æ˜“è¢«å°ç«¯å£ï¼‰"></a>åŸºäºPythonçš„Shadowsocks-Pythonï¼ˆä¸æ¨èï¼Œå®¹æ˜“è¢«å°ç«¯å£ï¼‰</h3><p><a href="https://wistbean.github.io/vultr-vps-bbr-ss.html">ä½¿ç”¨vultr(vps)æ­å»ºsså¹¶å¼€å¯BBRå¿«é€Ÿä¸Šç½‘æ•™ç¨‹ è¶…ç®€å•10åˆ†é’Ÿæå®š</a></p>
<p><a href="https://www.ailophy.com/2018/07/14/vpn/">ä»é›¶å¼€å§‹äºVulträ¸Šæ­å»ºå±äºè‡ªå·±çš„VPNæœåŠ¡å™¨ã€CentOS7+Shadowsocks+serverspeederåŠ é€Ÿ+é˜²å‘æŒ‡åŒ—ã€‘ã€é€‚åˆæ–°æ‰‹ã€‘</a></p>
<h4 id="p-sså¤šç«¯å£é…ç½®"><a href="#p-sså¤šç«¯å£é…ç½®" class="headerlink" title="p-sså¤šç«¯å£é…ç½®"></a>p-sså¤šç«¯å£é…ç½®</h4><p>é»˜è®¤æƒ…å†µä¸‹åªä¼šæœ‰ä¸€ä¸ªç«¯å£ã€‚</p>
<p>å¤šç«¯å£æ ¼å¼ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;server&quot;</span><span class="punctuation">:</span><span class="string">&quot;0.0.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;local_address&quot;</span><span class="punctuation">:</span><span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;local_port&quot;</span><span class="punctuation">:</span><span class="number">1080</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;port_password&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;xxxç«¯å£&quot;</span><span class="punctuation">:</span><span class="string">&quot;xxxå¯†ç &quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;xxxç«¯å£&quot;</span><span class="punctuation">:</span><span class="string">&quot;xxxå¯†ç &quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;xxxç«¯å£&quot;</span><span class="punctuation">:</span><span class="string">&quot;xxxå¯†ç &quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timeout&quot;</span><span class="punctuation">:</span><span class="number">300</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span><span class="string">&quot;aes-256-cfb&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fast_open&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>æœ€åè¦è®°å¾—é‡å¯ä¸‹shadowsocksï¼š<code>service shadowsocks restart</code> </p>
<p>ç›¸å…³å‘½ä»¤ï¼š<br>å¯åŠ¨ï¼šservice shadowsocks start<br>åœæ­¢ï¼šservice shadowsocks stop<br>é‡å¯ï¼šservice shadowsocks restart<br>çŠ¶æ€ï¼šservice shadowsocks status</p>
<p>å¦‚æœä½ çš„vpså¼€å¯äº†é˜²ç«å¢™,åˆ™è¿˜éœ€è¦å¼€å¯ç‰¹å®šç«¯å£.å¦åˆ™å¯èƒ½è¿æ¥ä¸ä¸Š.å¼€å¯é˜²ç«å¢™ç«¯å£ç§»æ­¥é˜²ç«å¢™éƒ¨åˆ†ã€‚</p>
<h4 id="p-ssçš„ä»£ç†ç«¯å£è¢«å¢™è§£å†³"><a href="#p-ssçš„ä»£ç†ç«¯å£è¢«å¢™è§£å†³" class="headerlink" title="p-ssçš„ä»£ç†ç«¯å£è¢«å¢™è§£å†³"></a>p-ssçš„ä»£ç†ç«¯å£è¢«å¢™è§£å†³</h4><p>è§£å†³åŠæ³•:ç™»å½•<code>ssh root@&lt;ip&gt;</code>,æ›´æ¢SSæœåŠ¡ç«¯å£.</p>
<p>ç¼–è¾‘ShadowSocksé…ç½®æ–‡ä»¶:<code>vi /etc/shadowsocks.json</code> ã€‚ä¿®æ”¹ç«¯å£ï¼Œä¿å­˜ã€‚</p>
<p>é‡å¯æœåŠ¡ï¼š<code>ssserver -c /etc/shadowsocks.json -d restart</code></p>
<p>åˆ«å¿˜äº†å¦‚æœä½ çš„vpså¼€å¯äº†é˜²ç«å¢™,åˆ™è¿˜éœ€è¦åœ¨é˜²ç«å¢™ä¸­å¼€å¯ä¸Šè¿°ç«¯å£.</p>
<p>å‚è€ƒ:</p>
<p><a href="https://www.flyzy2005.com/fan-qiang/tcp-blocked/">æœåŠ¡å™¨IPèƒ½Pingé€šï¼ŒSSHèƒ½è¿æ¥ï¼Œä»£ç†å´è¿ä¸ä¸Šçš„è¯´æ˜ä¸è§£å†³</a></p>
<p><a href="https://www.sinocalife.com/change-ports-to-prevent-ss-from-banning">ShadowSocksï¼šæ›´æ”¹SSç«¯å£å·é˜²æ­¢è¢«å¢™</a></p>
<h3 id="å‘-1"><a href="#å‘-1" class="headerlink" title="å‘"></a>å‘</h3><p>å‘1ï¼š <code>ssh root@&lt;ip&gt;</code> ç™»å½•ä¸ä¸Š  </p>
<p>ç™»å½•ä¸ä¸Šçš„åŸå› æœ‰å¾ˆå¤šã€‚å¯ä»¥åˆ†åˆ«å°è¯•ä¸‹é¢çš„è§£å†³åŠæ³•ï¼š</p>
<p>1.ä½¿ç”¨vpsæœåŠ¡å•†è‡ªèº«æä¾›çš„ç½‘é¡µç‰ˆç»ˆç«¯ç™»å½•ä¸€æ¬¡ï¼Œæ¿€æ´»22ç«¯å£ã€‚</p>
<p>2.å¯èƒ½æ˜¯é‡æ–°è´­ä¹°çš„vpså’Œä¸Šä¸€æ¬¡çš„IPç›¸åŒå¯¼è‡´.éœ€è¦å°†æœ¬åœ° <code>/.ssh/known_hosts</code> ä¹‹å‰çš„é‚£ä¸€æ¡è®°å½•åˆ é™¤æ‰.é‡å¯ç»ˆç«¯.</p>
<p>å‘2ï¼šæŒ‰ç…§ç½‘ä¸Šçš„æ•™ç¨‹æ­¥éª¤æ€»æ˜¯å¤±è´¥æç¤º<code>[Error] libsodium-1.0.17 install failed</code>  </p>
<p>å‘ç°æ˜¯ç½‘ä¸Šçš„è„šæœ¬ä¸æ”¯æŒcentOS8,è€Œè´­ä¹°vpsæ—¶é»˜è®¤æ˜¯centOS8,æ‰€ä»¥åœ¨è´­ä¹°æ—¶éœ€è¦æ‰‹åŠ¨é€‰æ‹©ä¸ºcentOS7.æœ€å¥½çš„åŠæ³•æ˜¯ç ”ç©¶ä¸€ä¸‹è„šæœ¬å†…å®¹,è‡ªå·±æ•´.</p>
<p>å› æ­¤ï¼Œåœ¨æŒ‰ç…§æ•™ç¨‹æ­¥éª¤å‰ï¼Œä¸€å®šè¦çœ‹æ¸…æ¥šï¼Œæ“ä½œç³»ç»Ÿçš„ç‰ˆæœ¬æ˜¯ä¸æ˜¯ä¸€è‡´ï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´å„ç§é€‚é…é—®é¢˜ã€‚</p>
<h3 id="ç–‘é—®"><a href="#ç–‘é—®" class="headerlink" title="ç–‘é—®"></a>ç–‘é—®</h3><h4 id="1-å¦‚ä½•æŸ¥çœ‹ç«¯å£åœ¨è¢«å“ªä¸ªç¨‹åºorè¿›ç¨‹ä½¿ç”¨ï¼Ÿ"><a href="#1-å¦‚ä½•æŸ¥çœ‹ç«¯å£åœ¨è¢«å“ªä¸ªç¨‹åºorè¿›ç¨‹ä½¿ç”¨ï¼Ÿ" class="headerlink" title="1. å¦‚ä½•æŸ¥çœ‹ç«¯å£åœ¨è¢«å“ªä¸ªç¨‹åºorè¿›ç¨‹ä½¿ç”¨ï¼Ÿ"></a>1. å¦‚ä½•æŸ¥çœ‹ç«¯å£åœ¨è¢«å“ªä¸ªç¨‹åºorè¿›ç¨‹ä½¿ç”¨ï¼Ÿ</h4><p>æ£€æŸ¥ç«¯å£è¢«å“ªä¸ªè¿›ç¨‹å ç”¨ï¼š<code>netstat -lnp|grep 80   #80ç«¯å£ï¼Œè‡ªè¡Œæ›´æ¢ï¼›å¦‚ï¼š8888</code> ï¼Œæ‰“å°å¦‚ä¸‹ï¼š</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">tcp</span>        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0.0.0:18388</span>           <span class="number">0.0.0.0</span>:*               LISTEN      <span class="number">982</span>/python</span><br><span class="line"><span class="attribute">tcp</span>        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0.0.0:8388</span>            <span class="number">0.0.0.0</span>:*               LISTEN      <span class="number">911</span>/ss-server</span><br><span class="line"><span class="attribute">udp</span>        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0.0.0:18388</span>           <span class="number">0.0.0.0</span>:*                           <span class="number">982</span>/python</span><br><span class="line"><span class="attribute">udp</span>        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0.0.0:8388</span>            <span class="number">0.0.0.0</span>:*                           <span class="number">911</span>/ss-server</span><br></pre></td></tr></table></figure>
<p>å®‰è£…ï¼š</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">yum <span class="keyword">install</span> net-tools</span><br></pre></td></tr></table></figure>
<h4 id="2-firewallçš„â€”add-portå‘½ä»¤æ˜¯ä¸æ˜¯çœŸçš„å¼€å¯äº†ä¸€ä¸ªç«¯å£ï¼Ÿ"><a href="#2-firewallçš„â€”add-portå‘½ä»¤æ˜¯ä¸æ˜¯çœŸçš„å¼€å¯äº†ä¸€ä¸ªç«¯å£ï¼Ÿ" class="headerlink" title="2. firewallçš„â€”add-portå‘½ä»¤æ˜¯ä¸æ˜¯çœŸçš„å¼€å¯äº†ä¸€ä¸ªç«¯å£ï¼Ÿ"></a>2. firewallçš„â€”add-portå‘½ä»¤æ˜¯ä¸æ˜¯çœŸçš„å¼€å¯äº†ä¸€ä¸ªç«¯å£ï¼Ÿ</h4><h4 id="3-æœåŠ¡å™¨å¼€å¯ä¸€ä¸ªç«¯å£ä½†ä¸ç»‘å®šä»»ä½•åº”ç”¨å¤–éƒ¨èƒ½è®¿é—®åˆ°å—ï¼Ÿ"><a href="#3-æœåŠ¡å™¨å¼€å¯ä¸€ä¸ªç«¯å£ä½†ä¸ç»‘å®šä»»ä½•åº”ç”¨å¤–éƒ¨èƒ½è®¿é—®åˆ°å—ï¼Ÿ" class="headerlink" title="3. æœåŠ¡å™¨å¼€å¯ä¸€ä¸ªç«¯å£ä½†ä¸ç»‘å®šä»»ä½•åº”ç”¨å¤–éƒ¨èƒ½è®¿é—®åˆ°å—ï¼Ÿ"></a>3. æœåŠ¡å™¨å¼€å¯ä¸€ä¸ªç«¯å£ä½†ä¸ç»‘å®šä»»ä½•åº”ç”¨å¤–éƒ¨èƒ½è®¿é—®åˆ°å—ï¼Ÿ</h4><p>ä½¿ç”¨ <code>firewall-cmd --zone=public --add-port=4500/udp --permanent</code> æ·»åŠ äº†ä¸€ä¸ªç«¯å£ï¼Œä½†å¤–éƒ¨æ£€æµ‹å´æ˜¯å…³é—­ä»€ä¹ˆåŸå› ï¼Ÿ</p>
<p>ä¸€ä¸ªç«¯å£å¼€å¯åä½†ä¸ç»‘å®šä»»ä½•åº”ç”¨ç¨‹åºï¼Œé‚£ä¹ˆå¯¹äºå¤–éƒ¨æ¥è¯´è¿™ä¸ªç«¯å£ä¾ç„¶æ˜¯å…³é—­çš„ï¼Œå› ä¸ºæ£€æµ‹è‚¯å®šæ˜¯ä¾æ®æŸä¸ªåè®®æ¥æ£€æµ‹çš„ï¼Œå¦‚æœç«¯å£æ²¡æœ‰ç»‘å®šä»»ä½•åº”ç”¨ï¼Œé‚£è‡ªç„¶å°±ä¸ä¼šæœ‰ä»»ä½•å›åº”ï¼Œå› æ­¤å¯¹äºå¤–éƒ¨æ¥è¯´è¿™ä¸ªç«¯å£ç­‰åŒäºå…³é—­ï¼Œè™½ç„¶å†…éƒ¨æŸ¥çœ‹è¯¥ç«¯å£å…¶å®æ˜¯å¼€å¯çš„ã€‚â€”ä¸ªäººçŒœæµ‹ï¼Œå¯èƒ½æ˜¯å®Œå…¨é”™è¯¯çš„ã€‚</p>
<h4 id="4-0-0-0-0-å’Œ-127-0-0-1çš„åŒºåˆ«"><a href="#4-0-0-0-0-å’Œ-127-0-0-1çš„åŒºåˆ«" class="headerlink" title="4. 0.0.0.0 å’Œ 127.0.0.1çš„åŒºåˆ«"></a>4. 0.0.0.0 å’Œ 127.0.0.1çš„åŒºåˆ«</h4><p><a href="https://www.jianshu.com/p/ad7cd1d5be45">å½»åº•æ˜ç™½ipåœ°å€ï¼ŒåŒºåˆ†localhostã€127.0.0.1å’Œ0.0.0.0</a></p>
<h4 id="5-shadowsocksæ˜¯å¦‚ä½•è¢«æ£€æµ‹å’Œå°é”çš„"><a href="#5-shadowsocksæ˜¯å¦‚ä½•è¢«æ£€æµ‹å’Œå°é”çš„" class="headerlink" title="5. shadowsocksæ˜¯å¦‚ä½•è¢«æ£€æµ‹å’Œå°é”çš„"></a>5. shadowsocksæ˜¯å¦‚ä½•è¢«æ£€æµ‹å’Œå°é”çš„</h4><p><a href="https://pincong.rocks/article/12173">ã€è¿˜Shadowsocksä¸€ä¸ªæ¸…ç™½ã€‘Shadowsocksæ˜¯å¦‚ä½•è¢«æ£€æµ‹å’Œå°é”çš„ï¼Œå…¼è°ˆssé…ç½®ç­–ç•¥</a></p>
]]></content>
      <categories>
        <category>ç§‘å­¦ä¸Šç½‘</category>
      </categories>
      <tags>
        <tag>VPN</tag>
      </tags>
  </entry>
  <entry>
    <title>OC nullabilityç‰¹æ€§</title>
    <url>/2019/10/01/OC%20nullability%E7%89%B9%E6%80%A7/</url>
    <content><![CDATA[<h3 id="OC-nullabilityç‰¹æ€§"><a href="#OC-nullabilityç‰¹æ€§" class="headerlink" title="OC nullabilityç‰¹æ€§"></a>OC nullabilityç‰¹æ€§</h3><p>ä¼—æ‰€å‘¨çŸ¥,Swiftè¯­è¨€æ˜¯ä¸¥æ ¼åŒºåˆ†å¯é€‰å’Œéå¯é€‰å˜é‡çš„.æ¯”å¦‚<code>UIView</code>å’Œ<code>UIView?</code>.è€Œåœ¨ä¹‹å‰çš„OCä¸­å´æ²¡æœ‰è¿™ä¸ªæ¦‚å¿µ,äºŒè€…éƒ½ä½¿ç”¨<code>UIView*</code>è¡¨ç¤º.ç”±äºSwiftç¼–è¯‘å™¨æ— æ³•æ ¹æ®<code>UIView*</code>åˆ¤æ–­è¯¥å˜é‡æ˜¯å¦æ˜¯å¯é€‰çš„.å› æ­¤è¯¥ç±»å‹åœ¨Swiftä¸­è¢«è§£é‡Šä¸ºéšå¼è§£åŒ…<code>UIView!</code>.è€Œåœ¨Swiftä¸­å¯¹ä¸€ä¸ªå€¼ä¸ºnilçš„å¯é€‰å˜é‡è¿›è¡Œå¼ºåˆ¶è§£åŒ…æ—¶å°†å¯¼è‡´å´©æºƒ.å› æ­¤ä½ å¿…é¡»æ—¶åˆ»è­¦æƒ•<code>UIView!</code>å˜é‡åœ¨æŸå¤„ä¼šä¸ä¼šè¢«èµ‹å€¼ä¸ºnil.è¿™ä¸ä»…å¸¦æ¥ä½¿ç”¨ä¸Šçš„ä¸ä¾¿,è€Œä¸”ä¹Ÿå½±å“ç¼–ç¨‹ä½“éªŒ.å› æ­¤æœ‰å¿…è¦è®©OCå…¼å®¹Swiftçš„Optionalç‰¹æ€§,æ–¹ä¾¿OCçš„ç±»åœ¨Swiftä¸­çš„ä½¿ç”¨.äºæ˜¯åœ¨Xcode 6.3 å¼€å§‹å®˜æ–¹ä¾¿ç»™OCæ·»åŠ äº†nullabilityåŠŸèƒ½.</p>
<p>nullability ç‰¹æ€§åŒ…å«<code>_Nullable</code> å’Œ <code>_Nonnull</code>è¿™ä¸¤ç§ä¿®é¥°ç¬¦.<code>_Nullable</code>è¡¨æ˜è¯¥å˜é‡å¯ä»¥ä¸ºnilæˆ–NULLå€¼.è€Œ<code>_Nonnull</code>è¡¨æ˜è¯¥å˜é‡ä¸èƒ½ä¸ºnilå€¼.ä¸¤ä¸ªå˜ç§å†™æ³•<code>nullable</code>,<code>nonnull</code>.</p>
<p>ç¤ºä¾‹å¦‚ä¸‹:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;Person.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> myCase  4</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> myCase == 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸ä½¿ç”¨</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Book</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithName:(<span class="built_in">NSString</span> *)name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *version;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="type">long</span> words;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *publicID;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *url;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) Person *author;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">Swiftæ¥å£å¦‚ä¸‹:</span></span><br><span class="line"><span class="comment">open class Book : NSObject &#123;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    public init!(name: String!)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    open var name: String!</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    open var version: String!</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    open var words: Int</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    open var publicID: String!</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    open var url: String!</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    open var author: Person!</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> myCase == 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¨èå†™æ³•.å±æ€§éƒ½ä¸å¯ä¸ºnil</span></span><br><span class="line"><span class="built_in">NS_ASSUME_NONNULL_BEGIN</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Book</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithName:(<span class="built_in">NSString</span> *)name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *version;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="type">long</span> words;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *publicID;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *url;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) Person *author;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NS_ASSUME_NONNULL_END</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> myCase == 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¨èå†™æ³•,ä¸ªåˆ«å±æ€§å¯ä¸ºnil</span></span><br><span class="line"><span class="built_in">NS_ASSUME_NONNULL_BEGIN</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Book</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithName:(<span class="built_in">NSString</span> *)name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *version;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="type">long</span> words;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">nullable</span>) <span class="built_in">NSString</span> *publicID;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">nullable</span>) <span class="built_in">NSString</span> *url;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) Person *author;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NS_ASSUME_NONNULL_END</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> myCase == 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å…¨éƒ¨è‡ªå·±æ‰‹åŠ¨å®šä¹‰</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Book</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">nonnull</span> <span class="keyword">instancetype</span>)initWithName:(<span class="built_in">NSString</span> * _Nonnull)name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> * _Nonnull name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">nonnull</span>) <span class="built_in">NSString</span> *version;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="type">long</span> words;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nonnull</span>) <span class="built_in">NSNumber</span> *barCode;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">nullable</span>) <span class="built_in">NSString</span> *publicID;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">nullable</span>) <span class="built_in">NSString</span> *url;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nonnull</span>) Person *author;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nonnull</span>) <span class="built_in">NSMutableArray</span>&lt;Person *&gt; *seeker;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h4 id="nullabilityç‰¹æ€§å¯¹OCç¼–ç çš„å½±å“"><a href="#nullabilityç‰¹æ€§å¯¹OCç¼–ç çš„å½±å“" class="headerlink" title="nullabilityç‰¹æ€§å¯¹OCç¼–ç çš„å½±å“"></a>nullabilityç‰¹æ€§å¯¹OCç¼–ç çš„å½±å“</h4><p>åœ¨OCä¸­å³ä½¿æ ‡æ˜ä¸º<code>_Nonnull</code>,ä½ ä¾ç„¶å¯ä»¥ç»™å®ƒä¸€ä¸ªnilå€¼,ä½†ç¼–è¯‘å™¨ä¼šç»™å‡ºè­¦å‘Š,ä»…ä»…æ˜¯è­¦å‘Š.å› æ­¤åœ¨OCä¸­ä¸è¦å¯¹<code>_Nonnull</code>ä¿®é¥°çš„å˜é‡æŠ±æœ‰ä¸€å®šä¸ä¸ºnilçš„å¹»æƒ³,å¦åˆ™è¯¥å´©è¿˜å¾—å´©.</p>
<p>nullabilityç‰¹æ€§åªæ˜¯ä¸€ç§çº¦å®š,åœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬è¦éµå®ˆè¿™ä¸€çº¦å®š.å¦‚æœä¸€ä¸ªå˜é‡æ˜¯nonnullçš„,æˆ‘ä»¬åœ¨initæ–¹æ³•ä¸­ä¸€å®šè¦ç»™å®ƒä¸€ä¸ªåˆå§‹å€¼,å¹¶ä¸”åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä¸è¦ç»™å®ƒèµ‹å€¼ä¸ºnil.</p>
<h4 id="nullabilityç‰¹æ€§å¯¹OC-Swiftæ··ç¼–çš„å½±å“"><a href="#nullabilityç‰¹æ€§å¯¹OC-Swiftæ··ç¼–çš„å½±å“" class="headerlink" title="nullabilityç‰¹æ€§å¯¹OC,Swiftæ··ç¼–çš„å½±å“"></a>nullabilityç‰¹æ€§å¯¹OC,Swiftæ··ç¼–çš„å½±å“</h4><p>nullabilityç‰¹æ€§å…¶å®ä¸»è¦è¿˜æ˜¯ä¸ºäº†æ–¹ä¾¿OCçš„ç±»åœ¨Swiftä¸­çš„ä½¿ç”¨.</p>
<p>ä¸€ä¸ª<code>_Nonnull</code>ä¿®é¥°çš„OCå˜é‡,å®ƒåœ¨OCä»£ç ä¸­å¯èƒ½ä¼šè¢«èµ‹å€¼ä¸ºnil,å½“å®ƒåœ¨Swiftä¸­ä½¿ç”¨æ—¶nilä¼šå˜æˆ<code>&lt;uninitialized&gt;</code>å¯¹è±¡.å¥‡æ€ªçš„æ˜¯å¦‚æœæ˜¯nilçš„NSStringåˆ™ä¼šè¢«è‡ªåŠ¨è½¬æ¢ä¸ºç©ºå­—ç¬¦<code>&quot;&quot;</code>.</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">NS_ASSUME_NONNULL_BEGIN</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@interface</span> <span class="type">Person</span> : <span class="type">NSObject</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@property</span> (nonatomic, <span class="keyword">copy</span>) <span class="type">NSString</span> <span class="operator">*</span>name;</span><br><span class="line"><span class="meta">@property</span> (nonatomic, <span class="keyword">copy</span>) <span class="type">NSString</span> <span class="operator">*</span>sex;</span><br><span class="line"></span><br><span class="line"><span class="operator">-</span> (void)hello;</span><br><span class="line"></span><br><span class="line"><span class="meta">@end</span></span><br><span class="line"></span><br><span class="line"><span class="type">NS_ASSUME_NONNULL_END</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@interface</span> <span class="type">Book</span> : <span class="type">NSObject</span></span><br><span class="line"></span><br><span class="line"><span class="operator">-</span> (nonnull instancetype)initWithName:(<span class="type">NSString</span> <span class="operator">*</span> _Nonnull)name;</span><br><span class="line"></span><br><span class="line"><span class="meta">@property</span> (nonatomic, <span class="keyword">copy</span>) <span class="type">NSString</span> <span class="operator">*</span> _Nonnull name;</span><br><span class="line"><span class="meta">@property</span> (nonatomic, <span class="keyword">copy</span>, nonnull) <span class="type">NSString</span> <span class="operator">*</span>version;</span><br><span class="line"><span class="meta">@property</span> (nonatomic, assign) long words;</span><br><span class="line"><span class="meta">@property</span> (nonatomic, strong, nonnull) <span class="type">NSNumber</span> <span class="operator">*</span>barCode;</span><br><span class="line"><span class="meta">@property</span> (nonatomic, <span class="keyword">copy</span>, nullable) <span class="type">NSString</span> <span class="operator">*</span>publicID;</span><br><span class="line"><span class="meta">@property</span> (nonatomic, <span class="keyword">copy</span>, nullable) <span class="type">NSString</span> <span class="operator">*</span>url;</span><br><span class="line"><span class="meta">@property</span> (nonatomic, strong, nonnull) <span class="type">Person</span> <span class="operator">*</span>author;</span><br><span class="line"><span class="meta">@property</span> (nonatomic, strong, nonnull) <span class="type">NSMutableArray</span>&lt;<span class="type">Person</span> *&gt; <span class="operator">*</span>seeker;</span><br><span class="line"></span><br><span class="line"><span class="meta">@end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@objc</span> <span class="keyword">func</span> <span class="title function_">printBook</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> name <span class="operator">=</span> book.name</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> version <span class="operator">=</span> book.version</span><br><span class="line">    <span class="built_in">print</span>(version)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> seeker: <span class="type">NSMutableArray</span> <span class="operator">=</span> book.seeker</span><br><span class="line">    seeker.add(<span class="string">&quot;sd&quot;</span>) <span class="comment">//æ²¡æ•ˆæœ</span></span><br><span class="line">    <span class="built_in">print</span>(seeker) <span class="comment">//å´©æºƒ:Thread 1: EXC_BAD_ACCESS (code=1, address=0x0)</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> num: <span class="type">NSNumber</span> <span class="operator">=</span> book.barCode</span><br><span class="line"><span class="comment">//        print(num) //å´©æºƒ</span></span><br><span class="line">    <span class="keyword">let</span> i <span class="operator">=</span> num.intValue <span class="comment">//0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> author <span class="operator">=</span> book.author</span><br><span class="line">    <span class="keyword">let</span> authorName <span class="operator">=</span> author.name</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> publicID <span class="operator">=</span> book.publicID <span class="operator">??</span> <span class="string">&quot;unknown&quot;</span></span><br><span class="line">    <span class="keyword">let</span> url <span class="operator">=</span> book.url <span class="operator">??</span> <span class="string">&quot;unknown&quot;</span></span><br><span class="line">    <span class="keyword">let</span> string <span class="operator">=</span> name <span class="operator">+</span> <span class="string">&quot;-&quot;</span> <span class="operator">+</span> version <span class="operator">+</span> <span class="string">&quot;-&quot;</span> <span class="operator">+</span> authorName <span class="operator">+</span> <span class="string">&quot;-&quot;</span> <span class="operator">+</span> publicID <span class="operator">+</span> <span class="string">&quot;-&quot;</span> <span class="operator">+</span> url</span><br><span class="line">    </span><br><span class="line">    author.hello() <span class="comment">//ä¸ä¼šæ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">let</span> des <span class="operator">=</span> <span class="type">String</span>.<span class="keyword">init</span>(describing: author) <span class="comment">//ç©ºå­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;des:<span class="subst">\(des)</span>&quot;</span>)</span><br><span class="line"><span class="comment">//        print(author) //å´©æºƒ</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//        let s: AnyClass = type(of: author) //å´©æºƒ</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> arr: [<span class="type">Person</span>] <span class="operator">=</span> []</span><br><span class="line">    arr.append(author)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\(author)</span>&quot;</span>, <span class="string">&quot;arrä¸ªæ•°:<span class="subst">\(arr.count)</span>&quot;</span>, arr)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\(string)</span>&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰“å°</p>
<figure class="highlight maxima"><table><tr><td class="code"><pre><span class="line"> arrä¸ªæ•°:<span class="number">1</span> []</span><br><span class="line">ä¸‰å›½---<span class="literal">unknown</span>-<span class="literal">unknown</span></span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­çš„authorNameå°†ä¼šæ˜¯ç©ºå­—ç¬¦ä¸²<code>&quot;&quot;</code>;è€Œauthorå°†ä¼šæ˜¯<code>&lt;uninitialized&gt;</code>,å…¶å®å°±æ˜¯ä¸€ä¸ªnilå¯¹è±¡,ç»™å®ƒå‘é€æ¶ˆæ¯æ²¡æœ‰ä»€ä¹ˆé—®é¢˜,ä½†è°ƒç”¨Swiftä¸­çš„æŸäº›æ–¹æ³•æ¯”å¦‚<code>print(author)</code>æˆ–<code>type(of: author)</code>å°†å¯¼è‡´é‡æŒ‡é’ˆå´©æºƒ:<code>Thread 1: EXC_BAD_ACCESS (code=1, address=0x0)</code>.</p>
<blockquote>
<p>OCå’ŒSwiftè¯­è¨€å…¶ä»–çš„ä¸€äº›è®¾è®¡å·®åˆ«</p>
</blockquote>
<p>Swiftä¸­,å¦‚æœä¸€ä¸ªå˜é‡æ²¡æœ‰è¢«åˆå§‹åŒ–,å®ƒæ˜¯ä¸èƒ½è¢«ä½¿ç”¨çš„,ç¼–è¯‘å™¨ä¼šæŠ¥é”™.</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="selector-tag">var</span> peron: Person</span><br><span class="line">	peron.<span class="built_in">hello</span>() //Variable <span class="string">&#x27;peron&#x27;</span> used before being initialized</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†OCä¸­,å£°æ˜ä¸€ä¸ªå˜é‡åæ²¡æœ‰ç»™å®ƒä¸€ä¸ªå€¼ä¹Ÿèƒ½å¤Ÿç»™å®ƒå‘é€æ¶ˆæ¯.</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	Person *p;</span><br><span class="line">    [<span class="meta">p hello</span>];</span><br><span class="line">    Class cls = p.<span class="keyword">class</span>;</span><br><span class="line">    NSLog(<span class="string">@&quot;cls:%@&quot;</span>, cls);	 <span class="comment">// cls:(null)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºSwiftå¯¹åˆå§‹åŒ–æ˜¯éå¸¸ä¸¥æ ¼çš„.è€ŒOCåŸºæœ¬æ²¡å•¥é™åˆ¶.</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>nullabilityç‰¹æ€§åªæ˜¯ä¸€ç§çº¦å®š,åœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬è¦éµå®ˆè¿™ä¸€çº¦å®š.å¦‚æœä¸€ä¸ªå˜é‡æ˜¯nonnullçš„,æˆ‘ä»¬åœ¨åˆå§‹åŒ–æ–¹æ³•ä¸­ä¸€å®šè¦ç»™å®ƒä¸€ä¸ªåˆå§‹å€¼,å¹¶ä¸”åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä¸è¦ç»™å®ƒèµ‹å€¼ä¸ºnil.</p>
<p>OC,Swiftæ··ç¼–æ—¶,ä¸ºäº†ä½¿ç”¨æ–¹ä¾¿å¹¶å‡å°‘å¯èƒ½çš„è§£åŒ…å´©æºƒ,æ¨èä½¿ç”¨nullabilityç‰¹æ€§,æ—§çš„OCä»£ç ä¹Ÿæœ‰å¿…è¦æ·»åŠ .</p>
<p>åœ¨Swiftä¸­å°½é‡ä¸ä½¿ç”¨å¼ºåˆ¶è§£åŒ….</p>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
      <tags>
        <tag>nullability</tag>
      </tags>
  </entry>
  <entry>
    <title>Swift è®¿é—®æ§åˆ¶</title>
    <url>/2019/09/15/Swift%20%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6/</url>
    <content><![CDATA[<h3 id="Swift-è®¿é—®æ§åˆ¶"><a href="#Swift-è®¿é—®æ§åˆ¶" class="headerlink" title="Swift è®¿é—®æ§åˆ¶"></a>Swift è®¿é—®æ§åˆ¶</h3><p>ç»§æ‰¿æ˜¯é’ˆå¯¹ç±»çš„ï¼Œé‡å†™æ˜¯é’ˆå¯¹ç±»çš„æ–¹æ³•çš„ã€‚</p>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th>In Module</th>
<th>Out Module</th>
</tr>
</thead>
<tbody>
<tr>
<td>open</td>
<td>å¯è®¿é—®,å¯ç»§æ‰¿,å¯é‡å†™</td>
<td>å¯è®¿é—®,å¯ç»§æ‰¿,å¯é‡å†™</td>
</tr>
<tr>
<td>public</td>
<td>å¯è®¿é—®,å¯ç»§æ‰¿,å¯é‡å†™</td>
<td>å¯è®¿é—®</td>
</tr>
<tr>
<td>internal</td>
<td>å¯è®¿é—®,å¯ç»§æ‰¿,å¯é‡å†™</td>
<td>X</td>
</tr>
<tr>
<td>fileprivate</td>
<td>åœ¨åŒä¸€æºæ–‡ä»¶é‡Œå¯è®¿é—®,å¯ç»§æ‰¿,å¯é‡å†™</td>
<td>X</td>
</tr>
<tr>
<td>private</td>
<td>å¦‚æœä¿®é¥°çš„æ˜¯ç±»ä¸­çš„æˆå‘˜ï¼Œåˆ™æˆå‘˜åªèƒ½åœ¨<strong>è‡ªèº«å®šä¹‰é‡Œ</strong>æˆ–<strong>åŒä¸€æºæ–‡ä»¶ä¸­çš„è‡ªèº«æ‰©å±•é‡Œ</strong>å¯è®¿é—®ï¼ˆä¹Ÿå°±æ˜¯ä¸èƒ½è¢«é‡å†™äº†ï¼‰ï¼Œå¦‚æœä¿®é¥°çš„æ˜¯ç±»åˆ™åœ¨åŒä¸€æºæ–‡ä»¶é‡Œå¯è®¿é—®,å¯ç»§æ‰¿</td>
<td>X</td>
</tr>
</tbody>
</table>
</div>
<p>openåªèƒ½ç”¨äºä¿®é¥°ç±»å’Œç±»çš„æˆå‘˜(å±æ€§,æ–¹æ³•å’Œä¸‹æ ‡)ï¼Œä¸èƒ½ä¿®é¥°åè®®ã€å…¨å±€å˜é‡/å¸¸é‡ã€ç»“æ„ä½“ã€æšä¸¾ç­‰ç­‰ï¼ˆè¿™äº›å¯ä»¥ä½¿ç”¨publicä¿®é¥°ï¼‰ã€‚ç³»ç»Ÿç¦æ­¢çš„åŸå› å¯èƒ½æ˜¯å› ä¸ºè¿™äº›ç±»å‹éƒ½æ˜¯å€¼ç±»å‹æœ¬èº«å°±æ— æ³•ç»§æ‰¿å’Œé‡å†™ï¼Œåˆšå¥½å°±æ˜¯publicçš„ä½œç”¨ã€‚</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Only classes and overridable class members can be declared &#x27;open&#x27;; use &#x27;public&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">open</span> <span class="keyword">protocol</span> <span class="title class_">MyProtocol</span>: <span class="title class_ inherited__">AnyObject</span> &#123; <span class="comment">//æŠ¥é”™</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">open</span> <span class="keyword">let</span> kAPIKey <span class="operator">=</span> <span class="string">&quot;xxx&quot;</span> <span class="comment">//æŠ¥é”™</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">open</span> <span class="keyword">struct</span> <span class="title class_">MyStruct</span> &#123; <span class="comment">//æŠ¥é”™</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹äºåˆå§‹åŒ–å™¨å¦‚æœéœ€è¦å¯¹å¤–å…¬å¼€,åˆ™åªèƒ½ä½¿ç”¨public.å¦‚æœå­ç±»çš„åˆå§‹åŒ–å™¨å’Œçˆ¶ç±»çš„åˆå§‹åŒ–å™¨ç­¾åç›¸åŒåˆ™å­ç±»è¿˜éœ€è¦åŠ ä¸Šoverrideå…³é”®å­—.æ˜¯ä¸æ˜¯æ„Ÿè§‰æœ‰ç‚¹ç–‘æƒ‘,ä¸æ˜¯è¯´publicçš„åœ¨å…¶ä»–Moduleåªèƒ½è®¿é—®å—,ä¸ºå•¥publicä¿®é¥°çš„åˆå§‹åŒ–å™¨åœ¨å…¶ä»–Moduleè¿˜å¯ä»¥override?æ— ä»–â€”é¾Ÿè…š.</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">Machine</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> numberID: <span class="type">String</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">init</span>(<span class="keyword">_</span> <span class="params">numberID</span>: <span class="type">String</span>) &#123; <span class="comment">//è¿™é‡ŒæŠ¥é”™:Only classes and overridable class members can be declared &#x27;open&#x27;; use &#x27;public&#x27;</span></span><br><span class="line">        <span class="keyword">self</span>.numberID <span class="operator">=</span> numberID</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å”¯ä¸€æ‰¾åˆ°çš„è§£é‡Šå¦‚ä¸‹:</p>
<p><a href="https://github.com/apple/swift-evolution/blob/master/proposals/0117-non-public-subclassable-by-default.md">Allow distinguishing between public access and public overridability</a></p>
<p>Initializers do not participate in open checking; they cannot be declared open, and there are no restrictions on providing an initializer that has the same signature as an initializer in the superclass. This is true even of required initializers. A classâ€™s initializers provide an interface for constructing instances of that class that is logically distinct from the interface of its superclass, even when signatures happen to match and there are well-understood patterns of delegation. Constructing an object of a subclass necessarily involves running code associated with that subclass, and there is no value in arbitrarily restricting what initializers the subclass may declare.</p>
<p>å¤§æ„å°±æ˜¯åˆå§‹åŒ–å™¨ä¸å‚ä¸openæ£€æŸ¥,å¹¶ä¸”å®ƒä»¬ä¹Ÿä¸èƒ½è¢«å£°æ˜ä¸ºopen.æ²¡æœ‰å•¥é™åˆ¶è¯´å­ç±»çš„åˆå§‹åŒ–å™¨ä¸èƒ½å’Œçˆ¶ç±»çš„åˆå§‹åŒ–å™¨ç›¸åŒ(å®é™…ä¸Šå¦‚æœç›¸åŒåˆå¿…é¡»æ·»åŠ overrideç®€ç›´å“”äº†ç‹—).</p>
<blockquote>
<p>fileprivate å’Œ private åŒºåˆ«</p>
</blockquote>
<p>fileprivateåªè¦åœ¨åŒä¸€æºæ–‡ä»¶é‚£ä¹ˆå°±å¯ä»¥è®¿é—®ã€‚è€Œprivateåˆ™èŒƒå›´æ›´çª„åªèƒ½åœ¨è‡ªèº«å®šä¹‰é‡Œæˆ–åŒä¸€æºæ–‡ä»¶ä¸­çš„è‡ªèº«æ‰©å±•é‡Œã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MATBaseViewController</span>: <span class="title class_ inherited__">UIViewController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">fileprivate</span> <span class="keyword">var</span> name <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> age <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        <span class="type">DLog</span>(<span class="string">&quot;<span class="subst">\(<span class="keyword">self</span>)</span>é”€æ¯&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">viewDidLoad</span>() &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line"></span><br><span class="line">        view.backgroundColor <span class="operator">=</span> .white</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">MATBaseViewController</span> &#123;</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">printInfo</span>() &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="keyword">self</span>.name)</span><br><span class="line">        <span class="built_in">print</span>(<span class="keyword">self</span>.age)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>: <span class="title class_ inherited__">NSObject</span> &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">init</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> vc <span class="operator">=</span> <span class="type">MATBaseViewController</span>.<span class="keyword">init</span>()</span><br><span class="line">        vc.name <span class="operator">=</span> <span class="string">&quot;xxx&quot;</span> <span class="comment">//nameå¯ä»¥è¢«è®¿é—®åˆ°ï¼Œä½†æ˜¯ageä¸èƒ½ã€‚ageåªèƒ½åœ¨MATBaseViewControllerè‡ªèº«å®šä¹‰é‡Œæˆ–åŒä¸€æ–‡ä»¶çš„MATBaseViewControllerè‡ªèº«æ‰©å±•é‡Œï¼Œ</span></span><br><span class="line"><span class="comment">//        vc.age = 3  //&#x27;age&#x27; is inaccessible due to &#x27;private&#x27; protection level</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è®¿é—®çº§åˆ«è§„åˆ™"><a href="#è®¿é—®çº§åˆ«è§„åˆ™" class="headerlink" title="è®¿é—®çº§åˆ«è§„åˆ™"></a>è®¿é—®çº§åˆ«è§„åˆ™</h3><blockquote>
<p>è®¿é—®çº§åˆ«éµå¾ªçš„ä¸€èˆ¬è§„åˆ™</p>
</blockquote>
<p>ä¸èƒ½åœ¨ä¸€ä¸ªè¾ƒä½è®¿é—®çº§åˆ«å®ä½“ä¸­å®šä¹‰ä¸€ä¸ªè¾ƒé«˜è®¿é—®çº§åˆ«çš„å®ä½“.</p>
<p>æ¯”å¦‚ä¸€ä¸ªpublicçš„å˜é‡å°±ä¸èƒ½å®šä¹‰åœ¨ä¸€ä¸ªinternalæˆ–privateçš„ç±»å‹ä¸­.ä¸€ä¸ªå‡½æ•°çš„è®¿é—®çº§åˆ«ä¸èƒ½è¶…è¿‡å®ƒçš„å‚æ•°å’Œè¿”å›å€¼çš„ç±»å‹çš„è®¿é—®çº§åˆ«.</p>
<blockquote>
<p>é»˜è®¤çš„è®¿é—®çº§åˆ«</p>
</blockquote>
<p>é»˜è®¤çš„è®¿é—®çº§åˆ«æ˜¯internalã€‚ä¹Ÿå°±æ˜¯è¯´å³ä½¿ä½ å®šä¹‰çš„æ˜¯ä¸€ä¸ªpublicçš„ç±»å‹,å®ƒçš„æˆå‘˜é»˜è®¤çš„è®¿é—®çº§åˆ«ä¹Ÿåªæ˜¯internalè€Œä¸æ˜¯public.</p>
<p>privateæˆ–fileprivateçš„ç±»å‹é‡Œé¢çš„æˆå‘˜çš„é»˜è®¤è®¿é—®çº§åˆ«åˆ™åªæœ‰fileprivateã€‚</p>
<p>æ¯”å¦‚ï¼š</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">Food</span>: <span class="title class_ inherited__">NSObject</span> &#123; <span class="comment">//åŒä¸€æºæ–‡ä»¶é‡Œå¯è®¿é—®,å¯ç»§æ‰¿</span></span><br><span class="line">    <span class="keyword">var</span> name <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">hello</span>() &#123; </span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">func</span> <span class="title function_">run</span>() &#123; <span class="comment">//è¿˜æ˜¯éœ€è¦åŠ private å¦åˆ™å­ç±»é‡Œè¿˜æ˜¯èƒ½é‡å†™ã€‚</span></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">Orange</span>: <span class="title class_ inherited__">Food</span> &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">hello</span>() &#123; </span><br><span class="line">      	<span class="keyword">super</span>.hello()</span><br><span class="line">        <span class="built_in">print</span>(name)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Method does not override any method from its superclass</span></span><br><span class="line"><span class="comment">//    override func run() &#123;</span></span><br><span class="line"><span class="comment">//        print(name)</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿˜æœ‰æ›´å¤š23ä¸ªè§„åˆ™,å¯ä»¥åœ¨å®˜æ–¹çš„Swiftç¼–ç¨‹æŒ‡å—ä¸­æ‰¾åˆ°.æ„Ÿè§‰Swiftè™½ç„¶å·ç§°ç®€æ´ä¼˜é›…,ä½†æ˜¯èƒŒåçš„è§„åˆ™ç»†èŠ‚ä¸æ˜¯ä¸€èˆ¬çš„å¤š.</p>
<h3 id="frameworkè®¿é—®æ§åˆ¶"><a href="#frameworkè®¿é—®æ§åˆ¶" class="headerlink" title="frameworkè®¿é—®æ§åˆ¶"></a>frameworkè®¿é—®æ§åˆ¶</h3><p>åœ¨åˆ¶ä½œå¯¹å¤–ä½¿ç”¨çš„SDKæ—¶,å¦‚æœæŸäº›ç±»æˆ–æ–¹æ³•éœ€è¦æš´éœ²ç»™å¤–éƒ¨ä½¿ç”¨,å¯ä»¥åœ¨å¯¹åº”ç±»æˆ–æ–¹æ³•å‰æ·»åŠ openæˆ–publicä¿®é¥°ç¬¦.</p>
<p>ä¸è¿‡Swiftçš„SDKå’ŒOCçš„SDKä¸åŒçš„åœ°æ–¹åœ¨äºSwift SDKæ²¡æœ‰å¯¹å¤–å…¬å¼€çš„å¤´æ–‡ä»¶æ¦‚å¿µ,è¿™ä¸ªå¾ˆå¥½ç†è§£,å› ä¸ºSwiftæœ¬èº«å°±æ²¡æœ‰å¤´æ–‡ä»¶.Swiftä¼šæ ¹æ®ä½ æ‰€ä½¿ç”¨çš„è®¿é—®æ§åˆ¶ä¿®é¥°ç¬¦è‡ªåŠ¨ç”Ÿæˆå¯¹å¤–æ¥å£.</p>
<p>å½“å…¶ä»–Module importæˆ‘ä»¬çš„SDKå.å¯ä»¥ç‚¹å‡»è¿›å»æŸ¥çœ‹æˆ‘ä»¬æä¾›çš„API.</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> MyFrameworkDemo  <span class="comment">//è¿™ä¸ªæ˜¯SDK</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">People</span>: <span class="title class_ inherited__">NSObject</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span>?</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">init</span>() &#123;</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">_</span> <span class="operator">=</span> <span class="type">Car</span>(with: <span class="string">&quot;sd&quot;</span>)</span><br><span class="line">        <span class="keyword">let</span> m <span class="operator">=</span> <span class="type">Machine</span>.<span class="keyword">init</span>(<span class="string">&quot;x&quot;</span>)</span><br><span class="line">        m.numberID <span class="operator">=</span> <span class="string">&quot;df&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç‚¹å‡»è¿›å»æŸ¥çœ‹ç³»ç»Ÿç”Ÿæˆçš„å¯¹å¤–æ¥å£æ–‡ä»¶å†…å®¹:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">var</span> <span class="type">MyFrameworkDemoVersionNumber</span>: <span class="type">Double</span></span><br><span class="line"><span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">Car</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">var</span> open_name: <span class="type">String</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> public_wheel: <span class="type">Int</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(<span class="params">with</span> <span class="params">name</span>: <span class="type">String</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">public_run</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">func</span> <span class="title function_">open_hello</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">Machine</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">var</span> numberID: <span class="type">String</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(<span class="keyword">_</span> <span class="params">numberID</span>: <span class="type">String</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„:æ ¹æ®ä¸Šè¿°è¡¨æ€»ç»“,å¯ä»¥çœ‹å‡ºç³»ç»Ÿåªä¼šå°†openæˆ–publicä¿®é¥°çš„ç±»æˆ–æ–¹æ³•ç”Ÿæˆåˆ°å¯¹å¤–æ¥å£æ–‡ä»¶ä¸­.è€ŒinternalåŠä»¥ä¸‹ä¿®é¥°çš„ç±»å°†ä¸ä¼šå‡ºç°åœ¨å¯¹å¤–æ¥å£æ–‡ä»¶ä¸­.</p>
]]></content>
      <categories>
        <category>Swift</category>
      </categories>
      <tags>
        <tag>è®¿é—®æ§åˆ¶</tag>
      </tags>
  </entry>
  <entry>
    <title>Swiftä¸­çš„AnyClassã€AnyObjectã€Any</title>
    <url>/2019/09/13/Swift%E4%B8%AD%E7%9A%84AnyClass%E3%80%81AnyObject%E3%80%81Any/</url>
    <content><![CDATA[<p>1.AnyObject</p>
<p>å®šä¹‰:<br>public typealias AnyObject</p>
<p>è¯´æ˜:<br>The protocol to which all classes implicitly conform.</p>
<p>AnyObject can be used as the concrete type for an instance of any class, class type, or class-only protocol.</p>
<p>The flexible behavior of the <code>AnyObject</code> protocol is similar to<br>Objective-Câ€™s <code>id</code> type.</p>
<p>AnyObject:ç”¨äºè¡¨ç¤ºä»»æ„ç±»,å…ƒç±»çš„å®ä¾‹çš„å…·ä½“ç±»å‹.</p>
<p>å¯¹äºâ€123â€æˆ–123è¿™äº›åŸºç¡€æ•°æ®ç±»å‹åœ¨Swiftä¸­æ˜¯ç»“æ„ä½“ç±»å‹,æ‰€ä»¥è¿™é‡Œéœ€è¦å°†å…¶å¼ºè½¬ä¸ºAnyObjectç±»å‹,æ­¤æ—¶å®ƒä»¬çš„ç±»å‹å°†æ˜¯<br>OCçš„NSTaggedPointerStringå’Œ__NSCFNumberç­‰å¯¹è±¡ç±»å‹.ä¸å¼ºè½¬çš„è¯ç¼–è¯‘ä¼šå‡ºé”™.</p>
<p>eg:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FDEItemModel</span> &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> anyA: <span class="type">AnyObject</span> <span class="operator">=</span> <span class="type">FDEItemModel</span>.<span class="keyword">init</span>() <span class="comment">//å¯¹è±¡ï¼Œç±»çš„å®ä¾‹</span></span><br><span class="line"><span class="keyword">let</span> anyB: <span class="type">AnyObject</span> <span class="operator">=</span> <span class="type">FDEItemModel</span>.<span class="keyword">self</span> <span class="comment">//ç±»å¯¹è±¡ï¼Œå…ƒç±»çš„å®ä¾‹</span></span><br><span class="line"><span class="keyword">let</span> anyC: <span class="type">AnyObject</span> <span class="operator">=</span> <span class="type">FDEItemModel</span>.<span class="keyword">init</span>().<span class="keyword">self</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> defaulA <span class="operator">=</span> <span class="type">FDEItemModel</span>.<span class="keyword">init</span>()  <span class="comment">//FDEItemModel</span></span><br><span class="line"><span class="keyword">let</span> defaulB <span class="operator">=</span> <span class="type">FDEItemModel</span>.<span class="keyword">self</span> <span class="comment">//FDEItemModel.Type</span></span><br><span class="line"><span class="keyword">let</span> defaulC <span class="operator">=</span> <span class="type">FDEItemModel</span>.<span class="keyword">init</span>().<span class="keyword">self</span> <span class="comment">//FDEItemModel</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> arr1: [<span class="type">AnyObject</span>] <span class="operator">=</span> [<span class="string">&quot;123&quot;</span> <span class="keyword">as</span> <span class="type">AnyObject</span>, <span class="number">123</span> <span class="keyword">as</span> <span class="type">AnyObject</span>, [<span class="number">123</span>] <span class="keyword">as</span> <span class="type">AnyObject</span>]</span><br><span class="line"> </span><br><span class="line"><span class="keyword">let</span> arr2: [<span class="type">AnyObject</span>] <span class="operator">=</span> [<span class="type">NSString</span>(<span class="string">&quot;123&quot;</span>),</span><br><span class="line">                             <span class="type">NSNumber</span>(<span class="number">123</span>),</span><br><span class="line">                             <span class="literal">true</span> <span class="keyword">as</span> <span class="type">AnyObject</span>,</span><br><span class="line">                             <span class="type">People</span>.<span class="keyword">init</span>(),</span><br><span class="line">                             <span class="type">People</span>.<span class="keyword">self</span></span><br><span class="line">                             ]</span><br><span class="line"><span class="built_in">print</span>(arr2)</span><br><span class="line"></span><br><span class="line"><span class="operator">...</span></span><br><span class="line">[<span class="number">123</span>, <span class="number">123</span>, <span class="number">1</span>, <span class="operator">&lt;</span><span class="type">OSHybridDemo</span>.<span class="type">People</span>: <span class="number">0x600002348b90</span><span class="operator">&gt;</span>, <span class="type">OSHybridDemo</span>.<span class="type">People</span>]</span><br></pre></td></tr></table></figure>
<p>åœ¨ä½¿ç”¨AnyObject å¯¹è±¡æ—¶è¦ç‰¹åˆ«æ³¨æ„å¦‚æœä½ éœ€è¦è°ƒç”¨å®ƒçš„å±æ€§åˆ™æœ€å¥½å…ˆdowncastä¸ºå®é™…çš„ç±»å‹ï¼Œå¦‚æœä¸downcasté‚£ä¹ˆç³»ç»Ÿå¯èƒ½è·å–çš„æ˜¯å…¶ä»–ç±»çš„åŒåå±æ€§ï¼Œå¾—åˆ°çš„å€¼å°†æ˜¯nilã€‚</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> node1 <span class="operator">=</span> <span class="type">BinaryTreeNode</span>.<span class="keyword">init</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">let</span> node2 <span class="operator">=</span> <span class="type">BinaryTreeNode</span>.<span class="keyword">init</span>(<span class="number">2</span>)</span><br><span class="line">node1.left <span class="operator">=</span> node2</span><br><span class="line"><span class="keyword">let</span> curr: <span class="type">AnyObject</span> <span class="operator">=</span> node1</span><br><span class="line"><span class="keyword">let</span> left: <span class="type">AnyObject</span>? <span class="operator">=</span> curr.left  <span class="comment">//ä¸ä¼šæŠ¥é”™</span></span><br><span class="line"><span class="keyword">let</span> left1: <span class="type">AnyObject</span>? <span class="operator">=</span> (curr <span class="keyword">as!</span> <span class="type">BinaryTreeNode</span>).left</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;left:<span class="subst">\(left)</span>, left1:<span class="subst">\(left1<span class="operator">!</span>)</span>&quot;</span>) <span class="comment">//left:nil, left1:AlgorithmUtils.BinaryTreeNode</span></span><br></pre></td></tr></table></figure>
<p>2.AnyClass</p>
<p>å®šä¹‰:<br>typealias AnyClass = AnyObject.Type</p>
<p>è¯´æ˜:<br>The protocol to which all class types implicitly conform.</p>
<p>You can use the AnyClass protocol as the concrete type for an instance of any class.</p>
<p>AnyClass:ç”¨äºè¡¨ç¤ºä»»æ„å…ƒç±»çš„å®ä¾‹çš„å…·ä½“ç±»å‹.</p>
 <figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> anyB: <span class="type">AnyObject</span> <span class="operator">=</span> <span class="type">People</span>.<span class="keyword">self</span></span><br><span class="line"><span class="keyword">let</span> anyC: <span class="type">AnyClass</span> <span class="operator">=</span> <span class="type">People</span>.<span class="keyword">self</span></span><br><span class="line"><span class="keyword">let</span> anyD: <span class="type">AnyClass</span> <span class="operator">=</span> <span class="type">FDEItemModel</span>.<span class="keyword">init</span>() <span class="comment">//æŠ¥é”™ï¼šCannot convert value of type &#x27;FDEItemModel&#x27; to specified type &#x27;AnyClass&#x27; (aka &#x27;any AnyObject.Type&#x27;)</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">let</span> obj1 <span class="operator">=</span> (anyB <span class="keyword">as!</span> <span class="type">People</span>.<span class="keyword">Type</span>).<span class="keyword">init</span>()</span><br><span class="line"><span class="keyword">let</span> obj2 <span class="operator">=</span> (anyC <span class="keyword">as!</span> <span class="type">People</span>.<span class="keyword">Type</span>).<span class="keyword">init</span>()</span><br></pre></td></tr></table></figure>
<p>3.Any</p>
<p>Any:ç”¨äºè¡¨ç¤ºä»»æ„ç±»å‹.</p>
<p>ä¹‹æ‰€ä»¥å‡ºç°Anyä¸»è¦æ˜¯ç”±äºAnyObjectåªèƒ½è¡¨ç¤ºç±»çš„å®ä¾‹.è€Œ Swift ä¸­æ‰€æœ‰çš„åŸºæœ¬ç±»å‹ï¼ŒåŒ…æ‹¬ Array å’Œ Dictionary è¿™äº›ä¼ ç»Ÿæ„ä¹‰ä¸Šä¼šæ˜¯ class çš„ä¸œè¥¿ï¼Œç»Ÿç»Ÿéƒ½æ˜¯ struct ç±»å‹ï¼Œå¹¶ä¸èƒ½ç”± AnyObject æ¥è¡¨ç¤ºï¼Œäºæ˜¯ Apple æå‡ºäº†ä¸€ä¸ªæ›´ä¸ºç‰¹æ®Šçš„ Anyï¼Œé™¤äº† class ä»¥å¤–ï¼Œå®ƒè¿˜å¯ä»¥è¡¨ç¤ºåŒ…æ‹¬ struct å’Œ enum åœ¨å†…çš„æ‰€æœ‰ç±»å‹ã€‚</p>
<p><code>let a: AnyObject = Int.init(2.0)</code> ä¼šç¼–è¯‘é”™è¯¯ï¼Œéœ€è¦å¼ºè½¬ä¸ºAnyObjectï¼Œæ­¤æ—¶açš„å®é™…ç±»å‹å°†ä¸å†æ˜¯Intè€Œæ˜¯<code>__NSCFNumber</code> ï¼Œè¿™è¡¨æ˜ç³»ç»Ÿä¼šå°†è¿™äº›structè½¬ä¸ºå¯¹åº”çš„OCç±»ã€‚</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> a: <span class="type">AnyObject</span> <span class="operator">=</span> <span class="type">Int</span>.<span class="keyword">init</span>(<span class="number">2.0</span>) <span class="keyword">as</span> <span class="type">AnyObject</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a type:<span class="subst">\(<span class="built_in">type</span>(of: a))</span>&quot;</span>) <span class="comment">//a type:__NSCFNumber</span></span><br><span class="line"><span class="keyword">let</span> b <span class="operator">=</span> <span class="number">3</span></span><br><span class="line"><span class="keyword">let</span> c <span class="operator">=</span> a <span class="keyword">as!</span> <span class="type">Int</span> <span class="operator">+</span> b</span><br></pre></td></tr></table></figure>
<p>ä¸‰è€…ä¹‹é—´çš„å…³ç³»:</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20230302190146.png" style="zoom:50%;" /></p>
]]></content>
      <categories>
        <category>Swift</category>
      </categories>
      <tags>
        <tag>AnyClassã€AnyObjectã€Any</tag>
      </tags>
  </entry>
  <entry>
    <title>Swiftã€OCåå°„</title>
    <url>/2019/09/12/Swift%E3%80%81OC%E5%8F%8D%E5%B0%84/</url>
    <content><![CDATA[<h3 id="Swiftã€OCåå°„"><a href="#Swiftã€OCåå°„" class="headerlink" title="Swiftã€OCåå°„"></a>Swiftã€OCåå°„</h3><p>åå°„å³æ ¹æ®ç±»åå­—ç¬¦ä¸²,ç”Ÿæˆå¯¹åº”å®ä¾‹å¯¹è±¡çš„è¿‡ç¨‹.</p>
<p>åˆ†ä¸ºä¸¤æ­¥:</p>
<ol>
<li>æ ¹æ®å­—ç¬¦ä¸²,å¾—åˆ°å¯¹åº”çš„ç±»å¯¹è±¡.</li>
<li>é€šè¿‡ç±»å¯¹è±¡è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•ç”Ÿæˆä¸€ä¸ªå®ä¾‹.</li>
</ol>
<h3 id="è·å–ç±»å¯¹è±¡"><a href="#è·å–ç±»å¯¹è±¡" class="headerlink" title="è·å–ç±»å¯¹è±¡"></a>è·å–ç±»å¯¹è±¡</h3><p>OC:</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">+ (Class)<span class="class"><span class="keyword">class</span> <span class="title">OBJC_SWIFT_UNAVAILABLE</span>(&quot;<span class="title">use</span> &#x27;<span class="title">aClass</span>.<span class="title">self</span>&#x27; <span class="title">instead</span>&quot;)</span>;</span><br><span class="line">- (Class)<span class="class"><span class="keyword">class</span> <span class="title">OBJC_SWIFT_UNAVAILABLE</span>(&quot;<span class="title">use</span> &#x27;<span class="title">type</span>(<span class="title">of</span>: <span class="title">anObject</span>)&#x27; <span class="title">instead</span>&quot;)</span>;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¿©æ–¹æ³•éƒ½æ˜¯è¿”å›ä¸€ä¸ªç±»å¯¹è±¡.    </p>
<p>Swift:</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">aClass<span class="selector-class">.self</span></span><br><span class="line"><span class="function"><span class="title">type</span><span class="params">(of: anObject)</span></span></span><br></pre></td></tr></table></figure>
<p>ä¸¾ä¸ªä¾‹å­,æ‰“å°ç±»å¯¹è±¡:</p>
<p>OCç±»åœ¨OCç±»é‡Œæ‰“å°:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="title class_">XQMessageTableViewCell</span> *ocCell = [[<span class="title class_">XQMessageTableViewCell</span> alloc] <span class="symbol">initWithStyle:</span><span class="title class_">UITableViewCellStyleValue1</span> <span class="symbol">reuseIdentifier:</span>@<span class="string">&quot;yyy&quot;</span>];</span><br><span class="line"><span class="title class_">NSLog</span>(@<span class="string">&quot;+classæ–¹æ³•:%@ -classæ–¹æ³•:%@ classString:%@ obj:%@&quot;</span>, <span class="title class_">XQMessageTableViewCell</span>.<span class="keyword">class</span>, ocCell.<span class="keyword">class</span>, <span class="title class_">NSStringFromClass</span>(<span class="title class_">XQMessageTableViewCell</span>.<span class="keyword">class</span>), ocCell);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="number">2019</span>-09-<span class="number">12</span> <span class="number">16</span><span class="symbol">:</span><span class="number">23</span><span class="symbol">:</span><span class="number">18.539301</span>+0800 <span class="title class_">OSHybridDemo</span>[<span class="number">33893</span><span class="symbol">:</span><span class="number">5942155</span>] +<span class="keyword">class</span>æ–¹æ³•<span class="symbol">:XQMessageTableViewCell</span> -<span class="keyword">class</span>æ–¹æ³•<span class="symbol">:XQMessageTableViewCell</span> <span class="symbol">classString:</span><span class="title class_">XQMessageTableViewCell</span> <span class="symbol">obj:</span>&lt;<span class="title class_">XQMessageTableViewCell</span>: <span class="number">0x7fa743821a00</span>; baseClass = <span class="title class_">UITableViewCell</span>; frame = (<span class="number">0</span> <span class="number">0</span>; <span class="number">320</span> <span class="number">44</span>); layer = &lt;<span class="title class_">CALayer</span>: <span class="number">0x600002940d40</span>&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>Swiftç±»åœ¨OCç±»é‡Œæ‰“å°:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="title class_">XQTableViewCell</span> *swtCell = [[<span class="title class_">XQTableViewCell</span> alloc] <span class="symbol">initWithStyle:</span><span class="title class_">UITableViewCellStyleValue1</span> <span class="symbol">reuseIdentifier:</span>@<span class="string">&quot;xxx&quot;</span>];</span><br><span class="line"><span class="title class_">NSLog</span>(@<span class="string">&quot;+classæ–¹æ³•:%@ -classæ–¹æ³•:%@ classString:%@ obj:%@&quot;</span>, <span class="title class_">XQTableViewCell</span>.<span class="keyword">class</span>, swtCell.<span class="keyword">class</span>, <span class="title class_">NSStringFromClass</span>(<span class="title class_">XQTableViewCell</span>.<span class="keyword">class</span>), swtCell);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="number">2019</span>-09-<span class="number">12</span> <span class="number">16</span><span class="symbol">:</span><span class="number">24</span><span class="symbol">:</span><span class="number">32.637695</span>+0800 <span class="title class_">OSHybridDemo</span>[<span class="number">33981</span><span class="symbol">:</span><span class="number">5943715</span>] +<span class="keyword">class</span>æ–¹æ³•<span class="symbol">:OSHybridDemo</span>.<span class="title class_">XQTableViewCell</span> -<span class="keyword">class</span>æ–¹æ³•<span class="symbol">:OSHybridDemo</span>.<span class="title class_">XQTableViewCell</span> <span class="symbol">classString:</span><span class="title class_">OSHybridDemo</span>.<span class="title class_">XQTableViewCell</span> <span class="symbol">obj:</span>&lt;<span class="title class_">OSHybridDemo</span>.<span class="title class_">XQTableViewCell</span>: <span class="number">0x7ffab705e200</span>; baseClass = <span class="title class_">UITableViewCell</span>; frame = (<span class="number">0</span> <span class="number">0</span>; <span class="number">320</span> <span class="number">44</span>); layer = &lt;<span class="title class_">CALayer</span>: <span class="number">0x60000251a6e0</span>&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>Swiftç±»åœ¨Swiftç±»é‡Œæ‰“å°:</p>
<figure class="highlight elm"><table><tr><td class="code"><pre><span class="line"><span class="title">let</span> people = <span class="type">People</span>.init()</span><br><span class="line"><span class="title">print</span>(<span class="type">People</span>.self, <span class="keyword">type</span>(of: people), <span class="type">NSStringFromClass</span>(<span class="type">People</span>.self), <span class="type">String</span>.init(describing: <span class="type">People</span>.self), people) //<span class="type">NSStringFromClass</span>(<span class="type">People</span>.self)æœ‰å‘½åç©ºé—´,è€Œ<span class="type">String</span>.init(describing: <span class="type">People</span>.self)æ²¡æœ‰å‘½åç©ºé—´</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="type">People</span> <span class="type">People</span> <span class="type">OSHybridDemo</span>.<span class="type">People</span> <span class="type">People</span> &lt;<span class="type">OSHybridDemo</span>.<span class="type">People</span>: <span class="number">0x60000157ec10</span>&gt;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ä½¿ç”¨NSStringFromClass(People.self)æœ‰å‘½åç©ºé—´,è€ŒString.init(describing: People.self)æ²¡æœ‰å‘½åç©ºé—´.</p>
<p>OCç±»åœ¨Swiftç±»é‡Œæ‰“å°:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> ocObj <span class="operator">=</span> <span class="type">XQMessageTableViewCell</span>.<span class="keyword">init</span>()</span><br><span class="line"><span class="built_in">print</span>(<span class="type">XQMessageTableViewCell</span>.<span class="keyword">self</span>, <span class="built_in">type</span>(of: ocObj), <span class="type">NSStringFromClass</span>(<span class="type">XQMessageTableViewCell</span>.<span class="keyword">self</span>), <span class="type">String</span>.<span class="keyword">init</span>(describing: <span class="type">XQMessageTableViewCell</span>.<span class="keyword">self</span>), ocObj)</span><br><span class="line"></span><br><span class="line"><span class="operator">...</span></span><br><span class="line"></span><br><span class="line"><span class="type">XQMessageTableViewCell</span> <span class="type">XQMessageTableViewCell</span> <span class="type">XQMessageTableViewCell</span> <span class="type">XQMessageTableViewCell</span> <span class="operator">&lt;</span><span class="type">XQMessageTableViewCell</span>: <span class="number">0x7fcad001b600</span>; baseClass <span class="operator">=</span> <span class="type">UITableViewCell</span>; frame <span class="operator">=</span> (<span class="number">0</span> <span class="number">0</span>; <span class="number">320</span> <span class="number">44</span>); layer <span class="operator">=</span> <span class="operator">&lt;</span><span class="type">CALayer</span>: <span class="number">0x600000f517c0</span><span class="operator">&gt;&gt;</span></span><br></pre></td></tr></table></figure>
<p>æ€»ç»“:</p>
<p>ä½¿ç”¨NSStringFromClass()è·å–ç±»åæ—¶,å¯¹äºSwiftç±»ç³»ç»Ÿä¼šåœ¨ç±»åå‰æ·»åŠ å‘½åç©ºé—´.è€ŒOCæ²¡æœ‰è¿™ä¸€æ¦‚å¿µæ‰€ä»¥æ²¡æœ‰å‘½åç©ºé—´.</p>
<h3 id="åå°„"><a href="#åå°„" class="headerlink" title="åå°„"></a>åå°„</h3><p>ç³»ç»Ÿæä¾›çš„æ–¹æ³•å¦‚ä¸‹:</p>
<p>OC:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">FOUNDATION_EXPORT <span class="built_in">NSString</span> *<span class="built_in">NSStringFromClass</span>(Class aClass);</span><br><span class="line">FOUNDATION_EXPORT Class _Nullable <span class="built_in">NSClassFromString</span>(<span class="built_in">NSString</span> *aClassName);</span><br></pre></td></tr></table></figure>
<p>Swift:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">NSStringFromClass</span>(<span class="keyword">_</span> <span class="params">aClass</span>: <span class="type">AnyClass</span>) -&gt; <span class="type">String</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">NSClassFromString</span>(<span class="keyword">_</span> <span class="params">aClassName</span>: <span class="type">String</span>) -&gt; <span class="type">AnyClass</span>?</span><br></pre></td></tr></table></figure>
<p>å·²çŸ¥ä¸€ä¸ªOCç±»å,å¦‚æœéœ€è¦é€šè¿‡è¯¥ç±»åå­—ç¬¦ä¸²æ¥åˆ›å»ºä¸€ä¸ªå®ä¾‹,æ— éœ€æŒ‡å®šå‘½åç©ºé—´.å’Œä¹‹å‰å†™æ³•ä¸€æ ·.</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> ocCls: <span class="type">AnyClass</span>? <span class="operator">=</span> <span class="type">NSClassFromString</span>(<span class="string">&quot;XQMessageTableViewCell&quot;</span>)</span><br><span class="line"><span class="keyword">let</span> ocConcreteCls: <span class="type">XQMessageTableViewCell</span>.<span class="keyword">Type</span> <span class="operator">=</span> ocCls <span class="keyword">as!</span> <span class="type">XQMessageTableViewCell</span>.<span class="keyword">Type</span></span><br><span class="line"><span class="keyword">let</span> aocObj <span class="operator">=</span> ocConcreteCls.<span class="keyword">init</span>(style: .default, reuseIdentifier: <span class="string">&quot;reuseIdentifier&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(aocObj)</span><br></pre></td></tr></table></figure>
<p>å·²çŸ¥ä¸€ä¸ªSwiftç±»å,é€šè¿‡è¯¥ç±»åå­—ç¬¦ä¸²æ¥åˆ›å»ºä¸€ä¸ªå®ä¾‹:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> namespace <span class="operator">=</span> <span class="type">Bundle</span>.main.infoDictionary<span class="operator">!</span>[<span class="string">&quot;CFBundleExecutable&quot;</span>] <span class="keyword">as!</span> <span class="type">String</span></span><br><span class="line"><span class="keyword">let</span> s2: <span class="type">People</span>.<span class="keyword">Type</span> <span class="operator">=</span> <span class="type">NSClassFromString</span>(namespace <span class="operator">+</span> <span class="string">&quot;.&quot;</span> <span class="operator">+</span> <span class="string">&quot;People&quot;</span>) <span class="keyword">as!</span> <span class="type">People</span>.<span class="keyword">Type</span></span><br><span class="line"><span class="keyword">let</span> s2obj <span class="operator">=</span> s2.<span class="keyword">init</span>()</span><br><span class="line"><span class="built_in">print</span>(s2obj)</span><br></pre></td></tr></table></figure>
<p>å¯¹äºSwiftçš„ç±»,å¦‚æœéœ€è¦é€šè¿‡è¯¥ç±»åå­—ç¬¦ä¸²æ¥åˆ›å»ºä¸€ä¸ªå®ä¾‹,åˆ™å¿…é¡»æŒ‡å®šå‘½åç©ºé—´.</p>
<p>é”™è¯¯å†™æ³•:æ²¡æœ‰æ‹¼æ¥å‘½åç©ºé—´.</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> swiftCls: <span class="type">AnyClass</span>? <span class="operator">=</span> <span class="type">NSClassFromString</span>(<span class="string">&quot;People&quot;</span>) <span class="comment">//è¿™é‡Œå…¶å®æ˜¯nil.</span></span><br><span class="line"><span class="keyword">let</span> swiftConcreteCls: <span class="type">People</span>.<span class="keyword">Type</span> <span class="operator">=</span> swiftCls <span class="keyword">as!</span> <span class="type">People</span>.<span class="keyword">Type</span> </span><br><span class="line"><span class="keyword">let</span> swiftobj <span class="operator">=</span> swiftConcreteCls.<span class="keyword">init</span>()</span><br><span class="line"><span class="built_in">print</span>(swiftobj)</span><br></pre></td></tr></table></figure>
<h3 id="å°è£…"><a href="#å°è£…" class="headerlink" title="å°è£…"></a>å°è£…</h3><p>å¯¹äºæ··ç¼–å·¥ç¨‹,ä¸ºäº†ä½¿ç”¨æ–¹ä¾¿,å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å°è£…æ–¹æ³•.</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ZAEClassUtil</span>: <span class="title class_ inherited__">NSObject</span> &#123;</span><br><span class="line">    <span class="keyword">@objc</span> <span class="keyword">static</span> <span class="keyword">func</span> <span class="title function_">getClassType</span>(<span class="params">namespace</span>: <span class="type">String</span>?, <span class="params">className</span>: <span class="type">String</span>) -&gt; <span class="type">AnyClass</span>? &#123;</span><br><span class="line">        <span class="keyword">var</span> rs: <span class="type">AnyClass</span>? <span class="operator">=</span> <span class="type">NSClassFromString</span>(className)</span><br><span class="line">        <span class="keyword">if</span> rs <span class="operator">==</span> <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> ns <span class="operator">=</span> namespace <span class="operator">??</span> <span class="type">Bundle</span>.main.infoDictionary<span class="operator">!</span>[<span class="string">&quot;CFBundleExecutable&quot;</span>] <span class="keyword">as!</span> <span class="type">String</span></span><br><span class="line">            rs <span class="operator">=</span> <span class="type">NSClassFromString</span>(ns <span class="operator">+</span> <span class="string">&quot;.&quot;</span> <span class="operator">+</span> className) <span class="comment">//å¦‚æœç±»åå¯¹åº”çš„æ˜¯Swiftç±»åˆ™å¿…é¡»è¦æ‹¼æ¥å‘½åç©ºé—´,å¦‚æœæ˜¯OCçš„åˆ™ä¸éœ€è¦.</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rs</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">@objc</span> <span class="keyword">static</span> <span class="keyword">func</span> <span class="title function_">getClassString</span>(<span class="params">cls</span>: <span class="type">AnyClass</span>) -&gt; <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> name <span class="operator">=</span> <span class="type">NSStringFromClass</span>(cls)</span><br><span class="line">        <span class="keyword">if</span> (name.contains(<span class="string">&quot;.&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> name.components(separatedBy: <span class="string">&quot;.&quot;</span>)[<span class="number">1</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨å¦‚ä¸‹:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> s3: <span class="type">XQRedView</span>.<span class="keyword">Type</span> <span class="operator">=</span> <span class="type">ZAEClassUtil</span>.getClassType(namespace: <span class="literal">nil</span>, className: <span class="string">&quot;XQRedView&quot;</span>) <span class="keyword">as!</span> <span class="type">XQRedView</span>.<span class="keyword">Type</span></span><br><span class="line"><span class="keyword">let</span> s3obj <span class="operator">=</span> s3.<span class="keyword">init</span>(frame: .zero)</span><br><span class="line"><span class="built_in">print</span>(s3obj)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">let</span> s4: <span class="type">XQMessageTableViewCell</span>.<span class="keyword">Type</span> <span class="operator">=</span> <span class="type">ZAEClassUtil</span>.getClassType(namespace: <span class="literal">nil</span>, className: <span class="string">&quot;XQMessageTableViewCell&quot;</span>) <span class="keyword">as!</span> <span class="type">XQMessageTableViewCell</span>.<span class="keyword">Type</span></span><br><span class="line"><span class="keyword">let</span> s4obj <span class="operator">=</span> s4.<span class="keyword">init</span>(style: .default, reuseIdentifier: <span class="string">&quot;reuseIdentifier&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(s4obj, <span class="type">ZAEClassUtil</span>.getClassString(cls: s4))</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Swift</category>
      </categories>
      <tags>
        <tag>åå°„</tag>
      </tags>
  </entry>
  <entry>
    <title>OCæ‡’åŠ è½½ä¸Swiftæ‡’åŠ è½½</title>
    <url>/2019/09/01/OC%E6%87%92%E5%8A%A0%E8%BD%BD%E4%B8%8ESwift%E6%87%92%E5%8A%A0%E8%BD%BD/</url>
    <content><![CDATA[<h3 id="OCæ‡’åŠ è½½ä¸Swiftæ‡’åŠ è½½"><a href="#OCæ‡’åŠ è½½ä¸Swiftæ‡’åŠ è½½" class="headerlink" title="OCæ‡’åŠ è½½ä¸Swiftæ‡’åŠ è½½"></a>OCæ‡’åŠ è½½ä¸Swiftæ‡’åŠ è½½</h3><h4 id="OCæ‡’åŠ è½½"><a href="#OCæ‡’åŠ è½½" class="headerlink" title="OCæ‡’åŠ è½½"></a>OCæ‡’åŠ è½½</h4><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="operator">-</span> (<span class="type">UIView</span> <span class="operator">*</span>)redView</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_redView <span class="operator">==</span> <span class="literal">nil</span>) &#123;</span><br><span class="line">        _redView <span class="operator">=</span> [[<span class="type">UIView</span> alloc] <span class="keyword">init</span>];</span><br><span class="line">        _redView.frame <span class="operator">=</span> <span class="type">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">200</span>);</span><br><span class="line">        _redView.backgroundColor <span class="operator">=</span> <span class="type">UIColor</span>.redColor;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _redView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ³¨æ„</strong>:åœ¨æ‡’åŠ è½½çš„å®ç°ä¸­å°½é‡é¿å…æ‡’åŠ è½½å¾ªç¯.å³Aæ‡’åŠ è½½B,Båˆæ‡’åŠ è½½A.è¿™æ ·ä¼šå¯¼è‡´äº’ç›¸è°ƒç”¨è€Œæ­»å¾ªç¯æˆ–è€…åç¦»é¢„æœŸç»“æœ.</p>
<p>é”™è¯¯ç¤ºä¾‹1:ä¼šå¯¼è‡´è°ƒç”¨æ­»å¾ªç¯.</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">UIView</span> *)redView</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_redView == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="built_in">UIView</span> *view = [[<span class="built_in">UIView</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">self</span>.blackView.frame.size.width + <span class="number">100</span>, <span class="number">200</span>)];</span><br><span class="line">        view.backgroundColor = <span class="built_in">UIColor</span>.redColor;</span><br><span class="line">        _redView = view;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _redView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UIView</span> *)blackView</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_blackView == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="built_in">UIView</span> *view = [[<span class="built_in">UIView</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">200</span>, <span class="keyword">self</span>.redView.frame.size.height + <span class="number">100</span>)];</span><br><span class="line">        view.backgroundColor = <span class="built_in">UIColor</span>.blackColor;</span><br><span class="line">        _blackView = view;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _blackView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>é”™è¯¯ç¤ºä¾‹2:ç¤ºä¾‹2å…¶å®å’Œç¤ºä¾‹1æ˜¯ä¸€å›äº‹.ä¹Ÿä¼šå¯¼è‡´è°ƒç”¨æ­»å¾ªç¯.</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">UIView</span> *)redView</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_redView == <span class="literal">nil</span>) &#123;</span><br><span class="line">        _redView = [[<span class="built_in">UIView</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">self</span>.blackView.frame.size.width + <span class="number">100</span>, <span class="number">200</span>)];</span><br><span class="line">        _redView.backgroundColor = <span class="built_in">UIColor</span>.redColor;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _redView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UIView</span> *)blackView</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_blackView == <span class="literal">nil</span>) &#123;</span><br><span class="line">        _blackView = [[<span class="built_in">UIView</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">200</span>, <span class="keyword">self</span>.redView.frame.size.height + <span class="number">100</span>)];</span><br><span class="line">        _blackView.backgroundColor = <span class="built_in">UIColor</span>.blackColor;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _blackView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é”™è¯¯ç¤ºä¾‹3:ç¨‹åºä¼šåœ¨<code>[self.view addSubview:self.redView];</code>è¿™ä¸€è¡Œå´©æºƒ:<code>Thread 1: EXC_BAD_ACCESS (code=1, address=0x0)</code></p>
<p>åŸå› åœ¨äº:å¯¹äºä¸€ä¸ªOCå¯¹è±¡,allocä¹‹åå¿…é¡»è°ƒç”¨initæ–¹æ³•å®Œæˆåˆå§‹åŒ–.å¯¹è±¡åªæœ‰åœ¨åˆå§‹åŒ–å®Œæˆä¹‹åæ‰èƒ½ç»§ç»­ä½¿ç”¨.</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="type">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="variable language_">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:<span class="keyword">self</span>.redView];</span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:<span class="keyword">self</span>.blackView];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UIView</span> *)redView</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_redView == <span class="literal">nil</span>) &#123;</span><br><span class="line">        _redView = [<span class="built_in">UIView</span> alloc];</span><br><span class="line">        _redView.frame = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">self</span>.blackView.frame.size.width + <span class="number">100</span>, <span class="number">200</span>);</span><br><span class="line">        _redView.backgroundColor = <span class="built_in">UIColor</span>.redColor;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _redView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UIView</span> *)blackView</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_blackView == <span class="literal">nil</span>) &#123;</span><br><span class="line">        _blackView = [<span class="built_in">UIView</span> alloc];</span><br><span class="line">        _blackView.frame = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">200</span>, <span class="keyword">self</span>.redView.frame.size.height + <span class="number">100</span>);</span><br><span class="line">        _blackView.backgroundColor = <span class="built_in">UIColor</span>.blackColor;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _blackView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é”™è¯¯ç¤ºä¾‹4:ç¨‹åºè™½ç„¶ä¸ä¼šå´©æºƒ,ä½†äºŒè€…çš„frameä¼šå’Œä½ çš„é¢„æœŸä¸åŒ,å› æ­¤ä¸å»ºè®®è¿™ä¹ˆåš.</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="operator">-</span> (<span class="type">UIView</span> <span class="operator">*</span>)redView</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_redView <span class="operator">==</span> <span class="literal">nil</span>) &#123;</span><br><span class="line">        _redView <span class="operator">=</span> [[<span class="type">UIView</span> alloc] <span class="keyword">init</span>];</span><br><span class="line">        _redView.frame <span class="operator">=</span> <span class="type">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">self</span>.blackView.frame.size.width <span class="operator">+</span> <span class="number">100</span>, <span class="number">200</span>);</span><br><span class="line">        _redView.backgroundColor <span class="operator">=</span> <span class="type">UIColor</span>.redColor;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _redView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="operator">-</span> (<span class="type">UIView</span> <span class="operator">*</span>)blackView</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_blackView <span class="operator">==</span> <span class="literal">nil</span>) &#123;</span><br><span class="line">        _blackView <span class="operator">=</span> [[<span class="type">UIView</span> alloc] <span class="keyword">init</span>];</span><br><span class="line">        _blackView.frame <span class="operator">=</span> <span class="type">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">200</span>, <span class="keyword">self</span>.redView.frame.size.height <span class="operator">+</span> <span class="number">100</span>);</span><br><span class="line">        _blackView.backgroundColor <span class="operator">=</span> <span class="type">UIColor</span>.blackColor;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _blackView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿˜æœ‰ä¸€ç§æ›´éšç§˜çš„æ‡’åŠ è½½è°ƒç”¨æ‡’åŠ è½½:å­è§†å›¾æ‡’åŠ è½½ä¸­ä½¿ç”¨äº†self.view,è€Œself.viewä¹Ÿæ˜¯æ‡’åŠ è½½çš„.è™½ç„¶åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹self.viewä¼šå…ˆäºå­è§†å›¾åŠ è½½,ä»è€Œä¸ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜.ä½†ä¹Ÿæœ‰ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹ä¼šå‡ºç°å­è§†å›¾å…ˆäºself.viewè®¿é—®.ä»è€Œå‡ºç°ä¸€äº›bug.</p>
<p>eg: å­è§†å›¾redViewä½¿ç”¨äº†self.viewçš„frameä¿¡æ¯.</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NS_ASSUME_NONNULL_BEGIN</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">XQViewController</span> : <span class="title">UIViewController</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIView</span> *redView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NS_ASSUME_NONNULL_END</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">XQViewController</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">XQViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="variable language_">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.view.backgroundColor = <span class="built_in">UIColor</span>.whiteColor;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.view addSubview:<span class="keyword">self</span>.redView];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;æ·»åŠ çš„view:%@&quot;</span>, _redView);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UIView</span> *)redView</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_redView == <span class="literal">nil</span>) &#123;</span><br><span class="line">        _redView = [[<span class="built_in">UIView</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">200</span>, <span class="keyword">self</span>.view.frame.size.width, <span class="number">200</span>)];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, _redView);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _redView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span> dismissViewControllerAnimated:<span class="literal">YES</span> completion:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="comment">//åœ¨æŸä¸ªåœ°æ–¹æˆ‘ä»¬å…ˆè®¿é—®äº†å­æ§ä»¶,å¹¶è°ƒç”¨äº†å­æ§ä»¶çš„æŸä¸ªæ–¹æ³•.</span></span><br><span class="line">- (<span class="type">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event</span><br><span class="line">&#123;</span><br><span class="line">    XQViewController *vc = [XQViewController.alloc init];</span><br><span class="line">    vc.redView.backgroundColor = <span class="built_in">UIColor</span>.redColor;</span><br><span class="line">    [<span class="keyword">self</span> presentViewController:vc animated:<span class="literal">YES</span> completion:^&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>æ‰“å°å¦‚ä¸‹:</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">2019</span>-<span class="number">09</span>-<span class="number">01</span> <span class="number">12</span>:<span class="number">21</span>:<span class="number">08</span>.<span class="number">512351</span>+<span class="number">0800</span> OCDemo[<span class="number">70734</span>:<span class="number">2950590</span>] &lt;UIView: <span class="number">0</span>x7fd353f14610; frame = (<span class="number">0</span> <span class="number">200</span>; <span class="number">375</span> <span class="number">200</span>); layer = &lt;CALayer: <span class="number">0</span>x600002d6dae0&gt;&gt;</span><br><span class="line"><span class="attribute">2019</span>-<span class="number">09</span>-<span class="number">01</span> <span class="number">12</span>:<span class="number">21</span>:<span class="number">08</span>.<span class="number">512753</span>+<span class="number">0800</span> OCDemo[<span class="number">70734</span>:<span class="number">2950590</span>] æ·»åŠ çš„view:&lt;UIView: <span class="number">0</span>x7fd353f14610; frame = (<span class="number">0</span> <span class="number">200</span>; <span class="number">375</span> <span class="number">200</span>); layer = &lt;CALayer: <span class="number">0</span>x600002d6dae0&gt;&gt;</span><br><span class="line"><span class="attribute">2019</span>-<span class="number">09</span>-<span class="number">01</span> <span class="number">12</span>:<span class="number">21</span>:<span class="number">08</span>.<span class="number">512946</span>+<span class="number">0800</span> OCDemo[<span class="number">70734</span>:<span class="number">2950590</span>] &lt;UIView: <span class="number">0</span>x7fd353f0a1f0; frame = (<span class="number">0</span> <span class="number">200</span>; <span class="number">375</span> <span class="number">200</span>); layer = &lt;CALayer: <span class="number">0</span>x600002d75960&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ—¶å€™self.redViewå’Œself.viewä¸Šæ·»åŠ çš„redViewå…¶å®æ˜¯ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡.å› æ­¤ç•Œé¢ä¸Šå¹¶ä¸ä¼šå‡ºç°çº¢è‰²çš„è§†å›¾.</p>
<p>è§£å†³åŠæ³•æœ‰ä¸¤ç§:</p>
<ol>
<li>æ‰‹åŠ¨æå‰self.viewçš„åŠ è½½.å¦‚:<code>[vc loadViewIfNeeded];</code></li>
<li>é¿å…åœ¨å­æ§ä»¶ä¸­ä½¿ç”¨self.view</li>
</ol>
<h4 id="Swiftæ‡’åŠ è½½"><a href="#Swiftæ‡’åŠ è½½" class="headerlink" title="Swiftæ‡’åŠ è½½"></a>Swiftæ‡’åŠ è½½</h4><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">lazy</span> <span class="keyword">var</span> blackView: <span class="type">UIView</span>? <span class="operator">=</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> view <span class="operator">=</span> <span class="type">UIView</span>.<span class="keyword">init</span>(frame: <span class="type">CGRect</span>.<span class="keyword">init</span>(x: <span class="number">0</span>, y: <span class="number">300</span>, width: <span class="number">200</span>, height: <span class="number">100</span>))</span><br><span class="line">    view.backgroundColor <span class="operator">=</span> .black</span><br><span class="line">    <span class="keyword">return</span> view</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
<p>Swiftçš„æ‡’åŠ è½½å®ç°åªä¼šæ‰§è¡Œä¸€æ¬¡,å¦‚æœåœ¨æŸä¸ªåœ°æ–¹å°†blackViewç½®ä¸ºnilå,æ‡’åŠ è½½çš„å®ç°ä¸ä¼šè¢«å†æ¬¡æ‰§è¡Œ.blackViewå°±ä¸€ç›´æ˜¯niläº†.</p>
<p>åŒæ ·:åœ¨æ‡’åŠ è½½çš„å®ç°ä¸­å°½é‡é¿å…ç›¸äº’æ‡’åŠ è½½.</p>
<p>é”™è¯¯ç¤ºä¾‹:æ­»å¾ªç¯</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">lazy</span> <span class="keyword">var</span> redView: <span class="type">UIView</span> <span class="operator">=</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> view <span class="operator">=</span> <span class="type">UIView</span>.<span class="keyword">init</span>(frame: <span class="type">CGRect</span>.<span class="keyword">init</span>(x: <span class="number">0</span>, y: <span class="number">0</span>, width: <span class="keyword">self</span>.blackView.frame.size.width <span class="operator">+</span> <span class="number">100</span>, height: <span class="number">200</span>))</span><br><span class="line">    view.backgroundColor <span class="operator">=</span> .red</span><br><span class="line">    <span class="keyword">return</span> view</span><br><span class="line">&#125;()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">lazy</span> <span class="keyword">var</span> blackView: <span class="type">UIView</span> <span class="operator">=</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> view <span class="operator">=</span> <span class="type">UIView</span>.<span class="keyword">init</span>(frame: <span class="type">CGRect</span>.<span class="keyword">init</span>(x: <span class="number">0</span>, y: <span class="number">300</span>, width: <span class="number">200</span>, height: <span class="keyword">self</span>.redView.frame.size.height <span class="operator">+</span> <span class="number">100</span>))</span><br><span class="line">    view.backgroundColor <span class="operator">=</span> .black</span><br><span class="line">    <span class="keyword">return</span> view</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>ç›¸åŒç‚¹:å¯¹è±¡åœ¨çœŸæ­£ä½¿ç”¨æ—¶æ‰ä¼šè¢«åˆå§‹åŒ–.</p>
<p>ä¸åŒç‚¹:OCçš„æ‡’åŠ è½½å®ç°å¯èƒ½ä¼šè¢«å¤šæ¬¡è°ƒç”¨.å½“å±æ€§çš„å®ä¾‹å˜é‡å˜ä¸ºnilæ—¶ä¼šå†æ¬¡æ‰§è¡Œ.è€ŒSwiftçš„æ‡’åŠ è½½å®ç°åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡,å¦‚æœåœ¨æŸä¸ªåœ°æ–¹å°†å˜é‡ç½®ä¸ºnilå,æ‡’åŠ è½½çš„å®ç°ä¸ä¼šè¢«å†æ¬¡æ‰§è¡Œ.å˜é‡å°±ä¸€ç›´æ˜¯niläº†.</p>
<p>æ³¨æ„ç‚¹:åœ¨æ‡’åŠ è½½çš„å®ç°ä¸­å°½é‡é¿å…æ‡’åŠ è½½å¾ªç¯.å³Aæ‡’åŠ è½½B,Båˆæ‡’åŠ è½½A.è¿™æ ·ä¼šå¯¼è‡´äº’ç›¸è°ƒç”¨è€Œæ­»å¾ªç¯æˆ–è€…åç¦»é¢„æœŸç»“æœ.</p>
]]></content>
      <categories>
        <category>Swift</category>
      </categories>
      <tags>
        <tag>æ‡’åŠ è½½</tag>
      </tags>
  </entry>
  <entry>
    <title>åµŒå¥—é¡µé¢æ‰‹åŠ¿å†²çªè§£å†³</title>
    <url>/2019/08/04/%E5%B5%8C%E5%A5%97%E9%A1%B5%E9%9D%A2%E6%89%8B%E5%8A%BF%E5%86%B2%E7%AA%81%E8%A7%A3%E5%86%B3/</url>
    <content><![CDATA[<h4 id="BUGåœºæ™¯"><a href="#BUGåœºæ™¯" class="headerlink" title="BUGåœºæ™¯"></a>BUGåœºæ™¯</h4><p>mainTableViewåµŒå¥—listTableView.mainTableViewçš„headerViewé‡Œæœ‰å·¦å³æ»‘åŠ¨çš„collectionView(eg:è½®æ’­å›¾).æ­¤æ—¶mainTableViewçš„ä¸‹æ‹‰åˆ·æ–°å°±ä¼šå’ŒcollectionViewçš„å·¦å³æ»‘åŠ¨èµ·å†²çª.collectionViewå·¦å³æ»‘æ—¶,mainTableViewå¯èƒ½ä¼šè·Ÿç€ä¸€èµ·åŠ¨.</p>
<p>ä¸ºäº†å®ç°å¸é¡¶æ•ˆæœ,mainTableViewæ˜¯å…è®¸åŒæ—¶è¯†åˆ«å¤šä¸ªæ‰‹åŠ¿çš„.è€Œè¿™æ°æ°æ˜¯å¼•èµ·æ‰‹åŠ¿å†²çªçš„åŸå› .</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MainTableView</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…è®¸å¤šä¸ªæ‰‹åŠ¿</span></span><br><span class="line">- (<span class="type">BOOL</span>)gestureRecognizer:(<span class="built_in">UIGestureRecognizer</span> *)gestureRecognizer shouldRecognizeSimultaneouslyWithGestureRecognizer:(<span class="built_in">UIGestureRecognizer</span> *)otherGestureRecognizer &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h4 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h4><p>ç”±äºmainTableViewåªèƒ½ä¸Šä¸‹æ»‘åŠ¨,å› æ­¤å¯ä»¥åˆ¤æ–­å¦‚æœotherGestureRecognizeræ‰€åœ¨çš„viewåœ¨å·¦å³æ»‘åŠ¨åˆ™ä¸è®©mainTableViewçš„æ‰‹åŠ¿åŒæ—¶è¯†åˆ«.</p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªä¸å¥½å¤„ç†çš„åœ°æ–¹å°±æ˜¯åœ¨æŸäº›ç²¾å¿ƒæ„é€ çš„æ»‘åŠ¨ä¸‹,pointå¯èƒ½ä¸º(0,0),</p>
<blockquote>
<p>å¶ç°æ—¶çš„æ—¥å¿—:</p>
<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line"><span class="number">201</span>9-<span class="number">0</span>8-<span class="number">03</span> <span class="number">18</span>:<span class="number">23</span>:<span class="number">52.661593</span><span class="operator">+</span><span class="number">0800</span> xxx[<span class="number">20938</span>:<span class="number">1512558</span>] </span><br><span class="line">view:<span class="operator">&lt;</span><span class="params">MainTableView:</span> <span class="number">0</span>x1070c3c00; <span class="attr">baseClass</span> <span class="operator">=</span> UITableView; <span class="attr">frame</span> <span class="operator">=</span> (<span class="number">0</span> <span class="number">0</span>; <span class="number">414</span> <span class="number">623</span>); <span class="attr">clipsToBounds</span> <span class="operator">=</span> YES; <span class="attr">gestureRecognizers</span> <span class="operator">=</span> <span class="operator">&lt;</span><span class="params">NSArray:</span> <span class="number">0</span>x282b5dce0<span class="operator">&gt;</span>; <span class="attr">layer</span> <span class="operator">=</span> <span class="operator">&lt;</span><span class="params">CALayer:</span> <span class="number">0</span>x28258a980<span class="operator">&gt;</span>; <span class="params">contentOffset:</span> &#123;<span class="number">0</span>, <span class="operator">-</span><span class="number">3.3333333333333335</span>&#125;; <span class="params">contentSize:</span> &#123;<span class="number">414</span>, <span class="number">1418</span>&#125;; <span class="params">adjustedContentInset:</span> &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;<span class="operator">&gt;</span></span><br><span class="line">ges:<span class="operator">&lt;</span><span class="params">UIScrollViewPanGestureRecognizer:</span> <span class="number">0</span>x106d75500; <span class="attr">state</span> <span class="operator">=</span> Changed; <span class="attr">delaysTouchesEnded</span> <span class="operator">=</span> NO; <span class="attr">view</span> <span class="operator">=</span> <span class="operator">&lt;</span>GKPageTableView <span class="number">0</span>x1070c3c00<span class="operator">&gt;</span>; <span class="attr">target</span><span class="operator">=</span> <span class="operator">&lt;</span>(action<span class="operator">=</span>handlePan:, target<span class="operator">=</span><span class="operator">&lt;</span>GKPageTableView <span class="number">0</span>x1070c3c00<span class="operator">&gt;</span>)<span class="operator">&gt;</span><span class="operator">&gt;</span></span><br><span class="line">otherView:<span class="operator">&lt;</span><span class="params">UICollectionView:</span> <span class="number">0</span>x1079cea00; <span class="attr">frame</span> <span class="operator">=</span> (<span class="number">0</span> <span class="number">0</span>; <span class="number">414</span> <span class="number">165.6</span>); <span class="attr">clipsToBounds</span> <span class="operator">=</span> YES; <span class="attr">gestureRecognizers</span> <span class="operator">=</span> <span class="operator">&lt;</span><span class="params">NSArray:</span> <span class="number">0</span>x282b03930<span class="operator">&gt;</span>; <span class="attr">layer</span> <span class="operator">=</span> <span class="operator">&lt;</span><span class="params">CALayer:</span> <span class="number">0</span>x2825528c0<span class="operator">&gt;</span>; <span class="params">contentOffset:</span> &#123;<span class="number">64584</span>, <span class="number">0</span>&#125;; <span class="params">contentSize:</span> &#123;<span class="number">124200</span>, <span class="number">165.60000000000002</span>&#125;; <span class="params">adjustedContentInset:</span> &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;<span class="operator">&gt;</span> collection view <span class="params">layout:</span> <span class="operator">&lt;</span><span class="params">UICollectionViewFlowLayout:</span> <span class="number">0</span>x111c20eb0<span class="operator">&gt;</span></span><br><span class="line">otherGes:<span class="operator">&lt;</span><span class="params">UIScrollViewPanGestureRecognizer:</span> <span class="number">0</span>x106c7aaa0; <span class="attr">state</span> <span class="operator">=</span> Began; <span class="attr">delaysTouchesEnded</span> <span class="operator">=</span> NO; <span class="attr">view</span> <span class="operator">=</span> <span class="operator">&lt;</span>UICollectionView <span class="number">0</span>x1079cea00<span class="operator">&gt;</span>; <span class="attr">target</span><span class="operator">=</span> <span class="operator">&lt;</span>(action<span class="operator">=</span>handlePan:, target<span class="operator">=</span><span class="operator">&lt;</span>UICollectionView <span class="number">0</span>x1079cea00<span class="operator">&gt;</span>)<span class="operator">&gt;</span>; <span class="attr">must-fail</span> <span class="operator">=</span> &#123;</span><br><span class="line">        <span class="operator">&lt;</span><span class="params">UIScrollViewPagingSwipeGestureRecognizer:</span> <span class="number">0</span>x111c210d0; <span class="attr">state</span> <span class="operator">=</span> Failed; <span class="attr">view</span> <span class="operator">=</span> <span class="operator">&lt;</span>UICollectionView <span class="number">0</span>x1079cea00<span class="operator">&gt;</span>; <span class="attr">target</span><span class="operator">=</span> <span class="operator">&lt;</span>(action<span class="operator">=</span>_handleSwipe:, target<span class="operator">=</span><span class="operator">&lt;</span>UICollectionView <span class="number">0</span>x1079cea00<span class="operator">&gt;</span>)<span class="operator">&gt;</span><span class="operator">&gt;</span></span><br><span class="line">    &#125;<span class="operator">&gt;</span></span><br><span class="line"><span class="number">201</span>9-<span class="number">0</span>8-<span class="number">03</span> <span class="number">18</span>:<span class="number">23</span>:<span class="number">52.662988</span><span class="operator">+</span><span class="number">0800</span> EmotionCounsel[<span class="number">20938</span>:<span class="number">1512558</span>] </span><br><span class="line">ç§»åŠ¨çš„ä½ç½®:&#123;<span class="number">0</span>, <span class="number">7</span>&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>æ­¤æ—¶å°±æ²¡åŠæ³•åˆ¤æ–­å‡ºotherGestureRecognizer.viewæ˜¯ä¸æ˜¯åœ¨å·¦å³æ»‘åŠ¨äº†.æ‰€ä»¥åŠ äº†ä¸€ä¸ªelseåˆ¤æ–­é¿å…è¿™ç§æƒ…å†µ.</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MainTableView</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…è®¸å¤šä¸ªæ‰‹åŠ¿</span></span><br><span class="line">- (<span class="type">BOOL</span>)gestureRecognizer:(<span class="built_in">UIGestureRecognizer</span> *)gestureRecognizer shouldRecognizeSimultaneouslyWithGestureRecognizer:(<span class="built_in">UIGestureRecognizer</span> *)otherGestureRecognizer &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ([gestureRecognizer isKindOfClass:[<span class="built_in">UIPanGestureRecognizer</span> <span class="keyword">class</span>]] &amp;&amp; [otherGestureRecognizer isKindOfClass:[<span class="built_in">UIPanGestureRecognizer</span> <span class="keyword">class</span>]] &amp;&amp; otherGestureRecognizer.view != <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">UIPanGestureRecognizer</span> *otherPanGes = (<span class="built_in">UIPanGestureRecognizer</span> *)otherGestureRecognizer;</span><br><span class="line">        <span class="built_in">CGPoint</span> point = [otherPanGes translationInView:otherPanGes.view];</span><br><span class="line">        <span class="built_in">UIGestureRecognizerState</span> otherState = otherPanGes.state;</span><br><span class="line">        <span class="keyword">if</span> (otherState == <span class="built_in">UIGestureRecognizerStatePossible</span> || otherState == <span class="built_in">UIGestureRecognizerStateBegan</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (fabs(point.x) &gt; <span class="number">0</span>) &#123; <span class="comment">//å¦‚æœåœ¨æ°´å¹³å·¦å³æ»‘åŠ¨</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ([otherGestureRecognizer.view isKindOfClass:[<span class="built_in">UICollectionView</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">                    <span class="built_in">UICollectionView</span> *otherView = (<span class="built_in">UICollectionView</span> *)otherGestureRecognizer.view;</span><br><span class="line">                    <span class="keyword">if</span> ([otherView.collectionViewLayout isKindOfClass:[<span class="built_in">UICollectionViewFlowLayout</span> <span class="keyword">class</span>]] &amp;&amp; [(<span class="built_in">UICollectionViewFlowLayout</span> *)otherView.collectionViewLayout scrollDirection] == <span class="built_in">UICollectionViewScrollDirectionHorizontal</span>) &#123;</span><br><span class="line">                        <span class="built_in">NSLog</span>(<span class="string">@&quot;æ­£åœ¨æ»‘åŠ¨å·¦å³æ»šåŠ¨è§†å›¾!!!!!!&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="built_in">NSLog</span>(<span class="string">@&quot;UICollectionViewçš„å…¶ä»–å¸ƒå±€&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">NSLog</span>(<span class="string">@&quot;å…¶ä»–è§†å›¾&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Bug</category>
      </categories>
      <tags>
        <tag>æ‰‹åŠ¿å†²çª</tag>
      </tags>
  </entry>
  <entry>
    <title>éŸ³é¢‘æ‰“æ–­å¤„ç†</title>
    <url>/2019/07/12/%E9%9F%B3%E9%A2%91%E6%89%93%E6%96%AD%E5%A4%84%E7%90%86/</url>
    <content><![CDATA[<h4 id="éŸ³é¢‘æ‰“æ–­å¤„ç†"><a href="#éŸ³é¢‘æ‰“æ–­å¤„ç†" class="headerlink" title="éŸ³é¢‘æ‰“æ–­å¤„ç†"></a>éŸ³é¢‘æ‰“æ–­å¤„ç†</h4><p>éŸ³é¢‘æ‰“æ–­é€šçŸ¥:</p>
<p><code>AVAudioSessionInterruptionNotification</code></p>
<p>éŸ³é¢‘ä¼šè¯è¢«ç³»ç»Ÿæ‰“æ–­æ—¶ä¼šæ”¶åˆ°è¯¥é€šçŸ¥.æ‰“æ–­å¼€å§‹ä¼šæ”¶åˆ°è¯¥é€šçŸ¥,æ‰“æ–­ç»“æŸä¹Ÿä¼šæ”¶åˆ°è¯¥é€šçŸ¥.å¯ä»¥é€šè¿‡userInfoé‡Œçš„<code>AVAudioSessionInterruptionTypeKey</code>keyæŸ¥çœ‹æ‰“æ–­çš„ç±»å‹:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSUInteger</span>, <span class="built_in">AVAudioSessionInterruptionType</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">AVAudioSessionInterruptionTypeBegan</span> = <span class="number">1</span>,  <span class="comment">/* the system has interrupted your audio session */</span></span><br><span class="line">	<span class="built_in">AVAudioSessionInterruptionTypeEnded</span> = <span class="number">0</span>,  <span class="comment">/* the interruption has ended */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* keys for AVAudioSessionInterruptionNotification */</span></span><br><span class="line"><span class="comment">/* Value is an NSNumber representing an AVAudioSessionInterruptionType */</span></span><br><span class="line"><span class="built_in">AVF_EXPORT</span> <span class="built_in">NSString</span> *<span class="keyword">const</span> <span class="built_in">AVAudioSessionInterruptionTypeKey</span> API_AVAILABLE(ios(<span class="number">6.0</span>), watchos(<span class="number">2.0</span>), tvos(<span class="number">9.0</span>)) API_UNAVAILABLE(macos);</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯æ‰“æ–­ç»“æŸç±»å‹,åˆ™userInfoé‡Œä¼šæœ‰ä¸€ä¸ª<code>AVAudioSessionInterruptionOptions</code>key,å®ƒçš„å€¼æ˜¯<code>AVAudioSessionInterruptionOptions</code>æšä¸¾ç±»å‹.ç”¨äºè¡¨ç¤ºæ‰“æ–­ç»“æŸåæ˜¯å¦åº”è¯¥ç»§ç»­æ’­æ”¾.</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* For use with AVAudioSessionInterruptionNotification */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_OPTIONS</span>(<span class="built_in">NSUInteger</span>, <span class="built_in">AVAudioSessionInterruptionOptions</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">AVAudioSessionInterruptionOptionShouldResume</span> = <span class="number">1</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ‰“æ–­æ˜¯å› ä¸ºåº”ç”¨è¢«æŒ‚èµ·,åˆ™userInfoé‡Œä¼šæœ‰ä¸€ä¸ª<code>AVAudioSessionInterruptionWasSuspendedKey</code>key,å¹¶ä¸”å€¼æ˜¯true.(è¿™ä¸ªkeyæœ‰ç‚¹å¥‡è‘©)</p>
<p>ä½¿ç”¨å¦‚ä¸‹:</p>
<p>æ³¨å†Œ<code>AVAudioSessionInterruptionNotification</code>é€šçŸ¥:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">[[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(playerAudioBeInterrupted:) name:<span class="built_in">AVAudioSessionInterruptionNotification</span> object:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>
<p>å¤„ç†é€šçŸ¥:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)playerAudioBeInterrupted:(<span class="built_in">NSNotification</span> *)notification</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSDictionary</span> *userInfo = notification.userInfo;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;éŸ³é¢‘æ‰“æ–­userInfo:%@&quot;</span>, userInfo);</span><br><span class="line">    <span class="built_in">AVAudioSessionInterruptionType</span> interruptionType = [userInfo[<span class="built_in">AVAudioSessionInterruptionTypeKey</span>] integerValue];</span><br><span class="line">    <span class="keyword">if</span> (interruptionType == <span class="built_in">AVAudioSessionInterruptionTypeBegan</span>) &#123;<span class="comment">//æ‰“æ–­å¼€å§‹</span></span><br><span class="line">        <span class="comment">//è¿™ä¸ªæ—¶å€™è¦æš‚åœæ’­æ”¾å™¨</span></span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (interruptionType == <span class="built_in">AVAudioSessionInterruptionTypeEnded</span>) &#123;<span class="comment">//æ‰“æ–­ç»“æŸ</span></span><br><span class="line">        <span class="built_in">AVAudioSessionInterruptionOptions</span> options = [userInfo[<span class="built_in">AVAudioSessionInterruptionOptionKey</span>] integerValue];</span><br><span class="line">        <span class="keyword">if</span> (options == <span class="built_in">AVAudioSessionInterruptionOptionShouldResume</span>) &#123; <span class="comment">//å¯ä»¥ç»§ç»­æ’­æ”¾</span></span><br><span class="line">            <span class="comment">//ç»§ç»­æ’­æ”¾</span></span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">//ä¸å¤„ç†</span></span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;æœªçŸ¥&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PS:åœ¨å¼€å‘çš„æ—¶å€™é‡åˆ°ä¸€ä¸ªå‘:<br>åœ¨appå†…å¬éŸ³ä¹,ç‚¹æš‚åœ,ç„¶åè¿›å…¥åå°ä¸€æ®µæ—¶é—´,å†ä»åå°è¿›å…¥å‰å°æ—¶,éŸ³ä¹å±…ç„¶è‡ªåŠ¨æ’­æ”¾äº†.<br>æœ€åæ‰¾åˆ°åŸå› :ä¸Šè¿°æ“ä½œå,åœ¨è¿›å…¥å‰å°æ—¶ä¼šæ”¶åˆ°<code>AVAudioSessionInterruptionNotification</code>é€šçŸ¥.ä¹‹å‰ä»£ç åœ¨æ‰“æ–­ç»“æŸçš„åˆ¤æ–­ä¸­æ²¡æœ‰ç»§ç»­åˆ¤æ–­æ˜¯å¦åº”è¯¥æ¢å¤æ’­æ”¾,è€Œç›´æ¥è°ƒç”¨äº†playæ–¹æ³•,å¯¼è‡´ä¸Šè¿°bug.</p>
<p>æ‰“å°æ—¥å¿—å¦‚ä¸‹:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="number">19</span>:<span class="number">04</span>:<span class="number">56.847796</span> +<span class="number">0800</span>	EmotionCounsel	app did resume</span><br><span class="line"><span class="number">19</span>:<span class="number">04</span>:<span class="number">56.850945</span> +<span class="number">0800</span>	EmotionCounsel	<span class="built_in">AVAudioSession</span>.mm:<span class="number">2136</span>:-[<span class="built_in">AVAudioSession</span> privateInterruptionWithInfo:]: Posting <span class="built_in">AVAudioSessionInterruptionNotification</span> (Begin Interruption). Was suspended:<span class="number">1</span></span><br><span class="line"><span class="number">19</span>:<span class="number">04</span>:<span class="number">56.851301</span> +<span class="number">0800</span>	EmotionCounsel	éŸ³é¢‘æ‰“æ–­userInfo:&#123;</span><br><span class="line">    <span class="built_in">AVAudioSessionInterruptionTypeKey</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">AVAudioSessionInterruptionWasSuspendedKey</span> = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">19</span>:<span class="number">04</span>:<span class="number">56.851538</span> +<span class="number">0800</span>	EmotionCounsel	<span class="built_in">AVAudioSession</span>.mm:<span class="number">2156</span>:-[<span class="built_in">AVAudioSession</span> privateInterruptionWithInfo:]: Posting <span class="built_in">AVAudioSessionInterruptionNotification</span> (End Interruption). Resumable:<span class="number">0</span></span><br><span class="line"><span class="number">19</span>:<span class="number">04</span>:<span class="number">56.851616</span> +<span class="number">0800</span>	EmotionCounsel	éŸ³é¢‘æ‰“æ–­userInfo:&#123;</span><br><span class="line">    <span class="built_in">AVAudioSessionInterruptionOptionKey</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">AVAudioSessionInterruptionTypeKey</span> = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>éŸ³è§†é¢‘</category>
      </categories>
      <tags>
        <tag>éŸ³é¢‘æ‰“æ–­</tag>
      </tags>
  </entry>
  <entry>
    <title>iOS äº‹ä»¶åˆ†å‘ä¸æ‰‹åŠ¿è¯†åˆ«</title>
    <url>/2019/05/19/iOS%20%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E4%B8%8E%E6%89%8B%E5%8A%BF%E8%AF%86%E5%88%AB/</url>
    <content><![CDATA[<h3 id="iOS-äº‹ä»¶åˆ†å‘ä¸æ‰‹åŠ¿è¯†åˆ«"><a href="#iOS-äº‹ä»¶åˆ†å‘ä¸æ‰‹åŠ¿è¯†åˆ«" class="headerlink" title="iOS äº‹ä»¶åˆ†å‘ä¸æ‰‹åŠ¿è¯†åˆ«"></a>iOS äº‹ä»¶åˆ†å‘ä¸æ‰‹åŠ¿è¯†åˆ«</h3><p>åœ¨è®²äº‹ä»¶çš„åˆ†å‘ä¹‹å‰,æœ‰ä¸‰ä¸ªæ¦‚å¿µä¸å¾—ä¸æ:å“åº”è€…å¯¹è±¡, nextResponder, å“åº”è€…é“¾.</p>
<h4 id="å“åº”è€…å¯¹è±¡"><a href="#å“åº”è€…å¯¹è±¡" class="headerlink" title="å“åº”è€…å¯¹è±¡"></a>å“åº”è€…å¯¹è±¡</h4><p>åœ¨iOSç³»ç»Ÿä¸­ï¼Œèƒ½å¤Ÿå“åº”å¹¶å¤„ç†äº‹ä»¶çš„å¯¹è±¡ç§°ä¹‹ä¸ºresponder object, UIResponderæ˜¯æ‰€æœ‰responderå¯¹è±¡çš„åŸºç±»ã€‚<br>UIApplication,UIViewController,UIViewå’Œæ‰€æœ‰ç»§æ‰¿è‡ªUIViewçš„UIKitç±»(åŒ…æ‹¬UIWindow,ç»§æ‰¿è‡ªUIView)éƒ½ç›´æ¥æˆ–é—´æ¥çš„ç»§æ‰¿è‡ªUIResponder,æ‰€ä»¥å®ƒä»¬çš„å®ä¾‹éƒ½æ˜¯responder objectå¯¹è±¡ã€‚</p>
<h4 id="nextResponder"><a href="#nextResponder" class="headerlink" title="nextResponder"></a>nextResponder</h4><p>æœ‰UIResponderçš„æ–‡æ¡£å¦‚ä¸‹:</p>
<blockquote>
<p>The UIResponder class does not store or set the next responder automatically, so this method returns nil by default. Subclasses must override this method and return an appropriate next responder.</p>
</blockquote>
<p>UIResponderè‡ªèº«é»˜è®¤è¿”å›çš„æ˜¯nil.ä½†å­ç±»å¿…é¡»é‡å†™è¿™ä¸ªæ–¹æ³•å¹¶ä¸”è¿”å›ä¸€ä¸ªåˆé€‚çš„nextResponder.UIViewçš„é»˜è®¤å®ç°:é€šå¸¸æƒ…å†µä¸‹æ˜¯å®ƒçš„çˆ¶è§†å›¾,ä½†æ˜¯å¦‚æœviewæ˜¯ä½œä¸ºViewControllerçš„rootView,é‚£ä¹ˆå®ƒçš„nextResponderå°±æ˜¯ViewController. ViewControllerçš„é»˜è®¤å®ç°:è¿”å›å®ƒç®¡ç†çš„viewçš„çˆ¶è§†å›¾.</p>
<h4 id="å“åº”è€…é“¾"><a href="#å“åº”è€…é“¾" class="headerlink" title="å“åº”è€…é“¾"></a>å“åº”è€…é“¾</h4><p>appçš„è§†å›¾ç»“æ„æ˜¯ä¸€ä¸ªNå‰æ ‘(ä¸€ä¸ªè§†å›¾å¯ä»¥æœ‰å¤šä¸ªå­è§†å›¾ï¼Œä¸€ä¸ªå­è§†å›¾åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçˆ¶è§†å›¾),è€Œæ¯ä¸€ä¸ªç»§æ‰¿UIResponderçš„å¯¹è±¡éƒ½å¯ä»¥åœ¨è¿™ä¸ªNå‰æ ‘ä¸­æ‰®æ¼”ä¸€ä¸ªèŠ‚ç‚¹ã€‚å½“å¶èŠ‚ç‚¹æˆä¸ºç¬¬ä¸€å“åº”è€…çš„æ—¶å€™ï¼Œä»è¿™ä¸ªå¶èŠ‚ç‚¹å¼€å§‹å¾€å…¶çˆ¶èŠ‚ç‚¹å¼€å§‹è¿½æœ”å‡ºä¸€æ¡é“¾ï¼Œè¿™ä¸€æ¡é“¾å°±æ˜¯å½“å‰æ´»è·ƒçš„å“åº”è€…é“¾ã€‚</p>
<p>å“åº”è€…é“¾çš„é“¾å¤´æ˜¯å¶èŠ‚ç‚¹,é“¾å°¾æ˜¯UIApplication(å¦‚æœAppDelegateä¹Ÿç»§æ‰¿è‡ªUIResponsder,é‚£ä¹ˆUIApplicationä¼šå°†äº‹ä»¶ä»£ç†ç»™å®ƒ).</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)didTapped:(<span class="built_in">UIGestureRecognizer</span> *)sender &#123;</span><br><span class="line">    <span class="comment">//æ‹¿åˆ°ç¬¬ä¸€å“åº”è€…ï¼Œæ ¹æ®nextResponderå°±å¯ä»¥æ‹¿åˆ°æ•´ä¸ªå“åº”è€…é“¾ã€‚</span></span><br><span class="line">    <span class="built_in">UIResponder</span> *view = sender.view;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (view != <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;ç¬¬%dä¸ªï¼š%@&quot;</span>, i, view);</span><br><span class="line">        </span><br><span class="line">        i += <span class="number">1</span>;</span><br><span class="line">        view = view.nextResponder;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  é“¾å¤´</span><br><span class="line">ç¬¬ä¸€å“åº”è€…---&gt;xxx---&gt;xxx---...--&gt;<span class="built_in">UIWindow</span>---&gt;<span class="built_in">UIApplication</span>---&gt;AppDelegate(å¯èƒ½)</span><br></pre></td></tr></table></figure>
<p>ä»‹ç»å®Œè¿™ä¸ªä¸‰ä¸ªæ¦‚å¿µå,å¼€å§‹æ­£æ–‡.</p>
<h4 id="ç¬¬ä¸€å“åº”è€…çš„æŸ¥æ‰¾"><a href="#ç¬¬ä¸€å“åº”è€…çš„æŸ¥æ‰¾" class="headerlink" title="ç¬¬ä¸€å“åº”è€…çš„æŸ¥æ‰¾"></a>ç¬¬ä¸€å“åº”è€…çš„æŸ¥æ‰¾</h4><p>ç®€å•ç‚¹è®²å°±æ˜¯å½“å‰window(è¿™é‡ŒæŒ‡çš„æ˜¯keyWindow)ä¼šå¯¹å…¶ä¸Šçš„è§†å›¾è¿›è¡ŒhitTestæ£€æµ‹. hitTestæ–¹æ³•ä¼šè¿”å›ç¬¬ä¸€å“åº”è€….</p>
<p>å¤æ‚ç‚¹è®²å°±æ˜¯å‘ç”Ÿè§¦æ‘¸äº‹ä»¶åï¼Œç³»ç»Ÿä¼šå°†è¯¥äº‹ä»¶åŠ å…¥åˆ°ä¸€ä¸ªç”±UIApplicationç®¡ç†çš„äº‹ä»¶é˜Ÿåˆ—ä¸­.UIApplicationä¼šä»äº‹ä»¶é˜Ÿåˆ—ä¸­å–å‡ºæœ€å‰é¢çš„äº‹ä»¶ï¼Œå¹¶å°†äº‹ä»¶åˆ†å‘ä¸‹å»ä»¥ä¾¿å¤„ç†.é€šå¸¸,å…ˆå‘é€äº‹ä»¶ç»™åº”ç”¨ç¨‹åºçš„ä¸»çª—å£ï¼ˆkeyWindowï¼‰.ä¸»çª—å£ä¼šåœ¨è§†å›¾å±‚æ¬¡ç»“æ„ä¸­è¿›è¡ŒhitTestæ£€æµ‹æ¥æ‰¾åˆ°ä¸€ä¸ªæœ€åˆé€‚çš„è§†å›¾å¤„ç†è§¦æ‘¸äº‹ä»¶ï¼Œè¿™ä¹Ÿæ˜¯æ•´ä¸ªäº‹ä»¶å¤„ç†è¿‡ç¨‹çš„ç¬¬ä¸€æ­¥ã€‚æ‰¾åˆ°åˆé€‚çš„è§†å›¾æ§ä»¶åï¼Œå°±ä¼šè°ƒç”¨è§†å›¾æ§ä»¶çš„touchesæ–¹æ³•æ¥ä½œå…·ä½“çš„äº‹ä»¶å¤„ç†ã€‚</p>
<p>hitTestçš„ä¸€ç§å¯èƒ½å®ç°:</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">UIView</span> *)hitTest:(<span class="built_in">CGPoint</span>)point withEvent:(<span class="built_in">UIEvent</span> *)event</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//é¦–å…ˆåˆ¤æ–­æ˜¯å¦å¯ä»¥æ¥æ”¶äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.userInteractionEnabled == <span class="literal">NO</span> || <span class="keyword">self</span>.hidden == <span class="literal">YES</span> || <span class="keyword">self</span>.alpha &lt;= <span class="number">0.01</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">//ç„¶ååˆ¤æ–­è§¦æ‘¸ç‚¹æ˜¯å¦åœ¨å½“å‰è§†å›¾ä¸Š</span></span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span> pointInside:point withEvent:event] == <span class="literal">NO</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">//å¾ªç¯éå†æ‰€æœ‰å­è§†å›¾ï¼ŒæŸ¥æ‰¾æ˜¯å¦æœ‰æœ€åˆé€‚çš„è§†å›¾</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="keyword">self</span>.subviews.count - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="built_in">UIView</span> *childView = <span class="keyword">self</span>.subviews[i];</span><br><span class="line">        <span class="comment">//è½¬æ¢ç‚¹åˆ°å­è§†å›¾åæ ‡ç³»ä¸Š</span></span><br><span class="line">        <span class="built_in">CGPoint</span> childPoint = [<span class="keyword">self</span> convertPoint:point toView:childView];</span><br><span class="line">        <span class="comment">//é€’å½’æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨æœ€åˆé€‚çš„view</span></span><br><span class="line">        <span class="built_in">UIView</span> *fitView = [childView hitTest:childPoint withEvent:event];</span><br><span class="line">        <span class="comment">//å¦‚æœè¿”å›éç©ºï¼Œè¯´æ˜å­è§†å›¾ä¸­æ‰¾åˆ°äº†æœ€åˆé€‚çš„viewï¼Œé‚£ä¹ˆè¿”å›å®ƒ</span></span><br><span class="line">        <span class="keyword">if</span> (fitView) &#123;</span><br><span class="line">            <span class="keyword">return</span> fitView;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¾ªç¯ç»“æŸï¼Œä»æ—§æ²¡æœ‰åˆé€‚çš„å­è§†å›¾å¯ä»¥å¤„ç†äº‹ä»¶ï¼Œé‚£ä¹ˆå°±è®¤ä¸ºè‡ªå·±æ˜¯æœ€åˆé€‚çš„view</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>note:é‡å†™hitTestæ–¹æ³•è¦æ³¨æ„å¼€å§‹çš„ä¸‰ä¸ªæ¡ä»¶åˆ¤æ–­,å¦åˆ™å¯èƒ½ä¼šå‡ºä¸€äº›bug:æ¯”å¦‚é‡å†™buttonçš„hitTestæ–¹æ³•ä½†æ²¡æœ‰åŠ ä¸Šè¿°åˆ¤æ–­,å°±ä¼šå¯¼è‡´æ˜æ˜å·²ç»éšè—äº†button,ä½†å¦‚æœæ‘¸åˆ°äº†è¯¥button,é‚£ä¹ˆè¯¥buttonçš„target-actionæ–¹æ³•å°†ä¼šè¢«è°ƒç”¨,è¿™åº”è¯¥æ˜¯ä½ ä¸å¸Œæœ›çš„.</p>
<h4 id="è§¦æ‘¸äº‹ä»¶å¤„ç†çš„æ•´ä½“è¿‡ç¨‹"><a href="#è§¦æ‘¸äº‹ä»¶å¤„ç†çš„æ•´ä½“è¿‡ç¨‹" class="headerlink" title="è§¦æ‘¸äº‹ä»¶å¤„ç†çš„æ•´ä½“è¿‡ç¨‹"></a>è§¦æ‘¸äº‹ä»¶å¤„ç†çš„æ•´ä½“è¿‡ç¨‹</h4><ol>
<li><p>ç”¨æˆ·ç‚¹å‡»å±å¹•åäº§ç”Ÿä¸€ä¸ªè§¦æ‘¸äº‹ä»¶ï¼Œç»è¿‡ä¸€ç³»åˆ—çš„hitTestè¿‡ç¨‹åï¼Œä¼šæ‰¾åˆ°æœ€åˆé€‚çš„è§†å›¾æ§ä»¶æ¥å¤„ç†è¿™ä¸ªäº‹ä»¶</p>
</li>
<li><p>æ‰¾åˆ°æœ€åˆé€‚çš„è§†å›¾æ§ä»¶åï¼Œå°±ä¼šè°ƒç”¨æ§ä»¶çš„touchesæ–¹æ³•æ¥åšå…·ä½“çš„äº‹ä»¶å¤„ç†touchesBeganâ€¦touchesMovedâ€¦touchedEndedâ€¦</p>
</li>
<li><p>UIResponderçš„è¿™äº›touchesæ–¹æ³•çš„é»˜è®¤å®ç°æ˜¯å°†äº‹ä»¶é¡ºç€å“åº”è€…é“¾æ¡å‘ä¸Šä¼ é€’ï¼Œå°†äº‹ä»¶äº¤ç»™nextResponderè¿›è¡Œå¤„ç†ã€‚å¦‚æœæœ€ç»ˆéƒ½æ²¡æœ‰å“åº”è€…å¤„ç†ï¼Œè¯¥äº‹ä»¶å°±è¢«æŠ›å¼ƒã€‚(å¦‚æœä½ ä¸æƒ³å°†äº‹ä»¶äº¤ç»™nextResponderå¤„ç†,é‚£ä¹ˆåœ¨å¤„ç†äº‹ä»¶çš„æ—¶å€™ä¸è°ƒç”¨superå°±å¯ä»¥äº†,äº‹ä»¶çš„å¤„ç†åˆ°è¿™ä¸ªèŠ‚ç‚¹ä¹Ÿå°±ç»“æŸäº†)</p>
</li>
</ol>
<blockquote>
<p>note:åœ¨å®šåˆ¶UIViewå­ç±»çš„ä¸Šè¿°äº‹ä»¶å¤„ç†æ–¹æ³•æ—¶ï¼Œå¦‚æœéœ€è¦å°†äº‹ä»¶ä¼ é€’ç»™next responder,å¯ä»¥ç›´æ¥è°ƒç”¨superçš„å¯¹åº”äº‹ä»¶å¤„ç†æ–¹æ³•ï¼Œè¿™æ ·äº‹ä»¶å°†ä¼šä¼ é€’ç»™next responder,å³ä½¿ç”¨<br><code>[super touchesBegan:touches withEvent:event];</code><br>ä¸å»ºè®®ç›´æ¥å‘nextResponderå‘é€æ¶ˆæ¯ï¼Œè¿™æ ·å¯èƒ½ä¼šæ¼æ‰çˆ¶ç±»å¯¹è¿™ä¸€äº‹ä»¶çš„å…¶ä»–å¤„ç†ã€‚<br><code>[self.nextResponder touchesBegan:touches withEvent:event];</code></p>
<p>ä¸ºä»€ä¹ˆè°ƒç”¨superï¼ŒnextResponderä¼šæ”¶åˆ°touchæ¶ˆæ¯ï¼Ÿsuperçš„æ„æ€æ˜¯è°ƒç”¨çˆ¶ç±»çš„å®ç°ï¼Œç½‘ä¸Šçš„ä¸€ç§è¯´æ³•æ˜¯UIViewçš„touchæ–¹æ³•å®ç°ä¼šå°†touchäº‹ä»¶è½¬å‘ç»™nextResponderã€‚</p>
</blockquote>
<p>çˆ¶è§†å›¾UIViewä¸Šæœ‰ä¸€ä¸ªæŒ‰é’®UIButtonï¼Œç‚¹å‡»btnï¼Œçˆ¶è§†å›¾ä¸Šçš„touchesç³»åˆ—æ–¹æ³•æ˜¯ä¸ä¼šè°ƒç”¨çš„ï¼Œè¯´æ˜UIButtonå¤„ç†äº‹ä»¶åæ²¡æœ‰è°ƒç”¨superã€‚</p>
<h4 id="æ‰‹åŠ¿è¯†åˆ«"><a href="#æ‰‹åŠ¿è¯†åˆ«" class="headerlink" title="æ‰‹åŠ¿è¯†åˆ«"></a>æ‰‹åŠ¿è¯†åˆ«</h4><p>æœ‰æ–‡æ¡£æ›°:</p>
<blockquote>
<p>Gesture recognizers receive touch and press events before their view does. If a viewâ€™s gesture recognizers fail to recognize a sequence of touches, UIKit sends the touches to the view. If the view does not handle the touches, UIKit passes them up the responder chain. For more information about using gesture recognizerâ€™s to handle events, see Handling UIKit Gestures.</p>
</blockquote>
<p>åˆæœ‰<a href="https://developer.apple.com/documentation/uikit/uigesturerecognizer">UIGestureRecognizer</a>æ–‡æ¡£æ›°:</p>
<blockquote>
<p>A window delivers touch events to a gesture recognizer before it delivers them to the hit-tested view attached to the gesture recognizer. Generally, if a gesture recognizer analyzes the stream of touches in a multi-touch sequence and doesnâ€™t recognize its gesture, the view receives the full complement of touches. If a gesture recognizer recognizes its gesture, the remaining touches for the view are cancelled.</p>
</blockquote>
<p>å­—é‡Œè¡Œé—´é€éœ²ç€ä¸€å¥è¯ï¼šæ‰‹åŠ¿è¯†åˆ«å™¨æ‹¥æœ‰ä¼˜å…ˆå¤„ç†äº‹ä»¶çš„æƒåˆ©ã€‚</p>
<p>æ‰‹åŠ¿è¯†åˆ«çš„è¿‡ç¨‹åŸºæœ¬ä¸Šæ˜¯è¿™æ ·å­çš„ï¼šå½“æ‰¾åˆ°ç¬¬ä¸€å“åº”è€…viewåï¼Œwindowä¼šå…ˆè®©viewä¸Šçš„æ‰‹åŠ¿è¯†åˆ«å™¨å¤„ç†äº‹ä»¶ï¼Œå½“viewä¸Šçš„æ‰‹åŠ¿è¯†åˆ«å™¨è¯†åˆ«å¤±è´¥åï¼Œviewæ‰ä¼šæ¥æ”¶åˆ°å…¨éƒ¨çš„touchã€‚å¦åˆ™å¦‚æœæ‰‹åŠ¿è¯†åˆ«æˆåŠŸï¼Œviewå°†æ”¶åˆ°touchCancelå›è°ƒã€‚<strong>ä¸æ­¤åŒæ—¶</strong>ï¼ˆæ˜¯å¦åŒæ—¶ä¸å¤ªç¡®å®šï¼‰ç³»ç»Ÿä¹Ÿä¼šæ²¿ç€å“åº”è€…é“¾è®©æ‰€æœ‰é“¾ä¸Šçš„responderä¸Šçš„æ‰‹åŠ¿è¯†åˆ«å™¨å¤„ç†äº‹ä»¶,å¦‚æœå…¶ä¸­æŸä¸ªæ‰‹åŠ¿è¯†åˆ«å™¨è¯†åˆ«æˆåŠŸ,é‚£ä¹ˆç¬¬ä¸€å“åº”è€…å°†æ”¶åˆ°touchCancelå›è°ƒ.ä¸åŒresponderä¸Šçš„æ‰‹åŠ¿è¯†åˆ«å™¨å¯èƒ½ä¼šåŒæ—¶è¯†åˆ«æˆåŠŸ.è€Œ<code>shouldRecognizeSimultaneouslyWithGestureRecognizer</code>ä»£ç†æ–¹æ³•é»˜è®¤è¿”å›false.å› æ­¤é»˜è®¤æƒ…å†µä¸‹æœ€ç»ˆåªä¼šæœ‰ä¸€ä¸ªè¯†åˆ«æˆåŠŸ,å³å“åº”è€…é“¾ä¸Šæœ€å‰é¢çš„responderä¸Šçš„æ‰‹åŠ¿çš„actionæ–¹æ³•è¢«è°ƒç”¨.</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚ä¸‹å›¾ï¼šXQView0_1ä¸Šæ·»åŠ tapæ‰‹åŠ¿ï¼ŒXQView0_1_0çš„touchç³»åˆ—æ–¹æ³•ä¸è°ƒç”¨superï¼Œç‚¹å‡»XQView0_1_0ã€‚</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/D82CF040-A5D9-4113-8ED7-97040B67CB6A.png" alt=""></p>
<p>æ‰“å°ï¼š</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">2023</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">56</span>:<span class="number">06</span>.<span class="number">719888</span>+<span class="number">0800</span> ResponderChainDemo[<span class="number">26161</span>:<span class="number">2476848</span>] touchesBegan:&lt;XQView0_1_0: <span class="number">0</span>x129b1d340; frame = (<span class="number">20</span> <span class="number">19</span>.<span class="number">6667</span>; <span class="number">35</span> <span class="number">35</span>); autoresize = RM+BM; backgroundColor = &lt;UIDynamicModifiedColor: <span class="number">0</span>x60000274de30; contrast = normal, baseColor = &lt;UIDynamicCatalogSystemColor: <span class="number">0</span>x600003c71100; name = systemTealColor&gt;&gt;; layer = &lt;CALayer: <span class="number">0</span>x6000029aba00&gt;&gt;</span><br><span class="line"><span class="attribute">2023</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">56</span>:<span class="number">06</span>.<span class="number">720824</span>+<span class="number">0800</span> ResponderChainDemo[<span class="number">26161</span>:<span class="number">2476848</span>] didTapped</span><br><span class="line"><span class="attribute">2023</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">56</span>:<span class="number">06</span>.<span class="number">721124</span>+<span class="number">0800</span> ResponderChainDemo[<span class="number">26161</span>:<span class="number">2476848</span>] touchesCancelled:&lt;XQView0_1_0: <span class="number">0</span>x129b1d340; frame = (<span class="number">20</span> <span class="number">19</span>.<span class="number">6667</span>; <span class="number">35</span> <span class="number">35</span>); autoresize = RM+BM; backgroundColor = &lt;UIDynamicModifiedColor: <span class="number">0</span>x60000274de30; contrast = normal, baseColor = &lt;UIDynamicCatalogSystemColor: <span class="number">0</span>x600003c71100; name = systemTealColor&gt;&gt;; layer = &lt;CALayer: <span class="number">0</span>x6000029aba00&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå³ä½¿XQView0_1_0ä¸è°ƒç”¨superï¼ŒXQView0_1ä¸Šçš„æ‰‹åŠ¿ä¹Ÿèƒ½è¯†åˆ«æˆåŠŸï¼Œå¹¶ä¸”è¯†åˆ«æˆåŠŸåXQView0_1_0æ”¶åˆ°touchesCancelledæ¶ˆæ¯ã€‚</p>
<p>çŒœæƒ³å®ç°ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UIResponder</span> *firstResponderView = a;</span><br><span class="line"><span class="built_in">NSArray</span> *responders = @[a, b, c, ..., <span class="built_in">UIWindow</span>, <span class="built_in">UIApplication</span>, AppDelegate];</span><br><span class="line"></span><br><span class="line">firstResponderView.touchBegin</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿›è¡Œæ‰‹åŠ¿è¯†åˆ«</span></span><br><span class="line"><span class="type">BOOL</span> hasRec = <span class="literal">NO</span>;</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> responders &#123;</span><br><span class="line">    item.gestureRecognizers å¼€å§‹è¯†åˆ«æ‰‹åŠ¿</span><br><span class="line">    <span class="keyword">if</span> è¯†åˆ«æˆåŠŸ &#123;</span><br><span class="line">        hasRec = <span class="literal">YES</span>;</span><br><span class="line">        è°ƒç”¨gesçš„target-actionæ–¹æ³•ã€‚</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> hasRec &#123;</span><br><span class="line">    firstResponderView.touchCancelled</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//å°†touchäº‹ä»¶å…¨éƒ¨äº¤ç»™firstResponderViewå¤„ç†ã€‚</span></span><br><span class="line">    firstResponderView.touchMoved</span><br><span class="line">    firstResponderView.touchEnd</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UIWindowçš„æ´¾å‘äº‹ä»¶æ–¹æ³•:</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)sendEvent:(UIEvent *)event;                    // <span class="keyword">called</span> <span class="keyword">by</span> UIApplication <span class="keyword">to</span> dispatch events <span class="keyword">to</span> views inside the <span class="keyword">window</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœç¬¬ä¸€å“åº”è€…æ˜¯UIControl,æƒ…å†µä¼šæœ‰æ‰€ä¸åŒ.</p>
<p>æœ‰<a href="https://developer.apple.com/documentation/uikit/uicontrol">UIControl</a>çš„æ–‡æ¡£å¦‚ä¸‹:</p>
<blockquote>
<p>The target object can be any object, but it is typically the view controller whose root view contains the control. <strong>If you specify nil for the target object, the control searches the responder chain for an object that defines the specified action method.</strong></p>
</blockquote>
<p>å½“ä½ æŒ‡å®štargetä¸ºnilçš„æ—¶å€™,ç³»ç»Ÿä¼šæ²¿ç€å“åº”è€…é“¾å¯»æ‰¾ä¸€ä¸ªå®ç°äº†actionæ–¹æ³•çš„å“åº”è€…å¯¹è±¡å¹¶è°ƒç”¨actionæ–¹æ³•.ä¸Šé¢è¯´åˆ°æ‰‹åŠ¿è¯†åˆ«å™¨è¯†åˆ«æˆåŠŸå,å“åº”è€…é“¾ä¸Šçš„viewå°†æ”¶åˆ°touchCancelå›è°ƒ.è¿™é‡Œå°±æœ‰å†²çªäº†.æœ€ç»ˆçš„ç»“æœå°±æ˜¯nextResponderä¸Šçš„æ‰‹åŠ¿è¯†åˆ«å™¨(cancelsTouchesInView = true,å°±æ˜¯é‚£ç§è‡ªå·±å¤„ç†å®Œåä¸è®©viewå¤„ç†çš„è¯†åˆ«å™¨)å°†ä¸å¤„ç†, æ‰€æœ‰touchç”±UIControlå¤„ç†,å¤„ç†å®Œåè°ƒç”¨actionæ–¹æ³•.</p>
<p>æ¯”å¦‚:çˆ¶viewä¸Šæ·»åŠ tapæ‰‹åŠ¿,çˆ¶viewä¸Šæ·»åŠ ä¸€ä¸ªUIButton.ç‚¹å‡»button,å“åº”çš„æ˜¯buttonçš„target-action,è€Œä¸æ˜¯tapçš„target-action.å¦‚æœçˆ¶viewä¸Šçš„tap cancelsTouchesInView = false,åˆ™ä¸¤è€…éƒ½ä¼šè¢«è°ƒç”¨.</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://juejin.im/post/5d396ef7518825453b605afa">æ·±å…¥ç†è§£ iOS äº‹ä»¶æœºåˆ¶</a>   TODOï¼šè·Ÿç€ä½œè€…çš„demoåšä¸€éï¼ŒåŠ æ·±ç†è§£</p>
<p><a href="https://www.jianshu.com/p/74a2f44840fa">iOSäº‹ä»¶åˆ†å‘æœºåˆ¶ä¸å®è·µ</a></p>
<p><a href="https://www.jianshu.com/p/ef33cc31a614">iOSå“åº”è€…é“¾ã€äº‹ä»¶çš„ä¼ é€’</a></p>
<p><a href="https://www.jianshu.com/p/77139b374313">è¯¦è§£iOSè§¦æ‘¸äº‹ä»¶ä¸æ‰‹åŠ¿è¯†åˆ«</a></p>
<p><a href="https://blog.csdn.net/zhoupengju/article/details/52250135">iOSäº‹ä»¶å“åº”è€…é“¾ä¹‹è¢«å¿½è§†çš„æ‰‹åŠ¿è¯†åˆ«å™¨å·¥ä½œåŸç†</a>  ä½œè€…çš„æ€è€ƒæŒºæœ‰æ„æ€çš„</p>
<p>å®˜æ–¹æ–‡æ¡£ï¼š</p>
<p><a href="https://developer.apple.com/documentation/uikit/uigesturerecognizer">UIGestureRecognizer</a></p>
<p><a href="https://developer.apple.com/documentation/uikit/touches_presses_and_gestures/using_responders_and_the_responder_chain_to_handle_events">Using Responders and the Responder Chain to Handle Events</a></p>
<p><a href="https://developer.apple.com/documentation/uikit/uiresponder/1621099-nextresponder?language=objc">nextResponder</a></p>
<p><a href="https://developer.apple.com/documentation/uikit/touches_presses_and_gestures/implementing_a_custom_gesture_recognizer/about_the_gesture_recognizer_state_machine">About the Gesture Recognizer State Machine</a>  è®²è§£æ‰‹åŠ¿è¯†åˆ«å™¨çŠ¶æ€æœºçš„ã€‚å¦‚æœè¦å®ç°è‡ªå®šä¹‰çš„æ‰‹åŠ¿è¯†åˆ«å™¨å»ºè®®çœ‹çœ‹ã€‚</p>
]]></content>
      <categories>
        <category>UIKit</category>
      </categories>
      <tags>
        <tag>UIResponder</tag>
        <tag>äº‹ä»¶åˆ†å‘</tag>
        <tag>æ‰‹åŠ¿è¯†åˆ«</tag>
      </tags>
  </entry>
  <entry>
    <title>ç†è§£OCä¸­çš„SELã€IMPã€Method</title>
    <url>/2019/05/04/%E7%90%86%E8%A7%A3OC%E4%B8%AD%E7%9A%84SEL%E3%80%81IMP%E3%80%81Method/</url>
    <content><![CDATA[<h4 id="SEL"><a href="#SEL" class="headerlink" title="SEL"></a>SEL</h4><p>Defines an opaque type that represents a method selector.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">objc_selector</span> *SEL;</span><br></pre></td></tr></table></figure>
<p>SELæ˜¯ä¸€ç§æ•°æ®ç±»å‹,ä»£è¡¨ä¸€ä¸ªæ–¹æ³•é€‰æ‹©å™¨(è¦æ˜¯è§‰å¾—ä¸å¥½ç†è§£,å¯ä»¥ç±»æ¯”ä¸€ä¸‹int,intæ˜¯æ•´å‹ç±»å‹,ä»£è¡¨ä¸€ä¸ªæ•´æ•°).æ–¹æ³•é€‰æ‹©å™¨å°±æ˜¯è¿è¡Œæ—¶ä¸­æ–¹æ³•çš„åç§°,å®ƒæ˜¯ä¸€ä¸ªæ³¨å†Œåˆ°(æˆ–æ˜ å°„åˆ°)Objective-Cè¿è¡Œæ—¶é‡Œçš„ä¸€ä¸ªCå­—ç¬¦ä¸².é€‰æ‹©å™¨ç”±ç¼–è¯‘å™¨ç”Ÿæˆ,åœ¨ç³»ç»ŸåŠ è½½ç±»çš„æ—¶å€™ç”±runtimeè‡ªåŠ¨è¿›è¡Œæ˜ å°„.</p>
<p>æŒ‰ç…§æ–‡æ¡£è¯´æ˜,é€‰æ‹©å™¨æ˜¯åœ¨ç¼–è¯‘æœŸé—´ç”Ÿæˆçš„,åœ¨åŠ è½½ç±»çš„æ—¶å€™æ˜ å°„ä¸ºruntimeä¸­çš„ä¸€ä¸ªCå­—ç¬¦ä¸².</p>
<p>ç»™å¯¹è±¡å‘é€ä¸€æ¡æ¶ˆæ¯<code>[obj xxxMethod];</code>,å…¶å®æ˜¯è°ƒç”¨äº†<code>objc_msgSend(obj, @selector(xxxMethod));</code>.</p>
<p><code>objc_msgSend</code>çš„å£°æ˜å¦‚ä¸‹:<br><code>OBJC_EXPORT id _Nullable
objc_msgSend(id _Nullable self, SEL _Nonnull op, ...);</code><br>å®ƒçš„ç¬¬äºŒä¸ªå‚æ•°çš„ç±»å‹å°±æ˜¯SEL.è¯´æ˜å®ƒæ˜¯çœŸå®å­˜åœ¨çš„.</p>
<p>ç›¸å…³çš„API:</p>
<figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å‘runtime systemæ³¨å†Œä¸€ä¸ªæ–¹æ³•åã€‚å¦‚æœæ–¹æ³•åå·²ç»æ³¨å†Œï¼Œåˆ™è¿”å›å·²ç»æ³¨å†Œçš„SEL</span></span><br><span class="line">SEL sel_registerName(<span class="keyword">const</span> char *str)</span><br><span class="line"></span><br><span class="line"><span class="comment">//åŠŸèƒ½åŒä¸Š</span></span><br><span class="line">SEL sel_getUid(<span class="keyword">const</span> char *str)</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨OCç¼–è¯‘å™¨æŒ‡ä»¤.åŠŸèƒ½åŒä¸Š,ä¹Ÿæ˜¯å‘runtime systemæ³¨å†Œä¸€ä¸ªæ–¹æ³•å.</span></span><br><span class="line">@<span class="keyword">selector</span>(&lt;#<span class="keyword">selector</span>#&gt;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨OCå­—ç¬¦ä¸²æ„é€ .åŠŸèƒ½åŒä¸Š</span></span><br><span class="line">SEL NSSelectorFromString(NSString *aSelectorName)</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ ¹æ®Methodç»“æ„ä½“è·å–</span></span><br><span class="line">SEL _Nonnull method_getName(<span class="keyword">Method</span> _<span class="title function_">Nonnull</span> <span class="title function_">m</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¯”è¾ƒä¸¤ä¸ªé€‰æ‹©å™¨</span></span><br><span class="line">BOOL sel_isEqual ( SEL lhs, SEL rhs )<span class="punctuation">;</span></span><br><span class="line"><span class="comment">//åˆ¤æ–­æ–¹æ³•åæ˜¯å¦æ˜ å°„åˆ°æŸä¸ªå‡½æ•°å®ç°ä¸Š</span></span><br><span class="line">BOOL sel_isMapped(SEL sel)<span class="punctuation">;</span></span><br></pre></td></tr></table></figure>
<p>eg:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">SEL</span> <span class="variable">hasBookSEL</span> <span class="operator">=</span> <span class="meta">@selector(hasBook:)</span>; <span class="comment">//hasBook:æ˜¯Personç±»çš„ä¸€ä¸ªå®ä¾‹æ–¹æ³•.</span></span><br><span class="line"><span class="comment">//sel_getName:hasBook:, p:0x10c230538</span></span><br><span class="line">NSLog(@<span class="string">&quot;sel_getName:%s, p:%p&quot;</span>, sel_getName(hasBookSEL), hasBookSEL);</span><br><span class="line"></span><br><span class="line"><span class="type">SEL</span> <span class="variable">sel0</span> <span class="operator">=</span> sel_registerName(<span class="string">&quot;myRegisterName&quot;</span>);</span><br><span class="line"><span class="type">SEL</span> <span class="variable">sel1</span> <span class="operator">=</span> sel_getUid(<span class="string">&quot;myGetUid&quot;</span>);</span><br><span class="line"><span class="type">SEL</span> <span class="variable">sel2</span> <span class="operator">=</span> <span class="meta">@selector(hello:)</span>;</span><br><span class="line"><span class="type">SEL</span> <span class="variable">sel3</span> <span class="operator">=</span> NSSelectorFromString(@<span class="string">&quot;mySelectorFromString&quot;</span>); </span><br><span class="line"><span class="comment">//sel0:0x10c232634, sel1:0x10c232643, sel2:0x10c7be0eb, sel3:0x600003e78500.</span></span><br><span class="line">NSLog(@<span class="string">&quot;sel0:%p, sel1:%p, sel2:%p, sel3:%p&quot;</span>, sel0, sel1, sel2, sel3);</span><br><span class="line"><span class="keyword">if</span> (sel_isMapped(sel2)) &#123; <span class="comment">//éƒ½æ˜¯true</span></span><br><span class="line">    NSLog(@<span class="string">&quot;å·²ç»æ˜ å°„&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‰ä¸‰ç§æ–¹å¼å¾—åˆ°çš„selåœ°å€ç›¸å·®ä¸å¤§,ä½†ä½¿ç”¨<code>NSSelectorFromString()</code>å¾—åˆ°çš„selåœ°å€å´ç›¸å·®å¾ˆå¤§.å¯èƒ½çš„åŸå› æ˜¯å‰ä¸‰ç§æ˜¯åœ¨ç¼–è¯‘æœŸé—´ç”Ÿæˆçš„.è€Œä½¿ç”¨<code>NSSelectorFromString()</code>å¾—åˆ°çš„selæ˜¯åœ¨è¿è¡Œæ—¶æ‰ç”Ÿæˆ(å¾…éªŒè¯).</p>
<p>ä¸Šè¿°ä»£ç åªæ˜¯å‘runtimeæ³¨å†Œäº†æ–¹æ³•å,å¹¶æ²¡æœ‰å…³è”ä¸€ä¸ªç‰©ç†çš„å‡½æ•°å®ç°(IMP).æ‰€ä»¥ä¸è¦çœ‹åˆ°ä¸€ä¸ªé€‰æ‹©å™¨å°±è§‰å¾—ä¸€å®šæœ‰ä¸€ä¸ªå¯¹åº”çš„ç‰©ç†å‡½æ•°å®ç°.é€‰æ‹©å­SELå’Œç‰©ç†å‡½æ•°å®ç°IMPå®é™…ä¸Šæ˜¯ç›¸äº’ç‹¬ç«‹çš„,è¿™ç»™OCçš„åŠ¨æ€æ€§æä¾›äº†åŸºç¡€.</p>
<p>æˆ‘ä»¬éƒ½çŸ¥é“ä¸€æ¡æˆåŠŸçš„æ¶ˆæ¯å‘é€æœ€ç»ˆæ˜¯è¦è°ƒåˆ°ä¸€ä¸ªç‰©ç†å‡½æ•°çš„,å› æ­¤æ¶ˆæ¯å‘é€çš„è¿‡ç¨‹å°±æ˜¯runtimeæ ¹æ®é€‰æ‹©å­SELæ‰¾ç‰©ç†å‡½æ•°å®ç°IMPçš„è¿‡ç¨‹.åœ¨æ¶ˆæ¯å‘é€çš„è¿‡ç¨‹ä¸­å½“ä¸€ä¸ªé€‰æ‹©å­æœ€ç»ˆæ— æ³•æ‰¾åˆ°ä¸€ä¸ªå¯¹åº”çš„IMPæ—¶,ç³»ç»Ÿå°±ä¼šæŠ›å‡ºè‘—åçš„<code>unrecognized selector sent to instance</code>å´©æºƒ.</p>
<p>è¿™å°±å¼•å‡ºäº†ä¸€ä¸ªé—®é¢˜,æ€ä¹ˆé€šè¿‡ä¸€ä¸ªSELæ‰¾åˆ°ä¸€ä¸ªIMP?è¿™ä¸ªæ—¶å€™å°±éœ€è¦æŸ¥çœ‹ç±»çš„ç»“æ„ä½“<code>struct objc_class</code>çš„æ„æˆäº†,å¦‚ä¸‹:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">objc_class</span> &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !__OBJC2__</span></span><br><span class="line">    Class _Nullable super_class                              OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> * _Nonnull name                               OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="type">long</span> version                                             OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="type">long</span> info                                                OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="type">long</span> instance_size                                       OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">objc_ivar_list</span> * _Nullable ivars                  OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">objc_method_list</span> * _Nullable * _Nullable methodLists                    OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">objc_cache</span> * _Nonnull cache                       OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">objc_protocol_list</span> * _Nullable protocols          OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125; OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="comment">/* Use `Class` instead of `struct objc_class *` */</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°å®ƒé‡Œé¢æœ‰ä¸€ä¸ª<code>struct objc_method_list * _Nullable * _Nullable methodLists</code>æ–¹æ³•åˆ—è¡¨çš„æˆå‘˜å˜é‡,ç»§ç»­æŸ¥çœ‹æ–¹æ³•åˆ—è¡¨ç»“æ„ä½“,å¦‚ä¸‹:</p>
<figure class="highlight gauss"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="type">objc_method</span> &#123;</span><br><span class="line">    SEL _Nonnull method_name                                 OBJC2_UNAVAILABLE;</span><br><span class="line">    char * _Nullable method_types                            OBJC2_UNAVAILABLE;</span><br><span class="line">    IMP _Nonnull method_imp                                  OBJC2_UNAVAILABLE;</span><br><span class="line">&#125;                                                            OBJC2_UNAVAILABLE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="type">objc_method_list</span> &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="type">objc_method_list</span> * _Nullable obsolete             OBJC2_UNAVAILABLE;</span><br><span class="line"></span><br><span class="line">    int method_count                                         OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __LP64__</span></span><br><span class="line">    int space                                                OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* variable length structure */</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="type">objc_method</span> method_list[<span class="number">1</span>]                        OBJC2_UNAVAILABLE;</span><br><span class="line">&#125;                                                            OBJC2_UNAVAILABLE;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ç»ˆäºçœ‹åˆ°äº†ä¸€ä¸ª<code>struct objc_method</code>çš„ç»“æ„ä½“,è¿™å°±æ˜¯åé¢è¦è¯´åˆ°çš„Methodç±»å‹.çœ‹åˆ°Methodç±»å‹çš„æˆå‘˜å˜é‡æˆ‘ä»¬å°±çŸ¥é“OCè¯­è¨€çš„è®¾è®¡è€…æ˜¯æ€ä¹ˆçœ‹å¾…åœ¨.mæ–‡ä»¶ä¸­å†™çš„é‚£ä¸€ä¸ªä¸ªç‰©ç†å‡½æ•°äº†:</p>
<p>ä¸€ä¸ªç‰©ç†å‡½æ•°={é€‰æ‹©å­(æ–¹æ³•å)+æ–¹æ³•ç±»å‹(å°†è¿”å›å€¼ç±»å‹,å‚æ•°ç±»å‹ç¼–ç åçš„ä¸€ä¸ªCå­—ç¬¦ä¸²)+å‡½æ•°æŒ‡é’ˆIMP}=ä¸€ä¸ªMethodå®ä¾‹.</p>
<p>ç”±ä¸Šå¯çŸ¥,ä¸€ä¸ªç±»æ‹¥æœ‰ä¸€ä¸ªæ–¹æ³•åˆ—è¡¨,ç»™ç±»çš„å®ä¾‹å‘é€ä¸€æ¡æ¶ˆæ¯çš„è¿‡ç¨‹ç®€å•ç‚¹è®²å°±æ˜¯æ ¹æ®è¯¥æ¶ˆæ¯é€‰æ‹©å­åœ¨æ–¹æ³•åˆ—è¡¨é‡Œæ‰¾å¯¹åº”çš„Method,æ‰¾åˆ°äº†å°±è°ƒç”¨Methodå®ä¾‹é‡Œçš„IMP,æ‰§è¡Œå‡½æ•°å°±å®Œäº‹äº†.å½“ç„¶å®é™…æƒ…å†µè¦ç¨å¾®å¤æ‚äº›:å¦‚æœåœ¨è‡ªèº«ç±»é‡Œæ²¡æ‰¾åˆ°ä¼šç»§ç»­æ²¿ç€ç»§æ‰¿é“¾å¾€ä¸Šæ‰¾,æœ€åå¯èƒ½è¿˜ä¼šè¿›å…¥æ¶ˆæ¯è½¬å‘.è¿™é‡Œå°±ä¸å±•å¼€è®²äº†,ç½‘ä¸Šæœ‰å¾ˆå¤š.</p>
<p>ç»™ç±»åŠ¨æ€çš„æ·»åŠ ä¸€ä¸ªæ–¹æ³•:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)viewDidLoad &#123;</span><br><span class="line">	<span class="type">BOOL</span> rs = class_addMethod(Person.class, sel2, (IMP)hello, <span class="string">&quot;B@:@&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (rs) &#123;</span><br><span class="line">	    <span class="built_in">NSLog</span>(<span class="string">@&quot;æ·»åŠ æ–¹æ³•æˆåŠŸ&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	Person *p = [Person new];</span><br><span class="line">	[p performSelector:sel2 withObject:<span class="string">@&quot;å°æ˜&quot;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">BOOL</span> hello(<span class="type">id</span> <span class="keyword">self</span>, SEL _cmd, <span class="built_in">NSString</span> *name) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@, hello:%@&quot;</span>, <span class="keyword">self</span>, name);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="IMP"><a href="#IMP" class="headerlink" title="IMP"></a>IMP</h4><p>A pointer to the function of a method implementation.</p>
<figure class="highlight elm"><table><tr><td class="code"><pre><span class="line">typedef id _Nullable (*<span class="type">IMP</span>)(id _Nonnull, <span class="type">SEL</span> _Nonnull, ...); </span><br></pre></td></tr></table></figure>
<p>IMPæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ,æŒ‡å‘æ–¹æ³•å®ç°çš„å…·ä½“å‡½æ•°é¦–åœ°å€.</p>
<p>eg:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">IMP imp0 = class_getMethodImplementation(Person.class, <span class="keyword">@selector</span>(hasBook:));</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;%p&quot;</span>, imp0);</span><br><span class="line">    </span><br><span class="line">Method method = class_getInstanceMethod(Person.class, <span class="keyword">@selector</span>(hasBook:));</span><br><span class="line">IMP imp1 = method_getImplementation(method);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;%p&quot;</span>, imp1);</span><br><span class="line">    </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 1. éœ€è¦å°†Enable Strict Checking of objc_msgSend Calls è®¾ç½®ä¸ºNO</span></span><br><span class="line"><span class="comment"> 2. å¿…é¡»å°†imp1ç±»å‹å¼ºè½¬åå†è°ƒç”¨.</span></span><br><span class="line"><span class="comment"> id rs1 = imp1([Person new], @selector(hasBook:), @&quot;wind&quot;);</span></span><br><span class="line"><span class="comment"> ä¼šå¯¼è‡´å´©æºƒ:Thread 1: EXC_BAD_ACCESS (code=1, address=0x7d8)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> é€šè¿‡IMPç›´æ¥è°ƒç”¨å‡½æ•°.è¿™é‡Œä¼ å…¥äº†ä»€ä¹ˆSELå½¢å‚å€¼,é‚£ä¹ˆæ‰§è¡Œçš„å‡½æ•°è¯»å–_cmdçš„å€¼å°±æ˜¯ä»€ä¹ˆ.ç”šè‡³å¯ä»¥ä¼ NULL,ä½†æœ€å¥½è¿˜æ˜¯ä¼ åŸå§‹æ–¹æ³•é€‰æ‹©å™¨.</span></span><br><span class="line"><span class="comment"> imp1æ˜¯å’ŒPersonç±»ç›¸å…³è”çš„.å› æ­¤ç¬¬0ä¸ªå‚æ•°ä¼ Personç±»å‹å¯¹è±¡,ç¬¬1ä¸ªå‚æ•°ä¼ Personé‡Œçš„æ–¹æ³•,æ‰æœ‰æ„ä¹‰.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">BOOL</span> rs = ((<span class="type">BOOL</span> (*)(<span class="type">id</span>, SEL, <span class="built_in">NSString</span> *))imp1)([Person new], <span class="keyword">@selector</span>(hasBook:), <span class="string">@&quot;Gone with the wind&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (rs) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;has book: Gone with the wind&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;not found book:Gone with the wind&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> ä½¿ç”¨imp_implementationWithBlock()ç”Ÿæˆä¸€ä¸ªIMP,å¹¶è°ƒç”¨IMP.ç”±äºimp2æ˜¯é€šè¿‡imp_implementationWithBlock()å‡½æ•°å¾—æ¥å’Œä¸Šé¢çš„imp0çš„äº§ç”Ÿæ–¹å¼å®Œå…¨ä¸åŒ,å› æ­¤imp2å¹¶ä¸å’Œä»»ä½•ç±»æœ‰å•¥å…³è”,æ•…å®ƒçš„å‰ä¸¤ä¸ªå‚æ•°åŸºæœ¬ä¸Šå¯ä»»æ„ä¼ .</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">IMP imp2 = imp_implementationWithBlock(^<span class="type">BOOL</span>(<span class="type">id</span> object, <span class="built_in">NSString</span> *arg) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;object:%@, arg:%@&quot;</span>, object, arg);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="type">BOOL</span> rss = ((<span class="type">BOOL</span> (*)(<span class="type">id</span>, SEL, <span class="built_in">NSString</span> *))imp2)([Person new], <span class="keyword">@selector</span>(placeholderSEL:), <span class="string">@&quot;Gone with the wind&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (rss) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;has book: Gone with the wind&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;not found book:Gone with the wind&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">rss = [Person.new hasBook:<span class="string">@&quot;Gone with the wind&quot;</span>];</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡IMPç›´æ¥è°ƒç”¨å¯¹åº”å‡½æ•°,éœ€è¦æ³¨æ„ä¸¤ç‚¹:</p>
<ol>
<li>éœ€è¦å°†Enable Strict Checking of objc_msgSend Calls è®¾ç½®ä¸ºNO</li>
<li>å¿…é¡»å°†IMPç±»å‹å¼ºè½¬åå†è°ƒç”¨.å¦åˆ™ä¼šå¯¼è‡´å´©æºƒ:<code>Thread 1: EXC_BAD_ACCESS (code=1, address=0x7d8)</code></li>
</ol>
<h4 id="Method"><a href="#Method" class="headerlink" title="Method"></a>Method</h4><figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line"><span class="comment">/// An opaque type that represents a method in a class definition.</span></span><br><span class="line">typedef struct objc_method *<span class="keyword">Method</span>;</span><br><span class="line"></span><br><span class="line">struct objc_method <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    SEL _Nonnull method_name                                 OBJC2_UNAVAILABLE;</span></span><br><span class="line"><span class="comment">    char * _Nullable method_types                            OBJC2_UNAVAILABLE;</span></span><br><span class="line"><span class="comment">    IMP _Nonnull method_imp                                  OBJC2_UNAVAILABLE;</span></span><br><span class="line"><span class="comment">&#125;</span>                                                            OBJC2_UNAVAILABLE<span class="punctuation">;</span></span><br></pre></td></tr></table></figure>
<p>Methodæ˜¯ä¸€ç§æ•°æ®ç±»å‹,ä»£è¡¨ç±»é‡Œé¢å®šä¹‰çš„ä¸€ä¸ªæ–¹æ³•.ä¸ªäººè§‰å¾—å°†ä¸€ä¸ªç‰©ç†æ–¹æ³•æŠ½è±¡ä¸ºä¸€ä¸ªMethodå®ä¾‹,ç®€ç›´æ˜¯ç§€å•Š.è¿™æ ·åªéœ€è¦æ›´æ”¹Methodå®ä¾‹é‡Œçš„IMPæˆå‘˜å˜é‡çš„å€¼,ä¸å°±è°ƒåˆ°å¦å¤–ä¸€ä¸ªç‰©ç†å‡½æ•°äº†å—,è¿™æ ·ä¸å°±åŠ¨æ€èµ·æ¥äº†å—,æœç„¶æ˜¯ä¼˜ç§€çš„è®¾è®¡!äº‹å®ä¸ŠMethodç³»åˆ—APIå°±æä¾›äº†è¿™äº›éªšæ“ä½œ:</p>
<figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è·å–Methodé‡Œçš„IMP</span></span><br><span class="line">OBJC_EXPORT IMP _Nonnull</span><br><span class="line">method_getImplementation(<span class="keyword">Method</span> _<span class="title function_">Nonnull</span> <span class="title function_">m</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®ä¸€ä¸ªæ–°çš„IMP</span></span><br><span class="line">OBJC_EXPORT IMP _Nonnull</span><br><span class="line">method_setImplementation(<span class="keyword">Method</span> _<span class="title function_">Nonnull</span> <span class="title function_">m</span>, <span class="title function_">IMP</span> _<span class="title function_">Nonnull</span> <span class="title function_">imp</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ–¹æ³•äº¤æ¢.å°±æ˜¯é‚£ä¸ªé»‘é­”æ³•.</span></span><br><span class="line">OBJC_EXPORT void</span><br><span class="line">method_exchangeImplementations(<span class="keyword">Method</span> _<span class="title function_">Nonnull</span> <span class="title function_">m1</span>, <span class="title function_">Method</span> _<span class="title function_">Nonnull</span> <span class="title function_">m2</span>);</span><br></pre></td></tr></table></figure>
<p>ç”±äºOBJC2_UNAVAILABLE,å³ä½¿å¾—åˆ°äº†MethodæŒ‡é’ˆä¹Ÿä¸èƒ½ç›´æ¥è®¿é—®ç»“æ„ä½“é‡Œçš„æˆå‘˜å˜é‡.åªèƒ½é€šè¿‡APIæ¥è·å–.</p>
<p>eg:</p>
<figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Method</span> <span class="title function_">method</span> = <span class="title function_">class_getInstanceMethod</span><span class="params">(Person.class, @<span class="keyword">selector</span>(hasBook:)</span>);</span><br><span class="line"></span><br><span class="line">SEL name = method_getName(<span class="keyword">method</span>);</span><br></pre></td></tr></table></figure>
<p>ç›¸å…³API:</p>
<figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å–å®ä¾‹æ–¹æ³•</span></span><br><span class="line"><span class="keyword">Method</span> <span class="title function_">class_getInstanceMethod</span> <span class="params">( <span class="keyword">Class</span> cls, SEL name )</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–ç±»æ–¹æ³•</span></span><br><span class="line"><span class="keyword">Method</span> <span class="title function_">class_getClassMethod</span> <span class="params">( <span class="keyword">Class</span> cls, SEL name )</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–æ‰€æœ‰æ–¹æ³•çš„æ•°ç»„</span></span><br><span class="line"><span class="keyword">Method</span> * <span class="title function_">class_copyMethodList</span> <span class="params">( <span class="keyword">Class</span> cls, unsigned int *outCount )</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å–æ–¹æ³•å</span></span><br><span class="line">OBJC_EXPORT SEL _Nonnull</span><br><span class="line">method_getName(<span class="keyword">Method</span> _<span class="title function_">Nonnull</span> <span class="title function_">m</span>) </span><br><span class="line">    <span class="title function_">OBJC_AVAILABLE</span><span class="params">(10.5, 2.0, 9.0, 1.0, 2.0)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å–IMP  </span></span><br><span class="line">OBJC_EXPORT IMP _Nonnull</span><br><span class="line">method_getImplementation(<span class="keyword">Method</span> _<span class="title function_">Nonnull</span> <span class="title function_">m</span>) </span><br><span class="line">    <span class="title function_">OBJC_AVAILABLE</span><span class="params">(10.5, 2.0, 9.0, 1.0, 2.0)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å–å‡½æ•°å‚æ•°å’Œè¿”å›å€¼ç±»å‹.(åŒ…å«åœ¨è¿”å›çš„å­—ç¬¦ä¸²ä¸­)</span></span><br><span class="line">OBJC_EXPORT <span class="keyword">const</span> char * _Nullable</span><br><span class="line">method_getTypeEncoding(<span class="keyword">Method</span> _<span class="title function_">Nonnull</span> <span class="title function_">m</span>) </span><br><span class="line">    <span class="title function_">OBJC_AVAILABLE</span><span class="params">(10.5, 2.0, 9.0, 1.0, 2.0)</span>;</span><br><span class="line">    </span><br><span class="line">OBJC_EXPORT void</span><br><span class="line">method_getReturnType(<span class="keyword">Method</span> _<span class="title function_">Nonnull</span> <span class="title function_">m</span>, <span class="title function_">char</span> * _<span class="title function_">Nonnull</span> <span class="title function_">dst</span>, <span class="title function_">size_t</span> <span class="title function_">dst_len</span>) </span><br><span class="line">    <span class="title function_">OBJC_AVAILABLE</span><span class="params">(10.5, 2.0, 9.0, 1.0, 2.0)</span>;</span><br></pre></td></tr></table></figure>
<p>eg:</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">- (void)methodApi</span><br><span class="line">&#123;</span><br><span class="line">    Method <span class="function"><span class="keyword">method</span> = <span class="title">class_getInstanceMethod</span></span>(Person.class, @selector(hasBook:));</span><br><span class="line">    SEL name = method_getName(<span class="function"><span class="keyword">method</span>)</span>;</span><br><span class="line">    NSLog(@<span class="string">&quot;sel:<span class="variable">%@</span>&quot;</span>, NSStringFromSelector(name));</span><br><span class="line">    </span><br><span class="line">    <span class="regexp">//</span>æ‰“å°æ–¹æ³•çš„å‚æ•°å’Œè¿”å›å€¼ç±»å‹ç¼–ç </span><br><span class="line">    const char *types = method_getTypeEncoding(<span class="function"><span class="keyword">method</span>)</span>;</span><br><span class="line">    NSLog(@<span class="string">&quot;TypeEncoding:<span class="variable">%s</span>&quot;</span>, types); <span class="regexp">//</span><span class="string">&quot;B24<span class="variable">@0</span>:8<span class="variable">@16</span>&quot;</span>,ä¸çœ‹æ•°å­—å°±æ˜¯<span class="string">&quot;B<span class="variable">@:</span>@&quot;</span>,å³<span class="string">&quot;BOOL id SEL id&quot;</span>.è¡¨æ˜è¿”å›å€¼ä¸ºBOOLç±»å‹,ç¬¬<span class="number">0</span>ä¸ªå‚æ•°çš„ç±»å‹æ˜¯å¯¹è±¡ç±»å‹,ç¬¬<span class="number">1</span>ä¸ªå‚æ•°çš„ç±»å‹æ˜¯SELç±»å‹,ç¬¬<span class="number">2</span>ä¸ªå‚æ•°çš„ç±»å‹ä¹Ÿæ˜¯å¯¹è±¡ç±»å‹.ä¸­é—´å¤¹æ‚çš„æ•°å­—ä¼°è®¡æ˜¯åç§»é‡.ç¬¬<span class="number">0</span>ä¸ªå‚æ•°åç§»é‡è‡ªç„¶æ˜¯<span class="number">0</span>,é•¿åº¦<span class="number">8</span>å­—èŠ‚.äºæ˜¯ç¬¬äºŒä¸ªå‚æ•°çš„åç§»é‡è‡ªç„¶æ˜¯<span class="number">8</span>.ä»¥æ­¤ç±»æ¨.</span><br><span class="line">    </span><br><span class="line">    //æ‰“å°å‚æ•°ä¸ªæ•°</span><br><span class="line">    NSUInteger args = method_getNumberOfArguments(<span class="function"><span class="keyword">method</span>)</span>;</span><br><span class="line">    NSLog(@<span class="string">&quot;å‚æ•°ä¸ªæ•°:<span class="variable">%lu</span>&quot;</span>, args);</span><br><span class="line">    </span><br><span class="line">    <span class="regexp">//</span>æ‰“å°è¿”å›å€¼çš„ç±»å‹ç¼–ç </span><br><span class="line">    char returnType;</span><br><span class="line">    method_getReturnType(<span class="function"><span class="keyword">method</span>, &amp;<span class="title">returnType</span>, 1)</span>;</span><br><span class="line">    char *rt = method_copyReturnType(<span class="function"><span class="keyword">method</span>)</span>;</span><br><span class="line">    NSLog(@<span class="string">&quot;returnType:<span class="variable">%c</span> <span class="variable">%s</span>&quot;</span>, returnType, rt);</span><br><span class="line">    free(rt); <span class="regexp">//</span>å¿…é¡»è°ƒç”¨free,å¦åˆ™å†…å­˜æ³„æ¼.</span><br><span class="line">    </span><br><span class="line">    //æ‰“å°å‚æ•°çš„ç±»å‹ç¼–ç </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args; i++) &#123;</span><br><span class="line">        char argType;</span><br><span class="line">        method_getArgumentType(<span class="function"><span class="keyword">method</span>, <span class="title">i</span>, &amp;<span class="title">argType</span>, 1)</span>;</span><br><span class="line">        NSLog(@<span class="string">&quot;argType<span class="variable">%d</span>:<span class="variable">%c</span>&quot;</span>, i, argType);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args; i++) &#123;</span><br><span class="line">        char *arg = method_copyArgumentType(<span class="function"><span class="keyword">method</span>, <span class="title">i</span>)</span>;</span><br><span class="line">        NSLog(@<span class="string">&quot;argType<span class="variable">%d</span>:<span class="variable">%s</span>&quot;</span>, i, arg);</span><br><span class="line">        free(arg); <span class="regexp">//</span>å¿…é¡»è°ƒç”¨free,å¦åˆ™å†…å­˜æ³„æ¼.</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //ä¹Ÿå¯ä»¥ä½¿ç”¨NSMethodSignatureå¯¹è±¡æ¥è·å–æŸä¸ªå‚æ•°çš„ç±»å‹ç¼–ç æˆ–è¿”å›å€¼ç¼–ç </span><br><span class="line">    NSMethodSignature *methodSig = [Person instanceMethodSignatureForSelector:name];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>æ ¹æ®ä¸Šé¢çš„ç®€å•ä»‹ç»,æˆ‘ä»¬çŸ¥é“äº†:<br>SELæ˜¯ä¸€ç§æ•°æ®ç±»å‹,ä»£è¡¨ä¸€ä¸ªæ–¹æ³•é€‰æ‹©å™¨.<br>IMPæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ,æŒ‡å‘æ–¹æ³•å®ç°çš„å…·ä½“å‡½æ•°é¦–åœ°å€.<br>Methodæ˜¯ä¸€ç§æ•°æ®ç±»å‹,ä»£è¡¨ç±»é‡Œé¢å®šä¹‰çš„ä¸€ä¸ªæ–¹æ³•.<br>æ­£æ˜¯æŠ½è±¡å‡ºäº†è¿™ä¹ˆå‡ ç§æ•°æ®ç±»å‹,æ‰è®©æˆ‘ä»¬èƒ½å¤Ÿå¦‚æ­¤æ–¹ä¾¿çš„è¿ç”¨runtime,ä½¿ç”¨å„ç§é»‘ç§‘æŠ€.</p>
<p>æœ€åä»¥è§£å†³ä¸€ä¸ªå°é—®é¢˜,å†æ¬¡æ¸©ä¹ ä¸€ä¸‹è¿™ä¸‰ä¸ªæ¦‚å¿µ,å¹¶ç»“æŸæœ¬æ–‡.</p>
<p>é—®é¢˜:å‡è®¾æœ‰ä¸€ä¸ªSDK,æˆ‘ä»¬ä»…çŸ¥é“è¿™ä¸ªSDKé‡Œé¢æœ‰ä¸€ä¸ªç§æœ‰ç±»åå«â€Personâ€,ä»¥åŠå®ƒçš„ä¸€ä¸ªæ–¹æ³•:<code>- (BOOL)hasBook:(NSString *)book;</code>,å‡è®¾è¯¥æ–¹æ³•çš„å®ç°å¦‚ä¸‹:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)hasBook:(<span class="built_in">NSString</span> *)book</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ([book isEqualToString:<span class="string">@&quot;Gone with the wind&quot;</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨æƒ³è¦é‡å†™è¯¥æ–¹æ³•çš„å†…éƒ¨å®ç°è¦æ±‚:å½“ä¼ å…¥çš„å‚æ•°ä¸ºâ€Romance Of The Three Kingdomsâ€è¿”å›YES,å¦åˆ™è¿˜èµ°åŸæ¥çš„é€»è¾‘.å¦‚ä½•åšæ‰å¯ä»¥åŠåˆ°?</p>
<p>è§£:å…¶å®å¦‚æœPersonä¸æ˜¯ç§æœ‰ç±»,æˆ‘ä»¬åªéœ€è¦ç»§æ‰¿å®ƒ,ç„¶åé‡å†™<code>hasBook:</code>æ–¹æ³•,åœ¨é‡Œé¢æ¥ä¸ªif-elseå°±å®Œäº‹äº†.ä½†æ˜¯ç°åœ¨Personæ˜¯ç§æœ‰ç±»,æ²¡åŠæ³•ç»§æ‰¿,æ­¤è·¯ä¸é€š.åŒæ ·çš„ç±»åˆ«ä¹Ÿä¸è¡Œ,å†è¯´ç±»åˆ«é‡Œçš„æ–¹æ³•ä¼šè¦†ç›–åŸæ¥çš„å®ç°,åŸºæœ¬ä¸Šæ²¡æ³•è°ƒç”¨åˆ°åŸæ¥çš„å®ç°,æ‰€ä»¥ç±»åˆ«ä¹Ÿæ˜¯è¡Œä¸é€šçš„.ç›®å‰çœ‹æ¥åªæœ‰runtimeå¯èƒ½æœ‰ç‚¹ç”¨,ç°åœ¨å°±è®©æˆ‘ä»¬ä½¿ç”¨ä¸Šè¿°APIæ¥æå®šè¿™ä¸ªé—®é¢˜.</p>
<p>é€šè¿‡runtimeæˆ‘ä»¬å¯ä»¥è·å–åˆ°ä¸€ä¸ªç±»çš„Method,æœ‰äº†Methodå°±å¯ä»¥è·å–åˆ°åŸå§‹IMP,ç„¶åæˆ‘ä»¬è¿˜å¯ä»¥ç»™Methodè®¾ç½®ä¸€ä¸ªæ–°çš„IMP,åœ¨æ–°çš„IMPé‡Œè°ƒç”¨åŸå§‹IMP.è¿™æ ·ä¸Šè¿°é—®é¢˜å°±è§£å†³äº†.</p>
<p>å’±ä»¬å…ˆå†™ä¸ªè°ƒç”¨Personçš„hasBook:çš„æ–¹æ³•,æ–¹ä¾¿åé¢æµ‹è¯•:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)invokeHasBookWithPerson:(<span class="type">id</span>)person param:(<span class="built_in">NSString</span> *)param</span><br><span class="line">&#123;</span><br><span class="line">    SEL seletor = <span class="built_in">NSSelectorFromString</span>(<span class="string">@&quot;hasBook:&quot;</span>);</span><br><span class="line">    <span class="built_in">NSMethodSignature</span> *methodSig = [person methodSignatureForSelector:seletor];</span><br><span class="line">    <span class="built_in">NSInvocation</span> *invocation = [<span class="built_in">NSInvocation</span> invocationWithMethodSignature:methodSig];</span><br><span class="line">    [invocation setArgument:&amp;param atIndex:<span class="number">2</span>];</span><br><span class="line">    [invocation setSelector:seletor];</span><br><span class="line">    [invocation setTarget:person];</span><br><span class="line">    [invocation invoke];</span><br><span class="line">    <span class="comment">//è°ƒç”¨åæ‰å¯ä»¥å»è·å–è¿”å›å€¼.</span></span><br><span class="line">    <span class="type">BOOL</span> rs = <span class="literal">NO</span>;</span><br><span class="line">    [invocation getReturnValue:&amp;rs];</span><br><span class="line">    <span class="keyword">return</span> rs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä¸ºå•¥ä½¿ç”¨NSInvocationè€Œä¸ç›´æ¥ä½¿ç”¨performSelector,æ˜¯å› ä¸º:</p>
<blockquote>
<p><code>- (id)performSelector:(SEL)aSelector;</code><br><code>- (id)performSelector:(SEL)aSelector withObject:(id)object;</code><br>performSelectorç³»åˆ—æ–¹æ³•,è¢«æ‰§è¡Œçš„é€‰æ‹©å™¨çš„è¿”å›å€¼å¿…é¡»æ˜¯å¯¹è±¡ç±»å‹.å¦åˆ™å°†å´©æºƒ.å‚æ•°ä¹Ÿå¿…é¡»æ˜¯å¯¹è±¡ç±»å‹,å¦åˆ™è¢«æ‰§è¡Œçš„é€‰æ‹©å™¨å¾—åˆ°çš„å°†æ˜¯æ— æ•ˆå‚æ•°.å¦‚æœæ˜¯éå¯¹è±¡ç±»å‹,åˆ™åªèƒ½ä½¿ç”¨NSInvocation.</p>
</blockquote>
<p>ç»§ç»­æ‰¯å›æ¥,è¿™æ ·æ­£å¸¸çš„å†™æ³•<code>[Person.new hasBook:@&quot;xxx&quot;];</code>å˜ä¸º:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="type">id</span> person = [<span class="built_in">NSClassFromString</span>(<span class="string">@&quot;Person&quot;</span>) new];</span><br><span class="line"><span class="type">BOOL</span> rst1 = [<span class="keyword">self</span> invokeHasBookWithPerson:person param:<span class="string">@&quot;Romance Of The Three Kingdoms&quot;</span>];</span><br><span class="line"><span class="type">BOOL</span> rst2 = [<span class="keyword">self</span> invokeHasBookWithPerson:person param:<span class="string">@&quot;Gone with the wind&quot;</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;rst1:%d, rst2:%d&quot;</span>, rst1, rst2);</span><br></pre></td></tr></table></figure>
<p>æ‰“å°ä¸ºrst1:0, rst2:1.è¯´æ˜ç›®å‰èµ°çš„æ˜¯ä»¥å‰çš„å®ç°.</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯è·å–åŸå§‹IMP,ä»¥åŠè®¾ç½®æ–°IMP.</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">Method method = class_getInstanceMethod(<span class="built_in">NSClassFromString</span>(<span class="string">@&quot;Person&quot;</span>), <span class="built_in">NSSelectorFromString</span>(<span class="string">@&quot;hasBook:&quot;</span>));</span><br><span class="line"><span class="comment">//è·å–åŸå§‹IMP</span></span><br><span class="line">IMP imp1 = method_getImplementation(method);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;imp1:%p&quot;</span>, imp1);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®æ–°IMP</span></span><br><span class="line">method_setImplementation(method, imp_implementationWithBlock(^<span class="type">BOOL</span>(<span class="type">id</span> object, <span class="built_in">NSString</span> *arg) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;object:%@, arg:%@&quot;</span>, object, arg);</span><br><span class="line">    <span class="keyword">if</span> ([arg isEqualToString:<span class="string">@&quot;Romance Of The Three Kingdoms&quot;</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è°ƒç”¨åŸæ¥çš„å®ç°.</span></span><br><span class="line">    <span class="keyword">return</span> ((<span class="type">BOOL</span> (*)(<span class="type">id</span>, SEL, <span class="built_in">NSString</span> *))imp1)(object, <span class="built_in">NSSelectorFromString</span>(<span class="string">@&quot;hasBook:&quot;</span>), arg);</span><br><span class="line">&#125;));</span><br><span class="line">    </span><br><span class="line"><span class="comment">//æµ‹è¯•æ•ˆæœ</span></span><br><span class="line"><span class="type">id</span> person = [<span class="built_in">NSClassFromString</span>(<span class="string">@&quot;Person&quot;</span>) new];</span><br><span class="line"><span class="type">BOOL</span> rst1 = [<span class="keyword">self</span> invokeHasBookWithPerson:person param:<span class="string">@&quot;Romance Of The Three Kingdoms&quot;</span>];</span><br><span class="line"><span class="type">BOOL</span> rst2 = [<span class="keyword">self</span> invokeHasBookWithPerson:person param:<span class="string">@&quot;Gone with the wind&quot;</span>];</span><br><span class="line"><span class="type">BOOL</span> rst3 = [<span class="keyword">self</span> invokeHasBookWithPerson:person param:<span class="string">@&quot;xxx&quot;</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;rst1:%d, rst2:%d&quot;</span>, rst1, rst2);</span><br></pre></td></tr></table></figure>
<p>æ‰“å°ç»“æœ:rst1:1, rst2:1, rst3:0.æ˜¯é¢„æœŸçš„æ•ˆæœ.é—®é¢˜è§£å†³.</p>
<p>å…¶å®æˆ‘ä»¬è¿˜å¯ä»¥å¯¹ä¸Šé¢çš„é‡å†™æ“ä½œå°è£…ä¸€ä¸‹,è¿™æ ·å¦‚æœå…¶ä»–ç±»ä¹Ÿæœ‰è¿™æ ·çš„éœ€æ±‚,é‚£ä¹ˆåªéœ€è¦æ”¹åŠ¨Blockçš„å®ç°å°±å¯ä»¥äº†:</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">BOOL overideImplemention(Class <span class="class"><span class="keyword">class</span>, <span class="title">SEL</span> <span class="title">selector</span>, <span class="title">id</span> (^<span class="title">impBlk</span>)(<span class="title">Class</span> <span class="title">cls</span>, <span class="title">SEL</span> <span class="title">sel</span>, <span class="title">IMP</span> <span class="title">imp</span>)) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="class"><span class="keyword">class</span> == <span class="title">Nil</span> || <span class="title">selector</span> == <span class="title">NULL</span> || <span class="title">impBlk</span> == <span class="title">nil</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> NO;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Method <span class="function"><span class="keyword">method</span> = <span class="title">class_getInstanceMethod</span></span>(<span class="keyword">class</span>, selector);</span><br><span class="line">    <span class="keyword">if</span> (<span class="function"><span class="keyword">method</span> == <span class="title">NULL</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> NO;</span><br><span class="line">    &#125;</span><br><span class="line">    IMP originalIMP = method_getImplementation(<span class="function"><span class="keyword">method</span>)</span>;</span><br><span class="line">    method_setImplementation(<span class="function"><span class="keyword">method</span>, <span class="title">imp_implementationWithBlock</span></span>(impBlk(<span class="keyword">class</span>, selector, originalIMP)));</span><br><span class="line">    <span class="keyword">return</span> YES;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//ä½¿ç”¨</span><br><span class="line">&#123;</span><br><span class="line">	BOOL isOveride = overideImplemention(NSClassFromString(@<span class="string">&quot;Person&quot;</span>), NSSelectorFromString(@<span class="string">&quot;hasBook:&quot;</span>), ^id(__unsafe_unretained Class cls, SEL sel, IMP imp) &#123;</span><br><span class="line">        <span class="keyword">return</span> ^BOOL(id object, NSString *arg) &#123;</span><br><span class="line">            <span class="keyword">if</span> (![object isKindOfClass:cls]) &#123;</span><br><span class="line">                <span class="keyword">return</span> NO;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> ([arg isEqualToString:@<span class="string">&quot;Romance Of The Three Kingdoms&quot;</span>]) &#123;</span><br><span class="line">                <span class="keyword">return</span> YES;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            //è°ƒç”¨åŸå§‹æ–¹æ³•</span><br><span class="line">            <span class="keyword">return</span> ((BOOL (*)(id, SEL, NSString *))imp)(object, sel, arg);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (isOveride) &#123;</span><br><span class="line">        NSLog(@<span class="string">&quot;é‡å†™æˆåŠŸ!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    BOOL rst4 = [self invokeHasBookWithPerson:person param:@<span class="string">&quot;Romance Of The Three Kingdoms&quot;</span>];</span><br><span class="line">    BOOL rst5 = [self invokeHasBookWithPerson:person param:@<span class="string">&quot;Gone with the wind&quot;</span>];</span><br><span class="line">    BOOL rst6 = [self invokeHasBookWithPerson:person param:@<span class="string">&quot;Journey to the West&quot;</span>];</span><br><span class="line">    NSLog(@<span class="string">&quot;rst4:<span class="variable">%d</span>, rst5:<span class="variable">%d</span>, rst6:<span class="variable">%d</span>&quot;</span>, rst4, rst5, rst6);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰“å°:rst4:1, rst5:1, rst6:0.ä¹Ÿæ˜¯ä¸€æ ·çš„æ•ˆæœ.<br>ç»è¿‡é‡å†™,åŸSDKé‡Œçš„<code>hasBook:</code>æ¶ˆæ¯ä¹Ÿä¼šèµ°åˆ°æˆ‘ä»¬æ–°è®¾ç½®çš„IMP,å¦‚æœæˆ‘ä»¬ä¸åœ¨æ–°IMPé‡Œè°ƒç”¨åŸIMP,é‚£ä¹ˆç¨‹åºå°†ä¸å†æ‰§è¡Œä»¥å‰çš„å®ç°.è¿™å°±æ˜¯runtime,æ˜¯ä¸æ˜¯å¾ˆå¼ºå¤§.</p>
<h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><p><a href="https://developer.apple.com/documentation/objectivec/sel?language=occ">SELçš„å®˜æ–¹æ–‡æ¡£è¯´æ˜</a></p>
<p><a href="https://draveness.me/message">ä»æºä»£ç çœ‹ ObjC ä¸­æ¶ˆæ¯çš„å‘é€</a></p>
<p><a href="https://awhisper.github.io/2015/12/31/%E5%B0%9D%E8%AF%95%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E6%9B%B4%E5%A5%BD%E7%94%A8%E7%9A%84performSelector-msgSend/">å°è¯•æ‰‹å†™ä¸€ä¸ªæ›´å¥½ç”¨çš„performSelector-msgSend</a></p>
]]></content>
      <categories>
        <category>runtime</category>
      </categories>
      <tags>
        <tag>SELã€IMPã€Method</tag>
      </tags>
  </entry>
  <entry>
    <title>OCä¸Swiftæ··ç¼–</title>
    <url>/2019/04/07/OC%E4%B8%8ESwift%E6%B7%B7%E7%BC%96/</url>
    <content><![CDATA[<h2 id="1-æ··ç¼–è®¾ç½®"><a href="#1-æ··ç¼–è®¾ç½®" class="headerlink" title="1.æ··ç¼–è®¾ç½®"></a>1.æ··ç¼–è®¾ç½®</h2><p>æ–°å»ºä¸€ä¸ªæ¡¥æ¥æ–‡ä»¶<code>å·¥ç¨‹å-Bridging-Header.h</code>.åˆ°æ­¤ä¸ºæ­¢,æ··ç¼–è®¾ç½®å·®ä¸å¤šå°±å®Œäº‹äº†.<br>è¯¥æ–‡ä»¶åœ¨ç¬¬ä¸€æ¬¡æ–°å»ºSwiftæ–‡ä»¶æ—¶,ç³»ç»Ÿä¼šæç¤ºæ˜¯å¦å»ºç«‹æ¡¥æ¥æ–‡ä»¶,é€‰æ‹©æ˜¯å³å¯.ä¹Ÿå¯è‡ªè¡Œåˆ›å»º,ä½†è‡ªè¡Œåˆ›å»ºè¿˜éœ€è¦è®¾ç½®è·¯å¾„ç•¥å¾®éº»çƒ¦.</p>
<h3 id="1-1-Swiftè°ƒç”¨OC"><a href="#1-1-Swiftè°ƒç”¨OC" class="headerlink" title="1.1 Swiftè°ƒç”¨OC"></a>1.1 Swiftè°ƒç”¨OC</h3><p>åœ¨æ¡¥æ¥æ–‡ä»¶ä¸­å¯¼å…¥éœ€è¦è°ƒç”¨çš„OCç±»çš„å¤´æ–‡ä»¶å³å¯.è¿™æ ·å°±å¯ä»¥åœ¨Swiftçš„ç±»é‡Œä½¿ç”¨OCçš„ç±»äº†.</p>
<p>ä¸¾ä¾‹:</p>
<figure class="highlight clean"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Use this file to import your target&#x27;s public headers that you would like to expose to Swift.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//åœ¨Swifté‡Œè°ƒç”¨OC,éœ€è¦åœ¨æ¡¥æ¥æ–‡ä»¶é‡Œå¯¼å…¥OCå¤´æ–‡ä»¶</span></span><br><span class="line"><span class="comment">//è°ƒç”¨è‡ªèº«moduleé‡Œçš„OCä»£ç </span></span><br><span class="line">#<span class="keyword">import</span> <span class="string">&quot;AppDelegate.h&quot;</span></span><br><span class="line">#<span class="keyword">import</span> <span class="string">&quot;ZAEGradientView.h&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Podç®¡ç†çš„OCåº“</span></span><br><span class="line">#<span class="keyword">import</span> &lt;MJRefresh/MJRefresh.h&gt;</span><br><span class="line">#<span class="keyword">import</span> &lt;YYModel/YYModel.h&gt;</span><br><span class="line">#<span class="keyword">import</span> &lt;ZACommon/UIViewController+FRCustomNavigationBarItem.h&gt;</span><br><span class="line">#<span class="keyword">import</span> &lt;ZACommon/InnerBandCore.h&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ³¨æ„:å¯¹äºpodç®¡ç†çš„OCåº“,å¯¼å…¥å¤´æ–‡ä»¶æ—¶æ¨èä½¿ç”¨<code>&lt;&gt;</code>è€Œé<code>&quot;&quot;</code>.å¦‚<code>#import &lt;ZACommon/UIViewController+FRCustomNavigationBarItem.h&gt;</code>,ä¸è¦å†™ä¸º<code>#import &quot;UIViewController+FRCustomNavigationBarItem.h&quot;</code>,å¦åˆ™å¯èƒ½å¯¼è‡´ç¼–è¯‘é€šä¸è¿‡.</p>
</blockquote>
<h3 id="1-2-OCè°ƒç”¨Swift"><a href="#1-2-OCè°ƒç”¨Swift" class="headerlink" title="1.2 OCè°ƒç”¨Swift"></a>1.2 OCè°ƒç”¨Swift</h3><p>éœ€è¦åœ¨OCçš„ç±»é‡Œå†™ä¸Š<code>import &quot;xxx-Swift.h&quot;</code>.(xxxä¸ºé¡¹ç›®åç§°).ä¹Ÿå¯ä»¥å†™åœ¨PCHæ–‡ä»¶ä¸­.<br>å¦‚:<code>#import &quot;EmotionCounsel-Swift.h&quot;</code></p>
<p>å®˜æ–¹æ–‡æ¡£:</p>
<p><a href="https://developer.apple.com/documentation/swift/migrating_your_objective-c_code_to_swift">Migrating Your Objective-C Code to Swift</a></p>
<p><a href="https://developer.apple.com/documentation/swift#2984801">Swift-Build apps using a powerful open language.</a></p>
<h2 id="2-æ··ç¼–é—®é¢˜"><a href="#2-æ··ç¼–é—®é¢˜" class="headerlink" title="2.æ··ç¼–é—®é¢˜"></a>2.æ··ç¼–é—®é¢˜</h2><p>æ··ç¼–å‡ºç°çš„é—®é¢˜å¤§è‡´æœ‰ä¸¤ç±»:</p>
<ul>
<li>å¤´æ–‡ä»¶å¼•ç”¨é—®é¢˜</li>
<li>è¯­æ³•å…¼å®¹æ€§é—®é¢˜</li>
</ul>
<h3 id="2-1å¤´æ–‡ä»¶å¼•ç”¨é—®é¢˜"><a href="#2-1å¤´æ–‡ä»¶å¼•ç”¨é—®é¢˜" class="headerlink" title="2.1å¤´æ–‡ä»¶å¼•ç”¨é—®é¢˜"></a>2.1å¤´æ–‡ä»¶å¼•ç”¨é—®é¢˜</h3><p>å¤´æ–‡ä»¶é—®é¢˜å¯èƒ½ä¼šå¼•èµ·ä¸€ç³»åˆ—çš„ç¼–è¯‘æŠ¥é”™.</p>
<h4 id="å¤´æ–‡ä»¶å¾ªç¯å¼•ç”¨"><a href="#å¤´æ–‡ä»¶å¾ªç¯å¼•ç”¨" class="headerlink" title="å¤´æ–‡ä»¶å¾ªç¯å¼•ç”¨"></a>å¤´æ–‡ä»¶å¾ªç¯å¼•ç”¨</h4><p>Swiftä½¿ç”¨äº†OCçš„æŸä¸ªç±»,è¯¥ç±»çš„å¤´æ–‡ä»¶ä¸­åˆæƒ³ä½¿ç”¨Swiftçš„ç±».å°†å¯¼è‡´Swiftä¸OCäº’ç›¸å¼•ç”¨å¤´æ–‡ä»¶,ä»è€Œå¼•èµ·ç¼–è¯‘é”™è¯¯.<br>è§£å†³åŠæ³•:å¦‚æœä¸€å®šè¦åœ¨OCçš„.hæ–‡ä»¶ä¸­ä½¿ç”¨Swiftçš„ç±»ï¼Œé‚£å°±å‰ç½®å£°æ˜ä¸€ä¸‹Swiftçš„ç±»åï¼Œ<code>@class swift-className</code>ï¼Œç„¶ååœ¨.mæ–‡ä»¶ä¸­å†å¯¼å…¥â€œxxx-Swift.hâ€å¤´æ–‡ä»¶ã€‚<br>å»ºè®®:åœ¨OCè¦è°ƒç”¨Swiftç±»çš„åœ°æ–¹,æ¡¥æ¥æ–‡ä»¶èƒ½å†™åœ¨.mæ–‡ä»¶ä¸­å°±ä¸è¦å†™åœ¨.hæ–‡ä»¶.</p>
<h4 id="case1"><a href="#case1" class="headerlink" title="case1"></a>case1</h4><p>Swiftä¸­ä½¿ç”¨äº†OCçš„<code>ZAEContactDetailViewController</code>,<code>ZAEContactDetailViewController</code>åˆæƒ³ä½¿ç”¨Swiftä¸­çš„ç±».è¿™æ ·å°†ä¼šå¯¼è‡´å¤´æ–‡ä»¶å¾ªç¯å¼•ç”¨.ä»è€Œç¼–è¯‘å™¨ä¼šæŠ¥æœªçŸ¥ç±»å‹ç­‰å…¶ä»–è«åçš„é”™è¯¯.</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ZAEDiscoverViewController</span>: <span class="title class_ inherited__">ZAEViewController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">viewDidLoad</span>() &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">touchesBegan</span>(<span class="keyword">_</span> <span class="params">touches</span>: <span class="type">Set</span>&lt;<span class="type">UITouch</span>&gt;, <span class="params">with</span> <span class="params">event</span>: <span class="type">UIEvent</span>?) &#123;</span><br><span class="line">        <span class="keyword">let</span> detailVC <span class="operator">=</span> <span class="type">ZAEContactDetailViewController</span>.<span class="keyword">init</span>()</span><br><span class="line">        navigationController<span class="operator">?</span>.pushViewController(detailVC, animated: <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="operator">...</span></span><br><span class="line"></span><br><span class="line">#<span class="keyword">import</span> &quot;ZAEViewController.h&quot;</span><br><span class="line"></span><br><span class="line"><span class="type">NS_ASSUME_NONNULL_BEGIN</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@interface</span> <span class="type">ZAEContactDetailViewController</span> : <span class="type">ZAEViewController</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@property</span> (nonatomic, strong) <span class="type">People</span> <span class="operator">*</span>people; <span class="comment">//Peopleä¸ºswiftçš„ç±»</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@end</span></span><br><span class="line"></span><br><span class="line"><span class="type">NS_ASSUME_NONNULL_END</span></span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘å™¨ä¼šæŠ¥é”™:</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">Property <span class="keyword">with</span> <span class="string">&#x27;retain (or strong)&#x27;</span> <span class="keyword">attribute</span> must be <span class="keyword">of</span> <span class="keyword">object</span> <span class="keyword">type</span></span><br><span class="line"><span class="type">Unknown</span> <span class="keyword">type</span> <span class="type">name</span> <span class="string">&#x27;People&#x27;</span></span><br></pre></td></tr></table></figure>
<p>è§£å†³åŠæ³•:</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&quot;ZAEViewController.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NS_ASSUME_NONNULL_BEGIN</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">People</span>; //ä½¿ç”¨@<span class="title">class</span> å‰ç½®å£°æ˜ä¸€ä¸‹å³å¯.</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ZAEContactDetailViewController</span> : <span class="title">ZAEViewController</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) People *people; <span class="comment">//Peopleä¸ºswiftçš„ç±»</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NS_ASSUME_NONNULL_END</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="case2-OC-hæ–‡ä»¶éœ€è¦éµå®ˆSwiftåè®®ï¼Œç„¶ååˆéœ€è¦åœ¨Swiftä¸­å¼•ç”¨è¯¥OCç±»ã€‚"><a href="#case2-OC-hæ–‡ä»¶éœ€è¦éµå®ˆSwiftåè®®ï¼Œç„¶ååˆéœ€è¦åœ¨Swiftä¸­å¼•ç”¨è¯¥OCç±»ã€‚" class="headerlink" title="case2:OC.hæ–‡ä»¶éœ€è¦éµå®ˆSwiftåè®®ï¼Œç„¶ååˆéœ€è¦åœ¨Swiftä¸­å¼•ç”¨è¯¥OCç±»ã€‚"></a>case2:OC.hæ–‡ä»¶éœ€è¦éµå®ˆSwiftåè®®ï¼Œç„¶ååˆéœ€è¦åœ¨Swiftä¸­å¼•ç”¨è¯¥OCç±»ã€‚</h4><p>åƒä¸Šé¢é‚£æ ·å‰å‘å¼•ç”¨ï¼Œä½†å‰å‘å¼•ç”¨åè®®åï¼Œä¼šå‘ç°OC.hæ–‡ä»¶ä¸­ä¼šæœ‰è­¦å‘Šã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&lt;UIKit/UIKit.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NS_ASSUME_NONNULL_BEGIN</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">GKPageListViewDelegate</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">SYANewPersonProfileBaseListViewController</span> : <span class="title">UIViewController</span> &lt;<span class="title">GKPageListViewDelegate</span>&gt; //è­¦å‘Šï¼š<span class="title">cannot</span> <span class="title">find</span> <span class="title">protocol</span> <span class="title">definition</span> <span class="title">for</span> &#x27;<span class="title">GKPageListViewDelegate</span>&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">nullable</span>) <span class="type">void</span>(^scrollCallBack)(<span class="built_in">UIScrollView</span> *scrollView);</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> userId;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nullable</span>) SYAUserInfo *userInfo;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)requestPhotoAlbum;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NS_ASSUME_NONNULL_END</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>åŠæ³•1ï¼šå±è”½è­¦å‘Šã€‚æ²¡æœ‰ä»€ä¹ˆå¤ªå¥½çš„åŠæ³•ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">GKPageListViewDelegate</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> clang diagnostic push</span></span><br><span class="line"><span class="comment">// To get rid of &#x27;No protocol definition found&#x27; warnings which are not accurate</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> clang diagnostic ignored <span class="string">&quot;-Weverything&quot;</span></span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">SYANewPersonProfileBaseListViewController</span> : <span class="title">UIViewController</span> &lt;<span class="title">GKPageListViewDelegate</span>&gt;</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> clang diagnostic pop</span></span><br></pre></td></tr></table></figure>
<p>åŠæ³•2ï¼šç”¨Swiftç»™OCç±»æ·»åŠ æ‰©å±•å®ç°åè®®ã€‚è¿™ä¸ªè‚¯å®šæ²¡è­¦å‘Šäº†ã€‚</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extension</span> <span class="title class_">SYANewPersonProfileBaseListViewController</span>: <span class="title class_ inherited__">GKPageListViewDelegate</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">listScrollView</span>() -&gt; <span class="type">UIScrollView</span> &#123;</span><br><span class="line">        <span class="built_in">fatalError</span>(<span class="string">&quot;Must be implemented by Concrete subclass.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">listViewDidScroll</span>(<span class="params">callBack</span>: <span class="keyword">@escaping</span> (<span class="type">UIScrollView</span>) -&gt; ()) &#123;</span><br><span class="line">        <span class="keyword">self</span>.scrollCallBack <span class="operator">=</span> callBack</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">listView</span>() -&gt; <span class="type">UIView</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.view</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‚è€ƒï¼š<a href="https://developer.apple.com/forums/thread/36454">Pragma ignore missing protocol definition</a></p>
<h4 id="case3-OCç±»-hæ–‡ä»¶éœ€è¦ä½¿ç”¨swiftæ–‡ä»¶ä¸­çš„æšä¸¾ï¼Œç„¶åswiftç±»åˆéœ€è¦ä½¿ç”¨è¯¥OCç±»ã€‚å¯¼è‡´å¤´æ–‡ä»¶å¾ªç¯"><a href="#case3-OCç±»-hæ–‡ä»¶éœ€è¦ä½¿ç”¨swiftæ–‡ä»¶ä¸­çš„æšä¸¾ï¼Œç„¶åswiftç±»åˆéœ€è¦ä½¿ç”¨è¯¥OCç±»ã€‚å¯¼è‡´å¤´æ–‡ä»¶å¾ªç¯" class="headerlink" title="case3:OCç±».hæ–‡ä»¶éœ€è¦ä½¿ç”¨swiftæ–‡ä»¶ä¸­çš„æšä¸¾ï¼Œç„¶åswiftç±»åˆéœ€è¦ä½¿ç”¨è¯¥OCç±»ã€‚å¯¼è‡´å¤´æ–‡ä»¶å¾ªç¯"></a>case3:OCç±».hæ–‡ä»¶éœ€è¦ä½¿ç”¨swiftæ–‡ä»¶ä¸­çš„æšä¸¾ï¼Œç„¶åswiftç±»åˆéœ€è¦ä½¿ç”¨è¯¥OCç±»ã€‚å¯¼è‡´å¤´æ–‡ä»¶å¾ªç¯</h4><p>ç›®å‰æ²¡æ‰¾åˆ°ä»€ä¹ˆå¥½çš„åŠæ³•ã€‚åªèƒ½æ˜¯æŠŠOC .hä½¿ç”¨åˆ°çš„æšä¸¾ç±»å‹æ”¹ä¸ºNSIntegerç±»å‹ã€‚</p>
<figure class="highlight elm"><table><tr><td class="code"><pre><span class="line">- (instance<span class="keyword">type</span>)initWithStatus:(<span class="type">NSInteger</span>)status;</span><br></pre></td></tr></table></figure>
<h3 id="2-2è¯­æ³•å…¼å®¹æ€§é—®é¢˜"><a href="#2-2è¯­æ³•å…¼å®¹æ€§é—®é¢˜" class="headerlink" title="2.2è¯­æ³•å…¼å®¹æ€§é—®é¢˜"></a>2.2è¯­æ³•å…¼å®¹æ€§é—®é¢˜</h3><p>Swiftç›¸æ¯”OCæ¥è¯´æ˜¯ä¸€é—¨é«˜çº§è¯­è¨€.Swifté‡Œé¢è®¸å¤šçš„é«˜çº§åŠŸèƒ½æ˜¯OCæ²¡æœ‰çš„,è¦æƒ³é¡ºåˆ©æ··ç¼–,åˆ™å¿…é¡»ä½¿ç”¨äºŒè€…éƒ½æœ‰çš„åŠŸèƒ½.æ‰€ä»¥åœ¨ç¼–å†™ä»£ç çš„æ—¶å€™,å¦‚æœè¿™ä¸ªç±»å¯èƒ½è¢«OCè°ƒç”¨,é‚£ä¹ˆéœ€è¦é¿å…ä½¿ç”¨Swiftçš„ç‰¹æœ‰åŠŸèƒ½æˆ–è€…é«˜çº§è¯­æ³•.ä¸‹é¢è®¸å¤šé—®é¢˜,å¤§éƒ¨åˆ†ä¹Ÿæ˜¯å› ä¸ºOCæ— æ³•æ”¯æŒè€Œå¯¼è‡´çš„.</p>
<h4 id="OCä¸Swiftç±»çš„ç›¸äº’è°ƒç”¨"><a href="#OCä¸Swiftç±»çš„ç›¸äº’è°ƒç”¨" class="headerlink" title="OCä¸Swiftç±»çš„ç›¸äº’è°ƒç”¨"></a>OCä¸Swiftç±»çš„ç›¸äº’è°ƒç”¨</h4><ul>
<li><p>OCç±»ä¸èƒ½ç»§æ‰¿Swiftçš„ç±»ï¼ˆå³ä½¿Swiftçš„ç±»ç»§æ‰¿è‡ªNSObjectï¼Œä¹Ÿæ·»åŠ äº†@objcï¼Œé‚£ä¹Ÿä¸èƒ½ï¼‰,ä½†Swiftå¯ä»¥ç»§æ‰¿OCçš„ç±».</p>
</li>
<li><p>è¦æƒ³Swiftçš„ç±»èƒ½åœ¨OCä¸­å¯è®¿é—®,åˆ™å¿…é¡»ç»§æ‰¿è‡ªOCçš„ç±».å¦‚æœæƒ³åœ¨OCä¸­è®¿é—®Swiftç±»çš„å±æ€§æˆ–æ–¹æ³•,åˆ™éœ€è¦åœ¨Swiftçš„å±æ€§å‰æ·»åŠ @objcå…³é”®å­—.ä¸¾ä¸ªæ —å­:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å¿…é¡»ç»§æ‰¿äº NSObject	</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">People</span>: <span class="title class_ inherited__">NSObject</span> &#123;</span><br><span class="line">  		<span class="comment">// æƒ³å…¬å¼€ç»™OCçš„è¦ä½¿ç”¨ @objc ä¿®é¥°</span></span><br><span class="line">	    <span class="keyword">@objc</span> <span class="keyword">var</span> firstName: <span class="type">String</span></span><br><span class="line">	    <span class="keyword">@objc</span> <span class="keyword">var</span> lastName: <span class="type">String</span></span><br><span class="line">	    <span class="keyword">@objc</span> <span class="keyword">var</span> sex: <span class="type">Bool</span> <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">	    </span><br><span class="line">	    <span class="keyword">@objc</span> <span class="keyword">init</span>(<span class="params">firstName</span>: <span class="type">String</span>, <span class="params">lastName</span>: <span class="type">String</span>) &#123;</span><br><span class="line">	        <span class="keyword">self</span>.firstName <span class="operator">=</span> firstName</span><br><span class="line">	        <span class="keyword">self</span>.lastName <span class="operator">=</span> lastName</span><br><span class="line">	        <span class="keyword">super</span>.<span class="keyword">init</span>()</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="OCä¸­è°ƒç”¨Swiftçš„struct"><a href="#OCä¸­è°ƒç”¨Swiftçš„struct" class="headerlink" title="OCä¸­è°ƒç”¨Swiftçš„struct"></a>OCä¸­è°ƒç”¨Swiftçš„struct</h4><p>OCä¸èƒ½ç›´æ¥è°ƒç”¨Swiftä¸­çš„structï¼Œå¦‚æœæƒ³åœ¨OCä¸­è°ƒç”¨structçš„å±æ€§ï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿ<br>è§£å†³åŠæ³•:å¯ä»¥å°è£…ä¸€ä¸ªSwiftçš„ç±»,åœ¨ç±»é‡Œå†™ä¸ªæ–¹æ³•æ¥è¿”å›structä¸­çš„å€¼.</p>
<h4 id="OCä¸­ä½¿ç”¨Swiftçš„å…¨å±€å˜é‡"><a href="#OCä¸­ä½¿ç”¨Swiftçš„å…¨å±€å˜é‡" class="headerlink" title="OCä¸­ä½¿ç”¨Swiftçš„å…¨å±€å˜é‡"></a>OCä¸­ä½¿ç”¨Swiftçš„å…¨å±€å˜é‡</h4><p>OCä¸èƒ½ç›´æ¥ä½¿ç”¨Swiftçš„å…¨å±€å˜é‡.<br>è§£å†³åŠæ³•:å¯ä»¥å°è£…ä¸€ä¸ªSwiftçš„ç±»,ç„¶åå°†å…¨å±€å˜é‡ä½œä¸ºç±»æ–¹æ³•çš„è¿”å›å€¼.åœ¨OCä¸­ä½¿ç”¨è¯¥å°è£…ç±».</p>
<p>ä¸¾ä¸ªæ —å­:æœ‰å¦‚ä¸‹ä¸¤ä¸ªSwiftçš„å…¨å±€å˜é‡</p>
<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="params">dateFormatter:</span> DateFormatter <span class="operator">=</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> formatter <span class="operator">=</span> DateFormatter()</span><br><span class="line">    <span class="attr">formatter.dateFormat</span> <span class="operator">=</span> <span class="string">&quot;yyyy-MM-dd&quot;</span></span><br><span class="line">    return formatter</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> notFoundCode <span class="operator">=</span> <span class="number">404</span></span><br></pre></td></tr></table></figure>
<p>æƒ³åœ¨OCä¸­ä½¿ç”¨,åˆ™éœ€è¦å°è£…ä¸€ä¸ªSwiftçš„ç±»å¦‚ä¸‹:</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">class</span> <span class="selector-tag">ZAEGlobal</span>: <span class="selector-tag">NSObject</span> &#123;</span><br><span class="line">    <span class="variable">@objc</span> static let gNotFoundCode = notFoundCode</span><br><span class="line">    <span class="variable">@objc</span> static let gDateFormatter = dateFormatter</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨å¦‚ä¸‹:</p>
<figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">NSLog(@<span class="string">&quot;gNotFoundCode = %ld&quot;</span>, (<span class="name">long</span>)ZAEGlobal.gNotFoundCode)<span class="comment">;  </span></span><br><span class="line">NSLog(@<span class="string">&quot;æ—¥æœŸ:%@&quot;</span>, [ZAEGlobal.gDateFormatter stringFromDate<span class="symbol">:NSDate</span>.date])<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>è€ŒSwiftå¯¼å…¥OCå¤´æ–‡ä»¶åå¯ä»¥ç›´æ¥è°ƒç”¨OCä¸­å®šä¹‰çš„å…¨å±€å˜é‡.</p>
<h4 id="å®"><a href="#å®" class="headerlink" title="å®"></a>å®</h4><p>Swiftè‡ªèº«ä¸æ”¯æŒå®å®šä¹‰.ä»…èƒ½åœ¨Swiftä¸­ä½¿ç”¨ç®€å•çš„å®.<br>è§£å†³åŠæ³•:å°†åŸæœ¬OCä¸­ä¸éœ€è¦æ¥å—å‚æ•°çš„å®ï¼Œå®šä¹‰æˆletå¸¸é‡ï¼Œå°†éœ€è¦æ¥å—å‚æ•°çš„å®å®šä¹‰æˆå‡½æ•°å³å¯.å¯ä»¥ç»™æˆ‘ä»¬çš„é¡¹ç›®æ·»åŠ ä¸€ä¸ªConst.swiftæ–‡ä»¶ï¼Œç„¶åå®šä¹‰è¿™äº›å…¬å…±çš„å¸¸é‡å’Œå‡½æ•°.ç”±äºæˆ‘ä»¬çš„æ•´ä¸ªé¡¹ç›®å…±äº«å‘½åç©ºé—´ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨é¡¹ç›®å†…çš„ä»»ä½•åœ°æ–¹ç›´æ¥ä½¿ç”¨Const.swiftä¸­å®šä¹‰çš„è¿™äº›å…¬å…±çš„å¸¸é‡å’Œå‡½æ•°.</p>
<p>ä¸¾ä¸ªä¾‹å­:<br><code>#define kSeperatorLineViewHeight 0.5</code><br>è¿™ç§ç®€å•çš„å®å¯ä»¥ç›´æ¥åœ¨Swiftä¸­ä½¿ç”¨.</p>
<p>ä½†ä¸‹é¢è¿™ç§<br><code>#define rgba(r,g,b,a) [UIColor colorWithRed:(r)/255.0 green:(g)/255.0 blue:(b)/255.0 alpha:a]</code><br>å°±ä¸èƒ½åœ¨Swiftä¸­ç›´æ¥ä½¿ç”¨.éœ€è¦å®šä¹‰ä¸ºä¸€ä¸ªå‡½æ•°:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">rgba</span>(<span class="params">r</span>: <span class="type">CGFloat</span>, <span class="params">g</span>: <span class="type">CGFloat</span>, <span class="params">b</span>: <span class="type">CGFloat</span>, <span class="params">a</span>: <span class="type">CGFloat</span>) -&gt; <span class="type">UIColor</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">UIColor</span>.<span class="keyword">init</span>(red: r<span class="regexp">/255.0, green: g/</span><span class="number">255.0</span>, blue: b<span class="operator">/</span><span class="number">255.0</span>, alpha: a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="æšä¸¾"><a href="#æšä¸¾" class="headerlink" title="æšä¸¾"></a>æšä¸¾</h4><p>Swiftçš„æšä¸¾éå¸¸å¼ºå¤§.ä½†OCçš„æšä¸¾åŸºæœ¬æ²¿ç”¨Cçš„æšä¸¾å®šä¹‰.è¿™å°±æ„å‘³ç€å¦‚æœæƒ³åœ¨OCç±»ä¸­ä½¿ç”¨Swiftçš„æšä¸¾,é‚£ä¹ˆåœ¨ç¼–å†™Swiftçš„æšä¸¾æ—¶åªèƒ½ä½¿ç”¨ä½é…ç‰ˆçš„æšä¸¾å®šä¹‰,è¿™æ ·ç³»ç»Ÿæ‰èƒ½è½¬æ¢æˆOCèƒ½æ”¯æŒçš„æšä¸¾,æ‰èƒ½å¤Ÿåœ¨OCä¸­ä½¿ç”¨.</p>
<h5 id="OCä½¿ç”¨Swiftæšä¸¾"><a href="#OCä½¿ç”¨Swiftæšä¸¾" class="headerlink" title="OCä½¿ç”¨Swiftæšä¸¾"></a>OCä½¿ç”¨Swiftæšä¸¾</h5><p>OCåªèƒ½ä½¿ç”¨ä½é…ç‰ˆSwiftæšä¸¾.</p>
<p>ä¸¾ä¸ªä¾‹å­:ä¸‹é¢çš„Swiftçš„æšä¸¾å°±å¯ä»¥åœ¨OCä¸­ä½¿ç”¨</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@objc</span> <span class="keyword">enum</span> <span class="title class_">ZAEPayType</span>: <span class="title class_ inherited__">Int</span> &#123;</span><br><span class="line">    <span class="comment">//å…¨æ¬¾ä»˜æ¸…</span></span><br><span class="line">    <span class="keyword">case</span> fullPayment <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ†æœŸæ”¯ä»˜</span></span><br><span class="line">    <span class="keyword">case</span> instalmentPayment</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æšä¸¾ZAEPayTypeå¿…é¡»è¦æŒ‡æ˜åŸå§‹å€¼ç±»å‹ä¸ºInt,ä¸èƒ½çœç•¥,ä¹Ÿä¸èƒ½ä¸ºStringæˆ–å…¶ä»–ç±»å‹.è¿˜éœ€è¦åŠ ä¸Š<code>@objc</code></p>
<p>å¦‚ä¸‹çš„Swiftæšä¸¾<code>DateFormatterType</code>å°±ä¸èƒ½åœ¨OCä¸­ä½¿ç”¨:</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum</span> DateFormatterType &#123;</span><br><span class="line">    <span class="keyword">case</span> formatterType1</span><br><span class="line">    <span class="keyword">case</span> formatterType2</span><br><span class="line">    <span class="keyword">case</span> formatterType3</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> formatterTypeString: <span class="built_in">String</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> self &#123;</span><br><span class="line">        <span class="keyword">case</span> .formatterType1:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span></span><br><span class="line">        <span class="keyword">case</span> .formatterType2:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;yyyy-MM-dd&quot;</span></span><br><span class="line">        <span class="keyword">case</span> .formatterType3:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;yyyy.MM.dd&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å³ä½¿åŠ ä¸Š<code>@objc</code>ä¹Ÿä¼šå¯¼è‡´ç¼–è¯‘å‡ºé”™.</p>
<h5 id="Swiftä½¿ç”¨OCçš„æšä¸¾"><a href="#Swiftä½¿ç”¨OCçš„æšä¸¾" class="headerlink" title="Swiftä½¿ç”¨OCçš„æšä¸¾"></a>Swiftä½¿ç”¨OCçš„æšä¸¾</h5><p>OCé‡Œé¢æœ‰ä¸¤ç§å½¢å¼å®šä¹‰çš„æšä¸¾åˆ†åˆ«ä¸º<code>typedef NS_ENUM</code>,<code>typedef NS_OPTIONS</code>.åœ¨Swiftä¸­ä½¿ç”¨<code>NS_ENUM</code>çš„OCæšä¸¾ä¸OCä¸­æ— å¼‚.ä½†<code>NS_OPTIONS</code>åˆ™æœ‰äº›å·®å¼‚.</p>
<p>ä¸¾ä¸ªæ —å­:</p>
<figure class="highlight elm"><table><tr><td class="code"><pre><span class="line">//èŠå¤©å†…å®¹ç±»å‹</span><br><span class="line">typedef <span class="type">NS_ENUM</span>(<span class="type">NSInteger</span>, <span class="type">ZAEMsgChatContentType</span>) &#123;</span><br><span class="line">    <span class="type">ZAEMsgChatContentTypeUnknow</span> = 0,  //æœªçŸ¥</span><br><span class="line">    <span class="type">ZAEMsgChatContentTypePlainText</span>,   //çº¯æ–‡æœ¬æ¶ˆæ¯</span><br><span class="line">    <span class="type">ZAEMsgChatContentTypePicture</span>,  //å›¾ç‰‡æ¶ˆæ¯</span><br><span class="line">    <span class="type">ZAEMsgChatContentTypeVoice</span>,  //è¯­éŸ³æ¶ˆæ¯</span><br><span class="line">    <span class="type">ZAEMsgChatContentTypeVideo</span>,  //è§†é¢‘æ¶ˆæ¯</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/// <span class="type">Image</span> cache <span class="keyword">type</span></span><br><span class="line">typedef <span class="type">NS_OPTIONS</span>(<span class="type">NSUInteger</span>, <span class="type">YYImageCacheType</span>) &#123;</span><br><span class="line">    /// <span class="type">No</span> value.</span><br><span class="line">    <span class="type">YYImageCacheTypeNone</span>   = 0,</span><br><span class="line">    </span><br><span class="line">    /// <span class="type">Get</span>/store image with memory cache.</span><br><span class="line">    <span class="type">YYImageCacheTypeMemory</span> = 1 &lt;&lt; 0,</span><br><span class="line">    </span><br><span class="line">    /// <span class="type">Get</span>/store image with disk cache.</span><br><span class="line">    <span class="type">YYImageCacheTypeDisk</span>   = 1 &lt;&lt; 1,</span><br><span class="line">    </span><br><span class="line">    /// <span class="type">Get</span>/store image with both memory cache and disk cache.</span><br><span class="line">    <span class="type">YYImageCacheTypeAll</span>    = <span class="type">YYImageCacheTypeMemory</span> | <span class="type">YYImageCacheTypeDisk</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å…¶è½¬æ¢ä¸ºSwiftçš„æ¥å£å¦‚ä¸‹:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="comment">//èŠå¤©å†…å®¹ç±»å‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">ZAEMsgChatContentType</span> : <span class="title class_ inherited__">Int</span> &#123;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">case</span> unknow <span class="comment">//æœªçŸ¥</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> plainText <span class="comment">//çº¯æ–‡æœ¬æ¶ˆæ¯</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> picture <span class="comment">//å›¾ç‰‡æ¶ˆæ¯</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> voice <span class="comment">//è¯­éŸ³æ¶ˆæ¯</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> video <span class="comment">//è§†é¢‘æ¶ˆæ¯</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Image cache type</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> <span class="title class_">YYImageCacheType</span> : <span class="title class_ inherited__">OptionSet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(<span class="params">rawValue</span>: <span class="type">UInt</span>)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// Get/store image with memory cache.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> memory: <span class="type">YYImageCacheType</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// Get/store image with disk cache.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> disk: <span class="type">YYImageCacheType</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// Get/store image with both memory cache and disk cache.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> all: <span class="type">YYImageCacheType</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»è½¬æ¢æ¥å£å¯ä»¥çœ‹å‡ºå¯¹äºä½¿ç”¨<code>NS_OPTIONS</code>å®šä¹‰çš„OCæšä¸¾å¯¹åº”çš„Swiftå…¶å®æ˜¯ä¸€ä¸ªç»“æ„ä½“,<br>å¯¹äºå…¥å‚æ˜¯<code>NS_OPTIONS</code>å®šä¹‰çš„OCæšä¸¾,OCä¸­çš„å†™æ³•æ˜¯<code>YYImageCacheTypeMemory | YYImageCacheTypeDisk</code>,ä½†åœ¨Swiftä¸­å´æ˜¯ä¼ å…¥ä¸€ä¸ªæ•°ç»„.<br><code>let cacheType: [YYImageCacheType] = [.memory, .disk]</code></p>
<p>åä¹‹,åœ¨Swiftä¸­å®šä¹‰ä¸€ä¸ªåŠŸèƒ½ç±»ä¼¼äº<code>NS_OPTIONS</code>çš„OCæšä¸¾,éœ€è¦å®šä¹‰ä¸€ä¸ªstruct,è€Œä¸æ˜¯enum.</p>
<p>æ€»ä¹‹,åœ¨ç¼–å†™ä»£ç çš„æ—¶å€™,å¦‚æœè¿™ä¸ªç±»å¯èƒ½è¢«OCè°ƒç”¨,é‚£ä¹ˆéœ€è¦é¿å…ä½¿ç”¨Swiftçš„ç‰¹æœ‰åŠŸèƒ½æˆ–è€…é«˜çº§è¯­æ³•,å¦åˆ™åœ¨OCä¸­å°±ç”¨ä¸äº†.</p>
<h3 id="3-å…¶ä»–"><a href="#3-å…¶ä»–" class="headerlink" title="3.å…¶ä»–"></a>3.å…¶ä»–</h3><p>æ¨¡å‹è§£ææ¡†æ¶ã€‚å¦‚æœä½¿ç”¨çš„æ˜¯OCå®ç°çš„æ¨¡å‹è§£ææ¡†æ¶ï¼Œåœ¨Swiftä¸­ä½¿ç”¨æ—¶éœ€è¦åœ¨ç±»å‰åŠ @objcMembersï¼Œè¦ä¸ç„¶è§£æçš„å±æ€§å€¼æ˜¯ç©ºçš„ã€‚</p>
<p>æ¯”å¦‚ä¸‹é¢ä½¿ç”¨çš„æ˜¯MJExtensionã€‚SYATimelineMessageModelç±»å‰éœ€è¦åŠ @objcMembersã€‚</p>
<p>ps:è¢«@objcMembersä¿®é¥°çš„ç±»ï¼Œä¼šé»˜è®¤ä¸ºç±»ã€å­ç±»ã€ç±»æ‰©å±•å’Œå­ç±»æ‰©å±•çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•éƒ½åŠ ä¸Š@objcã€‚å½“ç„¶å¦‚æœæƒ³è®©æŸä¸€ä¸ªæ‰©å±•å…³é—­@objcï¼Œåˆ™å¯ä»¥ç”¨@nonobjcè¿›è¡Œä¿®é¥°ã€‚</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@objc</span> <span class="keyword">enum</span> <span class="title class_">SYATimelineMessageType</span>: <span class="title class_ inherited__">Int</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> comment <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">case</span> reply</span><br><span class="line">    <span class="keyword">case</span> praise</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@objcMembers</span> <span class="keyword">class</span> <span class="title class_">SYATimelineMessageModel</span>: <span class="title class_ inherited__">NSObject</span> &#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> avatar: <span class="type">String</span>  &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> v <span class="operator">=</span> user_info<span class="operator">?</span>.photo &#123;</span><br><span class="line">            <span class="keyword">return</span> v</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> nickname: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> v <span class="operator">=</span> user_info<span class="operator">?</span>.nickname &#123;</span><br><span class="line">            <span class="keyword">return</span> v</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> news_id: <span class="type">Int</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    <span class="comment">/// æ–°æ¶ˆæ¯ç±»å‹ 1ï¼šæ–°è¯„è®º 2ï¼šæ–°å›å¤ 3ï¼šæ–°ç‚¹èµ</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> news_type: <span class="type">SYATimelineMessageType</span> <span class="operator">=</span> .comment</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> user_info: <span class="type">SYAUserInfo</span>?</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> moment: <span class="type">SYATimelineItem</span>?</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> comments: <span class="type">SYATimelineCommentItem</span>?</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> like: <span class="type">SYATimelineLikeItem</span>?</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// MARK: - æœ¬åœ°å­—æ®µ</span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">var</span> cellHeight: <span class="type">CGFloat</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>OCï¼Œnullableæ ‡è®°</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="bullet">+</span> (NSURL <span class="emphasis">*)getAvatarResourceURLWithPartial:(NSString *</span>)partialUrl;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢è¿™ä¸ªæ–¹æ³•å¯èƒ½ä¼šè¿”å›nil,ä½†æ˜¯æ²¡æœ‰æ ‡è®°ä¸ºnullableã€‚</p>
<p>åœ¨Swiftè°ƒç”¨æ—¶ç”Ÿæˆäº†ä¸€ä¸ªnilçš„URLï¼Œè™½ç„¶SDçš„æ–¹æ³•urlå¯ä»¥ä¼ nilï¼Œä½†è¿˜æ˜¯å´©æºƒäº†ã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">avatarImageView.sd_setImage(with: <span class="built_in">NSURL</span>.getAvatarResourceURL(withPartial: model.avatar), placeholderImage: <span class="built_in">UIImage</span>.lightGrayPlaceholder())</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)sd_setImageWithURL:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)url</span><br><span class="line">          placeholderImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)placeholder</span><br><span class="line">                   options:(SDWebImageOptions)options</span><br><span class="line">                 completed:(<span class="keyword">nullable</span> SDExternalCompletionBlock)completedBlock;</span><br></pre></td></tr></table></figure>
<p>è¿™è¯´æ˜Swift-OCæ¡¥æ¥æ—¶nilæ£€æŸ¥å¾ˆä¸¥æ ¼ï¼ŒOCæ²¡æ ‡è®°ä¸ºnullableï¼Œé‚£ä¹ˆSwiftè®¤ä¸ºä¸ä¼šæœ‰ç©ºå¯¹è±¡ï¼Œç„¶è€Œå¦‚æœå®é™…OCè¿”å›äº†ç©ºå¯¹è±¡é‚£ä¹ˆæ¡¥æ¥å°±ä¼šå´©æºƒã€‚</p>
<p>ä¿®å¤ï¼šæ·»åŠ nullableã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">+ (<span class="keyword">nullable</span> <span class="built_in">NSURL</span> *)getAvatarResourceURLWithPartial:(<span class="built_in">NSString</span> *)partialUrl;</span><br></pre></td></tr></table></figure>
<h2 id="bug"><a href="#bug" class="headerlink" title="bug"></a>bug</h2><p>Xcode 16.1å¯¹OCç±»ç”ŸæˆSwiftæ¥å£ï¼Œç”Ÿæˆçš„APIåªæœ‰å‡ ä¸ªï¼Œæ˜æ˜æœ‰å¾ˆå¤šä¸ªçš„ï¼ŒåŸå› ä¸æ˜ã€‚ä½†æ˜¯Swifté‡Œå®é™…æ˜¯å¯ä»¥è®¿é—®çš„ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&lt;UIKit/UIKit.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NS_ASSUME_NONNULL_BEGIN</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">XQNavigationBarView</span> : <span class="title">UIView</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">UIButton</span> *backButton;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nullable</span>) <span class="built_in">UIView</span> *titleView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">nullable</span>) <span class="built_in">NSString</span> *title;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIFont</span> *titleFont;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIColor</span> *titleColor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">nullable</span>) <span class="built_in">NSAttributedString</span> *attributeTitle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">nullable</span>) <span class="type">void</span>(^backActionBlock)(<span class="type">void</span>);</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)navigationBar;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NS_ASSUME_NONNULL_END</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ç”Ÿæˆçš„APIï¼š</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">XQNavigationBarView</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">var</span> backActionBlock: (() -&gt; <span class="type">Void</span>)<span class="operator">?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">class</span> <span class="keyword">func</span> <span class="title function_">navigationBar</span>() -&gt; <span class="keyword">Self</span><span class="operator">!</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://juejin.cn/post/6844903844758077453">Objective-C Swift æ··ç¼–çš„æ¨¡å—äºŒè¿›åˆ¶åŒ– 1ï¼šï¿½ï¿½ç¡€çŸ¥è¯†</a></p>
]]></content>
      <categories>
        <category>Swift</category>
      </categories>
      <tags>
        <tag>æ··ç¼–</tag>
      </tags>
  </entry>
  <entry>
    <title>ä»JSONSerializationå´©æºƒåˆ°ææ‡‚Swiftçš„try-catch</title>
    <url>/2019/03/03/%E4%BB%8EJSONSerialization%E5%B4%A9%E6%BA%83%E5%88%B0%E6%90%9E%E6%87%82Swift%E7%9A%84try-catch/</url>
    <content><![CDATA[<p>ä»Šå¤©å­¦ä¹ äº†ä¸‹Swiftä¸­çš„try-catch,çªç„¶å‘ç°åœ¨jsonåºåˆ—åŒ–æ—¶try-catchä¸å¥½ä½¿äº†,ä¸‹é¢çš„ä»£ç ä¾ç„¶ä¼šå¯¼è‡´å´©æºƒ,try-catchå¹¶ä¸èƒ½catchä½.</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">People</span>: <span class="title class_ inherited__">NSObject</span>, <span class="title class_ inherited__">Decodable</span> &#123;</span><br><span class="line">    <span class="keyword">@objc</span> <span class="keyword">var</span> firstName: <span class="type">String</span></span><br><span class="line">    <span class="keyword">@objc</span> <span class="keyword">var</span> lastName: <span class="type">String</span></span><br><span class="line">    <span class="keyword">@objc</span> <span class="keyword">var</span> age: <span class="type">Int</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">@objc</span> <span class="keyword">var</span> height: <span class="type">Float</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">@objc</span> <span class="keyword">var</span> weight: <span class="type">Float</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">@objc</span> <span class="keyword">var</span> sex: <span class="type">Bool</span> <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">@objc</span> <span class="keyword">init</span>(<span class="params">firstName</span>: <span class="type">String</span>, <span class="params">lastName</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.firstName <span class="operator">=</span> firstName</span><br><span class="line">        <span class="keyword">self</span>.lastName <span class="operator">=</span> lastName</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> dict <span class="operator">=</span> [<span class="string">&quot;one&quot;</span>: <span class="type">People</span>.<span class="keyword">init</span>(firstName: <span class="string">&quot;x&quot;</span>, lastName: <span class="string">&quot;q&quot;</span>)]</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> jsonData <span class="operator">=</span> <span class="keyword">try</span> <span class="type">JSONSerialization</span>.data(withJSONObject: dict, options: [])</span><br><span class="line">    <span class="built_in">print</span>(jsonData)</span><br><span class="line">&#125; <span class="keyword">catch</span> <span class="keyword">let</span> error &#123;</span><br><span class="line">    <span class="built_in">print</span>(error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çœ‹äº†ä¸‹æ–¹æ³•</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="keyword">func</span> <span class="title function_">data</span>(withJSONObject obj: <span class="keyword">Any</span>, options opt: <span class="type">JSONSerialization</span>.<span class="type">WritingOptions</span> <span class="operator">=</span> []) <span class="keyword">throws</span> -&gt; <span class="type">Data</span></span><br></pre></td></tr></table></figure>
<p>çš„è¯´æ˜:</p>
<blockquote>
<p>If obj will not produce valid JSON, an exception is thrown. This exception is thrown prior to parsing and represents a programming error, not an internal error. You should check whether the input will produce valid JSON before calling this method by using isValidJSONObject(_:).</p>
</blockquote>
<p>å¤§æ„æ˜¯å¦‚æœobjå‚æ•°ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„JSON,é‚£ä¹ˆå°†æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸.è¯¥å¼‚å¸¸ä»£è¡¨çš„æ˜¯ä¸€ä¸ªç¼–ç¨‹é”™è¯¯è€Œä¸æ˜¯è§£ææ—¶çš„å†…éƒ¨é”™è¯¯,å®ƒåœ¨è§£æä¹‹å‰å°±è¢«æŠ›å‡ºäº†.ä¼°è®¡è¿™ç§å¼‚å¸¸æ˜¯æ— æ³•æ•è·çš„.æ‰€ä»¥æœ€å¥½å…ˆè°ƒç”¨<code>isValidJSONObject</code>åˆ¤æ–­ä¸‹æ˜¯ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„JSON,å†è¿›è¡Œåºåˆ—åŒ–.</p>
<p>ç±»ä¼¼çš„è¿™æ ·çš„é”™è¯¯ä¹Ÿæ˜¯æ•æ‰ä¸åˆ°çš„.</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> ot: <span class="type">String</span>!</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> os <span class="operator">=</span> <span class="keyword">try</span> ot<span class="operator">!</span></span><br><span class="line">    <span class="built_in">print</span>(os)</span><br><span class="line">&#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç ä¾æ—§å´©æºƒ.</p>
<p>çœ‹æ¥ä»¥åä½¿ç”¨try-catchå¾—æ³¨æ„ä¸‹äº†.</p>
<h3 id="try-catchèƒ½å¤Ÿæ•è·ä»€ä¹ˆæ ·çš„é”™è¯¯å‘¢"><a href="#try-catchèƒ½å¤Ÿæ•è·ä»€ä¹ˆæ ·çš„é”™è¯¯å‘¢" class="headerlink" title="try-catchèƒ½å¤Ÿæ•è·ä»€ä¹ˆæ ·çš„é”™è¯¯å‘¢?"></a>try-catchèƒ½å¤Ÿæ•è·ä»€ä¹ˆæ ·çš„é”™è¯¯å‘¢?</h3><p>ç¼–ç¨‹é”™è¯¯ä¹Ÿå°±æ˜¯å¼‚å¸¸éƒ½æ˜¯ä¸èƒ½æ•è·çš„.æ¯”å¦‚å¯¹nilå¼ºåˆ¶è§£åŒ…,æ•°ç»„è¶Šç•Œ,éæ³•å‚æ•°ç­‰.<br>åªæœ‰å¯æ¢å¤çš„é”™è¯¯æ‰å¯ä»¥æ•è·.</p>
<p><a href="https://stackoverflow.com/questions/24010569/error-handling-in-swift-language">Error-Handling in Swift-Language
</a></p>
<p>ä½†åœ¨OCä¸­æ˜¯å¯ä»¥æ•è·å¼‚å¸¸çš„:</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@try</span> &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;@try&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSString</span> *s = <span class="string">@&quot;xx&quot;</span>;</span><br><span class="line">    s = [s stringByAppendingString:<span class="literal">nil</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, s);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@catch</span> (<span class="built_in">NSException</span> *exception) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;exception:%@&quot;</span>, exception);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@finally</span> &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;@finally&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç åŠ äº†try-catchåå°±ä¸ä¼šå´©æºƒ.</p>
<p>Swfitä¸­çš„try-catchåªæ˜¯ç”¨æ¥è¿›è¡Œé”™è¯¯å¤„ç†çš„,å› æ­¤åªèƒ½æ•è·é”™è¯¯,ä¸èƒ½æ•è·å¼‚å¸¸.</p>
<h3 id="Swiftçš„é”™è¯¯å¤„ç†ï¼ˆError-handlingï¼‰"><a href="#Swiftçš„é”™è¯¯å¤„ç†ï¼ˆError-handlingï¼‰" class="headerlink" title="Swiftçš„é”™è¯¯å¤„ç†ï¼ˆError handlingï¼‰"></a>Swiftçš„é”™è¯¯å¤„ç†ï¼ˆError handlingï¼‰</h3><p>é”™è¯¯å¤„ç†ï¼ˆError handlingï¼‰æ˜¯å“åº”é”™è¯¯ä»¥åŠä»é”™è¯¯ä¸­æ¢å¤çš„è¿‡ç¨‹ã€‚Swift æä¾›äº†åœ¨è¿è¡Œæ—¶å¯¹å¯æ¢å¤é”™è¯¯çš„æŠ›å‡ºã€æ•è·ã€ä¼ é€’å’Œæ“ä½œçš„ä¸€ç­‰å…¬æ°‘æ”¯æŒã€‚</p>
<p>æŸäº›æ“ä½œæ— æ³•ä¿è¯æ€»æ˜¯æ‰§è¡Œå®Œæ‰€æœ‰ä»£ç æˆ–æ€»æ˜¯ç”Ÿæˆæœ‰ç”¨çš„ç»“æœã€‚å¯é€‰ç±»å‹å¯ç”¨æ¥è¡¨ç¤ºå€¼ç¼ºå¤±ï¼Œä½†æ˜¯å½“æŸä¸ªæ“ä½œå¤±è´¥æ—¶ï¼Œæœ€å¥½èƒ½å¾—çŸ¥å¤±è´¥çš„åŸå› ï¼Œä»è€Œå¯ä»¥ä½œå‡ºç›¸åº”çš„åº”å¯¹ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡å¦‚æœ‰ä¸ªä»ç£ç›˜ä¸Šçš„æŸä¸ªæ–‡ä»¶è¯»å–æ•°æ®å¹¶è¿›è¡Œå¤„ç†çš„ä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡ä¼šæœ‰å¤šç§å¯èƒ½å¤±è´¥çš„æƒ…å†µï¼ŒåŒ…æ‹¬æŒ‡å®šè·¯å¾„ä¸‹æ–‡ä»¶å¹¶ä¸å­˜åœ¨ï¼Œæ–‡ä»¶ä¸å…·æœ‰å¯è¯»æƒé™ï¼Œæˆ–è€…æ–‡ä»¶ç¼–ç æ ¼å¼ä¸å…¼å®¹ã€‚åŒºåˆ†è¿™äº›ä¸åŒçš„å¤±è´¥æƒ…å†µå¯ä»¥è®©ç¨‹åºè§£å†³å¹¶å¤„ç†æŸäº›é”™è¯¯ï¼Œç„¶åæŠŠå®ƒè§£å†³ä¸äº†çš„é”™è¯¯æŠ¥å‘Šç»™ç”¨æˆ·ã€‚</p>
<blockquote>
<p>Swiftä¸­çš„é”™è¯¯å¤„ç†ç±»ä¼¼äºå…¶ä»–è¯­è¨€ä¸­çš„å¼‚å¸¸å¤„ç†,æ¯”å¦‚éƒ½ä½¿ç”¨tryï¼Œcatchå’Œthrowå…³é”®å­—ã€‚å’Œå…¶ä»–è¯­è¨€ä¸­ï¼ˆåŒ…æ‹¬ Objective-C ï¼‰çš„å¼‚å¸¸å¤„ç†ä¸åŒçš„æ˜¯ï¼ŒSwift ä¸­çš„é”™è¯¯å¤„ç†å¹¶ä¸æ¶‰åŠunwindingè°ƒç”¨æ ˆ(å³è°ƒç”¨æ ˆå±•å¼€)ï¼Œè¿™æ˜¯ä¸€ä¸ªè®¡ç®—ä»£ä»·é«˜æ˜‚çš„è¿‡ç¨‹ã€‚å°±æ­¤è€Œè¨€ï¼Œthrowè¯­å¥çš„æ€§èƒ½æ˜¯å¯ä»¥å’Œreturnè¯­å¥ç›¸åª²ç¾çš„ã€‚</p>
</blockquote>
<p>ç”±æ­¤å¯è§Swiftä¸­çš„é”™è¯¯å¤„ç†å’Œå¼‚å¸¸å¤„ç†ä¸æ˜¯åŒä¸€ä¸ªä¸œè¥¿,åªä¸è¿‡ä½¿ç”¨çš„å…³é”®å­—ç›¸åŒ.</p>
<h3 id="throwã€throwsã€rethrows"><a href="#throwã€throwsã€rethrows" class="headerlink" title="throwã€throwsã€rethrows"></a>throwã€throwsã€rethrows</h3><p>throwï¼šç”¨äºæŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">parseObject</span>&lt;<span class="type">T</span>: <span class="type">Decodable</span>&gt;(<span class="params">data</span>: <span class="type">Data</span>?) <span class="keyword">throws</span> -&gt; <span class="type">T</span> &#123;</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> d <span class="operator">=</span> data <span class="keyword">else</span> &#123;<span class="keyword">throw</span> <span class="type">BusinessError</span>.<span class="keyword">init</span>(code: <span class="type">BusinessError</span>.<span class="type">SuperLike</span>.badParam, message: <span class="string">&quot;æ— æ•°æ®&quot;</span>)&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">try</span> <span class="type">JSONDecoder</span>().decode(<span class="type">T</span>.<span class="keyword">self</span>, from: d)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>throwsï¼šç”¨äºå‘å¤–æŠ›å‡ºé”™è¯¯ã€‚ç”¨äºå‡½æ•°å£°æ˜ï¼Œè¡¨ç¤ºè¯¥å‡½æ•°å†…éƒ¨è‡ªèº«ä¼šæŠ›å‡ºé”™è¯¯ï¼Œè°ƒç”¨å‡½æ•°æ—¶å¤–éƒ¨éœ€è¦ä½¿ç”¨tryå¯¹é”™è¯¯è¿›è¡Œå¤„ç†ï¼Œå¦‚æœå¤–éƒ¨å‡½æ•°ä¹Ÿä¸æƒ³å¤„ç†è¯¥é”™è¯¯ï¼Œé‚£ä¹ˆå¤–éƒ¨å‡½æ•°åœ¨å£°æ˜æ—¶ä¹Ÿè¦æ·»åŠ throwsã€‚</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">func</span> <span class="title function_">test_parse</span>() <span class="keyword">throws</span> -&gt; <span class="type">User</span> &#123; <span class="comment">//è‡ªèº«ä¸å¤„ç†ï¼Œç»§ç»­å¾€å¤–æŠ›</span></span><br><span class="line">    <span class="keyword">let</span> user: <span class="type">User</span> <span class="operator">=</span> <span class="keyword">try</span> parseObject(data: <span class="literal">nil</span>)</span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">func</span> <span class="title function_">test_parse1</span>() -&gt; <span class="type">User</span>? &#123; <span class="comment">//è‡ªèº«å¤„ç†ã€‚try?</span></span><br><span class="line">    <span class="keyword">let</span> user: <span class="type">User</span>? <span class="operator">=</span> <span class="keyword">try?</span> parseObject(data: <span class="literal">nil</span>)</span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">func</span> <span class="title function_">test_parse2</span>() -&gt; <span class="type">User</span>? &#123; <span class="comment">//è‡ªèº«å¤„ç†ã€‚do-catch</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> user: <span class="type">User</span> <span class="operator">=</span> <span class="keyword">try</span> parseObject(data: <span class="literal">nil</span>)</span><br><span class="line">        <span class="keyword">return</span> user</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\(error)</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">func</span> <span class="title function_">test_error</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> user <span class="operator">=</span> <span class="keyword">try?</span> test_parse()</span><br><span class="line">    <span class="keyword">let</span> user1 <span class="operator">=</span> test_parse1()</span><br><span class="line">    <span class="keyword">let</span> user2 <span class="operator">=</span> test_parse2()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> arr <span class="operator">=</span> [<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">let</span> arr1 <span class="operator">=</span> arr.map &#123; ele <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">return</span> <span class="type">String</span>.<span class="keyword">init</span>(ele)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> arr2 <span class="operator">=</span> arr.map &#123; ele <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">let</span> user: <span class="type">User</span>? <span class="operator">=</span> <span class="keyword">try?</span> parseObject(data: <span class="literal">nil</span>)  <span class="comment">//é—­åŒ…å†…éƒ¨éœ€è¦tryå¤„ç†ï¼Œå¦åˆ™å¤–éƒ¨éœ€è¦tryå¤„ç†ã€‚</span></span><br><span class="line">        <span class="keyword">return</span> user</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>rethrowsï¼šç”¨äºå‘å¤–ä¼ é€’é”™è¯¯ã€‚ç”¨äºå‡½æ•°å£°æ˜ï¼Œå‡½æ•°æœ¬èº«ä¸ä¼šæŠ›å‡ºé”™è¯¯ï¼Œä½†é—­åŒ…å‚æ•°ä¼šæŠ›å‡ºé”™è¯¯ï¼Œè°ƒç”¨å‡½æ•°æ—¶å¦‚æœé—­åŒ…å†…éƒ¨å¤„ç†äº†åˆ™å¤–éƒ¨ä¸éœ€è¦å†ä½¿ç”¨tryå¯¹é”™è¯¯è¿›è¡Œå¤„ç†ã€‚</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@inlinable</span> <span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">map</span>&lt;<span class="type">T</span>&gt;(<span class="keyword">_</span> <span class="params">transform</span>: (<span class="type">Element</span>) <span class="keyword">throws</span> -&gt; <span class="type">T</span>) <span class="keyword">rethrows</span> -&gt; [<span class="type">T</span>]</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ï¼š</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> arr <span class="operator">=</span> [<span class="number">1</span>]</span><br><span class="line"><span class="keyword">let</span> arr1 <span class="operator">=</span> arr.map &#123; ele <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">return</span> <span class="type">String</span>.<span class="keyword">init</span>(ele)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//[User?]</span></span><br><span class="line"><span class="keyword">let</span> arr2 <span class="operator">=</span> arr.map &#123; ele <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">let</span> user: <span class="type">User</span>? <span class="operator">=</span> <span class="keyword">try?</span> parseObject(data: <span class="literal">nil</span>)  <span class="comment">//é—­åŒ…å†…éƒ¨éœ€è¦tryå¤„ç†ï¼Œå¦åˆ™å¤–éƒ¨éœ€è¦tryå¤„ç†ã€‚</span></span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Swift</category>
      </categories>
      <tags>
        <tag>é”™è¯¯å¤„ç†</tag>
      </tags>
  </entry>
  <entry>
    <title>éŸ³è§†é¢‘ç¼–ç æ ¼å¼å’Œæ–‡ä»¶æ ¼å¼</title>
    <url>/2018/12/20/%E9%9F%B3%E8%A7%86%E9%A2%91%E7%BC%96%E7%A0%81%E6%A0%BC%E5%BC%8F%E5%92%8C%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/</url>
    <content><![CDATA[<h3 id="éŸ³è§†é¢‘æ–‡ä»¶æ ¼å¼å’Œç¼–ç æ ¼å¼"><a href="#éŸ³è§†é¢‘æ–‡ä»¶æ ¼å¼å’Œç¼–ç æ ¼å¼" class="headerlink" title="éŸ³è§†é¢‘æ–‡ä»¶æ ¼å¼å’Œç¼–ç æ ¼å¼"></a>éŸ³è§†é¢‘æ–‡ä»¶æ ¼å¼å’Œç¼–ç æ ¼å¼</h3><p>ä¸»è¦æ˜¯ææ¸…æ¥šä¸¤ä¸ªæ¦‚å¿µï¼šç¼–ç æ ¼å¼å’Œæ–‡ä»¶æ ¼å¼ã€‚</p>
<p>ç”±äºéŸ³è§†é¢‘çš„åŸå§‹æ•°æ®éƒ½å¾ˆå¤§ï¼Œä¸æ–¹ä¾¿å­˜å‚¨ä¸ä¼ è¾“ï¼Œæ‰€ä»¥å°±æœ‰å„ç§å„æ ·çš„ç¼–ç æŠ€æœ¯æˆ–ç®—æ³•å¯¹å…¶è¿›è¡Œç¼–ç ä»¥è¾¾åˆ°å‡å°‘æ•°æ®çš„ç›®çš„ï¼Œè¿™äº›ç¼–ç æŠ€æœ¯å°±å«ç¼–ç æ ¼å¼ï¼Œæœ‰äº›ç¼–ç æ ¼å¼è§£ç åèƒ½å¤Ÿå®Œå…¨æ¢å¤ä¸ºåŸå§‹æ•°æ®ï¼Œå› æ­¤è¿™äº›ç¼–ç æ ¼å¼ä¹Ÿè¢«ç§°ä¸ºæ— æŸå‹ç¼©ï¼Œè€Œæœ‰äº›ç¼–ç æ ¼å¼è§£ç åä¸èƒ½æ¢å¤ä¸ºåŸæ¥çš„æ•°æ®å› æ­¤ä¹Ÿè¢«ç§°ä¸ºæœ‰æŸå‹ç¼©ã€‚</p>
<p>æˆ‘ä»¬é€šå¸¸è¯´çš„éŸ³è§†é¢‘æ ¼å¼å‡†ç¡®åœ°è®²åº”è¯¥æ˜¯éŸ³è§†é¢‘æ–‡ä»¶æ ¼å¼ã€‚éŸ³è§†é¢‘æ–‡ä»¶æ ¼å¼å®ƒæ˜¯ä¸€ä¸ªå®¹å™¨é‡Œé¢åŒ…å«äº†éŸ³é¢‘ã€è§†é¢‘ã€å­—å¹•ç­‰ï¼Œæœ‰æ—¶ä¹Ÿè¢«ç§°ä¸ºå°è£…æ ¼å¼ã€‚æœ‰äº›æ–‡ä»¶æ ¼å¼åªèƒ½è£…è½½ç‰¹å®šç¼–ç æ ¼å¼çš„æ•°æ®ï¼Œè€Œæœ‰äº›æ–‡ä»¶æ ¼å¼æ—¢å¯ä»¥è£…è½½Aç¼–ç æ ¼å¼çš„æ•°æ®ï¼Œä¹Ÿå¯ä»¥è£…è½½Bç¼–ç æ ¼å¼çš„æ•°æ®ï¼Œä¸è¿‡è¿™ä¹Ÿä¼šå¸¦æ¥ä¸€äº›é—®é¢˜æ¯”å¦‚æŸä¸ªæ’­æ”¾å™¨åªèƒ½æ’­æ”¾è£…è½½Aç¼–ç æ ¼å¼çš„.mp4æ–‡ä»¶ï¼Œè¿™æ—¶å¦‚æœä½ ç»™ä»–ä¸€ä¸ªè£…è½½Bç¼–ç æ ¼å¼çš„.mp4æ–‡ä»¶é‚£ä¹ˆè¿™ä¸ªæ’­æ”¾å™¨å°±ä¼šæ’­æ”¾å¤±è´¥ã€‚å¯¹äºéŸ³é¢‘æ–‡ä»¶ï¼Œè™½ç„¶ä¸€ç§éŸ³é¢‘æ–‡ä»¶æ ¼å¼å¯ä»¥æ”¯æŒå¤šç§ç¼–ç ï¼Œä¾‹å¦‚AVIæ–‡ä»¶æ ¼å¼ï¼Œä½†å¤šæ•°çš„éŸ³é¢‘æ–‡ä»¶ä»…æ”¯æŒä¸€ç§éŸ³é¢‘ç¼–ç ã€‚</p>
<p>éŸ³è§†é¢‘æ–‡ä»¶çš„åå­—åé¢éƒ½ä¼šæœ‰ä¸€ä¸ªæ‰©å±•åï¼Œè¿™ä¸ªæ‰©å±•åå°±ä»£è¡¨å®ƒæ˜¯ä»€ä¹ˆæ–‡ä»¶æ ¼å¼ï¼Œæ‰©å±•åçš„ä½œç”¨å°±æ˜¯å‘Šè¯‰æ“ä½œç³»ç»Ÿåº”è¯¥ä½¿ç”¨ä»€ä¹ˆæ ·çš„è½¯ä»¶æ¥æ‰“å¼€è¯¥æ–‡ä»¶ï¼Œå¯¹äºéŸ³è§†é¢‘æ–‡ä»¶æ”¹å˜æ‰©å±•åå¹¶ä¸å½±å“å†…éƒ¨æ•°æ®çš„ç¼–ç æ ¼å¼ï¼Œåè€Œè¿˜ä¼šè¯¯å¯¼æ“ä½œç³»ç»Ÿï¼Œå¯¼è‡´æ–‡ä»¶æ‰“å¼€å¤±è´¥ï¼Œå¦‚æœæƒ³æ”¹å˜ç¼–ç æ ¼å¼åˆ™éœ€è¦ä¸“é—¨çš„æ ¼å¼è½¬æ¢è½¯ä»¶ã€‚</p>
<p>ç¼–ç æŠ€æœ¯æ˜¯ä¼šä¸æ–­å‘å±•è¿­ä»£çš„ï¼Œæ‰€ä»¥ç»å¸¸ä¼šçœ‹åˆ°ä¸€ä¸ªç¼–ç æŠ€æœ¯ä¸‹é¢å¯èƒ½è¿˜ä¼šåˆ†å¥½å‡ ä¸ªå­ç±»ã€‚å¦å¤–ç¼–ç æ ¼å¼æœ‰å„ä¸ªå‚å•†æ¨å‡ºçš„ï¼Œä¹Ÿæœ‰æ ‡å‡†ç»„ç»‡æ¨å‡ºçš„ï¼Œä¹Ÿæœ‰ä¸ªäººæ¨å‡ºçš„ã€‚è¿™ä¹Ÿå¯¼è‡´äº†å¸‚é¢ä¸Šå‡ºç°äº†å„ç§ç¼–ç æ ¼å¼ï¼Œæ¯ç§ç¼–ç æ ¼å¼åˆä¼šå¯¹åº”ä¸€ç§æ–‡ä»¶æ ¼å¼ï¼Œè¿™å°±é€ æˆäº†æ–°æ‰‹åœ¨ä¸€å †æ ¼å¼åç§°é‡Œæ™•å¤´è½¬å‘ã€‚æˆ‘ä»¬æ‰€è¯´çš„æ ¼å¼ä¸€èˆ¬æŒ‡æ–‡ä»¶æ ¼å¼ï¼Œä½†æœ‰äº›æ—¶å€™åˆæ˜¯æŒ‡ç¼–ç æ ¼å¼ï¼Œé€ æˆè¿™ç§ç°è±¡çš„åŸå› ä¸»è¦æ˜¯å¤§éƒ¨åˆ†æ–‡ä»¶æ ¼å¼åªæ”¯æŒä¸€ç§ç¼–ç æ ¼å¼ï¼Œè¿™ä¸ªæ—¶å€™æ–‡ä»¶æ ¼å¼å’Œç¼–ç æ ¼å¼å¯ä»¥çœ‹åšæ˜¯åŒä¸€ä¸ªä¸œè¥¿ã€‚</p>
<p>ä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶çš„æ’­æ”¾è¿‡ç¨‹ï¼š</p>
<p>éŸ³é¢‘æ–‡ä»¶â€”â€”&gt;è§£å°è£…â€”â€”-&gt;è§£ç â€”â€”â€”&gt;æ¸²æŸ“æ’­æ”¾</p>
<p>è§†é¢‘æ’­æ”¾åˆ™è¦å¤æ‚ä¸€äº›ï¼Œä¸»è¦æ˜¯éŸ³é¢‘å’Œè§†é¢‘çš„åŒæ­¥ã€‚</p>
<p>å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/%E6%88%AA%E5%B1%8F2024-05-22%2013.02.10.png" style="zoom:50%;" /></p>
<p>å›¾ç‰‡æ–‡ä»¶ï¼ŒéŸ³é¢‘æ–‡ä»¶ï¼Œè§†é¢‘æ–‡ä»¶æ„Ÿè§‰éƒ½æ˜¯ä¸€ä¸ªå¥—è·¯ã€‚</p>
<p>å¸¸è§éŸ³é¢‘æ–‡ä»¶æ ¼å¼ï¼š</p>
<ul>
<li>æ— æŸæ ¼å¼ï¼Œä¾‹å¦‚WAVï¼ŒPCMï¼ŒALSï¼ŒALACï¼ŒTAKï¼ŒFLACï¼ŒAPEï¼ŒWavPack(WV)</li>
<li>æœ‰æŸæ ¼å¼ï¼Œä¾‹å¦‚MP3ï¼ŒAACï¼ŒWMAï¼ŒOgg Vorbis</li>
</ul>
<h3 id="AVPlayeræ”¯æŒçš„æ ¼å¼"><a href="#AVPlayeræ”¯æŒçš„æ ¼å¼" class="headerlink" title="AVPlayeræ”¯æŒçš„æ ¼å¼"></a>AVPlayeræ”¯æŒçš„æ ¼å¼</h3><p>å¯ä»¥é€šè¿‡è¿™å‡ ä¸ªAPIæŸ¥çœ‹æ–‡ä»¶æ˜¯å¦æ”¯æŒæ’­æ”¾</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">  @method		audiovisualTypes</span></span><br><span class="line"><span class="comment">  @abstract		Provides the file types the AVURLAsset class understands.</span></span><br><span class="line"><span class="comment">  @result		An NSArray of UTIs identifying the file types the AVURLAsset class understands.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">+ (<span class="built_in">NSArray</span>&lt;<span class="built_in">AVFileType</span>&gt; *)audiovisualTypes API_AVAILABLE(macos(<span class="number">10.7</span>), ios(<span class="number">5.0</span>), tvos(<span class="number">9.0</span>), watchos(<span class="number">1.0</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">  @method		audiovisualMIMETypes</span></span><br><span class="line"><span class="comment">  @abstract		Provides the MIME types the AVURLAsset class understands.</span></span><br><span class="line"><span class="comment">  @result		An NSArray of NSStrings containing MIME types the AVURLAsset class understands.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">+ (<span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *)audiovisualMIMETypes API_AVAILABLE(macos(<span class="number">10.7</span>), ios(<span class="number">5.0</span>), tvos(<span class="number">9.0</span>), watchos(<span class="number">1.0</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">  @method		isPlayableExtendedMIMEType:</span></span><br><span class="line"><span class="comment">  @abstract		Returns YES if asset is playable with the codec(s) and container type specified in extendedMIMEType. Returns NO otherwise.</span></span><br><span class="line"><span class="comment">  @param		extendedMIMEType</span></span><br><span class="line"><span class="comment">  @result		YES or NO.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">+ (<span class="type">BOOL</span>)isPlayableExtendedMIMEType: (<span class="built_in">NSString</span> *)extendedMIMEType API_AVAILABLE(macos(<span class="number">10.7</span>), ios(<span class="number">5.0</span>), tvos(<span class="number">9.0</span>), watchos(<span class="number">1.0</span>));</span><br></pre></td></tr></table></figure>
<p>æ”¯æŒçš„æ ¼å¼ï¼ŒMIMEæ‰“å°ï¼š</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">&quot;<span class="selector-tag">audio</span>/vnd<span class="selector-class">.wave</span>&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/aacp&quot;,</span><br><span class="line">&quot;<span class="selector-tag">video</span>/<span class="number">3</span>gpp2&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/mpeg3&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/mp3&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/<span class="attribute">x</span>-caf&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/mpeg&quot;,</span><br><span class="line">&quot;<span class="selector-tag">video</span>/quicktime&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/<span class="attribute">x</span>-mpeg3&quot;,</span><br><span class="line">&quot;<span class="selector-tag">video</span>/mp4&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/wav&quot;,</span><br><span class="line">&quot;<span class="selector-tag">video</span>/avi&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/flac&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/mp4&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/<span class="attribute">x</span>-mpg&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/scpls&quot;,</span><br><span class="line">&quot;<span class="selector-tag">video</span>/<span class="attribute">x</span>-m4v&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/<span class="attribute">x</span>-wav&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/<span class="attribute">x</span>-aiff&quot;,</span><br><span class="line">&quot;application/ttml+xml&quot;,</span><br><span class="line">&quot;application/vnd<span class="selector-class">.apple</span><span class="selector-class">.mpegurl</span>&quot;,</span><br><span class="line">&quot;<span class="selector-tag">video</span>/<span class="number">3</span>gpp&quot;,</span><br><span class="line">&quot;<span class="selector-tag">text</span>/vtt&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/usac&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/<span class="attribute">x</span>-mpeg&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/wave&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/<span class="attribute">x</span>-m4r&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/<span class="attribute">x</span>-mp3&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/AMR&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/aiff&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/<span class="number">3</span>gpp2&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/aac&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/mpg&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/mpegurl&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/<span class="attribute">x</span>-m4b&quot;,</span><br><span class="line">&quot;application/mp4&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/<span class="attribute">x</span>-m4p&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/<span class="attribute">x</span>-scpls&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/<span class="attribute">x</span>-mpegurl&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/<span class="attribute">x</span>-aac&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/<span class="number">3</span>gpp&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/basic&quot;,</span><br><span class="line">&quot;<span class="selector-tag">audio</span>/<span class="attribute">x</span>-m4a&quot;,</span><br><span class="line">&quot;application/<span class="attribute">x</span>-mpegurl&quot;</span><br></pre></td></tr></table></figure>
<p>å¾ˆæ˜æ˜¾ä¸æ”¯æŒoggã€wmaã€ape(ä¸€ç§æ— æŸå‹ç¼©ç¼–ç æ ¼å¼)ã€flvã€rmè¿™äº›éŸ³é¢‘æ ¼å¼ã€‚ç½‘ä¸Šå¾ˆå¤šæ–‡ç« éƒ½æ˜¯çå†™çš„æ‹·è´çš„ç™¾åº¦ç™¾ç§‘çš„ï¼Œåªå› ä¸ºç™¾åº¦ç™¾ç§‘æœ‰ä¸€ä¸ªè¯æ¡AVPlayerï¼Œä½†æ˜¯æ­¤AVPlayerï¼ˆæ˜¯ä¸€ä¸ªæ’­æ”¾å™¨ï¼‰ä¸æ˜¯å½¼AVPlayerï¼ˆiOSé‡Œçš„ä¸€ä¸ªæ¡†æ¶ï¼‰ã€‚æ‰€ä»¥è¿˜æ˜¯ç”¨ç³»ç»ŸAPIæ£€æŸ¥ä¸€ä¸‹çœ‹çœ‹æ˜¯ä¸æ˜¯æ”¯æŒã€‚</p>
<p>iOSæ”¯æŒçš„éŸ³é¢‘æ–‡ä»¶æ ¼å¼  </p>
<p>iOS supports the audio file formats listed in Table 2-1. For information on audio data formats available in iOS, see Codecs.</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Format name</th>
<th>Format filename extensions</th>
</tr>
</thead>
<tbody>
<tr>
<td>AIFF</td>
<td>.aif, .aiff</td>
</tr>
<tr>
<td>CAF</td>
<td>.caf</td>
</tr>
<tr>
<td>MPEG-1, layer 3</td>
<td>.mp3</td>
</tr>
<tr>
<td>MPEG-2 or MPEG-4 ADTS</td>
<td>.aac</td>
</tr>
<tr>
<td>MPEG-4</td>
<td>.m4a, .mp4</td>
</tr>
<tr>
<td>WAV</td>
<td>.wav</td>
</tr>
</tbody>
</table>
</div>
<p>åŸºæœ¬ä¸Šå°±æ˜¯mpegç³»åˆ—å†åŠ ä¸Šå°‘æ•°å‡ ä¸ªå…¶ä»–æ ¼å¼ã€‚</p>
<h3 id="PCM"><a href="#PCM" class="headerlink" title="PCM"></a>PCM</h3><p>PCMï¼šåˆç§°è„‰å†²ç¼–ç è°ƒåˆ¶ï¼ˆä¹Ÿå«éŸ³é¢‘è£¸æ•°æ®ï¼‰ã€‚<strong>PCMéŸ³é¢‘æ•°æ®æ˜¯æœªç»å‹ç¼©çš„éŸ³é¢‘é‡‡æ ·æ•°æ®è£¸æµ</strong>ï¼Œå®ƒæ˜¯ç”±æ¨¡æ‹Ÿä¿¡å·ç»è¿‡é‡‡æ ·ã€é‡åŒ–ã€ç¼–ç è½¬æ¢æˆçš„æ ‡å‡†çš„æ•°å­—éŸ³é¢‘æ•°æ®ã€‚</p>
<h3 id="AIFF"><a href="#AIFF" class="headerlink" title="AIFF"></a>AIFF</h3><p>éŸ³é¢‘äº¤æ¢æ–‡ä»¶æ ¼å¼ï¼ˆAudio Interchange File Formatï¼Œç¼©å†™ä¸ºAIFFï¼‰,è‹¹æœå…¬å¸å¼€å‘ã€‚ä¸€ä¸ªæ ‡å‡†çš„AIFFæ–‡ä»¶ä¸­çš„éŸ³é¢‘åº”æ˜¯çº¿æ€§PCMï¼Œè¿˜æœ‰ä¸€ç§è¢«ç§°ä¸ºAIFF-Cæˆ–AIFCçš„ä½¿ç”¨å„ç§å‹ç¼©ç¼–è§£ç å™¨çš„å˜ä½“ã€‚</p>
<p><strong>æ˜¯å¦å‹ç¼©</strong></p>
<p>æ— å‹ç¼©ã€‚</p>
<p><strong>æ–‡ä»¶æ‰©å±•å</strong></p>
<p>æ ‡å‡†AIFFæ–‡ä»¶çš„æ‰©å±•åæ˜¯.aiffæˆ–.aifï¼Œå‹ç¼©è¿‡çš„AIFFæ–‡ä»¶çš„æ‰©å±•ååº”æ˜¯.aifcã€‚</p>
<h3 id="WAV"><a href="#WAV" class="headerlink" title="WAV"></a>WAV</h3><p>WAV æ˜¯ Microsoft å’Œ IBM ä¸º PC å¼€å‘çš„ä¸€ç§å£°éŸ³æ–‡ä»¶æ ¼å¼ï¼Œå®ƒç¬¦åˆ RIFFï¼ˆResource Interchange File Formatï¼‰æ–‡ä»¶è§„èŒƒï¼Œç”¨äºä¿å­˜ Windows å¹³å°çš„éŸ³é¢‘ä¿¡æ¯èµ„æºï¼Œè¢« Windows å¹³å°åŠå…¶åº”ç”¨ç¨‹åºæ‰€å¹¿æ³›æ”¯æŒã€‚WAVE æ–‡ä»¶é€šå¸¸åªæ˜¯ä¸€ä¸ªå…·æœ‰å•ä¸ª â€œWAVEâ€ å—çš„ RIFF æ–‡ä»¶ï¼Œè¯¥å—æœ‰ä¸¤ä¸ªå­å—ï¼ˆâ€fmtâ€ å­æ•°æ®å—å’Œ â€dataâ€ å­æ•°æ®å—ï¼‰</p>
<p>è¯¥æ ¼å¼çš„å®è´¨å°±æ˜¯åœ¨ PCM æ–‡ä»¶çš„å‰é¢åŠ äº†ä¸€ä¸ªæ–‡ä»¶å¤´ã€‚</p>
<p><strong>æ˜¯å¦å‹ç¼©</strong></p>
<p>æ— å‹ç¼©ã€‚</p>
<p><strong>æ–‡ä»¶æ‰©å±•å</strong></p>
<p>.wav</p>
<h3 id="CAF"><a href="#CAF" class="headerlink" title="CAF"></a>CAF</h3><p>Core Audio Formatï¼Œå³æ ¸å¿ƒéŸ³é¢‘æ ¼å¼ï¼Œæ˜¯è‹¹æœå…¬å¸ä¸ºäº†æ¶ˆé™¤<a href="https://www.wenjianbaike.com/aiff.html">.AIFF</a>å’Œ<a href="https://www.wenjianbaike.com/wav.html">.WAV</a>æ ¼å¼çš„å±€é™è€Œå¼€å‘çš„éŸ³é¢‘æ ¼å¼ã€‚CAFæ–‡ä»¶ç»“æ„çš„çµæ´»æ€§ä»¥åŠå¯ä»¥è®°å½•çš„å¤šç§ç±»å‹çš„å…ƒæ•°æ®ä½¿å®ƒå‡ ä¹å¯ä»¥ä¸ä»»ä½•ç±»å‹çš„éŸ³é¢‘æ•°æ®ä¸€èµ·ä½¿ç”¨ã€‚</p>
<p>è¿™ç§æ–‡ä»¶æ ¼å¼å°±æ˜¯å…¸å‹çš„ä¸€å¯¹å¤šçš„æ–‡ä»¶æ ¼å¼ã€‚ä½ ä¸çŸ¥é“å®ƒé‡Œé¢å­˜å‚¨çš„æ˜¯å•¥ç±»å‹çš„ç¼–ç æ ¼å¼æ•°æ®ã€‚</p>
<p><strong>æ–‡ä»¶æ‰©å±•å</strong></p>
<p>.caf</p>
<h3 id="WMA"><a href="#WMA" class="headerlink" title="WMA"></a><strong>WMA</strong></h3><p>Windows Media Audioï¼Œæ˜¯å¾®è½¯å…¬å¸å¼€å‘çš„ä¸€ç³»åˆ—éŸ³é¢‘ç¼–è§£ç å™¨ï¼Œä¹ŸæŒ‡ç›¸åº”çš„æ•°å­—éŸ³é¢‘ç¼–ç æ ¼å¼ã€‚</p>
<p><strong>æ˜¯å¦å‹ç¼©</strong></p>
<p>æœ‰æŸå‹ç¼©ã€‚(å¹¶ä¸ç»å¯¹ï¼Œå› ä¸ºä¸€ç§ç¼–è§£ç æ ¼å¼ä¸‹é¢å¯èƒ½æœ‰å¥½å‡ ç§å­ç±»å‹ï¼Œè€Œå…¶ä¸­ä¸€ç§å­ç±»å‹å¯èƒ½æ”¯æŒæ— æŸå‹ç¼©ã€‚ä¸ºäº†æ–¹ä¾¿å¦‚æœå¤§éƒ¨åˆ†éƒ½æ˜¯æœ‰æŸå‹ç¼©ï¼Œå°±å½“åšæœ‰æŸå‹ç¼©äº†)</p>
<p><strong>æ–‡ä»¶æ‰©å±•å</strong></p>
<p>.wma</p>
<h3 id="MPEG"><a href="#MPEG" class="headerlink" title="MPEG"></a>MPEG</h3><p>MPEGï¼šåŠ¨æ€å½±åƒä¸“å®¶å°ç»„ï¼ŒMoving Picture Experts Groupï¼Œç®€ç§°MPEGï¼Œæ˜¯ä¸€ä¸ªæºè‡ªISOä¸IECç­‰å›½é™…ç»„ç»‡çš„å·¥ä½œå°ç»„ï¼Œç”¨ä»¥åˆ¶å®šå½±éŸ³å‹ç¼©åŠä¼ è¾“çš„è§„æ ¼æ ‡å‡†ã€‚</p>
<p>MPEGå°ç»„åˆ°ç›®å‰ä¸ºæ­¢ï¼Œå·²æœ‰ä»¥ä¸‹å’ŒéŸ³è§†é¢‘ç›¸å…³çš„æ ‡å‡†ï¼šMPEG-1ã€MPEG-2ã€MPEG-3ã€MPEG-4ã€MPEG-7ã€MPEG-21ã€‚MPEG-1æ˜¯MPEGç»„ç»‡åˆ¶å®šçš„ç¬¬ä¸€ä¸ªè§†é¢‘å’ŒéŸ³é¢‘æœ‰æŸå‹ç¼©æ ‡å‡†ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°MPEGå·²ç»åˆ¶å®šäº†å¾ˆå¤šæ ‡å‡†äº†ï¼Œè¿™äº›æ ‡å‡†æ¶µç›–äº†å¾ˆå¤šæ–¹é¢ï¼Œå› æ­¤æ¯ä¸ªæ ‡å‡†ä¸‹é¢åˆåŒ…å«å¾ˆå¤šä¸ªéƒ¨åˆ†ã€‚æ¯”å¦‚MPEG-1åŒ…å«5ä¸ªpartï¼ŒPart 2æ˜¯videoéƒ¨åˆ†ï¼ŒPart 3æ˜¯audioéƒ¨åˆ†ï¼Œaudioéƒ¨åˆ†ä¸‹é¢åˆåŒ…å«3ä¸ªLayerï¼Œå…¶ä¸­MPEG-1 Audio Layer IIIï¼Œå°±æ˜¯ç¬¬ä¸€ç‰ˆçš„MP3ã€‚</p>
<p>MPEG-2æ ‡å‡†æ˜¯å¯¹MPEG-1æ ‡å‡†çš„è¡¥å……å’Œæ‰©å±•ã€‚MPEG-2 Part7éƒ¨åˆ†å¼•å…¥äº†AACï¼ŒAACåœ¨MPEG-4çš„Part 3ä¸­ä¹Ÿæœ‰å®šä¹‰ã€‚</p>
<h4 id="MP3"><a href="#MP3" class="headerlink" title="MP3"></a>MP3</h4><p>MPEG-1 Audio Layer III</p>
<p><strong>æ˜¯å¦å‹ç¼©</strong></p>
<p>æœ‰æŸå‹ç¼©ã€‚</p>
<p><strong>æ–‡ä»¶æ‰©å±•å</strong></p>
<p>.mp3ï¼Œå®é™…ä¸Šç”±äºMPEG-1æ ‡å‡†ä¸‹åŒ…å«å¾ˆå¤šå­æ ‡å‡†æ‰€ä»¥è·ŸMPEG-1æœ‰å…³çš„æ–‡ä»¶æ‰©å±•åéå¸¸å¤šã€‚</p>
<p><a href="https://en.wikipedia.org/wiki/MPEG-1">MPEG-1</a> </p>
<p><a href="https://en.wikipedia.org/wiki/MPEG-2">MPEG-2</a></p>
<p><a href="https://en.wikipedia.org/wiki/MPEG-4">MPEG-4</a></p>
<p>MPEG-4ç›¸å…³çš„æ–‡ä»¶æ‰©å±•åå¯ä»¥å‚è€ƒï¼š<a href="https://en.wikipedia.org/wiki/MPEG-4_Part_14">MPEG-4_Part_14çš„Filename extensions</a> ï¼Œæ‰©å±•åæ˜¯çœŸçš„å¤šã€‚</p>
<h3 id="AAC"><a href="#AAC" class="headerlink" title="AAC"></a>AAC</h3><p>AACæ˜¯é«˜çº§éŸ³é¢‘ç¼–ç ï¼ˆAdvanced Audio Codingï¼‰çš„ç¼©å†™ï¼Œå‡ºç°äº1997å¹´ï¼Œæœ€åˆæ˜¯åŸºäºMPEG-2çš„éŸ³é¢‘ç¼–ç æŠ€æœ¯ï¼Œç›®çš„æ˜¯å–ä»£MP3æ ¼å¼ã€‚2000å¹´ï¼ŒMPEG-4æ ‡å‡†å‡ºå°ï¼ŒAACé‡æ–°é›†æˆäº†å…¶å®ƒæŠ€æœ¯åŒ…æ‹¬SBRæˆ–PSç‰¹æ€§ï¼Œç›®å‰AACå¯ä»¥å®šä¹‰ä¸ºâ¼€ç§ç”± MPEG-4 æ ‡å‡†å®šä¹‰çš„æœ‰æŸéŸ³é¢‘å‹ç¼©æ ¼å¼ã€‚</p>
<p><strong>æ˜¯å¦å‹ç¼©</strong></p>
<p>æœ‰æŸå‹ç¼©ã€‚</p>
<p><strong>ACC éŸ³é¢‘æ–‡ä»¶æ ¼å¼ç±»å‹</strong></p>
<p>AACçš„éŸ³é¢‘æ–‡ä»¶æ ¼å¼æœ‰ADIF å’Œ ADTSï¼š</p>
<p><strong>ADIF</strong>ï¼šAudio Data Interchange Format éŸ³é¢‘æ•°æ®äº¤æ¢æ ¼å¼ã€‚è¿™ç§æ ¼å¼çš„ç‰¹å¾æ˜¯å¯ä»¥ç¡®å®šçš„æ‰¾åˆ°è¿™ä¸ªéŸ³é¢‘æ•°æ®çš„å¼€å§‹ï¼Œä¸éœ€è¿›è¡Œåœ¨éŸ³é¢‘æ•°æ®æµä¸­é—´å¼€å§‹çš„è§£ç ï¼Œå³å®ƒçš„è§£ç å¿…é¡»åœ¨æ˜ç¡®å®šä¹‰çš„å¼€å§‹å¤„è¿›è¡Œï¼Œè¿™ç§æ ¼å¼å¸¸ç”¨åœ¨ç£ç›˜æ–‡ä»¶ä¸­ã€‚</p>
<p><strong>ADTS</strong>ï¼šAudio Data Transport Stream éŸ³é¢‘æ•°æ®ä¼ è¾“æµã€‚è¿™ç§æ ¼å¼çš„ç‰¹å¾æ˜¯å®ƒæ˜¯ä¸€ä¸ªæœ‰åŒæ­¥å­—çš„æ¯”ç‰¹æµï¼Œè§£ç å¯ä»¥åœ¨è¿™ä¸ªæµä¸­ä»»ä½•ä½ç½®å¼€å§‹ã€‚å®ƒçš„ç‰¹å¾ç±»ä¼¼äºmp3æ•°æ®æµæ ¼å¼ã€‚</p>
<p>ç®€å•è¯´ï¼ŒADTSå¯ä»¥åœ¨ä»»æ„å¸§è§£ç ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒæ¯ä¸€å¸§éƒ½æœ‰å¤´ä¿¡æ¯ã€‚ADIFåªæœ‰ä¸€ä¸ªç»Ÿä¸€çš„å¤´ï¼Œæ‰€ä»¥å¿…é¡»å¾—åˆ°æ‰€æœ‰çš„æ•°æ®åè§£ç ã€‚è¿™ä¸¤ç§çš„headerçš„æ ¼å¼ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œä¸€èˆ¬ç¼–ç åçš„å’ŒæŠ½å–å‡ºçš„éƒ½æ˜¯ADTSæ ¼å¼çš„éŸ³é¢‘æµã€‚</p>
<p><strong>æ–‡ä»¶æ‰©å±•å</strong></p>
<p>.aac</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://juejin.cn/post/6844903725291552775">AVPlayeræ”¯æŒçš„è§†é¢‘æ ¼å¼</a>   â­ï¸â­ï¸â­ï¸</p>
<p><a href="https://www.cnblogs.com/booksky/p/5213198.html">æµ…è°ˆiOSè§†é¢‘å¼€å‘</a>  â­ï¸â­ï¸â­ï¸</p>
<p><a href="https://blog.csdn.net/bsplover/article/details/7426480">å¸¸è§éŸ³é¢‘ç¼–ç æ ¼å¼æ€»ç»“</a></p>
<p><a href="http://blog.51cto.com/huangfu3342/1613795">éŸ³è§†é¢‘å°è£…æ ¼å¼ã€ç¼–ç æ ¼å¼çŸ¥è¯†</a></p>
<p><a href="https://www.cnblogs.com/renhui/p/10412630.html">éŸ³è§†é¢‘ç¼–è§£ç æŠ€æœ¯ï¼ˆäºŒï¼‰ï¼šAAC éŸ³é¢‘ç¼–ç æŠ€æœ¯</a>  æ¯”è¾ƒè¯¦ç»†</p>
<p><a href="https://www.wenjianbaike.com/aac.html">.AACæ–‡ä»¶æ‰©å±•å</a></p>
<p><a href="https://www.cnblogs.com/renhui/p/12148330.html">å¤šåª’ä½“æ–‡ä»¶æ ¼å¼ï¼ˆäº”ï¼‰ï¼šPCM / WAV æ ¼å¼</a>   æ¯”è¾ƒè¯¦ç»†</p>
<p><a href="https://zhuanlan.zhihu.com/p/396273481">PCMæ•°æ®æ ¼å¼ä½ è¯¥çŸ¥é“ä¸€åˆ‡</a></p>
<p><a href="https://www.jianshu.com/p/e568f94cdf6a">PCMæ•°æ®æ ¼å¼</a></p>
<p><a href="https://blog.csdn.net/u010650845/article/details/53520426">MP3æ–‡ä»¶ç»“æ„è§£æ(è¶…è¯¦ç»†)</a></p>
<p><a href="https://www.cnblogs.com/ranson7zop/p/7655474.html#!comments">MP3æ ¼å¼éŸ³é¢‘æ–‡ä»¶ç»“æ„è§£æ</a></p>
<p><a href="https://en.wikipedia.org/wiki/Comparison_of_audio_coding_formats">Comparison of audio coding formats</a></p>
<p><a href="https://damiansheldon.github.io/blog/audio-and-video-file-format.html">éŸ³é¢‘å’Œè§†é¢‘æ ¼å¼</a></p>
<p><a href="https://www.jianshu.com/p/4d611897526b">å…³äºCAFæ–‡ä»¶</a></p>
]]></content>
      <categories>
        <category>éŸ³è§†é¢‘</category>
      </categories>
  </entry>
  <entry>
    <title>UIBarButtonItemå‘</title>
    <url>/2018/12/19/UIBarButtonItem%E5%9D%91/</url>
    <content><![CDATA[<p>ä½¿ç”¨ç³»ç»Ÿè®¾ç½®,åœ¨iOS11.4ä¸Šä¼šå‡ºç°ç‚¹å‡»æ—¶,æ–‡å­—å˜å¤§,é¢œè‰²å˜ä¸ºè“è‰².æ‰€ä»¥ä½¿ç”¨æŒ‰é’®è¿˜æ˜¯é è°±äº›.</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UIBarButtonItem</span> *allReadItem = [[<span class="built_in">UIBarButtonItem</span> alloc] initWithTitle:<span class="string">@&quot;å…¨éƒ¨å·²è¯»&quot;</span> style:<span class="built_in">UIBarButtonItemStylePlain</span> target:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(allReadItemDidClicked:)];</span><br><span class="line">[allReadItem setTitleTextAttributes:@&#123;<span class="built_in">NSFontAttributeName</span> : [<span class="built_in">UIFont</span> pingFangSCWithSize:<span class="number">14</span>], <span class="built_in">NSForegroundColorAttributeName</span> : [<span class="built_in">UIColor</span> colorWithHexString:<span class="string">@&quot;#333333&quot;</span>]&#125; forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line"><span class="keyword">self</span>.navigationItem.rightBarButtonItem = allReadItem;</span><br></pre></td></tr></table></figure>
<p>è§£å†³åŠæ³•ä½¿ç”¨è‡ªå®šä¹‰æŒ‰é’®:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UIButton</span> *btn = [<span class="built_in">UIButton</span> buttonWithType:<span class="built_in">UIButtonTypeCustom</span>];</span><br><span class="line">    btn.titleLabel.font = [<span class="built_in">UIFont</span> pingFangSCWithSize:<span class="number">14</span>];</span><br><span class="line">    [btn setTitle:<span class="string">@&quot;å…¨éƒ¨å·²è¯»&quot;</span> forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">    [btn setTitleColor:[<span class="built_in">UIColor</span> colorWithHexString:<span class="string">@&quot;#333333&quot;</span>] forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">    [btn addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(allReadItemDidClicked:) forControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>];</span><br><span class="line">    [btn sizeToFit]; <span class="comment">//éœ€è¦è®¾ç½®ä¸€ä¸‹å¦åˆ™åœ¨iOS10ä¼šæ²¡æœ‰å¤§å°.</span></span><br><span class="line">    <span class="built_in">UIBarButtonItem</span> *allReadItem = [[<span class="built_in">UIBarButtonItem</span> alloc] initWithCustomView:btn];</span><br><span class="line">    <span class="keyword">self</span>.navigationItem.rightBarButtonItem = allReadItem;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>UIKit</category>
      </categories>
      <tags>
        <tag>UIBarButtonItem</tag>
      </tags>
  </entry>
  <entry>
    <title>iOS UIApplicationStateçŠ¶æ€å˜åŒ–</title>
    <url>/2018/12/09/iOS%20UIApplicationState%E7%8A%B6%E6%80%81%E5%8F%98%E5%8C%96/</url>
    <content><![CDATA[<p>å®éªŒè®¾å¤‡:iPhone5s,10.3.3ç³»ç»Ÿ.</p>
<p>åº”ç”¨çŠ¶æ€:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, <span class="built_in">UIApplicationState</span>) &#123;</span><br><span class="line">    <span class="built_in">UIApplicationStateActive</span>, <span class="comment">//0</span></span><br><span class="line">    <span class="built_in">UIApplicationStateInactive</span>, <span class="comment">//1</span></span><br><span class="line">    <span class="built_in">UIApplicationStateBackground</span> <span class="comment">//2</span></span><br><span class="line">&#125; <span class="built_in">NS_ENUM_AVAILABLE_IOS</span>(<span class="number">4</span>_0);</span><br></pre></td></tr></table></figure>
<p>APPæœªå¯åŠ¨,ç‚¹å‡»å›¾ç‰‡æ‰§è¡Œé¡ºåº:</p>
<figure class="highlight dns"><table><tr><td class="code"><pre><span class="line">é»˜è®¤	<span class="number">23</span>:<span class="number">07</span>:<span class="number">51.443320</span> +<span class="number">0800</span>	pictureInMemory	-[AppDelegate application:didFinishLaunchingWithOptions:]  åº”ç”¨çŠ¶æ€:<span class="number">1</span></span><br><span class="line"></span><br><span class="line">é»˜è®¤	<span class="number">23</span>:<span class="number">07</span>:<span class="number">51.515796</span> +<span class="number">0800</span>	pictureInMemory	-[AppDelegate applicationDidBecomeActive:]  åº”ç”¨çŠ¶æ€:<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>åœ¨åº”ç”¨å¤„äºUIApplicationStateActiveæ—¶,åˆ†åˆ«è¿›è¡Œå¦‚ä¸‹æ“ä½œ:</p>
<h4 id="1-æŒ‰ä¸‹homeé”®"><a href="#1-æŒ‰ä¸‹homeé”®" class="headerlink" title="1.æŒ‰ä¸‹homeé”®"></a>1.æŒ‰ä¸‹homeé”®</h4><figure class="highlight dns"><table><tr><td class="code"><pre><span class="line">é»˜è®¤	<span class="number">23</span>:<span class="number">09</span>:<span class="number">50.067690</span> +<span class="number">0800</span>	pictureInMemory	-[AppDelegate applicationWillResignActive:]  åº”ç”¨çŠ¶æ€:<span class="number">0</span></span><br><span class="line">é»˜è®¤	<span class="number">23</span>:<span class="number">09:50.602224</span> +<span class="number">0800</span>	pictureInMemory	-[AppDelegate applicationDidEnterBackground:]  åº”ç”¨çŠ¶æ€:<span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>1.1å¤„äºåå°æ—¶,å†ç‚¹å‡»å›¾æ ‡</p>
<figure class="highlight dns"><table><tr><td class="code"><pre><span class="line">é»˜è®¤	<span class="number">23</span>:<span class="number">11</span>:<span class="number">34.897752</span> +<span class="number">0800</span>	pictureInMemory	-[AppDelegate applicationWillEnterForeground:]  åº”ç”¨çŠ¶æ€:<span class="number">2</span></span><br><span class="line">é»˜è®¤	<span class="number">23</span>:<span class="number">11:35.218295</span> +<span class="number">0800</span>	pictureInMemory	-[AppDelegate applicationDidBecomeActive:]  åº”ç”¨çŠ¶æ€:<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>1.2å¤„äºåå°æ—¶,åŒå‡»homeè¿›å…¥å¤šä»»åŠ¡ç•Œé¢ç‚¹å‡»è‡ªèº«</p>
<figure class="highlight dns"><table><tr><td class="code"><pre><span class="line">é»˜è®¤	<span class="number">23</span>:<span class="number">19</span>:<span class="number">12.051002</span> +<span class="number">0800</span>	pictureInMemory	-[AppDelegate applicationWillEnterForeground:]  åº”ç”¨çŠ¶æ€:<span class="number">2</span></span><br><span class="line">é»˜è®¤	<span class="number">23</span>:<span class="number">19</span>:<span class="number">13.286377</span> +<span class="number">0800</span>	pictureInMemory	-[AppDelegate applicationDidBecomeActive:]  åº”ç”¨çŠ¶æ€:<span class="number">0</span></span><br></pre></td></tr></table></figure>
<h4 id="2-æŒ‰ä¸‹é”å±é”®"><a href="#2-æŒ‰ä¸‹é”å±é”®" class="headerlink" title="2. æŒ‰ä¸‹é”å±é”®"></a>2. æŒ‰ä¸‹é”å±é”®</h4><figure class="highlight dns"><table><tr><td class="code"><pre><span class="line">é»˜è®¤	<span class="number">23</span>:<span class="number">13</span>:<span class="number">07.542846</span> +<span class="number">0800</span>	pictureInMemory	-[AppDelegate applicationWillResignActive:]  åº”ç”¨çŠ¶æ€:<span class="number">0</span></span><br><span class="line">é»˜è®¤	<span class="number">23</span>:<span class="number">13</span>:<span class="number">07.543049</span> +<span class="number">0800</span>	pictureInMemory	-[AppDelegate applicationDidEnterBackground:]  åº”ç”¨çŠ¶æ€:<span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>2.1è§£é”</p>
<figure class="highlight dns"><table><tr><td class="code"><pre><span class="line">é»˜è®¤	<span class="number">23</span>:<span class="number">17:48.176320</span> +<span class="number">0800</span>	pictureInMemory	-[AppDelegate applicationWillEnterForeground:]  åº”ç”¨çŠ¶æ€:<span class="number">2</span></span><br><span class="line">é»˜è®¤	<span class="number">23</span>:<span class="number">17:48.872183</span> +<span class="number">0800</span>	pictureInMemory	-[AppDelegate applicationDidBecomeActive:]  åº”ç”¨çŠ¶æ€:<span class="number">0</span></span><br></pre></td></tr></table></figure>
<h4 id="3-åŒå‡»homeè¿›å…¥å¤šä»»åŠ¡ç•Œé¢"><a href="#3-åŒå‡»homeè¿›å…¥å¤šä»»åŠ¡ç•Œé¢" class="headerlink" title="3. åŒå‡»homeè¿›å…¥å¤šä»»åŠ¡ç•Œé¢"></a>3. åŒå‡»homeè¿›å…¥å¤šä»»åŠ¡ç•Œé¢</h4><figure class="highlight dns"><table><tr><td class="code"><pre><span class="line">é»˜è®¤	<span class="number">23</span>:<span class="number">14</span>:<span class="number">28.340768</span> +<span class="number">0800</span>	pictureInMemory	-[AppDelegate applicationWillResignActive:]  åº”ç”¨çŠ¶æ€:<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>3.1å¤šä»»åŠ¡ç‚¹å‡»å…¶ä»–APP</p>
<figure class="highlight dns"><table><tr><td class="code"><pre><span class="line">é»˜è®¤	<span class="number">23</span>:<span class="number">15</span>:<span class="number">14.853798</span> +<span class="number">0800</span>	pictureInMemory	-[AppDelegate applicationDidEnterBackground:]  åº”ç”¨çŠ¶æ€:<span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>3.2å¤šä»»åŠ¡ç‚¹å‡»è‡ªèº«</p>
<figure class="highlight dns"><table><tr><td class="code"><pre><span class="line">é»˜è®¤	<span class="number">23</span>:<span class="number">15</span>:<span class="number">53.643633</span> +<span class="number">0800</span>	pictureInMemory	-[AppDelegate applicationDidBecomeActive:]  åº”ç”¨çŠ¶æ€:<span class="number">0</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>UIKit</category>
      </categories>
      <tags>
        <tag>UIApplicationState</tag>
      </tags>
  </entry>
  <entry>
    <title>iOS APPç”Ÿå‘½å‘¨æœŸ</title>
    <url>/2018/12/09/iOS%20App%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/</url>
    <content><![CDATA[<p>é—®é¢˜:APPè¿›å…¥åå°åå¤§æ¦‚ä¸‰åˆ†é’Ÿå°±è¢«ç³»ç»Ÿkillæ‰äº†,å†æ¬¡è¿›å…¥éƒ½æ˜¯é‡æ–°å¯åŠ¨,å¯¹ç”¨æˆ·ä½“éªŒæœ‰ä¸€å®šå½±å“.</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜,é¦–å…ˆæ¥äº†è§£ä¸€ä¸‹ä¸€ä¸ªAPPçš„ç”Ÿå‘½å‘¨æœŸ.</p>
<h4 id="ä¸€ã€iOS-APPç”Ÿå‘½å‘¨æœŸ"><a href="#ä¸€ã€iOS-APPç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ä¸€ã€iOS APPç”Ÿå‘½å‘¨æœŸ"></a>ä¸€ã€iOS APPç”Ÿå‘½å‘¨æœŸ</h4><p>ä¸€ä¸ªiOS APPç”Ÿå‘½å‘¨æœŸå¤§æ¦‚æœ‰äº”ç§çŠ¶æ€.</p>
<p>å¦‚ä¸‹å›¾:</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/pictures/20210713102802.png" alt=""></p>
<ul>
<li><strong>Not running</strong>:appè¿˜æ²¡è¿è¡Œ.</li>
<li><strong>Inactive</strong>:appè¿è¡Œåœ¨å‰å°ä½†ä¸èƒ½æ¥æ”¶äº‹ä»¶.</li>
<li><strong>Active</strong>:appè¿è¡Œåœ¨å‰å°å¹¶ä¸”èƒ½å¤Ÿæ¥æ”¶äº‹ä»¶.</li>
<li><strong>Backgroud</strong>:ç¨‹åºåœ¨åå°å¹¶ä¸”èƒ½å¤Ÿæ‰§è¡Œä»£ç ,å¤§å¤šæ•°ç¨‹åºè¿›å…¥è¿™ä¸ªçŠ¶æ€åä¼šåœ¨è¿™ä¸ªçŠ¶æ€ä¸Šåœç•™ä¸€ä¼š(ä¸€èˆ¬å°±å‡ ç§’é’Ÿ,å¦‚æœæœ‰ç”³è¯·åå°è¿è¡Œå¤§æ¦‚ä¼šåœç•™180s).æ—¶é—´åˆ°ä¹‹åä¼šè¿›å…¥æŒ‚èµ·çŠ¶æ€(Suspended).ä½†æœ‰å‡ ç§ç‰¹å®šç±»å‹çš„APPå¯ä»¥é•¿æœŸå¤„äºBackgroudçŠ¶æ€.</li>
<li><strong>Suspended</strong>:ç¨‹åºåœ¨åå°ä¸èƒ½æ‰§è¡Œä»£ç .ç³»ç»Ÿä¼šè‡ªåŠ¨æŠŠç¨‹åºå˜æˆè¿™ä¸ªçŠ¶æ€è€Œä¸”ä¸ä¼šå‘å‡ºé€šçŸ¥.å½“æŒ‚èµ·æ—¶,ç¨‹åºè¿˜æ˜¯åœç•™åœ¨å†…å­˜ä¸­çš„,å½“ç³»ç»Ÿå†…å­˜ä½æ—¶,ç³»ç»Ÿå°±æŠŠæŒ‚èµ·çš„ç¨‹åºæ¸…é™¤æ‰,ä¸ºå‰å°ç¨‹åºæä¾›æ›´å¤šçš„å†…å­˜,å¹¶ä¸”ä¸ä¼šå‘å‡ºä»»ä½•é€šçŸ¥.</li>
</ul>
<p>ä»ä¸Šé¢çš„å›¾å¯ä»¥çœ‹å‡ºå¦‚æœæŒ‚èµ·çš„åº”ç”¨æ‰€å ç”¨çš„å†…å­˜è¿˜æ²¡æœ‰è¢«ç³»ç»Ÿå›æ”¶,åˆ™ç‚¹å‡»APPå›¾æ ‡æ—¶,åº”ç”¨ä¼šè¿›å…¥åå°,ç„¶åè¿›å…¥å‰å°,æ­¤æ—¶çœ‹åˆ°çš„ä»ç„¶æ˜¯ä¸Šä¸€æ¬¡çš„ç•Œé¢.ä½†å½“æŒ‚èµ·çš„åº”ç”¨æ‰€å ç”¨çš„å†…å­˜å·²ç»è¢«ç³»ç»Ÿå›æ”¶,åˆ™ç‚¹å‡»APPå›¾æ ‡æ—¶,ç›¸å½“äºé‡æ–°å¯åŠ¨.</p>
<p>äº†è§£äº†APPçš„ç”Ÿå‘½å‘¨æœŸå,å¯ä»¥çœ‹åˆ°æŒ‚èµ·çš„åº”ç”¨åªæœ‰åœ¨å†…å­˜ç´§å¼ çš„æƒ…å†µä¸‹æ‰ä¼šè¢«ç³»ç»Ÿæ¸…ç†,è¿™ç§æƒ…å†µæ˜¯æˆ‘ä»¬æ— æ³•æ§åˆ¶çš„.å› æ­¤å‡ºç°ä¸Šè¿°bugææœ‰å¯èƒ½æ˜¯ç¨‹åºè¿˜åœ¨è¿è¡Œæ—¶å°±è¢«ç³»ç»Ÿkillæ‰äº†.ç³»ç»Ÿä¸»åŠ¨killæ‰ä¸€ä¸ªAPPçš„æƒ…å†µå¹¶ä¸å¤šè§,ä¸»è¦æœ‰å¦‚ä¸‹å‡ ç§:</p>
<ul>
<li>APPå‡ºç°é—ªé€€</li>
<li>APPå†…å­˜å³°å€¼è¿‡é«˜</li>
<li>APPé•¿æ—¶é—´æ²¡æœ‰å“åº”äº‹ä»¶</li>
<li>æŸäº›ç‰¹æ®ŠAPIçš„é”™è¯¯ä½¿ç”¨</li>
</ul>
<p>ç”±äºAPPæ˜¯åœ¨åå°è¿è¡Œä¸€æ®µæ—¶é—´åè¢«killæ‰çš„,å› æ­¤ææœ‰å¯èƒ½æ˜¯æŸäº›ç‰¹æ®ŠAPIçš„é”™è¯¯ä½¿ç”¨å¯¼è‡´çš„,æœ€ç»ˆå‘ç°æ˜¯å‘ç³»ç»Ÿç”³è¯·åå°è¿è¡Œæ—¶é—´çš„APIé”™è¯¯ä½¿ç”¨å¯¼è‡´.</p>
<p><strong>å¯é•¿æœŸå¤„äºåå°çŠ¶æ€çš„åº”ç”¨ç±»å‹</strong></p>
<p>å¯¹äºéœ€è¦æ‰§è¡Œæ›´å¤šæ‰§è¡Œæ—¶é—´çš„ä»»åŠ¡ï¼Œå¿…é¡»è¯·æ±‚ç‰¹å®šæƒé™æ‰èƒ½åœ¨åå°è¿è¡Œå®ƒä»¬è€Œä¸ä¼šè¢«æŒ‚èµ·ã€‚åœ¨iOSä¸­ï¼Œåªå…è®¸åœ¨åå°è¿è¡Œç‰¹å®šçš„åº”ç”¨ç±»å‹ï¼š</p>
<ul>
<li>åœ¨åå°æ’­æ”¾ç”¨æˆ·å¯å¬å†…å®¹çš„åº”ç”¨ï¼Œä¾‹å¦‚éŸ³ä¹æ’­æ”¾å™¨åº”ç”¨</li>
<li>åœ¨åå°å½•åˆ¶éŸ³é¢‘å†…å®¹çš„åº”ç”¨ç¨‹åº</li>
<li>å¯è®©ç”¨æˆ·éšæ—¶äº†è§£å…¶ä½ç½®çš„åº”ç”¨ï¼Œä¾‹å¦‚å¯¼èˆªåº”ç”¨</li>
<li>æ”¯æŒäº’è”ç½‘åè®®è¯­éŸ³ï¼ˆVoIPï¼‰çš„åº”ç”¨</li>
<li>éœ€è¦å®šæœŸä¸‹è½½å’Œå¤„ç†æ–°å†…å®¹çš„åº”ç”¨</li>
<li>ä»å¤–éƒ¨é…ä»¶æ¥æ”¶å®šæœŸæ›´æ–°çš„åº”ç”¨ç¨‹åº</li>
</ul>
<h4 id="äºŒã€å¦‚ä½•å‘ç³»ç»Ÿç”³è¯·åå°è¿è¡Œæ—¶é—´"><a href="#äºŒã€å¦‚ä½•å‘ç³»ç»Ÿç”³è¯·åå°è¿è¡Œæ—¶é—´" class="headerlink" title="äºŒã€å¦‚ä½•å‘ç³»ç»Ÿç”³è¯·åå°è¿è¡Œæ—¶é—´"></a>äºŒã€å¦‚ä½•å‘ç³»ç»Ÿç”³è¯·åå°è¿è¡Œæ—¶é—´</h4><p>ç›¸å…³æ–¹æ³•:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">UIBackgroundTaskIdentifier</span>)beginBackgroundTaskWithExpirationHandler:(<span class="type">void</span>(^ __<span class="keyword">nullable</span>)(<span class="type">void</span>))handler  <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">4</span>_0) <span class="built_in">NS_REQUIRES_SUPER</span>;</span><br><span class="line">- (<span class="built_in">UIBackgroundTaskIdentifier</span>)beginBackgroundTaskWithName:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)taskName expirationHandler:(<span class="type">void</span>(^ __<span class="keyword">nullable</span>)(<span class="type">void</span>))handler <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">7</span>_0) <span class="built_in">NS_REQUIRES_SUPER</span>;</span><br><span class="line">- (<span class="type">void</span>)endBackgroundTask:(<span class="built_in">UIBackgroundTaskIdentifier</span>)identifier <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">4</span>_0) <span class="built_in">NS_REQUIRES_SUPER</span>;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡<code>beginBackgroundTaskWithExpirationHandler:</code>æ–¹æ³•å¯ä»¥å‘ç³»ç»Ÿç”³è¯·å¤§çº¦180s(iOS7)çš„åå°è¿è¡Œæ—¶é—´,æˆ–è€…600sï¼ˆiOS6ï¼‰è¿è¡Œæ—¶é—´ç”¨ä»¥å¤„ç†åå°æ“ä½œ.</p>
<p>ç¤ºä¾‹:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)backgroundDoSomethings &#123;</span><br><span class="line">    <span class="built_in">UIApplication</span> *application = [<span class="built_in">UIApplication</span> performSelector:<span class="keyword">@selector</span>(sharedApplication)];</span><br><span class="line">    __block <span class="built_in">UIBackgroundTaskIdentifier</span> bgTask = [application beginBackgroundTaskWithExpirationHandler:^&#123;</span><br><span class="line">        <span class="comment">// Clean up any unfinished task business by marking where you</span></span><br><span class="line">        <span class="comment">// stopped or ending the task outright.</span></span><br><span class="line">        [application endBackgroundTask:bgTask];</span><br><span class="line">        bgTask = <span class="built_in">UIBackgroundTaskInvalid</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Start the long-running task and return immediately.</span></span><br><span class="line">    [<span class="keyword">self</span> doSomethingWithCompletionBlock:^&#123;</span><br><span class="line">        [application endBackgroundTask:bgTask];</span><br><span class="line">        bgTask = <span class="built_in">UIBackgroundTaskInvalid</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)doSomethingWithCompletionBlock:(<span class="type">void</span> (^)(<span class="type">void</span>))completion</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">       </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;å¼€å§‹ç¡&quot;</span>);</span><br><span class="line">        sleep(<span class="number">175</span>);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;ç¡é†’&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (completion) &#123;</span><br><span class="line">            completion();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ç‰¹åˆ«æ³¨æ„</strong>:<br><code>beginBackgroundTaskWithExpirationHandler</code>ä¸€å®šè¦ä¸<code>endBackgroundTask</code>é…å¯¹ä½¿ç”¨,å¦åˆ™æ—¶é—´åˆ°åç³»ç»Ÿå°†ç›´æ¥killæ‰ä½ çš„APP,ä»è€Œå¯¼è‡´å¼€å¤´å‡ºç°çš„é—®é¢˜.</p>
<h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><p><a href="https://developer.apple.com/library/archive/documentation/iPhone/Conceptual/iPhoneOSProgrammingGuide/TheAppLifeCycle/TheAppLifeCycle.html#//apple_ref/doc/uid/TP40007072-CH2-SW1">App Programming Guide for iOS</a></p>
]]></content>
      <categories>
        <category>Foundation</category>
      </categories>
      <tags>
        <tag>Appç”Ÿå‘½å‘¨æœŸ</tag>
      </tags>
  </entry>
  <entry>
    <title>æ¸…ç†APPç¼“å­˜</title>
    <url>/2018/12/07/%E6%B8%85%E7%90%86APP%E7%BC%93%E5%AD%98/</url>
    <content><![CDATA[<h4 id="æ¸…ç†ç¼“å­˜"><a href="#æ¸…ç†ç¼“å­˜" class="headerlink" title="æ¸…ç†ç¼“å­˜"></a>æ¸…ç†ç¼“å­˜</h4><p>ä¸»è¦æ˜¯åˆ é™¤/Cachesç›®å½•ä¸‹çš„å†…å®¹.å¦‚æœå…¶ä»–è·¯å¾„ä¸Šçš„æ–‡ä»¶å¯ä»¥åˆ é™¤ä¹Ÿå¯ä»¥åŒ…å«è¿›æ¥.</p>
<p>iOS æ–‡ä»¶ç³»ç»Ÿä¹Ÿå¾—äº†è§£ä¸€ä¸‹<br><a href="https://developer.apple.com/library/archive/documentation/FileManagement/Conceptual/FileSystemProgrammingGuide/FileSystemOverview/FileSystemOverview.html#//apple_ref/doc/uid/TP40010672-CH2-SW12">iOS æ–‡ä»¶ç³»ç»Ÿ</a></p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">+ (<span class="built_in">NSUInteger</span>)getCachesSize &#123;</span><br><span class="line">    <span class="built_in">NSUInteger</span> size = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">NSFileManager</span> *fileManager = [<span class="built_in">NSFileManager</span> defaultManager];</span><br><span class="line">    <span class="built_in">NSString</span> *cachePath = [<span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSCachesDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>) lastObject];</span><br><span class="line">    <span class="built_in">NSDirectoryEnumerator</span> *fileEnumerator = [fileManager enumeratorAtPath:cachePath]; <span class="comment">//æšä¸¾æŒ‡å®šç›®å½•çš„æ‰€æœ‰æ–‡ä»¶åŒ…æ‹¬æ–‡ä»¶å¤¹.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *fileName <span class="keyword">in</span> fileEnumerator) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([fileName isEqualToString:<span class="string">@&quot;Snapshots&quot;</span>]) &#123;  <span class="comment">//&quot;/Snapshots&quot;æ˜¯ç³»ç»Ÿç”Ÿæˆçš„,åˆ äº†ä¹Ÿä¼šå†è‡ªåŠ¨åˆ›å»º,æ‰€ä»¥å°±ä¸è®¡ç®—äº†.</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">NSString</span> *filePath = [cachePath stringByAppendingPathComponent:fileName];</span><br><span class="line">        <span class="built_in">NSDictionary</span> *attrs = [fileManager attributesOfItemAtPath:filePath error:<span class="literal">nil</span>];</span><br><span class="line"><span class="comment">//        NSLog(@&quot;fileType:%@, fileName:%@&quot;, [attrs objectForKey:NSFileType], fileName);</span></span><br><span class="line"><span class="comment">//        NSLog(@&quot;filePath:%@&quot;, filePath);</span></span><br><span class="line">        size += [attrs fileSize];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="type">void</span>)clearCachesWithCompletionHandler:(<span class="type">void</span>(^)(<span class="type">void</span>))completionHandler &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">        <span class="built_in">NSFileManager</span> *fileManager = [<span class="built_in">NSFileManager</span> defaultManager];</span><br><span class="line">        <span class="built_in">NSString</span> * cachePath = [<span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSCachesDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>) lastObject];</span><br><span class="line">        <span class="built_in">NSDirectoryEnumerator</span> *fileEnumerator = [fileManager enumeratorAtPath:cachePath];</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSString</span> *fileName <span class="keyword">in</span> fileEnumerator) &#123;</span><br><span class="line">            <span class="keyword">if</span> ([fileName isEqualToString:<span class="string">@&quot;Snapshots&quot;</span>]) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">NSString</span> *filePath = [cachePath stringByAppendingPathComponent:fileName];</span><br><span class="line">            <span class="type">BOOL</span> removeRs = [fileManager removeItemAtPath:filePath error:<span class="literal">nil</span>];</span><br><span class="line">            <span class="keyword">if</span> (!removeRs) &#123;</span><br><span class="line">                <span class="built_in">NSDictionary</span> *attrs = [fileManager attributesOfItemAtPath:filePath error:<span class="literal">nil</span>];</span><br><span class="line">                DLog(<span class="string">@&quot;ç§»é™¤æ–‡ä»¶å¤±è´¥:fileType:%@, fileName:%@&quot;</span>, [attrs objectForKey:<span class="built_in">NSFileType</span>], fileName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            <span class="keyword">if</span> (completionHandler) &#123;</span><br><span class="line">                completionHandler();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>/Library/Caches/Snapshots/com.AppName/UIApplicationAutomaticSnapshotDefault-LandscapeLeft.png</code><br>â€œ/Snapshotsâ€è¯¥ç›®å½•ä¿å­˜çš„æ˜¯æŒ‰ä¸‹homeé”®æ—¶ç³»ç»Ÿå¯¹å½“å‰å±å¹•ç”Ÿæˆçš„ä¸€å¼ å¿«ç…§.</p>
<p>å‚è€ƒ:<a href="https://www.virtuesecurity.com/ios-background-screen-caching-2/">IOS BACKGROUND SCREEN CACHING</a></p>
<p><code>- (BOOL)removeItemAtPath:(NSString *)path error:(NSError * _Nullable *)error;</code>ä¼šç§»é™¤æ–‡ä»¶æˆ–ç›®å½•</p>
]]></content>
      <categories>
        <category>Foundation</category>
      </categories>
      <tags>
        <tag>æ–‡ä»¶ç³»ç»Ÿ</tag>
      </tags>
  </entry>
  <entry>
    <title>iOSå´©æºƒæ—¥å¿—å †æ ˆè§£æ</title>
    <url>/2018/12/05/iOS%E5%B4%A9%E6%BA%83%E6%97%A5%E5%BF%97%E5%A0%86%E6%A0%88%E8%A7%A3%E6%9E%90/</url>
    <content><![CDATA[<h3 id="iOSå´©æºƒæ—¥å¿—å †æ ˆè§£æ"><a href="#iOSå´©æºƒæ—¥å¿—å †æ ˆè§£æ" class="headerlink" title="iOSå´©æºƒæ—¥å¿—å †æ ˆè§£æ"></a>iOSå´©æºƒæ—¥å¿—å †æ ˆè§£æ</h3><p>æœ¬æ–‡åªä¸ºè‡ªå·±æŸ¥çœ‹æ–¹ä¾¿.</p>
<h4 id="dSYM-æ–‡ä»¶"><a href="#dSYM-æ–‡ä»¶" class="headerlink" title=".dSYM æ–‡ä»¶"></a>.dSYM æ–‡ä»¶</h4><p>æˆ‘ä»¬è°ƒè¯•çš„ symbols ä¼šåŒ…å«åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ã€‚</p>
<p>æ¯æ¬¡ç¼–è¯‘é¡¹ç›®çš„æ—¶å€™éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ dSYM æ–‡ä»¶ï¼Œæˆ‘ä»¬åº”è¯¥ä¿å­˜æ¯ä¸ªæ­£å¼å‘å¸ƒç‰ˆæœ¬çš„ dSYM æ–‡ä»¶ï¼Œä»¥å¤‡æˆ‘ä»¬æ›´å¥½çš„è°ƒè¯•é—®é¢˜ã€‚ä¸€èˆ¬æ˜¯åœ¨æˆ‘ä»¬ Archives æ—¶ä¿å­˜å¯¹åº”çš„ç‰ˆæœ¬æ–‡ä»¶çš„ï¼Œé‡Œé¢ä¹Ÿæœ‰å¯¹åº”çš„ .dSYM å’Œ .app æ–‡ä»¶ã€‚</p>
<h4 id="ç¬¦å·è§£æ"><a href="#ç¬¦å·è§£æ" class="headerlink" title="ç¬¦å·è§£æ"></a>ç¬¦å·è§£æ</h4><p>æ³¨æ„:.dSYM ã€.crashæ–‡ä»¶,äºŒè€…çš„UUIDå¿…é¡»ä¸€è‡´è§£ææ‰æœ‰æ„ä¹‰.</p>
<h5 id="è·å–-UUID"><a href="#è·å–-UUID" class="headerlink" title="è·å– UUID"></a>è·å– UUID</h5><p>.crash UUID</p>
<p><code>grep --after-context=2 &quot;Binary Images:&quot; *crash</code></p>
<p>.dSYM UUID</p>
<p><code>dwarfdump --uuid myCrashDemo.app.dSYM</code></p>
<p>.app UUID</p>
<p><code>dwarfdump --uuid myCrashDemo.app/myCrashDemo</code></p>
<h4 id="ä½¿ç”¨symbolicatecrashè¿›è¡Œè§£æ"><a href="#ä½¿ç”¨symbolicatecrashè¿›è¡Œè§£æ" class="headerlink" title="ä½¿ç”¨symbolicatecrashè¿›è¡Œè§£æ"></a>ä½¿ç”¨symbolicatecrashè¿›è¡Œè§£æ</h4><p>symbolicatecrash æ˜¯ Xcode è‡ªå¸¦çš„ crash æ—¥å¿—åˆ†æå·¥å…·.</p>
<p>é¦–å…ˆæŸ¥æ‰¾åˆ°å®ƒçš„è·¯å¾„:</p>
<p><code>find /Applications/Xcode.app -name symbolicatecrash</code></p>
<p>æŠŠ symbolicatecrash æ‹·è´å‡ºæ¥ï¼Œæ”¾åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹ã€‚</p>
<p>æœ‰ä¸¤ç§æ–¹å¼è§£æ:</p>
<ol>
<li><code>symbolicatecrash</code> + <code>.dSYM</code> + <code>.crash</code></li>
<li><code>symbolicatecrash</code> + <code>.app</code> + <code>.crash</code></li>
</ol>
<p><strong>åˆ©ç”¨ dSYM</strong></p>
<p>å°† .dSYM ã€.crash åŠ symbolicatecrash æ”¾åˆ°åŒä¸€ä¸ªæ–‡ä»¶ä¸‹ï¼Œæ‰§è¡Œå‘½ä»¤ï¼š</p>
<p><code>./symbolicatecrash .crashæ–‡ä»¶è·¯å¾„ .dSYMæ–‡ä»¶è·¯å¾„ &gt; åå­—.crash</code></p>
<p><strong>åˆ©ç”¨ app</strong></p>
<p>å°† .app ã€.crash åŠ symbolicatecrash æ”¾åˆ°åŒä¸€ä¸ªæ–‡ä»¶ä¸‹ï¼Œæ‰§è¡Œå‘½ä»¤ï¼š</p>
<p><code>./symbolicatecrash .crashæ–‡ä»¶è·¯å¾„ .app/appName è·¯å¾„ &gt; åå­—.crash</code></p>
<p>å¯èƒ½ä¼šæŠ¥é”™è¯¯ï¼š</p>
<p><code>Error: &quot;DEVELOPER_DIR&quot; is not defined at ./symbolicatecrash line 69.</code></p>
<p>æ‰§è¡Œä¸‹å‘½ä»¤å°±è¡Œï¼š</p>
<p><code>export DEVELOPER_DIR=/Applications/Xcode.app/Contents/Developer</code></p>
<p>ç„¶åå†é‡æ–°ç”Ÿæˆä¸‹æ–°çš„ .crash æ–‡ä»¶å°±è¡Œã€‚</p>
<h4 id="ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·-atos"><a href="#ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·-atos" class="headerlink" title="ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…· atos"></a>ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…· atos</h4><p>åŒæ ·ä¹Ÿæœ‰ä¸¤ç§æ–¹å¼</p>
<ol>
<li><code>.dSYM</code> + <code>.crash</code></li>
<li><code>.app</code> + <code>.crash</code></li>
</ol>
<p>.dSYMæ–¹å¼</p>
<p><code>xcrun atos -o ./myCrashDemo.app.dSYM/Contents/Resources/DWARF/myCrashDemo -arch æŒ‡ä»¤é›†(armv7æˆ–arm64) -l Slideåœ°å€</code></p>
<p>æ¥ç€è¾“å…¥é”™è¯¯çš„å†…å­˜åœ°å€,å³å¯çœ‹åˆ°.</p>
<p>.appæ–¹å¼</p>
<p><code>xcrun atos -o myCrashDemo.app/myCrashDemo -arch æŒ‡ä»¤é›†(armv7æˆ–arm64) -l Slideåœ°å€</code></p>
<p>æ¥ç€è¾“å…¥é”™è¯¯çš„å†…å­˜åœ°å€.</p>
<p>GitHub ä¸Šæœ‰ä¸ª<code>dSYMTools</code>å·¥å…·å°è£…äº†<code>atos</code>å‘½ä»¤ï¼Œå¯ä»¥è¾…åŠ©æˆ‘ä»¬è§£æ.</p>
<p>ä½¿ç”¨å¾ˆæ–¹ä¾¿,åªè¦æ‹–å…¥dSYMæ–‡ä»¶,ç„¶åå°†é”™è¯¯åœ°å€ä»¥åŠSlide Addressè¾“å…¥å·¥å…·çš„æ–‡æœ¬æ¡†ä¸­å³å¯.</p>
<h4 id="Slide-addressæŸ¥çœ‹"><a href="#Slide-addressæŸ¥çœ‹" class="headerlink" title="Slide addressæŸ¥çœ‹"></a>Slide addressæŸ¥çœ‹</h4><p>åœ¨å´©æºƒæ—¥å¿—é‡Œé¢æ‰¾åˆ° Binary IImages: è¿™ä¸€å—ï¼ŒBinary IImages: ä¸‹é¢ç¬¬ä¸€è¡Œå°±æ˜¯åŠ è½½åº”ç”¨å¯æ‰§è¡Œæ–‡ä»¶çš„ä¿¡æ¯ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š</p>
<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">Binary <span class="params">Images:</span></span><br><span class="line"><span class="number">0</span>x100878000 <span class="operator">-</span> <span class="number">0</span>x10087ffff myCrashDemo arm64  <span class="symbol">&lt;dc8bc710db863d2ca08180537af8015e&gt;</span> <span class="symbol">/var/containers/Bundle/Application/3BCB5A1C-9BD8-44CD-84EE-39128C005B9F/myCrashDemo.app/myCrashDemo</span></span><br><span class="line"><span class="number">0</span>x100938000 <span class="operator">-</span> <span class="number">0</span>x10099bfff dyld arm64  <span class="symbol">&lt;fc36be383ccf330abe42940868e68937&gt;</span> <span class="symbol">/usr/lib/dyld</span></span><br><span class="line"><span class="number">0</span>x102478000 <span class="operator">-</span> <span class="number">0</span>x102483fff libobjc-trampolines.dylib arm64  <span class="symbol">&lt;a8cd788cc9113887ae254bd47d58c7c1&gt;</span> <span class="symbol">/usr/lib/libobjc-trampolines.dylib</span></span><br><span class="line"><span class="number">0</span>x239546000 <span class="operator">-</span> <span class="number">0</span>x239547fff libSystem.B.dylib arm64  <span class="symbol">&lt;b3dbcc8e41b03e51b7e65d2800dcdea9&gt;</span> <span class="symbol">/usr/lib/libSystem.B.dylib</span></span><br><span class="line"><span class="number">0</span>x239548000 <span class="operator">-</span> <span class="number">0</span>x2395a2fff libc<span class="operator">++</span>.<span class="number">1</span>.dylib arm64  <span class="symbol">&lt;c406443c983a33829b164c441b7c2af4&gt;</span> <span class="symbol">/usr/lib/libc++.1.dylib</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ 0x100878000 å°±æ˜¯ slide addressã€‚<br>arm64 æŒ‡çš„æ˜¯ arm64 æ¶æ„ä¸‹ï¼Œuuid æ˜¯ dc8bc710db863d2ca08180537af8015e.</p>
<h4 id="é”™è¯¯çš„å†…å­˜åœ°å€æŸ¥çœ‹"><a href="#é”™è¯¯çš„å†…å­˜åœ°å€æŸ¥çœ‹" class="headerlink" title="é”™è¯¯çš„å†…å­˜åœ°å€æŸ¥çœ‹"></a>é”™è¯¯çš„å†…å­˜åœ°å€æŸ¥çœ‹</h4><p>å†…å­˜åœ°å€æ˜¯ Last Exception Backtraces ä¸­æ¯ä¸€è¡Œçš„ç¬¬ä¸€ä¸ªåœ°å€ï¼Œåˆ†æå…¶ä»–è¡Œçš„æ—¶å€™ä½ è¦çœ‹ä¸‹æ˜¯ä¸æ˜¯è‡ªå·±åº”ç”¨å¯æ‰§è¡Œæ–‡ä»¶é‚£è¡Œï¼Œå› ä¸ºä½ è¿™ä¸ª slide address åªå¯¹åº”åˆ°è‡ªå·±é‚£ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œç³»ç»Ÿçš„ä¸€äº›åº“çš„ slide address éƒ½ä¸ä¸€æ ·çš„ã€‚<br>å…¶å®åˆ†æä¸€ä¸ª crash æ–‡ä»¶å¹¶ä¸è¦å¾ˆé•¿æ—¶é—´ï¼Œåªéœ€è¦æ‰¾åˆ°è‡ªå·±å¯æ‰§è¡Œæ–‡ä»¶å¯¹åº”çš„é‚£è¡Œå†…å­˜åœ°å€ï¼Œslide addressï¼Œå’Œ arch type è¿™ä¸‰ä¸ªä¿¡æ¯å°±å¯ä»¥äº†ï¼Œå¹¶ä¸æ˜¯æ¯ä¸€è¡Œé”™è¯¯ä¿¡æ¯éƒ½éœ€è¦çœ‹ã€‚</p>
]]></content>
      <categories>
        <category>Foundation</category>
      </categories>
      <tags>
        <tag>å´©æºƒæ—¥å¿—è§£æ</tag>
      </tags>
  </entry>
  <entry>
    <title>iOS APPåå°è¿è¡Œæ—¶é—´æ¢ç©¶åŠå»¶é•¿</title>
    <url>/2018/11/25/iOS%20APP%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8C%E6%97%B6%E9%97%B4%E6%8E%A2%E7%A9%B6%E5%8F%8A%E5%BB%B6%E9%95%BF/</url>
    <content><![CDATA[<p>å®éªŒè®¾å¤‡:iPhone7plus iOS12.1</p>
<p>é—®é¢˜:å‘ç°å¸‚é¢ä¸Šå¾ˆå¤šAPPè¿›å…¥åå°å,è¿‡äº†16minç”šè‡³20minå,å†æ¬¡ç‚¹å‡»APP,éƒ½èƒ½å¤Ÿä¿æŒåœ¨åŸæ¥çš„é¡µé¢.è€Œæˆ‘ä»¬è‡ªå·±çš„APP,è¿›å…¥åå°è¿‡ä¸ªä¸‰åˆ†é’Ÿå°±è¢«killæ‰äº†,å†æ¬¡è¿›å…¥éƒ½æ˜¯é‡æ–°å¯åŠ¨.<br>ç½‘æ˜“æ–°é—»APP,ä¸»ç«™APP,å–œé©¬æ‹‰é›…APPéƒ½ä¸ä¼š.ä¸ºä»€ä¹ˆæˆ‘ä»¬çš„APPåœ¨æŒ‚èµ·åä¼šè¿™ä¹ˆå¿«è¢«ç³»ç»Ÿä»å†…å­˜ä¸­æ¸…ç†?è€Œåˆ«çš„APPå´ä¸ä¼š.</p>
<p>ç›®å‰app,æ²¡æœ‰åšä»»ä½•ç‰¹åˆ«å¤„ç†,ç”³è¯·çš„æƒé™ä¹Ÿå¾ˆå¸¸è§„,å¦‚ä¸‹:</p>
<p><img src="https://portal.qiniu.com/" alt="APPåå°æ¨¡å¼"></p>
<p>è§£å†³:ç»è¿‡ä¸æ–­çš„åˆ†æ,æœ€ç»ˆå‘ç°æ˜¯ä»£ç ä¸­åœ¨å‘ç³»ç»Ÿç”³è¯·åå°è¿è¡Œæ—¶é—´é”™è¯¯ä½¿ç”¨å¯¼è‡´,åœ¨è°ƒç”¨<code>beginBackgroundTaskWithExpirationHandler</code>å,æ²¡æœ‰é…å¯¹è°ƒç”¨<code>endBackgroundTask:</code>.</p>
<p>åæ§½:æœ‰æ—¶å€™å·¥ç¨‹ä¸€å¤§,å‡ºç°ä¸€äº›BUGçœŸçš„å¾ˆéš¾åˆ†æåŸå› .</p>
<h3 id="å‘ç³»ç»Ÿç”³è¯·åå°è¿è¡Œæ—¶é—´"><a href="#å‘ç³»ç»Ÿç”³è¯·åå°è¿è¡Œæ—¶é—´" class="headerlink" title="å‘ç³»ç»Ÿç”³è¯·åå°è¿è¡Œæ—¶é—´"></a>å‘ç³»ç»Ÿç”³è¯·åå°è¿è¡Œæ—¶é—´</h3><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)backgroundDoSomethings &#123;</span><br><span class="line">    <span class="built_in">UIApplication</span> *application = [<span class="built_in">UIApplication</span> performSelector:<span class="keyword">@selector</span>(sharedApplication)];</span><br><span class="line">    __block <span class="built_in">UIBackgroundTaskIdentifier</span> bgTask = [application beginBackgroundTaskWithExpirationHandler:^&#123;</span><br><span class="line">        <span class="comment">// Clean up any unfinished task business by marking where you</span></span><br><span class="line">        <span class="comment">// stopped or ending the task outright.</span></span><br><span class="line">        [application endBackgroundTask:bgTask];</span><br><span class="line">        bgTask = <span class="built_in">UIBackgroundTaskInvalid</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Start the long-running task and return immediately.</span></span><br><span class="line">    [<span class="keyword">self</span> doSomethingWithCompletionBlock:^&#123;</span><br><span class="line">        [application endBackgroundTask:bgTask];</span><br><span class="line">        bgTask = <span class="built_in">UIBackgroundTaskInvalid</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)doSomethingWithCompletionBlock:(<span class="type">void</span> (^)(<span class="type">void</span>))completion</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">       </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;å¼€å§‹ç¡&quot;</span>);</span><br><span class="line">        sleep(<span class="number">175</span>); <span class="comment">//200x 170âˆš 180x 175âˆš</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;ç¡é†’&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (completion) &#123;</span><br><span class="line">            completion();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®æµ‹è¿è¡Œçš„æ—¶é—´å¤§è‡´åœ¨175så·¦å³,å°äº180s.å³é€šè¿‡<code>beginBackgroundTaskWithExpirationHandler:</code>æ–¹æ³•å¯ä»¥å‘ç³»ç»Ÿç”³è¯·å¤§çº¦180sçš„åå°è¿è¡Œæ—¶é—´.</p>
<p>ç›¸å…³æ–¹æ³•:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">UIBackgroundTaskIdentifier</span>)beginBackgroundTaskWithExpirationHandler:(<span class="type">void</span>(^ __<span class="keyword">nullable</span>)(<span class="type">void</span>))handler  <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">4</span>_0) <span class="built_in">NS_REQUIRES_SUPER</span>;</span><br><span class="line">- (<span class="built_in">UIBackgroundTaskIdentifier</span>)beginBackgroundTaskWithName:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)taskName expirationHandler:(<span class="type">void</span>(^ __<span class="keyword">nullable</span>)(<span class="type">void</span>))handler <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">7</span>_0) <span class="built_in">NS_REQUIRES_SUPER</span>;</span><br><span class="line">- (<span class="type">void</span>)endBackgroundTask:(<span class="built_in">UIBackgroundTaskIdentifier</span>)identifier <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">4</span>_0) <span class="built_in">NS_REQUIRES_SUPER</span>;</span><br></pre></td></tr></table></figure>
<p><strong>ç‰¹åˆ«æ³¨æ„</strong>:<br><code>beginBackgroundTaskWithExpirationHandler</code>ä¸€å®šè¦ä¸<code>endBackgroundTask</code>é…å¯¹ä½¿ç”¨,å¦åˆ™æ—¶é—´åˆ°åç³»ç»Ÿå°†ç›´æ¥killæ‰ä½ çš„APP.</p>
<h3 id="å¦‚ä½•å»¶é•¿APPåå°è¿è¡Œæ—¶é—´-ç”šè‡³æ— é™é•¿"><a href="#å¦‚ä½•å»¶é•¿APPåå°è¿è¡Œæ—¶é—´-ç”šè‡³æ— é™é•¿" class="headerlink" title="å¦‚ä½•å»¶é•¿APPåå°è¿è¡Œæ—¶é—´?ç”šè‡³æ— é™é•¿."></a>å¦‚ä½•å»¶é•¿APPåå°è¿è¡Œæ—¶é—´?ç”šè‡³æ— é™é•¿.</h3><p>ä»¥åæœ‰ç©ºç ”ç©¶.</p>
]]></content>
      <categories>
        <category>Foundation</category>
      </categories>
      <tags>
        <tag>åå°è¿è¡Œ</tag>
      </tags>
  </entry>
  <entry>
    <title>æ•°ç»„å»é‡æ·»åŠ å…ƒç´ Blockæ–¹å¼å®ç°</title>
    <url>/2018/09/28/%E6%95%B0%E7%BB%84%E5%8E%BB%E9%87%8D%E6%B7%BB%E5%8A%A0%E5%85%83%E7%B4%A0/</url>
    <content><![CDATA[<p>æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦è¯¥å…ƒç´ ä¸åœ¨è¯¥æ•°ç»„ä¸­æ—¶æ‰æ·»åŠ .</p>
<p>ç”±äºä½¿ç”¨åœºæ™¯è¿˜ç®—æ¯”è¾ƒå¤š,æ‰€ä»¥è‡ªå·±ç®€å•å°è£…äº†ä¸€ä¸‹.è¿™é‡Œç”¨blockä½œä¸ºè¿‡æ»¤æ¡ä»¶,ä½¿ç”¨è¿˜æ˜¯å¾ˆæ–¹ä¾¿çš„.</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSMutableArray</span> (<span class="title">Tool</span>)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> æ•°ç»„å»é‡æ·»åŠ å•ä¸ªå…ƒç´ </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @param anObject è¢«æ·»åŠ çš„å…ƒç´ </span></span><br><span class="line"><span class="comment"> @param filterBlk è¿‡æ»¤æ¡ä»¶.elementä¸ºåŸæ•°ç»„çš„å…ƒç´ ,anObjectä¸ºè¢«æ·»åŠ çš„å…ƒç´ .</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="type">void</span>)addObject:(<span class="type">id</span>)anObject filter:(<span class="type">BOOL</span> (^)(<span class="type">id</span> element, <span class="type">id</span> anObject))filterBlk;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> æ•°ç»„å»é‡æ·»åŠ ä¸€ä¸ªæ•°ç»„é‡Œçš„å…ƒç´ </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @param otherArray è¢«æ·»åŠ çš„æ•°ç»„</span></span><br><span class="line"><span class="comment"> @param filterBlk è¿‡æ»¤æ¡ä»¶.elementä¸ºåŸæ•°ç»„çš„å…ƒç´ ,anObjectä¸ºè¢«æ·»åŠ çš„æ•°ç»„çš„å…ƒç´ .</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="type">void</span>)addObjectsFromArray:(<span class="built_in">NSArray</span> *)otherArray filter:(<span class="type">BOOL</span> (^)(<span class="type">id</span> element, <span class="type">id</span> anObject))filterBlk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSMutableArray</span> (<span class="title">Tool</span>)</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)addObject:(<span class="type">id</span>)anObject filter:(<span class="type">BOOL</span> (^)(<span class="type">id</span>, <span class="type">id</span>))filterBlk</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (anObject == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">BOOL</span> isExist = <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">id</span> obj <span class="keyword">in</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!filterBlk(obj, anObject)) &#123;</span><br><span class="line">            isExist = <span class="literal">YES</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!isExist) &#123;</span><br><span class="line">        [<span class="keyword">self</span> addObject:anObject];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)addObjectsFromArray:(<span class="built_in">NSArray</span> *)otherArray filter:(<span class="type">BOOL</span> (^)(<span class="type">id</span>, <span class="type">id</span>))filterBlk</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (otherArray.count == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">id</span> element <span class="keyword">in</span> otherArray) &#123;</span><br><span class="line">        [<span class="keyword">self</span> addObject:element filter:filterBlk];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨å¦‚ä¸‹:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSMutableArray</span> *mArr = [@[<span class="string">@&quot;3&quot;</span>, <span class="string">@&quot;4&quot;</span>, <span class="string">@&quot;5&quot;</span>, <span class="string">@&quot;33&quot;</span>, <span class="string">@&quot;7&quot;</span>] mutableCopy];</span><br><span class="line">[mArr addObject:<span class="string">@&quot;57&quot;</span> filter:^<span class="type">BOOL</span>(<span class="built_in">NSString</span> *element, <span class="built_in">NSString</span> *anObject) &#123;</span><br><span class="line">    <span class="keyword">return</span> ![element isEqualToString:anObject]; <span class="comment">//ä¸ç­‰äºå…¶ä¸­ä»»ä½•ä¸€ä¸ªå…ƒç´ æ‰æ·»åŠ </span></span><br><span class="line">&#125;];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, mArr);</span><br><span class="line">    </span><br><span class="line"><span class="built_in">NSArray</span> *arr = @[<span class="string">@&quot;1&quot;</span>, <span class="string">@&quot;2&quot;</span>, <span class="string">@&quot;3&quot;</span>, <span class="string">@&quot;13&quot;</span>, <span class="string">@&quot;7&quot;</span>];</span><br><span class="line">[mArr addObjectsFromArray:arr filter:^<span class="type">BOOL</span>(<span class="built_in">NSString</span> *element, <span class="built_in">NSString</span> *anObject) &#123;</span><br><span class="line">    <span class="keyword">return</span> ![element isEqualToString:anObject]; <span class="comment">//ä¸ç­‰äºå…¶ä¸­ä»»ä½•ä¸€ä¸ªå…ƒç´ æ‰æ·»åŠ </span></span><br><span class="line">&#125;];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, mArr);</span><br></pre></td></tr></table></figure>
<p>æ‰“å°å¦‚ä¸‹:</p>
<figure class="highlight autohotkey"><table><tr><td class="code"><pre><span class="line"><span class="number">2018</span>-<span class="number">09</span>-<span class="number">28</span> <span class="number">20</span>:<span class="number">52</span>:<span class="number">39.060469</span>+<span class="number">0800</span> testDemo[<span class="number">94995</span>:<span class="number">18270135</span>] (</span><br><span class="line"><span class="built_in">    3,</span></span><br><span class="line"><span class="built_in">    4,</span></span><br><span class="line"><span class="built_in">    5,</span></span><br><span class="line"><span class="built_in">    33,</span></span><br><span class="line"><span class="built_in">    7,</span></span><br><span class="line">    <span class="number">57</span></span><br><span class="line">)</span><br><span class="line"><span class="number">2018</span>-<span class="number">09</span>-<span class="number">28</span> <span class="number">20</span>:<span class="number">52</span>:<span class="number">39.060571</span>+<span class="number">0800</span> testDemo[<span class="number">94995</span>:<span class="number">18270135</span>] (</span><br><span class="line"><span class="built_in">    3,</span></span><br><span class="line"><span class="built_in">    4,</span></span><br><span class="line"><span class="built_in">    5,</span></span><br><span class="line"><span class="built_in">    33,</span></span><br><span class="line"><span class="built_in">    7,</span></span><br><span class="line"><span class="built_in">    57,</span></span><br><span class="line"><span class="built_in">    1,</span></span><br><span class="line"><span class="built_in">    2,</span></span><br><span class="line">    <span class="number">13</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå¯ä»¥ä½¿ç”¨æ¨¡å‹ä¸­çš„æŸä¸ªå±æ€§ä½œä¸ºåˆ¤æ–­æ¡ä»¶:</p>
<figure class="highlight wren"><table><tr><td class="code"><pre><span class="line">[<span class="variable">audienceList</span> <span class="variable">addObjectsFromArray</span>:<span class="variable">self</span>.<span class="property">audienceList</span> <span class="variable">filter</span>:<span class="operator">^</span><span class="title function_">BOOL</span>(<span class="params">ZAEAudienceModel</span> *<span class="params">element</span>, <span class="params">ZAEAudienceModel</span> *<span class="params">anObject</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="operator">!</span>[<span class="variable">element</span>.<span class="property">userID</span> isEqualToString:<span class="variable">anObject</span>.<span class="property">userID</span>];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Foundation</category>
      </categories>
      <tags>
        <tag>NSMutableArray</tag>
      </tags>
  </entry>
  <entry>
    <title>å®šæ—¶å™¨å¯ç¤ºå½•</title>
    <url>/2018/09/21/%E5%AE%9A%E6%97%B6%E5%99%A8%E5%90%AF%E7%A4%BA%E5%BD%95/</url>
    <content><![CDATA[<p>æ—©äº›æ—¶å€™çœ‹è¿‡ä¸€äº›åˆ†æå®šæ—¶å™¨å†…å­˜æ–¹é¢çš„æ–‡ç« ï¼Œä½†åœ¨é‡åˆ°è¿™ä¸ªbugå‰æˆ‘æ˜¯ä¸å±‘çš„ã€‚ä¸å°±æ˜¯å®šæ—¶å™¨å¼ºå¼•ç”¨ViewControllerï¼Œè€ŒViewControllerå†ç”¨strongå±æ€§å»å¼•ç”¨å®šæ—¶å™¨ï¼Œå¿…ç„¶ä¼šå¯¼è‡´å¾ªç¯å¼•ç”¨ä¹ˆã€‚è§£å†³åŠæ³•ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€ä½¿ç”¨weakå±æ€§å»å¼•ç”¨å®šæ—¶å™¨å³å¯ã€‚ç„¶è€Œè¿™ä¸€æ¬¡çš„ç»å†å´è¯æ˜æˆ‘è¿˜æ˜¯å›¾æ ·ï¼Œæˆ‘å•çŸ¥é“ä½¿ç”¨weakå±æ€§ä¸ä¼šå¯¼è‡´å¾ªç¯å¼•ç”¨ï¼Œæˆ‘æ²¡æ³¨æ„åˆ°æ­¤æ—¶çš„å®šæ—¶å™¨åœ¨æ— å½¢ä¸­å»¶é•¿äº†ViewControllerçš„ç”Ÿå‘½å‘¨æœŸã€‚è¿™å°±ä¸ºè¿™ä¸ªbugåŸ‹ä¸‹äº†éšæ‚£ã€‚</p>
<p>è®°å½•ä¸€ä¸‹bugçš„è§£å†³æ€»æ˜¯æœ‰å¿…è¦çš„ã€‚</p>
<p>ä¸‹åˆçš„ä¸€æ¬¡è‡ªæµ‹ä¸­ï¼Œå¶å°”å‘ç°è§‚ä¼—ç«¯å¬ä¸åˆ°ä¸»æ’­ç«¯çš„å£°éŸ³ã€‚æˆ‘å…ˆæ˜¯è¯§å¼‚ï¼Œæ¥ç€æ˜¯å¾ˆä¸å®‰ï¼Œå› ä¸ºå¢¨è²å®šå¾‹å‘Šè¯‰æˆ‘ä»¬ï¼šå¦‚æœä½ æ‹…å¿ƒæŸç§æƒ…å†µå‘ç”Ÿï¼Œé‚£ä¹ˆå®ƒå°±æ›´æœ‰å¯èƒ½å‘ç”Ÿã€‚æœ€å¼€å§‹ä»¥ä¸ºæ˜¯ä¸»æ’­ç«¯çš„é—®é¢˜ï¼Œä¾¿ä»”ç»†æ£€æŸ¥äº†ä¸»æ’­ç«¯çš„ä»£ç ï¼ŒåˆåŠ å…¥äº†å¦ä¸€å°æ‰‹æœºè®¾ç½®ä¸ºè§‚ä¼—ï¼Œä½œä¸ºå¯¹ç…§ã€‚è¿è¡Œä¹‹åå‘ç°å¯¹ç…§ç»„æ˜¯å¥½çš„ï¼Œä½†åˆšæ‰é‚£å°æ‰‹æœºçš„é—®é¢˜ä»ç„¶å¶ç°ã€‚è¿™å°±è¯´æ˜ä¸»æ’­ç«¯çš„æ¨æµæ˜¯æ²¡é—®é¢˜çš„ã€‚æ¥ä¸‹æ¥çš„å·¥ä½œä¾¿æ˜¯åœ¨é—®é¢˜æ‰‹æœºä¸Šå°½å¯èƒ½æ‰¾åˆ°å¤ç°çš„æ“ä½œï¼Œä»¥ä¾¿æ ¹æ®æ“ä½œè·¯å¾„å®šä½å¤§è‡´åŸå› ã€‚åœ¨æŸæ¬¡é¢‘ç¹è¿›å…¥ç¦»å¼€ç›´æ’­æˆ¿é—´æ—¶ï¼ŒAPPç›´æ¥å¡æ­»äº†ï¼Œå†æ— ä»»ä½•äº¤äº’çš„å“åº”ã€‚é—®é¢˜å¼€å§‹å˜å¾—ä¸¥é‡ï¼Œæ—¶é—´ä¹Ÿä¸€åˆ†ä¸€ç§’çš„æµé€åœ¨è¿™ä¸€æ¬¡æ¬¡çš„è°ƒè¯•ä¸­ï¼Œä¸€æ™ƒä¸‹ç­æ—¶é—´å¿«åˆ°äº†ï¼Œå‘¨å›´å¼€å§‹å˜çš„å˜ˆæ‚ï¼Œå®‰å“å…„å¼Ÿå¼€å§‹å‚¬æˆ‘ä¸‹ç­è¿˜è¯´è¦å¸¦æˆ‘ä¸Šç‹è€…ä½†æˆ‘æ˜¯ä¸ä¿¡çš„ã€‚æˆ‘æ•´ç†äº†ä¸‹ä¸œè¥¿ï¼Œä½†åˆä¸æƒ³åœ¨èŠ‚å‰ç•™ä¸‹äº›è®¸é—®é¢˜ï¼Œä¾¿åˆåäº†å›å»ã€‚ç­‰åˆ°å‘¨å›´å¼€å§‹å®‰é™æ—¶ï¼Œå¤•é˜³å·²ç»è¥¿ä¸‹ã€‚æˆ‘åŠªåŠ›å›æƒ³ä¹‹å‰çš„æ“ä½œï¼Œå‘ç°åªåœ¨ç›´æ’­é¢„çº¦çŠ¶æ€ä¸‹ï¼Œé—®é¢˜æ‰ä¼šé‡ç°ã€‚äºæ˜¯åœ¨é¡µé¢çš„deallocå‡½æ•°ä¸­æ‰“å¥½æ–­ç‚¹ï¼Œç‚¹å‡»è¿”å›ï¼Œæœç„¶å‡½æ•°æ²¡æœ‰è¢«è°ƒç”¨ã€‚è¿™è¯´æ˜é¡µé¢ä¾ç„¶è¢«æŸä¸ªå¯¹è±¡æŒæœ‰è€Œæ²¡æœ‰é‡Šæ”¾ã€‚åœ¨æ£€æŸ¥äº†æ‰€æœ‰Blockå›è°ƒéƒ½ä½¿ç”¨çš„æ˜¯weakSelfåï¼Œæœ€ååªå‰©ä¸‹å®šæ—¶å™¨äº†ã€‚</p>
<p>é—®é¢˜çš„æ ¹æºç®—æ˜¯æ‰¾åˆ°äº†ã€‚åŸæ¥åœ¨ç›´æ’­é¢„çº¦çŠ¶æ€ä¸‹ä¼šå¯åŠ¨ä¸€ä¸ªå®šæ—¶å™¨ï¼Œä½†åœ¨ç‚¹å‡»è¿”å›æ—¶å¿˜è®°invalidå®šæ—¶å™¨äº†ã€‚è¿™è®©å®šæ—¶å™¨å»¶é•¿äº†ViewControllerçš„ç”Ÿå‘½å‘¨æœŸã€‚åŠ ä¸Šinvalidåï¼Œé—®é¢˜æå®šï¼Œæ”¶å·¥ã€‚å›å®¶çš„è·¯ä¸Šç¢°å·§é‡åˆ°äº†Kå›ï¼Œä¾¿ç»™Kå›è®²è¿°äº†è¿™ä¸ªé—®é¢˜ï¼ŒKå›å¬åå“ˆå“ˆå¤§ç¬‘è¯´ï¼šåŠ ä¸Šinvalidåªèƒ½è§£å†³è¿™ä¸€æ¬¡çš„bugï¼Œå´ä¸èƒ½é¿å…ä¸‹ä¸€æ¬¡åˆå¿˜è®°ï¼Œè€Œä¸”æ ¹æ®é¡µé¢deallocå‡½æ•°é‡Œé€»è¾‘çš„ä¸åŒï¼Œbugçš„å¤–åœ¨è¡¨ç°å½¢å¼ä¹Ÿå¿…ç„¶ä¸åŒï¼Œåˆ°æ—¶å€™åˆå¾—èŠ±è´¹ä¸å°‘çš„æ—¶é—´æ‰¾bugå•Šã€‚é—»é“äºæœï¼Œä¸ç¦æ„Ÿå¹Kå›çš„èº«ç»ç™¾æˆ˜ã€‚</p>
<p>å›åˆ°å®¶åï¼Œæ‰“å¼€è°·æ­Œåˆæœåˆ°äº†æ—©äº›æ—¶å€™çœ‹è¿‡çš„é‚£äº›æ–‡ç« ï¼Œæ„Ÿæ…¨é¢‡å¤šã€‚ç³»ç»Ÿçš„<code>NSTimer</code>ç®€å•å´åˆä¸é‚£ä¹ˆç®€å•ï¼š</p>
<ol>
<li><p>ä¸æ³¨æ„ä½¿ç”¨çš„è¯æœ‰å¾ªç¯å¼•ç”¨çš„éšæ‚£ã€‚å› ä¸ºNSTimerä¼šå¼ºå¼•ç”¨targetï¼Œå¦‚æœtargetå†å¼ºå¼•ç”¨NSTimeré‚£ä¹ˆå°±ä¼šå‘ç”Ÿå¾ªç¯å¼•ç”¨ã€‚æ¯”å¦‚ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)test_normal_timer1 &#123;</span><br><span class="line">    <span class="keyword">self</span>.normalStrongTimer = [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">1</span> target:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(doSome) userInfo:<span class="literal">nil</span> repeats:<span class="literal">YES</span>];</span><br><span class="line">    [[<span class="built_in">NSRunLoop</span> currentRunLoop] addTimer:<span class="keyword">self</span>.normalStrongTimer forMode:<span class="built_in">NSRunLoopCommonModes</span>];</span><br><span class="line">    [<span class="keyword">self</span>.normalStrongTimer fire];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç å°±ä¼šå‘ç”Ÿå¾ªç¯å¼•ç”¨ã€‚æ­¤æ—¶å³ä½¿é¡µé¢è¿”å›ï¼Œä½†æ˜¯å› ä¸ºå¾ªç¯å¼•ç”¨ï¼ŒViewControllerçš„deallocå°†ä¸ä¼šè¢«æ‰§è¡Œï¼Œå› æ­¤invalidateä¸èƒ½æ”¾åœ¨deallocé‡Œï¼Œåªèƒ½åœ¨å…¶ä»–æ—¶æœºæ¯”å¦‚viewDidDisappearé‡Œè°ƒç”¨ã€‚æ‰€ä»¥ä¸€èˆ¬ä½¿ç”¨weakæ¥å¼±å¼•ç”¨å®šæ—¶å™¨ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨deallocé‡Œè°ƒç”¨invalidateã€‚</p>
</li>
<li><p>éœ€è¦åœ¨åˆé€‚çš„åœ°æ–¹invalidå®šæ—¶å™¨ï¼Œå¦åˆ™å®šæ—¶å™¨ä¼šä¸€ç›´å¼ºå¼•ç”¨targetä»è€Œå»¶é•¿targetçš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
<p>åœ¨å¼€å‘ä¸­å¾ˆå®¹æ˜“å¿˜è®°invalidå®šæ—¶å™¨ï¼Œä¸€æ—¦å¿˜è®°invalidå®šæ—¶å™¨ï¼Œå®šæ—¶å™¨å°±ä¼šå»¶é•¿targetçš„ç”Ÿå‘½å‘¨æœŸï¼Œæ¯”å¦‚é¡µé¢è¿”å›äº†ä½†å®é™…è¿˜æ²¡æœ‰è¢«é”€æ¯ï¼Œä»è€Œäº§ç”Ÿä¸€äº›è¯¡å¼‚é—®é¢˜ã€‚è¿™ä¹Ÿæ˜¯ä½¿ç”¨NSTimerå¿…é¡»æ³¨æ„çš„åœ°æ–¹ã€‚</p>
</li>
<li><p>ä½¿ç”¨æ—¶å¿…é¡»ä¿è¯æœ‰ä¸€ä¸ªæ´»è·ƒçš„runloopï¼Œå¹¶ä¸”éœ€è¦æŒ‡å®šmodeã€‚åœ¨å­çº¿ç¨‹ä¸­ä½¿ç”¨ä¸æ˜¯å¾ˆæ–¹ä¾¿ã€‚</p>
</li>
<li><p>ç²¾åº¦å¯èƒ½ä¸å¤Ÿã€‚</p>
</li>
<li><p>ç½‘ä¸Šçš„ä¸€ä¸ªè¯´æ³•ï¼šåˆ›å»ºå’Œæ’¤é”€å¿…é¡»åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸Šï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä½¿ç”¨ä¸ä¾¿ã€‚(è¿™ä¸€æ¡å­˜ç–‘ï¼Œç»è¿‡éªŒè¯åœ¨å­çº¿ç¨‹åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼Œåœ¨å¦ä¸€ä¸ªå­çº¿ç¨‹invalidateå¹¶æ²¡æœ‰å‘ç°ä»€ä¹ˆé—®é¢˜)</p>
</li>
<li><p>iOS10å¼€å§‹æ”¯æŒblockä½¿ç”¨ï¼ŒåŒæ ·åœ¨ä½¿ç”¨blockæ—¶ä¸€å®šè¦æ³¨æ„å¾ªç¯å¼•ç”¨ã€‚</p>
</li>
</ol>
<p>ä¸ºäº†ä»æ ¹æœ¬ä¸Šé¿å…ä¸Šè¿°é—®é¢˜ï¼Œä¸€ä¸ªå¼±å¼•ç”¨targetçš„ã€èƒ½å¤Ÿåœ¨è‡ªèº«é”€æ¯æ—¶è‡ªåŠ¨invalidçš„å®šæ—¶å™¨æƒ³å¿…æ˜¯æå¥½çš„ï¼Œä½†åˆè¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿå¥½åœ¨äº’è”ç½‘åœ¨ç»è¿‡è¿™ä¹ˆå¤šå¹´çš„å‘å±•ï¼Œç¬¬ä¸‰æ–¹å¼€æºåº“ä»æœªåƒç°åœ¨è¿™èˆ¬ä¸°å¯Œï¼Œå”¾æ‰‹å¯å¾—ã€‚ä¸å¤šæ—¶ï¼Œä¾¿åœ¨GitHubä¸Šæ‰¾åˆ°äº†<a href="https://githubã€‚com/mindsnacks/MSWeakTimer">MSWeakTimer</a>ã€‚</p>
<p><code>MSWeakTimer</code>æä¾›äº†å’Œç³»ç»Ÿ<code>NSTimer</code>ä¸€è‡´çš„æ¥å£ï¼Œå¥½çš„ä»£ç å°±è¯¥è¿™æ ·ç¾ç¾ä¸å…±ï¼Œå’Œè€Œä¸åŒï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) MSWeakTimer *weakTimer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>.weakTimer = [MSWeakTimer scheduledTimerWithTimeInterval:<span class="number">3</span> target:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(doSome) userInfo:<span class="literal">nil</span> repeats:<span class="literal">YES</span> dispatchQueue:dispatch_get_main_queue()];</span><br><span class="line"><span class="comment">//ç«‹å³è§¦å‘å›è°ƒæ–¹æ³•</span></span><br><span class="line">[<span class="keyword">self</span>.weakTimer fire];</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)doSome &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;++++++%@&quot;</span>, <span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‡³äº<code>MSWeakTimer</code>çš„å®ç°åŸç†è‡ªç„¶æ˜¯å’Œ<code>NSTimer</code>ä¸åŒçš„ï¼šé€šè¿‡å°è£…GCDå®šæ—¶å™¨å®ç°<code>NSTimer</code>çš„åŠŸèƒ½ï¼Œä½†å†…éƒ¨å´æ˜¯å¼±å¼•ç”¨targetï¼Œä¸ä»…å¦‚æ­¤<code>MSWeakTimer</code>è¿˜æ”¯æŒåœ¨å…¶ä»–çº¿ç¨‹ä¸­æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MSWeakTimer</span> ()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">struct</span></span><br><span class="line">    &#123;</span><br><span class="line">        uint32_t timerIsInvalidated;</span><br><span class="line">    &#125; _timerFlags;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSTimeInterval</span> timeInterval;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="type">id</span> target; <span class="comment">//å¼±å¼•ç”¨target</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) SEL selector;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="type">id</span> userInfo;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="type">BOOL</span> repeats;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, ms_gcd_property_qualifier) <span class="built_in">dispatch_queue_t</span> privateSerialQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, ms_gcd_property_qualifier) dispatch_source_t timer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line">  </span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">//è‡ªèº«é”€æ¯æ—¶invalidateæ‰å®šæ—¶å™¨</span></span><br><span class="line">- (<span class="type">void</span>)dealloc</span><br><span class="line">&#123;</span><br><span class="line">  [<span class="keyword">self</span> invalidate];</span><br><span class="line"></span><br><span class="line">  ms_release_gcd_object(_privateSerialQueue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬ä½¿ç”¨<code>MSWeakTimer</code>æ—¶ï¼Œå°±å¯ä»¥é¿å…å› å¿˜è®°invalidå®šæ—¶å™¨ï¼Œå¯¼è‡´ViewControllerç”Ÿå‘½å‘¨æœŸè¢«å»¶é•¿ä¸èƒ½åŠæ—¶é”€æ¯è€Œäº§ç”Ÿçš„bugã€‚ä»è¿™ä¹‹åï¼Œæˆ‘ä¾¿ä¸å†é‡åˆ°å’Œ<code>NSTimer</code>ç›¸å…³çš„bugäº†ã€‚</p>
<div style="text-align: right"> äºŒé›¶ä¸€å…«å¹´ä¹æœˆäºŒåä¸€æ—¥ </div> 

]]></content>
      <categories>
        <category>Foundation</category>
      </categories>
      <tags>
        <tag>NSTimer</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¸å°å¿ƒé‡å†™äº†çˆ¶ç±»çš„æŸä¸ªæ–¹æ³•å¯¼è‡´çš„å´©æºƒ</title>
    <url>/2018/07/20/%E4%B8%8D%E5%B0%8F%E5%BF%83%E9%87%8D%E5%86%99%E4%BA%86%E7%88%B6%E7%B1%BB%E7%9A%84%E6%96%B9%E6%B3%95%E5%AF%BC%E8%87%B4%E7%9A%84%E5%B4%A9%E6%BA%83/</url>
    <content><![CDATA[<h3 id="ä¸å°å¿ƒé‡å†™äº†çˆ¶ç±»çš„æŸä¸ªæ–¹æ³•å¯¼è‡´çš„å´©æºƒ"><a href="#ä¸å°å¿ƒé‡å†™äº†çˆ¶ç±»çš„æŸä¸ªæ–¹æ³•å¯¼è‡´çš„å´©æºƒ" class="headerlink" title="ä¸å°å¿ƒé‡å†™äº†çˆ¶ç±»çš„æŸä¸ªæ–¹æ³•å¯¼è‡´çš„å´©æºƒ"></a>ä¸å°å¿ƒé‡å†™äº†çˆ¶ç±»çš„æŸä¸ªæ–¹æ³•å¯¼è‡´çš„å´©æºƒ</h3><p>ZAEButtonç±»é‡Œæœ‰ä¸€ä¸ªcommonInitæ–¹æ³•,è¯¥æ–¹æ³•ä¼šæ³¨å†ŒKVO â€œenabledâ€.</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithFrame:(<span class="built_in">CGRect</span>)frame</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="variable language_">super</span> initWithFrame:frame];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        [<span class="keyword">self</span> commonInit];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)commonInit</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span> addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@&quot;enabled&quot;</span> options:<span class="built_in">NSKeyValueObservingOptionOld</span> | <span class="built_in">NSKeyValueObservingOptionNew</span> context:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)dealloc</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span> removeObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@&quot;enabled&quot;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ZAECountDownButtonç±»ä¸ºZAEButtonçš„å­ç±»,å¦‚æœä¸ä»”ç»†çœ‹çˆ¶ç±»çš„å®ç°çš„è¯,å¯èƒ½ä¹Ÿä¼šå®šä¹‰ä¸€ä¸ªcommonInitæ–¹æ³•.æ­¤æ—¶å°±æ˜¯é‡å†™äº†è¯¥æ–¹æ³•,è™½ç„¶è¿™å¹¶ä¸æ˜¯ä½ çš„æ„æ„¿.</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithFrame:(<span class="built_in">CGRect</span>)frame</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="variable language_">super</span> initWithFrame:frame];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        [<span class="keyword">self</span> commonInit];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)commonInit</span><br><span class="line">&#123;</span><br><span class="line">    _duration = <span class="number">30</span>;</span><br><span class="line">    _autoCountDown = <span class="literal">YES</span>;</span><br><span class="line">    _timerStartState = ZAECountDownButtonTimerStartStateFromBegining;</span><br><span class="line">    [<span class="keyword">self</span> addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(buttonDidClicked:) forControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>];</span><br><span class="line">    _activityView = [[<span class="built_in">UIActivityIndicatorView</span> alloc] initWithActivityIndicatorStyle:<span class="built_in">UIActivityIndicatorViewStyleGray</span>];</span><br><span class="line">    [<span class="keyword">self</span> addSubview:_activityView];</span><br><span class="line">    _activityView.center = <span class="built_in">CGPointMake</span>(<span class="keyword">self</span>.bounds.size.width/<span class="number">2.0</span>, <span class="keyword">self</span>.bounds.size.height/<span class="number">2.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å´©æºƒå°±è¿™æ ·äº§ç”Ÿäº†:</p>
<p>å½“å®ä¾‹åŒ–ä¸€ä¸ªZAECountDownButtonå¯¹è±¡,è°ƒç”¨åˆ°[super initWithFrame:frame]æ—¶,ç”±äºå­ç±»å’Œçˆ¶ç±»éƒ½æœ‰ä¸€ä¸ªcommonInitæ–¹æ³•,å­ç±»ä¼šè¦†ç›–çˆ¶ç±»çš„æ–¹æ³•,æœ€ç»ˆè°ƒç”¨çš„æ˜¯å­ç±»çš„commonInitæ–¹æ³•.æ­¤æ—¶,å­ç±»å°±ä¸ä¼šæ³¨å†Œkvo,è€Œå½“å¯¹è±¡é”€æ¯æ—¶,ä¼šæ‰§è¡Œåˆ°çˆ¶ç±»çš„deallocæ–¹æ³•ç§»é™¤KVO,äºæ˜¯ç¨‹åºä¼šå› ä¸ºKVOæ³¨å†Œâ€”ç§»é™¤ä¸åŒ¹é…è€Œå¯¼è‡´å´©æºƒ.</p>
<p>è¿™æˆ–è®¸å°±æ˜¯æœ‰äº›æ¡†æ¶ä¸­çˆ¶ç±»çš„åˆå§‹åŒ–æ–¹æ³•éƒ½æœ‰â€_â€çš„ç¼˜æ•…å§.</p>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
  </entry>
  <entry>
    <title>iOS appæ–‡ä»¶ç³»ç»Ÿä»‹ç»</title>
    <url>/2018/07/18/iOS%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/</url>
    <content><![CDATA[<h2 id="iOS-appæ–‡ä»¶ç³»ç»Ÿ"><a href="#iOS-appæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="iOS appæ–‡ä»¶ç³»ç»Ÿ"></a>iOS appæ–‡ä»¶ç³»ç»Ÿ</h2><p>appæ²™ç›’ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/540C1C9A-29B1-4CD6-ACB3-84610E052426.png" style="zoom:50%;" /></p>
<h3 id="AppName-app"><a href="#AppName-app" class="headerlink" title="AppName.app"></a>AppName.app</h3><p>appçš„bundleã€‚è¯¥ç›®å½•åŒ…å«APPç¨‹åºåŠå¼€å‘è¿‡ç¨‹ä¸­ç”¨åˆ°çš„æœ¬åœ°èµ„æºã€‚è¯¥ç›®å½•æ˜¯åªè¯»çš„ï¼Œä¸å¯ä¿®æ”¹å¦åˆ™APPå°†æ— æ³•å¯åŠ¨ã€‚</p>
<h3 id="Documentsç›®å½•"><a href="#Documentsç›®å½•" class="headerlink" title="Documentsç›®å½•"></a>Documentsç›®å½•</h3><p>è¯´æ˜ï¼š</p>
<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line">Use this <span class="built_in">directory</span> <span class="built_in">to</span> store user-generated content. The contents <span class="keyword">of</span> this <span class="built_in">directory</span> can be made available <span class="built_in">to</span> <span class="keyword">the</span> user through <span class="built_in">file</span> sharing; therefore, this <span class="built_in">directory</span> should only contain <span class="built_in">files</span> that you may wish <span class="built_in">to</span> expose <span class="built_in">to</span> <span class="keyword">the</span> user.</span><br><span class="line"></span><br><span class="line">The contents <span class="keyword">of</span> this <span class="built_in">directory</span> are backed up <span class="keyword">by</span> iTunes <span class="keyword">and</span> iCloud.</span><br></pre></td></tr></table></figure>
<p>Documentsç›®å½•ä¸»è¦æ”¾ç½®ç”¨æˆ·åˆ›å»ºçš„ç›¸å…³å†…å®¹ï¼Œæ¯”å¦‚ç”¨æˆ·çš„åŠ¨æ€ï¼Œæ¶ˆæ¯æ•°æ®åº“ç­‰ã€‚Documentsç›®å½•åº”è¯¥ä»…å­˜æ”¾ä½ æƒ³æš´éœ²ç»™ç”¨æˆ·çš„æ–‡ä»¶ã€‚è¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶éƒ½ä¼šè¢«å¤‡ä»½åˆ°iTuneså’ŒiCloudã€‚</p>
<h3 id="Libraryç›®å½•"><a href="#Libraryç›®å½•" class="headerlink" title="Libraryç›®å½•"></a>Libraryç›®å½•</h3><p>è¯¥ç›®å½•ä¸‹æœ‰å‡ ä¸ªç³»ç»Ÿåˆ›å»ºçš„å­ç›®å½•,ç”¨çš„æ¯”è¾ƒå¤šçš„æ˜¯/Cacheså’Œ/Preferences.</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line"><span class="string">/Library</span></span><br><span class="line">	 <span class="string">/Application</span> Support</span><br><span class="line">	 <span class="string">/Caches</span></span><br><span class="line">	 <span class="string">/Preferences</span></span><br></pre></td></tr></table></figure>
<p>è¯´æ˜ï¼š</p>
<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line">This is <span class="keyword">the</span> top-level <span class="built_in">directory</span> <span class="keyword">for</span> <span class="keyword">any</span> <span class="built_in">files</span> that are <span class="keyword">not</span> user data <span class="built_in">files</span>. You typically <span class="built_in">put</span> <span class="built_in">files</span> <span class="keyword">in</span> <span class="literal">one</span> <span class="keyword">of</span> several standard subdirectories. iOS apps commonly use <span class="keyword">the</span> Application Support <span class="keyword">and</span> Caches subdirectories; however, you can <span class="built_in">create</span> custom subdirectories.</span><br><span class="line"></span><br><span class="line">Use <span class="keyword">the</span> Library subdirectories <span class="keyword">for</span> <span class="keyword">any</span> <span class="built_in">files</span> you donâ€™t want exposed <span class="built_in">to</span> <span class="keyword">the</span> user. Your app should <span class="keyword">not</span> use these <span class="built_in">directories</span> <span class="keyword">for</span> user data <span class="built_in">files</span>.</span><br><span class="line"></span><br><span class="line">The contents <span class="keyword">of</span> <span class="keyword">the</span> Library <span class="built_in">directory</span> (<span class="keyword">with</span> <span class="keyword">the</span> exception <span class="keyword">of</span> <span class="keyword">the</span> Caches subdirectory) are backed up <span class="keyword">by</span> iTunes <span class="keyword">and</span> iCloud.</span><br></pre></td></tr></table></figure>
<p>Libraryç›®å½•ä¸‹é¢æœ‰ä¸‰ä¸ªç³»ç»Ÿåˆ›å»ºçš„å­ç›®å½•åˆ†åˆ«æ˜¯Application Supportï¼ŒCachesï¼ŒPreferencesï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥åˆ›å»ºè‡ªå·±çš„å­ç›®å½•ã€‚Libraryç›®å½•ä¸‹é€šå¸¸æ”¾ä¸€äº›ä¸æƒ³æš´éœ²ç»™ç”¨æˆ·çš„æ–‡ä»¶ï¼Œæ¯”å¦‚æ—¥å¿—æ–‡ä»¶ã€‚</p>
<p>Libraryç›®å½•ä¸‹é™¤äº†Cachesæ–‡ä»¶å¤¹ï¼Œå…¶ä»–çš„æ–‡ä»¶éƒ½ä¼šè¢«å¤‡ä»½åˆ°iTuneså’ŒiCloudã€‚</p>
<h4 id="Cachesç›®å½•"><a href="#Cachesç›®å½•" class="headerlink" title="Cachesç›®å½•"></a>Cachesç›®å½•</h4><p>In iOS 5.0 and later, <strong>the system may delete the Caches directory on rare occasions when the system is very low on disk space.</strong> This will never occur while an app is running. However, be aware that restoring from backup is not necessarily the only condition under which the Caches directory can be erased.</p>
<blockquote>
<p>åœ¨æ‰‹æœºç£ç›˜ä¸è¶³æ—¶,ç³»ç»Ÿä¼šå‘¨æœŸæ€§çš„å°†ä¸åœ¨è¿è¡ŒçŠ¶æ€APPçš„Cachesç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åˆ é™¤.å·²ç»äº²èº«ç»å†è¿‡æ˜¯çœŸçš„,æ‰€ä»¥ä¸è¦å°†é‡è¦æ•°æ®ä¿å­˜åœ¨è¯¥ç›®å½•ä¸‹.å¦åˆ™å‡ºbugæ—¶ä½ ç»å¯¹ä¼šæƒ³ä¸åˆ°æ˜¯è¿™ä¸ªåŸå› ,è€Œä¸”è¿™æ ·çš„bugå¤ç°éš¾åº¦å¾ˆå¤§.ç½‘ä¸Šæœ‰ä¸€äº›æ–‡ç« ä¸­è¯´â€ç³»ç»Ÿä¸ä¼šæ¸…ç† cache ç›®å½•ä¸­çš„æ–‡ä»¶â€å®å±è¯¯äººå­å¼Ÿ,ä¹Ÿä¸çŸ¥é“ä»–ä»¬æ˜¯ä»å“ªçœ‹åˆ°çš„ç»“è®º.</p>
</blockquote>
<p>ç”±äºCachesç›®å½•ä¸‹çš„æ–‡ä»¶å¯èƒ½ä¼šè¢«ç³»ç»Ÿä¸»åŠ¨åˆ é™¤ï¼Œæ‰€ä»¥Cachesç›®å½•åªé€‚åˆæ”¾ä¸€äº›å¯é‡å»ºçš„ï¼Œå¯å†æ¬¡ä¸‹è½½çš„æ–‡ä»¶ï¼Œæ¯”å¦‚å›¾ç‰‡ç¼“å­˜ç­‰ã€‚åƒä¸‡ä¸è¦æ”¾ä¸å¯é‡å»ºçš„é‡è¦æ•°æ®ï¼Œæ¯”å¦‚å­˜æ”¾tokenä¿¡æ¯ç­‰ï¼Œå¦åˆ™å‡ºäº†bugï¼Œä¼šå¾ˆéš¾æ’æŸ¥ã€‚</p>
<h4 id="Preferencesç›®å½•"><a href="#Preferencesç›®å½•" class="headerlink" title="Preferencesç›®å½•"></a>Preferencesç›®å½•</h4><p>NSUserDefaultsä¿å­˜çš„ä¸œè¥¿å°±åœ¨/Preferencesç›®å½•.</p>
<h3 id="tmpç›®å½•"><a href="#tmpç›®å½•" class="headerlink" title="tmpç›®å½•"></a>tmpç›®å½•</h3><p>è¯´æ˜ï¼š</p>
<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line">Use this <span class="built_in">directory</span> <span class="built_in">to</span> <span class="built_in">write</span> temporary <span class="built_in">files</span> that <span class="built_in">do</span> <span class="keyword">not</span> need <span class="built_in">to</span> persist between launches <span class="keyword">of</span> your app. Your app should remove <span class="built_in">files</span> <span class="built_in">from</span> this <span class="built_in">directory</span> when they are no longer needed; however, <span class="keyword">the</span> <span class="keyword">system</span> may purge this <span class="built_in">directory</span> when your app is <span class="keyword">not</span> running.</span><br><span class="line"></span><br><span class="line">The contents <span class="keyword">of</span> this <span class="built_in">directory</span> are <span class="keyword">not</span> backed up <span class="keyword">by</span> iTunes <span class="keyword">or</span> iCloud.</span><br></pre></td></tr></table></figure>
<p>ç”±äºç³»ç»Ÿåœ¨APPä¸åœ¨è¿è¡Œæ—¶ä¼šæ¸…é™¤è¯¥ç›®å½•ä¸‹çš„å†…å®¹ã€‚å› æ­¤tmpç›®å½•åªé€‚åˆå­˜æ”¾ä¸€äº›ä¸´æ—¶æ–‡ä»¶ï¼Œæ¯”å¦‚ä¸‹è½½è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸´æ—¶æ–‡ä»¶ã€‚è¿™äº›ä¸´æ—¶æ–‡ä»¶ä¸å†éœ€è¦æ—¶åº”è¯¥åŠæ—¶åˆ é™¤ã€‚</p>
<p>tmpç›®å½•ä¸‹çš„æ–‡ä»¶ä¸ä¼šè¢«å¤‡ä»½åˆ°iTuneså’ŒiCloudã€‚</p>
<h3 id="è·å–æ²™ç›’è·¯å¾„"><a href="#è·å–æ²™ç›’è·¯å¾„" class="headerlink" title="è·å–æ²™ç›’è·¯å¾„"></a>è·å–æ²™ç›’è·¯å¾„</h3><p>NSHomeDirectory()</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *homePath = <span class="built_in">NSHomeDirectory</span>();</span><br><span class="line">    <span class="built_in">NSString</span> *documentsPath = [homePath stringByAppendingPathComponent:<span class="string">@&quot;Documents&quot;</span>];</span><br><span class="line">    <span class="built_in">NSString</span> *libraryPath = [homePath stringByAppendingPathComponent:<span class="string">@&quot;Library&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;documentsPath:%@&quot;</span>, documentsPath);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;libraryPath:%@&quot;</span>, libraryPath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *documentsPath = <span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSDocumentDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>).lastObject;</span><br><span class="line">    <span class="built_in">NSString</span> *libraryPath = <span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSLibraryDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>).lastObject;</span><br><span class="line">    <span class="built_in">NSString</span> *libraryCachePath = <span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSCachesDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>).lastObject;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;documentsPath:%@&quot;</span>, documentsPath);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;libraryPath:%@&quot;</span>, libraryPath);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;libraryCachePath:%@&quot;</span>, libraryCachePath);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">   <span class="built_in">NSString</span> *cachePath = [<span class="built_in">NSFileManager</span>.defaultManager URLsForDirectory:<span class="built_in">NSCachesDirectory</span> inDomains:<span class="built_in">NSUserDomainMask</span>].lastObject;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸Šé¢å†™æ³•ï¼Œç»“æœæ˜¯ä¸€æ ·çš„ã€‚</span></span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼šNSSearchPathForDirectoriesInDomainså‡½æ•°çš„æœ€åä¸€ä¸ªå‚æ•°å¿…é¡»ä¸ºYESã€‚</p>
<p>æ³¨æ„ï¼šä¸è¦æƒ³ç€ä¿å­˜è·å–åˆ°çš„æ²™ç›’è·¯å¾„ç»“æœç”¨äºä¸‹ä¸€æ¬¡ä½¿ç”¨ï¼Œå› ä¸ºæ²™ç›’è·¯å¾„æ¯æ¬¡å¯åŠ¨éƒ½ä¼šå˜åŒ–ã€‚ä½¿ç”¨ä¸Šä¸€æ¬¡çš„ç»“æœæ˜¯æ²¡æ³•è®¿é—®åˆ°ä½ ä¿å­˜çš„æ–‡ä»¶çš„ï¼Œä½ åªéœ€è¦ä¿å­˜ç›¸å¯¹è·¯å¾„æ¯”å¦‚ï¼š/Library/MyFolder/xxx.fileã€‚ä¸‹ä¸€æ¬¡å–çš„æ—¶å€™ä½¿ç”¨NSHomeDirectoryæ‹¼æ¥å³å¯ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.jianshu.com/p/e6d3f7c4baed">å…³äº iOS åˆ é™¤ç¼“å­˜çš„é‚£äº›äº‹å„¿</a></p>
<p><a href="https://developer.apple.com/library/archive/documentation/FileManagement/Conceptual/FileSystemProgrammingGuide/FileSystemOverview/FileSystemOverview.html#//apple_ref/doc/uid/TP40010672-CH2-SW1">å®˜æ–¹æ–‡æ¡£</a></p>
<h2 id="ç®€è¦ç¬”è®°"><a href="#ç®€è¦ç¬”è®°" class="headerlink" title="ç®€è¦ç¬”è®°"></a>ç®€è¦ç¬”è®°</h2><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">-æ²™ç›’</span><br><span class="line"> -xxx.app appçš„<span class="keyword">bundleï¼Œåªè¯»ã€‚</span></span><br><span class="line"><span class="keyword"></span> -Documents å­˜æ”¾ç”¨æˆ·äº§ç”Ÿçš„æ–‡ä»¶ï¼Œæ¯”å¦‚IMæ•°æ®åº“ï¼Œç”¨æˆ·çš„ä½œå“</span><br><span class="line"> -Library å­˜æ”¾éç”¨æˆ·äº§ç”Ÿçš„æ–‡ä»¶ï¼Œæ¯”å¦‚æ—¥å¿—æ–‡ä»¶</span><br><span class="line">  -<span class="keyword">Caches </span>ç¼“å­˜æ–‡ä»¶ï¼Œæ¯”å¦‚å›¾ç‰‡ï¼Œè§†é¢‘ç­‰ç­‰ï¼Œå†…å­˜ä¸è¶³ä¼šè¢«ç³»ç»Ÿåˆ é™¤</span><br><span class="line">  -<span class="keyword">Preferences </span>NSUserDefaultsçš„kv</span><br><span class="line"> -Temp å­˜æ”¾ä¸´æ—¶æ–‡ä»¶ï¼Œæ¯”å¦‚ä¸‹è½½èµ„æºæ—¶çš„ä¸´æ—¶å­˜æ”¾ï¼Œå†…å­˜ä¸è¶³ä¼šè¢«ç³»ç»Ÿåˆ é™¤</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Foundation</category>
      </categories>
      <tags>
        <tag>iOSæ–‡ä»¶ç³»ç»Ÿ</tag>
      </tags>
  </entry>
  <entry>
    <title>openURLæ‰“å¼€åº”ç”¨</title>
    <url>/2018/07/18/openURL%E6%89%93%E5%BC%80%E5%BA%94%E7%94%A8/</url>
    <content><![CDATA[<h2 id="openURLæ‰“å¼€åº”ç”¨"><a href="#openURLæ‰“å¼€åº”ç”¨" class="headerlink" title="openURLæ‰“å¼€åº”ç”¨"></a>openURLæ‰“å¼€åº”ç”¨</h2><h3 id="Båº”ç”¨æ‰“å¼€Aåº”ç”¨"><a href="#Båº”ç”¨æ‰“å¼€Aåº”ç”¨" class="headerlink" title="Båº”ç”¨æ‰“å¼€Aåº”ç”¨"></a>Båº”ç”¨æ‰“å¼€Aåº”ç”¨</h3><p>éœ€è¦Aåº”ç”¨è®¾ç½®URL Scheme,å¦‚testA,å¹¶ä¸”å‘ŠçŸ¥Båº”ç”¨.æ­¤æ—¶Båº”ç”¨å°±å¯ä»¥é€šè¿‡â€testA://â€œæ‰“å¼€Aåº”ç”¨äº†.</p>
<p>Aåº”ç”¨å®ç°æ–¹æ³•</p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">- <span class="params">(BOOL)</span>application:<span class="params">(UIApplication *)</span>app openURL:<span class="params">(NSURL *)</span>url options:<span class="params">(NSDictionary&lt;UIApplicationOpenURLOptionsKey,id&gt; *)</span>options</span><br><span class="line">&#123;</span><br><span class="line">    DLog<span class="params">(@<span class="string">&quot;%@&quot;</span>, app)</span>;</span><br><span class="line">    DLog<span class="params">(@<span class="string">&quot;%@&quot;</span>, url)</span>;</span><br><span class="line">    DLog<span class="params">(@<span class="string">&quot;%@&quot;</span>, options)</span>;</span><br><span class="line">    return YES;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ä¼ é€’å‚æ•°"><a href="#ä¼ é€’å‚æ•°" class="headerlink" title="ä¼ é€’å‚æ•°"></a>ä¼ é€’å‚æ•°</h4><p>åªèƒ½æ˜¯key=valueå½¢å¼,å¤šä¸ªå‚æ•°ä½¿ç”¨&amp;è¿æ¥.<br><code>testA://?key1=value1&amp;key2=value2&amp;key3=value3</code></p>
<p><strong>æ³¨æ„</strong><br>valueæ˜¯ä¸€ä¸ªjsonå­—ç¬¦ä¸²æ—¶å°†æ‰“ä¸å¼€Aåº”ç”¨.è¿™æ˜¯ç”±äºjsonå­—ç¬¦ä¸²ä¸­çš„èŠ±æ‹¬å·å’Œå†’å·éƒ½æ˜¯ä¿ç•™å­—ç¬¦.<br><code>testA://?p=&#123;&quot;type&quot;:2,&quot;detail&quot;:&#123;&quot;backAction&quot;:1&#125;&#125;</code></p>
<p>å¯ä»¥æŠŠjsonå­—ç¬¦ä¸²ç™¾åˆ†å·ç¼–ç åä¼ é€’,å¦‚ä¸‹:<br><code>testA://?p=%7B%22type%22%3A2%2C%22detail%22%3A%7B%22backAction%22%3A1%7D%7D</code></p>
]]></content>
      <categories>
        <category>Foundation</category>
      </categories>
  </entry>
  <entry>
    <title>PINCacheä½¿ç”¨æ³¨æ„äº‹é¡¹</title>
    <url>/2018/07/18/PINCache%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/</url>
    <content><![CDATA[<h3 id="PINCacheä½¿ç”¨æ³¨æ„äº‹é¡¹"><a href="#PINCacheä½¿ç”¨æ³¨æ„äº‹é¡¹" class="headerlink" title="PINCacheä½¿ç”¨æ³¨æ„äº‹é¡¹"></a>PINCacheä½¿ç”¨æ³¨æ„äº‹é¡¹</h3><p>é»˜è®¤çš„[PINCache sharedCache] æ–‡ä»¶ä¿å­˜åœ¨ç›®å½•/Library/Caches/com.pinterest.PINDiskCache.PINCacheShared åœ¨ç£ç›˜ç©ºé—´ä¸è¶³æ—¶/Cachesç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶éƒ½ä¼šè¢«ç³»ç»Ÿè‡ªåŠ¨æ¸…é™¤,ä¸é€‚åˆå­˜å‚¨ç”¨æˆ·ä¿¡æ¯,ç™»å½•çŠ¶æ€ç­‰ç›¸å…³æ•°æ®.</p>
<p>è¯¡å¼‚BUG<br><strong>ç°è±¡</strong><br>ç”¨æˆ·åœ¨APPä¸­ç™»å½•æˆåŠŸå,æ¯éš”ä¸€æ®µæ—¶é—´(å¤§æ¦‚2-3ä¸ªå°æ—¶),å†æ¬¡æ‰“å¼€Appå,Appæ²¡æœ‰è¿›å…¥é¦–é¡µè€Œæ˜¯åˆ°äº†ç™»å½•é¡µ.ç”±äºä¸æ˜¯å¿…ç°,æ‰€ä»¥éš¾ä»¥åˆ†æå…¶å…·ä½“åŸå› .</p>
<p><strong>åˆ†æè§£å†³</strong><br>ç»è¿‡ä¸ªæŠŠæ˜ŸæœŸçš„çº ç¼ ,ç»ˆäºå‘ç°åŸå› :åœ¨å†™çš„æ—¶å€™å°†ç™»å½•æˆåŠŸåçš„tokenä½¿ç”¨[PINCache sharedCache]ä¿å­˜äº†,è€Œå®ƒçš„é»˜è®¤ä¿å­˜è·¯å¾„å°±æ˜¯åœ¨/Cachesç›®å½•ä¸‹,å¯¹äºé‚£äº›ç£ç›˜ç©ºé—´ä¸€ç›´å¾˜å¾Šåœ¨200-300Mçš„æ‰‹æœº,ç³»ç»Ÿä¼šå‘¨æœŸæ€§çš„æ¸…ç†å„ä¸ªAppçš„/Cachesç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶,æ¥é‡Šæ”¾éƒ¨åˆ†ç£ç›˜ç©ºé—´.è¿™æ—¶tokenå°±è¢«æ¸…ç†äº†,è€Œå¯åŠ¨æ—¶æ˜¯å…ˆä»æ–‡ä»¶ä¸­å–tokenè¿›è¡Œåˆ¤æ–­,ç”±äºå·²è¢«æ¸…é™¤,è‡ªç„¶ä¹Ÿå–ä¸åˆ°,å› æ­¤è¿›å…¥äº†ç™»å½•é¡µ.è§£å†³åŠæ³•:æ¢ä¸€ä¸ªè·¯å¾„ä¿å­˜å°±å¯ä»¥äº†.</p>
]]></content>
      <categories>
        <category>ç¬¬ä¸‰æ–¹åº“ä½¿ç”¨</category>
      </categories>
  </entry>
  <entry>
    <title>è®¡ç®—å­—ç¬¦ä¸²å ç”¨çš„å­—èŠ‚é•¿åº¦</title>
    <url>/2018/07/15/%E8%AE%A1%E7%AE%97%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8D%A0%E7%94%A8%E7%9A%84%E5%AD%97%E8%8A%82%E9%95%BF%E5%BA%A6/</url>
    <content><![CDATA[<h3 id="è®¡ç®—å­—ç¬¦ä¸²å ç”¨çš„å­—èŠ‚é•¿åº¦"><a href="#è®¡ç®—å­—ç¬¦ä¸²å ç”¨çš„å­—èŠ‚é•¿åº¦" class="headerlink" title="è®¡ç®—å­—ç¬¦ä¸²å ç”¨çš„å­—èŠ‚é•¿åº¦"></a>è®¡ç®—å­—ç¬¦ä¸²å ç”¨çš„å­—èŠ‚é•¿åº¦</h3><p><strong>å‰æ</strong></p>
<p>éœ€è¦äº†è§£å­—ç¬¦çš„ç¼–ç è§„åˆ™.ä½¿ç”¨ä¸åŒçš„ç¼–ç è§„åˆ™ä¼šå¾—åˆ°ä¸åŒçš„ç»“æœ.</p>
<p><strong>API</strong></p>
<p><code>- (NSUInteger)lengthOfBytesUsingEncoding:(NSStringEncoding)enc;        // Result in O(n) time; the result is exact. Returns 0 on error (cannot convert to specified encoding, or overflow)</code></p>
<p><strong>ç¤ºä¾‹</strong></p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *chString = <span class="string">@&quot;ä¸­å›½abc&quot;</span>;</span><br><span class="line"><span class="built_in">NSUInteger</span> utf8Bytes = [chString lengthOfBytesUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;utf8Bytes:%ld&quot;</span>, utf8Bytes); <span class="comment">//9</span></span><br><span class="line"><span class="built_in">NSUInteger</span> unicodeBytes = [chString lengthOfBytesUsingEncoding:<span class="built_in">NSUnicodeStringEncoding</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;unicodeBytes:%ld&quot;</span>, unicodeBytes); <span class="comment">//10</span></span><br></pre></td></tr></table></figure>
<p>å¤©æœç›®å‰å¼ºåˆ¶ä½¿ç”¨çš„æ˜¯GB18030.</p>
<p>åœ¨<code>CFStringEncodingExt.h</code>é‡Œé¢åŒ…å«äº†å…¶ä»–ç¼–ç æšä¸¾.å¦‚:</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">kCFStringEncodingGB_2312_80</span> = <span class="number">0</span>x0630,</span><br><span class="line"><span class="attr">kCFStringEncodingGBK_95</span> = <span class="number">0</span>x0631,		/* annex to GB <span class="number">13000</span>-<span class="number">93</span><span class="comment">; for Windows 95 */</span></span><br><span class="line"><span class="attr">kCFStringEncodingGB_18030_2000</span> = <span class="number">0</span>x0632,</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSStringEncoding</span> GBEncoding = <span class="built_in">CFStringConvertEncodingToNSStringEncoding</span>(kCFStringEncodingGB_18030_2000);</span><br><span class="line"><span class="built_in">NSUInteger</span> gbBytes = [chString lengthOfBytesUsingEncoding: GBEncoding];  <span class="comment">//7</span></span><br></pre></td></tr></table></figure>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Printing</span> description of gbCodeChData:</span><br><span class="line"><span class="section">&lt;d6d0b9fa 616263&gt;</span></span><br></pre></td></tr></table></figure>
<p>æ³¨æ„:<strong>å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºNSData,å†è·å–NSDataçš„length,åœ¨ä½¿ç”¨Unicodeç¼–ç æ—¶å®ƒä¼šä¸ç­‰äºä½¿ç”¨lengthOfBytesUsingEncodingè·å–åˆ°çš„å€¼.ä¸»è¦æ˜¯ç”±äºå¤§ç«¯å’Œå°ç«¯å¯¼è‡´çš„.Unicode è§„èŒƒå®šä¹‰ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶çš„æœ€å‰é¢åˆ†åˆ«åŠ å…¥ä¸€ä¸ªè¡¨ç¤ºç¼–ç é¡ºåºçš„å­—ç¬¦ï¼Œè¿™ä¸ªå­—ç¬¦çš„åå­—å«åšâ€é›¶å®½åº¦éæ¢è¡Œç©ºæ ¼â€ï¼ˆzero width no-break spaceï¼‰ï¼Œç”¨FEFFè¡¨ç¤ºã€‚è¿™æ­£å¥½æ˜¯ä¸¤ä¸ªå­—èŠ‚ï¼Œè€Œä¸”FFæ¯”FEå¤§1ã€‚å¦‚æœä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶çš„å¤´ä¸¤ä¸ªå­—èŠ‚æ˜¯FE FFï¼Œå°±è¡¨ç¤ºè¯¥æ–‡ä»¶é‡‡ç”¨å¤§ç«¯æ–¹å¼ï¼›å¦‚æœå¤´ä¸¤ä¸ªå­—èŠ‚æ˜¯FF FEï¼Œå°±è¡¨ç¤ºè¯¥æ–‡ä»¶é‡‡ç”¨å°ç«¯æ–¹å¼ã€‚</strong></p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSData</span>* utf8ChData = [chString dataUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line"><span class="built_in">NSData</span>* unicodeChData = [chString dataUsingEncoding:<span class="built_in">NSUnicodeStringEncoding</span>];</span><br><span class="line"><span class="built_in">NSUInteger</span> utf8ChLength = utf8ChData.length; <span class="comment">//9</span></span><br><span class="line"><span class="built_in">NSUInteger</span> unicodeChLength = unicodeChData.length; <span class="comment">//12.ä¸ç­‰äºä¸Šé¢çš„10.è¿™æ˜¯ç”±äºUnicodeç¼–ç åè½¬ä¸ºäºŒè¿›åˆ¶ä¼ è¾“æ—¶å‰é¢è¦åŠ ä¸ŠFEFF/FFFEè¿™ä¸¤ä¸ªå­—èŠ‚.</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;utf8ChLength:%ld,unicodeChLength:%ld&quot;</span>, utf8ChLength, unicodeChLength);</span><br></pre></td></tr></table></figure>
<p>æ‰“å°å¦‚ä¸‹:</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Printing</span> description of utf8ChData:</span><br><span class="line"><span class="section">&lt;e4b8ade5 9bbd6162 63&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">Printing</span> description of unicodeChData:</span><br><span class="line"><span class="section">&lt;fffe2d4e fd566100 62006300&gt;</span></span><br></pre></td></tr></table></figure>
<p>ç–‘é—®:</p>
<p>Q1:å¯¹äºä¸€ä¸²ç¼–ç åå¾—åˆ°çš„äºŒè¿›åˆ¶æ•°æ®,æ¥æ”¶æ–¹å¦‚ä½•çŸ¥é“è¯¥ç”¨å“ªç§æ–¹å¼è§£ç å‘¢?<br>A1:è¿™å°±éœ€è¦å‘é€æ–¹å’Œæ¥æ”¶æ–¹äº‹å…ˆç¡®å®šä¸€ç§ç¼–ç æ–¹å¼.è¿™æ ·å½“æ¥æ”¶åˆ°ä¸€ä¸²äºŒè¿›åˆ¶æ•°æ®å,æ¥æ”¶æ–¹å°±çŸ¥é“è¯¥ä½¿ç”¨å“ªä¸€ç§æ–¹å¼è¿›è¡Œè§£ç äº†.æœ‰ç‚¹ç±»ä¼¼äºåè®®.</p>
<p>Q2:å¯¹äºUTF-16ç¼–ç åœ¨è½¬ä¸ºäºŒè¿›åˆ¶åä¸ºå•¥éœ€è¦åœ¨æœ€å‰é¢æ ‡è®°æ˜¯å¤§ç«¯è¿˜æ˜¯å°ç«¯.ä¸ºä»€ä¹ˆUTF-8å´æ²¡æœ‰çœ‹åˆ°?<br>A2:æ¶‰åŠåˆ°ä¸€ä¸ªBOM(Byte Order Mark)æ¦‚å¿µ.å­—é¢æ„æ€å°±æ˜¯æ ‡è®°å­—èŠ‚é¡ºåºçš„.è¿™ä¸ªæ ‡è®°æ˜¯å¯é€‰çš„ï¼Œä¸è¿‡UTF8å­—èŠ‚æ˜¯æ²¡æœ‰é¡ºåºçš„ï¼Œæ‰€ä»¥ä¸€äº›å‚å®¶å°±æŠŠå®ƒç”¨ä½œäº†å¦ä¸€ç§ç”¨é€”,ç”¨æ¥æ£€æµ‹ä¸€ä¸ªå­—èŠ‚æµæ˜¯å¦æ˜¯UTF-8ç¼–ç ã€‚å¾®è½¯åšäº†è¿™ç§æ£€æµ‹ï¼Œä½†æœ‰äº›è½¯ä»¶ä¸åšè¿™ç§æ£€æµ‹ï¼Œ è€ŒæŠŠå®ƒå½“ä½œæ­£å¸¸å­—ç¬¦å¤„ç†ã€‚å¾®è½¯åœ¨è‡ªå·±çš„UTF-8æ ¼å¼çš„æ–‡æœ¬æ–‡ä»¶ä¹‹å‰åŠ ä¸Šäº†EF BB BFä¸‰ä¸ªå­—èŠ‚, windowsä¸Šé¢çš„notepadç­‰ç¨‹åºå°±æ˜¯æ ¹æ®è¿™ä¸‰ä¸ªå­—èŠ‚æ¥ç¡®å®šä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶æ˜¯ASCIIçš„è¿˜æ˜¯UTF-8çš„, ç„¶è€Œè¿™ä¸ªåªæ˜¯å¾®è½¯æš—è‡ªä½œçš„æ ‡è®°, å…¶å®ƒå¹³å°ä¸Šå¹¶æ²¡æœ‰å¯¹UTF-8æ–‡æœ¬æ–‡ä»¶åšä¸ªè¿™æ ·çš„æ ‡è®°ã€‚(è¿™é‡Œæ„Ÿè§‰å¾®è½¯çš„åšæ³•è·ŸBOMçš„å­—é¢æ„æ€å·®çš„æœ‰ç‚¹è¿œäº†.)</p>
<p>ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªUTF-8æ–‡ä»¶å¯èƒ½æœ‰BOMï¼Œä¹Ÿå¯èƒ½æ²¡æœ‰BOMï¼Œé‚£ä¹ˆæ€ä¹ˆåŒºåˆ†å‘¢ï¼Ÿ<br>ä¸‰ç§æ–¹æ³•ã€‚å‚è€ƒ:<a href="http://blog.163.com/result_2205/blog/static/13981945020102954023564/">EF BB BF</a></p>
<ol>
<li>ç”¨UltraEdit-32æ‰“å¼€æ–‡ä»¶ï¼Œåˆ‡æ¢åˆ°åå…­è¿›åˆ¶ç¼–è¾‘æ¨¡å¼ï¼Œå¯Ÿçœ‹æ–‡ä»¶å¤´éƒ¨æ˜¯å¦æœ‰EF BB BFã€‚  </li>
<li>ç”¨Dreamweaveræ‰“å¼€ï¼Œå¯Ÿçœ‹é¡µé¢å±æ€§ï¼Œçœ‹â€œåŒ…æ‹¬Unicodeç­¾åBOMâ€å‰é¢æ˜¯å¦æœ‰ä¸ªå‹¾ã€‚</li>
<li>ç”¨Windowsçš„è®°äº‹æœ¬æ‰“å¼€ï¼Œé€‰æ‹© â€œå¦å­˜ä¸ºâ€ï¼Œçœ‹æ–‡ä»¶çš„é»˜è®¤ç¼–ç æ˜¯UTF-8è¿˜æ˜¯ANSIï¼Œå¦‚æœæ˜¯ANSIåˆ™ä¸å¸¦BOMã€‚</li>
</ol>
<p>åæ­£,Macä¸Šå¯¹äºUTF-8ç¼–ç çš„æ˜¯æ²¡æœ‰çœ‹åˆ°EF BB BFè¿™æ ·çš„å­—æ ·.PCä¸Šå¯èƒ½æœ‰.ä¹‹æ‰€ä»¥UTF-16éœ€è¦è€ŒUTF-8ä¸éœ€è¦,æ˜¯ç”±äºäºŒè€…ç¼–ç è§„åˆ™çš„ä¸ä¸€æ ·.UTF-16å°±æ˜¯åŸå§‹çš„Unicodeç¼–ç ,æ‰€ä»¥å°±æ¶‰åŠåˆ°è§£è¯»é¡ºåºçš„é—®é¢˜.ä½†UTF-8çš„è§„åˆ™ä½¿å¾—å®ƒä¸å­˜åœ¨è§£è¯»é¡ºåºçš„é—®é¢˜.</p>
<p>Q3:å¯¹äºä¸€ä¸ªæ•°å­—å­—ç¬¦ä¸²â€123â€,å‘é€æ–¹åœ¨TCPä¼ è¾“æ—¶æ˜¯å…ˆä¼ é«˜ä½è¿˜æ˜¯å…ˆä¼ ä½ä½?æ¥æ”¶æ–¹çš„å­˜å‚¨é¡ºåºæ˜¯æ€æ ·çš„?è¯»å–æ—¶çš„é¡ºåºåˆæ˜¯æ€æ ·çš„?å¦‚ä½•æµ‹è¯•?<br>A3:ç½‘ç»œå­—èŠ‚é¡ºåºæ˜¯TCP/IPä¸­è§„å®šå¥½çš„ä¸€ç§æ•°æ®è¡¨ç¤ºæ ¼å¼ï¼Œå®ƒä¸å…·ä½“çš„CPUç±»å‹ã€æ“ä½œç³»ç»Ÿç­‰æ— å…³ï¼Œä»è€Œå¯ä»¥ä¿è¯æ•°æ®åœ¨ä¸åŒä¸»æœºä¹‹é—´ä¼ è¾“æ—¶èƒ½å¤Ÿè¢«æ­£ç¡®è§£é‡Šã€‚ç½‘ç»œå­—èŠ‚é¡ºåºé‡‡ç”¨big endianæ’åºæ–¹å¼ã€‚</p>
<p>å‚è€ƒ:</p>
<p><a href="https://blog.csdn.net/anningzte/article/details/52125665">å¤§ç«¯ã€å°ç«¯ä¸ç½‘ç»œå­—èŠ‚åº</a></p>
<p><a href="https://www.cnblogs.com/jacktu/archive/2008/11/24/1339789.html">ç½‘ç»œå­—èŠ‚åºä¸ä¸»æœºå­—èŠ‚åº</a></p>
<p>Q4:å¯¹äºintæ•´å‹æ•°å­—123,åœ¨å†…å­˜ä¸­æ˜¯å¦‚ä½•å­˜å‚¨çš„?å¦‚ä½•æµ‹è¯•?</p>
<h3 id="ç¼–ç è§„åˆ™"><a href="#ç¼–ç è§„åˆ™" class="headerlink" title="ç¼–ç è§„åˆ™"></a>ç¼–ç è§„åˆ™</h3><h4 id="ASCIIç¼–ç "><a href="#ASCIIç¼–ç " class="headerlink" title="ASCIIç¼–ç "></a>ASCIIç¼–ç </h4><p>American Standard Code for Information Interchangeï¼Œç¾å›½ä¿¡æ¯äº¤æ¢æ ‡å‡†ä»£ç .ASCIIç ä½¿ç”¨æŒ‡å®šçš„7 ä½æˆ–8 ä½äºŒè¿›åˆ¶æ•°ç»„åˆæ¥è¡¨ç¤º128 æˆ–256 ç§å¯èƒ½çš„å­—ç¬¦ã€‚<strong>æ ‡å‡†ASCIIç ä¹Ÿå«åŸºç¡€ASCIIç ï¼Œä½¿ç”¨7 ä½äºŒè¿›åˆ¶æ•°ï¼ˆå‰©ä¸‹çš„1ä½äºŒè¿›åˆ¶ä¸º0ï¼‰æ¥è¡¨ç¤ºæ‰€æœ‰çš„å¤§å†™å’Œå°å†™å­—æ¯ï¼Œæ•°å­—0 åˆ°9ã€æ ‡ç‚¹ç¬¦å·ï¼Œ ä»¥åŠåœ¨ç¾å¼è‹±è¯­ä¸­ä½¿ç”¨çš„ç‰¹æ®Šæ§åˆ¶å­—ç¬¦</strong>ã€‚</p>
<p>0ï½31åŠ127(å…±33ä¸ª)æ˜¯æ§åˆ¶å­—ç¬¦æˆ–é€šä¿¡ä¸“ç”¨å­—ç¬¦.å®ƒä»¬å¹¶æ²¡æœ‰ç‰¹å®šçš„å›¾å½¢æ˜¾ç¤ºï¼Œä½†ä¼šä¾ä¸åŒçš„åº”ç”¨ç¨‹åºï¼Œè€Œå¯¹æ–‡æœ¬æ˜¾ç¤ºæœ‰ä¸åŒçš„å½±å“.</p>
<p>32ï½126(å…±95ä¸ª)æ˜¯å¯æ˜¾ç¤ºå­—ç¬¦(32æ˜¯ç©ºæ ¼ï¼‰ï¼Œå…¶ä¸­48ï½57ä¸º0åˆ°9åä¸ªé˜¿æ‹‰ä¼¯æ•°å­—ã€‚<br>65ï½90ä¸º26ä¸ªå¤§å†™è‹±æ–‡å­—æ¯ï¼Œ97ï½122å·ä¸º26ä¸ªå°å†™è‹±æ–‡å­—æ¯ï¼Œå…¶ä½™ä¸ºä¸€äº›æ ‡ç‚¹ç¬¦å·ã€è¿ç®—ç¬¦å·ç­‰ã€‚</p>
<p>ASCIIç¼–ç è¿˜æ˜¯å¾ˆå¥½ç†è§£çš„,åªéœ€æŸ¥ä¸€ä¸‹è¡¨å°±å®Œäº‹äº†.å¯ä»¥è®°ä½å‡ ä¸ªå¸¸ç”¨çš„å¦‚:0x00(0)ä¸ºnull,ç©ºå­—ç¬¦;0x20(32)ä¸ºç©ºæ ¼;0x30(48)ä¸ºæ•°å­—0;0x41(65)ä¸ºA;0x61(97)ä¸ºa.</p>
<h4 id="Unicodeç¼–ç "><a href="#Unicodeç¼–ç " class="headerlink" title="Unicodeç¼–ç "></a>Unicodeç¼–ç </h4><p>ä¸–ç•Œä¸Šå­˜åœ¨ç€å¤šç§ç¼–ç æ–¹å¼ï¼ŒåŒä¸€ä¸ªäºŒè¿›åˆ¶æ•°å­—å¯ä»¥è¢«è§£é‡Šæˆä¸åŒçš„ç¬¦å·ã€‚å› æ­¤ï¼Œè¦æƒ³æ‰“å¼€ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå°±å¿…é¡»çŸ¥é“å®ƒçš„ç¼–ç æ–¹å¼ï¼Œå¦åˆ™ç”¨é”™è¯¯çš„ç¼–ç æ–¹å¼è§£è¯»ï¼Œå°±ä¼šå‡ºç°ä¹±ç ã€‚</p>
<p>Unicodeç¼–ç çš„å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜.å®ƒå°†ä¸–ç•Œä¸Šæ‰€æœ‰çš„ç¬¦å·éƒ½çº³å…¥å…¶ä¸­ã€‚æ¯ä¸€ä¸ªç¬¦å·éƒ½ç»™äºˆä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„ç¼–ç ï¼Œè¿™æ ·ä¹±ç é—®é¢˜å°±è§£å†³äº†ã€‚</p>
<p><strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒUnicode åªæ˜¯ä¸€ä¸ªç¬¦å·é›†ï¼Œå®ƒåªè§„å®šäº†ç¬¦å·çš„äºŒè¿›åˆ¶ä»£ç ï¼Œå´æ²¡æœ‰è§„å®šè¿™ä¸ªäºŒè¿›åˆ¶ä»£ç åº”è¯¥å¦‚ä½•å­˜å‚¨ã€‚</strong></p>
<p>Unicodeç¼–ç ç³»ç»Ÿå¯åˆ†ä¸ºç¼–ç æ–¹å¼å’Œå®ç°æ–¹å¼ä¸¤ä¸ªå±‚æ¬¡ã€‚</p>
<blockquote>
<p>Unicodeçš„ç¼–ç æ–¹å¼</p>
</blockquote>
<p>Unicodeçš„ç¼–ç æ–¹å¼ä¸ISO 10646çš„é€šç”¨å­—ç¬¦é›†æ¦‚å¿µç›¸å¯¹åº”ã€‚ç›®å‰å®é™…åº”ç”¨çš„ç»Ÿä¸€ç ç‰ˆæœ¬å¯¹åº”äºUCS-2ï¼Œä½¿ç”¨16ä½çš„ç¼–ç ç©ºé—´ã€‚ä¹Ÿå°±æ˜¯æ¯ä¸ªå­—ç¬¦å ç”¨2ä¸ªå­—èŠ‚ã€‚è¿™æ ·ç†è®ºä¸Šä¸€å…±æœ€å¤šå¯ä»¥è¡¨ç¤º2^16ï¼ˆå³65536ï¼‰ä¸ªå­—ç¬¦ã€‚åŸºæœ¬æ»¡è¶³å„ç§è¯­è¨€çš„ä½¿ç”¨ã€‚å®é™…ä¸Šå½“å‰ç‰ˆæœ¬çš„ç»Ÿä¸€ç å¹¶æœªå®Œå…¨ä½¿ç”¨è¿™16ä½ç¼–ç ï¼Œè€Œæ˜¯ä¿ç•™äº†å¤§é‡ç©ºé—´ä»¥ä½œä¸ºç‰¹æ®Šä½¿ç”¨æˆ–å°†æ¥æ‰©å±•ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°Unicodeå¯¹æ±‰å­—æ”¯æŒä¸æ€ä¹ˆå¥½ï¼Œè¿™ä¹Ÿæ˜¯æ²¡åŠæ³•çš„ï¼Œ ç®€ä½“å’Œç¹ä½“æ€»å…±æœ‰å…­ä¸ƒä¸‡ä¸ªæ±‰å­—ï¼Œè€ŒUCS-2æœ€å¤šèƒ½è¡¨ç¤º65536ä¸ªï¼Œæ‰å…­ä¸‡ å¤šä¸ªï¼Œæ‰€ä»¥Unicodeåªèƒ½æ’é™¤ä¸€äº›å‡ ä¹ä¸ç”¨çš„æ±‰å­—ï¼Œå¥½åœ¨å¸¸ç”¨çš„ç®€ä½“æ±‰å­— ä¹Ÿä¸è¿‡ä¸ƒåƒå¤šä¸ªï¼Œä¸ºäº†èƒ½è¡¨ç¤ºæ‰€æœ‰æ±‰å­—ï¼ŒUnicodeä¹Ÿæœ‰UCS-4è§„èŒƒï¼Œå°±æ˜¯ç”¨ 4ä¸ªå­—èŠ‚æ¥ç¼–ç å­—ç¬¦.</p>
<p>å‚è€ƒ:<a href="https://www.cnblogs.com/csguo/p/7401874.html">Unicodeç¼–ç è¡¨</a></p>
<p>Unicodeç¼–ç è¡¨ä¸­çš„0x4E00-0x9FBFä¸ºCJK ç»Ÿä¸€è¡¨æ„ç¬¦å· (CJK Unified Ideographs,ä¸­æ—¥éŸ©ç»Ÿä¸€è¡¨æ„æ–‡å­—).</p>
<blockquote>
<p>Unicodeçš„å®ç°æ–¹å¼</p>
</blockquote>
<p>Unicodeçš„å®ç°æ–¹å¼ä¸åŒäºç¼–ç æ–¹å¼ã€‚ä¸€ä¸ªå­—ç¬¦çš„Unicodeç¼–ç æ˜¯ç¡®å®šçš„ã€‚ä½†æ˜¯åœ¨å®é™…ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œç”±äºä¸åŒç³»ç»Ÿå¹³å°çš„è®¾è®¡ä¸ä¸€å®šä¸€è‡´ï¼Œä»¥åŠå‡ºäºèŠ‚çœç©ºé—´çš„ç›®çš„ï¼Œå¯¹Unicodeç¼–ç çš„å®ç°æ–¹å¼æœ‰æ‰€ä¸åŒã€‚Unicodeçš„å®ç°æ–¹å¼ç§°ä¸ºUnicodeè½¬æ¢æ ¼å¼ï¼ˆUnicode Transformation Formatï¼Œç®€ç§°ä¸ºUTFï¼‰ </p>
<h4 id="UTF-8"><a href="#UTF-8" class="headerlink" title="UTF-8"></a>UTF-8</h4><p>UTF-8ï¼ˆ8-bit Unicode Transformation Formatï¼‰æ˜¯ä¸€ç§é’ˆå¯¹Unicodeçš„<strong>å¯å˜é•¿åº¦å­—ç¬¦ç¼–ç </strong>ï¼Œåˆç§°ä¸‡å›½ç ï¼Œç”±Ken Thompsonäº1992å¹´åˆ›å»ºã€‚ç°åœ¨å·²ç»æ ‡å‡†åŒ–ä¸ºRFC 3629ã€‚UTF-8ç”¨1åˆ°6ä¸ªå­—èŠ‚ç¼–ç Unicodeå­—ç¬¦ã€‚</p>
<blockquote>
<p>UTF-8ä¸Unicodeçš„å…³ç³»  </p>
</blockquote>
<p>UTF-8 æ˜¯ Unicode çš„å®ç°æ–¹å¼ä¹‹ä¸€ã€‚</p>
<h5 id="UTF-8ç¼–ç è§„åˆ™"><a href="#UTF-8ç¼–ç è§„åˆ™" class="headerlink" title="UTF-8ç¼–ç è§„åˆ™"></a>UTF-8ç¼–ç è§„åˆ™</h5><p>UTF-8 çš„ç¼–ç è§„åˆ™å¾ˆç®€å•ï¼Œåªæœ‰äºŒæ¡ï¼š</p>
<p>1ï¼‰å¯¹äºå•å­—èŠ‚çš„ç¬¦å·ï¼Œå­—èŠ‚çš„ç¬¬ä¸€ä½è®¾ä¸º0ï¼Œåé¢7ä½ä¸ºè¿™ä¸ªç¬¦å·çš„ Unicode ç ã€‚å› æ­¤å¯¹äºè‹±è¯­å­—æ¯ï¼ŒUTF-8 ç¼–ç å’Œ ASCII ç æ˜¯ç›¸åŒçš„ã€‚</p>
<p>2ï¼‰å¯¹äºnå­—èŠ‚çš„ç¬¦å·ï¼ˆn &gt; 1ï¼‰ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚çš„å‰nä½éƒ½è®¾ä¸º1ï¼Œç¬¬n + 1ä½è®¾ä¸º0ï¼Œåé¢å­—èŠ‚çš„å‰ä¸¤ä½ä¸€å¾‹è®¾ä¸º10ã€‚å‰©ä¸‹çš„æ²¡æœ‰æåŠçš„äºŒè¿›åˆ¶ä½ï¼Œå…¨éƒ¨ä¸ºè¿™ä¸ªç¬¦å·çš„ Unicode ç ã€‚</p>
<h4 id="GB-2312â€”1980"><a href="#GB-2312â€”1980" class="headerlink" title="GB 2312â€”1980"></a>GB 2312â€”1980</h4><p>ã€Šä¿¡æ¯äº¤æ¢ç”¨æ±‰å­—ç¼–ç å­—ç¬¦é›†ã€‹æ˜¯ç”±ä¸­å›½å›½å®¶æ ‡å‡†æ€»å±€1980å¹´å‘å¸ƒï¼Œ1981å¹´5æœˆ1æ—¥å¼€å§‹å®æ–½çš„ä¸€å¥—å›½å®¶æ ‡å‡†ï¼Œæ ‡å‡†å·æ˜¯GB 2312â€”1980ã€‚<br>GB2312ç¼–ç é€‚ç”¨äºæ±‰å­—å¤„ç†ã€æ±‰å­—é€šä¿¡ç­‰ç³»ç»Ÿä¹‹é—´çš„ä¿¡æ¯äº¤æ¢ï¼Œé€šè¡Œäºä¸­å›½å¤§é™†ï¼›æ–°åŠ å¡ç­‰åœ°ä¹Ÿé‡‡ç”¨æ­¤ç¼–ç ã€‚ä¸­å›½å¤§é™†å‡ ä¹æ‰€æœ‰çš„ä¸­æ–‡ç³»ç»Ÿå’Œå›½é™…åŒ–çš„è½¯ä»¶éƒ½æ”¯æŒGB2312ã€‚</p>
<p>GB 2312çš„å‡ºç°ï¼ŒåŸºæœ¬æ»¡è¶³äº†æ±‰å­—çš„è®¡ç®—æœºå¤„ç†éœ€è¦ï¼Œå®ƒæ‰€æ”¶å½•çš„æ±‰å­—å·²ç»è¦†ç›–ä¸­å›½å¤§é™†99.75%çš„ä½¿ç”¨é¢‘ç‡ã€‚<br><strong>å¯¹äºäººåã€å¤æ±‰è¯­ç­‰æ–¹é¢å‡ºç°çš„ç½•ç”¨å­—ï¼ŒGB 2312ä¸èƒ½å¤„ç†ï¼Œè¿™å¯¼è‡´äº†åæ¥GBKåŠGB 18030æ±‰å­—å­—ç¬¦é›†çš„å‡ºç°ã€‚</strong></p>
<p>åœ¨ä½¿ç”¨GB2312çš„ç¨‹åºä¸­ï¼Œé€šå¸¸é‡‡ç”¨EUCå‚¨å­˜æ–¹æ³•ï¼Œä»¥ä¾¿å…¼å®¹äºASCIIã€‚æµè§ˆå™¨ç¼–ç è¡¨ä¸Šçš„â€œGB2312â€ï¼Œé€šå¸¸éƒ½æ˜¯æŒ‡â€œEUC-CNâ€è¡¨ç¤ºæ³•ã€‚<br>æ¯ä¸ªæ±‰å­—åŠç¬¦å·ä»¥ä¸¤ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºã€‚ç¬¬ä¸€ä¸ªå­—èŠ‚ç§°ä¸ºâ€œé«˜ä½å­—èŠ‚â€ï¼ˆä¹Ÿç§°â€œåŒºå­—èŠ‚ï¼‰â€ï¼Œç¬¬äºŒä¸ªå­—èŠ‚ç§°ä¸ºâ€œä½ä½å­—èŠ‚â€ï¼ˆä¹Ÿç§°â€œä½å­—èŠ‚â€ï¼‰ã€‚</p>
<p>å…¶ä»–å›½æ ‡ç ,å‚è€ƒ:<a href="https://baike.baidu.com/item/%E5%9B%BD%E5%AE%B6%E6%A0%87%E5%87%86%E4%BB%A3%E7%A0%81/10870180?fromtitle=%E5%9B%BD%E6%A0%87%E7%A0%81&amp;fromid=9886729">å›½å®¶æ ‡å‡†ä»£ç </a></p>
<p>ä¸Šé¢è¿™äº›è§„å®šå’‹ä¹Ÿçœ‹ä¸æ‡‚,æš‚ä¸”å…ˆè®°ä½å¯¹äºå›½æ ‡ç æ¥è¯´æ¯ä¸ªæ±‰å­—åŠç¬¦å·ä»¥ä¸¤ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºã€‚å…¶ä»–çš„æ–¹é¢æœ‰ç©ºå†ç ”ç©¶.</p>
<p>å‚è€ƒ:<a href="http://www.ruanyifeng.com/blog/2007/10/ascii_unicode_and_utf-8.html">å­—ç¬¦ç¼–ç ç¬”è®°ï¼šASCIIï¼ŒUnicode å’Œ UTF-8</a></p>
]]></content>
      <categories>
        <category>å­—ç¬¦ä¸²</category>
      </categories>
      <tags>
        <tag>å­—ç¬¦ç¼–ç </tag>
      </tags>
  </entry>
  <entry>
    <title>å›¾ç‰‡å‹ç¼©ç¬”è®°</title>
    <url>/2018/07/09/%E5%9B%BE%E7%89%87%E5%8E%8B%E7%BC%A9%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h2 id="å›¾ç‰‡å‹ç¼©ç¬”è®°"><a href="#å›¾ç‰‡å‹ç¼©ç¬”è®°" class="headerlink" title="å›¾ç‰‡å‹ç¼©ç¬”è®°"></a>å›¾ç‰‡å‹ç¼©ç¬”è®°</h2><h3 id="å‹ç¼©æ–¹æ³•"><a href="#å‹ç¼©æ–¹æ³•" class="headerlink" title="å‹ç¼©æ–¹æ³•"></a>å‹ç¼©æ–¹æ³•</h3><p>å·¥ç¨‹é‡Œå›¾ç‰‡å‹ç¼©æ–¹æ³•è¿‡ç¨‹:ä¼ å…¥ä¸€å¼ å›¾ç‰‡,å‹ç¼©å,å†è½¬å›å›¾ç‰‡.åŠ ä¸Šä¸Šä¼ åˆ°æœåŠ¡å™¨çš„æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹:<br>UIImage-å¤§åŠ›å‹ç¼©-&gt;NSData(A)-&gt;UIImage-UIImageJPEGRepresentation(img, 1)-&gt;NSData(B)-&gt;æœåŠ¡å™¨.</p>
<p>æµ‹è¯•å‘ç°dataBè¦æ¯”dataAå¤§å¾ˆå¤šå¾ˆå¤š.å¯¼è‡´å®é™…ä¸Šä¼ ç»™æœåŠ¡å™¨çš„æ•°æ®è¿œè¿œä¸æ­¢600kb.egæŸæ¬¡ä¸Šä¼ çš„å¤´åƒ:4.56Mb(åŸå›¾,å‹ç¼©å‰)-&gt;579.16kb(å‹ç¼©å)-&gt;2.93Mb(å®é™…ä¸Šä¼ ).å®é™…ä¸Šä¼ çš„æ•°æ®æ˜¯2.93Mb</p>
<p>å› æ­¤å†è½¬å›UIImageæ˜¯å¤šä½™ä¸”é”™çš„.è€Œåº”è¯¥å‹ç¼©åç›´æ¥ä¸Šä¼ æœåŠ¡å™¨,å³UIImage-å¤§åŠ›å‹ç¼©-&gt;NSData(A)-&gt;æœåŠ¡å™¨.</p>
<p>æ­£ç¡®çš„å‹ç¼©æ–¹æ³•ä¸º:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æŒ‡å®šå‹ç¼©é˜ˆå€¼,å‹ç¼©å›¾ç‰‡</span></span><br><span class="line">+ (<span class="built_in">NSData</span> *)za_compressImage:(<span class="built_in">UIImage</span> *)image toMaxFileSize:(<span class="built_in">NSInteger</span>)maxFileSize &#123;</span><br><span class="line">    <span class="built_in">CGFloat</span> compression = <span class="number">0.9</span>f;</span><br><span class="line">    <span class="built_in">CGFloat</span> minCompression = <span class="number">0.1</span>f;</span><br><span class="line">    <span class="built_in">NSData</span> *imageData = <span class="built_in">UIImageJPEGRepresentation</span>(image, compression);</span><br><span class="line">    <span class="keyword">while</span> ([imageData length] &gt; maxFileSize &amp;&amp; compression &gt; minCompression) &#123;</span><br><span class="line">        compression -= <span class="number">0.05</span>;</span><br><span class="line">        imageData = <span class="built_in">UIImageJPEGRepresentation</span>(image, compression);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> imageData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>å›¾ç‰‡å¤„ç†</category>
      </categories>
      <tags>
        <tag>å›¾ç‰‡å‹ç¼©</tag>
      </tags>
  </entry>
  <entry>
    <title>gitå¸¸ç”¨å‘½ä»¤ä½¿ç”¨</title>
    <url>/2018/07/09/git%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h2 id="åœ¨ç°æœ‰ç›®å½•ä¸­åˆå§‹åŒ–ä»“åº“"><a href="#åœ¨ç°æœ‰ç›®å½•ä¸­åˆå§‹åŒ–ä»“åº“" class="headerlink" title="åœ¨ç°æœ‰ç›®å½•ä¸­åˆå§‹åŒ–ä»“åº“"></a>åœ¨ç°æœ‰ç›®å½•ä¸­åˆå§‹åŒ–ä»“åº“</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">git <span class="keyword">init</span></span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œåï¼Œä¼šåˆ›å»ºä¸€ä¸ª.gitæ–‡ä»¶å¤¹</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">âœ  gitdemoprj git init</span><br><span class="line">Initialized empty Git repository in <span class="string">/Users/xuequan/Desktop/gitdemoprj/.git/</span></span><br><span class="line">âœ  gitdemoprj git:<span class="params">(main)</span> âœ— <span class="keyword">ls</span> -a</span><br><span class="line">.      <span class="string">..</span>     <span class="string">.git</span>   é£Ÿ<span class="string">.md</span></span><br></pre></td></tr></table></figure>
<p>ç›®å‰é»˜è®¤åˆ›å»ºçš„åˆ†æ”¯åæ˜¯mainï¼Œä¸æ˜¯masteräº†ã€‚ä¸æ³¨æ„çš„è¯åç»­ä¸€äº›æ“ä½œæ¯”å¦‚pushç­‰ç­‰å¯èƒ½ä¼šå‡ºé”™ã€‚å¦‚æœgit initæ—¶ä¸æƒ³ä½¿ç”¨é»˜è®¤çš„mainåˆ†æ”¯åæ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<p>æ–¹æ³•1ï¼šåœ¨åˆå§‹åŒ–çš„æ—¶å€™æŒ‡å®šåˆ†æ”¯å</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">git init -b <span class="keyword">master</span> <span class="title">//è¿™é‡ŒæŒ‡å®šä¸ºmaster</span>ã€‚</span><br></pre></td></tr></table></figure>
<p>æ–¹æ³•2ï¼šå…¨å±€è®¾ç½®åˆå§‹åŒ–çš„åˆ†æ”¯åç§°ã€‚</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">git config --<span class="keyword">global</span> <span class="keyword">init</span>.defaultBranch &lt;name&gt;</span><br><span class="line">ç¤ºä¾‹ï¼š</span><br><span class="line">git config --<span class="keyword">global</span> <span class="keyword">init</span>.defaultBranch master</span><br></pre></td></tr></table></figure>
<p>è¯¥å‘½ä»¤ä¼šåœ¨~/.gitconfigæ–‡ä»¶é‡Œæ·»åŠ é…ç½®ï¼š</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[init]</span></span><br><span class="line">	<span class="attr">defaultBranch</span> = master</span><br></pre></td></tr></table></figure>
<p>ä»¥åä½¿ç”¨git initåˆå§‹åŒ–åé»˜è®¤çš„å°±éƒ½æ˜¯masteräº†ã€‚</p>
<p>å¯æ˜¯æˆ‘ç°åœ¨å·²ç»æ˜¯mainåˆ†æ”¯äº†ï¼Œæƒ³ä¿®æ”¹ä¸ºmasteræ€ä¹ˆåŠå‘¢ï¼Ÿé‚£åªèƒ½é‡‡ç”¨ä¿®æ”¹åˆ†æ”¯åçš„æ–¹æ³•å˜ã€‚</p>
<p>psï¼šè¿™ä¸ªæ—¶å€™æŸ¥çœ‹åˆ†æ”¯git branchæ˜¯ä¸ä¼šæ˜¾ç¤ºä»»ä½•åˆ†æ”¯çš„ã€‚å› ä¸ºgitçš„åˆ†æ”¯å¿…é¡»æŒ‡å‘ä¸€ä¸ªcommitï¼Œæ²¡æœ‰ä»»ä½•commitå°±æ²¡æœ‰ä»»ä½•åˆ†æ”¯ï¼Œæäº¤ç¬¬ä¸€ä¸ªcommitågitè‡ªåŠ¨åˆ›å»ºmasteråˆ†æ”¯ã€‚</p>
<p>ç»§ç»­æäº¤æ“ä½œï¼š</p>
<figure class="highlight armasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">git</span> <span class="keyword">add</span> .</span><br><span class="line"><span class="symbol">git</span> commit -m <span class="string">&quot;git init&quot;</span></span><br><span class="line"><span class="symbol">git</span> branch</span><br><span class="line">* master  <span class="comment">//å‡ºç°äº†ã€‚</span></span><br></pre></td></tr></table></figure>
<h2 id="æŸ¥çœ‹åˆ†æ”¯"><a href="#æŸ¥çœ‹åˆ†æ”¯" class="headerlink" title="æŸ¥çœ‹åˆ†æ”¯"></a>æŸ¥çœ‹åˆ†æ”¯</h2><figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line">git branch<span class="comment"> //æŸ¥çœ‹æœ¬åœ°æ‰€æœ‰åˆ†æ”¯</span></span><br><span class="line">git branch -r<span class="comment"> //æŸ¥çœ‹è¿œç¨‹æ‰€æœ‰åˆ†æ”¯</span></span><br><span class="line">git branch -<span class="keyword">a</span><span class="comment"> //æŸ¥çœ‹æœ¬åœ°å’Œè¿œç¨‹æ‰€æœ‰åˆ†æ”¯</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯è¿œç¨‹åˆ†æ”¯åˆ™å‰é¢ä¼šæœ‰<code>remotes/</code></p>
<h2 id="ä¿®æ”¹åˆ†æ”¯å"><a href="#ä¿®æ”¹åˆ†æ”¯å" class="headerlink" title="ä¿®æ”¹åˆ†æ”¯å"></a>ä¿®æ”¹åˆ†æ”¯å</h2><p>å‡è®¾è¯¥åˆ†æ”¯è¿˜æ²¡æœ‰æ¨é€åˆ°è¿œç¨‹ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼š</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">git <span class="keyword">branch </span>-m &lt;name&gt;</span><br><span class="line">ç¤ºä¾‹ï¼š</span><br><span class="line">git <span class="keyword">branch </span>-m master</span><br></pre></td></tr></table></figure>
<h2 id="git-ä¸­ä¸€äº›é€‰é¡¹è§£é‡Š"><a href="#git-ä¸­ä¸€äº›é€‰é¡¹è§£é‡Š" class="headerlink" title="git ä¸­ä¸€äº›é€‰é¡¹è§£é‡Š"></a>git ä¸­ä¸€äº›é€‰é¡¹è§£é‡Š</h2><figure class="highlight css"><table><tr><td class="code"><pre><span class="line">-d  <span class="attr">--delete</span>ï¼šåˆ é™¤</span><br><span class="line">-D  <span class="attr">--delete</span> <span class="attr">--force</span>çš„å¿«æ·é”®</span><br><span class="line">-f  <span class="attr">--force</span>ï¼šå¼ºåˆ¶</span><br><span class="line">-m  <span class="attr">--move</span>ï¼šç§»åŠ¨æˆ–é‡å‘½å</span><br><span class="line">-M  <span class="attr">--move</span> <span class="attr">--force</span>çš„å¿«æ·é”®</span><br><span class="line">-<span class="attribute">r</span>  <span class="attr">--remote</span>ï¼šè¿œç¨‹</span><br><span class="line">-<span class="selector-tag">a</span>  <span class="attr">--all</span>ï¼šæ‰€æœ‰</span><br></pre></td></tr></table></figure>
<h2 id="æ·»åŠ è¿œç¨‹ä»“åº“"><a href="#æ·»åŠ è¿œç¨‹ä»“åº“" class="headerlink" title="æ·»åŠ è¿œç¨‹ä»“åº“"></a>æ·»åŠ è¿œç¨‹ä»“åº“</h2><p>å¦‚æœæƒ³å¤šäººåä½œï¼Œé‚£ä¹ˆå°±éœ€è¦ç»™æœ¬åœ°ä»“åº“æ·»åŠ ä¸€ä¸ªè¿œç¨‹ä»“åº“ã€‚</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">git remote <span class="keyword">add </span>&lt;<span class="keyword">shortname&gt; </span>&lt;url&gt;</span><br><span class="line">ç¤ºä¾‹ï¼š</span><br><span class="line">git remote <span class="keyword">add </span><span class="keyword">origin </span>xxx.git</span><br></pre></td></tr></table></figure>
<p>shortnameå°±ä»£è¡¨urlç›¸å½“äºèµ·ä¸ªåå­—ï¼Œæ–¹ä¾¿åç»­æ“ä½œã€‚å½“ç„¶å¦‚æœä½ ä¸å«Œéº»çƒ¦ç›´æ¥ç”¨urlä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œæœ‰æ—¶å€™ä¹Ÿç¡®å®ä¼šç›´æ¥ç”¨urlã€‚</p>
<h2 id="æŸ¥çœ‹è¿œç¨‹ä»“åº“"><a href="#æŸ¥çœ‹è¿œç¨‹ä»“åº“" class="headerlink" title="æŸ¥çœ‹è¿œç¨‹ä»“åº“"></a>æŸ¥çœ‹è¿œç¨‹ä»“åº“</h2><figure class="highlight maxima"><table><tr><td class="code"><pre><span class="line">git remote</span><br><span class="line">git remote -v</span><br><span class="line">git remote <span class="built_in">show</span> <span class="built_in">origin</span></span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">âœ  gitdemoprj git:(<span class="literal">master</span>) git remote</span><br><span class="line">origin</span><br><span class="line">âœ  gitdemoprj git:(<span class="literal">master</span>) git remote -v  //æŸ¥çœ‹è¿œç¨‹ä»“åº“è¯¦ç»†ä¿¡æ¯ï¼Œä¼šå±•ç¤ºå‡ºå¯¹åº”url</span><br><span class="line">origin	example.git (fetch)</span><br><span class="line">origin	example.git (push)</span><br><span class="line">âœ  gitdemoprj git:(<span class="literal">master</span>) git remote show origin //æ›´åŠ è¯¦ç»†çš„ä¿¡æ¯</span><br><span class="line">* remote origin</span><br><span class="line">  Fetch URL: example.git</span><br><span class="line">  Push  URL: example.git</span><br><span class="line">  HEAD branch: <span class="keyword">master</span></span><br><span class="line">  <span class="title">Remote</span> branch:</span><br><span class="line">    <span class="keyword">master</span> <span class="title">tracked</span></span><br><span class="line">  Local <span class="keyword">ref</span> configured for &#x27;git push&#x27;:</span><br><span class="line">    <span class="keyword">master</span> <span class="title">pushes</span> to <span class="keyword">master</span> <span class="title">(up</span> to <span class="keyword">date</span>)</span><br></pre></td></tr></table></figure>
<h2 id="æ¨é€åˆ°è¿œç¨‹ä»“åº“"><a href="#æ¨é€åˆ°è¿œç¨‹ä»“åº“" class="headerlink" title="æ¨é€åˆ°è¿œç¨‹ä»“åº“"></a>æ¨é€åˆ°è¿œç¨‹ä»“åº“</h2><p><strong>git push</strong> å‘½ä»¤ç”¨äºå°†æœ¬åœ°çš„åˆ†æ”¯ç‰ˆæœ¬ä¸Šä¼ åˆ°è¿œç¨‹å¹¶åˆå¹¶ã€‚</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">git push <span class="tag">&lt;<span class="name">è¿œç¨‹ä¸»æœºå</span>&gt;</span> <span class="tag">&lt;<span class="name">æœ¬åœ°åˆ†æ”¯å</span>&gt;</span>:<span class="tag">&lt;<span class="name">è¿œç¨‹åˆ†æ”¯å</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>ä»è¿™ä¸ªè¯­æ³•å¯ä»¥çŸ¥é“å¯ä»¥å°†æœ¬åœ°åˆ†æ”¯æ¨é€åˆ°è¿œç¨‹çš„åˆ«çš„åˆ†æ”¯ä¸Šå»ï¼Œå¦‚æœè¿œç¨‹åˆ†æ”¯ä¸å­˜åœ¨åˆ™ä¼šè‡ªåŠ¨åˆ›å»ºã€‚</p>
<p>å¦‚æœæœ¬åœ°åˆ†æ”¯åä¸è¿œç¨‹åˆ†æ”¯åç›¸åŒï¼Œåˆ™å¯ä»¥çœç•¥å†’å·ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">git push <span class="tag">&lt;<span class="name">è¿œç¨‹ä¸»æœºå</span>&gt;</span> <span class="tag">&lt;<span class="name">æœ¬åœ°åˆ†æ”¯å</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>eg:</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">git push origin <span class="keyword">master</span> <span class="title">//ç­‰ä»·äºgit</span> push origin <span class="literal">master</span>:<span class="literal">master</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœæœ¬åœ°ç‰ˆæœ¬ä¸è¿œç¨‹ç‰ˆæœ¬æœ‰å·®å¼‚ï¼Œä½†åˆè¦å¼ºåˆ¶æ¨é€å¯ä»¥ä½¿ç”¨ â€”force å‚æ•°ï¼š</p>
<figure class="highlight maxima"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">push</span> --force <span class="built_in">origin</span> master</span><br></pre></td></tr></table></figure>
<p>-fé€‰é¡¹éœ€è¦æ…é‡è€ƒè™‘ï¼Œä½†å¦‚æœä¸€ä¸ªåˆ†æ”¯è·Ÿè¸ªçš„éƒ½æ˜¯ä¸€äº›è‡ªåŠ¨ç”Ÿæˆçš„ä¸œè¥¿ï¼Œé‚£ä¹ˆå¼ºåˆ¶æ¨é€å°±å¾ˆæœ‰ç”¨ã€‚ç›¸å½“äºå¿½ç•¥è¿œç¨‹çš„å†…å®¹éƒ½ä½¿ç”¨æœ¬æ¬¡æäº¤çš„ã€‚</p>
<p>git pushå¯ä»¥å°†ä¸€ä¸ªå®Œå…¨æ˜¯æœ¬åœ°ä»“åº“çš„å†…å®¹æ¨é€åˆ°æŸä¸ªè¿œç¨‹ä»“åº“çš„æŸä¸ªåˆ†æ”¯ã€‚è¿™ä¸ªå¤ªå¼ºäº†ã€‚</p>
<p>egï¼šå°†æœ¬åœ°masteråˆ†æ”¯çš„å†…å®¹æ¨é€åˆ°è¿œç¨‹ä»“åº“<code>git@github.com:example.git</code> çš„autopageåˆ†æ”¯ã€‚</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line">git push -f git<span class="keyword">@github</span>.<span class="attribute">com</span>:example.git <span class="attribute">master</span>:autopage</span><br></pre></td></tr></table></figure>
<h2 id="æ‹‰å–è¿œç¨‹ä»“åº“"><a href="#æ‹‰å–è¿œç¨‹ä»“åº“" class="headerlink" title="æ‹‰å–è¿œç¨‹ä»“åº“"></a>æ‹‰å–è¿œç¨‹ä»“åº“</h2><p><strong>git pull</strong> å‘½ä»¤ç”¨äºä»è¿œç¨‹è·å–ä»£ç å¹¶åˆå¹¶æœ¬åœ°çš„ç‰ˆæœ¬ã€‚</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">git pull <span class="tag">&lt;<span class="name">è¿œç¨‹ä¸»æœºå</span>&gt;</span> <span class="tag">&lt;<span class="name">è¿œç¨‹åˆ†æ”¯å</span>&gt;</span>:<span class="tag">&lt;<span class="name">æœ¬åœ°åˆ†æ”¯å</span>&gt;</span></span><br><span class="line">git pull //å¦‚æœè¿œç¨‹åˆ†æ”¯æ˜¯ä¸å½“å‰åˆ†æ”¯åˆå¹¶ï¼Œå¯ä»¥ç®€å†™</span><br></pre></td></tr></table></figure>
<h2 id="è®¾ç½®æœ¬åœ°åˆ†æ”¯è·Ÿè¸ªè¿œç¨‹åˆ†æ”¯"><a href="#è®¾ç½®æœ¬åœ°åˆ†æ”¯è·Ÿè¸ªè¿œç¨‹åˆ†æ”¯" class="headerlink" title="è®¾ç½®æœ¬åœ°åˆ†æ”¯è·Ÿè¸ªè¿œç¨‹åˆ†æ”¯"></a>è®¾ç½®æœ¬åœ°åˆ†æ”¯è·Ÿè¸ªè¿œç¨‹åˆ†æ”¯</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">git branch --set-upstream-to=origin/<span class="tag">&lt;<span class="name">è¿œç¨‹åˆ†æ”¯å</span>&gt;</span> <span class="tag">&lt;<span class="name">æœ¬åœ°åˆ†æ”¯å</span>&gt;</span></span><br><span class="line">git branch -u origin/<span class="tag">&lt;<span class="name">è¿œç¨‹åˆ†æ”¯å</span>&gt;</span> <span class="tag">&lt;<span class="name">æœ¬åœ°åˆ†æ”¯å</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>æ·»åŠ è¿œç¨‹ä»“åº“åå¹¶ä¸æ„å‘³ç€åˆ†æ”¯ä¹Ÿå·²ç»è®¾ç½®è·Ÿè¸ªï¼Œæœ‰æ—¶å€™éœ€è¦æ‰‹åŠ¨è®¾ç½®ã€‚å¦‚æœæ²¡æœ‰è®¾ç½®çš„è¯ï¼Œgit pullå°±ä¼šæç¤ºï¼š</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">âœ  gitdemoprj git:(master) git pull <span class="comment">--verbose</span></span><br><span class="line"><span class="keyword">From</span> github.com:xq<span class="number">-120</span>/gitdemo</span><br><span class="line"> = [up <span class="keyword">to</span> <span class="type">date</span>]      autopage   -&gt; origin/autopage</span><br><span class="line"> = [up <span class="keyword">to</span> <span class="type">date</span>]      master     -&gt; origin/master</span><br><span class="line">There <span class="keyword">is</span> <span class="keyword">no</span> tracking information <span class="keyword">for</span> the <span class="keyword">current</span> branch.</span><br><span class="line">Please specify which branch you want <span class="keyword">to</span> merge <span class="keyword">with</span>.</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæƒ³è¦æŸ¥çœ‹è®¾ç½®çš„æ‰€æœ‰è·Ÿè¸ªåˆ†æ”¯ï¼Œå¯ä»¥ä½¿ç”¨ <code>git branch</code> çš„ <code>-vv</code> é€‰é¡¹ã€‚ è¿™ä¼šå°†æ‰€æœ‰çš„æœ¬åœ°åˆ†æ”¯åˆ—å‡ºæ¥å¹¶ä¸”åŒ…å«æ›´å¤šçš„ä¿¡æ¯ï¼Œå¦‚æ¯ä¸€ä¸ªåˆ†æ”¯æ­£åœ¨è·Ÿè¸ªå“ªä¸ªè¿œç¨‹åˆ†æ”¯ä¸æœ¬åœ°åˆ†æ”¯æ˜¯å¦æ˜¯é¢†å…ˆã€è½åæˆ–æ˜¯éƒ½æœ‰ã€‚</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">git branch -vv</span><br><span class="line">//æ‰“å°</span><br><span class="line">* <span class="keyword">master</span> <span class="title">abae279</span> git init</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æœ¬åœ°masteråˆ†æ”¯è¿˜æ²¡æœ‰è·Ÿè¸ªä»»ä½•è¿œç¨‹åˆ†æ”¯ã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">âœ  gitdemoprj git:(<span class="literal">master</span>) git branch -u origin/<span class="keyword">master</span> <span class="title">master</span></span><br><span class="line">branch &#x27;<span class="literal">master</span>&#x27; set up to track &#x27;origin/<span class="literal">master</span>&#x27;.</span><br><span class="line"></span><br><span class="line">âœ  gitdemoprj git:(<span class="literal">master</span>) git branch -vv</span><br><span class="line">* <span class="keyword">master</span> <span class="title">abae279</span> [origin/<span class="literal">master</span>] git init  //æœ¬åœ°<span class="literal">master</span>åˆ†æ”¯å·²è®¾ç½®è·Ÿè¸ªè¿œç¨‹åˆ†æ”¯origin/<span class="literal">master</span>ã€‚</span><br></pre></td></tr></table></figure>
<ul>
<li><p>æŸ¥çœ‹tag<code>git tag â€”list</code></p>
</li>
<li><p>è·å–æŒ‡å®šçš„tagå¤„ä»£ç <code>git checkout tag</code><br>ä¾‹å¦‚ï¼šgit checkout v0.1.0</p>
</li>
<li><p>åˆ›å»ºæœ¬åœ°åˆ†æ”¯<code>git branch åˆ†æ”¯å</code></p>
</li>
<li><p>æäº¤æœ¬åœ°åˆ†æ”¯åˆ°æœåŠ¡å™¨<code>git push origin &lt;local_branch_name&gt;:&lt;remote_branch_name&gt;</code></p>
</li>
<li><p>åˆ é™¤æœ¬åœ°åˆ†æ”¯<code>git branch -d &lt;BranchName&gt;</code><br>æ³¨æ„:å¤„äºå½“å‰åˆ†æ”¯æ˜¯ä¸èƒ½è¿›è¡Œåˆ é™¤åˆ†æ”¯è‡ªèº«æ“ä½œçš„.</p>
</li>
<li><p>åˆ é™¤è¿œç¨‹åˆ†æ”¯<code>git push origin :åˆ†æ”¯å</code></p>
</li>
<li><p>æ ¹æ®tagåˆ›å»ºåˆ†æ”¯<code>git branch &lt;new-branch-name&gt; &lt;tag-name&gt;</code>ä¼šæ ¹æ®tagåˆ›å»ºæ–°çš„åˆ†æ”¯.<br>ä¾‹å¦‚:git branch newbranch v1.0 . ä¼šä»¥tag v1.0åˆ›å»ºæ–°çš„åˆ†æ”¯newbranch.</p>
</li>
<li><p>git ignoreæ–‡ä»¶</p>
<p>å¦‚æœæŸäº›æ–‡ä»¶å·²ç»è¢«çº³å…¥äº†ç‰ˆæœ¬ç®¡ç†ä¸­ï¼Œå°±ç®—æ˜¯åœ¨.gitignoreä¸­å·²ç»å£°æ˜äº†å¿½ç•¥è·¯å¾„ä¹Ÿæ˜¯ä¸èµ·ä½œç”¨çš„ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±åº”è¯¥å…ˆæŠŠæœ¬åœ°ç¼“å­˜åˆ é™¤ï¼Œç„¶åå†è¿›è¡Œgitçš„pushï¼Œè¿™æ ·å°±ä¸ä¼šå‡ºç°å¿½ç•¥çš„æ–‡ä»¶äº†ã€‚gitæ¸…é™¤æœ¬åœ°ç¼“å­˜å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">gitÂ rmÂ <span class="operator">-</span>rÂ <span class="comment">--cachedÂ .</span></span><br><span class="line">gitÂ <span class="keyword">add</span>Â .</span><br><span class="line">gitÂ <span class="keyword">commit</span>Â <span class="operator">-</span>mÂ <span class="string">&#x27;updateÂ .gitignore&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="åˆ‡æ¢åˆ†æ”¯"><a href="#åˆ‡æ¢åˆ†æ”¯" class="headerlink" title="åˆ‡æ¢åˆ†æ”¯"></a>åˆ‡æ¢åˆ†æ”¯</h2><ol>
<li><p>gité¦–æ¬¡åˆ‡æ¢åˆ°å·²ç»å­˜åœ¨çš„åˆ†æ”¯.<br>å…ˆæŸ¥çœ‹åˆ†æ”¯<code>git branch -a</code>å†<code>git checkout origin/dev</code>è¿™ä¸ªæ—¶å€™å·²ç»å‡ºç°äº†devåˆ†æ”¯ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸åœ¨è¿™ä¸ªåˆ†æ”¯ä¸Š.å¯ä»¥æ‰§è¡Œä¸€ä¸‹:<br><code>git branch -l</code>çœ‹çœ‹æˆ‘ä»¬å½“å‰å¤„äºå“ªä¸ªåˆ†æ”¯ä¸Š.è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†æ‰§è¡Œä¸€ä¸‹ï¼š<code>git checkout dev</code>å°±å¯ä»¥äº†.</p>
</li>
<li><p>å¦‚æœå·²ç»åˆ‡æ¢è¿‡äº†åˆ™åªéœ€è¦<code>git checkout åˆ†æ”¯å</code></p>
</li>
</ol>
<h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><h3 id="1-fatal-refusing-to-merge-unrelated-histories"><a href="#1-fatal-refusing-to-merge-unrelated-histories" class="headerlink" title="1.fatal: refusing to merge unrelated histories"></a>1.fatal: refusing to merge unrelated histories</h3><p>åœºæ™¯æè¿°ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/%E6%88%AA%E5%B1%8F2024-02-11%2012.10.50.png" style="zoom:50%;" /></p>
<p>æœ¬åœ°çš„autopageåˆ†æ”¯æ˜¯ä»masteråˆ†æ”¯æ‹‰å‡ºæ¥çš„ï¼Œç„¶åè®¾ç½®äº†è·Ÿè¸ªè¿œç¨‹origin/autopageåˆ†æ”¯ï¼Œæ‰§è¡Œgit pullæ—¶æŠ¥ä¸Šè¿°é”™è¯¯ï¼ŒåŸå› å°±æ˜¯è¿œç¨‹origin/autopageåˆ†æ”¯å’Œæœ¬åœ°autopageåˆ†æ”¯æ²¡æœ‰å…¬å…±èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯æ¯«ä¸ç›¸å…³ï¼Œgitæ— æ³•å¸®ä½ è‡ªåŠ¨è¿›è¡Œåˆå¹¶ã€‚ä¸¤ä¸ªåˆ†æ”¯çš„å†…å®¹å¦‚ä¸‹ç¡®å®æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œæ‰€ä»¥éœ€è¦è‡ªå·±å†³å®šå¦‚ä½•åˆå¹¶ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/%E6%88%AA%E5%B1%8F2024-02-11%2012.14.58.png" style="zoom:50%;" /></p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/%E6%88%AA%E5%B1%8F2024-02-11%2012.15.13.png" style="zoom:50%;" /></p>
<p>è§£å†³åŠæ³•ï¼šåŠ å‚æ•°â€”allow-unrelated-histories</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">git pull <span class="comment">--allow-unrelated-histories</span></span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯åˆå¹¶åçš„å›¾è¡¨ï¼š</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/%E6%88%AA%E5%B1%8F2024-02-11%2012.25.50.png" style="zoom:50%;" /></p>
<p>æ‰§è¡Œå®Œæˆåè¿œç¨‹çš„å†…å®¹åŸå°ä¸åŠ¨ä¿å­˜åœ¨æœ¬åœ°åˆ†æ”¯ã€‚</p>
<h3 id="2-ç»ˆç«¯git-statusæ— æ³•æ˜¾ç¤ºæ±‰å­—ï¼Œè€Œæ˜¯ä¸€å †utf8ç¼–ç "><a href="#2-ç»ˆç«¯git-statusæ— æ³•æ˜¾ç¤ºæ±‰å­—ï¼Œè€Œæ˜¯ä¸€å †utf8ç¼–ç " class="headerlink" title="2.ç»ˆç«¯git statusæ— æ³•æ˜¾ç¤ºæ±‰å­—ï¼Œè€Œæ˜¯ä¸€å †utf8ç¼–ç "></a>2.ç»ˆç«¯git statusæ— æ³•æ˜¾ç¤ºæ±‰å­—ï¼Œè€Œæ˜¯ä¸€å †utf8ç¼–ç </h3><p>è§£å†³åŠæ³•ï¼š</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line">git config --global core.quotepath <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/0013760174128707b935b0be6fc4fc6ace66c4f15618f8d000">å¤šäººåä½œ</a></p>
<p><a href="https://blog.csdn.net/qq_39671159/article/details/81261049">git branchä¸æ˜¾ç¤ºæœ¬åœ°åˆ†æ”¯çš„é—®é¢˜ï¼ˆäºŒï¼‰</a></p>
<p><a href="https://www.runoob.com/git/git-push.html">Gitæ•™ç¨‹</a>  4</p>
<p><a href="https://www.progit.cn">Pro Git</a>  5</p>
]]></content>
      <categories>
        <category>Git</category>
      </categories>
  </entry>
  <entry>
    <title>TTTAttributedLabelä½¿ç”¨</title>
    <url>/2018/07/09/TTTAttributedLabel%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h2 id="TTTAttributedLabelä½¿ç”¨"><a href="#TTTAttributedLabelä½¿ç”¨" class="headerlink" title="TTTAttributedLabelä½¿ç”¨"></a>TTTAttributedLabelä½¿ç”¨</h2><p>Q1:ä½¿ç”¨podç®¡ç†TTTAttributedLabel,åœ¨XIBä¸­ä½¿ç”¨ä¼šå¯¼è‡´XIBæŠ¥é”™å¹¶ä¸”ä¸€ç‰‡ç©ºç™½.</p>
<p>A:æ²¡æ‰¾åˆ°ä¸€ç§å¥½çš„è§£å†³åŠæ³•,åªèƒ½ä¸ä½¿ç”¨XIB.</p>
<p>Q2:ä½¿ç”¨TTTAttributedLabel,åœ¨èŠå¤©cell(xibå®ç°)ä¸­,ç‚¹å‡»é“¾æ¥ä»£ç†æ–¹æ³•ä¸è¢«è°ƒç”¨,åŸå› æ˜¯TTTAttributedLabelçš„touchesCancelledä¸€ç›´è¢«è°ƒç”¨äº†,touchesEndedæ²¡è¢«è°ƒç”¨.</p>
<p>A2:ä»£ç ä¸­æœ‰æ·»åŠ ç‚¹å‡»æ‰‹åŠ¿å¯¼è‡´labelçš„touchäº‹ä»¶æ€»æ˜¯è¢«cancel.</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">UITapGestureRecognizer</span> *tapGes = [[<span class="built_in">UITapGestureRecognizer</span> alloc] initWithTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(tappedView:)];</span><br><span class="line">tapGes.delegate = <span class="keyword">self</span>;</span><br><span class="line">tapGes.cancelsTouchesInView = <span class="literal">NO</span>; <span class="comment">//é‡è¦</span></span><br><span class="line">[<span class="keyword">self</span>.view addGestureRecognizer:tapGes];</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ‰‹åŠ¿ä¸å“åº”è€…é“¾</p>
<p>çˆ¶è§†å›¾ä¸Šæ·»åŠ äº†ç‚¹å‡»æ‰‹åŠ¿,æœ‰æ—¶(ä¸æ˜¯æ¯æ¬¡)ä¼šå¯¼è‡´çˆ¶è§†å›¾ä¸Šçš„UIButtonçš„actionæ–¹æ³•ä¸ä¼šè¢«è°ƒç”¨.<br>åŸå› åœ¨äºå¦‚æœçˆ¶è§†å›¾è¯†åˆ«å‡ºäº†æ‰‹åŠ¿,é‚£ä¹ˆä¼šcancelæ‰UITouch.ä»è€Œç¬¬ä¸€å“åº”è€…ä¼šæ”¶åˆ°touchesCancelledæ¶ˆæ¯.åŸºæœ¬ä¸Šé‚£äº›åŸæœ¬ä¸æ¥å—ç”¨æˆ·äº‹ä»¶çš„æ§ä»¶æ¯”å¦‚UILabelå³ä½¿è®¾ç½®userInteractionEnabled=YES,ä½†å®ƒçš„touchesEndedå°†ä¸ä¼šè¢«è°ƒç”¨.è€ŒUIControlå­ç±»æ§ä»¶ä»–ä»¬çš„actionæ–¹æ³•æœ‰æ—¶ä¸ä¼šè¢«è°ƒç”¨.</p>
</blockquote>
]]></content>
      <categories>
        <category>ç¬¬ä¸‰æ–¹åº“ä½¿ç”¨</category>
      </categories>
      <tags>
        <tag>TTTAttributedLabel</tag>
      </tags>
  </entry>
  <entry>
    <title>SCLAlertViewä½¿ç”¨</title>
    <url>/2018/07/09/SCLAlertView%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h2 id="SCLAlertViewä½¿ç”¨"><a href="#SCLAlertViewä½¿ç”¨" class="headerlink" title="SCLAlertViewä½¿ç”¨"></a>SCLAlertViewä½¿ç”¨</h2><p>SCLAlertViewè®¾ç½®</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)showPopView</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//æäº¤æˆåŠŸ</span></span><br><span class="line">    SCLAlertView *alertView = [[SCLAlertView alloc] initWithNewWindowWidth:<span class="number">310</span>];</span><br><span class="line">    <span class="comment">//å»æ‰é¡¶éƒ¨åœ†åœˆ</span></span><br><span class="line">    [alertView removeTopCircle];</span><br><span class="line">    <span class="comment">//æŒ‰é’®æ°´å¹³æ”¾ç½®</span></span><br><span class="line">    [alertView setHorizontalButtons:<span class="literal">YES</span>];</span><br><span class="line">    <span class="comment">//è®¾ç½®å‡ºç°åŠ¨ç”»</span></span><br><span class="line">    alertView.showAnimationType = SCLAlertViewShowAnimationSimplyAppear;</span><br><span class="line">    alertView.shouldDismissOnTapOutside = <span class="literal">NO</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è®¾ç½®titleçš„å­—ä½“å’Œé¢œè‰²</span></span><br><span class="line">    alertView.labelTitle.font = [<span class="built_in">UIFont</span> pingFangSCWithSize:<span class="number">16</span>];</span><br><span class="line">    alertView.labelTitle.textColor = [<span class="built_in">UIColor</span> blackColor];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è®¾ç½®å¯Œæ–‡æœ¬çš„subTitle</span></span><br><span class="line">    alertView.attributedFormatBlock = ^<span class="built_in">NSAttributedString</span> *(<span class="built_in">NSString</span> *value) &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="built_in">NSString</span> attributeString:value subString:<span class="string">@&quot;13812341234&quot;</span> subStrColor:kRedColorRegular font:[<span class="built_in">UIFont</span> pingFangSCWithSize:<span class="number">16</span>] otherStrColor:[<span class="built_in">UIColor</span> colorWithHexString:<span class="string">@&quot;#818181&quot;</span>]];</span><br><span class="line">    &#125;;</span><br><span class="line">    [alertView setBodyTextFontFamily:<span class="string">@&quot;PingFangSC-Regular&quot;</span> withSize:<span class="number">16</span>];</span><br><span class="line">    <span class="comment">//è®¾ç½®æ™®é€šæ–‡æœ¬çš„subTitle</span></span><br><span class="line"><span class="comment">//    alertView.viewText.font = [UIFont pingFangSCWithSize:16];</span></span><br><span class="line"><span class="comment">//    alertView.viewText.textColor = [UIColor colorWithHexString:@&quot;#818181&quot;];</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½®Buttons, top circle and bordersçš„é¢œè‰²ç®€ä¾¿æ–¹æ³•</span></span><br><span class="line">    alertView.customViewColor = [<span class="built_in">UIColor</span> redColor];</span><br><span class="line">    <span class="comment">//ç»Ÿä¸€è®¾ç½®æŒ‰é’®çš„é…ç½®å¼ºå¤§æ–¹æ³•</span></span><br><span class="line">    alertView.buttonFormatBlock = ^ <span class="built_in">NSDictionary</span> *&#123;</span><br><span class="line">        <span class="keyword">return</span> @&#123;<span class="string">@&quot;backgroundColor&quot;</span>: [<span class="built_in">UIColor</span> cyanColor]&#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    SCLButton *authPersonalBtn = [alertView addButton:<span class="string">@&quot;å–æ¶ˆ&quot;</span> actionBlock:^(<span class="type">void</span>) &#123;</span><br><span class="line">        DLog(<span class="string">@&quot;å–æ¶ˆæŒ‰é’®è¢«æŒ‰ä¸‹&quot;</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">    authPersonalBtn.titleLabel.font = [<span class="built_in">UIFont</span> pingFangSCWithSize:<span class="number">16</span>];</span><br><span class="line">    authPersonalBtn.buttonFormatBlock = ^ <span class="built_in">NSDictionary</span> *&#123;</span><br><span class="line">        <span class="keyword">return</span> @&#123;<span class="string">@&quot;backgroundColor&quot;</span>: [<span class="built_in">UIColor</span> whiteColor], <span class="string">@&quot;textColor&quot;</span>: [<span class="built_in">UIColor</span> colorWithHexString:<span class="string">@&quot;#818181&quot;</span>], <span class="string">@&quot;borderWidth&quot;</span>: @<span class="number">0</span>&#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    SCLButton *authCompanyBtn = [alertView addButton:<span class="string">@&quot;å»æ³¨å†Œ&quot;</span> actionBlock:^(<span class="type">void</span>) &#123;</span><br><span class="line">        DLog(<span class="string">@&quot;å»æ³¨å†ŒæŒ‰é’®è¢«æŒ‰ä¸‹&quot;</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">    authCompanyBtn.titleLabel.font = [<span class="built_in">UIFont</span> pingFangSCWithSize:<span class="number">16</span>];</span><br><span class="line">    <span class="comment">//å•ç‹¬è®¾ç½®æŸä¸ªæŒ‰é’®çš„é…ç½®</span></span><br><span class="line">    authCompanyBtn.buttonFormatBlock = ^ <span class="built_in">NSDictionary</span> *&#123;</span><br><span class="line">        <span class="keyword">return</span> @&#123;<span class="string">@&quot;backgroundColor&quot;</span>: [<span class="built_in">UIColor</span> whiteColor], <span class="string">@&quot;textColor&quot;</span>: [<span class="built_in">UIColor</span> blackColor], <span class="string">@&quot;borderWidth&quot;</span>: @<span class="number">0</span>&#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    [alertView showSuccess:<span class="keyword">self</span> title:<span class="string">@&quot;æ‰‹æœºå·ç æœªæ³¨å†Œ&quot;</span> subTitle:<span class="string">@&quot;æ‰‹æœºå·ç  13812341234 æœªæ³¨å†Œï¼Œ è¯·æ³¨å†Œåå†ç™»å½•ã€‚&quot;</span> closeButtonTitle:<span class="literal">nil</span> duration:<span class="number">0.0</span>f];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>ç¬¬ä¸‰æ–¹åº“ä½¿ç”¨</category>
      </categories>
      <tags>
        <tag>SCLAlertView</tag>
      </tags>
  </entry>
  <entry>
    <title>UITextFieldç¬”è®°</title>
    <url>/2018/07/09/UITextField%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h2 id="UITextFieldç¬”è®°"><a href="#UITextFieldç¬”è®°" class="headerlink" title="UITextFieldç¬”è®°"></a>UITextFieldç¬”è®°</h2><h3 id="ç›‘å¬æ–‡æœ¬è¾“å…¥å˜åŒ–"><a href="#ç›‘å¬æ–‡æœ¬è¾“å…¥å˜åŒ–" class="headerlink" title="ç›‘å¬æ–‡æœ¬è¾“å…¥å˜åŒ–"></a>ç›‘å¬æ–‡æœ¬è¾“å…¥å˜åŒ–</h3><p>æ–¹æ³•1: addTarget â€” UIControlEventValueChanged</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">[<span class="keyword">self</span>.passwordTextField addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(passwordTextFieldTextDidChanged:) forControlEvents:<span class="built_in">UIControlEventValueChanged</span>];</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ–¹æ³•2: æ³¨å†Œé€šçŸ¥ â€” UITextFieldTextDidChangeNotification</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">[[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(passwordTextFieldTextDidChanged:) name:<span class="built_in">UITextFieldTextDidChangeNotification</span> object:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>
<p>note:</p>
<ol>
<li>å½“ç‚¹å‡»æ¸…ç©ºæŒ‰é’®æ—¶,åªæœ‰æ³¨å†Œé€šçŸ¥çš„æ–¹æ¡ˆ,å›è°ƒæ–¹æ³•è¢«è°ƒç”¨äº†.</li>
<li>ç›´æ¥å¯¹textFieldçš„textå±æ€§èµ‹å€¼,<code>textField.text = @&quot;dfsfsd&quot;;</code>æ˜¯ä¸ä¼šè§¦å‘UIControlEventValueChangedäº‹ä»¶,å’ŒUITextFieldTextDidChangeNotificationé€šçŸ¥å›è°ƒçš„.å¯ä»¥ä½¿ç”¨<code>textField.text = @&quot;&quot;;[textField insertText:newString];</code></li>
</ol>
]]></content>
      <categories>
        <category>UIKit</category>
      </categories>
      <tags>
        <tag>UITextField</tag>
      </tags>
  </entry>
  <entry>
    <title>åŸŸåç®€ä»‹</title>
    <url>/2018/07/09/%E5%9F%9F%E5%90%8D%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<h2 id="æ ¹åŸŸå"><a href="#æ ¹åŸŸå" class="headerlink" title="æ ¹åŸŸå"></a>æ ¹åŸŸå</h2><p>åœ¨æœ‰äº›åœºåˆï¼Œ<code>www.example.com</code>è¢«å†™æˆ<code>www.example.com.</code>ï¼Œå³æœ€åè¿˜ä¼šå¤šå‡ºä¸€ä¸ªç‚¹ã€‚è¿™ä¸ªç‚¹å°±æ˜¯æ ¹åŸŸåã€‚</p>
<p>ç†è®ºä¸Šï¼Œæ‰€æœ‰åŸŸåæŸ¥è¯¢éƒ½å¿…é¡»å…ˆæŸ¥è¯¢æ ¹åŸŸåï¼Œå› ä¸ºåªæœ‰æ ¹åŸŸåæ‰èƒ½å‘Šè¯‰ä½ ï¼ŒæŸä¸ªé¡¶çº§åŸŸåç”±å“ªå°æœåŠ¡å™¨ç®¡ç†ã€‚äº‹å®ä¸Šä¹Ÿç¡®å®å¦‚æ­¤ï¼ŒICANN ç»´æŠ¤ç€ä¸€å¼ åˆ—è¡¨ï¼Œé‡Œé¢è®°è½½ç€é¡¶çº§åŸŸåå’Œå¯¹åº”çš„æ‰˜ç®¡å•†ã€‚</p>
<h2 id="é¡¶çº§åŸŸå-TLDs"><a href="#é¡¶çº§åŸŸå-TLDs" class="headerlink" title="é¡¶çº§åŸŸå(TLDs)"></a>é¡¶çº§åŸŸå(TLDs)</h2><p>Top-level domainsï¼Œfirst-level domains.<br>é¡¶çº§åŸŸåæ˜¯åŸŸåçš„æœ€åä¸€ä¸ªéƒ¨åˆ†ï¼Œå³æ˜¯åŸŸåæœ€åä¸€ç‚¹ä¹‹åçš„å­—æ¯ï¼Œä¾‹å¦‚åœ¨example.comè¿™ä¸ªåŸŸåä¸­ï¼Œé¡¶çº§åŸŸæ˜¯.comï¼ˆæˆ–.COMï¼‰ï¼Œå¤§å°å†™è§†ä¸ºç›¸åŒã€‚</p>
<h2 id="äºŒçº§åŸŸå-SLD"><a href="#äºŒçº§åŸŸå-SLD" class="headerlink" title="äºŒçº§åŸŸå(SLD)"></a>äºŒçº§åŸŸå(SLD)</h2><p>second-level domain,æœ€é è¿‘é¡¶çº§åŸŸåå·¦ä¾§çš„å­—æ®µã€‚å¦‚ï¼šzh.wikipedia.orgä¸­ï¼Œwikipediaå°±æ˜¯äºŒçº§åŸŸå.</p>
<h2 id="çˆ¶åŸŸåã€å­åŸŸå"><a href="#çˆ¶åŸŸåã€å­åŸŸå" class="headerlink" title="çˆ¶åŸŸåã€å­åŸŸå"></a>çˆ¶åŸŸåã€å­åŸŸå</h2><p>è¿™æ˜¯ä¸€ä¸ªç›¸å¯¹æ¦‚å¿µ.<br>å¦‚ www.sina.com.cn  å’Œ news.sina.com.cn éƒ½æ˜¯ sina.com.cn çš„å­åŸŸåï¼ˆæˆ–ç§°ä¸ºäºŒçº§åŸŸåï¼‰ï¼Œ sina.com.cn å°±æ˜¯çˆ¶åŸŸåã€‚</p>
<p>åŒæ ·ï¼Œsina.com.cn å…¶å®åˆå¯ä»¥çœ‹ä½œæ˜¯ .com.cn çš„å­åŸŸåï¼›è€Œ com.cn åˆæ˜¯ .cn çš„ä¸€ä¸ªå­åŸŸåã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.jianshu.com/p/88c8ba682ac7">3åˆ†é’Ÿææ‡‚é¡¶çº§åŸŸå|äºŒçº§åŸŸå|å­åŸŸå|çˆ¶åŸŸåçš„åŒºåˆ«</a></p>
<p><a href="https://www.ruanyifeng.com/blog/2018/05/root-domain.html">æ ¹åŸŸåçš„çŸ¥è¯†</a></p>
<p><a href="https://www.guokeyun.com/news/technology/detail/147.html?navId=22">æµ…è°ˆåŸŸååˆ†çº§åŠåŸŸåè§£æè¿‡ç¨‹</a></p>
]]></content>
      <categories>
        <category>HTTP</category>
      </categories>
  </entry>
  <entry>
    <title>NSDataä¸å®ƒçš„å±æ€§bytes</title>
    <url>/2018/07/07/NSData%E4%B8%8E%E5%AE%83%E7%9A%84%E5%B1%9E%E6%80%A7bytes/</url>
    <content><![CDATA[<h4 id="NSDataä¸å®ƒçš„å±æ€§bytes"><a href="#NSDataä¸å®ƒçš„å±æ€§bytes" class="headerlink" title="NSDataä¸å®ƒçš„å±æ€§bytes"></a>NSDataä¸å®ƒçš„å±æ€§bytes</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSString</span>* enString= <span class="string">@&quot;abc&quot;</span>;</span><br><span class="line"><span class="built_in">NSData</span>* utf8EnData = [enString dataUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>byteså±æ€§:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> The -bytes method returns a pointer to a contiguous region of memory managed by the receiver.</span></span><br><span class="line"><span class="comment"> If the regions of memory represented by the receiver are already contiguous, it does so in O(1) time, otherwise it may take longer</span></span><br><span class="line"><span class="comment"> Using -enumerateByteRangesUsingBlock: will be efficient for both contiguous and discontiguous data.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="keyword">const</span> <span class="type">void</span> *bytes <span class="built_in">NS_RETURNS_INNER_POINTER</span>;</span><br></pre></td></tr></table></figure>
<p>byteså±æ€§æŒ‡å‘çš„æ˜¯NSDataå¯¹è±¡è£…è½½çš„å†…å®¹.NSDataè£…è½½çš„äºŒè¿›åˆ¶å†…å®¹åœ¨å†…å­˜ä¸­çš„åˆ†å¸ƒå¯èƒ½æ˜¯è¿ç»­çš„ä¸€ç‰‡,ä¹Ÿå¯èƒ½æ˜¯ä¸è¿ç»­çš„.ä½¿ç”¨<code>- (void) enumerateByteRangesUsingBlock:(void (NS_NOESCAPE ^)(const void *bytes, NSRange byteRange, BOOL *stop))block</code>éå†æ‰€æœ‰çš„åˆ†å¸ƒåŒºåŸŸ.</p>
<p>NSDataå¯¹è±¡æœ¬èº«çš„åœ°å€ä¸è£…è½½çš„äºŒè¿›åˆ¶å†…å®¹çš„åœ°å€,å¦‚ä¸‹å›¾:<br><img src="http://7xqoji.com1.z0.glb.clouddn.com/NSData%E4%B8%8Ebytes%E5%B1%9E%E6%80%A7%E7%9A%84%E5%85%B3%E7%B3%BB@2x.png" alt=""><br>å¯ä»¥çœ‹åˆ°NSDataå¯¹è±¡æœ¬èº«çš„åœ°å€ä¸äºŒè¿›åˆ¶å†…å®¹æ‰€åœ¨çš„åœ°å€æ˜¯ä¸åŒçš„.äºŒè€…å†…å­˜ä½ç½®ç›¸è·è¿˜æŒºè¿œçš„.</p>
<p>æŸ¥çœ‹NSDataå¯¹è±¡è£…è½½çš„äºŒè¿›åˆ¶å†…å®¹æ–¹æ³•:<br><img src="http://7xqoji.com1.z0.glb.clouddn.com/%E6%9F%A5%E7%9C%8BNSData%E7%9A%84%E5%86%85%E5%AD%98%E6%95%B0%E6%8D%AE%E6%96%B9%E6%B3%95@2x.png" alt=""></p>
]]></content>
      <categories>
        <category>Foundation</category>
      </categories>
      <tags>
        <tag>NSData</tag>
      </tags>
  </entry>
  <entry>
    <title>navigationBarå¯¹self.viewçš„frameå½±å“</title>
    <url>/2018/06/10/navigationBar%E5%AF%B9self.view%E7%9A%84frame%E5%BD%B1%E5%93%8D/</url>
    <content><![CDATA[<h3 id="navigationBarå¯¹self-viewçš„frameå½±å“"><a href="#navigationBarå¯¹self-viewçš„frameå½±å“" class="headerlink" title="navigationBarå¯¹self.viewçš„frameå½±å“"></a>navigationBarå¯¹self.viewçš„frameå½±å“</h3><p>åœ¨iOS7åŠä»¥ä¸Šç³»ç»Ÿ,<code>self.navigationController.navigationBar.hidden = NO;</code>çš„æƒ…å†µä¸‹.</p>
<p><strong>è®¾ç½®translucentä¸ºYES</strong>.å³<code>self.navigationController.navigationBar.translucent = YES;</code></p>
<blockquote>
<p>ä¸éšè—çŠ¶æ€æ </p>
</blockquote>
<p>self.viewçš„ä½ç½®å’Œå¤§å°å¦‚ä¸‹:</p>
<p><img src="http://7xqoji.com1.z0.glb.clouddn.com/self.view%E7%9A%84%E4%BD%8D%E7%BD%AE%E5%92%8C%E5%A4%A7%E5%B0%8F1@2x.png" alt=""></p>
<blockquote>
<p>éšè—çŠ¶æ€æ </p>
</blockquote>
<p><img src="http://7xqoji.com1.z0.glb.clouddn.com/self.view%E7%9A%84%E4%BD%8D%E7%BD%AE%E5%92%8C%E5%A4%A7%E5%B0%8F2@2x.png" alt=""></p>
<p>æ‰§è¡Œæµ:<br><img src="http://7xqoji.com1.z0.glb.clouddn.com/navigationBar%E5%AF%B9self.view%E7%9A%84frame%E5%BD%B1%E5%93%8D_3.png" alt=""></p>
<p>translucentä¸ºYESæ—¶,å¯ä»¥åœ¨viewDidLoadä¸­å­è§†å›¾å¯ä»¥ä½¿ç”¨self.viewçš„frameä¿¡æ¯.</p>
<p><strong>è®¾ç½®translucentä¸ºNO</strong>,å³<code>self.navigationController.navigationBar.translucent = NO;</code></p>
<blockquote>
<p>ä¸éšè—çŠ¶æ€æ </p>
</blockquote>
<p>self.viewçš„ä½ç½®å’Œå¤§å°å¦‚ä¸‹:</p>
<p><img src="http://7xqoji.com1.z0.glb.clouddn.com/navigationBar%E5%AF%B9self.view%E7%9A%84frame%E5%BD%B1%E5%93%8D_4.png" alt=""></p>
<blockquote>
<p>éšè—çŠ¶æ€æ </p>
</blockquote>
<p><img src="http://7xqoji.com1.z0.glb.clouddn.com/navigationBar%E5%AF%B9self.view%E7%9A%84frame%E5%BD%B1%E5%93%8D_5.png" alt=""></p>
<p>æ‰§è¡Œæµ:</p>
<p><img src="http://7xqoji.com1.z0.glb.clouddn.com/navigationBar%E5%AF%B9self.view%E7%9A%84frame%E5%BD%B1%E5%93%8D_6.png" alt=""></p>
<p>self.viewåœ¨viewDidLoad,viewWillAppearä¸­çš„origin,sizeéƒ½ä¸å¯¹.åœ¨viewWillLayoutSubviews,viewDidLayoutSubviewsä¸­sizeæ˜¯å¯¹çš„,originä¸å¯¹.åœ¨viewDidAppearä¸­origin,sizeæ‰éƒ½å¯¹.</p>
<p>å› æ­¤åœ¨è¿™ç§æƒ…å†µä¸‹,self.viewçš„å­è§†å›¾å¸ƒå±€æœ€å¥½åœ¨viewWillLayoutSubviewsä¸­è¿›è¡Œè°ƒæ•´.</p>
<p>å½“è®¾ç½®<code>self.navigationController.navigationBar.hidden = YES;</code>æ—¶,åˆ™navigationBarçš„translucentå±æ€§ä¸å†å¯¹self.viewçš„frameäº§ç”Ÿå½±å“.</p>
<h4 id="translucentå±æ€§"><a href="#translucentå±æ€§" class="headerlink" title="translucentå±æ€§"></a>translucentå±æ€§</h4><p>ç”±äºtranslucentå±æ€§å¯¹self.viewçš„frameä¼šäº§ç”Ÿå½±å“,æ‰€ä»¥æœ‰å¿…è¦æŸ¥çœ‹å®ƒçš„è¯´æ˜.</p>
<p>å®˜æ–¹è¯´æ˜:</p>
<figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line">The <span class="keyword">default</span> value <span class="keyword">is</span> YES. <span class="keyword">If</span> the navigation bar <span class="keyword">has</span> a custom background image, the <span class="keyword">default</span> <span class="keyword">is</span> YES <span class="keyword">if</span> any pixel <span class="keyword">of</span> the image <span class="keyword">has</span> an alpha value <span class="keyword">of</span> less than <span class="number">1.0</span>, <span class="keyword">and</span> NO otherwise.</span><br><span class="line"></span><br><span class="line"><span class="keyword">If</span> you <span class="keyword">set</span> this <span class="keyword">property</span> <span class="keyword">to</span> YES <span class="keyword">on</span> a navigation bar <span class="keyword">with</span> an opaque custom background image, the navigation bar applies a system-defined opacity <span class="keyword">of</span> less than <span class="number">1.0</span> <span class="keyword">to</span> the image.</span><br><span class="line"></span><br><span class="line"><span class="keyword">If</span> you <span class="keyword">set</span> this <span class="keyword">property</span> <span class="keyword">to</span> NO <span class="keyword">on</span> a navigation bar <span class="keyword">with</span> a translucent custom background image, the navigation bar provides an opaque background <span class="keyword">for</span> the image <span class="keyword">using</span> black <span class="keyword">if</span> the navigation bar <span class="keyword">has</span> UIBarStyleBlack style, white <span class="keyword">if</span> the navigation bar <span class="keyword">has</span> UIBarStyleDefault, <span class="keyword">or</span> the navigation barâ€™s barTintColor <span class="keyword">if</span> a custom value <span class="keyword">is</span> defined.</span><br></pre></td></tr></table></figure>
<p>å¤§æ„ä¸º:<br>è¯¥å±æ€§é»˜è®¤ä¸ºYES.ä½†æ˜¯å¦‚æœç»™å¯¼èˆªæ è®¾ç½®äº†ä¸€å¼ è‡ªå®šä¹‰çš„èƒŒæ™¯å›¾ç‰‡,å¦‚æœè¯¥å›¾ç‰‡æœ‰ä¸€ä¸ªalpha&lt;1çš„åƒç´ .é‚£ä¹ˆè¯¥å€¼å°±ä¸ºYES,å¦åˆ™ä¸ºNO.(è®¾ç½®å¯¼èˆªæ çš„èƒŒæ™¯å›¾ç‰‡ä¼šå½±å“translucentçš„é»˜è®¤å€¼)</p>
<p>å¦å¤–å¦‚æœæ‰‹åŠ¨è®¾ç½®äº†è¯¥å±æ€§,å¹¶ä¸”è®¾ç½®äº†å¯¼èˆªæ çš„èƒŒæ™¯å›¾,åˆ™ç³»ç»Ÿå¯èƒ½ä¼šå¯¹èƒŒæ™¯å›¾è¿›è¡Œå¤„ç†:</p>
<ol>
<li>å¦‚æœè®¾ç½®è¯¥å±æ€§ä¸ºYES,ä½†æ˜¯æä¾›äº†ä¸€å¼ ä¸é€æ˜çš„èƒŒæ™¯å›¾,ç³»ç»Ÿä¼šå¯¹è¯¥èƒŒæ™¯å›¾è¿›è¡ŒåŠé€æ˜å¤„ç†.</li>
<li>å¦‚æœè®¾ç½®è¯¥å±æ€§ä¸ºNO,ä½†æ˜¯æä¾›äº†ä¸€å¼ åŠé€æ˜çš„èƒŒæ™¯å›¾,åˆ™ç³»ç»Ÿä¼šå¯¹è¯¥èƒŒæ™¯å›¾è¿›è¡Œä¸é€æ˜å¤„ç†.å…·ä½“æ˜¯æ ¹æ®å¯¼èˆªæ çš„styleæˆ–è€…barTintColorè¿›è¡Œå¤„ç†.</li>
</ol>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>åœ¨iOS7åŠä»¥ä¸Šç³»ç»Ÿ:</p>
<ol>
<li><p>å½“å¯¼èˆªæ æ²¡æœ‰è¢«éšè—æ—¶,ä¸”translucentå±æ€§è®¾ç½®ä¸ºYES,é‚£ä¹ˆ,VCçš„self.viewçš„ä½ç½®æ˜¯ä»(0,0)å¼€å§‹,å¤§å°æ˜¯æ•´ä¸ªå±å¹•å®½é«˜.è€Œå½“translucentå±æ€§è®¾ç½®ä¸ºNOæ—¶,é‚£ä¹ˆVCçš„self.viewçš„ä½ç½®æ˜¯ä»å¯¼èˆªæ å·¦ä¸‹è§’å¼€å§‹,å®½æ˜¯å±å¹•çš„å®½,é«˜æ˜¯æ•´ä¸ªå±å¹•å‡å»å¯¼èˆªæ çš„CGRectGetMaxY.</p>
</li>
<li><p>å¯¼èˆªæ çš„yå€¼ä¼šéšç€çŠ¶æ€æ éšè—ä¸å¦è€Œæœ‰20ptçš„åç§».</p>
</li>
<li><p>å½“å¯¼èˆªæ è¢«éšè—æ—¶,VCçš„self.viewçš„ä½ç½®æ˜¯ä»(0,0)å¼€å§‹,å¤§å°æ˜¯æ•´ä¸ªå±å¹•å®½é«˜.</p>
</li>
<li><p>self.viewçš„å­è§†å›¾å¸ƒå±€æ¨èåœ¨viewWillLayoutSubviewsä¸­è¿›è¡Œ.å› ä¸ºæ­¤æ—¶ä¸ç®¡translucentä¸ºä½•å€¼,self.viewçš„sizeéƒ½æ˜¯æ­£ç¡®çš„.</p>
</li>
</ol>
<hr>
<p>åæ§½Jekyll</p>
<p>å†™åœ¨</p>
<p>```</p>
<p>Xcodeçš„æ—¥å¿—</p>
<p>```</p>
<p>è¿™é‡Œé¢çš„æ—¥å¿—,åŒ…å«äº†Viewçš„frameæ‰“å°,å±…ç„¶å¯¼è‡´Jekyllæ„å»ºé¡µé¢å¤±è´¥,è¯´ä»€ä¹ˆå˜é‡æœªæ­£ç¡®å…³é—­,æœ€ååªå¥½ä¸€å¼ å¼ æˆªå›¾.è¿™è§£æåŠŸèƒ½ä¹Ÿå¤ªå·®äº†å§.</p>
]]></content>
      <categories>
        <category>UIKit</category>
      </categories>
      <tags>
        <tag>UIViewController</tag>
        <tag>translucent</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆ¶ä½œé™æ€åº“æ³¨æ„äº‹é¡¹</title>
    <url>/2018/04/15/%E5%88%B6%E4%BD%9CSDK%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/</url>
    <content><![CDATA[<p>åˆ¶ä½œé™æ€åº“æ³¨æ„äº‹é¡¹</p>
<ol>
<li><p>æ·»åŠ å‰ç¼€é˜²æ­¢å†²çª.<br> ç±»å,å…¨å±€å®šä¹‰çš„å˜é‡(å¦‚å…¨å±€å˜é‡,å…¨å±€çš„æšä¸¾å®šä¹‰),ç±»åˆ«æ–¹æ³•å,å®,é€šçŸ¥åç§°.éœ€è¦æ·»åŠ å‰ç¼€é˜²æ­¢ä¸å®¿ä¸»å†²çª.</p>
</li>
<li><p>ä½¿ç”¨staticå…³é”®å­—é™åˆ¶ä½œç”¨åŸŸ.<br> å¯¹äºå…¨å±€å˜é‡,å°½å¯èƒ½ä½¿ç”¨staticé™åˆ¶ä½œç”¨åŸŸ.å¦åˆ™å®¹æ˜“ä¸å®¿ä¸»é‡å¤å®šä¹‰å¯¼è‡´ç¼–è¯‘é”™è¯¯.</p>
</li>
</ol>
]]></content>
      <categories>
        <category>é™æ€åº“</category>
      </categories>
      <tags>
        <tag>é™æ€åº“</tag>
      </tags>
  </entry>
  <entry>
    <title>Swifté™æ€åº“æ³¨æ„äº‹é¡¹</title>
    <url>/2018/04/12/Swift%E9%9D%99%E6%80%81%E5%BA%93%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/</url>
    <content><![CDATA[<h3 id="Swifté™æ€åº“æ³¨æ„äº‹é¡¹"><a href="#Swifté™æ€åº“æ³¨æ„äº‹é¡¹" class="headerlink" title="Swifté™æ€åº“æ³¨æ„äº‹é¡¹"></a>Swifté™æ€åº“æ³¨æ„äº‹é¡¹</h3><p>å·¥ç¨‹æ˜¯Swift,OCæ··ç¼–.å¼€å‘å®Œæˆå,éœ€è¦å°†å·¥ç¨‹åˆ¶ä½œä¸ºä¸€ä¸ªé™æ€åº“.åˆ¶ä½œå®Œæˆæµ‹è¯•ä½¿ç”¨æ—¶,å‘ç°ä¸€è¿è¡Œå°±å´©æºƒ.æç¤º:<br>Unknown class KDLHomeLotteryKindCollectionCell in Interface Builder file.åº”è¯¥æ˜¯å®¿ä¸»å·¥ç¨‹åœ¨åŠ è½½é™æ€åº“å¯¹åº”çš„bundleé‡Œçš„XIBæ–‡ä»¶æ—¶å‡ºé—®é¢˜äº†.</p>
<p>åŸå› åˆ†æåŠè§£å†³åŠæ³•:<br>ç¡®å®šä»¥åŠè‚¯å®šçš„æ˜¯ç³»ç»Ÿåœ¨æŸ¥æ‰¾XIBå¯¹åº”çš„ç±»æ—¶æ²¡æœ‰æ‰¾åˆ°å¯¼è‡´çš„.</p>
<p>åœ¨åˆ¶ä½œé™æ€åº“å’ŒBundleæ—¶,ç±»å’ŒXIBæ–‡ä»¶è¢«åˆ†ç¦»åˆ°å„è‡ªçš„target.è€ŒXIBæ–‡ä»¶æ˜¯è¢«æ‹–å…¥åˆ°bundleä¸­çš„,å› æ­¤éœ€è¦æ›´æ”¹XIBä¹‹å‰çš„é»˜è®¤Moduleè®¾ç½®,å°¤å…¶æ˜¯åˆ›å»ºæ—¶é€‰æ‹©Swiftè¯­è¨€.å¦åˆ™ç³»ç»Ÿåœ¨æŸ¥æ‰¾XIBçš„ç±»æ—¶æ˜¯åœ¨Bundleè¿™ä¸ªModuleä¸­æ‰¾,å½“ç„¶æ˜¯æ‰¾ä¸åˆ°çš„,ä»è€Œåœ¨åŠ è½½æ—¶å´©æºƒ.</p>
<p>è§£å†³åŠæ³•:<br>éœ€è¦æ›´æ”¹XIBå¯¹åº”ç±»çš„æ‰€å±Moduleä¸ºé™æ€åº“çš„Module.æˆ–è€…ä¸å‹¾é€‰Inherit Module From Target,å¹¶æ¸…ç©ºModuleä¸€æ .</p>
<p>note:Swiftåˆ›å»ºçš„XIBé»˜è®¤æ˜¯é€‰ä¸­Inherit Module From Targetçš„.OCåˆ›å»ºçš„XIBæ–‡ä»¶ç³»ç»Ÿé»˜è®¤æ²¡æœ‰å‹¾é€‰.</p>
<p>eg:</p>
<p><img src="http://7xqoji.com1.z0.glb.clouddn.com/Swift%E5%88%9B%E5%BB%BAXIB%E6%96%87%E4%BB%B6@2x.png" alt=""></p>
]]></content>
      <categories>
        <category>é™æ€åº“</category>
      </categories>
  </entry>
  <entry>
    <title>mapå’ŒflapMapçš„ä¸€ç‚¹åŒºåˆ«</title>
    <url>/2018/04/09/map%E5%92%8CflapMap%E7%9A%84%E4%B8%80%E7%82%B9%E5%8C%BA%E5%88%AB/</url>
    <content><![CDATA[<h3 id="Arrayä¸­çš„mapå’ŒflapMapçš„ä¸€ç‚¹åŒºåˆ«"><a href="#Arrayä¸­çš„mapå’ŒflapMapçš„ä¸€ç‚¹åŒºåˆ«" class="headerlink" title="Arrayä¸­çš„mapå’ŒflapMapçš„ä¸€ç‚¹åŒºåˆ«"></a>Arrayä¸­çš„mapå’ŒflapMapçš„ä¸€ç‚¹åŒºåˆ«</h3><p>æ³¨æ„ï¼šmapå’ŒflapMapæ–¹æ³•åœ¨å¾ˆå¤šç±»å‹é‡Œéƒ½æœ‰å®šä¹‰ï¼Œä¸€å®šè¦çœ‹æ¸…æ¥šæ–¹æ³•å£°æ˜ã€‚</p>
<p>mapçš„å£°æ˜:<br><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@inlinable</span> <span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">map</span>&lt;<span class="type">T</span>&gt;(<span class="keyword">_</span> <span class="params">transform</span>: (<span class="type">Element</span>) <span class="keyword">throws</span> -&gt; <span class="type">T</span>) <span class="keyword">rethrows</span> -&gt; [<span class="type">T</span>]</span><br></pre></td></tr></table></figure></p>
<p>å®ƒè¿”å›çš„æ˜¯ä¸€ä¸ªæ•°ç»„.é—­åŒ…çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªæ–°æ•°ç»„çš„å…ƒç´ .  é»˜è®¤æƒ…å†µä¸‹ï¼Œåªè¦é—­åŒ…æœ‰å¯èƒ½è¿”å›ä¸€ä¸ªoptionalç±»å‹å…ƒç´ ï¼Œåˆ™mapè¿”å›çš„å°†æ˜¯ä¸€ä¸ª[T?]æ•°ç»„.</p>
<p>flapMapçš„å£°æ˜:  æœ‰ä¸¤ç§å£°æ˜</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@available</span>(<span class="keyword">swift</span>, deprecated: <span class="number">4.1</span>, renamed: <span class="string">&quot;compactMap(_:)&quot;</span>, message: <span class="string">&quot;Please use compactMap(_:) for the case where closure returns an optional value&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">flatMap</span>&lt;<span class="type">ElementOfResult</span>&gt;(<span class="keyword">_</span> <span class="params">transform</span>: (<span class="type">Element</span>) <span class="keyword">throws</span> -&gt; <span class="type">ElementOfResult</span>?) <span class="keyword">rethrows</span> -&gt; [<span class="type">ElementOfResult</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Returns an array containing the concatenated results of calling the</span></span><br><span class="line"><span class="comment">/// given transformation with each element of this sequence.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Use this method to receive a single-level collection when your</span></span><br><span class="line"><span class="comment">/// transformation produces a sequence or collection for each element.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// In this example, note the difference in the result of using `map` and</span></span><br><span class="line"><span class="comment">/// `flatMap` with a transformation that returns an array.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///     let numbers = [1, 2, 3, 4]</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///     let mapped = numbers.map &#123; Array(repeating: $0, count: $0) &#125;</span></span><br><span class="line"><span class="comment">///     // [[1], [2, 2], [3, 3, 3], [4, 4, 4, 4]]</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///     let flatMapped = numbers.flatMap &#123; Array(repeating: $0, count: $0) &#125;</span></span><br><span class="line"><span class="comment">///     // [1, 2, 2, 3, 3, 3, 4, 4, 4, 4]</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// In fact, `s.flatMap(transform)`  is equivalent to</span></span><br><span class="line"><span class="comment">/// `Array(s.map(transform).joined())`.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - Parameter transform: A closure that accepts an element of this</span></span><br><span class="line"><span class="comment">///   sequence as its argument and returns a sequence or collection.</span></span><br><span class="line"><span class="comment">/// - Returns: The resulting flattened array.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - Complexity: O(*m* + *n*), where *n* is the length of this sequence</span></span><br><span class="line"><span class="comment">///   and *m* is the length of the result.</span></span><br><span class="line"><span class="keyword">@inlinable</span> <span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">flatMap</span>&lt;<span class="type">SegmentOfResult</span>&gt;(<span class="keyword">_</span> <span class="params">transform</span>: (<span class="type">Element</span>) <span class="keyword">throws</span> -&gt; <span class="type">SegmentOfResult</span>) <span class="keyword">rethrows</span> -&gt; [<span class="type">SegmentOfResult</span>.<span class="type">Element</span>] <span class="keyword">where</span> <span class="type">SegmentOfResult</span> : <span class="type">Sequence</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@inlinable</span> <span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">compactMap</span>&lt;<span class="type">ElementOfResult</span>&gt;(<span class="keyword">_</span> <span class="params">transform</span>: (<span class="type">Element</span>) <span class="keyword">throws</span> -&gt; <span class="type">ElementOfResult</span>?) <span class="keyword">rethrows</span> -&gt; [<span class="type">ElementOfResult</span>]</span><br></pre></td></tr></table></figure>
<p>äºŒè€…åŒºåˆ«:  </p>
<ol>
<li><p>flatMapå¯ä»¥ç”¨æ¥å±•å¹³ä¸€ä¸ªæ•°ç»„ï¼šå®ƒæŠŠåŸåºåˆ—é‡Œçš„å…ƒç´ å˜ä¸ºä¸€ä¸ªåºåˆ—ï¼Œç„¶åæŠŠè¿™ä¸ªåºåˆ—çš„å…ƒç´ æ·»åŠ åˆ°ç»“æœåºåˆ—ä¸­ï¼Œç›¸å½“äºé™ç»´äº†ã€‚å±•çš„æœ‰å¤šå¹³å¾—çœ‹transformçš„å®ç°ï¼Œä¸è¿‡æœ€å°‘æ˜¯å‡ä¸€å±‚ã€‚</p>
 <figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> links: [[<span class="type">String</span>]] <span class="operator">=</span> [</span><br><span class="line">    [<span class="string">&quot;http://a1&quot;</span>, <span class="string">&quot;http://a2&quot;</span>, <span class="string">&quot;http://a3&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;http://b1&quot;</span>, <span class="string">&quot;http://b2&quot;</span>, <span class="string">&quot;http://b3&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;http://c1&quot;</span>, <span class="string">&quot;http://c2&quot;</span>, <span class="string">&quot;http://c3&quot;</span>],</span><br><span class="line">]</span><br><span class="line"><span class="built_in">print</span>(links)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> flapLink <span class="operator">=</span> links.flatMap &#123; (exlinks: [<span class="type">String</span>]) -&gt; [<span class="type">String</span>] <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">return</span> exlinks <span class="comment">//å› ä¸ºlinksçš„å…ƒç´ å°±æ˜¯æ•°ç»„æ‰€ä»¥è¿™é‡Œç›´æ¥è¿”å›å°±å¯ä»¥äº†ã€‚</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(flapLink)  <span class="comment">//[&quot;http://a1&quot;, &quot;http://a2&quot;, &quot;http://a3&quot;, &quot;http://b1&quot;, &quot;http://b2&quot;, &quot;http://b3&quot;, &quot;http://c1&quot;, &quot;http://c2&quot;, &quot;http://c3&quot;]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> d3: [[[<span class="type">Int</span>]]] <span class="operator">=</span> [</span><br><span class="line">    [[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>], [<span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]],</span><br><span class="line">    [[<span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>], [<span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>], [<span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>]],</span><br><span class="line">    [[<span class="number">19</span>, <span class="number">20</span>, <span class="number">21</span>], [<span class="number">22</span>, <span class="number">23</span>, <span class="number">24</span>], [<span class="number">25</span>, <span class="number">26</span>, <span class="number">27</span>]],</span><br><span class="line">]</span><br><span class="line"><span class="comment">//[[Int]]</span></span><br><span class="line"><span class="keyword">let</span> flapD1 <span class="operator">=</span> d3.flatMap &#123; ele <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">return</span> ele</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//[Int]</span></span><br><span class="line"><span class="keyword">let</span> flapD2 <span class="operator">=</span> d3.flatMap &#123; ele <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">return</span> ele.flatMap&#123;<span class="variable">$0</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> colors <span class="operator">=</span> [<span class="string">&quot;â™¥&quot;</span>, <span class="string">&quot;â™ &quot;</span>, <span class="string">&quot;â™¦&quot;</span>, <span class="string">&quot;â™£&quot;</span>]</span><br><span class="line"><span class="keyword">let</span> numbers <span class="operator">=</span> [<span class="string">&quot;J&quot;</span>, <span class="string">&quot;Q&quot;</span>, <span class="string">&quot;K&quot;</span>, <span class="string">&quot;A&quot;</span>]</span><br><span class="line"><span class="keyword">let</span> cards <span class="operator">=</span> colors.flatMap &#123; color <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">return</span> numbers.map &#123; num <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;<span class="subst">\(color)</span>-<span class="subst">\(num)</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(cards) <span class="comment">//[&quot;â™¥-J&quot;, &quot;â™¥-Q&quot;, &quot;â™¥-K&quot;, &quot;â™¥-A&quot;, &quot;â™ -J&quot;, &quot;â™ -Q&quot;, &quot;â™ -K&quot;, &quot;â™ -A&quot;, &quot;â™¦-J&quot;, &quot;â™¦-Q&quot;, &quot;â™¦-K&quot;, &quot;â™¦-A&quot;, &quot;â™£-J&quot;, &quot;â™£-Q&quot;, &quot;â™£-K&quot;, &quot;â™£-A&quot;]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>flatMapå¯ä»¥å°†è½¬åŒ–å¤±è´¥çš„nilå…ƒç´ å‰”é™¤,è€Œmapåˆ™ä¸èƒ½:</p>
 <figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> wq <span class="operator">=</span> [<span class="string">&quot;123&quot;</span>, <span class="string">&quot;fsd&quot;</span>, <span class="string">&quot;dfsd&quot;</span>, <span class="string">&quot;34&quot;</span>]</span><br><span class="line"><span class="comment">//ç±»å‹æ˜¯[Int?]</span></span><br><span class="line"><span class="keyword">let</span> wqm <span class="operator">=</span> wq.map &#123; (element) -&gt; <span class="type">Int</span>? <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">return</span> <span class="type">Int</span>(element)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(wqm)  <span class="comment">//[Optional(123), nil, nil, Optional(34)]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ç±»å‹æ˜¯[Int]</span></span><br><span class="line"><span class="keyword">let</span> wqfm <span class="operator">=</span> wq.flatMap &#123; (element) -&gt; <span class="type">Int</span>? <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">return</span> <span class="type">Int</span>(element)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(wqfm) <span class="comment">//[123, 34]</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>ç”±äºå‰”é™¤nilå…ƒç´ çš„ç”¨æ³•å·²ç»è¢«åºŸå¼ƒ,Appleæ¨èä½¿ç”¨compactMapä»£æ›¿,å› æ­¤flatMapçš„ç”¨æ³•ä¸»è¦æ˜¯ç¬¬ä¸€ç§äº†.</p>
<h3 id="Optionalæšä¸¾ç±»å‹ä¸­çš„mapå’ŒflatMap"><a href="#Optionalæšä¸¾ç±»å‹ä¸­çš„mapå’ŒflatMap" class="headerlink" title="Optionalæšä¸¾ç±»å‹ä¸­çš„mapå’ŒflatMap"></a>Optionalæšä¸¾ç±»å‹ä¸­çš„mapå’ŒflatMap</h3><p>map:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="comment">/// Evaluates the given closure when this `Optional` instance is not `nil`,</span></span><br><span class="line"><span class="comment">/// passing the unwrapped value as a parameter.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Use the `map` method with a closure that returns a non-optional value.</span></span><br><span class="line"><span class="comment">/// This example performs an arithmetic operation on an</span></span><br><span class="line"><span class="comment">/// optional integer.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///     let possibleNumber: Int? = Int(&quot;42&quot;)</span></span><br><span class="line"><span class="comment">///     let possibleSquare = possibleNumber.map &#123; $0 * $0 &#125;</span></span><br><span class="line"><span class="comment">///     print(possibleSquare)</span></span><br><span class="line"><span class="comment">///     // Prints &quot;Optional(1764)&quot;</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///     let noNumber: Int? = nil</span></span><br><span class="line"><span class="comment">///     let noSquare = noNumber.map &#123; $0 * $0 &#125;</span></span><br><span class="line"><span class="comment">///     print(noSquare)</span></span><br><span class="line"><span class="comment">///     // Prints &quot;nil&quot;</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - Parameter transform: A closure that takes the unwrapped value</span></span><br><span class="line"><span class="comment">///   of the instance.</span></span><br><span class="line"><span class="comment">/// - Returns: The result of the given closure. If this instance is `nil`,</span></span><br><span class="line"><span class="comment">///   returns `nil`.</span></span><br><span class="line"><span class="keyword">@inlinable</span> <span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">map</span>&lt;<span class="type">U</span>&gt;(<span class="keyword">_</span> <span class="params">transform</span>: (<span class="type">Wrapped</span>) <span class="keyword">throws</span> -&gt; <span class="type">U</span>) <span class="keyword">rethrows</span> -&gt; <span class="type">U</span>?</span><br></pre></td></tr></table></figure>
<p>flatMap:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="comment">/// Evaluates the given closure when this `Optional` instance is not `nil`,</span></span><br><span class="line"><span class="comment">/// passing the unwrapped value as a parameter.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Use the `flatMap` method with a closure that returns an optional value.</span></span><br><span class="line"><span class="comment">/// This example performs an arithmetic operation with an optional result on</span></span><br><span class="line"><span class="comment">/// an optional integer.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///     let possibleNumber: Int? = Int(&quot;42&quot;)</span></span><br><span class="line"><span class="comment">///     let nonOverflowingSquare = possibleNumber.flatMap &#123; x -&gt; Int? in</span></span><br><span class="line"><span class="comment">///         let (result, overflowed) = x.multipliedReportingOverflow(by: x)</span></span><br><span class="line"><span class="comment">///         return overflowed ? nil : result</span></span><br><span class="line"><span class="comment">///     &#125;</span></span><br><span class="line"><span class="comment">///     print(nonOverflowingSquare)</span></span><br><span class="line"><span class="comment">///     // Prints &quot;Optional(1764)&quot;</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - Parameter transform: A closure that takes the unwrapped value</span></span><br><span class="line"><span class="comment">///   of the instance.  </span></span><br><span class="line"><span class="comment">/// - Returns: The result of the given closure. If this instance is `nil`,</span></span><br><span class="line"><span class="comment">///   returns `nil`.</span></span><br><span class="line"><span class="keyword">@inlinable</span> <span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">flatMap</span>&lt;<span class="type">U</span>&gt;(<span class="keyword">_</span> <span class="params">transform</span>: (<span class="type">Wrapped</span>) <span class="keyword">throws</span> -&gt; <span class="type">U</span>?) <span class="keyword">rethrows</span> -&gt; <span class="type">U</span>?</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢ä¸¤ä¸ªåŒºåˆ«ä»…æ˜¯é—­åŒ…å‚æ•°çš„è¿”å›å€¼ä¸åŒã€‚ä¸ä»”ç»†çœ‹è¿˜çœŸå‘ç°ä¸äº†ã€‚å¦‚æœtransformçš„ç»“æœå¯èƒ½ä¸ºnilåˆ™éœ€è¦ä½¿ç”¨flatMapã€‚å¦‚æœä¸å¯èƒ½ä¸ºnilåˆ™å¯ä»¥ä½¿ç”¨mapã€‚</p>
]]></content>
      <categories>
        <category>Swift</category>
      </categories>
      <tags>
        <tag>map flapMap</tag>
      </tags>
  </entry>
  <entry>
    <title>Allocation Typeä»‹ç»</title>
    <url>/2018/04/04/Allocation%20Type%E4%BB%8B%E7%BB%8D/</url>
    <content><![CDATA[<h3 id="Allocation-Typeä»‹ç»"><a href="#Allocation-Typeä»‹ç»" class="headerlink" title="Allocation Typeä»‹ç»"></a>Allocation Typeä»‹ç»</h3><h4 id="å®˜æ–¹æ–‡æ¡£"><a href="#å®˜æ–¹æ–‡æ¡£" class="headerlink" title="å®˜æ–¹æ–‡æ¡£"></a>å®˜æ–¹æ–‡æ¡£</h4><p>The following allocation type display settings filter the allocations in the detail pane based on their type.</p>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th>Setting</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>All Heap &amp; Anonymous VM</td>
<td>Shows all malloc heap allocations and interesting VM regions such as graphics- and Core Data-related. Hides mapped files, dylibs, and some large reserved VM regions.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>All Heap Allocations</td>
<td>Shows all malloc heap allocations but no VM regions.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>All VM Regions</td>
<td>Shows all VM regions, including mapped files, dylibs, and the VM regions that include the malloc heap.</td>
<td></td>
</tr>
</tbody>
</table>
</div>
<p>å‚è€ƒ:<a href="https://developer.apple.com/library/content/documentation/DeveloperTools/Conceptual/InstrumentsUserGuide/Instrument-Allocations.html">Allocations Instrument</a></p>
<h4 id="è®ºå›ä¸Šçš„è§£é‡Š"><a href="#è®ºå›ä¸Šçš„è§£é‡Š" class="headerlink" title="è®ºå›ä¸Šçš„è§£é‡Š"></a>è®ºå›ä¸Šçš„è§£é‡Š</h4><h4 id="1"><a href="#1" class="headerlink" title="1"></a>1</h4><p>All heap allocations consist of the memory allocations your application makes. This is the allocation type you should focus on in Instruments.</p>
<p>All VM regions consist of the virtual memory the operating system reserves for your application. You cannot control the size of the virtual memory the operating system reserves.</p>
<p>All heap and anonymous vm is the sum of the All Heap Allocations and All VM Regions columns.</p>
<h4 id="2"><a href="#2" class="headerlink" title="2"></a>2</h4><p>While heap allocations are very important (thatâ€™s where all your Swift and Objective-C objects are created), you canâ€™t ignore the importance of VM memory for most apps. I recommend investigating that category because it can grow rather large, and the memory being allocated there â€œby the operating systemâ€ is going to be in response to some task youâ€™ve asked your application to perform.</p>
<p>For instance, when you allocate a large CGImage, a tiny object is allocated on the heap, but the many megabytes of image data is allocated in a separate VM region. In an image-heavy application, your heap may be relatively small but your VM regions may be rather large. In that case, youâ€™d need to take a closer look at the size and number of images your application has loaded at any given moment.</p>
<p>So in general, you need to ensure you are optimizing <strong>all</strong> of your memory usage.</p>
<p>å‚è€ƒ:<a href="https://forums.developer.apple.com/thread/21463">[Instruments] Allocation Types</a></p>
<h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p>All Heap Allocations:åº”ç”¨åœ¨å †ä¸Šç”³è¯·çš„å†…å­˜ç©ºé—´,æ¯”å¦‚ä½ è‡ªå·±çš„ç±»allocå‡ºæ¥çš„å¯¹è±¡.</p>
<p>All VM Regions:æ“ä½œç³»ç»Ÿä¸ºä½ çš„APPé¢„ç•™å‡ºæ¥çš„è™šæ‹Ÿå†…å­˜.æ¯”å¦‚APPåŠ è½½èµ„æºæ–‡ä»¶åˆ°å†…å­˜æ—¶,å ç”¨çš„å°±æ˜¯è¿™äº›è™šæ‹Ÿå†…å­˜.å› æ­¤å¦‚æœä½ çš„APPå›¾ç‰‡æ¯”è¾ƒå¤šæ—¶,è¿™éƒ¨åˆ†å†…å­˜å ç”¨ä¼šå¾ˆå¤§.</p>
<h4 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h4><p>åœ¨ä¸€ä¸ªé¡µé¢ä¸ŠåŠ è½½ä¸€å¼ 140kbçš„å›¾ç‰‡.ä½¿ç”¨InstrumentsæŸ¥çœ‹å®é™…æ¶ˆè€—çš„å†…å­˜:<br><img src="http://7xqoji.com1.z0.glb.clouddn.com/%E5%8A%A0%E8%BD%BD%E5%9B%BE%E7%89%87%E5%8D%A0%E7%94%A8%E7%9A%84%E5%86%85%E5%AD%98@2x.png" alt="åŠ è½½å›¾ç‰‡å ç”¨çš„å†…å­˜"><br>ä¸çŸ¥é“ä¸ºå•¥åŠ è½½åˆ°å†…å­˜åä¼šæ¯”ç£ç›˜ä¸Šè¦å¤§36kb.</p>
<p>åŠ è½½äº†ä¸€å¼ 52kbçš„å›¾ç‰‡,Instrumentsæ˜¾ç¤ºæ¶ˆè€—64kb.æ„Ÿè§‰è¦æ¯”åŸå›¾å¤šå ç”¨25%.</p>
<h4 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h4><h5 id="Macæ–‡ä»¶å­˜å‚¨å•ä½"><a href="#Macæ–‡ä»¶å­˜å‚¨å•ä½" class="headerlink" title="Macæ–‡ä»¶å­˜å‚¨å•ä½"></a>Macæ–‡ä»¶å­˜å‚¨å•ä½</h5><p>Appleè®¤ä¸º1GB=1 000 000 000å­—èŠ‚ï¼ŒMicrosoftè®¤ä¸º1GB=1 073 741 824å­—èŠ‚ï¼Œç½‘ç»œä¸Šå¤šç”¨Microsoftçš„æ ‡å‡†ã€‚<br>å¯¹äºç”µè„‘è€Œè¨€ï¼Œ1 073 741 824æ˜¯2çš„30æ¬¡æ–¹ï¼Œæ¯”1 000 000 000æ›´æ–¹ä¾¿å¤„ç†ï¼Œä½†ç¡¬ä»¶å‚å•†ç”Ÿäº§ç¡¬ç›˜ç­‰è®¾å¤‡çš„æ—¶å€™æ˜¯æŒ‰åè€…æ¥æ ‡æ³¨å®¹é‡çš„ã€‚Appleå¸Œæœ›ç”¨æˆ·ä¹°ä¸€å—1TBçš„ç¡¬ç›˜æ’åˆ°ç”µè„‘ä¸Šçœ‹åˆ°çš„å°±æ˜¯1TBè€Œä¸æ˜¯931GBï¼Œè¿™ä¼šå¸¦æ¥æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œäºæ˜¯Appleåœ¨æ˜¾ç¤ºå®¹é‡æ—¶éµå¾ªäº†åè€…çš„æ ‡å‡†ã€‚</p>
<p><img src="http://7xqoji.com1.z0.glb.clouddn.com/Mac%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E5%8D%95%E4%BD%8D@2x.png" width="264" height="451" /></p>
]]></content>
      <categories>
        <category>Instruments</category>
      </categories>
      <tags>
        <tag>Allocations</tag>
      </tags>
  </entry>
  <entry>
    <title>æ ¼å¼åŒ–è¾“å‡ºå¯¼è‡´çš„ç–‘ä¼¼bug</title>
    <url>/2018/04/04/%E6%A0%BC%E5%BC%8F%E5%8C%96%E8%BE%93%E5%87%BA%E5%AF%BC%E8%87%B4%E7%9A%84%E7%96%91%E4%BC%BCbug/</url>
    <content><![CDATA[ <figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *str = <span class="string">@&quot;123456a&quot;</span>;</span><br><span class="line"><span class="built_in">NSData</span> *dataStr = [str dataUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;%s %s&quot;</span>, [str UTF8String], dataStr.bytes);</span><br></pre></td></tr></table></figure>
<p>iOS9.0æ¨¡æ‹Ÿå™¨.<br>è¾“å‡º:123456a 123456aâ€“ËÃ£Ë˜<br>dataStr.bytesçš„äºŒè¿›åˆ¶å†…å®¹:31 32 33 34 35 36 61 D0 1D 13 FD 8B F9 07 00 10<br>å‡ºç°ä¸Šè¿°æƒ…å†µçš„åŸå› :<br>éœ€è¦äº†è§£%sæ˜¯å¦‚ä½•æ‰“å°cå­—ç¬¦ä¸²çš„.<br>%sæ‰“å°çš„æ—¶å€™é‡åˆ°\0å°±åœæ­¢ï¼Œ[str UTF8String]è½¬æ¢çš„æ—¶å€™ï¼Œè‡ªåŠ¨åœ¨å­—ç¬¦æ•°ç»„çš„æœ€åé¢åŠ ä¸Šäº†\0(A null-terminated UTF8 representation of the string.)ï¼Œä½†æ˜¯data.bytesåé¢â€™ä¸ä¸€å®šâ€™æ˜¯\0ï¼Œæ‰€ä»¥æ‰“å°data.bytesçš„æ—¶å€™ä¼šæœ‰é¢å¤–çš„å†…å®¹.</p>
]]></content>
      <categories>
        <category>Bug</category>
      </categories>
      <tags>
        <tag>æ ¼å¼åŒ–æ‰“å°æŒ‡ä»¤</tag>
      </tags>
  </entry>
  <entry>
    <title>CocoaPodså‘½ä»¤ä»‹ç»</title>
    <url>/2018/03/22/CocoaPods%E5%91%BD%E4%BB%A4%E4%BB%8B%E7%BB%8D/</url>
    <content><![CDATA[<h3 id="pod-installå’Œpod-update"><a href="#pod-installå’Œpod-update" class="headerlink" title="pod installå’Œpod update"></a>pod installå’Œpod update</h3><h4 id="pod-install"><a href="#pod-install" class="headerlink" title="pod install"></a>pod install</h4><p>æ¯æ¬¡è¿è¡Œpod installå‘½ä»¤ï¼Œå¹¶ä¸”æœ‰ä¸‹è½½å®‰è£…æ–°çš„åº“æ—¶ï¼ŒCocoaPodsä¼šæŠŠè¿™äº›å®‰è£…çš„åº“çš„ç‰ˆæœ¬éƒ½å†™åœ¨Podfile.lockæ–‡ä»¶é‡Œé¢ã€‚è¿™ä¸ªæ–‡ä»¶è®°å½•ä½ æ¯ä¸ªå®‰è£…åº“çš„ç‰ˆæœ¬å·ï¼Œå¹¶ä¸”é”å®šäº†è¿™äº›ç‰ˆæœ¬ã€‚</p>
<p>åé¢å†æ¬¡è¿è¡Œçš„æ—¶å€™,å®ƒä¼šè§£æPodfile.lockæ–‡ä»¶,å¯¹äºå­˜åœ¨åœ¨Podfile.lockæ–‡ä»¶ä¸­çš„åˆ™å®‰è£…Podfile.lockæ–‡ä»¶ä¸­çš„ç‰ˆæœ¬çš„åº“è€Œä¸ä¼šå»æ£€æµ‹è¯¥åº“æ˜¯å¦æœ‰æœ€æ–°çš„ç‰ˆæœ¬å¯ç”¨,å¯¹äºä¸åœ¨Podfile.lockæ–‡ä»¶ä¸­çš„,åˆ™æ ¹æ®Podfileæ–‡ä»¶æŒ‡å®šçš„åº“ç‰ˆæœ¬ä¸‹è½½å®‰è£….</p>
<p>pod installä¸ä¼šå»æ›´æ–°å·²å­˜åœ¨çš„åº“çš„ç‰ˆæœ¬.</p>
<p>ä¸¾ä¸ªæ —å­ï¼š</p>
<p>IGListKit æœ‰v3.1.0ï¼Œå’Œv3.1.1ä¸¤ä¸ªç‰ˆæœ¬</p>
<p>Podfileå¦‚ä¸‹ï¼š <code>pod &#39;IGListKit&#39;, &#39;~&gt; 3.1.0&#39;</code></p>
<p>åœºæ™¯1ï¼šç¬¬ä¸€æ¬¡å®‰è£…ï¼Œæ— Podfile.lockã€‚</p>
<p>æ­¤æ—¶æ‰§è¡Œpod installï¼Œä½ ä¼šå‘ç°ä¸‹è½½å¹¶å®‰è£…çš„æ˜¯3.1.1ç‰ˆæœ¬ã€‚å› ä¸ºPodfileä¸­ä½¿ç”¨çš„æ˜¯ <code>~&gt;</code> ï¼Œè¡¨æ˜å¯ä»¥ä½¿ç”¨è¾ƒæ–°çš„ä¸€ä¸ªå°ç‰ˆæœ¬ã€‚</p>
<p>åœºæ™¯2ï¼šå†æ¬¡å®‰è£…ï¼Œæœ‰Podfile.lockï¼Œä¸”Podfile.lockä¸­çš„ç‰ˆæœ¬ä¸º3.1.0ã€‚</p>
<p>æ­¤æ—¶æ‰§è¡Œpod installï¼Œä½ ä¼šå‘ç°ä¸‹è½½å¹¶å®‰è£…çš„æ˜¯3.1.0ç‰ˆæœ¬ã€‚ä¹Ÿå°±æ˜¯è¯´è¿™ç§æƒ…å†µå› ä¸ºèƒ½å¤Ÿåœ¨Podfile.lockä¸­æ‰¾åˆ°åº“çš„ç‰ˆæœ¬ï¼Œæ‰€ä»¥pod installå°±ç›´æ¥å®‰è£…æŒ‡å®šçš„ç‰ˆæœ¬äº†ã€‚è¿™ä¸ªæ—¶å€™å¦‚æœä½¿ç”¨çš„æ˜¯pod updateï¼Œåˆ™ä¼šå®‰è£…3.1.1çš„ç‰ˆæœ¬ã€‚</p>
<h4 id="pod-update"><a href="#pod-update" class="headerlink" title="pod update"></a>pod update</h4><p>å½“ä½ è¿è¡Œ pod update PODNAME å‘½ä»¤æ—¶ï¼ŒCocoaPodsä¼šå¸®ä½ æ›´æ–°åˆ°è¿™ä¸ªåº“çš„æ–°ç‰ˆæœ¬ï¼Œæ­¤æ—¶CocoaPods ä¼šå¿½ç•¥Podfile.locké‡Œé¢çš„é™åˆ¶ï¼Œå®ƒä¼šæ›´æ–°åˆ°è¿™ä¸ªåº“å°½å¯èƒ½çš„æ–°ç‰ˆæœ¬ï¼Œ<strong>åªè¦ç¬¦åˆPodfileé‡Œé¢çš„ç‰ˆæœ¬é™åˆ¶</strong>ã€‚</p>
<p>å¦‚æœä½ è¿è¡Œpod updateï¼Œåé¢æ²¡æœ‰è·Ÿåº“çš„åå­—ï¼ŒCocoaPodså°±ä¼šæ›´æ–°æ¯ä¸€ä¸ªPodfileé‡Œé¢çš„åº“åˆ°å°½å¯èƒ½çš„æœ€æ–°ç‰ˆæœ¬ã€‚</p>
<p>pod updateé»˜è®¤æ˜¯æ›´æ–°repoçš„ï¼Œè€Œpod installæ˜¯ä¸æ›´æ–°çš„ã€‚æ‰€ä»¥æˆ‘ä»¬æœ‰æ—¶å€™pod updateæ—¶ä¼šç‰¹åˆ«æ…¢.</p>
<p>ä¸¾ä¾‹:<br>å½“ä½ åœ¨Podfileæ–‡ä»¶ä¸­æ–°å¢ä¸€ä¸ªåº“æ—¶,ä½ åº”è¯¥ä½¿ç”¨pod installè€Œä¸æ˜¯pod update.(å› ä¸ºpod updateä¼šæ›´æ–°å·²å­˜åœ¨çš„åº“è€Œæˆ‘ä»¬çš„ç›®çš„åªæ˜¯æƒ³å®‰è£…ä¸€ä¸ªåº“æ‰€ä»¥åº”è¯¥ä½¿ç”¨pod install)</p>
<p>ä½ åªæœ‰åœ¨æƒ³æ›´æ–°æŸä¸ªåº“çš„æ—¶å€™æ‰ä½¿ç”¨pod update.</p>
<h3 id="pod-setup"><a href="#pod-setup" class="headerlink" title="pod setup"></a>pod setup</h3><p>æ‰€æœ‰çš„é¡¹ç›®çš„Podspecæ–‡ä»¶éƒ½æ‰˜ç®¡åœ¨<code>https://github.com/CocoaPods/Specs</code>ã€‚ç¬¬ä¸€æ¬¡æ‰§è¡Œpod setupæ—¶ï¼ŒCocoaPodsä¼šå°†è¿™äº›podspecæ–‡ä»¶cloneåˆ°æœ¬åœ°çš„ <code>~/.cocoapods/repos</code>ç›®å½•ä¸‹ï¼Œè¿™ä¸ªæ–‡ä»¶æ¯”è¾ƒå¤§ã€‚æ‰€ä»¥ç¬¬ä¸€æ¬¡æ›´æ–°æ—¶éå¸¸æ…¢ï¼Œé€šå¸¸éœ€è¦ä½¿ç”¨å›½å†…çš„é•œåƒæœåŠ¡å™¨æˆ–ç¿»å¢™ã€‚å¦‚æœcloneå·²å­˜åœ¨,åˆ™ä¼šæ›´æ–°reposæ–‡ä»¶.</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">xuequandeMacBook-Pro:~ xuequan$ pod setup</span><br><span class="line">Setting up CocoaPods <span class="keyword">master</span> <span class="title">repo</span></span><br><span class="line">  $ /usr/bin/git -C /Users/xuequan/.cocoapods/repos/<span class="keyword">master</span> <span class="title">fetch</span> origin</span><br><span class="line">  --progress</span><br><span class="line">  remote: Counting objects: <span class="number">38172</span>, done.        </span><br><span class="line">  remote: Compressing objects: <span class="number">100</span>% (<span class="number">117</span>/<span class="number">117</span>), done.        </span><br><span class="line">  remote: Total <span class="number">38172</span> (delta <span class="number">13706</span>), reused <span class="number">13672</span> (delta <span class="number">13672</span>), pack-reused <span class="number">24374</span>        </span><br><span class="line">  Receiving objects: <span class="number">100</span>% (<span class="number">38172</span>/<span class="number">38172</span>), <span class="number">4.09</span> MiB | <span class="number">560.00</span> KiB/s, done.</span><br><span class="line">  Resolving deltas: <span class="number">100</span>% (<span class="number">26181</span>/<span class="number">26181</span>), completed with <span class="number">3595</span> local objects.</span><br><span class="line">  From https://github.com/CocoaPods/Specs</span><br><span class="line">     cc16dc96ff1..f42ce3f56e0  <span class="keyword">master</span>     <span class="title">-&gt; origin</span>/<span class="keyword">master</span></span><br><span class="line">  <span class="title">$</span> /usr/bin/git -C /Users/xuequan/.cocoapods/repos/<span class="keyword">master</span> <span class="title">rev-parse</span></span><br><span class="line">  --abbrev-<span class="keyword">ref</span> HEAD</span><br><span class="line">  <span class="keyword">master</span></span><br><span class="line">  <span class="title">$</span> /usr/bin/git -C /Users/xuequan/.cocoapods/repos/<span class="keyword">master</span> <span class="title">reset</span> --hard</span><br><span class="line">  origin/<span class="keyword">master</span></span><br><span class="line">  <span class="title">HEAD</span> is now at f42ce3f56e0 [Add] HLDevice <span class="number">1.0</span>.<span class="number">0</span></span><br><span class="line">warning: inexact rename detection was skipped due to too many files.</span><br><span class="line">warning: you may want to set your diff.renameLimit variable to at least <span class="number">3856</span> <span class="keyword">and</span> retry the command.</span><br><span class="line"></span><br><span class="line">CocoaPods <span class="number">1.4</span>.<span class="number">0</span> is available.</span><br><span class="line">To update use: `sudo gem install cocoapods`</span><br><span class="line"></span><br><span class="line">For more <span class="literal">inf</span>ormation, see https://blog.cocoapods.org <span class="keyword">and</span> the CHANGELOG for this <span class="keyword">version</span> at https://github.com/CocoaPods/CocoaPods/releases/<span class="keyword">tag</span>/<span class="number">1.4</span>.<span class="number">0</span></span><br><span class="line"></span><br><span class="line">Setup completed</span><br></pre></td></tr></table></figure>
<h3 id="pod-search"><a href="#pod-search" class="headerlink" title="pod search"></a>pod search</h3><p>æ‰§è¡Œè¯¥å‘½ä»¤å,CocoaPodsä¼šåœ¨<code>~/Library/Caches/CocoaPods</code>ç›®å½•ä¸‹åˆ›å»º<code>search_index.json</code>æ–‡ä»¶(ç›®å‰16.6M).å½“ä½ <code>pod search</code>ä¸€ä¸ªå†…å®¹æ—¶ï¼Œå°±åœ¨è¿™ä¸ªæœ¬åœ°ç›®å½•ä¸‹è¿›è¡Œæœç´¢ã€‚æ‰€ä»¥ä¸€äº›è¾ƒæ–°çš„podåº“å¯èƒ½ä¼šæœç´¢ä¸åˆ°.æ¯”å¦‚ç›®å‰åˆšå‡ºçš„<code>LKImageKit</code>.<br>è§£å†³åŠæ³•:<br>åˆ é™¤<code>~/Library/Caches/CocoaPods</code>ç›®å½•ä¸‹çš„<code>search_index.json</code>æ–‡ä»¶.<br>å†æ¬¡æ‰§è¡Œ<code>pod search &#39;xxx&#39;</code>, CocoaPodsä¼šé‡æ–°åˆ›å»ºè¯¥æ–‡ä»¶.</p>
<figure class="highlight gams"><table><tr><td class="code"><pre><span class="line">xuequandeMacBook-Pro:~ xuequan<span class="symbol">$</span> pod search LKImageKit</span><br><span class="line"><span class="function"><span class="title">Creating</span></span> search index <span class="keyword">for</span> spec repo <span class="string">&#x27;artsy&#x27;</span>.. Done!</span><br><span class="line"><span class="function"><span class="title">Creating</span></span> search index <span class="keyword">for</span> spec repo <span class="string">&#x27;brion&#x27;</span>.. Done!</span><br><span class="line"><span class="function"><span class="title">Creating</span></span> search index <span class="keyword">for</span> spec repo <span class="string">&#x27;master&#x27;</span>.. Done!</span><br></pre></td></tr></table></figure>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">-&gt; LKImageKit (<span class="number">5.3</span>.<span class="number">1</span>)</span><br><span class="line">   LKImageKit</span><br><span class="line">   pod <span class="string">&#x27;LKImageKit&#x27;</span>, <span class="string">&#x27;~&gt; 5.3.1&#x27;</span></span><br><span class="line">   - Homepage: https:<span class="regexp">//gi</span>thub.com<span class="regexp">/Tencent/</span>LKImageKit</span><br><span class="line">   - Source:   https:<span class="regexp">//gi</span>thub.com<span class="regexp">/Tencent/</span>LKImageKit.git</span><br><span class="line">   - Versions: <span class="number">5.3</span>.<span class="number">1</span> [master repo]</span><br><span class="line">(<span class="keyword">END</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Podfile-lockæ–‡ä»¶"><a href="#Podfile-lockæ–‡ä»¶" class="headerlink" title="Podfile.lockæ–‡ä»¶"></a>Podfile.lockæ–‡ä»¶</h3><p>è¯¥æ–‡ä»¶åœ¨ç¬¬ä¸€æ¬¡è¿è¡Œpod installåç”Ÿæˆ,ç”¨äºè·Ÿè¸ªæ¯ä¸€ä¸ªå®‰è£…çš„Podåº“çš„ç‰ˆæœ¬.å½“ä¿®æ”¹äº†Podfileæ–‡ä»¶ä¸­æŸä¸ªåº“çš„ç‰ˆæœ¬æˆ–pod updateè¢«æ‰§è¡Œ,å°†ç”Ÿæˆæ–°çš„Podfile.lockæ–‡ä»¶.</p>
<p>Q:å¦‚ä½•ä¿è¯é¡¹ç›®ä¸­çš„æˆå‘˜ä½¿ç”¨çš„podåº“ç‰ˆæœ¬ä¸€è‡´?<br>A:æäº¤Podfile.lockæ–‡ä»¶.As a reminder, even if your policy is not to commit the Pods folder into your shared repository, you should always commit &amp; push your Podfile.lock file.</p>
<p>æ€»ç»“ä¸‹å°±æ˜¯:</p>
<ul>
<li>å¿½ç•¥Podsæ–‡ä»¶å¤¹</li>
<li>å°½é‡åœ¨Podfileæ–‡ä»¶ä¸­æŒ‡æ˜åº“çš„ç‰ˆæœ¬</li>
<li>æäº¤Podfile.lockæ–‡ä»¶</li>
</ul>
<p>æ³¨æ„:ä»…åœ¨Podfileä¸­å†™æ­»åº“çš„ç‰ˆæœ¬å¹¶ä¸èƒ½ä¿è¯å›¢é˜Ÿå„æˆå‘˜ä½¿ç”¨çš„åº“çš„ç‰ˆæœ¬ä¸€è‡´.è¿™æ˜¯å› ä¸ºç¬¬ä¸‰æ–¹åº“è‡ªå·±æœ‰å¯èƒ½ä¹Ÿä¾èµ–æŸä¸ªåº“.å› æ­¤æäº¤Podfile.lockæ–‡ä»¶æ‰æ˜¯æ­£è§£.</p>
<h3 id="Manifest-lock"><a href="#Manifest-lock" class="headerlink" title="Manifest.lock"></a>Manifest.lock</h3><p>Manifest.lock æ˜¯ Podfile.lock çš„å‰¯æœ¬ï¼Œæ¯æ¬¡åªè¦ç”Ÿæˆ Podfile.lock æ—¶å°±ä¼šç”Ÿæˆä¸€ä¸ªä¸€æ ·çš„ Manifest.lock å­˜å‚¨åœ¨ Pods æ–‡ä»¶å¤¹ä¸‹ã€‚åœ¨æ¯æ¬¡é¡¹ç›® Build çš„æ—¶å€™ï¼Œä¼šè·‘ä¸€ä¸‹è„šæœ¬æ£€æŸ¥ä¸€ä¸‹ Podfile.lock å’Œ Manifest.lock æ˜¯å¦ä¸€è‡´ï¼š</p>
<p>Build phases -&gt; [CP] Check Pods Manifest.lock</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">diff <span class="string">&quot;$&#123;PODS_PODFILE_DIR_PATH&#125;/Podfile.lock&quot;</span> <span class="string">&quot;$&#123;PODS_ROOT&#125;/Manifest.lock&quot;</span> &gt; <span class="regexp">/dev/</span>null</span><br><span class="line"><span class="keyword">if</span> [ $? != <span class="number">0</span> ] ; then</span><br><span class="line">    <span class="comment"># print error to STDERR</span></span><br><span class="line">    echo <span class="string">&quot;error: The sandbox is not in sync with the Podfile.lock. Run &#x27;pod install&#x27; or update your CocoaPods installation.&quot;</span> &gt;&amp;<span class="number">2</span></span><br><span class="line">    <span class="keyword">exit</span> <span class="number">1</span></span><br><span class="line">fi</span><br><span class="line"><span class="comment"># This output is used by Xcode &#x27;outputs&#x27; to avoid re-running this script phase.</span></span><br><span class="line">echo <span class="string">&quot;SUCCESS&quot;</span> &gt; <span class="string">&quot;$&#123;SCRIPT_OUTPUT_FILE_0&#125;&quot;</span></span><br></pre></td></tr></table></figure>
<p>å› æ­¤å¦‚æœä½ æœ‰æäº¤Podsæ–‡ä»¶å¤¹,é‚£ä¹ˆManifest.lockä¹Ÿæœ‰å¯èƒ½å†²çª.è§£å†³å†²çªçš„æ—¶å€™ä¸è¦å¿˜è®°å®ƒ,å¹¶ä¸”ç¡®ä¿Manifest.lockå’ŒPodfile.lockä¸€è‡´.</p>
<h3 id="podåº“ç‰ˆæœ¬å·é™å®š"><a href="#podåº“ç‰ˆæœ¬å·é™å®š" class="headerlink" title="podåº“ç‰ˆæœ¬å·é™å®š"></a>podåº“ç‰ˆæœ¬å·é™å®š</h3><p>eg:<br><code>pod &#39;AFNetworking&#39;, &#39;~&gt; 1.0&#39;</code> ç‰ˆæœ¬å·å¯ä»¥æ˜¯1.0ï¼Œå¯ä»¥æ˜¯1.1 â€¦ 1.9ï¼Œä½†å¿…é¡»å°äº2.</p>
<p>è¯¦ç»†ä»‹ç»å¦‚ä¸‹:</p>
<ul>
<li><code>= 0.1 Version 0.1.</code></li>
<li><code>&gt; 0.1 Any version higher than 0.1.</code></li>
<li><code>&gt;= 0.1 Version 0.1 and any higher version.</code></li>
<li><code>&lt; 0.1 Any version lower than 0.1.</code></li>
<li><code>&lt;= 0.1 Version 0.1 and any lower version.</code></li>
<li><code>~&gt; 0.1.2 Version 0.1.2 and the versions up to 0.2, not including 0.2. This operator works based on the last component that you specify in your version requirement. The example is equal to &gt;= 0.1.2 combined with &lt; 0.2.0 and will always match the latest known version matching your requirements.</code></li>
</ul>
<p><code>pod &#39;AFNetworking&#39;,</code>  // ä¸æŒ‡å®šç‰ˆæœ¬å·ï¼Œä»»ä½•ç‰ˆæœ¬éƒ½å¯ä»¥</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://guides.cocoapods.org/using/pod-install-vs-update.html">pod install vs. pod update</a></p>
<p><a href="https://guides.cocoapods.org/syntax/podfile.html#pod">podfileæ–‡ä»¶è¯­æ³•è§„åˆ™</a></p>
<p><a href="https://objccn.io/issue-6-4/">æ·±å…¥ç†è§£ CocoaPods</a>    </p>
]]></content>
      <categories>
        <category>CocoaPods</category>
      </categories>
  </entry>
  <entry>
    <title>ç§æœ‰Podåˆ¶ä½œ</title>
    <url>/2018/03/22/%E7%A7%81%E6%9C%89pod%E5%88%B6%E4%BD%9C/</url>
    <content><![CDATA[<h3 id="ä½¿ç”¨æœ¬åœ°pod"><a href="#ä½¿ç”¨æœ¬åœ°pod" class="headerlink" title="ä½¿ç”¨æœ¬åœ°pod"></a>ä½¿ç”¨æœ¬åœ°pod</h3><p>åˆ›å»ºPodspecæ–‡ä»¶:<code>pod spec create XQPerson</code></p>
<p>ä¿®æ”¹XQPerson.podspecæ–‡ä»¶:</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line">Pod::Spec.<span class="keyword">new</span> <span class="keyword">do</span> |s|</span><br><span class="line">    s.name         = <span class="string">&quot;XQPerson&quot;</span></span><br><span class="line">    s.version      = <span class="string">&quot;0.0.1&quot;</span></span><br><span class="line">    s.summary      = <span class="string">&quot;Use XQPerson to print hello.&quot;</span></span><br><span class="line">    s.description  = &lt;&lt;-DESC</span><br><span class="line">                        A pod used to print hello. <span class="keyword">this</span> is just a simply pod.</span><br><span class="line">                     DESC</span><br><span class="line">    s.homepage     = <span class="string">&quot;https://github.com/tonymillion/Reachability&quot;</span></span><br><span class="line">    s.license      = <span class="string">&quot;MIT&quot;</span></span><br><span class="line">    s.author       = &#123; <span class="string">&quot;xq_120&quot;</span> =&gt; <span class="string">&quot;xq_120455@yahoo.com&quot;</span> &#125;</span><br><span class="line">    s.platform     = :ios, <span class="string">&quot;7.0&quot;</span></span><br><span class="line">    s.source       = &#123; :git =&gt; <span class="string">&quot;/Users/xuequan/Desktop/XQPerson/&quot;</span>, :tag =&gt; <span class="string">&quot;#&#123;s.version&#125;&quot;</span> &#125;</span><br><span class="line">    s.source_files = <span class="string">&quot;XQPerson/*.&#123;h,m&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">    s.framework  = <span class="string">&quot;Foundation&quot;</span></span><br><span class="line"><span class="meta"># s.frameworks = <span class="string">&quot;SomeFramework&quot;</span>, <span class="string">&quot;AnotherFramework&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># s.library   = <span class="string">&quot;iconv&quot;</span></span></span><br><span class="line"><span class="meta"># s.libraries = <span class="string">&quot;iconv&quot;</span>, <span class="string">&quot;xml2&quot;</span></span></span><br><span class="line"></span><br><span class="line">    s.requires_arc = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># s.dependency <span class="string">&quot;JSONKit&quot;</span>, <span class="string">&quot;~&gt; 1.4&quot;</span></span></span><br><span class="line"></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>éªŒè¯Specæ–‡ä»¶:<code>pod lib lint</code>:</p>
<figure class="highlight clean"><table><tr><td class="code"><pre><span class="line"> -&gt; XQPerson (<span class="number">0.0</span><span class="number">.1</span>)</span><br><span class="line"></span><br><span class="line">XQPerson passed validation.</span><br></pre></td></tr></table></figure>
<p>å‡†å¤‡å¥½ä½ çš„podæ–‡ä»¶:</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">xuequandeMacBook-Pro:XQPerson xuequan$ tree /Users/xuequan/Desktop/XQPerson -L <span class="number">2</span></span><br><span class="line">/Users/xuequan/Desktop/XQPerson</span><br><span class="line">â”œâ”€â”€ LICENSE</span><br><span class="line">â”œâ”€â”€ XQPerson</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ XQPerson<span class="selector-class">.h</span></span><br><span class="line">â”‚Â Â  â””â”€â”€ XQPerson<span class="selector-class">.m</span></span><br><span class="line">â”œâ”€â”€ XQPerson<span class="selector-class">.podspec</span></span><br><span class="line">â””â”€â”€ XQPersonDemo</span><br><span class="line">    â”œâ”€â”€ Podfile</span><br><span class="line">    â”œâ”€â”€ Podfile<span class="selector-class">.lock</span></span><br><span class="line">    â”œâ”€â”€ Pods</span><br><span class="line">    â”œâ”€â”€ XQPersonDemo</span><br><span class="line">    â”œâ”€â”€ XQPersonDemo<span class="selector-class">.xcodeproj</span></span><br><span class="line">    â”œâ”€â”€ XQPersonDemo<span class="selector-class">.xcworkspace</span></span><br><span class="line">    â”œâ”€â”€ XQPersonDemoTests</span><br><span class="line">    â””â”€â”€ XQPersonDemoUITests</span><br></pre></td></tr></table></figure>
<p>æ‰“å¥½tag.</p>
<p>ä½¿ç”¨æœ¬åœ°podsæ—¶,Podfileæœ‰ä¸¤ç§å†™æ³•:</p>
<ol>
<li>pod â€˜XQPersonâ€™, :podspec =&gt; â€˜~/Desktop/XQPerson/XQPerson.podspecâ€™  # æŒ‡å®šåŒ…å«.podspecæ–‡ä»¶çš„è·¯å¾„</li>
<li>pod â€˜XQPersonâ€™, :path =&gt; â€˜~/Desktop/XQPersonâ€™    # æŒ‡å®špodspecæ–‡ä»¶çš„è·¯å¾„</li>
</ol>
<p>ä¸è¿‡å¦‚æœ<br><code>s.source       = &#123; :git =&gt; &quot;~/Desktop/XQPerson&quot;, :tag =&gt; &quot;#&#123;s.version&#125;&quot; &#125;</code><br>åˆ™æŒ‡å®špodspecæ–‡ä»¶å†™æ³•,pod installæ—¶ä¼šå®‰è£…å¤±è´¥.è€ŒæŒ‡å®šåŒ…å«.podspecæ–‡ä»¶çš„è·¯å¾„å†™æ³•ä¸ä¼š.</p>
<p>æœ€åpod install:</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Analyzing</span> dependencies</span><br><span class="line"><span class="attribute">Downloading</span> dependencies</span><br><span class="line"><span class="attribute">Using</span> XQPerson (<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>)</span><br><span class="line"><span class="attribute">Generating</span> Pods project</span><br><span class="line"><span class="attribute">Integrating</span> client project</span><br><span class="line"><span class="attribute">Sending</span> stats</span><br><span class="line"><span class="attribute">Pod</span> installation complete! There is <span class="number">1</span> dependency from the Podfile and <span class="number">1</span> total pod installed.</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ä½¿ç”¨æœ¬åœ°podå°±å®Œæˆäº†.</p>
<h3 id="æäº¤æœ¬åœ°podè‡³è¿œç¨‹ä»“åº“"><a href="#æäº¤æœ¬åœ°podè‡³è¿œç¨‹ä»“åº“" class="headerlink" title="æäº¤æœ¬åœ°podè‡³è¿œç¨‹ä»“åº“"></a>æäº¤æœ¬åœ°podè‡³è¿œç¨‹ä»“åº“</h3><p>åœ¨GitLabä¸Šåˆ›å»ºä¸€ä¸ªç§æœ‰å·¥ç¨‹XQPerson.</p>
<p>ä¿®æ”¹<code>XQPerson.podspec</code>ä¸­çš„:</p>
<figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">s.homepage     = <span class="string">&quot;https://gitlab.com/xq_120/XQPerson&quot;</span></span><br><span class="line">s.source       = &#123; :<span class="function"><span class="params">git</span> =&gt;</span> <span class="string">&quot;https://gitlab.com/xq_120/XQPerson.git&quot;</span>, :<span class="function"><span class="params">tag</span> =&gt;</span> <span class="string">&quot;#&#123;s.version&#125;&quot;</span> &#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨è¿œç¨‹åœ°å€ä»£æ›¿ä¹‹å‰çš„æœ¬åœ°è·¯å¾„.<br>é‡æ–°éªŒè¯ä¸€ä¸‹<code>XQPerson.podspec</code>æ–‡ä»¶:<code>pod lib lint</code></p>
<figure class="highlight crystal"><table><tr><td class="code"><pre><span class="line">xuequandeMacBook-<span class="symbol">Pro:</span>XQPerson xuequan<span class="variable">$ </span>pod <span class="class"><span class="keyword">lib</span> <span class="title">lint</span></span></span><br><span class="line"></span><br><span class="line"> -&gt; XQPerson (<span class="number">0.0</span>.<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">XQPerson passed validation.</span><br></pre></td></tr></table></figure>
<p>æäº¤æ–‡ä»¶åˆ°è¿œç¨‹ä»“åº“:</p>
<figure class="highlight elixir"><table><tr><td class="code"><pre><span class="line"><span class="variable">$ </span>git add .</span><br><span class="line"><span class="variable">$ </span>git commit -s -m <span class="string">&quot;Initial Commit of Library&quot;</span></span><br><span class="line"><span class="variable">$ </span>git remote add origin git<span class="variable">@gitlab</span>.<span class="symbol">com:</span>xq_120/<span class="title class_">XQPerson</span>.git  <span class="comment">#æ·»åŠ è¿œç«¯ä»“åº“</span></span><br><span class="line"><span class="variable">$ </span>git push origin master     <span class="comment">#æäº¤åˆ°è¿œç«¯ä»“åº“</span></span><br></pre></td></tr></table></figure>
<p>æ‰“å¥½tag:</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">$ git <span class="keyword">tag</span> <span class="title">-m</span> <span class="string">&quot;first release&quot;</span> <span class="number">0.0</span>.<span class="number">1</span></span><br><span class="line">$ git push --tags</span><br></pre></td></tr></table></figure>
<h3 id="åˆ›å»ºç§æœ‰Spec-Repo"><a href="#åˆ›å»ºç§æœ‰Spec-Repo" class="headerlink" title="åˆ›å»ºç§æœ‰Spec Repo"></a>åˆ›å»ºç§æœ‰Spec Repo</h3><p>åœ¨GitLabä¸Šåˆ›å»ºä¸€ä¸ªgitè¿œç¨‹ä»“åº“ç”¨äºå­˜å‚¨è‡ªå·±çš„ç§æœ‰podspecæ–‡ä»¶.å…¶å®è¿™å°±æœ‰ç‚¹ç±»ä¼¼CocoaPodsçš„å®˜æ–¹Spec repo.å®˜æ–¹çš„åœ°å€æ˜¯<code>https://github.com/CocoaPods/Specs.git</code>,åªä¸è¿‡å®˜æ–¹å­˜å‚¨çš„éƒ½æ˜¯å…¬å¼€çš„podçš„podspecæ–‡ä»¶.è€Œæˆ‘ä»¬çš„gitè¿œç¨‹ä»“åº“ç”±äºæ˜¯ç§æœ‰çš„,å› æ­¤å¤–éƒ¨äººå‘˜å°±æ— æ³•è®¿é—®åˆ°.</p>
<p>åˆ›å»ºå®Œæˆä¹‹ååœ¨Terminalä¸­æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤:<br><code>$ pod repo add XQSpecs https://gitlab.com/xq_120/XQSpecs.git</code></p>
<p>æ­¤æ—¶å¦‚æœæˆåŠŸçš„è¯è¿›å…¥åˆ°<code>~/.cocoapods/repos</code>ç›®å½•ä¸‹å°±å¯ä»¥çœ‹åˆ°XQSpecsè¿™ä¸ªç›®å½•äº†ã€‚</p>
<h3 id="å‘Spec-Repoæäº¤podspec"><a href="#å‘Spec-Repoæäº¤podspec" class="headerlink" title="å‘Spec Repoæäº¤podspec"></a>å‘Spec Repoæäº¤podspec</h3><p>å‘æˆ‘ä»¬çš„ç§æœ‰Spec Repoæäº¤podspecåªéœ€è¦ä¸€ä¸ªå‘½ä»¤:<br><code>$ pod repo push XQSpecs XQPerson.podspec</code></p>
<figure class="highlight ocaml"><table><tr><td class="code"><pre><span class="line">xuequandeMacBook-<span class="type">Pro</span>:<span class="type">XQPerson</span> xuequan$ pod repo push <span class="type">XQSpecs</span> <span class="type">XQPerson</span>.podspec</span><br><span class="line"></span><br><span class="line"><span class="type">Validating</span> spec</span><br><span class="line"> -&gt; <span class="type">XQPerson</span> (<span class="number">0.0</span>.<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="type">Updating</span> the <span class="type">`XQSpecs&#x27;</span> repo</span><br><span class="line"></span><br><span class="line"><span class="type">Already</span> up-<span class="keyword">to</span>-date.</span><br><span class="line"></span><br><span class="line"><span class="type">Adding</span> the spec <span class="keyword">to</span> the <span class="type">`XQSpecs&#x27;</span> repo</span><br><span class="line"></span><br><span class="line"> - [<span class="type">No</span> change] <span class="type">XQPerson</span> (<span class="number">0.0</span>.<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="type">Pushing</span> the <span class="type">`XQSpecs&#x27;</span> repo</span><br><span class="line"></span><br><span class="line">xuequandeMacBook-<span class="type">Pro</span>:<span class="type">XQPerson</span> xuequan$</span><br></pre></td></tr></table></figure>
<p>å®Œæˆä¹‹åè¿™ä¸ªç»„ä»¶åº“å°±æ·»åŠ åˆ°æˆ‘ä»¬çš„ç§æœ‰Spec Repoä¸­äº†ï¼Œå¯ä»¥è¿›å…¥åˆ°<code>~/.cocoapods/repos/XQSpecs</code>ç›®å½•ä¸‹æŸ¥çœ‹:<code>tree . -l</code></p>
<figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line"><span class="bullet">.</span></span><br><span class="line"><span class="bullet"></span>â”œâ”€â”€ XQPerson</span><br><span class="line">â”‚Â Â  â””â”€â”€ 0.0.1</span><br><span class="line">â”‚Â Â      â””â”€â”€ XQPerson.podspec</span><br></pre></td></tr></table></figure>
<p>å†å»çœ‹æˆ‘ä»¬çš„Spec Repoè¿œç«¯ä»“åº“ï¼Œä¹Ÿæœ‰äº†ä¸€æ¬¡æäº¤ï¼Œè¿™ä¸ªpodspecä¹Ÿå·²ç»è¢«Pushä¸Šå»äº†ã€‚</p>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬çš„è¿™ä¸ªç»„ä»¶åº“å°±å·²ç»åˆ¶ä½œæ·»åŠ å®Œæˆäº†ï¼Œä½¿ç”¨pod searchå‘½ä»¤å°±å¯ä»¥æŸ¥åˆ°æˆ‘ä»¬è‡ªå·±çš„åº“äº†:</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">-&gt; XQPerson (<span class="number">0.0</span>.<span class="number">1</span>)</span><br><span class="line">   Use XQPerson to print hello.</span><br><span class="line">   pod <span class="string">&#x27;XQPerson&#x27;</span>, <span class="string">&#x27;~&gt; 0.0.1&#x27;</span></span><br><span class="line">   - Homepage: https:<span class="regexp">//gi</span>tlab.com<span class="regexp">/xq_120/</span>XQPerson</span><br><span class="line">   - Source:   https:<span class="regexp">//gi</span>tlab.com<span class="regexp">/xq_120/</span>XQPerson.git</span><br><span class="line">   - Versions: <span class="number">0.0</span>.<span class="number">1</span> [XQSpecs repo]</span><br><span class="line">(<span class="keyword">END</span>)</span><br></pre></td></tr></table></figure>
<p>æœç´¢ä¸åˆ°çš„,å°†<code>/Users/xuequan/Library/Caches/CocoaPods</code>è·¯å¾„ä¸‹çš„<code>search_index.json</code>åˆ é™¤,ç„¶åé‡æ–°æœç´¢(å¯èƒ½éœ€è¦å…ˆæ›´æ–°ä¸‹Spec repo:<code>pod repo update</code>).</p>
<h3 id="ä½¿ç”¨è¿œç¨‹ç§æœ‰Pod"><a href="#ä½¿ç”¨è¿œç¨‹ç§æœ‰Pod" class="headerlink" title="ä½¿ç”¨è¿œç¨‹ç§æœ‰Pod"></a>ä½¿ç”¨è¿œç¨‹ç§æœ‰Pod</h3><p>Podfileæ–‡ä»¶:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">platform :ios, <span class="string">&#x27;9.0&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> <span class="string">&#x27;https://github.com/CocoaPods/Specs.git&#x27;</span></span><br><span class="line"><span class="built_in">source</span> <span class="string">&#x27;https://gitlab.com/xq_120/XQSpecs.git&#x27;</span></span><br><span class="line"></span><br><span class="line">target <span class="string">&#x27;tanwanlanyue&#x27;</span> <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">  pod <span class="string">&#x27;XQPerson&#x27;</span>, <span class="string">&#x27;~&gt; 0.0.1&#x27;</span></span><br><span class="line">  pod <span class="string">&#x27;AFNetworking&#x27;</span>, <span class="string">&#x27;~&gt; 3.2.0&#x27;</span></span><br><span class="line">  </span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œpod install:</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">xuequandeMacBook</span>-Pro:tanwanlanyue xuequan$ pod install</span><br><span class="line"><span class="attribute">Analyzing</span> dependencies</span><br><span class="line"><span class="attribute">Downloading</span> dependencies</span><br><span class="line"><span class="attribute">Installing</span> AFNetworking (<span class="number">3</span>.<span class="number">2</span>.<span class="number">0</span>)</span><br><span class="line"><span class="attribute">Installing</span> XQPerson (<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>)</span><br><span class="line"><span class="attribute">Generating</span> Pods project</span><br><span class="line"><span class="attribute">Integrating</span> client project</span><br><span class="line"><span class="attribute">Sending</span> stats</span><br><span class="line"><span class="attribute">Pod</span> installation complete! There are <span class="number">2</span> dependencies from the Podfile and <span class="number">2</span> total pods installed.</span><br><span class="line"><span class="attribute">xuequandeMacBook</span>-Pro:tanwanlanyue xuequan$</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&quot;ViewController.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="string">&lt;XQPerson.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="variable language_">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    XQPerson *p = [XQPerson new];</span><br><span class="line">    [p printHello]; <span class="comment">//2018-03-22 11:34:17.434385+0800 tanwanlanyue[9186:96648] hello</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://blog.wtlucky.com/blog/2015/02/26/create-private-podspec/">ä½¿ç”¨Cocoapodsåˆ›å»ºç§æœ‰podspec</a></p>
<p><a href="https://blog.cnbluebox.com/blog/2014/03/31/cocoapodsdai-ma-guan-li/">Cocoapodsä»£ç ç®¡ç†</a></p>
<p><a href="https://www.jianshu.com/p/5cb284934be2">cocoapodsè¿›é˜¶</a></p>
<p><a href="https://www.jianshu.com/p/1e5927eeb341">Cocoapodsä½¿ç”¨ç§æœ‰åº“ä¸­é‡åˆ°çš„å‘</a></p>
<p><a href="https://www.jianshu.com/p/0c640821b36f">CocoaPods ç§æœ‰ä»“åº“çš„åˆ›å»ºï¼ˆè¶…è¯¦ç»†ï¼‰</a></p>
<p><a href="https://segmentfault.com/a/1190000007947371">CocoaPodsåˆ›å»ºå…¬æœ‰å’Œç§æœ‰Podåº“æ–¹æ³•æ€»ç»“</a></p>
<hr>
<p><a href="https://blog.zengrong.net/post/1746.html">GitæŸ¥çœ‹ã€åˆ é™¤ã€é‡å‘½åè¿œç¨‹åˆ†æ”¯å’Œtag</a></p>
]]></content>
      <categories>
        <category>CocoaPods</category>
      </categories>
  </entry>
  <entry>
    <title>SDWebImageæºç åˆ†æ</title>
    <url>/2018/03/10/SDWebImage%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<p>ç‰ˆæœ¬ï¼šSDWebImage v5.11.1</p>
<h3 id="SDWebImageæºç åˆ†æ"><a href="#SDWebImageæºç åˆ†æ" class="headerlink" title="SDWebImageæºç åˆ†æ"></a>SDWebImageæºç åˆ†æ</h3><blockquote>
<p>æœ¬æ–‡ä¸»è¦åˆ†æè§£å†³ä»¥ä¸‹å‡ ä¸ªç–‘é—®:</p>
<ol>
<li>åŒä¸€å›¾ç‰‡çš„è¯·æ±‚,SDå¦‚ä½•ä»ç¼“å­˜ä¸­æŸ¥æ‰¾å‡ºæ¥(keyçš„å‘½åè§„åˆ™)?æˆ–è€…è¯´æŸ¥æ‰¾è¿‡ç¨‹æ˜¯æ€æ ·çš„?</li>
<li>SDå·¥ä½œè¿‡ç¨‹ä»¥åŠæ˜¯å¦‚ä½•ä»æœåŠ¡å™¨ä¸‹è½½çš„?</li>
<li>SDæ˜¯å¦‚ä½•ç¼“å­˜å›¾ç‰‡çš„?</li>
<li>å½“ç©ºé—´ä¸è¶³æ—¶,å®ƒçš„åˆ é™¤ç­–ç•¥æ˜¯ä»€ä¹ˆ(æŒ‰æ—¶é—´é¡ºåº,è¿˜æ˜¯å›¾ç‰‡è´¨é‡)?</li>
<li>SDå›¾ç‰‡ç¼“å­˜æœºåˆ¶ä¸ç³»ç»Ÿçš„NSURLCacheçš„åŒºåˆ«,ä¸ºä»€ä¹ˆSDè¯´è‡ªå·±çš„æ€§èƒ½è¦ç•¥é«˜äºç³»ç»Ÿçš„æ€§èƒ½?</li>
</ol>
</blockquote>
<h4 id="SDWebImageOptionsçš„æšä¸¾å€¼è§£é‡Š"><a href="#SDWebImageOptionsçš„æšä¸¾å€¼è§£é‡Š" class="headerlink" title="SDWebImageOptionsçš„æšä¸¾å€¼è§£é‡Š"></a>SDWebImageOptionsçš„æšä¸¾å€¼è§£é‡Š</h4><p>åœ¨ä½¿ç”¨SDæä¾›çš„UIImageViewç±»åˆ«æ–¹æ³•: </p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">- <span class="params">(void)</span>sd_setImageWithURL:<span class="params">(NSURL *)</span>url placeholderImage:<span class="params">(UIImage *)</span>placeholder options:<span class="params">(SDWebImageOptions)</span>options progress:<span class="params">(SDWebImageDownloaderProgressBlock)</span>progressBlock completed:<span class="params">(SDWebImageCompletionBlock)</span>completedBlock;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ä¸‹è½½å›¾ç‰‡æ—¶,æœ‰ä¸€ä¸ª<code>SDWebImageOptions</code>å‚æ•°,å®ƒå¯ä»¥ç”¨æ¥é…ç½®SDçš„ä¸‹è½½ã€ç¼“å­˜ç­‰è¡Œä¸º.è¯¥å‚æ•°æ˜¯ä¸€ä¸ªæšä¸¾,å®ƒæœ‰å¾ˆå¤šå¯é€‰çš„å€¼.<br>ä¸‹é¢å°†åˆ†ææ¯ä¸ªå€¼çš„å«ä¹‰:<br><code>SDWebImageRetryFailed = 1 &lt;&lt; 0</code>,SDçš„æ³¨é‡Š</p>
<figure class="highlight vbnet"><table><tr><td class="code"><pre><span class="line">/**</span><br><span class="line">     * <span class="keyword">By</span> <span class="keyword">default</span>, <span class="keyword">when</span> a URL fail <span class="keyword">to</span> be downloaded, the URL <span class="built_in">is</span> blacklisted so the library won<span class="comment">&#x27;t keep trying.</span></span><br><span class="line">     * This flag disable this blacklisting.</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<p>ç¿»è¯‘:<br>SDé»˜è®¤,å½“ä¸€ä¸ªURLä¸‹è½½å¤±è´¥å(ç½‘å€æ— æ•ˆçš„æƒ…å†µå¯¼è‡´çš„ä¸‹è½½å¤±è´¥æ‰ä¼šè¿›å…¥,å…¶ä»–æ¯”å¦‚ç½‘ç»œå·®åŸå› å¯¼è‡´çš„å¤±è´¥ä¸ä¼šè¿›å…¥é»‘åå•),è¯¥URLå°†ä¼šè¿›å…¥é»‘åå•,SDå°†ä¸ä¼šç»§ç»­å°è¯•ä¸‹è½½.è¯¥é€‰é¡¹å°†ä¸ä½¿èƒ½é»‘åå•.å³å³ä½¿è¯¥URLä¸‹è½½å¤±è´¥äº†,ä¹Ÿä¸ä¼šè¿›å…¥é»‘åå•,ä»¥åå¯ä»¥ç»§ç»­å°è¯•ä¸‹è½½.</p>
<p><code>SDWebImageLowPriority = 1 &lt;&lt; 1</code>,SDçš„æ³¨é‡Š</p>
<figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * By default, image downloads are started during UI interactions, this flags disable this feature,</span></span><br><span class="line"><span class="comment">     * leading to delayed download on UIScrollView deceleration for instance.</span></span><br><span class="line"><span class="comment">     */</span></span><br></pre></td></tr></table></figure>
<p>ç¿»è¯‘:<br>SDé»˜è®¤,å½“ç”¨æˆ·ç‚¹å‡»ä¸‹è½½æ—¶å°±å¼€å§‹ä¸‹è½½äº†,ä½†è¯¥æšä¸¾å€¼å°†ä¸ä½¿èƒ½è¯¥ç‰¹æ€§.æ¯”å¦‚UIScrollViewè¿˜åœ¨å‡é€Ÿçš„æ—¶å€™,å³ä½¿UIçš„äº¤äº’æŒ‡ç¤ºè¦å¼€å§‹ä¸‹è½½äº†,ä½†è¯¥æšä¸¾å€¼ä¼šä½¿SDå»¶åä¸‹è½½.</p>
<p><code>SDWebImageCacheMemoryOnly = 1 &lt;&lt; 2</code>,ä¸‹è½½çš„å›¾ç‰‡ä¸ç¼“å­˜åˆ°ç£ç›˜,ä»…ç¼“å­˜åˆ°å†…å­˜.</p>
<p><code>SDWebImageProgressiveDownload = 1 &lt;&lt; 3</code>,SDçš„æ³¨é‡Š</p>
<figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This flag enables progressive download, the image is displayed progressively during download as a browser would do.</span></span><br><span class="line"><span class="comment">     * By default, the image is only displayed once completely downloaded.</span></span><br><span class="line"><span class="comment">     */</span></span><br></pre></td></tr></table></figure>
<p>ç¿»è¯‘:<br>è¯¥æšä¸¾å€¼ä½¿èƒ½äº†progressive download(æ˜¾ç¤ºè¿›åº¦çš„ä¸‹è½½),å›¾ç‰‡å°†éšç€è¿›åº¦ä¸€ç‚¹ç‚¹æ˜¾ç¤º.SDé»˜è®¤åªæœ‰å½“å›¾ç‰‡å®Œå…¨ä¸‹è½½å®Œæˆåæ‰ä¸€æ¬¡æ€§æ˜¾ç¤º.</p>
<p><code>SDWebImageRefreshCached = 1 &lt;&lt; 4</code>,SDçš„æ³¨é‡Š</p>
<figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Even if the image is cached, respect the HTTP response cache control, and refresh the image from remote location if needed.</span></span><br><span class="line"><span class="comment">     * The disk caching will be handled by NSURLCache instead of SDWebImage leading to slight performance degradation.</span></span><br><span class="line"><span class="comment">     * This option helps deal with images changing behind the same request URL, e.g. Facebook graph api profile pics.</span></span><br><span class="line"><span class="comment">     * If a cached image is refreshed, the completion block is called once with the cached image and again with the final image.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Use this flag only if you can&#x27;t make your URLs static with embedded cache busting parameter.</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>ç¿»è¯‘:  </p>
<ul>
<li>å³ä½¿å›¾ç‰‡å·²ç»è¢«ç¼“å­˜äº†,ä½†æ˜¯æ ¹æ®HTTPå“åº”ç¼“å­˜æ§åˆ¶,å¦‚æœå¿…è¦çš„è¯è¿˜æ˜¯ä¼šç”¨è¿œç¨‹çš„å›¾ç‰‡åˆ·æ–°æœ¬åœ°çš„ç¼“å­˜çš„å›¾ç‰‡.</li>
<li>ç£ç›˜çš„ç¼“å­˜å°†ä½¿ç”¨ç³»ç»Ÿçš„NSURLCacheå¤„ç†è€Œä¸æ˜¯SDWebImage,æ‰€ä»¥ä¼šå¯¼è‡´ä¸€ä¸ªè½»å¾®çš„æ€§èƒ½ä¸‹é™.</li>
<li>è¯¥æšä¸¾å€¼ç”¨äºå¤„ç†å›¾ç‰‡æ”¹å˜ä½†å…¶å¯¹åº”çš„URLæ²¡å˜çš„æƒ…å†µ.</li>
<li>å¦‚æœç¼“å­˜çš„å›¾ç‰‡è¢«åˆ·æ–°,é‚£ä¹ˆthe completion blockä¼šè°ƒç”¨ä¸¤æ¬¡,ç¬¬ä¸€æ¬¡æ˜¯ç¼“å­˜çš„å›¾ç‰‡,æ¥ç€çš„ç¬¬äºŒæ¬¡æ˜¯æœ€ç»ˆçš„å›¾ç‰‡.</li>
<li>ä»…å½“ä½ ä¸èƒ½è®©ä½ çš„URLä¸ºä¸€ä¸ªé™æ€çš„åœ°å€æ—¶(æ—§å›¾ç‰‡æ˜¯ç½‘å€A,æ–°å›¾ç‰‡è¿˜æ˜¯ç½‘å€A)æ‰ä½¿ç”¨è¯¥æšä¸¾å€¼.</li>
</ul>
<p><code>SDWebImageContinueInBackground = 1 &lt;&lt; 5</code>,SDçš„æ³¨é‡Š</p>
<figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * In iOS 4+, continue the download of the image if the app goes to background. This is achieved by asking the system for</span></span><br><span class="line"><span class="comment">     * extra time in background to let the request finish. If the background task expires the operation will be cancelled.</span></span><br><span class="line"><span class="comment">     */</span></span><br></pre></td></tr></table></figure>
<p>ç¿»è¯‘:<br>éœ€è¦iOS4+,å½“APPè¿›å…¥åå°æ—¶,ç»§ç»­å›¾ç‰‡çš„ä¸‹è½½.è¯¥åŠŸèƒ½çš„å®ç°æ˜¯:è¿›å…¥åå°æ—¶,é€šè¿‡å‘ç³»ç»Ÿç”³è¯·é¢å¤–çš„æ—¶é—´æ¥è®©è¯·æ±‚å®Œæˆ.å¦‚æœåå°ä»»åŠ¡åˆ°æœŸ,æ“ä½œå°†è¢«å–æ¶ˆ.(xqæ³¨:æœ‰å¯èƒ½å–æ¶ˆæ—¶,å›¾ç‰‡è¿˜æ²¡ä¸‹è½½å®Œæˆ.è¿™ç§æƒ…å†µåº”è¯¥æ¯”è¾ƒå°‘è§,ä¸»è¦å‘ç”Ÿåœ¨ä¸‹è½½é«˜æ¸…å›¾,ä½†ç½‘é€Ÿåˆä¸å¥½çš„æƒ…å†µ)</p>
<p><code>SDWebImageHandleCookies = 1 &lt;&lt; 6</code>,å¤„ç†å­˜å‚¨åœ¨NSHTTPCookieStoreé‡Œçš„cookie.å†…éƒ¨é€šè¿‡è®¾ç½®NSMutableURLRequest.HTTPShouldHandleCookies = YES;å®ç°.</p>
<p><code>SDWebImageAllowInvalidSSLCertificates = 1 &lt;&lt; 7</code>,ä½¿èƒ½å…è®¸æœªä¿¡ä»»çš„SSLè¯ä¹¦.ä¸»è¦ç”¨äºæµ‹è¯•ç¯å¢ƒ.ç”Ÿäº§ç¯å¢ƒè°¨æ…ä½¿ç”¨.</p>
<p><code>SDWebImageHighPriority = 1 &lt;&lt; 8</code>,SDçš„æ³¨é‡Š</p>
<figure class="highlight actionscript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * By default, images are loaded in the order in which they were queued. This flag moves them to</span></span><br><span class="line"><span class="comment">     * the front of the queue.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ç¿»è¯‘:<br>SDé»˜è®¤,å›¾ç‰‡æ˜¯ä»¥å®ƒä»¬å…¥åˆ—æ—¶çš„é¡ºåºä¸‹è½½.è¯¥æšä¸¾å€¼ä¼šå°†å®ƒä»¬ç§»åˆ°é˜Ÿåˆ—çš„å‰é¢.</p>
<p><code>SDWebImageAvoidAutoSetImage = 1 &lt;&lt; 11</code>,SDé»˜è®¤å›¾ç‰‡ä¸‹è½½å®Œæˆåè‡ªåŠ¨è®¾ç½®imageView,ä½†è¯¥æšä¸¾å€¼å¯ä»¥è®©SDä¸è‡ªåŠ¨è®¾ç½®,è€Œæ˜¯è®©ç¨‹åºå‘˜æ‰‹åŠ¨è®¾ç½®.æ¯”å¦‚ä¸‹è½½å®Œæˆåè¿˜è¦å¤„ç†ä¸€ä¸‹æ‰è®¾ç½®åˆ°imageViewä¸Šå».</p>
<h4 id="SDçš„ç¼“å­˜è·¯å¾„"><a href="#SDçš„ç¼“å­˜è·¯å¾„" class="headerlink" title="SDçš„ç¼“å­˜è·¯å¾„"></a>SDçš„ç¼“å­˜è·¯å¾„</h4><p>SDé»˜è®¤çš„ç¼“å­˜è·¯å¾„:</p>
<figure class="highlight delphi"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Library</span>/Caches/<span class="keyword">default</span>/com.hackemist.SDWebImageCache.<span class="keyword">default</span>/cf00214b25574df24d89120a11424121.jpg</span><br></pre></td></tr></table></figure>
<p>å®ƒæ˜¯åœ¨<code>Library/Caches/</code>ç›®å½•ä¸‹åˆ›å»ºäº†<code>default/com.hackemist.SDWebImageCache.default/</code>è·¯å¾„,ä»¥åç¼“å­˜çš„å›¾ç‰‡å°†å­˜å‚¨åœ¨è¯¥è·¯å¾„ä¸‹.<strong>SDä¿å­˜å›¾ç‰‡çš„å‘½åè§„åˆ™:</strong>é€šè¿‡å¯¹URLString md5å,å†æ‹¼æ¥å¯èƒ½æœ‰çš„åç¼€åå¾—æ¥.å¦‚:cf00214b25574df24d89120a11424121.jpg</p>
<p>ç³»ç»Ÿ<code>NSURLCache</code>ç¼“å­˜çš„è·¯å¾„:<br><code>Library/Caches/bundleIdXXX(APP bundle id)/</code>,ç„¶ååœ¨<code>bundleIdXXX</code>æ–‡ä»¶å¤¹ä¸‹å­˜æ”¾ç¼“å­˜:<br><code>Cache.db,Cache.db-shm,Cache.db-wal,fsCachedData/A755FD02-64B3-430C-899D-6AD44E4D3229(å›¾ç‰‡çš„åç§°)</code>.</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">SDWebImageDownloader *downloader = [SDWebImageDownloader sharedDownloader];</span><br><span class="line">[downloader downloadImageWithURL:[<span class="built_in">NSURL</span> URLWithString:<span class="string">@&quot;http://b.zol-img.com.cn/sjbizhi/images/9/230x350/1469533909506.jpg&quot;</span>] options:SDWebImageDownloaderUseNSURLCache progress:<span class="literal">nil</span> completed:^(<span class="built_in">UIImage</span> *image, <span class="built_in">NSData</span> *data, <span class="built_in">NSError</span> *error, <span class="type">BOOL</span> finished) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;error:%@, finished:%d&quot;</span>, error, finished);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, image);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>å½“<code>SDWebImageDownloaderOptions</code>é€‰æ‹©<code>SDWebImageDownloaderUseNSURLCache</code>æ—¶,SDå°†é‡‡ç”¨ç³»ç»Ÿçš„<code>NSURLCache</code>ç¼“å­˜å›¾ç‰‡,æ‰€ä»¥è¿™é‡Œå³ä½¿ä¸‹è½½äº†,ä½†ä½¿ç”¨SDçš„ç±»åˆ«ä¸‹è½½æ—¶[self.myImageView sd_setImageWithURL:]ç”±äºé‡‡ç”¨çš„æ˜¯å¦ä¸€å¥—æŸ¥æ‰¾æœºåˆ¶,å®ƒæ²¡æœ‰å»æŸ¥æ‰¾ç³»ç»Ÿçš„ç¼“å­˜,æ‰€ä»¥è¿˜å¾—é‡æ–°ä¸‹è½½.</p>
<h4 id="åŒä¸€å›¾ç‰‡çš„è¯·æ±‚-SDå¦‚ä½•ä»ç¼“å­˜ä¸­æŸ¥æ‰¾å‡ºæ¥-keyçš„å‘½åè§„åˆ™-æˆ–è€…è¯´æŸ¥æ‰¾è¿‡ç¨‹æ˜¯æ€æ ·çš„"><a href="#åŒä¸€å›¾ç‰‡çš„è¯·æ±‚-SDå¦‚ä½•ä»ç¼“å­˜ä¸­æŸ¥æ‰¾å‡ºæ¥-keyçš„å‘½åè§„åˆ™-æˆ–è€…è¯´æŸ¥æ‰¾è¿‡ç¨‹æ˜¯æ€æ ·çš„" class="headerlink" title="åŒä¸€å›¾ç‰‡çš„è¯·æ±‚,SDå¦‚ä½•ä»ç¼“å­˜ä¸­æŸ¥æ‰¾å‡ºæ¥(keyçš„å‘½åè§„åˆ™)?æˆ–è€…è¯´æŸ¥æ‰¾è¿‡ç¨‹æ˜¯æ€æ ·çš„?"></a>åŒä¸€å›¾ç‰‡çš„è¯·æ±‚,SDå¦‚ä½•ä»ç¼“å­˜ä¸­æŸ¥æ‰¾å‡ºæ¥(keyçš„å‘½åè§„åˆ™)?æˆ–è€…è¯´æŸ¥æ‰¾è¿‡ç¨‹æ˜¯æ€æ ·çš„?</h4><p>SD keyçš„å‘½åè§„åˆ™æ˜¯æ€æ ·çš„?<br><code>NSString *key = [self cacheKeyForURL:url];</code></p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">NSString</span> *)cacheKeyForURL:(<span class="built_in">NSURL</span> *)url &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.cacheKeyFilter) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.cacheKeyFilter(url);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [url absoluteString];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SDå‘½åcacheçš„keyæ˜¯é€šè¿‡è¿”å›URLçš„absoluteStringå±æ€§çš„å€¼.è¯¥keyåœ¨åé¢çš„å†…å­˜æŸ¥æ‰¾ç¼“å­˜å’Œç£ç›˜æŸ¥æ‰¾ç¼“å­˜éƒ½æœ‰ç”¨åˆ°çš„.</p>
<p>SDè‡ªå®šä¹‰äº†ä¸€ä¸ªç¼“å­˜ç±»SDImageCache,è¯¥ç±»ç»´æŠ¤ç€ä¸€ä¸ªå†…å­˜ç¼“å­˜å’Œä¸€ä¸ªå¯é€‰çš„ç£ç›˜ç¼“å­˜.Disk cacheçš„å†™æ“ä½œæ˜¯å¼‚æ­¥çš„å› æ­¤ä¸ç”¨æ‹…å¿ƒå½±å“åˆ°UI.</p>
<p>ç»´æŠ¤çš„å†…å­˜ç¼“å­˜æ˜¯ä¸€ä¸ªAutoPurgeCacheå¯¹è±¡.<code>@interface AutoPurgeCache : NSCache</code>.AutoPurageCacheä¸»è¦æ˜¯åœ¨åˆå§‹åŒ–çš„æ—¶å€™æ³¨å†Œäº†ä¸€ä¸ªUIApplicationDidReceiveMemoryWarningNotificationå†…å­˜è­¦å‘Šçš„é€šçŸ¥.å¦‚æœæ”¶åˆ°å†…å­˜è­¦å‘Šé€šçŸ¥,åˆ™è°ƒç”¨<code>-removeAllObjects</code>æ¸…ç©ºç¼“å­˜.</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@interface</span> SDImageCache ()</span><br><span class="line"></span><br><span class="line"><span class="variable">@property</span> (strong, nonatomic) NSCache *memCache;</span><br><span class="line"><span class="variable">@property</span> (strong, nonatomic) NSString *diskCachePath;</span><br><span class="line"><span class="variable">@property</span> (strong, nonatomic) NSMutableArray *customPaths;</span><br><span class="line"><span class="variable">@property</span> (SDDispatchQueueSetterSementics, nonatomic) dispatch_queue_t ioQueue;</span><br><span class="line"></span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Init the memory cache</span></span><br><span class="line"><span class="variable">_memCache</span> = [[AutoPurgeCache alloc] init];</span><br><span class="line"><span class="variable">_memCache</span>.<span class="built_in">name</span> = fullNamespace;</span><br></pre></td></tr></table></figure>
<p>SDä¸‹è½½å›¾ç‰‡æ—¶æ˜¯å°†ä¸‹è½½å°è£…åˆ°ä¸€ä¸ªæ“ä½œé‡Œé¢çš„.</p>
<p>SDçš„ä¸»ç±»<code>SDWebImageManager</code>æœ‰ä¸¤ä¸ªé‡è¦çš„å±æ€§</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) SDImageCache *imageCache;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) SDWebImageDownloader *imageDownloader;</span><br></pre></td></tr></table></figure>
<p><code>SDImageCache</code>æ˜¯ç”¨æ¥æ“ä½œç¼“å­˜çš„,<code>SDWebImageDownloader</code>æ˜¯ç”¨æ¥ä¸‹è½½å›¾ç‰‡çš„.</p>
<p>SDé€šè¿‡ä¸Šé¢çš„Keyå‚æ•°å’Œæ–¹æ³•<code>- (NSOperation *)queryDiskCacheForKey:(NSString *)key done:(SDWebImageQueryCompletedBlock)doneBlock</code>æ¥æŸ¥æ‰¾ç¼“å­˜.</p>
<h4 id="åŒæ­¥æŸ¥æ‰¾å†…å­˜ç¼“å­˜"><a href="#åŒæ­¥æŸ¥æ‰¾å†…å­˜ç¼“å­˜" class="headerlink" title="åŒæ­¥æŸ¥æ‰¾å†…å­˜ç¼“å­˜"></a>åŒæ­¥æŸ¥æ‰¾å†…å­˜ç¼“å­˜</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">UIImage</span> *)imageFromMemoryCacheForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span>.memCache objectForKey:key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å†…å­˜æŸ¥æ‰¾æ¯”è¾ƒç®€å•,å°±æ˜¯ä½¿ç”¨NSCacheçš„æ–¹æ³•<code>-objectForKey:</code>,å¦‚æœåœ¨å†…å­˜é‡Œæ‰¾åˆ°é‚£ä¹ˆå°±ç›´æ¥è¿”å›å›¾ç‰‡äº†.å¦‚æœæ²¡æŸ¥åˆ°,å°±<strong>å¼‚æ­¥çš„ä»ç£ç›˜é‡ŒæŸ¥æ‰¾</strong>.ä¹Ÿå°±æ˜¯è¯´SDçš„<code>- (NSOperation *)queryDiskCacheForKey:(NSString *)key done:(SDWebImageQueryCompletedBlock)doneBlock</code>æ–¹æ³•æ˜¯åŒæ­¥çš„æŸ¥æ‰¾å†…å­˜ä¸­ç¼“å­˜,å¼‚æ­¥çš„æŸ¥æ‰¾ç£ç›˜ä¸­çš„ç¼“å­˜.<br>PS:NSCacheç±»ä¼¼äºNSDictionary.å®ƒé‡Œé¢å­˜æ”¾çš„å¯¹è±¡éƒ½æ˜¯ä½äºå†…å­˜çš„.</p>
<h4 id="å¼‚æ­¥æŸ¥æ‰¾ç£ç›˜ç¼“å­˜"><a href="#å¼‚æ­¥æŸ¥æ‰¾ç£ç›˜ç¼“å­˜" class="headerlink" title="å¼‚æ­¥æŸ¥æ‰¾ç£ç›˜ç¼“å­˜"></a>å¼‚æ­¥æŸ¥æ‰¾ç£ç›˜ç¼“å­˜</h4><figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="built_in">dispatch_async</span>(<span class="keyword">self</span>.ioQueue, ^&#123;</span><br><span class="line">	<span class="keyword">if</span> (operation.isCancelled) &#123;</span><br><span class="line">	    <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">	    <span class="built_in">UIImage</span> *diskImage = [<span class="keyword">self</span> diskImageForKey:key];</span><br><span class="line">	    <span class="keyword">if</span> (diskImage &amp;&amp; <span class="keyword">self</span>.shouldCacheImagesInMemory) &#123;</span><br><span class="line">	        <span class="built_in">NSUInteger</span> cost = SDCacheCostForImage(diskImage);</span><br><span class="line">	        [<span class="keyword">self</span>.memCache setObject:diskImage forKey:key cost:cost];</span><br><span class="line">	    &#125;</span><br><span class="line">	</span><br><span class="line">	    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">	        doneBlock(diskImage, SDImageCacheTypeDisk);</span><br><span class="line">	    &#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="æ ¹æ®Keyåœ¨ç£ç›˜ä¸­æ‰¾åˆ°å¯¹åº”çš„ç¼“å­˜å›¾ç‰‡"><a href="#æ ¹æ®Keyåœ¨ç£ç›˜ä¸­æ‰¾åˆ°å¯¹åº”çš„ç¼“å­˜å›¾ç‰‡" class="headerlink" title="æ ¹æ®Keyåœ¨ç£ç›˜ä¸­æ‰¾åˆ°å¯¹åº”çš„ç¼“å­˜å›¾ç‰‡"></a>æ ¹æ®Keyåœ¨ç£ç›˜ä¸­æ‰¾åˆ°å¯¹åº”çš„ç¼“å­˜å›¾ç‰‡</h4><p>ä¸»è¦æ–¹æ³•:<code>UIImage *diskImage = [self diskImageForKey:key];</code></p>
<p>SDæ˜¯é€šè¿‡Keyå¾—åˆ°æ–‡ä»¶(å›¾ç‰‡)åçš„,<code>NSString *filename = [self cachedFileNameForKey:key];</code>æ–¹æ³•å†…éƒ¨æ˜¯å¯¹keyè¿›è¡Œmd5ç­¾å,å¾—åˆ°ä¸€ä¸ªç­¾åä¸²,ç„¶åå†æ‹¼æ¥åç¼€å(å¦‚æœkeyé‡Œé¢æœ‰åç¼€çš„è¯).è¿™ä¸ªæ—¶å€™å°±å¾—åˆ°äº†æ–‡ä»¶å,å†æ‹¼æ¥SDè‡ªå·±çš„å­˜å‚¨è·¯å¾„self.diskCachePath(<code>/Library/Caches/default/com.hackemist.SDWebImageCache.default</code>äº‹å…ˆæŒ‡å®šå¥½çš„è·¯å¾„å).åˆ°è¿™ä¸€æ­¥å°±è·å¾—äº†æŒ‡å®škeyçš„ç¼“å­˜å›¾ç‰‡çš„è·¯å¾„(<code>/Library/Caches/default/com.hackemist.SDWebImageCache.default/cf00214b25574df24d89120a11424121.jpg</code>).é€šè¿‡<code>NSData *data = [NSData dataWithContentsOfFile:defaultPath];</code>è¯»å–å‡ºæ–‡ä»¶çš„æ•°æ®.æœ€åå°†NSDataè½¬åŒ–ä¸ºUIImage.è‡³æ­¤ä»ç£ç›˜æŸ¥æ‰¾æŒ‡å®škeyçš„ç¼“å­˜å›¾ç‰‡å°±åˆ°æ­¤ç»“æŸäº†.<br>PS:<code>[result appendFormat:@&quot;%02x&quot;, digest[i]];</code><br>x/X:è¡¨ç¤ºä»¥åå…­è¿›åˆ¶å½¢å¼è¾“å‡º.<br>02:è¡¨ç¤ºä¸è¶³ä¸¤ä½,å‰é¢è¡¥0è¾“å‡º;è¶…è¿‡ä¸¤ä½,åˆ™ç›´æ¥è¾“å‡º.</p>
<h3 id="SDæ˜¯å¦‚ä½•ç¼“å­˜å›¾ç‰‡çš„"><a href="#SDæ˜¯å¦‚ä½•ç¼“å­˜å›¾ç‰‡çš„" class="headerlink" title="SDæ˜¯å¦‚ä½•ç¼“å­˜å›¾ç‰‡çš„?"></a>SDæ˜¯å¦‚ä½•ç¼“å­˜å›¾ç‰‡çš„?</h3><p>ä¸»è¦æ˜¯é€šè¿‡<code>SDImageCache</code>ç±»å®Œæˆç¼“å­˜åŠŸèƒ½.<code>SDImageCache</code>æä¾›çš„æ¥å£æœ‰:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">SDImageCache</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - Properties</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">nonnull</span>) <span class="built_in">NSCache</span> *memCache; <span class="comment">//é‡Œé¢æ˜¯å…³è”äº†ä¸€ä¸ªç³»ç»Ÿçš„NSCacheå¯¹è±¡.</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">nonnull</span>) <span class="built_in">NSString</span> *diskCachePath;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>) <span class="built_in">NSMutableArray</span>&lt;<span class="built_in">NSString</span> *&gt; *customPaths;</span><br><span class="line"><span class="keyword">@property</span> (SDDispatchQueueSetterSementics, <span class="keyword">nonatomic</span>, <span class="keyword">nullable</span>) <span class="built_in">dispatch_queue_t</span> ioQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>åˆå§‹åŒ–æ–¹æ³•:<br><code>+ (SDImageCache *)sharedImageCache;</code>ã€<code>- (id)initWithNamespace:(NSString *)ns diskCacheDirectory:(NSString *)directory;</code>æä¾›ç¼“å­˜è·¯å¾„çš„è®¾ç½®.</p>
</li>
<li><p>å­˜å‚¨ç¼“å­˜æ–¹æ³•:<br><code>- (void)storeImage:(UIImage *)image forKey:(NSString *)key toDisk:(BOOL)toDisk;</code></p>
</li>
<li><p>è·å–ç¼“å­˜æ–¹æ³•:</p>
<ol>
<li><code>- (NSOperation *)queryDiskCacheForKey:(NSString *)key done:(SDWebImageQueryCompletedBlock)doneBlock;</code></li>
<li><code>- (UIImage *)imageFromMemoryCacheForKey:(NSString *)key;</code></li>
<li><code>- (UIImage *)imageFromDiskCacheForKey:(NSString *)key;</code></li>
</ol>
</li>
<li><p>ç§»é™¤ç¼“å­˜çš„æ–¹æ³•:</p>
<ol>
<li><code>- (void)removeImageForKey:(NSString *)key fromDisk:(BOOL)fromDisk withCompletion:(SDWebImageNoParamsBlock)completion;</code></li>
<li><code>- (void)clearDisk;</code></li>
<li><code>- (void)cleanDiskWithCompletionBlock:(SDWebImageNoParamsBlock)completionBlock;</code></li>
</ol>
</li>
<li><p>æŸ¥è¯¢ä¿¡æ¯æ–¹æ³•(æŸ¥è¯¢æŸä¸ªkeyçš„ç¼“å­˜æ˜¯å¦å­˜åœ¨,æŸ¥è¯¢ç¼“å­˜å ç”¨äº†å¤šå°‘ç©ºé—´):</p>
<ol>
<li><code>- (NSUInteger)getSize;</code></li>
<li><code>- (BOOL)diskImageExistsWithKey:(NSString *)key;</code></li>
<li><code>- (void)calculateSizeWithCompletionBlock:(SDWebImageCalculateSizeBlock)completionBlock;</code></li>
</ol>
</li>
</ul>
<p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªç±»çš„æ¥å£åŠŸèƒ½æ˜¯æ¯”è¾ƒå®Œå–„çš„,æœ‰åˆå§‹åŒ–æ–¹æ³•ã€å­˜ã€å–ã€åˆ ã€æŸ¥è¯¢ä¿¡æ¯ç­‰æ–¹æ³•.å¹¶ä¸”åŸºæœ¬éƒ½æä¾›äº†ä¸€ä¸ªåŒæ­¥çš„,ä¸€ä¸ªå¼‚æ­¥çš„.</p>
<p>å½“å›¾ç‰‡ä¸‹è½½å®Œæˆå,å°±è¿›è¡Œç¼“å­˜:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (downloadedImage &amp;&amp; finished) &#123;</span><br><span class="line">	[<span class="keyword">self</span>.imageCache storeImage:downloadedImage recalculateFromImage:<span class="literal">NO</span> imageData:data forKey:key toDisk:cacheOnDisk];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dispatch_main_sync_safe(^&#123;</span><br><span class="line">	<span class="keyword">if</span> (strongOperation &amp;&amp; !strongOperation.isCancelled) &#123;</span><br><span class="line">	    completedBlock(downloadedImage, <span class="literal">nil</span>, SDImageCacheTypeNone, finished, url);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//æœ€ç»ˆæ˜¯å°†å›¾ç‰‡çš„äºŒè¿›åˆ¶æ•°æ®å†™å…¥æ–‡ä»¶</span></span><br><span class="line"><span class="comment">// Make sure to call form io queue by caller</span></span><br><span class="line">- (<span class="type">void</span>)_storeImageDataToDisk:(<span class="keyword">nullable</span> <span class="built_in">NSData</span> *)imageData forKey:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> (!imageData || !key) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (![<span class="keyword">self</span>.fileManager fileExistsAtPath:_diskCachePath]) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.fileManager createDirectoryAtPath:_diskCachePath withIntermediateDirectories:<span class="literal">YES</span> attributes:<span class="literal">nil</span> error:<span class="literal">NULL</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// get cache Path for image key</span></span><br><span class="line">    <span class="built_in">NSString</span> *cachePathForKey = [<span class="keyword">self</span> defaultCachePathForKey:key];</span><br><span class="line">    <span class="comment">// transform to NSUrl</span></span><br><span class="line">    <span class="built_in">NSURL</span> *fileURL = [<span class="built_in">NSURL</span> fileURLWithPath:cachePathForKey];</span><br><span class="line">    </span><br><span class="line">    [imageData writeToURL:fileURL options:<span class="keyword">self</span>.config.diskCacheWritingOptions error:<span class="literal">nil</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// disable iCloud backup</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.config.shouldDisableiCloud) &#123;</span><br><span class="line">        [fileURL setResourceValue:@YES forKey:<span class="built_in">NSURLIsExcludedFromBackupKey</span> error:<span class="literal">nil</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="SDæ¸…é™¤ç¼“å­˜è§„åˆ™"><a href="#SDæ¸…é™¤ç¼“å­˜è§„åˆ™" class="headerlink" title="SDæ¸…é™¤ç¼“å­˜è§„åˆ™"></a>SDæ¸…é™¤ç¼“å­˜è§„åˆ™</h4><p>SDçš„ç¼“å­˜æ¸…ç†æ¶‰åŠåˆ°ä¸¤ä¸ªå…³é”®çš„é…ç½®å±æ€§:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æœ€å¤§ç¼“å­˜æ—¶é—´</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The maximum length of time to keep an image in the cache, in seconds.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSInteger</span> maxCacheAge;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æœ€å¤§ç¼“å­˜ç©ºé—´</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The maximum size of the cache, in bytes.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSUInteger</span> maxCacheSize;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)setMaxMemoryCost:(<span class="built_in">NSUInteger</span>)maxMemoryCost &#123;</span><br><span class="line">    <span class="keyword">self</span>.memCache.totalCostLimit = maxMemoryCost;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)maxMemoryCost &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.memCache.totalCostLimit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>SDæ ¹æ®è¿™ä¸¤ä¸ªå±æ€§çš„å€¼,å…ˆåˆ é™¤æœ€æ—§çš„æ–‡ä»¶.åˆ é™¤åè‹¥è¿˜è¶…å‡ºäº†maxCacheSize,åˆ™è¿›ä¸€æ­¥åˆ é™¤æ—§æ–‡ä»¶.ä¸éš¾çœ‹å‡ºSDæ¸…é™¤ç¼“å­˜çš„ç­–ç•¥å°±æ˜¯åˆ é™¤æ—§æ–‡ä»¶.è€Œå…¶ä»–æ¡†æ¶å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒ.æ¯”å¦‚é‡‡ç”¨LFU(Least Frequently Used)ç®—æ³•.å®ƒæ˜¯æ ¹æ®æ•°æ®çš„å†å²è®¿é—®é¢‘ç‡æ¥æ·˜æ±°æ•°æ®ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯â€œå¦‚æœæ•°æ®è¿‡å»è¢«è®¿é—®å¤šæ¬¡ï¼Œé‚£ä¹ˆå°†æ¥è¢«è®¿é—®çš„é¢‘ç‡ä¹Ÿæ›´é«˜â€ã€‚</p>
<p>ç¼“å­˜æ¸…é™¤æ—¶æœº:appå³å°†å¹²æ‰,æˆ–è¿›å…¥åå°æ—¶.</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Subscribe to app events</span></span><br><span class="line">[[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span></span><br><span class="line">                                         selector:<span class="keyword">@selector</span>(deleteOldFiles)</span><br><span class="line">                                             name:<span class="built_in">UIApplicationWillTerminateNotification</span></span><br><span class="line">                                           object:<span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line">[[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span></span><br><span class="line">                                         selector:<span class="keyword">@selector</span>(backgroundDeleteOldFiles)</span><br><span class="line">                                             name:<span class="built_in">UIApplicationDidEnterBackgroundNotification</span></span><br><span class="line">                                           object:<span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Start the long-running task and return immediately.</span></span><br><span class="line">[<span class="keyword">self</span> deleteOldFilesWithCompletionBlock:^&#123;</span><br><span class="line">    [application endBackgroundTask:bgTask];</span><br><span class="line">    bgTask = <span class="built_in">UIBackgroundTaskInvalid</span>;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<h3 id="SDå›¾ç‰‡ä¸‹è½½"><a href="#SDå›¾ç‰‡ä¸‹è½½" class="headerlink" title="SDå›¾ç‰‡ä¸‹è½½"></a>SDå›¾ç‰‡ä¸‹è½½</h3><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">SDWebImageCombinedOperation </span>: NSObject &lt;SDWebImageOperation&gt;</span><br><span class="line"></span><br><span class="line"><span class="variable">@property</span> (assign, nonatomic, getter = isCancelled) BOOL cancelled;</span><br><span class="line"><span class="variable">@property</span> (copy, nonatomic) SDWebImageNoParamsBlock cancelBlock;</span><br><span class="line"><span class="variable">@property</span> (strong, nonatomic) NSOperation *cacheOperation;</span><br><span class="line"></span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure>
<p><code>__block SDWebImageCombinedOperation *operation = [SDWebImageCombinedOperation new];</code><br><code>operation.cacheOperation = [self.imageCache queryDiskCacheForKey:key done:^(UIImage *image, SDImageCacheType cacheType) &#123;...&#125;];</code><br><strong>ä¸å¤ªæ˜ç™½<code>SDWebImageCombinedOperation</code>çš„cacheOperationèµ‹å€¼ä»¥åæœ‰ä»€ä¹ˆç”¨</strong>,å¥½åƒæ²¡æœ‰å“ªä¸ªåœ°æ–¹å°†å®ƒæ·»åŠ åˆ°é˜Ÿåˆ—é‡Œ.ä»…ä»…åœ¨<code>SDWebImageCombinedOperation</code>çš„cancelæ–¹æ³•é‡Œçœ‹åˆ°ç”¨äº†ä¸€ä¸‹.</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)cancel &#123;</span><br><span class="line">    <span class="keyword">self</span>.cancelled = <span class="literal">YES</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.cacheOperation) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.cacheOperation cancel];</span><br><span class="line">        <span class="keyword">self</span>.cacheOperation = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.cancelBlock) &#123;</span><br><span class="line">        <span class="keyword">self</span>.cancelBlock();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> this is a temporary fix to #809.</span></span><br><span class="line">        <span class="comment">// Until we can figure the exact cause of the crash, going with the ivar instead of the setter</span></span><br><span class="line"><span class="comment">//        self.cancelBlock = nil;</span></span><br><span class="line">        _cancelBlock = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">- <span class="params">(id &lt;SDWebImageOperation&gt;)</span>loadImageWithURL:<span class="params">(nullable NSURL *)</span>url</span><br><span class="line">                                     options:<span class="params">(SDWebImageOptions)</span>options</span><br><span class="line">                                    progress:<span class="params">(nullable SDWebImageDownloaderProgressBlock)</span>progressBlock</span><br><span class="line">                                   completed:<span class="params">(nullable SDInternalCompletionBlock)</span>completedBlock;</span><br><span class="line">                                   </span><br><span class="line">- <span class="params">(nullable SDWebImageDownloadToken *)</span>addProgressCallback:<span class="params">(SDWebImageDownloaderProgressBlock)</span>progressBlock</span><br><span class="line">                                           completedBlock:<span class="params">(SDWebImageDownloaderCompletedBlock)</span>completedBlock</span><br><span class="line">                                                   forURL:<span class="params">(nullable NSURL *)</span>url</span><br><span class="line">                                           createCallback:<span class="params">(SDWebImageDownloaderOperation *(^)</span><span class="params">(void)</span>)createCallback;</span><br></pre></td></tr></table></figure>
<p>ä¸‹è½½çš„æ“ä½œå°±æ˜¯åœ¨è¯¥æ–¹æ³•ä¸­åŠ å…¥åˆ°é˜Ÿåˆ—é‡Œçš„,ä»£ç ç‰‡æ®µ:</p>
<figure class="highlight smali"><table><tr><td class="code"><pre><span class="line">// Add operation to operation queue only after all configuration done according to Apple&#x27;s doc.</span><br><span class="line">// `addOperation:` does<span class="built_in"> not </span>synchronously<span class="built_in"> execute </span>the `operation.completionBlock` so this will<span class="built_in"> not </span>cause deadlock.</span><br><span class="line">[self.downloadQueue addOperation:operation];</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>æºç åˆ†æ</category>
      </categories>
      <tags>
        <tag>SDWebImage</tag>
      </tags>
  </entry>
  <entry>
    <title>å“åº”è€…é“¾hitTesté‡Šç–‘</title>
    <url>/2018/02/28/%E5%93%8D%E5%BA%94%E8%80%85%E9%93%BEhitTest%E9%87%8A%E7%96%91/</url>
    <content><![CDATA[<p>pointInsideæ–¹æ³•è¯´æ˜ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> point:</span></span><br><span class="line"><span class="comment"> A point that is in the receiverâ€™s local coordinate system (bounds).</span></span><br><span class="line"><span class="comment"> pointå‚æ•°ç³»ç»Ÿå·²ç»è½¬ä¸ºå½“å‰è§†å›¾åæ ‡ç³»çš„åæ ‡äº†ã€‚æ¯”å¦‚ç‚¹å‡»è§†å›¾çš„å·¦ä¸Šè§’é‚£ä¹ˆpointå°±æ˜¯ï¼ˆ0,0ï¼‰</span></span><br><span class="line"><span class="comment"> å†å¾€å·¦ä¸Šåæ ‡å¯èƒ½å°±æ˜¯ï¼ˆ-3ï¼Œ-4ï¼‰è¿™æ ·ã€‚pointå¯ä»¥åœ¨è§†å›¾åŒºåŸŸå¤–ï¼Œä½†ä¹Ÿéµå®ˆå½“å‰è§†å›¾åæ ‡ç³»çš„è§„åˆ™ï¼Œå¦‚æœè§†å›¾çš„å¤§å°ä¸ºï¼ˆ30,30ï¼‰ï¼Œé‚£ä¹ˆä»–çš„åæ ‡å°±æ˜¯ï¼ˆ40,42ï¼‰ã€‚</span></span><br><span class="line"><span class="comment"> è§†å›¾çš„bounds:</span></span><br><span class="line"><span class="comment"> é»˜è®¤æƒ…å†µä¸‹è§†å›¾boundsçš„x,yéƒ½æ˜¯0ï¼Œie:åæ ‡çš„åŸç‚¹ä¸ºï¼ˆ0,0ï¼‰</span></span><br><span class="line"><span class="comment"> + + +&gt;</span></span><br><span class="line"><span class="comment"> +</span></span><br><span class="line"><span class="comment"> +</span></span><br><span class="line"><span class="comment"> å¦‚æœæ›´æ”¹boundsçš„x,yä¸ºï¼ˆ10,10ï¼‰ï¼Œie:åæ ‡çš„åŸç‚¹å°†å˜ä¸ºï¼ˆ10,10ï¼‰</span></span><br><span class="line"><span class="comment"> ä»¥è§†å›¾ä¸ºåæ ‡ç³»çš„ç‚¹ä¼šæ•´ä½“åç§»ï¼ˆ10,10ï¼‰ã€‚ä¹Ÿå°±æ˜¯ä»¥å‰æ˜¯(1,5)çš„ç‚¹ï¼Œç°åœ¨å˜ä¸º(11,15)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="type">BOOL</span>)pointInside:(<span class="built_in">CGPoint</span>)point withEvent:(<span class="keyword">nullable</span> <span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    <span class="built_in">CGRect</span> rect = [<span class="keyword">self</span> enlargedRect];</span><br><span class="line">    <span class="type">BOOL</span> rs = <span class="built_in">CGRectContainsPoint</span>(rect, point);</span><br><span class="line">    <span class="keyword">return</span> rs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">CGRect</span>)enlargedRect &#123;</span><br><span class="line">    <span class="built_in">NSNumber</span> *topEdge = objc_getAssociatedObject(<span class="keyword">self</span>, &amp;topNameKey);</span><br><span class="line">    <span class="built_in">NSNumber</span> *rightEdge = objc_getAssociatedObject(<span class="keyword">self</span>, &amp;rightNameKey);</span><br><span class="line">    <span class="built_in">NSNumber</span> *bottomEdge = objc_getAssociatedObject(<span class="keyword">self</span>, &amp;bottomNameKey);</span><br><span class="line">    <span class="built_in">NSNumber</span> *leftEdge = objc_getAssociatedObject(<span class="keyword">self</span>, &amp;leftNameKey);</span><br><span class="line">    <span class="keyword">if</span> (topEdge &amp;&amp; rightEdge &amp;&amp; bottomEdge &amp;&amp; leftEdge) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">CGRectMake</span>(<span class="keyword">self</span>.bounds.origin.x - leftEdge.floatValue,</span><br><span class="line">                          <span class="keyword">self</span>.bounds.origin.y - topEdge.floatValue,</span><br><span class="line">                          <span class="keyword">self</span>.bounds.size.width + leftEdge.floatValue + rightEdge.floatValue,</span><br><span class="line">                          <span class="keyword">self</span>.bounds.size.height + topEdge.floatValue + bottomEdge.floatValue);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.bounds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Q:UIButtonæƒ³è¦æ‰©å¤§å®ƒçš„å“åº”åŒºåŸŸ?<br>A:é‡è½½UIButtonçš„hitTestæˆ–pointInside.<br>é‡è½½hitTest:</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">UIView</span> *)hitTest:(<span class="built_in">CGPoint</span>)point withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">self</span>.userInteractionEnabled == <span class="literal">NO</span> || <span class="keyword">self</span>.hidden == <span class="literal">YES</span> || <span class="keyword">self</span>.alpha &lt;= <span class="number">0.01</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">CGRect</span> touchRect = <span class="built_in">CGRectInset</span>(<span class="keyword">self</span>.bounds, <span class="number">-40</span>, <span class="number">-40</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">CGRectContainsPoint</span>(touchRect, point)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="variable language_">super</span> hitTest:point withEvent:event];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ–é‡è½½pointInside:</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)pointInside:(<span class="built_in">CGPoint</span>)point withEvent:(<span class="keyword">nullable</span> <span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    <span class="type">BOOL</span> rs = <span class="built_in">CGRectContainsPoint</span>(<span class="built_in">CGRectInset</span>(<span class="keyword">self</span>.bounds, <span class="number">-40</span>, <span class="number">-40</span>), point);</span><br><span class="line">    <span class="keyword">return</span> rs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæ¨èé‡å†™pointInsideæ–¹æ³•.å› ä¸ºé‡å†™hitTestæ–¹æ³•éœ€è¦æ³¨æ„åˆ¤æ–­viewçš„ä¸€äº›å±æ€§:<code>if (self.userInteractionEnabled == NO || self.hidden == YES || self.alpha &lt;= 0.01) return nil;</code>å¦‚æœä¸åˆ¤æ–­ä¼šå‡ºBug,æ¯”å¦‚è®¾ç½®æŒ‰é’®hiddenä¸ºYESäº†,ä½†æ˜¯æ‘¸åˆ°æŒ‰é’®çš„åŒºåŸŸ,æŒ‰é’®çš„å“åº”æ–¹æ³•ä¸€æ ·ä¼šè¢«è°ƒç”¨.è€Œé‡å†™pointInsideæ–¹æ³•åˆ™ä¸éœ€è¦è€ƒè™‘è¿™äº›.</p>
<p>PS:å¦‚æœè®¾ç½®äº†userInteractionEnabled=NO;å³ä½¿é‡å†™hitTestè¿”å›æŒ‰é’®è‡ªå·±,æŒ‰é’®çš„å“åº”æ–¹æ³•ä¹Ÿä¸ä¼šå›è°ƒ.åº”è¯¥æ˜¯ç³»ç»Ÿåœ¨å›è°ƒä¹‹å‰åˆåˆ¤æ–­äº†ä¸€ä¸‹è¯¥å±æ€§çš„å€¼.</p>
<p>userInteractionEnabledçš„è¯´æ˜å¦‚ä¸‹:</p>
<blockquote>
<p>When set to NO, touch, press, keyboard, and focus events intended for the view are ignored and removed from the event queue. When set to YES, events are delivered to the view normally. The default value of this property is YES.</p>
<p>During an animation, user interactions are temporarily disabled for all views involved in the animation, regardless of the value in this property. You can disable this behavior by specifying the UIViewAnimationOptionAllowUserInteraction option when configuring the animation.</p>
</blockquote>
<p>å½“btnä½œä¸ºç¬¬ä¸€å“åº”è€…è¢«è¿”å›æ—¶,å¦‚æœuserInteractionEnabledå±æ€§ä¸ºNO,åˆ™ä¸å®ƒç›¸å…³çš„äº‹ä»¶(è§¦æ‘¸,æŒ‰å‹)éƒ½å°†è¢«å¿½ç•¥.å› æ­¤btnçš„å“åº”æ–¹æ³•ä¸ä¼šè¢«è°ƒç”¨.</p>
<p>Q:ç‚¹å‡»å­è§†å›¾è¶…å‡ºçˆ¶è§†å›¾çš„åŒºåŸŸä»è®©å­è§†å›¾å“åº”äº‹ä»¶?<br>A:å¿…é¡»é‡è½½<strong>çˆ¶è§†å›¾(**</strong>çˆ¶è§†å›¾<strong><strong>çˆ¶è§†å›¾</strong></strong>çˆ¶è§†å›¾**ä¸‰é!!!)çš„pointInsideæ–¹æ³•.è¿™æ˜¯ç”±äºå¦‚æœçˆ¶è§†å›¾çš„pointInsideè¿”å›NOçš„è¯,å…¶ä¸Šçš„å­è§†å›¾å°±ä¸ä¼šè¿›è¡ŒhitTest,å› æ­¤é‡è½½å­è§†å›¾çš„ç›¸å…³æ–¹æ³•å°†æ— æ•ˆ.</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">point</span>(<span class="params">inside</span> <span class="params">point</span>: <span class="type">CGPoint</span>, <span class="params">with</span> <span class="params">event</span>: <span class="type">UIEvent</span>?) -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> rs <span class="operator">=</span> <span class="keyword">super</span>.point(inside: point, with: event)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="operator">!</span>rs &#123;</span><br><span class="line">        <span class="keyword">for</span> subView <span class="keyword">in</span> subviews.reversed() &#123;</span><br><span class="line">            <span class="keyword">let</span> subPoint <span class="operator">=</span> subView.convert(point, from: <span class="keyword">self</span>)</span><br><span class="line">            <span class="keyword">if</span> subView.bounds.contains(subPoint) &#123;</span><br><span class="line">                rs <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> rs</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨é¡¹ç›®ä¸­é‡åˆ°ä¸€ä¸ªåœºæ™¯:collectionViewCellä¸Šçš„æŒ‰é’®è¶…å‡ºäº†cellçš„è¾¹ç•Œ,æƒ³ç‚¹å‡»æŒ‰é’®è¶…å‡ºéƒ¨åˆ†æŒ‰é’®ä¹Ÿèƒ½å¤Ÿå“åº”äº‹ä»¶,æŒ‰ç…§ä¸Šè¿°åŠæ³•é‡å†™äº†collectionViewCellçš„pointInsideæ–¹æ³•,ä½†æ˜¯å´æ²¡æ•ˆæœ.äºæ˜¯åˆé‡å†™äº†cellçš„hitTestæ–¹æ³•,å‘ç°hitTestæ–¹æ³•è¿”å›çš„æ˜¯cellè‡ªèº«,å¹¶æ²¡æœ‰è¿”å›button.è¿™ä¸‹ç³Šæ¶‚äº†,æ˜¯ä¸Šé¢çš„ç†è®ºé”™äº†å—?ä¸Šé¢çš„ç†è®ºæ˜¯æ²¡æœ‰é”™çš„,åˆ†æäº†åŠå¤©å‘ç°æ ¹æœ¬åŸå› æ˜¯cellå¹¶ä¸æ˜¯buttonçš„çˆ¶è§†å›¾,buttonçš„çˆ¶è§†å›¾æ˜¯contentView,è€ŒcontentViewçš„çˆ¶è§†å›¾æ‰æ˜¯cell.è™½ç„¶cellçš„pointInsideè¿”å›äº†YES,ä½†æ˜¯contentViewçš„pointInsideä¾ç„¶è¿”å›çš„æ˜¯NO.æ‰€ä»¥ä¸ä¼šå†hitTest contentViewä¸Šçš„å­è§†å›¾,buttonè‡ªç„¶å°±æ²¡æœ‰ååº”äº†.çœŸç›¸ç»ˆäºæ˜äº†,ä½†é—®é¢˜è¿˜æ²¡è§£å†³,å¦‚ä½•è§£å†³å‘¢?</p>
<p>ç”±äºcontentViewæ˜¯cellçš„å†…éƒ¨å±æ€§æ²¡åŠæ³•è‡ªå®šä¹‰,æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬é‡å†™cellçš„hitTestæ–¹æ³•,åˆ¤æ–­å¦‚æœç‚¹å‡»çš„ç‚¹ä½äºæŒ‰é’®åŒºåŸŸå†…,åˆ™ç›´æ¥å°†æŒ‰é’®è¿”å›.è¿™ä¸‹ç‚¹å‡»è¶…å‡ºåŒºåŸŸæŒ‰é’®ä¹Ÿèƒ½å¤Ÿå“åº”äº‹ä»¶äº†,å®Œç¾.</p>
<p>Q:ç‚¹å‡»subviewå´è®©superviewå“åº”?<br>A:é‡è½½subviewçš„hitTestæ–¹æ³•:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">hitTest</span>(<span class="keyword">_</span> <span class="params">point</span>: <span class="type">CGPoint</span>, <span class="params">with</span> <span class="params">event</span>: <span class="type">UIEvent</span>?) -&gt; <span class="type">UIView</span>? &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">self</span>.superview</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Q:hitTestå’ŒpointInsideçš„å…³ç³»?<br>A:é€šè¿‡çœŸæœºè°ƒè¯•å‘ç°(æ¨¡æ‹Ÿå™¨å¯èƒ½ä¸å‡†),ç³»ç»Ÿä¼šå…ˆè°ƒç”¨çˆ¶è§†å›¾çš„hitTestæ–¹æ³•,hitTestæ–¹æ³•ç»§è€Œä¼šè°ƒç”¨pointInsideæ–¹æ³•,å¦‚æœpointInsideè¿”å›YES,é‚£ä¹ˆç³»ç»Ÿå°†å¯¹å…¶ä¸Šçš„å­è§†å›¾é‡å¤ä¸Šé¢çš„è¿‡ç¨‹è¿›è¡ŒhitTest.</p>
<p>hitTestçš„ä¸€ç§å¯èƒ½å®ç°ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">-(<span class="built_in">UIView</span> *)hitTest:(<span class="built_in">CGPoint</span>)point withEvent:(<span class="built_in">UIEvent</span> *)event&#123;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//1.åˆ¤æ–­è‡ªå·±èƒ½å¦æ¥æ”¶äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">self</span>.userInteractionEnabled == <span class="literal">NO</span> || <span class="keyword">self</span>.hidden == <span class="literal">YES</span> || <span class="keyword">self</span>.alpha &lt;= <span class="number">0.01</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.åˆ¤æ–­å½“å‰ç‚¹åœ¨ä¸åœ¨å½“å‰View.</span></span><br><span class="line">    <span class="keyword">if</span> (![<span class="keyword">self</span> pointInside:point withEvent:event]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3.ä»åå¾€å‰éå†è‡ªå·±çš„å­æ§ä»¶.è®©å­æ§ä»¶é‡å¤å‰ä¸¤æ­¥æ“ä½œ,(æŠŠäº‹ä»¶ä¼ é€’ç»™,è®©å­æ§ä»¶è°ƒç”¨hitTest)</span></span><br><span class="line">    <span class="type">int</span> count = (<span class="type">int</span>)<span class="keyword">self</span>.subviews.count;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = count - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="comment">//å–å‡ºæ¯ä¸€ä¸ªå­æ§ä»¶</span></span><br><span class="line">        <span class="built_in">UIView</span> *chileV =  <span class="keyword">self</span>.subviews[i];</span><br><span class="line">        <span class="comment">//æŠŠå½“å‰çš„ç‚¹è½¬æ¢æˆå­æ§ä»¶åæ ‡ç³»ä¸Šçš„ç‚¹.</span></span><br><span class="line">        <span class="built_in">CGPoint</span> childP = [<span class="keyword">self</span> convertPoint:point toView:chileV];</span><br><span class="line">        <span class="built_in">UIView</span> *fitView = [chileV hitTest:childP withEvent:event];</span><br><span class="line">        <span class="comment">//åˆ¤æ–­æœ‰æ²¡æœ‰æ‰¾åˆ°æœ€é€‚åˆçš„View</span></span><br><span class="line">        <span class="keyword">if</span>(fitView)&#123;</span><br><span class="line">            <span class="keyword">return</span> fitView;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//4.æ²¡æœ‰æ‰¾åˆ°æ¯”å®ƒè‡ªå·±æ›´é€‚åˆçš„View.é‚£ä¹ˆå®ƒè‡ªå·±å°±æ˜¯æœ€é€‚åˆçš„View</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>UIKit</category>
      </categories>
      <tags>
        <tag>UIResponder</tag>
        <tag>å“åº”è€…é“¾</tag>
      </tags>
  </entry>
  <entry>
    <title>runtime +loadä¸+initializeåˆ†æ</title>
    <url>/2018/02/26/runtime%20+load%E4%B8%8E+initialize%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<p>é€šè¿‡ä¸€ä¸ªç®€å•çš„æ‰“å°å®éªŒå°±å¯ä»¥å‘ç°:</p>
<ul>
<li>+initializeæ–¹æ³•å’Œ+loadè°ƒç”¨æ—¶æœº</li>
<li>+initializeåœ¨çˆ¶ç±»,å­ç±»,ç±»åˆ«ä¹‹é—´çš„å…³ç³»</li>
<li>+loadåœ¨çˆ¶ç±»,å­ç±»,ç±»åˆ«ä¹‹é—´çš„å…³ç³»</li>
</ul>
<p>å¦‚ä¸‹è¡¨æ ¼:</p>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th>+load</th>
<th>+initialize</th>
</tr>
</thead>
<tbody>
<tr>
<td>è°ƒç”¨æ—¶æœº</td>
<td>è¢«æ·»åŠ åˆ° runtime æ—¶(ç±»è¢«åŠ è½½æ—¶)</td>
<td>ç¬¬ä¸€æ¬¡è°ƒç”¨è¯¥ç±»çš„ç±»æ–¹æ³•æˆ–å®ä¾‹æ–¹æ³•å‰è°ƒç”¨,å¯èƒ½æ°¸è¿œä¸è°ƒç”¨</td>
</tr>
<tr>
<td>è°ƒç”¨é¡ºåº</td>
<td>çˆ¶ç±»-&gt;å­ç±»-&gt;åˆ†ç±»(å¤šä¸ªåˆ†ç±»é—´,åˆ™æŒ‰åŠ è½½é¡ºåº)</td>
<td>çˆ¶ç±»-&gt;åˆ†ç±»(å¤šä¸ªåˆ†ç±»æ—¶,æ˜¯æœ€åä¸€ä¸ªçš„è¢«æ‰§è¡Œ)orå­ç±»</td>
</tr>
<tr>
<td>æ˜¯å¦éœ€è¦æ˜¾å¼è°ƒç”¨çˆ¶ç±»å®ç°</td>
<td>å¦</td>
<td>å¦</td>
</tr>
<tr>
<td>è‡ªèº«æ²¡å®ç°æ˜¯å¦è°ƒç”¨çˆ¶ç±»çš„å®ç°</td>
<td>å¦</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>åˆ†ç±»ä¸­å®ç°äº§ç”Ÿçš„å½±å“</td>
<td>ç±»å’Œåˆ†ç±»éƒ½æ‰§è¡Œ</td>
<td>è¦†ç›–ç±»ä¸­çš„æ–¹æ³•ï¼Œåªæ‰§è¡Œåˆ†ç±»çš„å®ç°</td>
</tr>
</tbody>
</table>
</div>
<p>å¦:Swizzling should always be done in +load.</p>
<h2 id="initialize"><a href="#initialize" class="headerlink" title="initialize"></a>initialize</h2><p>æ–‡æ¡£è¯´æ˜ï¼š</p>
<figure class="highlight delphi"><table><tr><td class="code"><pre><span class="line">The runtime sends initialize <span class="keyword">to</span> each <span class="keyword">class</span> <span class="keyword">in</span> a <span class="keyword">program</span> just before the <span class="keyword">class</span>, <span class="keyword">or</span> any <span class="keyword">class</span> that inherits from it, <span class="keyword">is</span> sent its first <span class="keyword">message</span> from within the <span class="keyword">program</span>. Superclasses receive this <span class="keyword">message</span> before their subclasses.</span><br><span class="line"></span><br><span class="line">The runtime sends the initialize <span class="keyword">message</span> <span class="keyword">to</span> classes <span class="keyword">in</span> a thread-safe manner. That <span class="keyword">is</span>, initialize <span class="keyword">is</span> run by the first thread <span class="keyword">to</span> send a <span class="keyword">message</span> <span class="keyword">to</span> a <span class="keyword">class</span>, <span class="keyword">and</span> any other thread that tries <span class="keyword">to</span> send a <span class="keyword">message</span> <span class="keyword">to</span> that <span class="keyword">class</span> will block <span class="keyword">until</span> initialize completes.</span><br><span class="line"></span><br><span class="line">The superclass <span class="keyword">implementation</span> may be called multiple times <span class="keyword">if</span> subclasses <span class="keyword">do</span> <span class="keyword">not</span> implement initializeâ€”the runtime will call the <span class="keyword">inherited</span> <span class="keyword">implementation</span>â€”<span class="keyword">or</span> <span class="keyword">if</span> subclasses explicitly call [super initialize]. <span class="keyword">If</span> you want <span class="keyword">to</span> protect yourself from being run multiple times, you can structure your <span class="keyword">implementation</span> along these lines:</span><br><span class="line">+ (void)initialize <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">  if (self == [ClassName self]) &#123;</span></span><br><span class="line"><span class="comment">    // ... do the initialization ...</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Because initialize <span class="keyword">is</span> called <span class="keyword">in</span> a blocking manner, itâ€™s important <span class="keyword">to</span> limit method implementations <span class="keyword">to</span> the minimum amount <span class="keyword">of</span> work necessary possible. Specifically, any code that takes locks that might be required by other classes <span class="keyword">in</span> their initialize methods <span class="keyword">is</span> liable <span class="keyword">to</span> lead <span class="keyword">to</span> deadlocks. Therefore, you should <span class="keyword">not</span> rely <span class="keyword">on</span> initialize <span class="keyword">for</span> complex <span class="keyword">initialization</span>, <span class="keyword">and</span> should instead limit it <span class="keyword">to</span> straightforward, <span class="keyword">class</span> <span class="keyword">local</span> <span class="keyword">initialization</span>.</span><br><span class="line"></span><br><span class="line">Special Considerations</span><br><span class="line">initialize <span class="keyword">is</span> invoked only once per <span class="keyword">class</span>. <span class="keyword">If</span> you want <span class="keyword">to</span> perform independent <span class="keyword">initialization</span> <span class="keyword">for</span> the <span class="keyword">class</span> <span class="keyword">and</span> <span class="keyword">for</span> categories <span class="keyword">of</span> the <span class="keyword">class</span>, you should implement load methods.</span><br></pre></td></tr></table></figure>
<p>æœ‰å‡ ä¸ªç‚¹å€¼å¾—è¯´ä¸€ä¸‹ï¼š</p>
<p>1ã€initializeæ–¹æ³•æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å½“ç¬¬ä¸€ä¸ªçº¿ç¨‹è§¦å‘initializeæ‰§è¡Œåï¼Œå…¶ä»–çº¿ç¨‹å‘é€çš„æ¶ˆæ¯éƒ½ä¼šè¢«é˜»å¡ç›´åˆ°initializeæ‰§è¡Œå®Œæˆã€‚</p>
<p>2ã€çˆ¶ç±»çš„å®ç°å¯èƒ½ä¼šè¢«æ‰§è¡Œå¤šæ¬¡ã€‚æœ‰æ—¶å€™å¹¶ä¸æƒ³initializeé‡Œçš„ä»£ç æ‰§è¡Œå¤šæ¬¡ï¼Œå»ºè®®ä½¿ç”¨dispatch_onceä¿æŠ¤èµ·æ¥ã€‚</p>
<p>3ã€initializeæ–¹æ³•æ˜¯ä»¥åŒæ­¥çš„æ–¹å¼æ‰§è¡Œçš„ï¼Œæ‰€ä»¥é‡Œé¢çš„å®ç°æœ€å¥½å°½å¯èƒ½çš„ç®€å•ã€‚å°¤å…¶æ˜¯æ¶‰åŠåˆ°é”çš„é€»è¾‘å°±éœ€è¦ç‰¹åˆ«å°å¿ƒï¼Œå¤„ç†ä¸å¥½å¯èƒ½ä¼šå¯¼è‡´æ­»é”ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ:"></a>å‚è€ƒ:</h2><p><a href="https://www.jianshu.com/p/872447c6dc3f">Objective-C æ·±å…¥ç†è§£ +load å’Œ +initialize</a></p>
]]></content>
      <categories>
        <category>runtime</category>
      </categories>
      <tags>
        <tag>+load</tag>
      </tags>
  </entry>
  <entry>
    <title>OC MRCä¹‹æ—…</title>
    <url>/2018/02/25/OC%20MRC%E4%B9%8B%E6%97%85/</url>
    <content><![CDATA[<h2 id="OC-MRCä¹‹æ—…"><a href="#OC-MRCä¹‹æ—…" class="headerlink" title="OC MRCä¹‹æ—…"></a>OC MRCä¹‹æ—…</h2><p>å…ˆæ¥ä¸ªä¾‹å­,è®¡ç®—ä¸€ä¸‹Peopleå¯¹è±¡çš„å¼•ç”¨è®¡æ•°.</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="variable language_">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    People *p = [[People alloc] init]; <span class="comment">//</span></span><br><span class="line">    </span><br><span class="line">    People *p1 = [p <span class="keyword">retain</span>]; <span class="comment">//</span></span><br><span class="line">    </span><br><span class="line">    [p release]; <span class="comment">//</span></span><br><span class="line">    </span><br><span class="line">    [p1 <span class="keyword">retain</span>]; <span class="comment">//</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;p:%ld&quot;</span>, [p retainCount]);</span><br><span class="line">    </span><br><span class="line">    People *p2 = p;</span><br><span class="line">    p2.firstName = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;%dç®—æ³•&quot;</span>, <span class="number">2</span>];</span><br><span class="line">    p2.lastName = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;%dç®—æ³•&quot;</span>, <span class="number">3</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, p2.firstName);</span><br><span class="line">    </span><br><span class="line">    [p2 release]; <span class="comment">//</span></span><br><span class="line">    [p2 release]; <span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç­”æ¡ˆæ˜¯: 1 2 1 2 1 0.</p>
<p>æ³¨æ„:æŒ‡é’ˆåªæ˜¯è®©æˆ‘ä»¬èƒ½å¤Ÿè®¿é—®è¯¥å¯¹è±¡.p,p1,p2æŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡,å› æ­¤ä¸Šé¢çš„retain,releaseæ“ä½œçš„ä¹Ÿæ˜¯åŒä¸€ä¸ªå¯¹è±¡.</p>
<p>å†æ¥çœ‹ä¸€ä¸‹Peopleç±»:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">People</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">People</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">retain</span>) <span class="built_in">NSString</span> *firstName;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">retain</span>) <span class="built_in">NSString</span> *lastName;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)dealloc</span><br><span class="line">&#123;</span><br><span class="line">    [_firstName release];</span><br><span class="line"><span class="comment">//    [_lastName release];</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;_firstName:%ld&quot;</span>, [_firstName retainCount]); <span class="comment">//1</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;_lastName:%ld&quot;</span>, [_lastName retainCount]); <span class="comment">//2</span></span><br><span class="line">    </span><br><span class="line">    [<span class="variable language_">super</span> dealloc];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)setFirstName:(<span class="built_in">NSString</span> *)firstName</span><br><span class="line">&#123;</span><br><span class="line">    [firstName <span class="keyword">retain</span>];</span><br><span class="line">    [_firstName release];</span><br><span class="line">    _firstName = firstName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å¦‚æœå°†ä¸Šé¢çš„<code>[_lastName release];</code>æ³¨é‡Šæ‰é‚£ä¹ˆå°†ä¼šå¯¼è‡´å†…å­˜æ³„æ¼.ä¸ºä»€ä¹ˆä¼šå¯¼è‡´è¿™ç§æƒ…å†µå‘¢?è™½ç„¶<code>p2.lastName = [NSString stringWithFormat:@&quot;%dç®—æ³•&quot;, 3];</code>æ˜¯ä¸€ä¸ªæ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± çš„å¯¹è±¡,ä½†æ˜¯ç”±äºlastNameå±æ€§æ˜¯retain,å› æ­¤èµ‹å€¼æ—¶è¯¥å­—ç¬¦ä¸²å¯¹è±¡å¼•ç”¨è®¡æ•°ä¼šè¢«åŠ 1,å› æ­¤éœ€è¦åœ¨Peopleå¯¹è±¡é”€æ¯æ—¶,é‡Šæ”¾lastNameå­—ç¬¦ä¸²å¯¹è±¡.<br><strong>åœ¨MRCç¯å¢ƒä¸‹,å¯¹è±¡é”€æ¯æ—¶ä¸€èˆ¬éœ€è¦å¯¹è‡ªèº«çš„å±æ€§è¿›è¡Œé‡Šæ”¾.</strong></p>
<p>ç»§ç»­æŸ¥çœ‹åœ¨Peopleå¯¹è±¡é”€æ¯æ—¶,<code>_firstName</code>å’Œ<code>_lastName</code>çš„å¼•ç”¨è®¡æ•°æƒ…å†µ,æ‰“å°æ˜¾ç¤º<code>_firstName</code>çš„ä¸º1,<code>_lastName</code>çš„ä¸º2.<br>ä¸ºå•¥åœ¨Peopleçš„-deallocæ–¹æ³•ä¸­<code>_firstName</code>çš„å¼•ç”¨è®¡æ•°ä¸ä¸º0å´æ˜¯1å‘¢?<br>è¿™æ˜¯å› ä¸ºè‡ªåŠ¨é‡Šæ”¾æ± è¿˜æ²¡æœ‰è¢«é‡Šæ”¾,æ‰€ä»¥å®ƒé‡Œé¢æ³¨å†Œçš„å¯¹è±¡ä¹Ÿè¿˜æ²¡æœ‰è¢«é‡Šæ”¾æ•…<code>_firstName</code>ä¸º1.è€Œ<code>_lastName</code>çš„åˆ™ä¸º2.</p>
<p>æ³¨æ„:ä¸€ä¸ªå¯¹è±¡èƒ½å¤Ÿè¢«æ”¾åˆ°åŒä¸€ä¸ªæ± å­ä¸­è®¸å¤šæ¬¡ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æ¯æ”¾ä¸€æ¬¡éƒ½ä¼šæ”¶åˆ°ä¸€ä¸ª release æ¶ˆæ¯ã€‚</p>
<p>å¦‚æœä½ è§‰å¾—åˆ°è¿™é‡Œå°±ç»“æŸäº†,é‚£å°±too young.æœ‰ä¸€ä¸ªé—®é¢˜ä¼¼ä¹è¿˜ä¸æ˜¯å¾ˆæ˜æœ—,é‚£å°±æ˜¯è‡ªåŠ¨é‡Šæ”¾æ± é‡Œçš„å¯¹è±¡ä»€ä¹ˆæ—¶å€™é‡Šæ”¾?å®˜æ–¹æ–‡æ¡£å‘Šè¯‰æˆ‘ä»¬åœ¨@autorelease{â€¦}å—çš„ç»“å°¾å¤„,è‡ªåŠ¨é‡Šæ”¾æ± ä¼šè¢«drain,é‡Œé¢çš„å¯¹è±¡å°†è¢«é‡Šæ”¾.ä½†æ˜¯çºµè§‚ä¸Šè¿°ä»£ç å¹¶æ²¡æœ‰çœ‹åˆ°ä¸€ä¸ªautoreleaseå—.ä¹‹æ‰€ä»¥æ²¡æœ‰çœ‹åˆ°æ˜¯ç”±äºæˆ‘ä»¬å¤„äºä¸»çº¿ç¨‹ä¸­,è€Œä¸»çº¿ç¨‹çš„runloopé»˜è®¤æ˜¯å¼€å¯çš„,ä½ å¯èƒ½ä¼šå¥‡æ€ªæ€ä¹ˆä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± è¿˜æ‰¯åˆ°çº¿ç¨‹å’Œrunloopä¸Šå»äº†.äº‹å®ä¸Š,è‡ªåŠ¨é‡Šæ”¾æ± ,çº¿ç¨‹,runloopæœ‰ç€å¯†åˆ‡çš„è”ç³».</p>
<p>é‚£ä¹ˆ<strong>ä¸»çº¿ç¨‹ä¸­çš„è‡ªåŠ¨é‡Šæ”¾æ± åˆæ˜¯ä»€ä¹ˆæ—¶å€™åˆ›å»ºï¼Œä»€ä¹ˆæ—¶å€™é”€æ¯å‘¢?</strong><br>å®˜æ–¹æ–‡æ¡£åˆå‘Šè¯‰æˆ‘ä»¬:Application Kitä¼šåœ¨äº‹ä»¶å¾ªç¯çš„æ¯ä¸ªå¾ªç¯å¼€å§‹æ—¶åœ¨ä¸»çº¿ç¨‹ä¸Šåˆ›å»ºä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå¹¶åœ¨å¾ªç¯ç»“æŸæ—¶drainså®ƒï¼Œä»è€Œé‡Šæ”¾å¤„ç†äº‹ä»¶æ—¶ç”Ÿæˆçš„ä»»ä½•è‡ªåŠ¨é‡Šæ”¾å¯¹è±¡ã€‚ å¦‚æœæ‚¨ä½¿ç”¨Application Kitï¼Œåˆ™é€šå¸¸ä¸éœ€è¦åˆ›å»ºè‡ªå·±çš„æ± ã€‚ ä½†æ˜¯ï¼Œå¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºåœ¨äº‹ä»¶å¾ªç¯ä¸­åˆ›å»ºäº†å¤§é‡ä¸´æ—¶è‡ªåŠ¨é‡Šæ”¾å¯¹è±¡ï¼Œé‚£ä¹ˆåˆ›å»ºâ€œæœ¬åœ°â€è‡ªåŠ¨é‡Šæ”¾æ± ä»¥å¸®åŠ©æœ€å¤§é™åº¦åœ°å‡å°‘å³°å€¼å†…å­˜å ç”¨å¯èƒ½ä¼šæœ‰æ‰€å¸®åŠ©ã€‚<br>å®˜æ–¹æ–‡æ¡£æ€»æ˜¯è¿™ä¹ˆç®€æ´,è®©äººç¢ç£¨åŠå¤©.è®©ä¿ºæ¥è§£é‡Šä¸€ä¸‹:ä¸»çº¿ç¨‹çš„runloopé»˜è®¤æ˜¯å¼€å¯çš„,runloopè™½ç„¶ä¹Ÿæ˜¯ä¸€ä¸ªå¾ªç¯ä½†æ˜¯ä»–å’Œæ™®é€šå¾ªç¯æœ‰ç€å¾ˆå¤§çš„åŒºåˆ«,runloopä¼šè®©çº¿ç¨‹åœ¨æœ‰äº‹å¹²çš„æ—¶å€™å¹²äº‹,æ²¡äº‹å¹²çš„æ—¶å€™ä½¿çº¿ç¨‹ä¼‘çœ .runloopåˆæ˜¯å¦‚ä½•çŸ¥é“æœ‰äº‹æƒ…å¹²äº†å‘¢?è¿™å°±æ˜¯æˆ‘ä»¬äº‹å…ˆä¸ºrunloopæ·»åŠ çš„å„ç§æº.æœ‰ç‚¹æ‰¯è¿œäº†,å†æ‰¯ä¸‹å»ä¼°è®¡è¦è·‘é¢˜äº†.æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æš‚æ—¶ä¸ç®¡runloopæ˜¯å¦‚ä½•å¾—çŸ¥çš„,åæ­£runloopå°±æ˜¯çŸ¥é“äº†.å½“ç¨‹åºå¯åŠ¨,ç”¨æˆ·ç‚¹å‡»å±å¹•ç­‰runloopéƒ½ä¼šå»å¤„ç†è¿™äº›äº‹ä»¶.å¤„ç†ä¹‹å‰ä¸»çº¿ç¨‹çš„runloopå°±ä¼šå…ˆåˆ›å»ºä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ,ç­‰åˆ°å¤„ç†å®Œæˆæ—¶å°±å°†è‡ªåŠ¨é‡Šæ”¾æ± drain,é‡Œé¢çš„å¯¹è±¡å°±ä¼šè¢«é‡Šæ”¾,äº‹ä»¶å¤„ç†å®Œæ¯•runloopå°±é€€å‡ºäº†,ä¸ç”¨æ‹…å¿ƒç³»ç»Ÿä¼šå†æ¬¡é©±åŠ¨è¿›å…¥runloop.å› æ­¤å¦‚æœåœ¨äº‹ä»¶å¾ªç¯ä¸­åˆ›å»ºäº†å¤§é‡ä¸´æ—¶è‡ªåŠ¨é‡Šæ”¾å¯¹è±¡,åˆ™å¿…é¡»è‡ªå·±æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± .å¦åˆ™æƒ³ç­‰åˆ°äº‹ä»¶å¤„ç†å®Œæ¯•è®©ç³»ç»Ÿæ¥drain,å†…å­˜å¯èƒ½æ—©å°±è€—å°½äº†,ä½ çš„APPä¹Ÿå°±æ­‡èœäº†.å¥½åœ¨è‡ªå·±åˆ›å»ºå¹¶ä¸éº»çƒ¦,<code>@autorelease&#123;...&#125;</code>å³å¯.</p>
<p>ä»Šå¤©çš„MRCä¹‹æ—…å°±åˆ°è¿™é‡Œ.</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/MemoryMgmt/Articles/MemoryMgmt.html">Advanced Memory Management Programming Guide</a></p>
<p><a href="https://developer.apple.com/documentation/foundation/nsautoreleasepool?language=occ">NSAutoreleasePool</a></p>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
      <tags>
        <tag>å†…å­˜ç®¡ç†</tag>
      </tags>
  </entry>
  <entry>
    <title>SDWebImageå†…å­˜æš´æ¶¨åˆ†æä¸è§£å†³</title>
    <url>/2018/02/14/2018-2-14-SDWebImage%E5%86%85%E5%AD%98%E6%9A%B4%E6%B6%A8%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E5%86%B3/</url>
    <content><![CDATA[<p>ä½¿ç”¨SDWebImageåŠ è½½å›¾ç‰‡,å½“åˆ—è¡¨æœ‰å¾ˆå¤šé¡µ,å›¾ç‰‡å¾ˆå¤šæ—¶,å¯èƒ½ä¼šå¯¼è‡´å†…å­˜æš´æ¶¨:<br><img src="http://7xqoji.com1.z0.glb.clouddn.com/SDWebImage_%E5%86%85%E5%AD%98%E6%9A%B4%E6%B6%A8.jpg" alt="å†…å­˜æš´æ¶¨"></p>
<p>äº§ç”Ÿå†…å­˜æš´æ¶¨çš„ä»£ç :</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ä»ç£ç›˜è·å–å›¾ç‰‡,å¹¶ç¼“å­˜åˆ°å†…å­˜.</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)imageFromDiskCacheForKey:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="built_in">UIImage</span> *diskImage = [<span class="keyword">self</span> diskImageForKey:key];</span><br><span class="line">    <span class="keyword">if</span> (diskImage &amp;&amp; <span class="keyword">self</span>.config.shouldCacheImagesInMemory) &#123;</span><br><span class="line">        <span class="built_in">NSUInteger</span> cost = SDCacheCostForImage(diskImage);</span><br><span class="line">        [<span class="keyword">self</span>.memCache setObject:diskImage forKey:key cost:cost];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> diskImage;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è§£å‹å›¾ç‰‡</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)diskImageForKey:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="built_in">NSData</span> *data = [<span class="keyword">self</span> diskImageDataBySearchingAllPathsForKey:key];</span><br><span class="line">    <span class="keyword">if</span> (data) &#123;</span><br><span class="line">        <span class="built_in">UIImage</span> *image = [[SDWebImageCodersManager sharedInstance] decodedImageWithData:data];</span><br><span class="line">        image = [<span class="keyword">self</span> scaledImageForKey:key image:image];</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.config.shouldDecompressImages) &#123;</span><br><span class="line">            image = [[SDWebImageCodersManager sharedInstance] decompressedImageWithImage:image data:&amp;data options:@&#123;SDWebImageCoderScaleDownLargeImagesKey: @(<span class="literal">NO</span>)&#125;];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> image;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å…³é—­ç¼“å­˜å›¾ç‰‡åˆ°å†…å­˜çš„åŠŸèƒ½:<br><code>[[SDImageCache sharedImageCache].config setShouldCacheImagesInMemory:NO];</code></p>
<p>æ•ˆæœå¦‚ä¸‹:<br><img src="http://7xqoji.com1.z0.glb.clouddn.com/SDWebImage_%E5%86%85%E5%AD%98%E6%AD%A3%E5%B8%B8.jpg" alt="å†…å­˜æ­£å¸¸"><br>æ­¤æ—¶è™½ç„¶å†…å­˜ä¸å†å¼‚å¸¸,ä½†æ»‘åŠ¨è¿‡ç¨‹ä¸­ä¼šæ˜æ˜¾çœ‹åˆ°å›¾ç‰‡å¡«å……æ—¶çš„é—ªåŠ¨,ç”¨æˆ·ä½“éªŒæƒ³å½“ä¸å¥½.</p>
<p>æ¯”è¾ƒå¥½çš„åŠæ³•:</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">- (void)initSDWebImage</span><br><span class="line">&#123;</span><br><span class="line">    <span class="selector-attr">[[SDImageCache sharedImageCache]</span><span class="selector-class">.config</span> setShouldDecompressImages:NO];</span><br><span class="line">    <span class="selector-attr">[[SDWebImageDownloader sharedDownloader]</span> setShouldDecompressImages:NO];</span><br><span class="line">    <span class="selector-attr">[[SDImageCache sharedImageCache]</span> setMaxMemoryCost:<span class="number">20</span> * <span class="number">1024</span> * <span class="number">1024</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è®¾ç½®ä¸€ä¸ªå†…å­˜ç¼“å­˜æœ€å¤§å€¼,éœ€è¦æ³¨æ„çš„æ˜¯ç³»ç»Ÿå¹¶ä¸ä¼šç²¾ç¡®çš„ä½¿ç”¨è¯¥å€¼è¿›è¡Œé™å®š.è¿™æ ·è®¾ç½®ä¹‹å,å†…å­˜åŸºæœ¬åœ¨70-90Mä¹‹é—´æµ®åŠ¨.ä¸ä¼šå†åƒä¹‹å‰é£™åˆ°3-400Mè¿˜åœä¸ä¸‹æ¥.<br>å¦‚æœè®¾ç½®ä¸º10 <em> 1024 </em> 1024,é‚£ä¹ˆå†…å­˜åŸºæœ¬åœ¨30-50Mä¹‹é—´.å¹¶ä¸”ç”¨æˆ·ä½“éªŒè¿˜è¡Œ.</p>
]]></content>
      <categories>
        <category>ç¬¬ä¸‰æ–¹åº“ä½¿ç”¨</category>
      </categories>
      <tags>
        <tag>SDWebImage</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨reduceæ¨¡æ‹Ÿå®ç°mapå’Œfilter</title>
    <url>/2018/01/26/%E4%BD%BF%E7%94%A8reduce%E6%A8%A1%E6%8B%9F%E5%AE%9E%E7%8E%B0map%E5%92%8Cfilter/</url>
    <content><![CDATA[<h3 id="ä½¿ç”¨reduceæ¨¡æ‹Ÿå®ç°mapå’Œfilter"><a href="#ä½¿ç”¨reduceæ¨¡æ‹Ÿå®ç°mapå’Œfilter" class="headerlink" title="ä½¿ç”¨reduceæ¨¡æ‹Ÿå®ç°mapå’Œfilter"></a>ä½¿ç”¨reduceæ¨¡æ‹Ÿå®ç°mapå’Œfilter</h3><p>é¦–å…ˆçœ‹ä¸€ä¸‹ç³»ç»Ÿçš„mapå’ŒfilteråŠŸèƒ½:</p>
<figure class="highlight livescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> fbArr = [<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">13</span>, <span class="number">21</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> mmp = fbArr.<span class="keyword">map</span> &#123; <span class="function"><span class="params">(item)</span> -&gt;</span> Int <span class="keyword">in</span></span><br><span class="line">    item + item</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(mmp)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">let</span> cmp = fbArr.filter &#123; <span class="function"><span class="params">(item)</span> -&gt;</span> Bool <span class="keyword">in</span></span><br><span class="line">    item &gt; <span class="number">5</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(cmp)</span><br></pre></td></tr></table></figure>
<p>æ‰“å°å¦‚ä¸‹:</p>
<figure class="highlight accesslog"><table><tr><td class="code"><pre><span class="line"><span class="string">[2, 2, 4, 6, 10, 16, 26, 42]</span></span><br><span class="line"><span class="string">[8, 13, 21]</span></span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨reduceæ¨¡æ‹Ÿå®ç°mapå’Œfilter:</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line">extension Array &#123;</span><br><span class="line">	func map2&lt;T&gt;(_ transform: (Element) -&gt; T) -&gt; <span class="selector-attr">[T]</span> &#123;</span><br><span class="line">        <span class="comment">//åˆå§‹å€¼ä¸ºç©ºæ•°ç»„, æ•°ç»„+æ•°ç»„</span></span><br><span class="line">        return <span class="built_in">reduce</span>([], &#123; (result, item) -&gt; <span class="selector-attr">[T]</span> in</span><br><span class="line">            return result + <span class="selector-attr">[transform(item)]</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">//ç®€åŒ–ä¸€ä¸‹</span></span><br><span class="line">        return <span class="built_in">reduce</span>([], &#123;</span><br><span class="line">            $<span class="number">0</span> + [transform($<span class="number">1</span>)]</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">//å†ç®€åŒ–ä¸€ä¸‹</span></span><br><span class="line">        return <span class="built_in">reduce</span>([]) &#123; $<span class="number">0</span> + <span class="selector-attr">[transform($1)]</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    func <span class="built_in">filter2</span>(_ filter: (Element) -&gt; Bool) -&gt; <span class="selector-attr">[Element]</span> &#123;</span><br><span class="line">        return <span class="built_in">reduce</span>([], &#123; (result, item) -&gt; <span class="selector-attr">[Element]</span> in</span><br><span class="line">            return <span class="attribute">filter</span>(item) ? result + <span class="selector-attr">[item]</span> : result</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">//ç®€åŒ–ä¸€ä¸‹</span></span><br><span class="line">        return <span class="built_in">reduce</span>([]) &#123; <span class="attribute">filter</span>($<span class="number">1</span>) ? $<span class="number">0</span> + <span class="selector-attr">[$1]</span> : $<span class="number">0</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯´å®è¯,Swiftå¯¹é—­åŒ…çš„ç®€å†™æœ‰æ—¶å€™æ„Ÿè§‰æœ‰ç‚¹è¿‡äº†,åˆæ¬¡çœ‹åˆ°è¿™æ ·çš„å†™æ³•<code>reduce([]) &#123; filter($1) ? $0 + [$1] : $0 &#125;</code>,æœ‰æ—¶è¿˜å¾—ç¼“ç¼“æ‰çŸ¥é“æ˜¯å•¥æ„æ€.</p>
<p>ä½¿ç”¨:</p>
<figure class="highlight livescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> ammp = fbArr.map2 &#123; <span class="function"><span class="params">(item)</span> -&gt;</span> Int <span class="keyword">in</span></span><br><span class="line">    item + item</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(ammp)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">let</span> bm = fbArr.filter2 &#123; <span class="function"><span class="params">(item)</span> -&gt;</span> Bool <span class="keyword">in</span></span><br><span class="line">    item &gt; <span class="number">10</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(bm)</span><br></pre></td></tr></table></figure>
<p>æ‰“å°å¦‚ä¸‹:</p>
<figure class="highlight accesslog"><table><tr><td class="code"><pre><span class="line"><span class="string">[2, 2, 4, 6, 10, 16, 26, 42]</span></span><br><span class="line"><span class="string">[8, 13, 21]</span></span><br></pre></td></tr></table></figure>
<p>è™½ç„¶ä»…ä½¿ç”¨reduceå°±å¯ä»¥åšåˆ°mapå’Œfilterçš„åŠŸèƒ½,ä½†æ˜¯éšç€æ•°ç»„çš„å¢é•¿,å¤æ‚åº¦ä¼šå¾ˆå¤§.</p>
]]></content>
      <categories>
        <category>Swift</category>
      </categories>
  </entry>
  <entry>
    <title>OC Categoryæµ…æ</title>
    <url>/2018/01/19/Category/</url>
    <content><![CDATA[<p>categoryç”¨ç»“æ„ä½“category_tè¡¨ç¤ºï¼ˆåœ¨objc-runtime-new.hä¸­å¯ä»¥æ‰¾åˆ°æ­¤å®šä¹‰ï¼‰:</p>
<figure class="highlight gauss"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="type">category_t</span> &#123;</span><br><span class="line">    const char *name;</span><br><span class="line">    classref_t <span class="keyword">cls</span>;</span><br><span class="line">    <span class="keyword">struct</span> <span class="type">method_list_t</span> *instanceMethods;</span><br><span class="line">    <span class="keyword">struct</span> <span class="type">method_list_t</span> *classMethods;</span><br><span class="line">    <span class="keyword">struct</span> <span class="type">protocol_list_t</span> *protocols;</span><br><span class="line">    <span class="keyword">struct</span> <span class="type">property_list_t</span> *instanceProperties;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è€Œç±»çš„ç»“æ„ä½“:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">objc_class</span> &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !__OBJC2__</span></span><br><span class="line">    Class _Nullable super_class                              OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> * _Nonnull name                               OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="type">long</span> version                                             OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="type">long</span> info                                                OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="type">long</span> instance_size                                       OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">objc_ivar_list</span> * _Nullable ivars                  OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">objc_method_list</span> * _Nullable * _Nullable methodLists                    OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">objc_cache</span> * _Nonnull cache                       OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">objc_protocol_list</span> * _Nullable protocols          OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125; OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="comment">/* Use `Class` instead of `struct objc_class *` */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">objc_class</span> *Class;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ä»categoryçš„å®šä¹‰ä¹Ÿå¯ä»¥çœ‹å‡ºcategoryçš„å¯ä¸ºï¼ˆå¯ä»¥æ·»åŠ å®ä¾‹æ–¹æ³•ï¼Œç±»æ–¹æ³•ï¼Œç”šè‡³å¯ä»¥å®ç°åè®®ï¼Œæ·»åŠ å±æ€§ï¼‰å’Œä¸å¯ä¸ºï¼ˆæ— æ³•æ·»åŠ å®ä¾‹å˜é‡ï¼‰ã€‚</p>
<p>MyClass.h</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@interface</span> <span class="attribute">MyClass </span>: NSObject</span><br><span class="line"></span><br><span class="line">- (void)printName;</span><br><span class="line"></span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@interface</span> <span class="built_in">MyClass</span>(MyAddition)</span><br><span class="line"></span><br><span class="line"><span class="variable">@property</span>(nonatomic, copy) NSString *name;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">-</span> (void)<span class="selector-tag">printName</span>;</span><br><span class="line"></span><br><span class="line">@<span class="selector-tag">end</span></span><br></pre></td></tr></table></figure>
<p>MyClass.m</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MyClass</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)printName</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, <span class="string">@&quot;MyClass&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MyClass</span>(<span class="title">MyAddition</span>)</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)printName</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, <span class="string">@&quot;MyAddition&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>è½¬æ¢ä¸º.cppæ–‡ä»¶:<code>clang -rewrite-objc MyClass.m</code></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="comment">/*_method_list_t*/</span> &#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> entsize;  <span class="comment">// sizeof(struct _objc_method)</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> method_count;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">_objc_method</span> method_list[<span class="number">1</span>];</span><br><span class="line">&#125; _OBJC_$_CATEGORY_INSTANCE_METHODS_MyClass_$_MyAddition __attribute__ ((used, <span class="built_in">section</span> (<span class="string">&quot;__DATA,__objc_const&quot;</span>))) = &#123;</span><br><span class="line">	<span class="built_in">sizeof</span>(_objc_method),</span><br><span class="line">	<span class="number">1</span>,</span><br><span class="line">	&#123;&#123;(<span class="keyword">struct</span> objc_selector *)<span class="string">&quot;printName&quot;</span>, <span class="string">&quot;v16@0:8&quot;</span>, (<span class="type">void</span> *)_I_MyClass_MyAddition_printName&#125;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="comment">/*_prop_list_t*/</span> &#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> entsize;  <span class="comment">// sizeof(struct _prop_t)</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> count_of_properties;</span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">_prop_t</span> prop_list[<span class="number">1</span>];</span><br><span class="line">&#125; _OBJC_$_PROP_LIST_MyClass_$_MyAddition __attribute__ ((used, <span class="built_in">section</span> (<span class="string">&quot;__DATA,__objc_const&quot;</span>))) = &#123;</span><br><span class="line">	<span class="built_in">sizeof</span>(<span class="type">_prop_t</span>),</span><br><span class="line">	<span class="number">1</span>,</span><br><span class="line">	&#123;&#123;<span class="string">&quot;name&quot;</span>,<span class="string">&quot;T@\&quot;NSString\&quot;,C,N&quot;</span>&#125;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllexport) <span class="keyword">struct</span> <span class="title class_">_class_t</span> OBJC_CLASS_$_MyClass;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">_category_t</span> _OBJC_$_CATEGORY_MyClass_$_MyAddition __attribute__ ((used, <span class="built_in">section</span> (<span class="string">&quot;__DATA,__objc_const&quot;</span>))) = </span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;MyClass&quot;</span>,</span><br><span class="line">	<span class="number">0</span>, <span class="comment">// &amp;OBJC_CLASS_$_MyClass,</span></span><br><span class="line">	(<span class="type">const</span> <span class="keyword">struct</span> <span class="type">_method_list_t</span> *)&amp;_OBJC_$_CATEGORY_INSTANCE_METHODS_MyClass_$_MyAddition,</span><br><span class="line">	<span class="number">0</span>,</span><br><span class="line">	<span class="number">0</span>,</span><br><span class="line">	(<span class="type">const</span> <span class="keyword">struct</span> <span class="type">_prop_list_t</span> *)&amp;_OBJC_$_PROP_LIST_MyClass_$_MyAddition,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> OBJC_CATEGORY_SETUP_$_MyClass_$_MyAddition(<span class="type">void</span> ) &#123;</span><br><span class="line">	_OBJC_$_CATEGORY_MyClass_$_MyAddition.cls = &amp;OBJC_CLASS_$_MyClass;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> section(<span class="string">&quot;.objc_inithooks$B&quot;</span>, long, read, write)</span></span><br><span class="line">__declspec(<span class="built_in">allocate</span>(<span class="string">&quot;.objc_inithooks$B&quot;</span>)) <span class="type">static</span> <span class="type">void</span> *OBJC_CATEGORY_SETUP[] = &#123;</span><br><span class="line">	(<span class="type">void</span> *)&amp;OBJC_CATEGORY_SETUP_$_MyClass_$_MyAddition,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">_class_t</span> *L_OBJC_LABEL_CLASS_$ [<span class="number">1</span>] __attribute__((used, <span class="built_in">section</span> (<span class="string">&quot;__DATA, __objc_classlist,regular,no_dead_strip&quot;</span>)))= &#123;</span><br><span class="line">	&amp;OBJC_CLASS_$_MyClass,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">_category_t</span> *L_OBJC_LABEL_CATEGORY_$ [<span class="number">1</span>] __attribute__((used, <span class="built_in">section</span> (<span class="string">&quot;__DATA, __objc_catlist,regular,no_dead_strip&quot;</span>)))= &#123;</span><br><span class="line">	&amp;_OBJC_$_CATEGORY_MyClass_$_MyAddition,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">IMAGE_INFO</span> &#123; <span class="type">unsigned</span> version; <span class="type">unsigned</span> flag; &#125; _OBJC_IMAGE_INFO = &#123; <span class="number">0</span>, <span class="number">2</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>å¤šä¸ªcategoryçš„æƒ…å†µ:</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> struct _class_t *L_OBJC_LABEL_CLASS_<span class="variable">$</span> <span class="function">[<span class="number">1</span>] __<span class="title">attribute__</span></span>((used, section (<span class="string">&quot;__DATA, __objc_classlist,regular,no_dead_strip&quot;</span>)))= &#123;</span><br><span class="line">	&amp;OBJC_CLASS_<span class="variable">$_MyClass</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> struct _category_t *L_OBJC_LABEL_CATEGORY_<span class="variable">$</span> <span class="function">[<span class="number">2</span>] __<span class="title">attribute__</span></span>((used, section (<span class="string">&quot;__DATA, __objc_catlist,regular,no_dead_strip&quot;</span>)))= &#123;</span><br><span class="line">	&amp;_OBJC_<span class="variable">$_CATEGORY_MyClass_</span><span class="variable">$_MyAddition1</span>,</span><br><span class="line">	&amp;_OBJC_<span class="variable">$_CATEGORY_MyClass_</span><span class="variable">$_MyAddition2</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="categoryçš„åŠ è½½"><a href="#categoryçš„åŠ è½½" class="headerlink" title="categoryçš„åŠ è½½"></a>categoryçš„åŠ è½½</h3><p>å…ˆæ‹¿åˆ°ç±»çš„ç±»åˆ«æ•°ç»„åˆ—è¡¨[cat1, cat2, cat3],è¿™ä¸ªæ•°ç»„å…ƒç´ çš„é¡ºåºæ˜¯æ ¹æ®ç¼–è¯‘é¡ºåºå¾—æ¥.ç„¶åå€’åºæ‹¼è£…å¾—åˆ°ä¸€ä¸ªæ–¹æ³•æ•°ç»„åˆ—è¡¨.æœ€åè¯¥æ–¹æ³•åˆ—è¡¨å†è¿½åŠ ç±»è‡ªèº«çš„æ–¹æ³•.ç±»åˆ«åŠ è½½ç»“æŸ.å› æ­¤å½“æœ‰æ–¹æ³•è¦†ç›–æ—¶,æ‰§è¡Œçš„å°†æ˜¯æœ€åä¸€ä¸ªç¼–è¯‘çš„ç±»åˆ«é‡Œçš„æ–¹æ³•.</p>
<p>åœ¨ç±»å’Œcategoryä¸­éƒ½å¯ä»¥æœ‰+loadæ–¹æ³•ï¼Œé‚£ä¹ˆæœ‰ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>åœ¨ç±»çš„+loadæ–¹æ³•è°ƒç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨categoryä¸­å£°æ˜çš„æ–¹æ³•ä¹ˆï¼Ÿ</li>
<li>è¿™ä¹ˆäº›ä¸ª+loadæ–¹æ³•ï¼Œè°ƒç”¨é¡ºåºæ˜¯å’‹æ ·çš„å‘¢ï¼Ÿ</li>
</ol>
<p>A:å¯ä»¥è°ƒç”¨ï¼Œå› ä¸ºé™„åŠ categoryåˆ°ç±»çš„å·¥ä½œä¼šå…ˆäº+loadæ–¹æ³•çš„æ‰§è¡Œ.</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">objc</span>[<span class="number">20522</span>]: LOAD: category &#x27;MyClass(MyCategory1)&#x27; scheduled for +load</span><br><span class="line"><span class="attribute">objc</span>[<span class="number">20522</span>]: LOAD: category &#x27;MyClass(MyCategory2)&#x27; scheduled for +load</span><br><span class="line"><span class="attribute">objc</span>[<span class="number">20522</span>]: LOAD: +[MyClass(MyCategory1) load]</span><br><span class="line"></span><br><span class="line"><span class="attribute">2018</span>-<span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">01</span>.<span class="number">451</span> categoryDemo[<span class="number">20522</span>:<span class="number">194333</span>] MyCategory1:&lt;MyClass: <span class="number">0</span>x7f9422c01c30&gt;</span><br><span class="line"><span class="attribute">2018</span>-<span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">01</span>.<span class="number">452</span> categoryDemo[<span class="number">20522</span>:<span class="number">194333</span>] &lt;MyClass: <span class="number">0</span>x7f9422c01c30&gt;-MyClass,å°æ˜</span><br><span class="line"><span class="attribute">objc</span>[<span class="number">20522</span>]: LOAD: +[MyClass(MyCategory2) load]</span><br><span class="line"></span><br><span class="line"><span class="attribute">2018</span>-<span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">01</span>.<span class="number">453</span> categoryDemo[<span class="number">20522</span>:<span class="number">194333</span>] MyCategory2:&lt;MyClass: <span class="number">0</span>x7f9422f00100&gt;</span><br><span class="line"><span class="attribute">2018</span>-<span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">01</span>.<span class="number">453</span> categoryDemo[<span class="number">20522</span>:<span class="number">194333</span>] &lt;MyClass: <span class="number">0</span>x7f9422f00100&gt;-MyClass,å°åˆš</span><br></pre></td></tr></table></figure>
<p>+loadçš„æ‰§è¡Œé¡ºåºæ˜¯å…ˆç±»ï¼Œåcategoryï¼Œè€Œcategoryçš„+loadæ‰§è¡Œé¡ºåºæ˜¯æ ¹æ®ç¼–è¯‘é¡ºåºå†³å®šçš„ã€‚</p>
<p>æ€ä¹ˆè°ƒç”¨åˆ°åŸæ¥ç±»ä¸­è¢«categoryè¦†ç›–æ‰çš„æ–¹æ³•ï¼Ÿ<br>categoryå…¶å®å¹¶ä¸æ˜¯å®Œå…¨æ›¿æ¢æ‰åŸæ¥ç±»çš„åŒåæ–¹æ³•ï¼Œåªæ˜¯categoryåœ¨æ–¹æ³•åˆ—è¡¨çš„å‰é¢è€Œå·²ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦é¡ºç€æ–¹æ³•åˆ—è¡¨æ‰¾åˆ°æœ€åä¸€ä¸ªå¯¹åº”åå­—çš„æ–¹æ³•ï¼Œå°±å¯ä»¥è°ƒç”¨åŸæ¥ç±»çš„æ–¹æ³•.</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">Class currentClass = [MyClass <span class="class"><span class="keyword">class</span>]</span>;</span><br><span class="line">    MyClass *<span class="keyword">my</span> = [[MyClass alloc] init];</span><br><span class="line">    my.name = @<span class="string">&quot;æ— è„‘åˆš&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (currentClass) &#123;</span><br><span class="line">        unsigned <span class="keyword">int</span> methodCount;</span><br><span class="line">        Method *methodList = class_copyMethodList(currentClass, &amp;methodCount);</span><br><span class="line">        IMP lastImp = NULL;</span><br><span class="line">        SEL lastSel = NULL;</span><br><span class="line">        <span class="keyword">for</span> (NSInteger i = <span class="number">0</span>; i &lt; methodCount; i++) &#123;</span><br><span class="line">            Method <span class="function"><span class="keyword">method</span> = <span class="title">methodList</span>[<span class="title">i</span>]</span>;</span><br><span class="line">            NSString *methodName = [NSString stringWithCString:sel_getName(method_getName(<span class="function"><span class="keyword">method</span>)) <span class="title">encoding</span>:<span class="title">NSUTF8StringEncoding</span>]</span>;</span><br><span class="line">            NSLog(@<span class="string">&quot;æ–¹æ³•:<span class="variable">%@</span>&quot;</span>, methodName);</span><br><span class="line">            <span class="keyword">if</span> ([@<span class="string">&quot;printName&quot;</span> isEqualToString:methodName]) &#123;</span><br><span class="line">                lastImp = method_getImplementation(<span class="function"><span class="keyword">method</span>)</span>;</span><br><span class="line">                lastSel = method_getName(<span class="function"><span class="keyword">method</span>)</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        typedef void (*fn)(id,SEL);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (lastImp != NULL) &#123;</span><br><span class="line">            fn f = (fn)lastImp;</span><br><span class="line">            f(<span class="keyword">my</span>,lastSel);</span><br><span class="line">        &#125;</span><br><span class="line">        free(methodList);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>æ‰“å°å¦‚ä¸‹:</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">2018</span>-<span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">51</span>:<span class="number">56</span>.<span class="number">436</span> categoryDemo[<span class="number">20716</span>:<span class="number">206487</span>] æ–¹æ³•:printName</span><br><span class="line"><span class="attribute">2018</span>-<span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">51</span>:<span class="number">56</span>.<span class="number">436</span> categoryDemo[<span class="number">20716</span>:<span class="number">206487</span>] æ–¹æ³•:introduceYouselfForCategory2</span><br><span class="line"><span class="attribute">2018</span>-<span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">51</span>:<span class="number">56</span>.<span class="number">437</span> categoryDemo[<span class="number">20716</span>:<span class="number">206487</span>] æ–¹æ³•:printName</span><br><span class="line"><span class="attribute">2018</span>-<span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">51</span>:<span class="number">56</span>.<span class="number">437</span> categoryDemo[<span class="number">20716</span>:<span class="number">206487</span>] æ–¹æ³•:introduceYouselfForCategory1</span><br><span class="line"><span class="attribute">2018</span>-<span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">51</span>:<span class="number">56</span>.<span class="number">437</span> categoryDemo[<span class="number">20716</span>:<span class="number">206487</span>] æ–¹æ³•:printName</span><br><span class="line"><span class="attribute">2018</span>-<span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">51</span>:<span class="number">56</span>.<span class="number">437</span> categoryDemo[<span class="number">20716</span>:<span class="number">206487</span>] æ–¹æ³•:.cxx_destruct</span><br><span class="line"><span class="attribute">2018</span>-<span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">51</span>:<span class="number">56</span>.<span class="number">437</span> categoryDemo[<span class="number">20716</span>:<span class="number">206487</span>] æ–¹æ³•:name</span><br><span class="line"><span class="attribute">2018</span>-<span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">51</span>:<span class="number">56</span>.<span class="number">437</span> categoryDemo[<span class="number">20716</span>:<span class="number">206487</span>] æ–¹æ³•:setName:</span><br><span class="line"><span class="attribute">2018</span>-<span class="number">01</span>-<span class="number">17</span> <span class="number">16</span>:<span class="number">51</span>:<span class="number">56</span>.<span class="number">438</span> categoryDemo[<span class="number">20716</span>:<span class="number">206487</span>] &lt;MyClass: <span class="number">0</span>x7f8a0d618f40&gt;-MyClass,æ— è„‘åˆš</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è°ƒç”¨åˆ°äº†ç±»è‡ªèº«çš„æ–¹æ³•.</p>
<p>åœ¨categoryé‡Œé¢æ˜¯æ— æ³•ä¸ºcategoryæ·»åŠ å®ä¾‹å˜é‡çš„ã€‚ä½†æ˜¯æˆ‘ä»¬å¾ˆå¤šæ—¶å€™éœ€è¦åœ¨categoryä¸­æ·»åŠ å’Œå¯¹è±¡å…³è”çš„å€¼ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥æ±‚åŠ©å…³è”å¯¹è±¡æ¥å®ç°ã€‚</p>
<p>ä½†æ˜¯å…³è”å¯¹è±¡åˆæ˜¯å­˜åœ¨ä»€ä¹ˆåœ°æ–¹å‘¢ï¼Ÿ å¦‚ä½•å­˜å‚¨ï¼Ÿ å¯¹è±¡é”€æ¯æ—¶å€™å¦‚ä½•å¤„ç†å…³è”å¯¹è±¡å‘¢ï¼Ÿ</p>
<p>æ‰€æœ‰çš„å…³è”å¯¹è±¡éƒ½ç”±AssociationsManagerç®¡ç†.<br>AssociationsManageré‡Œé¢æ˜¯ç”±ä¸€ä¸ªé™æ€AssociationsHashMapæ¥å­˜å‚¨æ‰€æœ‰çš„å…³è”å¯¹è±¡çš„ã€‚è¿™ç›¸å½“äºæŠŠæ‰€æœ‰å¯¹è±¡çš„å…³è”å¯¹è±¡éƒ½å­˜åœ¨ä¸€ä¸ªå…¨å±€mapé‡Œé¢ã€‚è€Œmapçš„çš„keyæ˜¯è¿™ä¸ªå¯¹è±¡çš„æŒ‡é’ˆåœ°å€ï¼ˆä»»æ„ä¸¤ä¸ªä¸åŒå¯¹è±¡çš„æŒ‡é’ˆåœ°å€ä¸€å®šæ˜¯ä¸åŒçš„ï¼‰ï¼Œè€Œè¿™ä¸ªmapçš„valueåˆæ˜¯å¦å¤–ä¸€ä¸ªAssociationsHashMapï¼Œé‡Œé¢ä¿å­˜äº†å…³è”å¯¹è±¡çš„kvå¯¹.</p>
<p><code>void _object_set_associative_reference(id object, void *key, id value, uintptr_t policy)</code>éƒ¨åˆ†å®ç°:</p>
<figure class="highlight ceylon"><table><tr><td class="code"><pre><span class="line"><span class="comment">// create the new association (first time).</span></span><br><span class="line">ObjectAssociationMap *refs = <span class="keyword">new</span> ObjectAssociationMap;</span><br><span class="line">associations[disguised<span class="number">_</span><span class="keyword">object</span>] = refs;</span><br><span class="line">(*refs)[key] = ObjcAssociation(policy, <span class="keyword">new</span><span class="number">_</span><span class="keyword">value</span>);</span><br><span class="line">      <span class="number">_</span><span class="keyword">class</span><span class="number">_</span>setInstancesHaveAssociatedObjects(<span class="number">_</span><span class="keyword">object</span><span class="number">_</span>getClass(<span class="keyword">object</span>));</span><br></pre></td></tr></table></figure>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line">void *<span class="title function_ invoke__">objc_destructInstance</span>(id obj) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj) &#123;</span><br><span class="line">        <span class="comment">// Read all of the flags at once for performance.</span></span><br><span class="line">        <span class="type">bool</span> cxx = obj<span class="punctuation">-&gt;</span><span class="title function_ invoke__">hasCxxDtor</span>();</span><br><span class="line">        <span class="type">bool</span> assoc = !UseGC &amp;&amp; obj<span class="punctuation">-&gt;</span><span class="title function_ invoke__">hasAssociatedObjects</span>();</span><br><span class="line">        <span class="type">bool</span> dealloc = !UseGC;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This order is important.</span></span><br><span class="line">        <span class="keyword">if</span> (cxx) <span class="title function_ invoke__">object_cxxDestruct</span>(obj);</span><br><span class="line">        <span class="keyword">if</span> (assoc) _object_remove_assocations(obj);</span><br><span class="line">        <span class="keyword">if</span> (dealloc) obj<span class="punctuation">-&gt;</span><span class="title function_ invoke__">clearDeallocating</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>runtimeçš„é”€æ¯å¯¹è±¡å‡½æ•°<code>objc_destructInstance</code>é‡Œé¢ä¼šåˆ¤æ–­è¿™ä¸ªå¯¹è±¡æœ‰æ²¡æœ‰å…³è”å¯¹è±¡ï¼Œå¦‚æœæœ‰ï¼Œä¼šè°ƒç”¨<code>_object_remove_assocations</code>åšå…³è”å¯¹è±¡çš„æ¸…ç†å·¥ä½œã€‚</p>
<h2 id="å…³äºMethod-IMP-SEL-self-cmd"><a href="#å…³äºMethod-IMP-SEL-self-cmd" class="headerlink" title="å…³äºMethod,IMP,SEL,self,_cmd"></a>å…³äºMethod,IMP,SEL,self,_cmd</h2><h3 id="struct-objc-method"><a href="#struct-objc-method" class="headerlink" title="struct objc_method"></a>struct objc_method</h3><p>åœ¨runtime.hé‡Œæœ‰ç”³æ˜.</p>
<figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line">struct objc_method <span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    SEL _Nonnull method_name                                 OBJC2_UNAVAILABLE;</span></span><br><span class="line"><span class="comment">    char * _Nullable method_types                            OBJC2_UNAVAILABLE;</span></span><br><span class="line"><span class="comment">    IMP _Nonnull method_imp                                  OBJC2_UNAVAILABLE;</span></span><br><span class="line"><span class="comment">&#125;</span> </span><br><span class="line"></span><br><span class="line">typedef struct objc_method *<span class="keyword">Method</span>;</span><br></pre></td></tr></table></figure>
<h3 id="é™„å½•"><a href="#é™„å½•" class="headerlink" title="é™„å½•:"></a>é™„å½•:</h3><p><a href="https://opensource.apple.com/source/objc4/objc4-723/runtime/">è‹¹æœå¼€æºç½‘å€</a></p>
<p><a href="http://blog.sunnyxx.com/2014/03/05/objc_category_secret/">objc categoryçš„ç§˜å¯†</a></p>
<p><a href="https://tech.meituan.com/DiveIntoCategory.html">æ·±å…¥ç†è§£Objective-Cï¼šCategory</a></p>
<p><a href="https://opensource.apple.com/source/objc4/objc4-723/runtime/objc-runtime-new.mm.auto.html">macOS 10.13,objc4/objc4-723ç‰ˆæœ¬</a>å·²ç»æ‰¾ä¸åˆ°attachMethodLists()çš„å®ç°äº†.<br><code>static void 
attachMethodLists(Class cls, method_list_t **addedLists, int addedCount, 
                  bool baseMethods, bool methodsFromBundle, 
                  bool flushCaches)</code><br>å¾—çœ‹æ—§ç‰ˆ:<a href="https://opensource.apple.com/source/objc4/objc4-646/runtime/objc-runtime-new.mm.auto.html">macOS 10.10,objc4/objc4-646ç‰ˆæœ¬</a></p>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
      <tags>
        <tag>Category</tag>
      </tags>
  </entry>
  <entry>
    <title>å“åº”è€…é“¾</title>
    <url>/2017/12/13/%E5%93%8D%E5%BA%94%E8%80%85%E9%93%BE/</url>
    <content><![CDATA[<h4 id="å“åº”è€…å¯¹è±¡"><a href="#å“åº”è€…å¯¹è±¡" class="headerlink" title="å“åº”è€…å¯¹è±¡"></a>å“åº”è€…å¯¹è±¡</h4><p>å“åº”è€…å¯¹è±¡ï¼ˆResponder Objectï¼‰æŒ‡çš„æ˜¯æœ‰å“åº”å’Œå¤„ç†äº‹ä»¶èƒ½åŠ›çš„å¯¹è±¡ã€‚A responder object is any instance of the UIResponder class, and common subclasses include UIView, UIViewController, and UIApplication. UIResponderæ˜¯æ‰€æœ‰å“åº”è€…å¯¹è±¡çš„åŸºç±»ï¼Œåœ¨UIResponderç±»ä¸­å®šä¹‰äº†å¤„ç†ä¸Šè¿°å„ç§äº‹ä»¶çš„æ¥å£ã€‚æˆ‘ä»¬ç†Ÿæ‚‰çš„AppDelegateã€UIApplicationã€ UIViewControllerã€UIWindowå’Œæ‰€æœ‰ç»§æ‰¿è‡ªUIViewçš„UIKitç±»éƒ½ç›´æ¥æˆ–é—´æ¥çš„ç»§æ‰¿è‡ªUIResponderï¼Œæ‰€ä»¥å®ƒä»¬çš„å®ä¾‹éƒ½æ˜¯å¯ä»¥æ„æˆå“åº”è€…é“¾çš„å“åº”è€…å¯¹è±¡ã€‚</p>
<h4 id="å“åº”è€…é“¾"><a href="#å“åº”è€…é“¾" class="headerlink" title="å“åº”è€…é“¾"></a>å“åº”è€…é“¾</h4><p>å“åº”è€…é“¾å°±æ˜¯ç”±ä¸€ç³»åˆ—çš„å“åº”è€…å¯¹è±¡æ„æˆçš„ä¸€ä¸ªå±‚æ¬¡ç»“æ„ã€‚UIResponderå¯¹è±¡èƒ½å¤Ÿæ¥æ”¶è§¦æ‘¸äº‹ä»¶ï¼ˆå…¶å­ç±»å½“ç„¶ä¹Ÿèƒ½å¤Ÿï¼‰ã€‚æ¯ä¸€ä¸ªUIResponderå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªæŒ‡é’ˆnextResponder,ç„¶åè¿™äº›é“¾æ¥åœ¨ä¸€èµ·çš„å¯¹è±¡å°±ç»„æˆäº†å“åº”è€…é“¾ã€‚</p>
<h4 id="ç³»ç»Ÿæ˜¯å¦‚ä½•æ‰¾åˆ°ç¬¬ä¸€å“åº”è€…çš„"><a href="#ç³»ç»Ÿæ˜¯å¦‚ä½•æ‰¾åˆ°ç¬¬ä¸€å“åº”è€…çš„" class="headerlink" title="ç³»ç»Ÿæ˜¯å¦‚ä½•æ‰¾åˆ°ç¬¬ä¸€å“åº”è€…çš„"></a>ç³»ç»Ÿæ˜¯å¦‚ä½•æ‰¾åˆ°ç¬¬ä¸€å“åº”è€…çš„</h4><p>å½“ç”¨æˆ·ç‚¹å‡»äº†æŸä¸ªè§†å›¾.ç³»ç»Ÿæ˜¯å¦‚ä½•æ‰¾åˆ°ç”¨æˆ·ç‚¹å‡»çš„è§†å›¾å‘¢?</p>
<p>ç­”æ¡ˆå°±æ˜¯å¯¹è§†å›¾è¿›è¡ŒhitTest.</p>
<p>å®˜æ–¹æ–‡æ¡£:</p>
<p>UIKit uses view-based hit testing to determine where touch events occur. Specifically, UIKit compares the touch location to the bounds of view objects in the view hierarchy. The hitTest:withEvent: method of UIView walks the view hierarchy, looking for the deepest subview that contains the specified touch. That view becomes the first responder for the touch event.</p>
<p>æ³¨æ„:If a touch location is outside of a viewâ€™s bounds, the hitTest:withEvent: method ignores that view and all of its subviews. As a result, when a viewâ€™s clipsToBounds property is NO, subviews outside of that viewâ€™s bounds are not returned even if they happen to contain the touch.</p>
<p>ç›¸å…³API:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="keyword">func</span> <span class="title function_">hitTest</span>(<span class="keyword">_</span> <span class="params">point</span>: <span class="type">CGPoint</span>, <span class="params">with</span> <span class="params">event</span>: <span class="type">UIEvent</span>?) -&gt; <span class="type">UIView</span>? <span class="comment">// recursively calls -pointInside:withEvent:. point is in the receiver&#x27;s coordinate system</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">open</span> <span class="keyword">func</span> <span class="title function_">point</span>(<span class="params">inside</span> <span class="params">point</span>: <span class="type">CGPoint</span>, <span class="params">with</span> <span class="params">event</span>: <span class="type">UIEvent</span>?) -&gt; <span class="type">Bool</span> <span class="comment">// default returns YES if point is in bounds</span></span><br></pre></td></tr></table></figure>
<p>ä¸¾ä¸ªä¾‹å­:ç•Œé¢å¦‚ä¸‹:</p>
<p>ä¸‹é¢çš„è§†å›¾ä¸ºXQ1View,ä¸Šé¢æœ‰ä¸‰ä¸ªå­è§†å›¾åˆ†åˆ«ä¸ºXQ10View,XQ11View,XQ12Viewã€‚</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/%E6%88%AA%E5%B1%8F2023-03-29%2016.43.47.png" style="zoom:50%;" /></p>
<h5 id="å½“ç”¨æˆ·ç‚¹å‡»äº†XQ11View-ç³»ç»Ÿæ˜¯å¦‚ä½•æ‰¾åˆ°å®ƒçš„"><a href="#å½“ç”¨æˆ·ç‚¹å‡»äº†XQ11View-ç³»ç»Ÿæ˜¯å¦‚ä½•æ‰¾åˆ°å®ƒçš„" class="headerlink" title="å½“ç”¨æˆ·ç‚¹å‡»äº†XQ11View,ç³»ç»Ÿæ˜¯å¦‚ä½•æ‰¾åˆ°å®ƒçš„?"></a>å½“ç”¨æˆ·ç‚¹å‡»äº†XQ11View,ç³»ç»Ÿæ˜¯å¦‚ä½•æ‰¾åˆ°å®ƒçš„?</h5><p>å…·ä½“æ¥è¯´å°±æ˜¯:<br>ç³»ç»Ÿä¼šå¯¹XQ1View(ä¹Ÿå°±æ˜¯XQ11Viewçš„çˆ¶è§†å›¾),å‘é€ä¸€æ¡hitTestæ¶ˆæ¯, hitTestä¼šè°ƒç”¨pointInsideæ–¹æ³•.å¦‚æœXQ1Viewçš„pointInsideæ–¹æ³•è¿”å›falseåˆ™XQ1Viewçš„å­è§†å›¾ä¸ä¼šè¢«hitTest,XQ1Viewçš„hitTestå°†è¿”å›nil,æœ¬æ¬¡hitTestå°±ç»“æŸäº†.è‹¥è¿”å›true,é‚£ä¹ˆç³»ç»Ÿå°†å¯¹XQ1Viewçš„å­è§†å›¾æ•°ç»„è¿›è¡Œä¸€ä¸ªåå‘éå†çš„hitTestæ£€æµ‹.å› æ­¤é¦–å…ˆæ£€æµ‹çš„æ˜¯XQ12View.ç”±äºç”¨æˆ·å®é™…ç‚¹å‡»çš„æ˜¯XQ11View,æ‰€ä»¥XQ12Viewçš„pointInsideä¼šè¿”å›false,XQ12Viewçš„hitTestå°†è¿”å›nil.æ¥ä¸‹æ¥å°†å¯¹XQ11Viewè¿›è¡ŒhitTestæ£€æµ‹,hitTestä¼šè°ƒç”¨pointInsideæ–¹æ³•,è€Œç”¨æˆ·æ°å¥½ç‚¹å‡»çš„æ˜¯XQ11View,å› æ­¤pointInsideæ–¹æ³•è¿”å›true,ç”±äºXQ11Viewæ²¡æœ‰å­è§†å›¾äº†,å› æ­¤XQ11Viewçš„hitTestå°†è¿”å›è‡ªå·±.hitTestæ£€æµ‹ç»“æŸ.äºæ˜¯å°±æ‰¾åˆ°äº†.XQ1Viewçš„hitTestä¹Ÿå°†è¿”å›XQ11View.å¯ä»¥æ¨æ–­å‡ºç³»ç»Ÿæœ€å…ˆæ˜¯å¯¹UIWindowè¿›è¡ŒhitTestæ£€æµ‹çš„.å› æ­¤UIWindowçš„hitTestä¹Ÿå°†è¿”å›XQ11View.äºæ˜¯ç³»ç»Ÿå°±æ‹¿åˆ°äº†ç¬¬ä¸€å“åº”è€…XQ11View.æ‹¿åˆ°ä¹‹åç³»ç»Ÿä¼šå°è¯•è®©XQ11Viewå¤„ç†äº‹ä»¶.æ¥ä¸‹æ¥å°±æ˜¯äº‹ä»¶åœ¨å“åº”è€…é“¾ä¸­ä¼ é€’äº†.</p>
<h5 id="å¦‚æœç‚¹å‡»XQ12Viewè¶…å‡ºå®ƒçˆ¶è§†å›¾çš„é‚£éƒ¨åˆ†-ä¹Ÿè®©å®ƒèƒ½å¤Ÿå“åº”äº‹ä»¶-è¯¥å¦‚ä½•å®ç°å‘¢"><a href="#å¦‚æœç‚¹å‡»XQ12Viewè¶…å‡ºå®ƒçˆ¶è§†å›¾çš„é‚£éƒ¨åˆ†-ä¹Ÿè®©å®ƒèƒ½å¤Ÿå“åº”äº‹ä»¶-è¯¥å¦‚ä½•å®ç°å‘¢" class="headerlink" title="å¦‚æœç‚¹å‡»XQ12Viewè¶…å‡ºå®ƒçˆ¶è§†å›¾çš„é‚£éƒ¨åˆ†,ä¹Ÿè®©å®ƒèƒ½å¤Ÿå“åº”äº‹ä»¶,è¯¥å¦‚ä½•å®ç°å‘¢?"></a>å¦‚æœç‚¹å‡»XQ12Viewè¶…å‡ºå®ƒçˆ¶è§†å›¾çš„é‚£éƒ¨åˆ†,ä¹Ÿè®©å®ƒèƒ½å¤Ÿå“åº”äº‹ä»¶,è¯¥å¦‚ä½•å®ç°å‘¢?</h5><p>é€šè¿‡ä¸Šé¢çš„åˆ†æ,å¯ä»¥çŸ¥é“å¿…é¡»æƒ³åŠæ³•è®©å®ƒçš„çˆ¶è§†å›¾çš„pointInsideè¿”å›true.å¦åˆ™éƒ½ä¸ä¼šå¯¹XQ12Viewè¿›è¡ŒhitTestæ£€æµ‹.å®ç°å¦‚ä¸‹:</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">XQ1View</span>: <span class="title class_ inherited__">XQView</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">point</span>(<span class="params">inside</span> <span class="params">point</span>: <span class="type">CGPoint</span>, <span class="params">with</span> <span class="params">event</span>: <span class="type">UIEvent</span>?) -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> rs <span class="operator">=</span> <span class="keyword">super</span>.point(inside: point, with: event)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="operator">!</span>rs &#123;</span><br><span class="line">            <span class="keyword">for</span> subView <span class="keyword">in</span> subviews.reversed() &#123;</span><br><span class="line">                <span class="keyword">let</span> subPoint <span class="operator">=</span> subView.convert(point, from: <span class="keyword">self</span>)</span><br><span class="line">                <span class="keyword">if</span> subView.bounds.contains(subPoint) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> rs</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ps:å¯¹ä¸€ä¸ªè§†å›¾è¿›è¡ŒhitTestå‰,ç³»ç»Ÿè¿˜ä¼šæœ‰å¾ˆå¤šåˆ¤æ–­æ¯”å¦‚ä¼šå¿½ç•¥éšè—(hidden=YES)çš„è§†å›¾ï¼Œç¦æ­¢ç”¨æˆ·æ“ä½œ (userInteractionEnabled=YES)çš„è§†å›¾ï¼Œä»¥åŠalphaçº§åˆ«å°äº0.01(alpha&lt;0.01)çš„è§†å›¾ã€‚è¿™äº›è§†å›¾éƒ½ä¸ä¼šè¢«hitTestæ£€æµ‹.</p>
<h4 id="äº‹ä»¶æ˜¯å¦‚ä½•åœ¨å“åº”è€…é“¾ä¸­ä¼ é€’çš„"><a href="#äº‹ä»¶æ˜¯å¦‚ä½•åœ¨å“åº”è€…é“¾ä¸­ä¼ é€’çš„" class="headerlink" title="äº‹ä»¶æ˜¯å¦‚ä½•åœ¨å“åº”è€…é“¾ä¸­ä¼ é€’çš„"></a>äº‹ä»¶æ˜¯å¦‚ä½•åœ¨å“åº”è€…é“¾ä¸­ä¼ é€’çš„</h4><p>å®˜æ–¹è§£é‡Š:<br>If the text field does not handle an event, UIKit sends the event to the text fieldâ€™s parent UIView object, followed by the root view of the window. From the root view, the responder chain diverts to the owning view controller before returning to the viewâ€™s window.If the window does not handle the event, UIKit delivers the event to the UIApplication object, and possibly to the app delegate if that object is an instance of UIResponder and not already part of the responder chain.</p>
<p>å½“ç”¨æˆ·ç‚¹å‡»äº†text field,æœŸé—´ä¼šç»å†é‚£äº›è¿‡ç¨‹å‘¢?</p>
<p>é¦–å…ˆç³»ç»Ÿä¼šå»æ‰¾ç¬¬ä¸€å“åº”è€…,æ‰¾çš„è¿‡ç¨‹å°±æ˜¯ä¸Šé¢æ‰€è¿°,è¿™é‡Œå°±æ˜¯text field.æ‰¾åˆ°äº†ç¬¬ä¸€å“åº”è€…,é‚£ä¹ˆäº‹ä»¶å°†ä¼˜å…ˆç”±ç¬¬ä¸€å“åº”è€…å¤„ç†.å¦‚æœtext fieldä¸å¤„ç†,é‚£ä¹ˆUIKitä¼šå°†äº‹ä»¶å‘é€ç»™text fieldçš„çˆ¶è§†å›¾.å¦‚æœå®ƒçš„çˆ¶è§†å›¾ä¹Ÿä¸å¤„ç†åˆ™äº‹ä»¶å°†ä¼šæ²¿ç€å“åº”è€…é“¾ä¸€ç›´å¾€ä¸Šä¼ é€’(å¦‚æœViewæ˜¯ä½œä¸ºviewControllerçš„æ ¹è§†å›¾,é‚£ä¹ˆè¯¥Viewçš„next responderå°†æ˜¯UIViewController),å½“ä¼ é€’ç»™UIWindowå¯¹è±¡æ—¶,å¦‚æœwindowä¹Ÿä¸å¤„ç†,åˆ™äº‹ä»¶å°†ä¼ é€’ç»™UIApplication.UIApplicationå¯èƒ½ä¼šä¼ ç»™app delegate,å‰ææ˜¯app delegateæ˜¯UIResponderå®ä¾‹,éœ€è¦æ³¨æ„çš„æ˜¯app delegateå·²ç»ä¸æ˜¯å“åº”è€…é“¾é‡Œçš„ä¸€éƒ¨åˆ†äº†.</p>
<p>ä¸€èˆ¬æ¥è¯´å·¥ç¨‹çš„app delegateéƒ½æ˜¯UIResponderå®ä¾‹,æ‰€ä»¥å½“AppDelegateä¹Ÿä¸å¤„ç†æ—¶,é‚£ä¹ˆå°±å†ä¹Ÿæ²¡æœ‰æœºä¼šå¤„ç†äº†,äº‹ä»¶å°†è¢«ç³»ç»Ÿä¸¢å¼ƒ.</p>
<p>æœŸé—´åªè¦æœ‰ä¸€ä¸ªå“åº”è€…å¯¹è±¡å¤„ç†äº†è¯¥äº‹ä»¶.ç³»ç»Ÿé»˜è®¤å°†ä¸å†ä¼ é€’ç»™next responder,æœ¬æ¬¡äº‹ä»¶å°±ç®—å¤„ç†æˆåŠŸ.</p>
<h4 id="å˜æ›´å“åº”è€…é“¾"><a href="#å˜æ›´å“åº”è€…é“¾" class="headerlink" title="å˜æ›´å“åº”è€…é“¾"></a>å˜æ›´å“åº”è€…é“¾</h4><p>You can alter the responder chain by overriding the nextResponder property of your responder objects. Many UIKit classes already override this property and return specific objects.</p>
<p>If you override the nextResponder property for any class, the next responder is the object you return.</p>
<p>å‡ ç§ç±»å‹å¯¹è±¡çš„é»˜è®¤nextResponder.</p>
<ol>
<li><p>UIView</p>
<p> If the view is the root view of a view controller, the next responder is the view controller.</p>
<p> If the view is not the root view of a view controller, the next responder is the viewâ€™s superview.</p>
</li>
<li><p>UIViewController</p>
<p> If the view controllerâ€™s view is the root view of a window, the next responder is the window object.</p>
<p> If the view controller was presented by another view controller, the next responder is the presenting view controller.</p>
<p> (xqæ³¨:ä¸¾ä¾‹,UINavigationControllerçš„æ ¹è§†å›¾æ§åˆ¶å™¨vcAç‚¹å‡»æŒ‰é’®,è·³è½¬åˆ°vcB,é‚£ä¹ˆvcBçš„nextResponderæ˜¯UIViewControllerWrapperView-&gt;UINavigationTransitionView-&gt;UILayoutContainerView-&gt;UINavigationController,UINavigationControllerçš„æ ¹è§†å›¾ç±»å‹ç¡®å®æ˜¯UILayoutContainerView,å¿½ç•¥ä¸­é—´ä¸‰ä¸ªç³»ç»Ÿç±»,é‚£ä¹ˆvcBçš„nextResponderå°±æ˜¯UINavigationController.æ³¨æ„ä¸æ˜¯vcA)</p>
</li>
<li><p>UIWindow. The windowâ€™s next responder is the application object.</p>
</li>
<li><p>UIApplication. The app objectâ€™s next responder is the app delegate, but only if the app delegate is an instance of UIResponder and is not a view, view controller, or the app object itself.</p>
</li>
</ol>
<p>å¦‚ä½•æŠŠæ¶ˆæ¯å‘é€ç»™next responderï¼Ÿ</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)touchesBegan:(<span class="built_in">NSSet</span> *)touches withEvent:(<span class="built_in">UIEvent</span> *)event</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">UITouch</span> *touch = [touches anyObject];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (touch.tapCount == <span class="number">2</span>) &#123;</span><br><span class="line">        [[<span class="keyword">self</span> nextResponder] touchesBegan:touches withEvent:event];<span class="comment">//è¿™é‡Œæœ€å¥½å†™[self nextResponder]è€Œä¸æ˜¯å†™super</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ... Go on to handle touches that are not <span class="type">double</span> taps</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>UIKit</category>
      </categories>
      <tags>
        <tag>UIResponder</tag>
      </tags>
  </entry>
  <entry>
    <title>UIScrollViewä»£ç†æ–¹æ³•</title>
    <url>/2017/12/11/UIScrollView%E4%BB%A3%E7%90%86%E6%96%B9%E6%B3%95%E6%B3%A8%E8%A7%A3/</url>
    <content><![CDATA[<p>å°†è¦å¼€å§‹å‘ç”Ÿæ‹–æ‹½.<br><code>- (void)scrollViewWillBeginDragging:(UIScrollView *)scrollView</code></p>
<p>å°†è¦ç»“æŸæ‹–æ‹½,velocity:ç»“æŸæ—¶çš„é€Ÿåº¦;targetContentOffset:æƒ³è¦æ»šåŠ¨åˆ°çš„æŒ‡å®šä½ç½®.(ä½¿ç”¨è¯¥æ–¹æ³•å¯ä»¥è®©UIScrollViewåœåœ¨æˆ‘ä»¬æƒ³è¦çš„åœ°æ–¹)<br><code>- (void)scrollViewWillEndDragging:(UIScrollView *)scrollView withVelocity:(CGPoint)velocity targetContentOffset:(inout CGPoint *)targetContentOffset</code></p>
<p>æ‹–æ‹½ç»“æŸ,decelerate=YES:è¡¨æ˜æ‹–æ‹½ç»“æŸçš„æ—¶å€™,scrollViewè¿˜æœ‰é€Ÿåº¦,å°†ä¼šå‡é€Ÿæ»‘åŠ¨ä¸€æ®µè·ç¦»,æœ€ç»ˆåœæ­¢æ—¶ä¼šå›è°ƒscrollViewDidEndDeceleratingæ–¹æ³•;=NO:è¡¨æ˜æ‹–æ‹½ç»“æŸ,scrollViewä¹Ÿéšå³åœæ­¢,æ­¤æ—¶ä¸ä¼šå†å›è°ƒscrollViewDidEndDeceleratingæ–¹æ³•.<br><code>- (void)scrollViewDidEndDragging:(UIScrollView *)scrollView willDecelerate:(BOOL)decelerate</code></p>
<p>å·²ç»ç»“æŸå‡é€Ÿ.è¡¨æ˜æ»šåŠ¨åœæ­¢.åªæœ‰åœ¨åœæ­¢å‰æœ‰é€Ÿåº¦çš„æ—¶å€™æ‰ä¼šè¢«å›è°ƒ.<br><code>- (void)scrollViewDidEndDecelerating:(UIScrollView *)scrollView</code></p>
<p>å·²ç»æ»šåŠ¨.scrollViewå¤„äºæ»šåŠ¨çŠ¶æ€æ—¶,è¯¥æ–¹æ³•ä¼šè¢«é¢‘ç¹è°ƒç”¨,å› æ­¤è¯¥æ–¹æ³•é‡Œé¢ä¸åº”è¯¥æœ‰å¤ªå¤æ‚çš„å¤„ç†.åŠ¨ç”»scrollToItemAtIndexPath:atScrollPosition:animated:;å¹¶ä¸ä¼šä½¿è¯¥ä»£ç†æ–¹æ³•è°ƒç”¨.<br><code>- (void)scrollViewDidScroll:(UIScrollView *)scrollView</code></p>
<p>called when setContentOffset/scrollRectVisible:animated: finishes. not called if not animating. å› ä¸ºåŠ¨ç”»åŸå› æ»šåŠ¨ç»“æŸ.<br><code>- (void)scrollViewDidEndScrollingAnimation:(UIScrollView *)scrollView</code></p>
]]></content>
      <categories>
        <category>UIKit</category>
      </categories>
      <tags>
        <tag>UIScrollView</tag>
      </tags>
  </entry>
  <entry>
    <title>OC blockåŸºæœ¬æ“ä½œ--Blockçš„å£°æ˜ã€èµ‹å€¼ä¸è°ƒç”¨</title>
    <url>/2017/12/03/OC%20block%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C--Block%E7%9A%84%E5%A3%B0%E6%98%8E%E3%80%81%E8%B5%8B%E5%80%BC%E4%B8%8E%E8%B0%83%E7%94%A8/</url>
    <content><![CDATA[<h3 id="Blockçš„å£°æ˜ã€èµ‹å€¼ä¸è°ƒç”¨"><a href="#Blockçš„å£°æ˜ã€èµ‹å€¼ä¸è°ƒç”¨" class="headerlink" title="Blockçš„å£°æ˜ã€èµ‹å€¼ä¸è°ƒç”¨"></a>Blockçš„å£°æ˜ã€èµ‹å€¼ä¸è°ƒç”¨</h3><h4 id="Blockå˜é‡çš„å£°æ˜"><a href="#Blockå˜é‡çš„å£°æ˜" class="headerlink" title="Blockå˜é‡çš„å£°æ˜"></a>Blockå˜é‡çš„å£°æ˜</h4><p>å’ŒCè¯­è¨€çš„å‡½æ•°æŒ‡é’ˆå£°æ˜å‡ ä¹ä¸€æ ·,åªæ˜¯å°†â€*â€æ”¹ä¸ºâ€^â€.å¦‚ä¸‹:</p>
<p><code>è¿”å›å€¼ç±»å‹</code> <code>(^å˜é‡åç§°)</code> <code>(å˜é‡ç±»å‹ å˜é‡1, å˜é‡ç±»å‹ å˜é‡2, ...)</code></p>
<p>ä¾‹:int (^blkVar)(int a, int b);</p>
<h4 id="Blockè¯­æ³•"><a href="#Blockè¯­æ³•" class="headerlink" title="Blockè¯­æ³•"></a>Blockè¯­æ³•</h4><p>ä¸€ä¸ªBlockè¯­æ³•ä»£è¡¨ä¸€ä¸ªBlockç±»å‹å˜é‡çš„å€¼.å®ƒçš„å†™æ³•å’ŒCè¯­è¨€å‡½æ•°çš„å®šä¹‰å¾ˆåƒ.ä»…æœ‰ä¸¤ç‚¹åŒºåˆ«:</p>
<ul>
<li>æ²¡æœ‰å‡½æ•°å.</li>
<li>åœ¨è¿”å›å€¼å‰é¢åŠ ä¸Šâ€^â€. </li>
</ul>
<p><code>^</code> <code>è¿”å›å€¼</code> <code>(å˜é‡ç±»å‹ å˜é‡1, å˜é‡ç±»å‹ å˜é‡2, ...)</code> <code>&#123;... return xx;&#125;</code>. </p>
<p>ä¾‹:^int (int a, int b){â€¦ return 3;}.</p>
<p>Blockä½œä¸ºå‡½æ•°å‚æ•°åœ¨Cè¯­è¨€é‡Œçš„å†™æ³•å’ŒOCé‡Œçš„å†™æ³•ç•¥æœ‰ä¸åŒ.å¦‚ä¸‹:</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//OCæ–¹æ³•</span></span><br><span class="line">- (<span class="built_in">int</span>)addFunc:(<span class="built_in">int</span>(^)(<span class="built_in">int</span> a, <span class="built_in">int</span> b))blkParam :(<span class="built_in">int</span>)addA :(<span class="built_in">int</span>)addB</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span> c = <span class="number">0</span>;</span><br><span class="line">    c = blkParam(addA, addB);</span><br><span class="line">    printf(<span class="string">&quot;rs:%d\n&quot;</span>, c);</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Cå‡½æ•°</span></span><br><span class="line"><span class="built_in">int</span> addFunc(<span class="built_in">int</span> (^blkParam)(<span class="built_in">int</span> a , <span class="built_in">int</span> b), <span class="built_in">int</span> addA, <span class="built_in">int</span> addB)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span> c = <span class="number">0</span>;</span><br><span class="line">    c = blkParam(addA, addB);</span><br><span class="line">    printf(<span class="string">&quot;rs:%d\n&quot;</span>, c);</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Blockçš„è°ƒç”¨"><a href="#Blockçš„è°ƒç”¨" class="headerlink" title="Blockçš„è°ƒç”¨"></a>Blockçš„è°ƒç”¨</h4><p><code>blkå˜é‡(å‚æ•°1, å‚æ•°2, ...);</code></p>
<p>ä¸€ä¸ªæ¯”è¾ƒå¤æ€ªçš„Blockè°ƒç”¨:ç›´æ¥å¯¹Blockè¯­æ³•è°ƒç”¨.</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> aa = ^<span class="keyword">int</span>(<span class="keyword">int</span> a, <span class="keyword">int</span> b)&#123;</span><br><span class="line">        <span class="keyword">int</span> c = a + b;</span><br><span class="line">        NSLog(@<span class="string">&quot;<span class="variable">%d</span>&quot;</span>,c);</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;(<span class="number">2</span>,<span class="number">4</span>);</span><br><span class="line">NSLog(@<span class="string">&quot;aa=<span class="variable">%d</span>&quot;</span>,aa);</span><br></pre></td></tr></table></figure>
<p>å¾ˆæ—©ä¹‹å‰åˆšæ¥è§¦blockçš„æ—¶å€™,æ€»æ˜¯åœ¨æƒ³Blocké‡Œçš„ä»£ç åˆ°åº•å•¥æ—¶å€™æ‰§è¡Œ.åŸæ¥å°±æ˜¯blockä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨,ä»€ä¹ˆæ—¶å€™å°±è¢«æ‰§è¡Œ.</p>
<p>Blockä¹Ÿç›¸å½“äºä¸€ç§å˜é‡ç±»å‹ã€‚å°±åƒintä¸€æ ·ï¼Œå¯ä»¥ç”¨æ¥å®šä¹‰å¯¹åº”ç±»å‹çš„å˜é‡ã€‚<br>å› æ­¤</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">[p printWithBlcok:^ViewController *(<span class="built_in">int</span> <span class="built_in">num</span>) &#123;</span><br><span class="line">    NSLog(@<span class="string">&quot;num*cc:%i * %i = %i&quot;</span>,<span class="built_in">num</span>,cc,<span class="built_in">num</span> *cc);</span><br><span class="line">    <span class="keyword">return</span> self;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>é‡Œé¢çš„printWithBlcok:åçš„å°±æ˜¯ä¸€ä¸ªBlockè¯­æ³•(ä¹Ÿå°±æ˜¯ä¸€ä¸ªBlockç±»å‹çš„å˜é‡çš„å€¼)ã€‚åœ¨è¿™é‡Œå®ƒä½œä¸ºå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚å› æ­¤å¯¹å¯¹è±¡på‘é€printWithBlcok:æ¶ˆæ¯ï¼Œå°†æ‰§è¡Œè¯¥æ–¹æ³•çš„ä»£ç ï¼Œè¯¥æ–¹æ³•çš„ç¬¬ä¸€è¡Œä»£ç å°±æ˜¯è°ƒç”¨Blockï¼Œå› æ­¤åˆè½¬è€Œå»æ‰§è¡ŒBlockä¸­çš„ä»£ç ï¼Œæ‰§è¡Œå®Œåï¼Œå†å›åˆ°printWithBlcok:æ–¹æ³•ä¸­ï¼Œç„¶åç»§ç»­æ‰§è¡Œä¸‹å»ã€‚</p>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
      <tags>
        <tag>Block</tag>
      </tags>
  </entry>
  <entry>
    <title>OC blockåŸºæœ¬æ“ä½œ--Blocké‡Œçš„strongSelf</title>
    <url>/2017/12/03/OC%20block%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C--Block%E9%87%8C%E7%9A%84strongSelf/</url>
    <content><![CDATA[<h3 id="Blocké‡Œçš„strongSelf"><a href="#Blocké‡Œçš„strongSelf" class="headerlink" title="Blocké‡Œçš„strongSelf"></a>Blocké‡Œçš„strongSelf</h3><p>æœ‰æ—¶æˆ‘ä»¬åœ¨çœ‹æºç æ—¶,ä¼šå‘ç°ä½œè€…ä¼šåœ¨blocké‡Œç¬¬ä¸€è¡Œstrongä¸€ä¸‹weakSelf.ä»¥ä¸‹ä¾¿æ˜¯å¯¹è¿™ç§å†™æ³•çš„ä¸€ä¸ªæ¢ç©¶.</p>
<p>ä¸€èˆ¬åœ¨ä½¿ç”¨blockçš„æ—¶å€™,éƒ½ä¼šåœ¨blockå¤–,å£°æ˜ä¸€ä¸ªweakSelf,æ¥ç¡®ä¿blockä¸å»æŒæœ‰self.ä½†æ˜¯è¿™ä¹Ÿä¼šå¼•å‘ä¸€ä¸ªé—®é¢˜,å°±æ˜¯å¦‚æœåœ¨blockæ‰§è¡Œä¹‹å‰,selfå°±å·²ç»é”€æ¯äº†,é‚£ä¹ˆblocké‡Œçš„[weakSelf method],methodæ–¹æ³•å°±ä¸ä¼šè¢«æ‰§è¡Œ,å¦‚æœæœ‰è¿”å›å€¼çš„è¯,ä¼šè¿”å›nil.å¦‚æœBlocké‡Œæœ‰è¿™æ ·çš„ä»£ç :[arrM addObject:nil],æ˜¯ä¼šå´©æºƒçš„.æ‰€ä»¥,å¦‚ä½•è®©blockåœ¨æ‰§è¡Œæ—¶,selfä¸é”€æ¯?</p>
<p>è§£å†³åŠæ³•å°±æ˜¯:åœ¨blockä»£ç å—é‡Œç¬¬ä¸€è¡Œå°†weakSelfèµ‹å€¼ç»™ä¸€ä¸ªstrongç±»å‹æŒ‡é’ˆå˜é‡,é€šå¸¸æ˜¯<code>__strong typeof(weakSelf) strongSelf = weakSelf;</code>.æœ‰äº†strongSelfè¿™æ ·ä¸€ä¸ªå¼ºå¼•ç”¨æŒ‡é’ˆ,ä»¥åçš„ä»£ç æ‰§è¡Œæ—¶,ä¾¿ä¸ä¼šå‡ºç°self==nilçš„æƒ…å†µ,ä¸”å½“blockæ‰§è¡Œå®Œå,å±€éƒ¨å˜é‡strongSelfæ¸…é™¤,selfå¯¹è±¡è¢«é‡Šæ”¾.ä¸€åˆ‡çœ‹èµ·æ¥ä¼¼ä¹å¾ˆå®Œç¾.ä½†æ˜¯å¦‚æœåœ¨<br>__strong typeof(weakSelf) strongSelf = weakSelf;<br>æ‰§è¡Œä¹‹å‰,selfå°±å·²ç»é”€æ¯,é‚£ä¹ˆstrongSelfå°†ç­‰äºnil.ä¸Šé¢çš„å´©æºƒè¿˜æ˜¯ä¼šå‘ç”Ÿ.æ‰€ä»¥å¿…é¡»åˆ¤æ–­ä¸€ä¸‹strongSelfæ˜¯å¦ä¸ºnil.</p>
<p>ç»¼ä¸Šå®Œæ•´çš„å†™æ³•åº”è¯¥å¦‚ä¸‹:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">__<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br><span class="line"><span class="type">void</span> (^success)(<span class="type">id</span> data, <span class="built_in">NSString</span> *statusInfo) = ^(<span class="built_in">NSArray</span> *data, <span class="built_in">NSString</span> *statusInfo) &#123;</span><br><span class="line">    __<span class="keyword">strong</span> <span class="keyword">typeof</span>(weakSelf) strongSelf = weakSelf;</span><br><span class="line">    <span class="keyword">if</span> (strongSelf == <span class="literal">nil</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;blockå›è°ƒäº†,strongSelf:%@&quot;</span>, strongSelf); </span><br><span class="line">    <span class="built_in">NSString</span> *sd = [strongSelf printSomething]; <span class="comment">//  å¦‚æœæ²¡æœ‰å‰é¢çš„åˆ¤æ–­,è¿™é‡Œæœ‰å¯èƒ½ä¼šå› ä¸ºstrongSelf==nil,è€Œå¯¼è‡´è¿”å›å€¼ä¸ºnil.ä»è€Œåé¢çš„[mA addObject:sd];ä¼šå´©æºƒ.</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSMutableArray</span> *mA = [[<span class="built_in">NSMutableArray</span> alloc] initWithArray:data];</span><br><span class="line">    [mA addObject:<span class="string">@&quot;dsfds&quot;</span>];</span><br><span class="line">    [mA addObject:sd];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, mA);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, statusInfo);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ€è€ƒ1:åœ¨Blocké‡Œå†™<code>__strong typeof(weakSelf) strongSelf = weakSelf;</code>ä¼šä¸ä¼šå¯¼è‡´self-Blockå¼•ç”¨å¾ªç¯?</p>
</blockquote>
<p>ç­”æ¡ˆæ˜¯ä¸ä¼šçš„,å› ä¸ºstrongSelfæ˜¯Blockä»£ç å—é‡Œå®šä¹‰çš„ä¸€ä¸ªå±€éƒ¨å˜é‡,å½“Blockæ‰§è¡Œå®Œå,å±€éƒ¨å˜é‡å°±ä¼šé”€æ¯,è¿™æ ·å°±ä¸ä¼šæœ‰å¼ºå¼•ç”¨çš„æŒ‡é’ˆæŒ‡å‘selfå¯¹è±¡.selfä¸Blockä¹‹é—´ä¹Ÿå°±ä¸ä¼šå½¢æˆä¸€ä¸ªå¼•ç”¨å¾ªç¯.</p>
<blockquote>
<p>æ€è€ƒ2:æ˜¯ä¸æ˜¯Blocké‡Œåªèƒ½ä½¿ç”¨weakSelf,ä¸èƒ½ä½¿ç”¨self?</p>
</blockquote>
<p>è¿™ä¸ªå¹¶ä¸æ˜¯ç»å¯¹çš„,ä½¿ç”¨weakSelfå½“ç„¶æ˜¯ä¸ä¼šæœ‰é—®é¢˜çš„.è€Œå¦‚æœselfä¸æŒæœ‰Block,é‚£ä¹ˆå³ä½¿Blocké‡Œä½¿ç”¨self,ä¹Ÿä¸ä¼šå½¢æˆself-Blockå¼•ç”¨å¾ªç¯,è¿™ç§æƒ…å†µä¸‹åœ¨Blocké‡Œç›´æ¥ä½¿ç”¨selfä¹Ÿæ˜¯æ²¡æœ‰é—®é¢˜çš„,åªä¸è¿‡æ­¤æ—¶selfå¯¹è±¡çš„é”€æ¯å°†ä¾èµ–äºBlockçš„é”€æ¯,æ¢å¥è¯è¯´å°±æ˜¯selfå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå¯èƒ½ä¼šè¢«å»¶é•¿.  </p>
<p>ä¸¾ä¸ªä¾‹å­:<br>vcBé‡Œæœ‰ä¸€ä¸ªå®ä¾‹å˜é‡æŒ‡å‘Cå¯¹è±¡,vcBé‡Œç”¨è¯¥å®ä¾‹å˜é‡è°ƒç”¨Cç±»é‡Œçš„æ–¹æ³•,å‚æ•°blockä»£ç å—é‡Œç›´æ¥ä½¿ç”¨self(å³vcBå¯¹è±¡).</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">SecondViewController</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) Animal *myAni;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">SecondViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="variable language_">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.view.backgroundColor = [<span class="built_in">UIColor</span> whiteColor];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.myAni = [Animal new];</span><br><span class="line">    <span class="type">void</span> (^blk)(Animal *aAnimal) = ^(Animal *aAnimal) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, aAnimal);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;self:%@&quot;</span>, <span class="keyword">self</span>); <span class="comment">//Blockæˆªè·self.</span></span><br><span class="line">    &#125;;</span><br><span class="line">    [<span class="keyword">self</span>.myAni printHello:blk];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Animal</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)printHello:(<span class="type">void</span>(^)(Animal *aAnimal))paramBlk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Animal</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="type">void</span> (^blk)(Animal *aAnimal);</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Animal</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)printHello:(<span class="type">void</span> (^)(Animal *))paramBlk</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//    self.blk = paramBlk;   </span></span><br><span class="line">    paramBlk(<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)dealloc</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@é”€æ¯&quot;</span>, <span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>ä»–ä»¬ä¹‹é—´çš„å…³ç³»å°±å¦‚ä¸‹å›¾æ‰€ç¤º,vcBæŒæœ‰Cå¯¹è±¡,å‚æ•°blockæŒæœ‰vcBå¯¹è±¡,ä»ä¸‹å›¾å¯ä»¥çœ‹å‡ºå¹¶æ²¡æœ‰æ„æˆä¸€ä¸ªå¾ªç¯å¼•ç”¨,æ‰€ä»¥è™½ç„¶åœ¨blocké‡Œç›´æ¥ä½¿ç”¨self,ä½†å´å¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜.</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/1503319-bc529d12b861570e.webp" style="zoom: 50%;" /></p>
<p>ä½†æ˜¯å¦‚æœCç±»é‡Œæœ‰ä¸ªblockå®ä¾‹å˜é‡,æŒ‡å‘äº†è¯¥å‚æ•°block,é‚£ä¹ˆå°†å¯¼è‡´å¾ªç¯å¼•ç”¨.</p>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
      <tags>
        <tag>Block</tag>
      </tags>
  </entry>
  <entry>
    <title>OC blockåŸºæœ¬æ“ä½œ--è§£é™¤å¼•ç”¨å¾ªç¯</title>
    <url>/2017/12/02/OC%20block%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C--%E8%A7%A3%E9%99%A4%E5%BC%95%E7%94%A8%E5%BE%AA%E7%8E%AF/</url>
    <content><![CDATA[<h3 id="blockæˆªè·selfæƒ…å†µ"><a href="#blockæˆªè·selfæƒ…å†µ" class="headerlink" title="blockæˆªè·selfæƒ…å†µ."></a>blockæˆªè·selfæƒ…å†µ.</h3><p>ç•¥.</p>
<h3 id="blockæˆªè·æˆå‘˜å˜é‡æ—¶-é¿å…å¾ªç¯å¼•ç”¨çš„å‡ ç§åŸºæœ¬æ“ä½œ"><a href="#blockæˆªè·æˆå‘˜å˜é‡æ—¶-é¿å…å¾ªç¯å¼•ç”¨çš„å‡ ç§åŸºæœ¬æ“ä½œ" class="headerlink" title="blockæˆªè·æˆå‘˜å˜é‡æ—¶,é¿å…å¾ªç¯å¼•ç”¨çš„å‡ ç§åŸºæœ¬æ“ä½œ."></a>blockæˆªè·æˆå‘˜å˜é‡æ—¶,é¿å…å¾ªç¯å¼•ç”¨çš„å‡ ç§åŸºæœ¬æ“ä½œ.</h3><p>ä¸‹é¢è¿™æ®µä»£ç å¦‚æœä¸åšä»»ä½•å¤„ç†,åœ¨blockå±æ€§é‡Œç›´æ¥ä½¿ç”¨æˆå‘˜å˜é‡,100%å¯¼è‡´å¾ªç¯å¼•ç”¨.</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">åœºæ™¯:</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">void</span>(^MyBlk)(<span class="type">void</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">SecondViewController</span> ()</span></span><br><span class="line">&#123;</span><br><span class="line">    Animal *_myAnimal;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) MyBlk blk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">_myAnimal = [[Animal alloc] init];</span><br><span class="line"><span class="keyword">self</span>.blk = ^&#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, _myAnimal); <span class="comment">//å› ä¸ºå®ä¾‹å˜é‡çš„è®¿é—®ç­‰ä»·äºself-&gt;_myAnimal,ä¹Ÿç­‰ä»·äº(*self)._myAnimal;æ‰€ä»¥è¿™é‡Œä¼šå¯¼è‡´blockå¼ºå¼•ç”¨self.</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆå¦‚ä½•è§£å†³å‘¢?æœ‰å¦‚ä¸‹å‡ ç§æ“ä½œ:</p>
<ol>
<li><p>ä½¿ç”¨__weak typeof(æˆå‘˜å˜é‡) weakæˆå‘˜å˜é‡ = æˆå‘˜å˜é‡;</p>
 <figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">_myAnimal = [[Animal alloc] init];</span><br><span class="line">  __<span class="keyword">weak</span> <span class="keyword">typeof</span>(_myAnimal) weakMyAnimal = _myAnimal;</span><br><span class="line">  <span class="keyword">self</span>.blk = ^&#123;</span><br><span class="line">     <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, weakMyAnimal);</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure></li>
<li><p>ä½¿ç”¨å±€éƒ¨å˜é‡,è¿™æ ·blockå°±ä¸å†æŒæœ‰self.äºæ˜¯å¾ªç¯å¼•ç”¨ä¾¿ä¸èƒ½å½¢æˆäº†.</p>
 <figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">_myAnimal = [[Animal alloc] init];</span><br><span class="line">  Animal *tMyAnimal = _myAnimal;</span><br><span class="line">  <span class="keyword">self</span>.blk = ^&#123;</span><br><span class="line">     <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, tMyAnimal);</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure></li>
<li><p>å¯¹æ–¹æ³•2è¿›è¡Œæ”¹è¿›,å¢åŠ __blockä¿®é¥°ç¬¦.</p>
 <figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">_myAnimal = [[Animal alloc] init];</span><br><span class="line">  __block Animal *tMyAnimal = _myAnimal;</span><br><span class="line">  <span class="keyword">self</span>.blk = ^&#123;</span><br><span class="line">     <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, tMyAnimal);</span><br><span class="line">     tMyAnimal = <span class="literal">nil</span>;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure></li>
<li><p>ä½¿ç”¨__weak typeof(self) weakSelf = self;</p>
 <figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">_myAnimal = [[Animal alloc] init];</span><br><span class="line">  __<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br><span class="line">  <span class="keyword">self</span>.blk = ^&#123;</span><br><span class="line">     __<span class="keyword">strong</span> <span class="keyword">typeof</span>(weakSelf) strongSelf = weakSelf;</span><br><span class="line">     <span class="keyword">if</span> (!strongSelf) <span class="keyword">return</span> ; <span class="comment">//å¿…é¡»åŠ ä¸Šåˆ¤æ–­,å¦åˆ™ä¸€æ—¦selfåœ¨è¿™ä¹‹å‰è¢«é‡Šæ”¾é”€æ¯äº†,é‚£ä¹ˆåé¢çš„-&gt;æ“ä½œå°†å´©æºƒ.</span></span><br><span class="line">     <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, strongSelf -&gt; _myAnimal); <span class="comment">//ä¸€æ—¦blockåœ¨æ‰§è¡Œä¸­,å¯¹è±¡è¢«é”€æ¯äº†,å¾ˆå®¹æ˜“é€ æˆå¯¹NULLæŒ‡é’ˆè¿›è¡Œè§£å¼•ç”¨å¯¼è‡´å´©æºƒ.æ‰€ä»¥å‰é¢çš„åˆ¤æ–­æ˜¯å¿…é¡»çš„.</span></span><br><span class="line">     <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, (*strongSelf)._myAnimal);</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>é‚£ä¹ˆè¿™å‡ ç§åŠæ³•ä¸­å“ªç§æ‰æ˜¯æœ€ä½³å®è·µå‘¢?ä»å†™æ³•ä¸Šæ¥çœ‹,ç¬¬ä¸€ç§å’Œç¬¬äºŒç§ä»¥åŠæ”¹è¿›å‹çš„ç¬¬ä¸‰ç§è¦æ¯”ç¬¬å››ç§æ–¹ä¾¿å¾ˆå¤š.é‚£ä¹ˆç¬¬ä¸€ç§æ–¹æ³•å’Œç¬¬äºŒç§æ–¹æ³•å“ªç§æ›´å¥½å‘¢?è¿™é‡Œå°±éœ€è¦çŸ¥é“ä»€ä¹ˆæ˜¯blockä»¥åŠä¸ºä»€ä¹ˆä½¿ç”¨weakä¿®é¥°ç¬¦åå°±å¯ä»¥è§£é™¤å¾ªç¯å¼•ç”¨.</p>
<blockquote>
<p>ä»€ä¹ˆæ˜¯block</p>
</blockquote>
<p>å¸¦æœ‰è‡ªåŠ¨å˜é‡(å±€éƒ¨å˜é‡)å€¼çš„åŒ¿åå‡½æ•°å°±æ˜¯block.åŒ¿åå‡½æ•°å°±æ˜¯ä¸å¸¦æœ‰åç§°çš„å‡½æ•°.å¸¦æœ‰è‡ªåŠ¨å˜é‡å€¼åœ¨blockä¸­çš„è¡¨ç°å°±æ˜¯â€æˆªè·è‡ªåŠ¨å˜é‡å€¼â€.</p>
<blockquote>
<p>æˆªè·è‡ªåŠ¨å˜é‡å€¼</p>
</blockquote>
<p>â€œæˆªè·è‡ªåŠ¨å˜é‡å€¼â€æŒ‡çš„æ˜¯:åœ¨æ‰§è¡Œblockè¯­æ³•æ—¶,blockè¯­æ³•è¡¨è¾¾å¼æ‰€ä½¿ç”¨çš„è‡ªåŠ¨å˜é‡å€¼ä¼šè¢«ä¿å­˜åˆ°blockçš„ç»“æ„ä½“å®ä¾‹ä¸­(å³blockè‡ªèº«é‡Œ).ä¹Ÿå°±æ˜¯è¯´blockç»“æ„ä½“ä¼šå¤šå‡ºæ¥ä¸€ä¸ªæˆå‘˜å˜é‡,å®ƒçš„ç±»å‹å°±æ˜¯æˆªè·çš„è‡ªåŠ¨å˜é‡çš„ç±»å‹.æ¯”å¦‚è‡ªåŠ¨å˜é‡çš„ç±»å‹æ˜¯weak,é‚£ä¹ˆè¯¥æˆå‘˜å˜é‡çš„ç±»å‹ä¹Ÿæ˜¯weak;å¦‚æœæ˜¯strong,é‚£ä¹ˆæˆå‘˜å˜é‡çš„ç±»å‹ä¹Ÿæ˜¯strong.è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä½¿ç”¨<code>__weak typeof(self) weakSelf = self;</code>å¯ä»¥è®©blockä¸å¼ºå¼•ç”¨selfçš„åŸå› .</p>
<p>ç°åœ¨è®©æˆ‘ä»¬æ¥æ¯”è¾ƒä¸€ä¸‹æ–¹æ³•ä¸€å’Œæ–¹æ³•äºŒ,æ–¹æ³•ä¸€ä½¿ç”¨äº†weakä¿®é¥°ç¬¦,å› æ­¤blockæˆªè·çš„æŒ‡é’ˆå˜é‡<code>weakMyAnimal</code>æ˜¯weakç±»å‹çš„,è€Œweakç±»å‹æŒ‡é’ˆæ˜¯ä¸ä¼šå¼ºå¼•ç”¨æŒ‡å‘çš„å¯¹è±¡,è¿™æ ·blockä¹Ÿå°±ä¸ä¼šå¼ºå¼•ç”¨Animalå¯¹è±¡.è€Œæ–¹æ³•äºŒä¸­å°†å¯¼è‡´blockä¼šå¼ºå¼•ç”¨Animalå¯¹è±¡.è¿™å°±æ„å‘³ç€Animalå¯¹è±¡çš„é‡Šæ”¾è¿˜è¦ä¾èµ–äºblockæœ‰æ²¡æœ‰é‡Šæ”¾,æ›´ç›´ç™½ä¸€ç‚¹å°±æ˜¯Animalå¯¹è±¡æœ¬æ¥å¯ä»¥æ›´æ—©é‡Šæ”¾çš„,ä½†æ˜¯ç”±äºblockè¿˜å¼ºå¼•ç”¨äº†å®ƒ,å¯¼è‡´æ²¡æœ‰è¢«é‡Šæ”¾.</p>
<p>å°é—®é¢˜:å¦‚æœä¸€ä¸ªblockæˆªè·äº†ä¸€ä¸ªstrongç±»å‹çš„æŒ‡é’ˆå˜é‡,é‚£ä¹ˆè¯¥æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ä»€ä¹ˆæ—¶å€™æ‰ä¼šè¢«blocké‡Šæ”¾?æ˜¯blockæ‰§è¡Œå®Œåå°±è¢«é‡Šæ”¾è¿˜æ˜¯è¦ç­‰åˆ°blockè¢«é‡Šæ”¾åå®ƒæ‰ä¼šè¢«é‡Šæ”¾?</p>
<p>ç­”æ¡ˆæ˜¯é€‰B.è¿™æ˜¯å› ä¸ºblockè™½ç„¶æ‰§è¡Œå®Œäº†,ä½†æ˜¯blockæˆªè·çš„æŒ‡é’ˆå˜é‡ä¾ç„¶å­˜æ´»(åŒºåˆ«äºblockä»£ç å—é‡Œå®šä¹‰çš„å±€éƒ¨å˜é‡),å› æ­¤æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ä¾ç„¶è¢«å¼ºå¼•ç”¨.è¦ç›´åˆ°blockè¢«é‡Šæ”¾åè¯¥å¯¹è±¡æ‰ä¼šè¢«é‡Šæ”¾.</p>
<p>æ˜¯æ—¶å€™æ¯”è¾ƒä¸€ä¸‹æ–¹æ³•äºŒå’Œæ–¹æ³•ä¸‰äº†.æ–¹æ³•ä¸‰æ˜¯æ–¹æ³•äºŒçš„æ”¹è¿›å‹.å¯ä»¥çœ‹åˆ°æ–¹æ³•ä¸‰ä¸­,blockæ‰§è¡Œå®Œæˆåå°±å°†æˆªè·çš„æŒ‡é’ˆå˜é‡èµ‹å€¼ä¸ºniläº†,ä»è€ŒæŒ‡å‘çš„å¯¹è±¡ä¼šè¢«ç«‹å³é‡Šæ”¾.è¿™æ˜¯æ–¹æ³•äºŒæ‰€åšä¸åˆ°çš„.æ˜¯ä¸æ˜¯æ–¹æ³•ä¸‰å°±ç­‰ä»·äºæ–¹æ³•ä¸€äº†å‘¢?æ˜¾ç„¶ä¸ç­‰ä»·.è¦æƒ³ç­‰ä»·äºæ–¹æ³•ä¸€,è¦åšçš„äº‹æƒ…åªæœ‰ä¸€ä¸ª:ç¡®ä¿è¯¥blockä¸€å®šè¢«è°ƒç”¨.å¦åˆ™æ–¹æ³•ä¸‰å°†ç­‰ä»·äºæ–¹æ³•äºŒ.</p>
<p>ç»¼ä¸Š,æ–¹æ³•ä¸€æ˜¯æœ€ä½³å®è·µä¸ä¼šå¼•èµ·ä»»ä½•å‰¯ä½œç”¨.æ˜¯ä¸æ˜¯æ–¹æ³•äºŒå°±ä¸èƒ½ç”¨äº†å‘¢?å½“ç„¶ä¸æ˜¯,åªè¦ä½ èƒ½å¤Ÿç¡®ä¿¡ä¸ä¼šå¼•èµ·å…¶ä»–å¼•ç”¨å¾ªç¯(ps:åœ¨æŸç§æƒ…å†µä¸‹æ–¹æ³•äºŒä¼šå¯¼è‡´å¼•ç”¨å¾ªç¯,åŠåœ¨æŸç§æƒ…å†µä¸‹æ–¹æ³•äºŒå³ä½¿æ²¡æœ‰å¼•èµ·å¼•ç”¨å¾ªç¯ä¹Ÿå¯¼è‡´â€æˆªè·çš„å¯¹è±¡â€ä¸èƒ½è¢«é‡Šæ”¾)è‡ªç„¶æ˜¯å¯ä»¥ä½¿ç”¨çš„,æˆ‘å°±ç»å¸¸ä½¿ç”¨,å› ä¸ºå®ƒå†™æ³•æ›´ç®€å•.</p>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
      <tags>
        <tag>Block</tag>
      </tags>
  </entry>
  <entry>
    <title>Swift ArrayåŸºæœ¬æ“ä½œ</title>
    <url>/2017/12/01/Swift%20Array%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/</url>
    <content><![CDATA[<h2 id="Swift-ArrayåŸºæœ¬æ“ä½œ"><a href="#Swift-ArrayåŸºæœ¬æ“ä½œ" class="headerlink" title="Swift ArrayåŸºæœ¬æ“ä½œ"></a>Swift ArrayåŸºæœ¬æ“ä½œ</h2><p>Arrayä½¿ç”¨äº†copy-on-writeæŠ€æœ¯.Arrayæ˜¯ç»“æ„ä½“ç±»å‹,å› æ­¤æ˜¯å€¼ç±»å‹.å’ŒOCé‡Œçš„NSArrayå¼•ç”¨ç±»å‹æ˜¯ä¸åŒçš„.</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å®šä¹‰ä¸€ä¸ªæ•°ç»„</span></span><br><span class="line"><span class="keyword">let</span> arr1: <span class="type">Array</span>&lt;<span class="type">String</span>&gt; <span class="operator">=</span> [<span class="string">&quot;213&quot;</span>, <span class="string">&quot;fdsf&quot;</span>, <span class="string">&quot;sdfdsg&quot;</span>]  <span class="comment">//letå®šä¹‰çš„æ˜¯å¸¸é‡,æ‰€ä»¥arr1ä¸èƒ½å†è¿›è¡Œappendæ“ä½œ.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿½åŠ å…ƒç´ </span></span><br><span class="line"><span class="comment">//è¿½åŠ ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line"><span class="keyword">var</span> arr2: <span class="type">Array</span>&lt;<span class="type">String</span>&gt; <span class="operator">=</span> [<span class="string">&quot;llllfs&quot;</span>, <span class="string">&quot;dqafas&quot;</span>, <span class="string">&quot;21231&quot;</span>]</span><br><span class="line">arr2 <span class="operator">+=</span> [<span class="string">&quot;sfsdfsd&quot;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;arr2:<span class="subst">\(arr2)</span>&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> arr3: <span class="type">Array</span>&lt;<span class="type">String</span>&gt; <span class="operator">=</span> arr2</span><br><span class="line">arr3.append(<span class="string">&quot;hhehehe&quot;</span>)  <span class="comment">//append()ä¼šæ”¹å˜è‡ªèº«çš„å€¼.ä½†arr2çš„å€¼å¹¶ä¸ä¼šæ”¹å˜,å’ŒOCä¸ä¸€æ ·.</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;arr2:<span class="subst">\(arr2)</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;arr3:<span class="subst">\(arr3)</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿½åŠ ä¸€ä¸ªæ•°ç»„çš„å…ƒç´ </span></span><br><span class="line">arr3.append(contentsOf: [<span class="string">&quot;sfsdf&quot;</span>, <span class="string">&quot;dfsfds&quot;</span>, <span class="string">&quot;dgfdg&quot;</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;arr3:<span class="subst">\(arr3)</span>&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> arr4: <span class="type">Array</span>&lt;<span class="type">People</span>&gt; <span class="operator">=</span> [<span class="type">People</span>]()</span><br><span class="line"><span class="keyword">for</span> index: <span class="type">UInt</span> <span class="keyword">in</span> <span class="number">0</span><span class="operator">..&lt;</span><span class="number">4</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> p <span class="operator">=</span> <span class="type">People</span>.<span class="keyword">init</span>(name: <span class="string">&quot;æ¸£æ¸£è¾‰<span class="subst">\(index)</span>&quot;</span>, sex: <span class="literal">true</span>, age: index <span class="operator">*</span> <span class="type">UInt</span>(arc4random()<span class="operator">%</span><span class="number">20</span>))</span><br><span class="line">    arr4.append(p)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;arr4:<span class="subst">\(arr4)</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç§»é™¤å…ƒç´ </span></span><br><span class="line"><span class="keyword">var</span> arr5: <span class="type">Array</span> <span class="operator">=</span> arr4</span><br><span class="line"><span class="comment">//ç§»é™¤æœ€åä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">arr5.removeLast() <span class="comment">//æ”¹å˜è‡ªèº«.è¢«æ“ä½œçš„æ•°ç»„ä¸èƒ½ä¸ºç©º.</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;arr5:<span class="subst">\(arr5)</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç§»é™¤å…ƒç´ ,åŸæ•°ç»„ä¸å—å½±å“,å¾—åˆ°ä¸€ä¸ªç±»å‹ä¸ºArraySliceçš„æ–°æ•°ç»„.</span></span><br><span class="line"><span class="keyword">var</span> arr6: <span class="type">Array</span> <span class="operator">=</span> <span class="type">Array</span>.<span class="keyword">init</span>(arr5.dropLast()) <span class="comment">//ArraySliceè½¬Array</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;arr5:<span class="subst">\(arr5)</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;arr6:<span class="subst">\(arr6)</span>&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> arr7: <span class="type">ArraySlice</span> <span class="operator">=</span> <span class="type">ArraySlice</span>.<span class="keyword">init</span>(arr4)  <span class="comment">//Arrayè½¬ArraySlice</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ç§»é™¤æŸä¸ªèŒƒå›´é‡Œçš„å…ƒç´ </span></span><br><span class="line"><span class="keyword">var</span> arr8: <span class="type">Array</span> <span class="operator">=</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</span><br><span class="line">arr8.removeSubrange(<span class="number">1</span><span class="operator">...</span>) <span class="comment">//ç§»é™¤ä»ç¬¬1ä¸ªä½ç½®å¤„å¼€å§‹ä¸€ç›´åˆ°æœ«å°¾çš„å…ƒç´ </span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;arr8:<span class="subst">\(arr8)</span>&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> arr9: <span class="type">Array</span> <span class="operator">=</span> [<span class="number">1</span>]</span><br><span class="line">arr9.removeSubrange(<span class="number">1</span><span class="operator">...</span>) <span class="comment">//å¦‚æœæ•°ç»„åªæœ‰ä¸€ä¸ªå…ƒç´ ,ä½†ç§»é™¤ä»ç¬¬ä¸€ä¸ªä½ç½®å¤„çš„å…ƒç´ å¹¶ä¸ä¼šè¶Šç•Œå´©æºƒ.ä½†æ˜¯ç§»é™¤ä»ç¬¬äºŒä¸ªä½ç½®å¤„çš„å…ƒç´ å°†ä¼šå¯¼è‡´è¶Šç•Œå´©æºƒ</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;arr9:<span class="subst">\(arr9)</span>&quot;</span>) <span class="comment">//arr9:[1]</span></span><br><span class="line"><span class="keyword">var</span> arr10: <span class="type">Array</span> <span class="operator">=</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</span><br><span class="line">arr10.removeSubrange(<span class="number">1</span><span class="operator">...</span><span class="number">3</span>) <span class="comment">//ç§»é™¤ä»ç¬¬1ä¸ªä½ç½®å¤„å¼€å§‹éšåçš„3ä¸ªå…ƒç´ </span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;arr10:<span class="subst">\(arr10)</span>&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> arr11: <span class="type">Array</span> <span class="operator">=</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</span><br><span class="line">arr11.removeSubrange(<span class="number">1</span><span class="operator">..&lt;</span><span class="number">3</span>) <span class="comment">//ç§»é™¤ä»ç¬¬1ä¸ªä½ç½®å¤„å¼€å§‹éšåçš„2ä¸ªå…ƒç´ </span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;arr11:<span class="subst">\(arr11)</span>&quot;</span>)</span><br><span class="line"><span class="comment">//ä¾¿æ·æ“ä½œ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">mutating</span> <span class="keyword">func</span> <span class="title function_">removeLast</span>(<span class="keyword">_</span> <span class="params">n</span>: <span class="type">Int</span>) <span class="comment">//ç§»é™¤åå‡ ä¸ª</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">mutating</span> <span class="keyword">func</span> <span class="title function_">removeFirst</span>(<span class="keyword">_</span> <span class="params">n</span>: <span class="type">Int</span>) <span class="comment">//ç§»é™¤å‰å‡ ä¸ª</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">mutating</span> <span class="keyword">func</span> <span class="title function_">remove</span>(<span class="params">at</span> <span class="params">index</span>: <span class="type">Int</span>) -&gt; <span class="type">Array</span>.<span class="type">Element</span> <span class="comment">//ç§»é™¤æŒ‡å®šæŸä¸ªä½ç½®çš„å…ƒç´ </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">mutating</span> <span class="keyword">func</span> <span class="title function_">removeAll</span>(<span class="params">keepingCapacity</span> <span class="params">keepCapacity</span>: <span class="type">Bool</span> <span class="operator">=</span> <span class="keyword">default</span>) <span class="comment">//ç§»é™¤æ‰€æœ‰å…ƒç´ </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> tanwanlanyue <span class="operator">=</span> [<span class="string">&quot;æ¸£æ¸£è¾‰&quot;</span>, <span class="string">&quot;çº¯æ‰°æ˜¥&quot;</span>, <span class="string">&quot;å’•å¤©è½&quot;</span>, <span class="string">&quot;æ£®çº¢é›·&quot;</span>]</span><br><span class="line"><span class="comment">//â€œè¿­ä»£é™¤äº†ç¬¬ä¸€ä¸ªå…ƒç´ ä»¥å¤–çš„æ•°ç»„å…¶ä½™éƒ¨åˆ†â€</span></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> tanwanlanyue.dropFirst() &#123;</span><br><span class="line">    <span class="built_in">print</span>(item)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//â€œè¿­ä»£é™¤äº†æœ€å 1 ä¸ªå…ƒç´ ä»¥å¤–çš„æ•°ç»„â€</span></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> tanwanlanyue.dropLast() &#123;</span><br><span class="line">    <span class="built_in">print</span>(item)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//â€œéå†æ•°ç»„ä¸­çš„å…ƒç´ å’Œå¯¹åº”çš„ä¸‹æ ‡â€</span></span><br><span class="line"><span class="keyword">for</span> (index, element) <span class="keyword">in</span> tanwanlanyue.enumerated() &#123;</span><br><span class="line">    <span class="built_in">print</span>(index, element)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//â€œå¯»æ‰¾ä¸€ä¸ªæŒ‡å®šå…ƒç´ çš„ä½ç½®â€</span></span><br><span class="line"><span class="keyword">let</span> idx <span class="operator">=</span> tanwanlanyue.index(of: <span class="string">&quot;å’•å¤©è½&quot;</span>)</span><br><span class="line"><span class="keyword">let</span> i: <span class="type">Int</span> <span class="operator">=</span> idx<span class="operator">!</span> <span class="operator">+</span> <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(i)</span><br><span class="line"><span class="comment">//ä½¿ç”¨Whereé—­åŒ…</span></span><br><span class="line"><span class="keyword">let</span> index <span class="operator">=</span> tanwanlanyue.index &#123;</span><br><span class="line">    <span class="variable">$0</span> <span class="operator">==</span> <span class="string">&quot;çº¯æ‰°æ˜¥&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> j: <span class="type">Int</span> <span class="operator">=</span> index<span class="operator">!</span> <span class="operator">+</span> <span class="number">3</span></span><br><span class="line"><span class="built_in">print</span>(j)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> sidx <span class="operator">=</span> tanwanlanyue.index(where: &#123; (item) -&gt; <span class="type">Bool</span> <span class="keyword">in</span></span><br><span class="line">    item.hasSuffix(<span class="string">&quot;è½&quot;</span>)</span><br><span class="line">&#125;) &#123;</span><br><span class="line">    <span class="built_in">print</span>(sidx)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> didx <span class="operator">=</span> tanwanlanyue.index(where: &#123; (element) -&gt; <span class="type">Bool</span> <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">return</span> element.hasPrefix(<span class="string">&quot;æ¸£æ¸£&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">print</span>(didx)</span><br><span class="line"><span class="comment">//â€œå¯¹æ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ è¿›è¡Œå˜å½¢,å¾—åˆ°ä¸€ä¸ªæ–°æ•°ç»„â€</span></span><br><span class="line"><span class="keyword">let</span> tan2 <span class="operator">=</span> tanwanlanyue.map &#123; (item) -&gt; <span class="type">String</span> <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">let</span> idx <span class="operator">=</span> tanwanlanyue.index(of: item)</span><br><span class="line">    <span class="keyword">return</span> item <span class="operator">+</span> <span class="string">&quot;<span class="subst">\(idx<span class="operator">!</span>)</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(tan2)</span><br><span class="line"><span class="comment">//â€œç­›é€‰å‡ºç¬¦åˆæŸä¸ªæ ‡å‡†çš„å…ƒç´ ,å¾—åˆ°ä¸€ä¸ªæ–°æ•°ç»„â€</span></span><br><span class="line"><span class="keyword">let</span> tan3 <span class="operator">=</span> tan2.filter &#123; (item) -&gt; <span class="type">Bool</span> <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">let</span> ch <span class="operator">=</span> item.last<span class="operator">!</span></span><br><span class="line">    <span class="keyword">return</span> ch <span class="operator">&gt;</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(tan3)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">let</span> names <span class="operator">=</span> [<span class="string">&quot;Paula&quot;</span>, <span class="string">&quot;Elena&quot;</span>, <span class="string">&quot;Zoe&quot;</span>]</span><br><span class="line"><span class="keyword">var</span> lastNameEndingInA: <span class="type">String</span>?</span><br><span class="line"><span class="comment">//(for in) + whereæ¡ä»¶,ä»…éå†ç¬¦åˆæ¡ä»¶çš„å…ƒç´ </span></span><br><span class="line"><span class="keyword">for</span> name <span class="keyword">in</span> names.reversed() <span class="keyword">where</span> name.hasSuffix(<span class="string">&quot;a&quot;</span>) &#123;</span><br><span class="line">    lastNameEndingInA <span class="operator">=</span> name</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(lastNameEndingInA)</span><br><span class="line"><span class="keyword">for</span> name <span class="keyword">in</span> names.reversed() <span class="keyword">where</span> name.hasSuffix(<span class="string">&quot;a&quot;</span>) &#123;</span><br><span class="line">    <span class="built_in">print</span>(name)</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">let</span> last <span class="operator">=</span> names.last &#123; <span class="variable">$0</span>.hasSuffix(<span class="string">&quot;a&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(last)</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ’å…¥</span></span><br><span class="line">ç•¥.</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ›¿æ¢</span></span><br><span class="line">ç•¥.</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç¿»è½¬</span></span><br><span class="line">ç•¥.</span><br><span class="line"></span><br><span class="line"><span class="comment">//éå†</span></span><br><span class="line"><span class="keyword">let</span> names <span class="operator">=</span> [<span class="string">&quot;Paula&quot;</span>, <span class="string">&quot;Elena&quot;</span>, <span class="string">&quot;Zoe&quot;</span>]</span><br><span class="line"><span class="keyword">var</span> lastNameEndingInA: <span class="type">String</span>?</span><br><span class="line"><span class="comment">//(for in) + whereæ¡ä»¶:ä»…éå†ç¬¦åˆæ¡ä»¶çš„å…ƒç´ </span></span><br><span class="line"><span class="keyword">for</span> name <span class="keyword">in</span> names.reversed() <span class="keyword">where</span> name.hasSuffix(<span class="string">&quot;a&quot;</span>) &#123;</span><br><span class="line">    lastNameEndingInA <span class="operator">=</span> name</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(lastNameEndingInA)</span><br><span class="line"><span class="keyword">for</span> name <span class="keyword">in</span> names.reversed() <span class="keyword">where</span> name.hasSuffix(<span class="string">&quot;a&quot;</span>) &#123;</span><br><span class="line">    <span class="built_in">print</span>(name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Swfitæä¾›äº†ä¸‰ç§ç±»å‹çš„æ•°ç»„:</p>
<ul>
<li><p>public struct ContiguousArray<Element> : RandomAccessCollection, MutableCollection</p>
</li>
<li><p>public struct ArraySlice<Element> : RandomAccessCollection, MutableCollection</p>
</li>
<li><p>public struct Array<Element> : RandomAccessCollection, MutableCollection</p>
</li>
</ul>
]]></content>
      <categories>
        <category>Swift</category>
      </categories>
  </entry>
  <entry>
    <title>Swift StringåŸºæœ¬æ“ä½œ</title>
    <url>/2017/11/26/Swift%20String%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/</url>
    <content><![CDATA[<h2 id="Swift-StringåŸºæœ¬æ“ä½œ"><a href="#Swift-StringåŸºæœ¬æ“ä½œ" class="headerlink" title="Swift StringåŸºæœ¬æ“ä½œ"></a>Swift StringåŸºæœ¬æ“ä½œ</h2><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åˆ›å»ºå­—ç¬¦ä¸²  </span></span><br><span class="line">let s1: String = <span class="string">&quot;dsfdsf&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//éå†å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="keyword">for</span> char <span class="keyword">in</span> s1 &#123;</span><br><span class="line">	<span class="built_in">print</span>(char)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å­—ç¬¦ä¸²æ‹¼æ¥</span></span><br><span class="line">let s2 = <span class="string">&quot;dasdfds&quot;</span></span><br><span class="line">let s3 = s1 + s2</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(s3)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¡ç®—å­—ç¬¦ä¸²é•¿åº¦</span></span><br><span class="line">let length: Int = s3<span class="selector-class">.count</span></span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(<span class="string">&quot;é•¿åº¦:\(length)&quot;</span>)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ¤æ–­ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">let rs1 = s3<span class="selector-class">.isEmpty</span></span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(<span class="string">&quot;æ˜¯å¦ä¸ºç©º:\(rs1)&quot;</span>)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å°†ä¸€ä¸ªå­—ç¬¦ä¸²è½¬æ¢ä¸ºå¤§/å°å†™</span></span><br><span class="line">let s4: String = <span class="string">&quot;fsdfdsfsd&quot;</span></span><br><span class="line">let s5 = s4<span class="selector-class">.uppercased</span>() <span class="comment">//è¿”å›ä¸€ä¸ªå¤§å†™çš„å­—ç¬¦ä¸²,åŸå­—ç¬¦ä¸²ä¸å—å½±å“</span></span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(<span class="string">&quot;s4:\(s4)&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(<span class="string">&quot;s5:\(s5)&quot;</span>)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å­—ç¬¦ä¸²æˆªå–.å­—ç¬¦ä¸²æˆªå–éœ€è¦ä½¿ç”¨String.Indexä¸­ä»‹</span></span><br><span class="line">let s7: String = <span class="string">&quot;dasd3243232423sfsfdsf13&quot;</span></span><br><span class="line"><span class="comment">//æˆªå–å‰4ä¸ªå­—ç¬¦</span></span><br><span class="line">let s8: Substring = s7<span class="selector-class">.prefix</span>(<span class="number">4</span>) <span class="comment">//è¿”å›çš„æ˜¯ä¸€ä¸ªSubstringç±»å‹,å› æ­¤ä¸èƒ½èµ‹å€¼ç»™ä¸€ä¸ªStringç±»å‹çš„å˜é‡,å¦‚æœè¦èµ‹å€¼ç»™lable,éœ€è¦è½¬æ¢ä¸ºStringç±»å‹</span></span><br><span class="line">let <span class="selector-tag">label</span> = UILabel<span class="selector-class">.init</span>()</span><br><span class="line"><span class="selector-tag">label</span><span class="selector-class">.text</span> = String<span class="selector-class">.init</span>(s8) </span><br><span class="line"></span><br><span class="line"><span class="comment">//Stringå’ŒSubstringå¯ä»¥ç›´æ¥ç›¸åŠ æ“ä½œ,ç¼–è¯‘å™¨å·²ç»åšäº†å¼ºåˆ¶è½¬æ¢.</span></span><br><span class="line">let s9: String = s7 + s8</span><br><span class="line"></span><br><span class="line"><span class="comment">//æˆªå–å5ä¸ªå­—ç¬¦</span></span><br><span class="line">let s10: Substring = s7<span class="selector-class">.suffix</span>(<span class="number">5</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(<span class="string">&quot;s10:\(s10)&quot;</span>)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»ç¬¬å››ä¸ª(åŒ…å«)å¼€å§‹æˆªå–,æˆªå–10ä¸ªé•¿åº¦çš„å­—ç¬¦</span></span><br><span class="line">let offset4Index: String<span class="selector-class">.Index</span> = s7<span class="selector-class">.index</span>(s7<span class="selector-class">.startIndex</span>, offsetBy: <span class="number">4</span>)</span><br><span class="line">let dest14Index = s7<span class="selector-class">.index</span>(offset4Index, offsetBy: <span class="number">10</span>) <span class="comment">//æ³¨æ„:èµ·ç‚¹+é•¿åº¦ä¸èƒ½è¶Šç•Œ.</span></span><br><span class="line">let s11: Substring = s7<span class="selector-attr">[offset4Index..&lt;dest14Index]</span> <span class="comment">//è¿”å›çš„æ˜¯ä¸€ä¸ªSubstringç±»å‹,å› æ­¤ä¸èƒ½èµ‹å€¼ç»™ä¸€ä¸ªStringç±»å‹çš„å˜é‡. &quot;..&lt;&quot;è¡¨ç¤ºåŒ…å«å·¦è¾¹,ä½†ä¸åŒ…å«å³è¾¹,&quot;...&quot;è¡¨ç¤ºé—­åŒºé—´,ä¸¤è¾¹éƒ½åŒ…å«.</span></span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(<span class="string">&quot;s11:\(s11)&quot;</span>)</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//ç§»é™¤æœ€åä¸€ä¸ªå­—ç¬¦.è¢«æ“ä½œçš„å­—ç¬¦ä¸²ä¸èƒ½ä¸ºç©ºå­—ç¬¦ä¸².</span></span><br><span class="line"><span class="selector-tag">var</span> s12: String = <span class="string">&quot;sfdsfds&quot;</span></span><br><span class="line">s12<span class="selector-class">.removeLast</span>()</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(<span class="string">&quot;s12:\(s12)&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Swift</category>
      </categories>
  </entry>
  <entry>
    <title>æ“ä½œå­è§†å›¾æ§åˆ¶å™¨</title>
    <url>/2017/11/13/%E6%93%8D%E4%BD%9C%E5%AD%90%E8%A7%86%E5%9B%BE%E6%8E%A7%E5%88%B6%E5%99%A8/</url>
    <content><![CDATA[<h2 id="æ“ä½œå­è§†å›¾æ§åˆ¶å™¨"><a href="#æ“ä½œå­è§†å›¾æ§åˆ¶å™¨" class="headerlink" title="æ“ä½œå­è§†å›¾æ§åˆ¶å™¨"></a>æ“ä½œå­è§†å›¾æ§åˆ¶å™¨</h2><p>ç³»ç»Ÿæä¾›äº†ä¸€äº›æ–¹æ³•ç”¨äºæ·»åŠ å’Œç§»é™¤å­è§†å›¾æ§åˆ¶å™¨:<br>(UIContainerViewControllerProtectedMethods)ç±»åˆ«é‡Œçš„:  </p>
<figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">- <span class="params">(void)</span>addChildViewController:<span class="params">(UIViewController *)</span>childController NS_AVAILABLE_IOS<span class="params">(<span class="number">5_0</span>)</span>;</span><br><span class="line">- <span class="params">(void)</span>removeFromParentViewController NS_AVAILABLE_IOS<span class="params">(<span class="number">5_0</span>)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä¸¤ä¸ªæ–¹æ³•è°ƒç”¨åè¿˜è¦é…å¥—è°ƒç”¨(UIContainerViewControllerCallbacks)ç±»åˆ«é‡Œçš„:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)willMoveToParentViewController:(<span class="keyword">nullable</span> <span class="built_in">UIViewController</span> *)parent <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">5</span>_0);</span><br><span class="line">- (<span class="type">void</span>)didMoveToParentViewController:(<span class="keyword">nullable</span> <span class="built_in">UIViewController</span> *)parent <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">5</span>_0);</span><br></pre></td></tr></table></figure>
<h3 id="addChildViewController-çš„è¯´æ˜"><a href="#addChildViewController-çš„è¯´æ˜" class="headerlink" title="addChildViewController:çš„è¯´æ˜:"></a>addChildViewController:çš„è¯´æ˜:</h3><ol>
<li><p>If the child controller has a different parent controller, it will first be removed from its current parent<br>by calling removeFromParentViewController.</p>
</li>
<li><p>addChildViewController: will call [child willMoveToParentViewController:self] before adding the<br>child. However, it will not call didMoveToParentViewController:.æ‰€ä»¥willMoveToParentViewController:å°±ä¸éœ€è¦æˆ‘ä»¬è‡ªå·±è°ƒç”¨äº†,ä½†éœ€è¦æˆ‘ä»¬è‡ªå·±æ‰‹åŠ¨è°ƒç”¨didMoveToParentViewController:</p>
</li>
</ol>
<h3 id="removeFromParentViewControllerçš„è¯´æ˜"><a href="#removeFromParentViewControllerçš„è¯´æ˜" class="headerlink" title="removeFromParentViewControllerçš„è¯´æ˜:"></a>removeFromParentViewControllerçš„è¯´æ˜:</h3><p>removeFromParentViewController does not call [self willMoveToParentViewController:nil] before removing the<br>  child. This is also the responsibilty of the container subclass.subclasses will typically define a method that removes a child in<br>  the reverse manner by first calling [child willMoveToParentViewController:nil].</p>
<h3 id="æ­£ç¡®æ·»åŠ å’Œç§»é™¤ä¸€ä¸ªå­è§†å›¾æ§åˆ¶å™¨"><a href="#æ­£ç¡®æ·»åŠ å’Œç§»é™¤ä¸€ä¸ªå­è§†å›¾æ§åˆ¶å™¨" class="headerlink" title="æ­£ç¡®æ·»åŠ å’Œç§»é™¤ä¸€ä¸ªå­è§†å›¾æ§åˆ¶å™¨"></a>æ­£ç¡®æ·»åŠ å’Œç§»é™¤ä¸€ä¸ªå­è§†å›¾æ§åˆ¶å™¨</h3><p>æ·»åŠ ä¸€ä¸ªå­è§†å›¾æ§åˆ¶å™¨çš„æ–¹æ³•å¦‚ä¸‹:</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[self addChildViewController:quizingVC]</span><span class="comment">;</span></span><br><span class="line"><span class="attr">quizingVC.view.frame</span> = CGRectMake(<span class="number">0</span>, <span class="number">0</span>, self.contentScrollView.frame.size.width, self.contentScrollView.frame.size.height - <span class="number">2</span>*matchStatusBarH)<span class="comment">;</span></span><br><span class="line"><span class="section">[self.contentScrollView addSubview:quizingVC.view]</span><span class="comment">;</span></span><br><span class="line"><span class="section">[quizingVC didMoveToParentViewController:self]</span><span class="comment">;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ç§»é™¤ä¸€ä¸ªå­è§†å›¾æ§åˆ¶å™¨:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å…ˆå°†å…¶çˆ¶æ§åˆ¶å™¨ç½®ä¸ºnil</span></span><br><span class="line">[<span class="keyword">self</span> willMoveToParentViewController:<span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//å…¶ä»–ä¸€äº›æ“ä½œæ¯”å¦‚åŠ¨ç”».</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">//å†remove</span></span><br><span class="line">[<span class="keyword">self</span> removeFromParentViewController];</span><br></pre></td></tr></table></figure>
<h3 id="note"><a href="#note" class="headerlink" title="note"></a>note</h3><p>ä¸€ä¸ªæ§åˆ¶å™¨åªæœ‰è¢«æ·»åŠ åˆ°çˆ¶æ§åˆ¶å™¨å,çˆ¶æ§åˆ¶å™¨çš„viewçš„frame(å°¤å…¶æ˜¯size)æ”¹å˜æ—¶,ç³»ç»Ÿæ‰ä¼šè°ƒæ•´å­æ§åˆ¶å™¨çš„Viewçš„frame,å¹¶éšä¹‹è‡ªåŠ¨è°ƒç”¨å­æ§åˆ¶å™¨çš„viewDidLayoutSubviewsæ–¹æ³•.è¿™æ ·å­æ§åˆ¶å™¨çš„ViewåŠå…¶å­è§†å›¾æ‰ä¼šæœ‰æ­£ç¡®çš„frame.</p>
<p>åœ¨åµŒå¥—æ§åˆ¶å™¨çš„æ—¶å€™å¯ä»¥æµ‹è¯•ä¸€ä¸‹.æ¯”å¦‚ä½¿ç”¨<code>CAPSPageMenu</code>ç¬¬ä¸‰æ–¹åº“.</p>
]]></content>
      <categories>
        <category>UIKit</category>
      </categories>
      <tags>
        <tag>UIViewController</tag>
      </tags>
  </entry>
  <entry>
    <title>removeObject</title>
    <url>/2017/11/12/swift_removeObject/</url>
    <content><![CDATA[<h2 id="ç»™Swift-Arrayç±»å‹æ‰©å±•removeObjectæ–¹æ³•"><a href="#ç»™Swift-Arrayç±»å‹æ‰©å±•removeObjectæ–¹æ³•" class="headerlink" title="ç»™Swift Arrayç±»å‹æ‰©å±•removeObjectæ–¹æ³•"></a>ç»™Swift Arrayç±»å‹æ‰©å±•removeObjectæ–¹æ³•</h2><p>ç”±äºArrayæ˜¯ç»“æ„ä½“ç±»å‹,è€ŒremoveObjectå‡½æ•°ä¼šæ”¹å˜ç»“æ„ä½“çš„å€¼,æ‰€ä»¥è¯¥å‡½æ•°éœ€è¦æ·»åŠ mutatingå…³é”®å­—.â€œNotice the use of the mutating keyword in the declaration of SimpleStructure to mark a method that modifies the structure. The declaration of SimpleClass doesnâ€™t need any of its methods marked as mutating because methods on a class can always modify the class.â€</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extension</span> <span class="keyword">Array</span> <span class="keyword">where</span> Element: Equatable &#123;</span><br><span class="line">    mutating func removeObject(<span class="keyword">object</span>: Element) &#123;</span><br><span class="line">        <span class="keyword">if</span> let <span class="keyword">index</span> = <span class="keyword">index</span>(<span class="keyword">of</span>: <span class="keyword">object</span>) &#123;</span><br><span class="line">            remove(at: <span class="keyword">index</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Swift</category>
      </categories>
  </entry>
  <entry>
    <title>åè½¬ä¸€ä¸ªå­—ç¬¦ä¸²</title>
    <url>/2017/11/02/%E5%8F%8D%E8%BD%AC%E4%B8%80%E4%B8%AA%E5%AD%97%E7%AC%A6%E4%B8%B2/</url>
    <content><![CDATA[<h3 id="åè½¬ä¸€ä¸ªå­—ç¬¦ä¸²"><a href="#åè½¬ä¸€ä¸ªå­—ç¬¦ä¸²" class="headerlink" title="åè½¬ä¸€ä¸ªå­—ç¬¦ä¸²"></a>åè½¬ä¸€ä¸ªå­—ç¬¦ä¸²</h3><p>å¯¹â€hello,world!â€,è¿›è¡Œåè½¬.<br>é”™è¯¯å®ç°:</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åè½¬ä¸€ä¸ªå­—ç¬¦ä¸²</span></span><br><span class="line"><span class="type">char</span> * <span class="title function_ invoke__">reverseString</span>(<span class="type">char</span> *src)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> *rs = src;</span><br><span class="line">    <span class="keyword">while</span> (*src != <span class="string">&#x27;<span class="char escape_">\0</span>&#x27;</span>) &#123;</span><br><span class="line">        src++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (*rs != <span class="string">&#x27;<span class="char escape_">\0</span>&#x27;</span>) &#123;</span><br><span class="line">        *rs++ = *--src; </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> src;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ç§æ€è·¯å…¶å®æ˜¯é”™çš„.å½“rsä¸srcç›¸é‡æ—¶,å­—ç¬¦ä¸²å·²ç»å˜ä¸ºâ€!dlrowworld!â€,å†è¿›è¡Œæ›¿æ¢æ“ä½œå°±ä¼šå‡ºé—®é¢˜äº†,å› ä¸ºå­—ç¬¦â€hello,â€å·²ç»è¢«æ›¿æ¢è€Œä¸å­˜åœ¨äº†.æ‰€ä»¥ä¸åº”è¯¥ä½¿ç”¨æ›¿æ¢,è€Œåº”è¯¥ä½¿ç”¨äº¤æ¢.</p>
<p>æ­£ç¡®å®ç°:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åè½¬ä¸€ä¸ªå­—ç¬¦ä¸²</span></span><br><span class="line"><span class="function"><span class="type">char</span> * <span class="title">reverseString</span><span class="params">(<span class="type">char</span> *src)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> *forwardPtr = src;</span><br><span class="line">    <span class="type">char</span> *backPtr = src;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (*backPtr != <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">        backPtr++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (forwardPtr &lt; backPtr) &#123;</span><br><span class="line">        <span class="type">char</span> tmp = *forwardPtr;</span><br><span class="line">        *forwardPtr++ = *--backPtr;</span><br><span class="line">        *backPtr = tmp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> src;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>ç®—æ³•</category>
      </categories>
  </entry>
  <entry>
    <title>é‡‡ç”¨ Modern Objective-C</title>
    <url>/2017/10/21/%E9%87%87%E7%94%A8%20Modern%20Objective-C/</url>
    <content><![CDATA[<h2 id="é‡‡ç”¨-Modern-Objective-C"><a href="#é‡‡ç”¨-Modern-Objective-C" class="headerlink" title="é‡‡ç”¨ Modern Objective-C"></a>é‡‡ç”¨ Modern Objective-C</h2><p>å‚è€ƒ:<a href="https://developer.apple.com/library/content/releasenotes/ObjectiveC/ModernizationObjC/AdoptingModernObjective-C/AdoptingModernObjective-C.html">Adopting Modern Objective-C</a></p>
<p>These modernizations <strong>improve type safety, memory management, performance, and other aspects of Objective-C</strong>, making it easier for you to write correct code. Itâ€™s important to adopt these changes in your existing and future code to help it become more consistent, readable, and resilient.</p>
<h3 id="instancetype"><a href="#instancetype" class="headerlink" title="instancetype"></a>instancetype</h3><p>Use the instancetype keyword as the return type of methods that return an instance of the class they are called on (or a subclass of that class).<br>Using instancetype instead of id in appropriate places <strong>improves type safety</strong> in your Objective-C code.<br>ä½¿ç”¨instancetypeå,å¦‚æœç»™å¯¹è±¡å‘é€ä¸€æ¡ä¸èƒ½è¯†åˆ«çš„æ¶ˆæ¯é‚£ä¹ˆç¼–è¯‘å™¨å°±ä¼šæç¤ºé”™è¯¯,è¿™æ ·å°±å¯ä»¥æå‰è§£å†³é”™è¯¯,å› æ­¤æé«˜äº†ç±»å‹å®‰å…¨.å‚è€ƒå®˜æ–¹æ–‡æ¡£ä¸Šçš„ä¾‹å­è¯´æ˜.</p>
<p>Note that you should replace id with instancetype for return values only, not elsewhere in your code. Unlike id, the instancetype keyword can be used only as the result type in a method declaration.</p>
<h3 id="propertyè¯­æ³•"><a href="#propertyè¯­æ³•" class="headerlink" title="@propertyè¯­æ³•"></a><code>@property</code>è¯­æ³•</h3><p>ä½¿ç”¨propertiesä»£æ›¿å®ä¾‹å˜é‡æœ‰è®¸å¤šå¥½å¤„.</p>
<ul>
<li>è‡ªåŠ¨åˆæˆgetterå’Œsetter.</li>
<li>æ›´å¥½çš„å£°æ˜ä¸€ç³»åˆ—æ–¹æ³•çš„æ„å›¾.</li>
<li>Propertyå…³é”®å­—å¯ä»¥ä¼ é€’é¢å¤–çš„ä¿¡æ¯.æ¯”å¦‚assign (vs copy), weak, atomic (vs nonatomic), and so on.</li>
</ul>
<p>Property methods follow a simple naming convention. The getter is the name of the property (for example, date), and the setter is the name of the property with the set prefix, written in camel case (for example, setDate). The naming convention for Boolean properties is to declare them with a named getter starting with the word â€œisâ€:<br><code>@property (readonly, getter=isBlue) BOOL blue;</code></p>
<h3 id="æšä¸¾å®"><a href="#æšä¸¾å®" class="headerlink" title="æšä¸¾å®"></a>æšä¸¾å®</h3><p>ä½¿ç”¨NS_ENUM å’Œ NS_OPTIONSå®.when you use enum to define a bitmask use the NS_OPTIONS macro.</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, <span class="built_in">UITableViewCellStyle</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">UITableViewCellStyleDefault</span>,</span><br><span class="line"></span><br><span class="line">        <span class="built_in">UITableViewCellStyleValue1</span>,</span><br><span class="line"></span><br><span class="line">        <span class="built_in">UITableViewCellStyleValue2</span>,</span><br><span class="line"></span><br><span class="line">        <span class="built_in">UITableViewCellStyleSubtitle</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_OPTIONS</span>(<span class="built_in">NSUInteger</span>, <span class="built_in">UIViewAutoresizing</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">UIViewAutoresizingNone</span>                 = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="built_in">UIViewAutoresizingFlexibleLeftMargin</span>   = <span class="number">1</span> &lt;&lt; <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="built_in">UIViewAutoresizingFlexibleWidth</span>        = <span class="number">1</span> &lt;&lt; <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">        <span class="built_in">UIViewAutoresizingFlexibleRightMargin</span>  = <span class="number">1</span> &lt;&lt; <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">        <span class="built_in">UIViewAutoresizingFlexibleTopMargin</span>    = <span class="number">1</span> &lt;&lt; <span class="number">3</span>,</span><br><span class="line"></span><br><span class="line">        <span class="built_in">UIViewAutoresizingFlexibleHeight</span>       = <span class="number">1</span> &lt;&lt; <span class="number">4</span>,</span><br><span class="line"></span><br><span class="line">        <span class="built_in">UIViewAutoresizingFlexibleBottomMargin</span> = <span class="number">1</span> &lt;&lt; <span class="number">5</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
  </entry>
  <entry>
    <title>didSelectRowAtIndexPathä¸è¢«è°ƒç”¨</title>
    <url>/2017/10/18/didSelectRowAtIndexPath%E4%B8%8D%E8%A2%AB%E8%B0%83%E7%94%A8/</url>
    <content><![CDATA[<h2 id="didSelectRowAtIndexPathä¸è¢«è°ƒç”¨"><a href="#didSelectRowAtIndexPathä¸è¢«è°ƒç”¨" class="headerlink" title="didSelectRowAtIndexPathä¸è¢«è°ƒç”¨"></a>didSelectRowAtIndexPathä¸è¢«è°ƒç”¨</h2><p>vc.viewä¸Šæ·»åŠ ä¸€ä¸ªUITableView,å¹¶ä¸”vc.viewä¸Šæ·»åŠ ä¸€ä¸ªUITapGestureRecognizeræ‰‹åŠ¿,é‚£ä¹ˆ<code>- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath</code>ä»£ç†æ–¹æ³•å°†ä¸å†è¢«è°ƒç”¨.</p>
<p>è¿™æ˜¯ç”±äº<code>UIGestureRecognizer</code>æœ‰ä¸€ä¸ªå±æ€§:<br><code>@property(nonatomic) BOOL cancelsTouchesInView;</code><br>å®˜æ–¹çš„æ³¨é‡Š:default is YES. causes touchesCancelled:withEvent: or pressesCancelled:withEvent: to be sent to the view for all touches or presses recognized as part of this gesture immediately before the action method is called.<br>è¯¥å±æ€§é»˜è®¤æ˜¯YES,åœ¨actionæ–¹æ³•è¢«è°ƒç”¨ä¹‹å‰ç³»ç»Ÿä¼šè¿…é€Ÿè°ƒç”¨Viewçš„touchesCancelled:withEvent: or pressesCancelled:withEvent:æ–¹æ³•.touchesäº‹ä»¶å°†ç«‹å³è¢«cancel.æ‰€æœ‰çš„touchesæˆ–presseså¯¹è±¡å°†è½¬è€Œè¢«ç”¨äºæ‰‹åŠ¿è¯†åˆ«.å› æ­¤å½“ä¸€ä¸ªViewä¸Šæ·»åŠ äº†ä¸€ä¸ªæ‰‹åŠ¿é‚£ä¹ˆè¯¥Viewçš„touchesEndedæ–¹æ³•å°†ä¸ä¼šè¢«è°ƒç”¨(åªä¼štouchesBegan-&gt;touchesCancelled).</p>
<p>å¯ä»¥æ¨æ–­å‡º:å¦‚æœä¸€ä¸ªbuttonä¸Šåˆæ·»åŠ ä¸€ä¸ªtapæ‰‹åŠ¿,åˆ™æœ€ååªä¼šæœ‰tapå“åº”,buttonçš„targetåˆ™ä¸ä¼šè¢«è°ƒç”¨.è¿™æ˜¯ç”±äºæ‰‹åŠ¿è¯†åˆ«æ—¶ä¼šcancelæ‰åé¢çš„Touches.å› æ­¤å½“ç”¨æˆ·è§¦æ‘¸ä¸€ä¸ªæ§ä»¶æ—¶,æ‰‹åŠ¿çš„å¤„ç†ä¼˜å…ˆäºè§¦æ‘¸äº‹ä»¶çš„å¤„ç†.</p>
<p>å› æ­¤,è¦æƒ³didSelectRowAtIndexPathæ–¹æ³•è¢«è°ƒç”¨,æœ‰ä¸¤ç§è§£å†³åŠæ³•:  </p>
<ol>
<li>è®¾ç½®<code>tap.cancelsTouchesInView = NO;</code>è®©touchäº‹ä»¶ç»§ç»­è¿›è¡Œ,ä»è€Œè®©viewå¯ä»¥ç»§ç»­å¤„ç†.</li>
<li><p>å®ç°<code>UIGestureRecognizerDelegate</code>çš„ä»£ç†æ–¹æ³•</p>
 <figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)gestureRecognizer:(<span class="built_in">UIGestureRecognizer</span> *)gestureRecognizer shouldReceiveTouch:(<span class="built_in">UITouch</span> *)touch &#123;</span><br><span class="line">    <span class="keyword">if</span> ([touch.view isKindOfClass:<span class="built_in">NSClassFromString</span>(<span class="string">@&quot;UITableViewCellContentView&quot;</span>)]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> å½“ç‚¹å‡»åˆ°cell.contentViewä¸Šæ—¶,è®©tapæ‰‹åŠ¿ä¸å¤„ç†touches.</p>
</li>
</ol>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ:"></a>å‚è€ƒ:</h3><p><a href="https://joakimliu.github.io/2017/01/15/iOSçš„äº‹ä»¶å¤„ç†/">iOSçš„äº‹ä»¶å¤„ç†</a></p>
<p>Event Handling Guide for iOS </p>
]]></content>
      <categories>
        <category>UIKit</category>
      </categories>
      <tags>
        <tag>UITableView</tag>
      </tags>
  </entry>
  <entry>
    <title>CUICatalog-Invalid asset name supplied</title>
    <url>/2017/10/13/CUICatalog-Invalid%20asset%20name%20supplied/</url>
    <content><![CDATA[<h2 id="CUICatalog-Invalid-asset-name-supplied"><a href="#CUICatalog-Invalid-asset-name-supplied" class="headerlink" title="CUICatalog-Invalid asset name supplied"></a>CUICatalog-Invalid asset name supplied</h2><p>iOS11ä¸­,<br><code>UIImage *highlightedImage = [UIImage imageNamed:highlightedImageName];</code>å¦‚æœå›¾ç‰‡åæ˜¯nil,æˆ–è€…ä¸å­˜åœ¨å¯¹åº”çš„å›¾ç‰‡,é‚£ä¹ˆæ§åˆ¶å°ä¼šæ‰“å°ä¸‹é¢çš„æç¤ºä¿¡æ¯.ä¸€èˆ¬æ˜¯å› ä¸ºä¼ äº†nilæˆ–è¦æ‰¾çš„èµ„æºä¸å­˜åœ¨å¯¼è‡´.</p>
<p>2017-09-27 16:46:33.399319+0800 KingDynastyGaming[48313:2122542] [framework] CUICatalog: Invalid asset name supplied: â€˜(null)â€™</p>
<p>é—®é¢˜å°±æ˜¯è¦æ‰¾åˆ°å“ªè¡Œä»£ç å¯¼è‡´å‡ºç°äº†æç¤ºä¿¡æ¯.<br>è°ƒè¯•åŠæ³•:æ‰“ç¬¦å·æ–­ç‚¹:<code>+[UIImage imageNamed:]</code>.åœ¨å‡ºç°è¿™æ¡ä¿¡æ¯çš„æ“ä½œä¹‹å‰ä½¿èƒ½æ–­ç‚¹,è¿™æ ·æ ¹æ®å‡½æ•°è°ƒç”¨æ ˆå°±å¯ä»¥çœ‹åˆ°è°ƒç”¨è¯¥æ–¹æ³•çš„ä½ç½®,ä½¿ç”¨å‘½ä»¤<code>po $arg3</code>è¿˜å¯ä»¥æŸ¥çœ‹å›¾ç‰‡çš„åå­—å³ç¬¬ä¸‰ä¸ªå‚æ•°çš„å€¼.</p>
<h3 id="è°ƒè¯•å‘½ä»¤å‚æ•°"><a href="#è°ƒè¯•å‘½ä»¤å‚æ•°" class="headerlink" title="è°ƒè¯•å‘½ä»¤å‚æ•°"></a>è°ƒè¯•å‘½ä»¤å‚æ•°</h3><p>The exception object is passed in as the first argument to <code>objc_exception_throw</code>. LLDB provides <code>$arg1..$argn</code> variables to refer to arguments in the correct calling convention, making it simple to print the exception details:</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line">(lldb) po <span class="variable">$arg1</span></span><br><span class="line">(lldb) po <span class="selector-attr">[$arg1 name]</span></span><br><span class="line">(lldb) po <span class="selector-attr">[$arg1 reason]</span></span><br></pre></td></tr></table></figure>
<p>Make sure to select the objc_exception_throw frame in the call stack before executing these commands. See the â€œAdvanced Debugging and the Address Sanitizerâ€ in the WWDC15 session videos to see this performed on stage.</p>
<p>On the iPhone Simulator, all function arguments are passed on the stack, so the syntax is considerably more horrible. The shortest expression I could construct that gets to it is <code>*(id *)($ebp + 8)</code>. To make things less painful, I suggest using a convenience variable:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(gdb) <span class="built_in">set</span> <span class="variable">$exception</span> = *(<span class="built_in">id</span> *)(<span class="variable">$ebp</span> + 8)</span><br><span class="line">(gdb) po <span class="variable">$exception</span></span><br><span class="line">(gdb) po [<span class="variable">$exception</span> name]</span><br><span class="line">(gdb) po [<span class="variable">$exception</span> reason]</span><br></pre></td></tr></table></figure>
<p>You can also set <code>$exception</code> automatically whenever the breakpoint is triggered by adding a command list to the <code>objc_exception_throw</code> breakpoint.</p>
<p>(Note that in all cases I tested, the exception object was also present in the eax and edx registers at the time the breakpoint hit. Iâ€™m not sure thatâ€™ll always be the case, though.)</p>
<p>Added from comment below:</p>
<p>In lldb, select the stack frame for objc_exception_throw and then enter this command:</p>
<p><code>(lldb) po *(id *)($esp + 4)</code></p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://stackoverflow.com/questions/3327828/xcode-lldb-how-to-get-information-about-an-exception-that-was-just-thrown">Xcode/LLDB: How to get information about an exception that was just thrown?</a></p>
<p><a href="http://www.clarkcox.com/blog/2009/02/04/inspecting-obj-c-parameters-in-gdb/">Inspecting Obj-C parameters in gdb</a></p>
<p><a href="http://www.jianshu.com/p/f900de4a1495">ã€OCåˆ¨æ ¹é—®åº•ã€‘-Runtimeç®€å•ç²—æš´ç†è§£</a></p>
<p><a href="http://blog.csdn.net/qq_27074387/article/details/50352613">OC è¿è¡Œæ—¶ (äºŒ)</a></p>
]]></content>
      <categories>
        <category>Bug</category>
      </categories>
  </entry>
  <entry>
    <title>åœ¨mac OSä¸Šåç¼–è¯‘å®‰å“apkåŒ…</title>
    <url>/2017/09/30/%E5%9C%A8mac%20OS%E4%B8%8A%E5%8F%8D%E7%BC%96%E8%AF%91%E5%AE%89%E5%8D%93apk%E5%8C%85/</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¸€èˆ¬ä¸Šæ¶çš„å®‰å“apkéƒ½ä¼šåšæ··æ·†å’ŒåŠ å›º,å¦‚æœä¸¤ä¸ªéƒ½ä¸åšé‚£ä¹ˆè¢«åˆ«äººåç¼–è¯‘åå°±å¯ä»¥ç›´æ¥çœ‹åˆ°æºç äº†.è€Œæ··æ·†å,é‚£äº›å‡½æ•°åå°±ä¼šå˜æˆä¸€äº›å¦‚â€aâ€,â€bâ€,â€câ€ä¹‹ç±»æ— æ„ä¹‰çš„åç§°,å¹¶ä¸”è¿˜ä¼šæ·»åŠ ä¸€äº›æ— æ„ä¹‰çš„ä»£ç é€»è¾‘.ä»è€Œå¤§å¤§æé«˜äº†ç ´è§£çš„éš¾åº¦,ä½†æ˜¯èŠ±ç‚¹æ—¶é—´è¿˜æ˜¯èƒ½å¤Ÿçœ‹æ‡‚ä¸€äº›é€»è¾‘çš„.å› æ­¤ä¸ºäº†è®©apkæ›´åŠ éš¾ä»¥åç¼–è¯‘,åŠ å›ºä¹Ÿå¾ˆé‡è¦.åŠ å›ºåè¦æƒ³åç¼–è¯‘åˆ™æ›´åŠ è´¹æ—¶,è´¹åŠ².æœ¬æ–‡ä»…ä»…æ˜¯è‡ªå·±åšä¸ªè®°å½•,æ‰€ä»¥ä¸ç‰µæ¶‰åˆ°å¯¹åŠ å›ºåçš„apkè¿›è¡Œåç¼–è¯‘.</p>
<h2 id="å·¥å…·"><a href="#å·¥å…·" class="headerlink" title="å·¥å…·"></a>å·¥å…·</h2><ul>
<li><a href="https://ibotpeaches.github.io/Apktool/install/">Apktool</a></li>
<li><a href="https://sourceforge.net/projects/dex2jar/files/">dex2jar</a></li>
<li><a href="http://jd.benow.ca/">jd-gui</a></li>
</ul>
<h3 id="Apktool"><a href="#Apktool" class="headerlink" title="Apktool"></a>Apktool</h3><p>èµ„æºåç¼–è¯‘,è·å–apké‡Œé¢çš„èµ„æº.å¦‚æœä½ ä»…ä»…åªæ˜¯æƒ³è·å–é‡Œé¢çš„èµ„æº,å¯ä¸å¿…ä½¿ç”¨è¯¥å·¥å…·,ç›´æ¥è§£å‹ç¼©æºapkå°±å¯ä»¥äº†.<br>note:ä½¿ç”¨Apktoolå¤„ç†åçš„å’Œç›´æ¥è§£å‹ç¼©åçš„é‡Œé¢çš„æ–‡ä»¶å†…å®¹è¿˜æ˜¯ä¸ä¸€æ ·çš„,æ¯”å¦‚é‡Œé¢çš„AndroidManifest.xmlæ–‡ä»¶,Apktoolå¤„ç†åçš„å°±èƒ½å¤Ÿè¯»æ‡‚,å¦åˆ™æ˜¯ä¸€äº›ä¹±ç .</p>
<h4 id="Apktoolå®‰è£…"><a href="#Apktoolå®‰è£…" class="headerlink" title="Apktoolå®‰è£…"></a>Apktoolå®‰è£…</h4><p>æŒ‰ç…§å®˜ç½‘è¯´æ˜,ä¸‹è½½åä¼šå¾—åˆ°ä¸¤ä¸ªæ–‡ä»¶<code>apktool</code>å’Œ<code>apktool.jar</code>,éœ€è¦æ³¨æ„çš„æ˜¯å¿…é¡»èµ‹äºˆè¿™ä¸¤ä¸ªæ–‡ä»¶å¯æ‰§è¡Œæƒé™.ä½¿ç”¨å‘½ä»¤<code>chmod +x å¯¹åº”æ–‡ä»¶å</code>å³å¯.æœ€åå°†è¿™ä¸¤ä¸ªæ–‡ä»¶æ‹–å…¥<code>/usr/local/bin</code>æ–‡ä»¶å¤¹ä¸­.</p>
<h4 id="Apktoolä½¿ç”¨"><a href="#Apktoolä½¿ç”¨" class="headerlink" title="Apktoolä½¿ç”¨"></a>Apktoolä½¿ç”¨</h4><p>å‘½ä»¤:<code>apktool d å¯¹åº”apkè·¯å¾„</code>.<br>æ‰§è¡Œå®Œæ¯•å,ä¼šå¾—åˆ°ä¸€ä¸ªåŒåçš„æ–‡ä»¶å¤¹,é‡Œé¢å°±æ˜¯ä¸€äº›èµ„æºäº†.æ‰¾åˆ°é‡Œé¢çš„<code>classes.dex</code>æ–‡ä»¶,åé¢ä»£ç åç¼–è¯‘ä¼šç”¨åˆ°.</p>
<h3 id="dex2jar"><a href="#dex2jar" class="headerlink" title="dex2jar"></a>dex2jar</h3><p>ä»£ç åç¼–è¯‘,å¾—åˆ°<code>classes-dex2jar.jar</code>æ–‡ä»¶.</p>
<h4 id="dex2jarä½¿ç”¨"><a href="#dex2jarä½¿ç”¨" class="headerlink" title="dex2jarä½¿ç”¨"></a>dex2jarä½¿ç”¨</h4><p>ä¸‹è½½åä¼šå¾—åˆ°ä¸€ä¸ª<code>dex2jar-2.0</code>æ–‡ä»¶å¤¹.è¿™é‡Œéœ€è¦ç”¨åˆ°é‡Œé¢çš„<code>lib</code>,<code>d2j_invoke.sh</code>,<code>d2j-dex2jar.sh</code>.<br>å°†è¿™ä¸‰ä¸ªæ–‡ä»¶åŠä¸Šé¢è·å¾—çš„<code>classes.dex</code>æ–‡ä»¶æ‹–å…¥åŒä¸€ä¸ªæ–‡ä»¶å¤¹ç›®å½•.<br>ä½¿ç”¨å‘½ä»¤: <code>sh d2j-dex2jar.sh classes.dex</code><br>æ­¤æ—¶åœ¨è¯¥ç›®å½•ä¸‹ä¼šå¾—åˆ°ä¸€ä¸ª<code>classes-dex2jar.jar</code>æ–‡ä»¶.è¿™ä¸ªæ–‡ä»¶åé¢ä¼šç”¨åˆ°.</p>
<h3 id="jd-gui"><a href="#jd-gui" class="headerlink" title="jd-gui"></a>jd-gui</h3><p>ä¸‹è½½åä¼šå¾—åˆ°ä¸€ä¸ª<code>jd-gui-osx-1.4.0</code>æ–‡ä»¶å¤¹,åŒå‡»é‡Œé¢çš„<code>JD-GUI</code>æ–‡ä»¶,æ‰“å¼€åå°†ä¸Šè¿°<code>classes-dex2jar.jar</code>æ–‡ä»¶æ‹–å…¥å…¶ä¸­.å°±å¯ä»¥çœ‹åˆ°å•¦!<br>note:ä½ çš„Macå¿…é¡»å®‰è£…äº†Javaç¯å¢ƒ.</p>
<h2 id="æ•ˆæœ"><a href="#æ•ˆæœ" class="headerlink" title="æ•ˆæœ"></a>æ•ˆæœ</h2><p>ç›®å½•:<br><img src="http://7xqoji.com1.z0.glb.clouddn.com/%E5%AE%89%E8%A3%85apk%E5%8F%8D%E7%BC%96%E8%AF%91%E5%90%8E%E5%B7%A5%E7%A8%8B%E7%9B%AE%E5%BD%95.png" alt="ç›®å½•"></p>
<p>éƒ¨åˆ†ä»£ç :</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">a</span>(<span class="params"><span class="built_in">int</span> paramInt, boolean paramBoolean</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    Observable.a(<span class="keyword">new</span> FavoriteBean(Integer.valueOf(paramInt), Boolean.valueOf(paramBoolean))).a(<span class="keyword">new</span> Func1()</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> String <span class="title">a</span>(<span class="params">FavoriteBean paramAnonymousFavoriteBean</span>)</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (paramAnonymousFavoriteBean.getKeepAble().booleanValue()) &#123;</span><br><span class="line">          BasicActivity.f(BasicActivity.<span class="keyword">this</span>).<span class="keyword">add</span>(<span class="number">0</span>, paramAnonymousFavoriteBean.getId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (;;)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">          Iterator localIterator = BasicActivity.f(BasicActivity.<span class="keyword">this</span>).iterator();</span><br><span class="line">          <span class="keyword">if</span> (localIterator.hasNext())</span><br><span class="line">          &#123;</span><br><span class="line">            Integer localInteger = (Integer)localIterator.next();</span><br><span class="line">            <span class="keyword">if</span> (!localInteger.<span class="keyword">equals</span>(paramAnonymousFavoriteBean.getId())) &#123;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            BasicActivity.f(BasicActivity.<span class="keyword">this</span>).<span class="keyword">remove</span>(localInteger);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).b(Schedulers.computation()).a(AndroidSchedulers.a()).a(<span class="keyword">new</span> Action1()</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">a</span>(<span class="params">String paramAnonymousString</span>)</span> &#123;&#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>é€†å‘</category>
      </categories>
      <tags>
        <tag>åç¼–è¯‘</tag>
      </tags>
  </entry>
  <entry>
    <title>mac OSé…ç½®JAVAç¯å¢ƒ</title>
    <url>/2017/09/30/mac%20OS%E9%85%8D%E7%BD%AEJAVA%E7%8E%AF%E5%A2%83/</url>
    <content><![CDATA[<h2 id="mac-OSé…ç½®JAVAç¯å¢ƒ"><a href="#mac-OSé…ç½®JAVAç¯å¢ƒ" class="headerlink" title="mac OSé…ç½®JAVAç¯å¢ƒ"></a>mac OSé…ç½®JAVAç¯å¢ƒ</h2><ul>
<li><p>ä¸‹è½½å®‰è£…æœ€æ–°ç‰ˆçš„JDKå®‰è£…åŒ…:<a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html">http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html</a>,å®‰è£…å®ŒæˆåæŸ¥çœ‹ä¸‹Javaçš„ç‰ˆæœ¬åé¢é…ç½®è¦ç”¨åˆ°:<code>java -version</code></p>
  <figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">admindeMacBook-Pro:æœªå‘½åæ–‡ä»¶å¤¹ admin$ <span class="keyword">java </span>-version</span><br><span class="line"><span class="keyword">java </span>version <span class="string">&quot;1.8.0_144&quot;</span></span><br><span class="line"><span class="keyword">Java(TM) </span>SE Runtime Environment (<span class="keyword">build </span><span class="number">1</span>.<span class="number">8</span>.<span class="number">0</span>_144-<span class="keyword">b01)</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">Java </span>HotSpot(TM) <span class="number">64</span>-<span class="keyword">Bit </span>Server VM (<span class="keyword">build </span><span class="number">25</span>.<span class="number">144</span>-<span class="keyword">b01, </span>mixed mode)</span><br></pre></td></tr></table></figure></li>
<li><p>é…ç½®ç¯å¢ƒå˜é‡ï¼šåœ¨å‘½ä»¤è¡Œä¸­æ‰“å¼€<code>sudo vim ~/.bash_profile</code>ï¼Œåœ¨æ–‡ä»¶åé¢åŠ å…¥ä¸‹é¢å†…å®¹ï¼š</p>
  <figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> <span class="attribute">JAVA_HOME</span>=<span class="string">&quot;/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home&quot;</span> </span><br><span class="line"><span class="built_in">export</span> <span class="attribute">PATH</span>=<span class="string">&quot;<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span>&quot;</span> </span><br><span class="line"><span class="built_in">export</span> <span class="attribute">CLASSPATH</span>=<span class="string">&quot;.:<span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar&quot;</span></span><br></pre></td></tr></table></figure>
<p>  note:<code>/jdk1.8.0_144.jdk</code>é‡Œé¢çš„ç‰ˆæœ¬å­—ç¬¦ä¸²éœ€è¦æ›¿æ¢ä¸ºä¸Šé¢æåˆ°çš„ç‰ˆæœ¬å­—ç¬¦ä¸².<br>  å®Œæˆåä¿å­˜,å¹¶ä½¿ç”¨<code>source ~/.bash_profile</code>åº”ç”¨è¯¥å˜æ›´ã€‚</p>
</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>httpç›¸å…³å‘½ä»¤å·¥å…·</title>
    <url>/2017/09/15/http%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4%E5%B7%A5%E5%85%B7/</url>
    <content><![CDATA[<p>æµ‹è¯•æŸä¸ªç½‘å€æ˜¯å¦ä½¿ç”¨https:<br><code>nscurl --ats-diagnostics --verbose https://www.baidu.com</code></p>
]]></content>
      <categories>
        <category>HTTP</category>
      </categories>
  </entry>
  <entry>
    <title>Swiftå¯¹è±¡æ‹·è´</title>
    <url>/2017/09/15/Swift%E5%AF%B9%E8%B1%A1%E6%8B%B7%E8%B4%9D/</url>
    <content><![CDATA[<h2 id="Swiftå¯¹è±¡æ‹·è´"><a href="#Swiftå¯¹è±¡æ‹·è´" class="headerlink" title="Swiftå¯¹è±¡æ‹·è´"></a>Swiftå¯¹è±¡æ‹·è´</h2><h3 id="æ–¹æ³•ä¸€-å®ç°NSCopyingåè®®"><a href="#æ–¹æ³•ä¸€-å®ç°NSCopyingåè®®" class="headerlink" title="æ–¹æ³•ä¸€:å®ç°NSCopyingåè®®"></a>æ–¹æ³•ä¸€:å®ç°NSCopyingåè®®</h3><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Resume</span>: <span class="title class_ inherited__">NSObject</span>, <span class="title class_ inherited__">NSCopying</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> sex: <span class="type">String</span>?</span><br><span class="line">    <span class="keyword">var</span> age: <span class="type">String</span>?</span><br><span class="line">    <span class="keyword">var</span> timeArea: <span class="type">String</span>?</span><br><span class="line">    <span class="keyword">var</span> company: <span class="type">String</span>?</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å¿…é¡»è¦æœ‰ä¸€ä¸ªrequiredçš„åˆå§‹åŒ–æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init</span>(<span class="params">name</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">copy</span>(<span class="params">with</span> <span class="params">zone</span>: <span class="type">NSZone</span>? <span class="operator">=</span> <span class="literal">nil</span>) -&gt; <span class="keyword">Any</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> obj <span class="operator">=</span> <span class="built_in">type</span>(of: <span class="keyword">self</span>).<span class="keyword">init</span>(name: name)</span><br><span class="line">        obj.sex <span class="operator">=</span> sex</span><br><span class="line">        obj.age <span class="operator">=</span> age</span><br><span class="line">        obj.timeArea <span class="operator">=</span> timeArea</span><br><span class="line">        obj.company <span class="operator">=</span> company</span><br><span class="line">        <span class="keyword">return</span> obj</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨:<br><code>let ben = Resume.init(name: &quot;æœ¬åˆ&quot;)</code><br><code>var shu = ben.copy() as! Resume</code></p>
<h3 id="æ–¹æ³•äºŒ-å®ç°è‡ªå®šä¹‰æ‹·è´åè®®"><a href="#æ–¹æ³•äºŒ-å®ç°è‡ªå®šä¹‰æ‹·è´åè®®" class="headerlink" title="æ–¹æ³•äºŒ:å®ç°è‡ªå®šä¹‰æ‹·è´åè®®"></a>æ–¹æ³•äºŒ:å®ç°è‡ªå®šä¹‰æ‹·è´åè®®</h3><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protocol</span> <span class="title class_">Copyable</span> &#123;</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">copied</span>() -&gt; <span class="keyword">Self</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Book</span>: <span class="title class_ inherited__">Copyable</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> author: <span class="type">String</span>?</span><br><span class="line">    <span class="keyword">var</span> publish: <span class="type">String</span>?</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å¿…é¡»è¦æœ‰ä¸€ä¸ªrequiredçš„åˆå§‹åŒ–æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">init</span>(<span class="params">name</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">copied</span>() -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> obj <span class="operator">=</span> <span class="built_in">type</span>(of: <span class="keyword">self</span>).<span class="keyword">init</span>(name: name)</span><br><span class="line">        obj.name <span class="operator">=</span> name</span><br><span class="line">        obj.author <span class="operator">=</span> author</span><br><span class="line">        obj.publish <span class="operator">=</span> publish</span><br><span class="line">        <span class="keyword">return</span> obj</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨:<br><code>let sanguo = Book.init(name: &quot;three of kingdom&quot;)</code><br><code>let book = sanguo.copied()</code>  </p>
]]></content>
      <categories>
        <category>Swift</category>
      </categories>
  </entry>
  <entry>
    <title>Swiftå®ç°removeObject</title>
    <url>/2017/09/15/Swift%E5%AE%9E%E7%8E%B0removeObject/</url>
    <content><![CDATA[<h2 id="Swiftå®ç°removeObject"><a href="#Swiftå®ç°removeObject" class="headerlink" title="Swiftå®ç°removeObject"></a>Swiftå®ç°removeObject</h2><p>å¦‚æœç±»æ²¡æœ‰ç»§æ‰¿è‡ªNSObject,é‚£ä¹ˆç±»å¿…é¡»è¦å®ç°<code>Equatable</code>åè®®.å¦åˆ™ä¸éœ€è¦.</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span>!</span><br><span class="line">    <span class="keyword">var</span> subject: <span class="type">Subject</span>!</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">observer</span>(<span class="params">name</span>: <span class="type">String</span>, <span class="params">subject</span>: <span class="type">Subject</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">        <span class="keyword">self</span>.subject <span class="operator">=</span> subject</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">update</span>() &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">Observer</span>: <span class="title class_ inherited__">Equatable</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">func</span> <span class="title function_">==</span>(<span class="params">lhs</span>: <span class="type">Observer</span>, <span class="params">rhs</span>: <span class="type">Observer</span>) -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> lhs <span class="operator">===</span> rhs &#123; <span class="comment">//åœ°å€ç›¸ç­‰. ps:&quot;==&quot;å€¼ç›¸ç­‰.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨é€šè¿‡æ‰©å±•ç»™Arrayå¢åŠ ä¸€ä¸ª<code>removeObject(object: Element)</code>æ–¹æ³•:</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extension</span> <span class="keyword">Array</span> <span class="keyword">where</span> Element: Equatable &#123;</span><br><span class="line">    mutating func removeObject(<span class="keyword">object</span>: Element) &#123;</span><br><span class="line">        <span class="keyword">if</span> let <span class="keyword">index</span> = <span class="keyword">index</span>(<span class="keyword">of</span>: <span class="keyword">object</span>) &#123;</span><br><span class="line">            remove(at: <span class="keyword">index</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±äºArrayæ˜¯ç»“æ„ä½“ç±»å‹,è€ŒremoveObjectå‡½æ•°ä¼šæ”¹å˜ç»“æ„ä½“çš„å€¼,æ‰€ä»¥è¯¥å‡½æ•°éœ€è¦æ·»åŠ mutatingå…³é”®å­—.â€œNotice the use of the mutating keyword in the declaration of SimpleStructure to mark a method that modifies the structure. The declaration of SimpleClass doesnâ€™t need any of its methods marked as mutating because methods on a class can always modify the class.â€</p>
]]></content>
      <categories>
        <category>Swift</category>
      </categories>
  </entry>
  <entry>
    <title>Swift addTargetå‡½æ•°çš„Selectorå‚æ•°</title>
    <url>/2017/09/15/Swift%20addTarget%E5%87%BD%E6%95%B0%E7%9A%84Selector%E5%8F%82%E6%95%B0/</url>
    <content><![CDATA[<p>Swifté‡ŒaddTargetå‡½æ•°é‡Œçš„Selectorå‚æ•°å’ŒOCçš„ä¸å¤ªä¸€æ ·.<br><code>open func addTarget(_ target: Any?, action: Selector, for controlEvents: UIControlEvents)</code><br>æ ¹æ®Selectorçš„å®šä¹‰</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">struct</span> <span class="title class_">Selector</span> : <span class="title class_ inherited__">ExpressibleByStringLiteral</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Create a selector from a string.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(<span class="keyword">_</span> <span class="params">str</span>: <span class="type">String</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Create an instance initialized to `value`.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(<span class="params">unicodeScalarLiteral</span> <span class="params">value</span>: <span class="type">String</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Construct a selector from `value`.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(<span class="params">extendedGraphemeClusterLiteral</span> <span class="params">value</span>: <span class="type">String</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Create an instance initialized to `value`.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(<span class="params">stringLiteral</span> <span class="params">value</span>: <span class="type">String</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒæ˜¯ä¸€ä¸ªç»“æ„ä½“,å¹¶éµå®ˆ<code>ExpressibleByStringLiteral</code>åè®®,å› æ­¤å¯ä»¥ç›´æ¥ä¼ é€’ä¸€ä¸ªå­—é¢å€¼å­—ç¬¦ä¸².<br>ä¸è¿‡è¿™ä¸ªå­—ç¬¦ä¸²éœ€è¦éµå¾ªä¸€å®šçš„è§„åˆ™:</p>
<ol>
<li>å¦‚æœå‡½æ•°æ²¡æœ‰å‚æ•°,åˆ™å­—ç¬¦ä¸²çš„æ ¼å¼ä¸ºâ€å‡½æ•°åâ€.</li>
<li>å¦‚æœå‡½æ•°æœ‰å‚æ•°ä½†çœç•¥äº†å‚æ•°æ ‡ç­¾,åˆ™å­—ç¬¦ä¸²çš„æ ¼å¼ä¸ºâ€å‡½æ•°å:â€.</li>
<li>å¦‚æœå‡½æ•°æœ‰å‚æ•°å¹¶ä¸”æ²¡æœ‰çœç•¥å‚æ•°æ ‡ç­¾,åˆ™å­—ç¬¦ä¸²çš„æ ¼å¼ä¸ºâ€å‡½æ•°åWithå‚æ•°æ ‡ç­¾:â€.ps:å¦‚æœå‡½æ•°ä½¿ç”¨çš„æ˜¯é»˜è®¤å‚æ•°æ ‡ç­¾å³ä½¿ç”¨å‚æ•°åç§°ä½œä¸ºå‚æ•°æ ‡ç­¾çš„,é‚£ä¹ˆå­—ç¬¦ä¸²çš„æ ¼å¼ä¸ºâ€å‡½æ•°åWithå‚æ•°åç§°:â€</li>
</ol>
<p>ä¸¾ä¸ªä¾‹å­:  </p>
<ol>
<li>æ²¡æœ‰å‚æ•°<figure class="highlight livescript"><table><tr><td class="code"><pre><span class="line">func numberSliderChanged<span class="function"><span class="params">()</span> -&gt;</span> Void &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
å¯¹åº”å†™æ³•:<code>numberSlider.addTarget(self, action: &quot;numberSliderChanged&quot;, for: .valueChanged)</code></li>
<li>çœç•¥å‚æ•°æ ‡ç­¾<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">numberSliderChanged</span>(<span class="keyword">_</span> <span class="params">sender</span>: <span class="type">UISlider</span>) -&gt; <span class="type">Void</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;---&quot;</span>, sender.value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
å¯¹åº”å†™æ³•:<code>numberSlider.addTarget(self, action: &quot;numberSliderChanged:&quot;, for: .valueChanged)</code></li>
<li>å†™æ˜äº†å‚æ•°æ ‡ç­¾slider.<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">numberSliderChanged</span>(<span class="params">slider</span> <span class="params">sender</span>: <span class="type">UISlider</span>) -&gt; <span class="type">Void</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(sender.value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
å¯¹åº”å†™æ³•:<code>numberSlider.addTarget(self, action: &quot;numberSliderChangedWithSlider:&quot;, for: .valueChanged)</code></li>
<li>ä½¿ç”¨é»˜è®¤å‚æ•°æ ‡ç­¾<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">numberSliderChanged</span>(<span class="params">sender</span>: <span class="type">UISlider</span>) -&gt; <span class="type">Void</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;sds&quot;</span>, sender.value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
å¯¹åº”å†™æ³•:<code>numberSlider.addTarget(self, action: &quot;numberSliderChangedWithSender:&quot;, for: .valueChanged)</code></li>
</ol>
<p>ç„¶è€Œè¿™ç§å†™æ³•å·²ç»åºŸå¼ƒ,ç›®å‰swift3.1æ¨èçš„æ˜¯ä½¿ç”¨<code>#selector</code>,å› æ­¤ä¸Šè¿°4å†™æ³•ç­‰ä»·äº:<br><code>numberSlider.addTarget(self, action: #selector(numberSliderChanged(sender:)), for: .valueChanged)</code>.<br>å½“ç„¶ä½ ä¹Ÿå¯ä»¥ä¼ é€’ä¸€ä¸ªSelectorç±»å‹çš„å˜é‡:<br><code>numberSlider.addTarget(self, action: Selector.init(stringLiteral: &quot;numberSliderChangedWithSender:&quot;), for: .valueChanged)</code>.ä¸è¿‡è¿™ç§å†™æ³•ä¾ç„¶ä¸æ˜¯æ¨èçš„å†™æ³•.</p>
]]></content>
      <categories>
        <category>Swift</category>
      </categories>
  </entry>
  <entry>
    <title>Swiftåè®®</title>
    <url>/2017/09/12/Swift%E5%8D%8F%E8%AE%AE/</url>
    <content><![CDATA[<h2 id="åè®®"><a href="#åè®®" class="headerlink" title="åè®®"></a>åè®®</h2><h3 id="å¯é€‰å®ç°"><a href="#å¯é€‰å®ç°" class="headerlink" title="å¯é€‰å®ç°"></a>å¯é€‰å®ç°</h3><p>Swifté‡Œæ ‡è®°æŸä¸ªæ–¹æ³•ä¸ºå¯é€‰å®ç°æ—¶,éœ€è¦åœ¨åè®®å‰æ·»åŠ <code>@objc</code>,å¹¶ä¸”åœ¨å¯é€‰æ–¹æ³•å‰æ·»åŠ <code>@objc optional</code>.å…¶å®ä¹Ÿæ˜¯ä¸ºäº†è·ŸOCå…¼å®¹.<br>eg:</p>
<figure class="highlight livescript"><table><tr><td class="code"><pre><span class="line">@objc protocol Iterator &#123;</span><br><span class="line">    func first<span class="function"><span class="params">()</span> -&gt;</span> AnyObject?</span><br><span class="line">    </span><br><span class="line">    func next<span class="function"><span class="params">()</span> -&gt;</span> AnyObject?</span><br><span class="line">    </span><br><span class="line">    @objc optional func isDone<span class="function"><span class="params">()</span> -&gt;</span> Bool</span><br><span class="line">    </span><br><span class="line">    func currentItem<span class="function"><span class="params">()</span> -&gt;</span> AnyObject?</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ¤æ–­æŸä¸ªå®ä¾‹æ˜¯å¦å®ç°äº†åè®®é‡Œçš„å¯é€‰æ–¹æ³•:</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> i.isDone?() != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\(i) å®ç°äº†æ–¹æ³•isDone&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\(i) æ²¡å®ç°æ–¹æ³•isDone&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºisDoneæ˜¯å¯é€‰å®ç°æ–¹æ³•,æ‰€ä»¥è°ƒç”¨æ—¶éœ€è¦åŠ ?,è¿™æ ·å°±è½¬ä¸ºoptional chainingå¤„ç†,å¦‚æœæ–¹æ³•çš„è¿”å›å€¼ä¸ä¸ºnil,åˆ™è¯´æ˜å¯¹è±¡å®ç°äº†åè®®çš„å¯é€‰å®ç°æ–¹æ³•.</p>
]]></content>
      <categories>
        <category>Swift</category>
      </categories>
      <tags>
        <tag>åè®®</tag>
        <tag>protocol</tag>
      </tags>
  </entry>
  <entry>
    <title>CocoaPodså¸¸è§é—®é¢˜</title>
    <url>/2017/09/10/CocoaPods%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<p>Q:åœ¨ç”¨ Cocoapods åšç¬¬ä¸‰æ–¹å¼€æºåº“ç®¡ç†çš„æ—¶å€™ï¼Œæœ‰æ—¶å€™å‘ç°æŸ¥æ‰¾åˆ°çš„ç¬¬ä¸‰æ–¹åº“ç‰ˆæœ¬ä½äºgithubä¸Šä»“åº“çš„æœ€æ–°releaseç‰ˆæœ¬.<br>A:æ‰§è¡Œ<code>pod update</code>æ›´æ–°æœ¬åœ°ä»“åº“ï¼Œå®Œæˆåï¼Œå³å¯æœç´¢åˆ°æŒ‡å®šçš„ç¬¬ä¸‰æ–¹åº“.  </p>
<p>Q:åœ¨ä½¿ç”¨äº†<code>pod setup</code>ä¹‹åï¼Œå‘ç°å¥½é•¿æ—¶é—´éƒ½æ²¡æœ‰å˜åŒ–ï¼Œæ— æ³•ä»ç»ˆç«¯ä¸Šè·å–<code>pod setup</code>çš„æ‰§è¡Œæƒ…å†µ.<br>A:è¿™æ—¶å€™å¯ä»¥command+Næ–°å»ºä¸€ä¸ªçª—å£ï¼Œé€šè¿‡<code>sudo ls</code>ç”¨ç®¡ç†å‘˜æƒé™æŸ¥çœ‹ç›®å½•,ç„¶å<code>cd .cocoapods</code>æ–‡ä»¶å¤¹ï¼Œè¾“å…¥<code>du -sh</code>å‘½ä»¤æŸ¥çœ‹æ–‡ä»¶å¤¹å¤§å°å˜åŒ–ï¼Œä»è€Œç¡®å®š<code>pod setup</code>çš„è¿è¡Œæƒ…å†µ.</p>
<p>note:åœ¨Podfileæ–‡ä»¶ä¸­çš„<code>platform :ios, &#39;7.0&#39;</code>,å¦‚æœä½ è®¾ç½®çš„iOSç³»ç»Ÿè¿‡ä½,å¯èƒ½æœ‰çš„ç¬¬ä¸‰æ–¹åº“ä¼šä¸‹è½½ä¸ä¸‹æ¥.æ‰€ä»¥è¿˜æ˜¯è¦çœ‹ä¸€ä¸‹ç¬¬ä¸‰æ–¹åº“çš„æœ€ä½ç‰ˆæœ¬æ”¯æŒè¯´æ˜.</p>
<p>Q:RuntimeError - [Xcodeproj] Unknown object version.ç„¶åæ˜¯ä¸€å¤§å †é”™è¯¯æ—¥å¿—.ä¸ç®¡æ˜¯é‡æ–°ä»svn checkoutä¸€ä»½æ–°çš„è¿˜æ˜¯æ€æ ·,pod installéƒ½ä¸èƒ½æˆåŠŸ.<br>A:ä¸€ç§è§£å†³åŠæ³•:é‡æ–°å®‰è£…cocoapods.</p>
<p>Q:pod search xxxï¼Œæ€»æ˜¯å¤±è´¥ï¼Œæç¤ºCDN: trunk URL couldnâ€™t be downloaded â€¦ Response: SSL connect error</p>
<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">[<span class="operator">!</span>] <span class="params">CDN:</span> trunk Repo update failed <span class="operator">-</span> <span class="number">2</span> error(s):</span><br><span class="line"><span class="params">CDN:</span> trunk URL couldn&#x27;t be <span class="params">downloaded:</span> https:<span class="symbol">//cdn.jsdelivr.net/cocoa/Specs/7/1/d/lottie-ios/4.4.0/lottie-ios.podspec.json</span> <span class="params">Response:</span> SSL connect error</span><br><span class="line"><span class="params">CDN:</span> trunk URL couldn&#x27;t be <span class="params">downloaded:</span> https:<span class="symbol">//cdn.jsdelivr.net/cocoa/Specs/7/1/d/lottie-ios/4.4.1/lottie-ios.podspec.json</span> <span class="params">Response:</span> SSL connect error</span><br></pre></td></tr></table></figure>
<p>è§£å†³åŠæ³•ï¼š</p>
<p>The workaround to get working locally during this outage or CDN issue - guessing a DNS change or something?:</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">pod repo <span class="built_in">remove</span> trunk</span><br></pre></td></tr></table></figure>
<p>In <code>Podfile</code></p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"><span class="keyword">source</span> <span class="string">&#x27;https://github.com/CocoaPods/Specs.git&#x27;</span></span><br><span class="line"># <span class="keyword">source</span> <span class="string">&#x27;https://cdn.cocoapods.org/&#x27;</span></span><br></pre></td></tr></table></figure>
<p>Then <code>pod install</code> and <code>pod repo update</code> will work again.</p>
<p>Later, when CDN is working again:</p>
<figure class="highlight smali"><table><tr><td class="code"><pre><span class="line">pod repo<span class="built_in"> add-cdn </span>trunk https://cdn.cocoapods.org/</span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/CocoaPods/CocoaPods/issues/10078#issuecomment-696481185">Intermittent CDN issues</a></p>
]]></content>
      <categories>
        <category>CocoaPods</category>
      </categories>
      <tags>
        <tag>CocoaPods</tag>
      </tags>
  </entry>
  <entry>
    <title>can&#39;t find gem cocoapods (&gt;= 0.a)</title>
    <url>/2017/09/10/can&#39;t%20find%20gem%20cocoapods/</url>
    <content><![CDATA[<h2 id="æ›´æ–°rubyå-pod-installå‡ºé”™"><a href="#æ›´æ–°rubyå-pod-installå‡ºé”™" class="headerlink" title="æ›´æ–°rubyå,pod installå‡ºé”™."></a>æ›´æ–°rubyå,pod installå‡ºé”™.</h2><p>xuequandeiMac:KingDynastyGaming xuequan$ pod install<br>æç¤º:</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">/Library/Ruby/Site/<span class="number">2.0</span><span class="number">.0</span>/rubygems.rb:<span class="number">270</span>:<span class="keyword">in</span> `find_spec_for_ex<span class="string">e&#x27;: can&#x27;</span>t find gem cocoapods (&gt;= <span class="number">0.</span>a) (Gem::GemNotFoundException) <span class="keyword">from</span> /Library/Ruby/Site/<span class="number">2.0</span><span class="number">.0</span>/rubygems.rb:<span class="number">298</span>:<span class="keyword">in</span> `activate_bin_path<span class="string">&#x27; from /usr/local/bin/pod:22:in `&lt;main&gt;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>è§£å†³åŠæ³•:å¸è½½cocoapodsåé‡æ–°å®‰è£…</p>
<ol>
<li>sudo gem uninstall cocoapods</li>
<li>gem install cocoapods</li>
<li>pod install</li>
</ol>
]]></content>
      <categories>
        <category>CocoaPods</category>
      </categories>
      <tags>
        <tag>CocoaPods</tag>
      </tags>
  </entry>
  <entry>
    <title>å¤šä¸ªtargetsçš„Podfileå†™æ³•</title>
    <url>/2017/09/08/%E5%A4%9A%E4%B8%AAtargets%E7%9A%84Podfile%E5%86%99%E6%B3%95/</url>
    <content><![CDATA[<h2 id="å¤šä¸ªtargetsçš„Podfileå†™æ³•"><a href="#å¤šä¸ªtargetsçš„Podfileå†™æ³•" class="headerlink" title="å¤šä¸ªtargetsçš„Podfileå†™æ³•"></a>å¤šä¸ªtargetsçš„Podfileå†™æ³•</h2><p>é¡¹ç›®é‡Œé¢æ·»åŠ äº†å¤šä¸ªtarget,æ¯æ¬¡pod installå,å…¶ä»–targetå°±å‡ºç°æ‰¾ä¸åˆ°<code>#import &lt;AFNetworking.h&gt;</code>è¿™æ ·çš„ç¼–è¯‘é”™è¯¯,èŠ±äº†ä¸‰ä¸ªå¤šå°æ—¶æ‰æ‰¾åˆ°äº†åŸå› :æ˜¯å› ä¸ºPodfileæ–‡ä»¶åªç»™å…¶ä¸­ä¸€ä¸ªtargeté…ç½®äº†,æ‰€ä»¥å¯¼è‡´äº†ä¸Šè¿°çš„é—®é¢˜.<br>æ­£ç¡®å†™æ³•: </p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">platform</span> :ios, &#x27;<span class="number">8</span>.<span class="number">0</span>&#x27;</span><br><span class="line"></span><br><span class="line"><span class="attribute">def</span> shared_pods</span><br><span class="line">    <span class="attribute">pod</span> &#x27;AFNetworking&#x27;, &#x27;<span class="number">3</span>.<span class="number">1</span>.<span class="number">0</span>&#x27;</span><br><span class="line">    <span class="attribute">pod</span> &#x27;MJExtension&#x27;, &#x27;<span class="number">3</span>.<span class="number">0</span>.<span class="number">13</span>&#x27;</span><br><span class="line">    <span class="attribute">pod</span> &#x27;SDWebImage&#x27;, &#x27;<span class="number">4</span>.<span class="number">0</span>.<span class="number">0</span>&#x27;</span><br><span class="line">    <span class="attribute">pod</span> &#x27;FMDB&#x27;, &#x27;<span class="number">2</span>.<span class="number">6</span>.<span class="number">2</span>&#x27;</span><br><span class="line">    <span class="attribute">pod</span> &#x27;MJRefresh&#x27;, &#x27;<span class="number">3</span>.<span class="number">1</span>.<span class="number">12</span>&#x27;</span><br><span class="line">    <span class="attribute">pod</span> &#x27;SDCycleScrollView&#x27;, &#x27;<span class="number">1</span>.<span class="number">66</span>&#x27;</span><br><span class="line">    <span class="attribute">pod</span> &#x27;Bugly&#x27;, &#x27;<span class="number">2</span>.<span class="number">4</span>.<span class="number">8</span>&#x27;</span><br><span class="line">    <span class="attribute">pod</span> &#x27;MBProgressHUD&#x27;, &#x27;<span class="number">1</span>.<span class="number">0</span>.<span class="number">0</span>&#x27;</span><br><span class="line">    <span class="attribute">pod</span> &#x27;Masonry&#x27;, &#x27;<span class="number">1</span>.<span class="number">0</span>.<span class="number">2</span>&#x27;</span><br><span class="line">    <span class="attribute">pod</span> &#x27;IQKeyboardManager&#x27;, &#x27;<span class="number">4</span>.<span class="number">0</span>.<span class="number">9</span>&#x27;</span><br><span class="line">    <span class="attribute">pod</span> &#x27;TZImagePickerController&#x27;, &#x27;<span class="number">1</span>.<span class="number">7</span>.<span class="number">9</span>&#x27;</span><br><span class="line">    <span class="attribute">pod</span> &#x27;RealReachability&#x27;, &#x27;<span class="number">1</span>.<span class="number">1</span>.<span class="number">9</span>&#x27;</span><br><span class="line">    <span class="attribute">pod</span> &#x27;MMDrawerController&#x27;, &#x27;<span class="number">0</span>.<span class="number">6</span>.<span class="number">0</span>&#x27;</span><br><span class="line">    <span class="attribute">pod</span> &#x27;UMengAnalytics-NO-IDFA&#x27;</span><br><span class="line"><span class="attribute">end</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">target</span> &#x27;xxx1&#x27; do</span><br><span class="line">    <span class="attribute">shared_pods</span></span><br><span class="line"><span class="attribute">end</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">target</span> &#x27;xxx2&#x27; do</span><br><span class="line">    <span class="attribute">shared_pods</span></span><br><span class="line"><span class="attribute">end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å‚è€ƒ:<a href="http://www.jianshu.com/p/aa24cb9644a0">CocoaPodsä½¿ç”¨æ³¨æ„äº‹é¡¹</a></p>
]]></content>
      <categories>
        <category>CocoaPods</category>
      </categories>
      <tags>
        <tag>CocoaPods</tag>
      </tags>
  </entry>
  <entry>
    <title>UITableView-FDTemplateLayoutCellæºç åˆ†æ</title>
    <url>/2017/09/04/UITableView-FDTemplateLayoutCell%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h2 id="é«˜åº¦çš„è®¡ç®—"><a href="#é«˜åº¦çš„è®¡ç®—" class="headerlink" title="é«˜åº¦çš„è®¡ç®—"></a>é«˜åº¦çš„è®¡ç®—</h2><p>é€šè¿‡ä»å¯é‡ç”¨é˜Ÿåˆ—é‡Œå‡ºåˆ—ä¸€ä¸ªcell,å¹¶å°†è¯¥cellé…ç½®å¥½è¦å±•ç¤ºçš„æ•°æ®å(ps:åœ¨ä½¿ç”¨æ—¶å¦‚æœæœ‰ä¸€äº›ä¼šå½±å“cellé«˜åº¦çš„ä»£ç æ²¡æœ‰åŒ…æ‹¬åœ¨é…ç½®blocké‡Œå°†å¯¼è‡´è®¡ç®—ä¸å‡†),å¼€å§‹è®¡ç®—cellçš„é«˜åº¦:</p>
<ol>
<li><p>ç»™cellæ·»åŠ çº¦æŸ:<br><code>NSLayoutConstraint *widthFenceConstraint = [NSLayoutConstraint constraintWithItem:cell.contentView attribute:NSLayoutAttributeWidth relatedBy:NSLayoutRelationEqual toItem:nil attribute:NSLayoutAttributeNotAnAttribute multiplier:1.0 constant:contentViewWidth];</code><br>å¯¹äº10.2ä»¥ä¸Šç³»ç»Ÿè¿˜éœ€æ·»åŠ cellä¸Šä¸‹å·¦å³çš„çº¦æŸ:</p>
 <figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (isSystemVersionEqualOrGreaterThen10_2) &#123;</span><br><span class="line">            <span class="comment">// To avoid confilicts, make width constraint softer than required (1000)</span></span><br><span class="line">            widthFenceConstraint.priority = <span class="built_in">UILayoutPriorityRequired</span> - <span class="number">1</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Build edge constraints</span></span><br><span class="line">            <span class="built_in">NSLayoutConstraint</span> *leftConstraint = [<span class="built_in">NSLayoutConstraint</span> constraintWithItem:cell.contentView attribute:<span class="built_in">NSLayoutAttributeLeft</span> relatedBy:<span class="built_in">NSLayoutRelationEqual</span> toItem:cell attribute:<span class="built_in">NSLayoutAttributeLeft</span> multiplier:<span class="number">1.0</span> constant:<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">NSLayoutConstraint</span> *rightConstraint = [<span class="built_in">NSLayoutConstraint</span> constraintWithItem:cell.contentView attribute:<span class="built_in">NSLayoutAttributeRight</span> relatedBy:<span class="built_in">NSLayoutRelationEqual</span> toItem:cell attribute:<span class="built_in">NSLayoutAttributeRight</span> multiplier:<span class="number">1.0</span> constant:accessroyWidth];</span><br><span class="line">            <span class="built_in">NSLayoutConstraint</span> *topConstraint = [<span class="built_in">NSLayoutConstraint</span> constraintWithItem:cell.contentView attribute:<span class="built_in">NSLayoutAttributeTop</span> relatedBy:<span class="built_in">NSLayoutRelationEqual</span> toItem:cell attribute:<span class="built_in">NSLayoutAttributeTop</span> multiplier:<span class="number">1.0</span> constant:<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">NSLayoutConstraint</span> *bottomConstraint = [<span class="built_in">NSLayoutConstraint</span> constraintWithItem:cell.contentView attribute:<span class="built_in">NSLayoutAttributeBottom</span> relatedBy:<span class="built_in">NSLayoutRelationEqual</span> toItem:cell attribute:<span class="built_in">NSLayoutAttributeBottom</span> multiplier:<span class="number">1.0</span> constant:<span class="number">0</span>];</span><br><span class="line">            edgeConstraints = @[leftConstraint, rightConstraint, topConstraint, bottomConstraint];</span><br><span class="line">            [cell addConstraints:edgeConstraints];</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ç³»ç»ŸAPI<code>systemLayoutSizeFittingSize</code>è®¡ç®—å‡ºé«˜åº¦:<code>fittingHeight = [cell.contentView systemLayoutSizeFittingSize:UILayoutFittingCompressedSize].height;</code></p>
</li>
<li><p>ç§»é™¤ä¹‹å‰æ·»åŠ çš„çº¦æŸ:  </p>
 <figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="selector-attr">[cell.contentView removeConstraint:widthFenceConstraint]</span>;</span><br><span class="line">if (isSystemVersionEqualOrGreaterThen10_2) &#123;</span><br><span class="line">    <span class="selector-attr">[cell removeConstraints:edgeConstraints]</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>æœ€ç»ˆå¾—åˆ°cellçš„é«˜åº¦.</p>
<h2 id="é«˜åº¦ç¼“å­˜çš„å®ç°"><a href="#é«˜åº¦ç¼“å­˜çš„å®ç°" class="headerlink" title="é«˜åº¦ç¼“å­˜çš„å®ç°"></a>é«˜åº¦ç¼“å­˜çš„å®ç°</h2><p>é€šè¿‡ç»™UITableViewå¢åŠ ä¸€ä¸ªç±»åˆ«<code>(FDIndexPathHeightCache)</code>:  </p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="variable">@interface</span> UITableView (FDIndexPathHeightCache)</span><br><span class="line"><span class="comment">/// Height cache by index path. Generally, you don&#x27;t need to use it directly.</span></span><br><span class="line"><span class="variable">@property</span> (nonatomic, strong, readonly) FDIndexPathHeightCache *fd_indexPathHeightCache;</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure>
<p>ç±»åˆ«é‡Œæœ‰ä¸€ä¸ª<code>FDIndexPathHeightCache</code>ç±»å‹çš„å±æ€§<code>fd_indexPathHeightCache</code>æ˜¯åªè¯»çš„,ç”¨äºæ“ä½œç¼“å­˜:è®¾ç½®ç¼“å­˜,å–å‡ºç¼“å­˜,æ¸…é™¤ç¼“å­˜,æŸ¥è¯¢æŸä¸ªç¼“å­˜æ˜¯å¦å­˜åœ¨ç­‰.<code>FDIndexPathHeightCache</code>å†…éƒ¨æ‰©å±•å®šä¹‰äº†ä¸€ä¸ªç”¨äºä¿å­˜ç¼“å­˜çš„äºŒç»´æ•°ç»„.ä»¥åå–ç¼“å­˜æ—¶æ˜¯ä»è¯¥äºŒç»´æ•°ç»„å–å¾—.é»˜è®¤é«˜åº¦æ˜¯-1,å³è¯¥è¡Œcellè¿˜æœªç¼“å­˜é«˜åº¦.</p>
<h2 id="ç¼“å­˜é«˜åº¦çš„æ¸…é™¤æ—¶æœº"><a href="#ç¼“å­˜é«˜åº¦çš„æ¸…é™¤æ—¶æœº" class="headerlink" title="ç¼“å­˜é«˜åº¦çš„æ¸…é™¤æ—¶æœº"></a>ç¼“å­˜é«˜åº¦çš„æ¸…é™¤æ—¶æœº</h2><p>å®šä¹‰äº†ä¸€ä¸ªç±»åˆ«<code>FDIndexPathHeightCacheInvalidation</code>,è¯¥ç±»åˆ«é€šè¿‡method swizzleäº¤æ¢äº†ä¸€äº›ç³»ç»Ÿæ–¹æ³•çš„å®ç°.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="comment">// All methods that trigger height cache&#x27;s invalidation</span></span><br><span class="line">    SEL selectors[] = &#123;</span><br><span class="line">        <span class="meta">@selector(reloadData)</span>,</span><br><span class="line">        <span class="meta">@selector(insertSections:withRowAnimation:)</span>,</span><br><span class="line">        <span class="meta">@selector(deleteSections:withRowAnimation:)</span>,</span><br><span class="line">        <span class="meta">@selector(reloadSections:withRowAnimation:)</span>,</span><br><span class="line">        <span class="meta">@selector(moveSection:toSection:)</span>,</span><br><span class="line">        <span class="meta">@selector(insertRowsAtIndexPaths:withRowAnimation:)</span>,</span><br><span class="line">        <span class="meta">@selector(deleteRowsAtIndexPaths:withRowAnimation:)</span>,</span><br><span class="line">        <span class="meta">@selector(reloadRowsAtIndexPaths:withRowAnimation:)</span>,</span><br><span class="line">        <span class="meta">@selector(moveRowAtIndexPath:toIndexPath:)</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">NSUInteger</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; sizeof(selectors) / sizeof(SEL); ++index) &#123;</span><br><span class="line">        <span class="type">SEL</span> <span class="variable">originalSelector</span> <span class="operator">=</span> selectors[index];</span><br><span class="line">        <span class="type">SEL</span> <span class="variable">swizzledSelector</span> <span class="operator">=</span> NSSelectorFromString([@<span class="string">&quot;fd_&quot;</span> stringByAppendingString:NSStringFromSelector(originalSelector)]);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">originalMethod</span> <span class="operator">=</span> class_getInstanceMethod(self, originalSelector);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">swizzledMethod</span> <span class="operator">=</span> class_getInstanceMethod(self, swizzledSelector);</span><br><span class="line">        method_exchangeImplementations(originalMethod, swizzledMethod);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)fd_reloadData &#123;</span><br><span class="line">    <span class="keyword">if</span> (self.fd_indexPathHeightCache.automaticallyInvalidateEnabled) &#123;</span><br><span class="line">        [self.fd_indexPathHeightCache enumerateAllOrientationsUsingBlock:^(FDIndexPathHeightsBySection *heightsBySection) &#123;</span><br><span class="line">            [heightsBySection removeAllObjects];</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">    FDPrimaryCall([self fd_reloadData];);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“è°ƒç”¨è¿™äº›å¯èƒ½ä¼šå½±å“cellé«˜åº¦çš„æ–¹æ³•æ—¶,å°±ä¼šå°†ç¼“å­˜æ¸…é™¤.</p>
<h2 id="bug"><a href="#bug" class="headerlink" title="bug"></a>bug</h2><p>åœ¨iOS 10.2ä»¥ä¸Šå¯èƒ½ä¼šå‡ºç°å´©æºƒ,å´©æºƒåœ¨<code>systemLayoutSizeFittingSize:</code>å¤„.ä¸€ç§è§£å†³åŠæ³•:è®¾ç½®cellä¸­labelçš„preferredMaxLayoutWidthå±æ€§.</p>
]]></content>
      <categories>
        <category>æºç åˆ†æ</category>
      </categories>
      <tags>
        <tag>UITableView-FDTemplateLayoutCell</tag>
      </tags>
  </entry>
  <entry>
    <title>æ•°å€¼è®¡ç®—</title>
    <url>/2017/08/28/%E6%95%B0%E5%80%BC%E8%AE%A1%E7%AE%97/</url>
    <content><![CDATA[<h2 id="å››èˆäº”å…¥ä¿ç•™ä¸¤ä½å°æ•°"><a href="#å››èˆäº”å…¥ä¿ç•™ä¸¤ä½å°æ•°" class="headerlink" title="å››èˆäº”å…¥ä¿ç•™ä¸¤ä½å°æ•°"></a>å››èˆäº”å…¥ä¿ç•™ä¸¤ä½å°æ•°</h2><p><code>NSString *strOdds = [NSString stringWithFormat:@&quot;%.2f&quot;, odds]; //ä¿ç•™ä¸¤ä½å°æ•°</code><br>è¯¥æ–¹æ³•ä¼šå››èˆäº”å…¥ä¿ç•™ä¸¤ä½å°æ•°,ä¸è¶³ä¸¤ä½å°æ•°åé¢è¡¥0.å¦‚æœæƒ³åœ¨å››èˆäº”å…¥æ—¶å»æ‰å°æ•°ç‚¹åå¤šä½™çš„0,å¯ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•:</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">NSString</span> *)roundingAfterPoint:(<span class="built_in">NSInteger</span>)position roudingMode:(<span class="built_in">NSRoundingMode</span>)roundingMode</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSDecimalNumberHandler</span> *roundingBehavior = [<span class="built_in">NSDecimalNumberHandler</span> decimalNumberHandlerWithRoundingMode:roundingMode scale:position raiseOnExactness:<span class="literal">NO</span> raiseOnOverflow:<span class="literal">NO</span> raiseOnUnderflow:<span class="literal">NO</span> raiseOnDivideByZero:<span class="literal">NO</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="type">float</span> f_price = <span class="keyword">self</span>.floatValue;</span><br><span class="line">    <span class="built_in">NSDecimalNumber</span> *ouncesDecimal = [[<span class="built_in">NSDecimalNumber</span> alloc] initWithFloat:f_price];</span><br><span class="line">    <span class="built_in">NSDecimalNumber</span> *roundedOunces = [ouncesDecimal decimalNumberByRoundingAccordingToBehavior:roundingBehavior];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSString</span> *rs = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;%@&quot;</span>,roundedOunces];</span><br><span class="line">    <span class="keyword">return</span> rs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨:<br><code>NSString *rs = [self roundingAfterPoint:2 roudingMode:NSRoundPlain];</code></p>
<p>åœ¨è¿›è¡Œæµ®ç‚¹å‹æ•°å€¼è®¡ç®—æ—¶æœ€å¥½ç»Ÿä¸€ç±»å‹,æ¯”å¦‚å…¨éƒ¨ç»Ÿä¸€ä¸ºfloatè®¡ç®—,æˆ–å…¨éƒ¨ä¸ºdoubleå‹è®¡ç®—.å¦åˆ™å¯èƒ½ä¼šå‡ºç°è¯¯å·®,å¯¼è‡´è®¡ç®—ä¸ä¸€è‡´.</p>
<h2 id="æµ®ç‚¹å‹æ•°å€¼å–æ•´"><a href="#æµ®ç‚¹å‹æ•°å€¼å–æ•´" class="headerlink" title="æµ®ç‚¹å‹æ•°å€¼å–æ•´"></a>æµ®ç‚¹å‹æ•°å€¼å–æ•´</h2><ul>
<li>roundï¼šå¦‚æœå‚æ•°æ˜¯å°æ•°ï¼Œåˆ™æ±‚æœ¬èº«çš„å››èˆäº”å…¥ã€‚</li>
<li>ceilï¼šå¦‚æœå‚æ•°æ˜¯å°æ•°ï¼Œåˆ™æ±‚æœ€å°çš„æ•´æ•°ä½†ä¸å°äºæœ¬èº«.</li>
<li>floorï¼šå¦‚æœå‚æ•°æ˜¯å°æ•°ï¼Œåˆ™æ±‚æœ€å¤§çš„æ•´æ•°ä½†ä¸å¤§äºæœ¬èº«. </li>
</ul>
<p>Example:å¦‚æœå€¼æ˜¯3.4çš„è¯ï¼Œåˆ™round 3.000000, ceil 4.000000, floor 3.00000</p>
<p>å¦å¤–,å¼ºåˆ¶å–æ•´<code>(int)3.4 = 3</code>,ç›´æ¥ä¸¢å¼ƒå°æ•°ä½ä»…ä¿ç•™æ•´æ•°ä½,ç±»ä¼¼äºfloorå‡½æ•°.</p>
]]></content>
      <categories>
        <category>æ•°å€¼è®¡ç®—</category>
      </categories>
      <tags>
        <tag>æ•°å€¼è®¡ç®—</tag>
      </tags>
  </entry>
  <entry>
    <title>swiftå°è£…æ‰“å°å‡½æ•°</title>
    <url>/2017/08/21/swift%E5%B0%81%E8%A3%85%E6%89%93%E5%8D%B0%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<h2 id="swiftå°è£…æ‰“å°å‡½æ•°"><a href="#swiftå°è£…æ‰“å°å‡½æ•°" class="headerlink" title="swiftå°è£…æ‰“å°å‡½æ•°"></a>swiftå°è£…æ‰“å°å‡½æ•°</h2><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> dateFormatter <span class="operator">=</span> <span class="type">DateFormatter</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ—¥å¿—æ‰“å°</span></span><br><span class="line"><span class="keyword">func</span> <span class="title function_">DLog</span>&lt;<span class="type">T</span>&gt;(<span class="keyword">_</span> <span class="params">message</span>:<span class="type">T</span>, <span class="params">file</span>:<span class="type">String</span> <span class="operator">=</span> <span class="keyword">#file</span>, <span class="params">function</span>:<span class="type">String</span> <span class="operator">=</span> <span class="keyword">#function</span>, <span class="params">line</span>:<span class="type">Int</span> <span class="operator">=</span> <span class="keyword">#line</span>) &#123;</span><br><span class="line">    <span class="keyword">#if</span> <span class="type">DEBUG</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è·å–æ–‡ä»¶å</span></span><br><span class="line">    <span class="keyword">let</span> fileName <span class="operator">=</span> (file <span class="keyword">as</span> <span class="type">NSString</span>).lastPathComponent</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¸ºæ—¥æœŸæ ¼å¼å™¨è®¾ç½®æ ¼å¼å­—ç¬¦ä¸²</span></span><br><span class="line">    dateFormatter.dateFormat <span class="operator">=</span> <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨æ—¥æœŸæ ¼å¼å™¨æ ¼å¼åŒ–å½“å‰æ—¥æœŸã€æ—¶é—´</span></span><br><span class="line">    <span class="keyword">let</span> datestr <span class="operator">=</span> dateFormatter.string(from: <span class="type">Date</span>())</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ—¥å¿—å†…å®¹</span></span><br><span class="line">    <span class="keyword">let</span> consoleStr <span class="operator">=</span> <span class="string">&quot;<span class="subst">\(datestr)</span> [<span class="subst">\(fileName)</span>:<span class="subst">\(line)</span>][<span class="subst">\(function)</span>]<span class="subst">\(message)</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ‰“å°æ—¥å¿—å†…å®¹</span></span><br><span class="line">    <span class="built_in">print</span>(consoleStr)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">#endif</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æ‰“å°å¯¹è±¡åœ°å€"><a href="#æ‰“å°å¯¹è±¡åœ°å€" class="headerlink" title="æ‰“å°å¯¹è±¡åœ°å€"></a>æ‰“å°å¯¹è±¡åœ°å€</h2><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extension</span> <span class="title class_">String</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">func</span> <span class="title function_">pointer</span>(<span class="keyword">_</span> <span class="params">object</span>: <span class="type">AnyObject</span>?) -&gt; <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> object <span class="operator">=</span> object <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="string">&quot;nil&quot;</span> &#125;</span><br><span class="line">        <span class="keyword">let</span> opaque: <span class="type">UnsafeMutableRawPointer</span> <span class="operator">=</span> <span class="type">Unmanaged</span>.passUnretained(object).toOpaque()</span><br><span class="line">        <span class="keyword">return</span> <span class="type">String</span>(describing: opaque)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">DLog</span><span class="params">(self)</span></span></span><br><span class="line"><span class="function"><span class="title">DLog</span><span class="params">(<span class="string">&quot;self p:\(Unmanaged.passUnretained(self).toOpaque())&quot;</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>æ‰“å°å¦‚ä¸‹:  </p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">2019</span>-<span class="number">02</span>-<span class="number">27</span> <span class="number">11</span>:<span class="number">58</span>:<span class="number">57</span>.<span class="number">378</span><span class="meta"> [ViewController.swift:30][viewDidAppear]&lt;demo.ViewController: 0x1059c2170&gt;</span></span><br><span class="line"><span class="meta">2019-02-27 11:58:57.383 [ViewController.swift:31][viewDidAppear]self p:0x00000001059c2170</span></span><br></pre></td></tr></table></figure>
<p>ä¸è¿‡è¿˜æ˜¯æ¨è<a href="http://www.hangge.com/blog/cache/detail_1418.html">Swift - æ—¥å¿—æ¡†æ¶XCGLoggerçš„ä½¿ç”¨è¯¦è§£</a></p>
]]></content>
      <categories>
        <category>Swift</category>
      </categories>
  </entry>
  <entry>
    <title>layoutSubviewsçš„è°ƒç”¨æ—¶æœº</title>
    <url>/2017/08/20/layoutSubviews%E7%9A%84%E8%B0%83%E7%94%A8%E6%97%B6%E6%9C%BA/</url>
    <content><![CDATA[<h2 id="layoutSubviewsçš„è°ƒç”¨æ—¶æœº"><a href="#layoutSubviewsçš„è°ƒç”¨æ—¶æœº" class="headerlink" title="layoutSubviewsçš„è°ƒç”¨æ—¶æœº"></a>layoutSubviewsçš„è°ƒç”¨æ—¶æœº</h2><p>æ–¹æ³•è¯´æ˜:</p>
<p>è¯¥æ–¹æ³•åœ¨iOS 5.1åŠæ›´ä½ç‰ˆæœ¬ä¸Šä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚ å¦åˆ™ï¼Œè¯¥æ–¹æ³•å°†ä½¿ç”¨ä½ è®¾ç½®çš„çº¦æŸæ¥ç¡®å®šå­è§†å›¾çš„å¤§å°å’Œä½ç½®ã€‚</p>
<p>è¯¥æ–¹æ³•ç”±<code>layoutIfNeeded</code>è‡ªåŠ¨è°ƒç”¨,æ‰€ä»¥æˆ‘ä»¬ä¸èƒ½æ‰‹åŠ¨å»è°ƒç”¨å®ƒ.åœ¨éœ€è¦é‡æ–°å¸ƒå±€å­è§†å›¾æ—¶,å¯ä»¥è°ƒç”¨<code>[self layoutIfNeeded]</code>æˆ–<code>[self setNeedLayout];</code></p>
<h2 id="æ‰‹åŠ¨è§¦å‘layoutSubviews"><a href="#æ‰‹åŠ¨è§¦å‘layoutSubviews" class="headerlink" title="æ‰‹åŠ¨è§¦å‘layoutSubviews"></a>æ‰‹åŠ¨è§¦å‘layoutSubviews</h2><p>è°ƒç”¨<code>[self layoutIfNeeded]</code>æˆ–<code>[self setNeedLayout];</code>  </p>
<blockquote>
<p><code>layoutIfNeeded</code>ä¸<code>setNeedLayout</code>çš„åŒºåˆ«: </p>
</blockquote>
<p>è°ƒç”¨ <code>layoutIfNeeded</code> ä¼šé©¬ä¸Šæ‰§è¡Œ <code>layoutSubviews</code> æ–¹æ³•ï¼Œç«‹å³æ›´æ–°è§†å›¾çš„å¸ƒå±€ã€‚ä½†æ˜¯è°ƒç”¨<code>setNeedLayout</code>å¹¶ä¸ä¼šé©¬ä¸Šæ‰§è¡Œ<code>layoutSubviews</code>,è€Œæ˜¯ç­‰åˆ°runloopç»“æŸæ—¶è°ƒç”¨.</p>
<h2 id="è‡ªåŠ¨è§¦å‘layoutSubviews"><a href="#è‡ªåŠ¨è§¦å‘layoutSubviews" class="headerlink" title="è‡ªåŠ¨è§¦å‘layoutSubviews"></a>è‡ªåŠ¨è§¦å‘layoutSubviews</h2><p>å¦‚æœä¸€ä¸ªviewAè¿˜æ²¡æœ‰è¢«æ·»åŠ åˆ°çˆ¶è§†å›¾ä¸Šé¢å»,é‚£ä¹ˆæ— è®ºä½ å¯¹å®ƒè¿›è¡Œä»€ä¹ˆæ“ä½œ(è®¾ç½®frame,æ·»åŠ å­è§†å›¾ç­‰ç­‰),å®ƒçš„<code>layoutSubviews</code>æ–¹æ³•å§‹ç»ˆæ˜¯ä¸ä¼šè¢«è°ƒç”¨çš„.  </p>
<p>ä¸‹é¢æƒ…å†µå°†ä¼šè‡ªåŠ¨è§¦å‘viewAçš„<code>layoutSubviews</code>æ–¹æ³•:  </p>
<ol>
<li><p>viewAè¢«æ·»åŠ åˆ°çˆ¶è§†å›¾ä¸Š.(viewAçš„å’ŒviewAæ‰€æœ‰å­è§†å›¾çš„éƒ½ä¼šè¢«è§¦å‘).</p>
</li>
<li><p>viewA addSubviewä¼šè§¦å‘<code>layoutSubviews</code>.(viewAçš„è¢«è§¦å‘å,å¦‚æœåœ¨ <code>layoutSubviews</code> çš„å®ç°ä¸­è°ƒæ•´äº†å­è§†å›¾çš„frameï¼Œé‚£ä¹ˆå­è§†å›¾çš„ä¹Ÿä¼šè¢«è§¦å‘ï¼Œè¿é”ååº”ï¼Œä¸‹é¢çš„ç±»åŒ).</p>
</li>
<li><p>viewAä¸Šçš„å­è§†å›¾ä»viewAä¸Šç§»é™¤,ä¼šè§¦å‘<code>layoutSubviews</code>. </p>
</li>
<li><p>è®¾ç½®viewAçš„Frameä¼šè§¦å‘<code>layoutSubviews</code>ï¼Œå½“ç„¶å‰ææ˜¯frameçš„å€¼è®¾ç½®å‰åå‘ç”Ÿäº†å˜åŒ–. </p>
</li>
<li><p>viewAä¸Šçš„å­è§†å›¾å¤§å°(x,yæ”¹å˜æ²¡å½±å“)æ”¹å˜æ—¶ä¹Ÿä¼šè§¦å‘viewAçš„<code>layoutSubviews</code>äº‹ä»¶. </p>
</li>
<li><p>å¦‚æœviewAæ˜¯ä¸€ä¸ªUIScrollView,é‚£ä¹ˆviewAåœ¨æ»šåŠ¨æ—¶ä¼šè§¦å‘å®ƒçš„layoutSubviewsæ–¹æ³•. </p>
</li>
<li><p>æ—‹è½¬Screenä¼šè§¦å‘viewControllerçš„primary viewçš„layoutSubviewsäº‹ä»¶.</p>
</li>
</ol>
<p>æ€»ä¹‹ä¸€å¥è¯ï¼Œèƒ½å½±å“viewAæˆ–viewAå†…éƒ¨å¸ƒå±€æ”¹å˜çš„å› ç´ éƒ½ä¼šå¯¼è‡´viewAçš„ <code>layoutSubviews</code>è°ƒç”¨ã€‚</p>
<p>æ³¨æ„:  </p>
<ul>
<li>initåˆå§‹åŒ–ä¸ä¼šè§¦å‘<code>layoutSubviews</code>,å› ä¸ºæ­¤æ—¶Viewè¿˜æ²¡æœ‰è¢«æ·»åŠ åˆ°çˆ¶è§†å›¾ä¸Šå».  </li>
<li>ä¸€ä¸ªViewçš„å­è§†å›¾æŒ‡çš„æ˜¯å®ƒçš„ç›´ç³»å­è§†å›¾.</li>
</ul>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://blog.logichigh.com/2011/03/16/when-does-layoutsubviews-get-called/">When does layoutSubviews get called?</a></p>
]]></content>
      <categories>
        <category>UIKit</category>
      </categories>
      <tags>
        <tag>layoutSubviews</tag>
      </tags>
  </entry>
  <entry>
    <title>layoutIfNeededä¸layoutSubviewsçš„å…³ç³»</title>
    <url>/2017/08/16/layoutIfNeeded%E4%B8%8ElayoutSubviews%E7%9A%84%E5%85%B3%E7%B3%BB/</url>
    <content><![CDATA[<p>åŠ¨ç”»<code>-layoutIfNeeded</code>çˆ¶æ§åˆ¶å™¨çš„self.view,å­æ§åˆ¶å™¨çš„å­è§†å›¾å¦‚æœé‡å†™äº†<code>-layoutSubviews</code>ä¹Ÿå°†åŠ¨ç”»å¸ƒå±€.<br>éœ€æ±‚:å¯¼èˆªæ æ ¹æ®å­VCçš„tableviewçš„ä½ç§»åŠ¨ç”».</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (contentOffsetY <span class="operator">&gt;</span> <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">//ä¸Šæ»‘</span></span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.headerContainerView mas_updateConstraints:<span class="operator">^</span>(<span class="type">MASConstraintMaker</span> <span class="operator">*</span>make) &#123;</span><br><span class="line">        make.top.equalTo(<span class="keyword">self</span>.view.mas_topMargin).with.offset(startY <span class="operator">-</span> endY);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.view setNeedsUpdateConstraints];</span><br><span class="line">    [<span class="keyword">self</span>.view updateConstraintsIfNeeded];</span><br><span class="line">    </span><br><span class="line">    [<span class="type">UIView</span> animateWithDuration:<span class="number">0.3</span> animations:<span class="operator">^</span>&#123;</span><br><span class="line">        <span class="keyword">self</span>.contentScrollView.contentInset <span class="operator">=</span> <span class="type">UIEdgeInsetsMake</span>(<span class="operator">-</span>endY, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        [<span class="keyword">self</span>.view layoutIfNeeded]; <span class="comment">//é—®é¢˜ç‚¹</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.headerContainerView.headerView.matchOtherDesBgView.alpha <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">self</span>.headerContainerView.headerView.team1NameLabel.alpha <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">self</span>.headerContainerView.headerView.team2NameLabel.alpha <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.headerContainerView.headerView.teamLogoBgView.transform <span class="operator">=</span> <span class="type">CGAffineTransformMakeScale</span>(<span class="number">0.5</span>, <span class="number">0.5</span>);</span><br><span class="line">        <span class="type">CGAffineTransform</span> currentT <span class="operator">=</span> <span class="keyword">self</span>.headerContainerView.headerView.teamLogoBgView.transform;</span><br><span class="line">        <span class="type">CGAffineTransform</span> translation <span class="operator">=</span> <span class="type">CGAffineTransformTranslate</span>(currentT, <span class="number">0</span>, teamLogoBgViewOffsetY);</span><br><span class="line">        <span class="keyword">self</span>.headerContainerView.headerView.teamLogoBgView.transform <span class="operator">=</span> translation;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±äºéœ€è¦åŠ¨ç”»çš„æ”¹å˜çˆ¶æ§åˆ¶å™¨é‡Œçš„viewä½ç§»,åˆå› ä¸ºä½¿ç”¨äº†xib,æ‰€ä»¥åŠ¨ç”»æ—¶éœ€è¦åœ¨åŠ¨ç”»blocké‡Œå†™<code>[self.view layoutIfNeeded];</code>ä½†è¿™å¥ä»£ç å¯¼è‡´äº†å­æ§åˆ¶å™¨çš„è§†å›¾çš„<code>-layoutSubviews</code>æ–¹æ³•è¢«è°ƒç”¨.äºæ˜¯å­æ§åˆ¶å™¨çš„è§†å›¾åœ¨å¸ƒå±€æ—¶ä¹Ÿä¼šåŠ¨ç”»çš„è¿›è¡Œ(è€Œè¿™ç§æ•ˆæœä¸æ˜¯ä½ éœ€è¦çš„ä»è€Œå˜æˆäº†bug.)<br>è¿™é‡Œçš„bugå°±æ˜¯:å­æ§åˆ¶å™¨é‡Œçš„tableViewCellå› ä¸ºé‡å†™äº†<code>-layoutSubviews</code>,è€Œcellä¸Šçš„å­æ§ä»¶<code>KDGMatchDetailItemView</code>ä¹Ÿé‡å†™äº†<code>-layoutSubviews</code>.æ‰€ä»¥<code>KDGMatchDetailItemView</code>åœ¨å¸ƒå±€æ—¶å‡ºç°åŠ¨ç”»çš„å¾€å³ç§»åŠ¨.<br>è§£å†³åŠæ³•:å½“å¯¼èˆªæ æ”¶ç¼©å,å°±ä¸è¦æ‰§è¡Œ<code>[self.view layoutIfNeeded];</code>åŠ ä¸ªåˆ¤æ–­æ¡ä»¶:</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (contentOffsetY &gt; <span class="number">0</span>  &amp;&amp; self<span class="selector-class">.contentScrollView</span><span class="selector-class">.contentInset</span><span class="selector-class">.top</span> != -endY) &#123;</span><br><span class="line">	<span class="comment">//åŠ¨ç”»ä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç³»ç»Ÿçš„<code>-layoutIfNeeded</code>çš„å®ç°åº”è¯¥æ˜¯è°ƒç”¨äº†è§†å›¾çš„<code>-layoutSubviews</code>æ–¹æ³•.çˆ¶è§†å›¾<code>-layoutSubviews</code>æ–¹æ³•çš„è°ƒç”¨å¯èƒ½ä¼šå¼•èµ·å­è§†å›¾<code>-layoutSubviews</code>æ–¹æ³•çš„è°ƒç”¨.</p>
]]></content>
      <categories>
        <category>UIKit</category>
      </categories>
      <tags>
        <tag>layoutIfNeeded</tag>
      </tags>
  </entry>
  <entry>
    <title>Next Theme Tutorial</title>
    <url>/2017/07/20/next-tutorial/</url>
    <content><![CDATA[<blockquote>
<p>NexT is a high quality elegant <a href="https://jekyllrb.com">Jekyll</a> theme ported from <a href="https://github.com/iissnan/hexo-theme-next">Hexo Next</a>. It is crafted from scratch, with love.</p>
</blockquote>
<span id="more"></span>
<p><a href="http://simpleyyt.github.io/jekyll-theme-next/">Live Preview</a></p>
<h2 id="Screenshots"><a href="#Screenshots" class="headerlink" title="Screenshots"></a>Screenshots</h2><ul>
<li><p>Desktop<br><img src="http://iissnan.com/nexus/next/desktop-preview.png" alt="Desktop Preview"></p>
</li>
<li><p>Sidebar</p>
</li>
</ul>
<p><img src="http://iissnan.com/nexus/next/desktop-sidebar-preview.png" alt="Desktop Sidebar Preview"></p>
<ul>
<li>Sidebar (Post details page)</li>
</ul>
<p><img src="http://iissnan.com/nexus/next/desktop-sidebar-toc.png" alt="Desktop Sidebar Preview"></p>
<ul>
<li>Mobile</li>
</ul>
<p><img src="http://iissnan.com/nexus/next/mobile.png" alt="Mobile Preview"></p>
<h2 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h2><p>Check whether you have <code>Ruby 2.1.0</code> or higher installed:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ruby --version</span><br></pre></td></tr></table></figure>
<p>Install <code>Bundler</code>:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">gem install bundler</span><br></pre></td></tr></table></figure>
<p>Clone Jacman theme:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/Simpleyyt/jekyll-theme-next.git</span><br><span class="line"><span class="built_in">cd</span> jekyll-theme-next</span><br></pre></td></tr></table></figure>
<p>Install Jekyll and other dependencies from the GitHub Pages gem:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">bundle install</span><br></pre></td></tr></table></figure>
<p>Run your Jekyll site locally:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">bundle <span class="built_in">exec</span> jekyll server</span><br></pre></td></tr></table></figure>
<p>More Detailsï¼š<a href="https://help.github.com/articles/setting-up-your-github-pages-site-locally-with-jekyll/">Setting up your GitHub Pages site locally with Jekyll</a></p>
<h2 id="Features"><a href="#Features" class="headerlink" title="Features"></a>Features</h2><h3 id="Multiple-languages-support-including-English-Russian-French-German-Simplified-Chinese-Traditional-Chinese"><a href="#Multiple-languages-support-including-English-Russian-French-German-Simplified-Chinese-Traditional-Chinese" class="headerlink" title="Multiple languages support, including: English / Russian / French / German / Simplified Chinese / Traditional Chinese."></a>Multiple languages support, including: English / Russian / French / German / Simplified Chinese / Traditional Chinese.</h3><p>Default language is English.</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">language:</span> <span class="string">en</span></span><br><span class="line"><span class="comment"># language: zh-Hans</span></span><br><span class="line"><span class="comment"># language: fr-FR</span></span><br><span class="line"><span class="comment"># language: zh-hk</span></span><br><span class="line"><span class="comment"># language: zh-tw</span></span><br><span class="line"><span class="comment"># language: ru</span></span><br><span class="line"><span class="comment"># language: de</span></span><br></pre></td></tr></table></figure>
<p>Set <code>language</code> field as following in site <code>_config.yml</code> to change to Chinese.</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">language:</span> <span class="string">zh-Hans</span></span><br></pre></td></tr></table></figure>
<h3 id="Comment-support"><a href="#Comment-support" class="headerlink" title="Comment support."></a>Comment support.</h3><p>NexT has native support for <code>DuoShuo</code> and <code>Disqus</code> comment systems.</p>
<p>Add the following snippets to your <code>_config.yml</code>:</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">duoshuo:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">shortname:</span> <span class="string">your-duoshuo-shortname</span></span><br></pre></td></tr></table></figure>
<p>OR</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">disqus_shortname:</span> <span class="string">your-disqus-shortname</span></span><br></pre></td></tr></table></figure>
<h3 id="Social-Media"><a href="#Social-Media" class="headerlink" title="Social Media"></a>Social Media</h3><p>NexT can automatically add links to your Social Media accounts:</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">social:</span></span><br><span class="line">  <span class="attr">GitHub:</span> <span class="string">your-github-url</span></span><br><span class="line">  <span class="attr">Twitter:</span> <span class="string">your-twitter-url</span></span><br><span class="line">  <span class="attr">Weibo:</span> <span class="string">your-weibo-url</span></span><br><span class="line">  <span class="attr">DouBan:</span> <span class="string">your-douban-url</span></span><br><span class="line">  <span class="attr">ZhiHu:</span> <span class="string">your-zhihu-url</span></span><br></pre></td></tr></table></figure>
<h3 id="Feed-link"><a href="#Feed-link" class="headerlink" title="Feed link."></a>Feed link.</h3><blockquote>
<p>Show a feed link.</p>
</blockquote>
<p>Set <code>rss</code> field in themeâ€™s <code>_config.yml</code>, as the following value:</p>
<ol>
<li><code>rss: false</code> will totally disable feed link.</li>
<li><p><code>rss:</code> use sitesâ€™ feed link. This is the default option.</p>
<p> Follow the installation instruction in the pluginâ€™s README. After the configuration is done for this plugin, the feed link is ready too.</p>
</li>
<li><p><code>rss: http://your-feed-url</code> set specific feed link.</p>
</li>
</ol>
<h3 id="Up-to-5-code-highlight-themes-built-in"><a href="#Up-to-5-code-highlight-themes-built-in" class="headerlink" title="Up to 5 code highlight themes built-in."></a>Up to 5 code highlight themes built-in.</h3><p>NexT uses <a href="https://github.com/chriskempson/tomorrow-theme">Tomorrow Theme</a> with 5 themes for you to choose from.<br>Next use <code>normal</code> by default. Have a preview about <code>normal</code> and <code>night</code>:</p>
<p><img src="http://iissnan.com/nexus/next/tomorrow-normal.png" alt="Tomorrow Normal Preview"><br><img src="http://iissnan.com/nexus/next/tomorrow-night.png" alt="Tomorrow Night Preview"></p>
<p>Head over to <a href="https://github.com/chriskempson/tomorrow-theme">Tomorrow Theme</a> for more details.</p>
<h2 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h2><p>NexT comes with few configurations.</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Menu configuration.</span></span><br><span class="line"><span class="attr">menu:</span></span><br><span class="line">  <span class="attr">home:</span> <span class="string">/</span></span><br><span class="line">  <span class="attr">archives:</span> <span class="string">/archives</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Favicon</span></span><br><span class="line"><span class="attr">favicon:</span> <span class="string">/favicon.ico</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Avatar (put the image into next/source/images/)</span></span><br><span class="line"><span class="comment"># can be any image format supported by web browsers (JPEG,PNG,GIF,SVG,..)</span></span><br><span class="line"><span class="attr">avatar:</span> <span class="string">/default_avatar.png</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Code highlight theme</span></span><br><span class="line"><span class="comment"># available: normal | night | night eighties | night blue | night bright</span></span><br><span class="line"><span class="attr">highlight_theme:</span> <span class="string">normal</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Fancybox for image gallery</span></span><br><span class="line"><span class="attr">fancybox:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Specify the date when the site was setup</span></span><br><span class="line"><span class="attr">since:</span> <span class="number">2013</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Browser-support"><a href="#Browser-support" class="headerlink" title="Browser support"></a>Browser support</h2><p><img src="http://iissnan.com/nexus/next/browser-support.png" alt="Browser support"></p>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
  </entry>
  <entry>
    <title>UITableViewCellé‡ç”¨å¯¼è‡´çš„å›¾ç‰‡é”™ä¹±é—®é¢˜</title>
    <url>/2016/04/24/UITableViewCell%E9%87%8D%E7%94%A8%E5%AF%BC%E8%87%B4%E7%9A%84%E5%9B%BE%E7%89%87%E9%94%99%E4%B9%B1%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<p>ä¹‹å‰åšè¿‡ä¸€ä¸ªè§†é¢‘ä¿¡æ¯åˆ—è¡¨å±•ç¤ºçš„æ¨¡å—ï¼Œcellå¾ˆç®€å•å°±æ˜¯å·¦è¾¹å›¾ç‰‡ï¼Œå³è¾¹æ–‡å­—ä¿¡æ¯ã€‚å½“æ—¶ç”¨çš„SDWebImageåŠ è½½å›¾ç‰‡å¹¶æ²¡æœ‰çœ‹åˆ°å›¾ç‰‡é”™ä¹±çš„æƒ…å†µã€‚ä½†æ˜¯ï¼Œå¦‚æœæ˜¯è‡ªå·±å†™çš„å›¾ç‰‡ä¸‹è½½å™¨ï¼Œä¸æ³¨æ„å¤„ç†æ˜¯ä¼šå¯¼è‡´å›¾ç‰‡é”™ä¹±çš„ã€‚</p>
<p>ä»Šå¤©å†™äº†ä¸ªDemoï¼ŒéªŒè¯åŠè§£å†³è¿™ä¸ªé—®é¢˜ã€‚<br>å®éªŒç¯å¢ƒï¼šcellä¾ç„¶æ˜¯å·¦è¾¹å›¾ç‰‡ï¼Œå³è¾¹æ–‡å­—ä¿¡æ¯ã€‚å›¾ç‰‡ä¸¤å¼ ï¼Œä¸€å¼ å¤§å›¾ç‰‡A(é£æ™¯)ï¼Œä¸€å¼ å°å›¾ç‰‡B(äººç‰©)ï¼Œ<strong>é‡‡ç”¨è‡ªå·±å®ç°çš„åŸå§‹å›¾ç‰‡ä¸‹è½½å™¨</strong>å¼‚æ­¥ä¸‹è½½ï¼Œblocké‡Œå›è°ƒè®¾ç½®cellçš„å›¾ç‰‡ã€‚è¦æ±‚å¶æ•°è¡Œçš„å›¾ç‰‡æ˜¯é£æ™¯ï¼Œå¥‡æ•°è¡Œçš„å›¾ç‰‡æ˜¯äººç‰©ã€‚<br>æ•´ä¸ªç•Œé¢æœŸæœ›å¦‚ä¸‹:<br><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/1503319-0c16709bb58a8af1.webp" style="zoom:50%;" /></p>
<p>ä½†å®é™…å¯èƒ½å‡ºç°bugï¼Œå¦‚ä¸‹å›¾:<br><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/1503319-396836dd909893b1.webp" style="zoom:50%;" /></p>
<h4 id="æ•°æ®é”™ä¹±åŸå› åˆ†æ"><a href="#æ•°æ®é”™ä¹±åŸå› åˆ†æ" class="headerlink" title="æ•°æ®é”™ä¹±åŸå› åˆ†æ"></a>æ•°æ®é”™ä¹±åŸå› åˆ†æ</h4><p>cellä¸Šçš„æ•°æ®é”™ä¹±æ˜¾ç„¶æ˜¯ç”±äºcellçš„é‡ç”¨å¯¼è‡´çš„ã€‚ç”±äºå›¾ç‰‡æ˜¯å¼‚æ­¥ä¸‹è½½çš„ï¼Œä¸‹è½½å®Œæˆæ‰ç»™cellè®¾ç½®ï¼Œä½†æ˜¯åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ç”¨æˆ·å¯èƒ½ä¼šä¸Šä¸‹æ»‘åŠ¨ï¼Œæ»‘åŠ¨çš„æ—¶å€™ä¼šå¯¼è‡´cellçš„é‡ç”¨ï¼Œæ¯”å¦‚ç¬¬0è¡Œæ˜¯è®¾ç½®å¤§å›¾ç‰‡çš„ï¼Œç¬¬11è¡Œæ˜¯è®¾ç½®å°å›¾ç‰‡çš„ï¼Œç”¨æˆ·åœ¨æ»‘åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œå› ä¸ºcellçš„é‡ç”¨ç¬¬11è¡Œçš„cellå¯èƒ½ä½¿ç”¨çš„æ˜¯ç¬¬0è¡Œçš„cellï¼Œè¿™æ—¶ç¬¬0è¡Œçš„blockå›è°ƒè®¾ç½®çš„cellå’Œç¬¬11è¡Œçš„blockå›è°ƒè®¾ç½®çš„cellæ˜¯åŒä¸€ä¸ªï¼Œå³cellçš„é‡ç”¨å¯¼è‡´ä¸¤ä¸ªblockå›è°ƒæ—¶è®¾ç½®çš„å…¶å®æ˜¯åŒä¸€ä¸ªcellä¸Šçš„imageViewã€‚è¿™å°±æ˜¯é—®é¢˜çš„å…³é”®ã€‚</p>
<p>å› ä¸ºå›¾ç‰‡æ˜¯å¼‚æ­¥ä¸‹è½½çš„ï¼Œä½ ä¹Ÿä¸çŸ¥é“å“ªä¸ªblockä¼šå…ˆå›è°ƒï¼Œå¦‚æœå°å›¾ç‰‡çš„blockå…ˆå›è°ƒé‚£ä¹ˆè¿™ä¸ªcellçš„å›¾ç‰‡å°±å…ˆè¢«è®¾ç½®ä¸ºå°å›¾ç‰‡ï¼Œå¦‚æœåæ¥å¤§å›¾ç‰‡çš„blockå›æ¥äº†ï¼Œé‚£ä¹ˆä½ ä¼šçœ‹åˆ°å›¾ç‰‡è¢«æ›¿æ¢æˆå¤§å›¾ç‰‡ï¼Œè¿™ç§æƒ…å†µè¿˜ç®—æ¯”è¾ƒå¥½ï¼Œä½†å¦‚æœå¤§å›¾ç‰‡ä¸‹è½½å¤±è´¥æˆ–è€…å°å›¾ç‰‡çš„blockæœ€åå›è°ƒï¼Œé‚£ä¹ˆä½ çœ‹åˆ°çš„å°†æ˜¯å°å›¾ç‰‡åŠ å¤§å›¾ç‰‡çš„æ–‡å­—ä¿¡æ¯ï¼Œè¿™æ—¶æ•°æ®å°±é”™ä¹±äº†ã€‚</p>
<h4 id="å¦‚ä½•è§£å†³"><a href="#å¦‚ä½•è§£å†³" class="headerlink" title="å¦‚ä½•è§£å†³"></a>å¦‚ä½•è§£å†³</h4><p>å¦‚æœä¸é‡ç”¨cellï¼Œå½“ç„¶æ˜¯å¯ä»¥è§£å†³è¯¥é—®é¢˜çš„ï¼Œä½†æ˜¯å†…å­˜è‚¯å®šä¼šæµªè´¹ä¸å°‘ã€‚</p>
<p>è§£å†³çš„æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š</p>
<p>æ–¹æ¡ˆä¸€ï¼šåœ¨ä¸‹è½½å®Œæˆçš„å›è°ƒé‡Œè¿›è¡ŒåŒºåˆ†ï¼Œå¦‚æœä¸ä¸€è‡´åˆ™ä¸è®¾ç½®imageViewã€‚</p>
<p>æ–¹æ¡ˆäºŒï¼šæ¯æ¬¡ä¸‹è½½å‰éƒ½å…ˆå–æ¶ˆæ‰ä¸Šä¸€æ¬¡çš„ä¸‹è½½ï¼Œè¿™æ ·å°±ä¸ä¼šåŒæ—¶æœ‰ä¸¤ä¸ªblockå›è°ƒï¼Œè¿™æ˜¯å¾ˆå¤šç¬¬ä¸‰æ–¹å›¾ç‰‡åŠ è½½åº“çš„åšæ³•ã€‚</p>
<p>å¦‚æœé‡‡ç”¨æ–¹æ¡ˆä¸€ï¼Œé‚£ä¹ˆæœ‰ä¸¤ç§åŠæ³•è¿›è¡ŒåŒºåˆ†ï¼š</p>
<p><strong>1. é€šè¿‡indexPathæ¥åŒºåˆ†</strong></p>
<p>blocké‡Œæˆªè·çš„indexPathå¯¹è±¡æ˜¯cellåœ¨ä¸‹è½½å‰çš„indexPathï¼Œå‡è®¾ä¸ºt1æ—¶åˆ»çš„indexPathã€‚è€Œé€šè¿‡<code>[tableView indexPathForCell:cell];</code> åˆ™å¯ä»¥è·å¾—cellå½“å‰çš„indexPathï¼Œå‡è®¾ä¸ºt2æ—¶åˆ»çš„indexPathã€‚å¦‚æœt1-t2è¿™æ®µæ—¶é—´å†…cellå‘ç”Ÿäº†é‡ç”¨çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªindexPathå°†ä¸ä¸€è‡´ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">UITableViewCell</span> *)tableView:(<span class="built_in">UITableView</span> *)tableView cellForRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath</span><br><span class="line">&#123;</span><br><span class="line">    MyTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:<span class="string">@&quot;Cell&quot;</span> forIndexPath:indexPath];</span><br><span class="line">    cell.imgView.image = [<span class="built_in">UIImage</span> imageNamed:<span class="string">@&quot;pl&quot;</span>];</span><br><span class="line">    <span class="built_in">NSString</span> *urlStr = <span class="keyword">self</span>.urlArr[indexPath.row];</span><br><span class="line">    __<span class="keyword">weak</span> <span class="keyword">typeof</span>(MyTableViewCell *) weakCell = cell;</span><br><span class="line">    [[XQImageDownloader defaultImageDownloader] downloadImageWithUrlString:urlStr completion:^(<span class="built_in">NSString</span> *imgUrl, <span class="built_in">UIImage</span> *image, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!error) &#123;</span><br><span class="line">            <span class="built_in">NSIndexPath</span> *currentIndexPath = [tableView indexPathForCell:weakCell];</span><br><span class="line">          	<span class="keyword">if</span> (currentIndexPath == <span class="literal">nil</span>) &#123; <span class="comment">//è¡¨æ˜cellæ²¡åœ¨å±å¹•ä¸Šæ˜¾ç¤ºã€‚</span></span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">NSInteger</span> currentRow = currentIndexPath.row;</span><br><span class="line">            <span class="built_in">NSInteger</span> originalRow = indexPath.row; <span class="comment">//è¿™é‡Œçš„indexPathæ˜¯blockæˆªè·çš„.</span></span><br><span class="line">            <span class="keyword">if</span> (originalRow != currentRow) &#123;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@&quot;æ•°æ®é”™ä¹±ï¼Œåº”è¯¥è®¾ç½®çš„æ˜¯ç¬¬%ldä¸ªcellä¸Šçš„ImageView,ä½†å½“å‰è®¾ç½®çš„æ˜¯%ldä¸ªcellä¸Šçš„ImageView,cell:%p&quot;</span>, (<span class="type">long</span>)originalRow, currentRow, weakCell);</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@&quot;urlStr:%@, imgUrlï¼š%@&quot;</span>, urlStr, imgUrl); <span class="comment">//è¿™é‡Œçš„urlStr==imgUrlï¼Œæƒ³ä¸€æƒ³ä¸ºä»€ä¹ˆ</span></span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            &#125;</span><br><span class="line">            weakCell.imgView.image = image;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;ä¸‹è½½å›¾ç‰‡ï¼š%@ï¼Œerror:%@&quot;</span>, urlStr, [error localizedDescription]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    cell.contentLabel.text = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;è¿™æ˜¯ç¬¬%ldä¸ªcell:%p&quot;</span>, indexPath.row, cell];</span><br><span class="line">    <span class="keyword">return</span> cell;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ç§åŠæ³•çš„ç¼ºç‚¹æ˜¯å¦‚æœcellçš„é…ç½®æ–¹æ³•æ˜¯åœ¨åˆ«å¤„ï¼Œé‚£ä¹ˆéœ€è¦ä¼ é€’tableViewå’ŒindexPathä¸¤ä¸ªå‚æ•°ï¼Œå¯¹ç°æœ‰ä»£ç æ”¹åŠ¨è¾ƒå¤§ï¼Œä¸æ˜¯å¾ˆæ–¹ä¾¿ã€‚</p>
<p>æ³¨æ„ï¼šä¸Šè¿°ä»£ç ä¸­å’ŒcurrentIndexPathæ¯”è¾ƒçš„indexPathï¼Œå¿…é¡»æ˜¯blockæˆªè·çš„ï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨ <code>cell.indexPath</code> ï¼ˆè¿™é‡Œå‡è®¾cellé‡Œæœ‰ä¸€ä¸ªindexPathå±æ€§å¹¶åœ¨dequeueåå°±èµ‹å€¼ä¸ºä»£ç†æ–¹æ³•çš„indexPathå‚æ•°ï¼‰å¦åˆ™æ€»æ˜¯ç›¸ç­‰çš„ã€‚</p>
<p><strong>2. é€šè¿‡ä¸‹è½½çš„å›¾ç‰‡URLæ¥åŒºåˆ†</strong></p>
<p>ä¸‹è½½å‰å…ˆè®°å½•å½“å‰imageViewåº”è¯¥æ˜¾ç¤ºçš„å›¾ç‰‡URLï¼Œå½“ä¸‹è½½å®Œæˆæ—¶å†è¿›è¡Œæ¯”è¾ƒã€‚è¿™ç§åŠæ³•æ¯”ç¬¬ä¸€ç§è¦æ–¹ä¾¿å¾ˆå¤šï¼Œæˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªUIImageViewçš„ç±»åˆ«å°è£…ä¸€ä¸‹ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">UITableViewCell</span> *)tableView:(<span class="built_in">UITableView</span> *)tableView cellForRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath</span><br><span class="line">&#123;</span><br><span class="line">    MyTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:<span class="string">@&quot;Cell&quot;</span> forIndexPath:indexPath];</span><br><span class="line">    cell.imgView.image = [<span class="built_in">UIImage</span> imageNamed:<span class="string">@&quot;pl&quot;</span>];</span><br><span class="line">    <span class="built_in">NSString</span> *urlStr = <span class="keyword">self</span>.urlArr[indexPath.row];</span><br><span class="line">    cell.imageView.xq_imgUrl = [<span class="built_in">NSURL</span> URLWithString:urlStr]ï¼› <span class="comment">//è®°å½•å½“å‰imageViewåº”è¯¥æ˜¾ç¤ºçš„å›¾ç‰‡URL</span></span><br><span class="line">    __<span class="keyword">weak</span> <span class="keyword">typeof</span>(MyTableViewCell *) weakCell = cell;</span><br><span class="line">    [[XQImageDownloader defaultImageDownloader] downloadImageWithUrlString:urlStr completion:^(<span class="built_in">NSString</span> *imgUrl, <span class="built_in">UIImage</span> *image, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!error) &#123;</span><br><span class="line">            <span class="keyword">if</span> (![weakCell.imageView.xq_imgUrl.absoluteString isEqualToString:imgUrl]) &#123;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@&quot;æ•°æ®é”™ä¹±ï¼Œåº”è¯¥ä¸‹è½½çš„å›¾ç‰‡urlä¸º:%@, ä½†å½“å‰ä¸‹è½½çš„å›¾ç‰‡urlä¸ºï¼š%@&quot;</span>, weakCell.imageView.xq_imgUrl, imgUrl);</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            &#125;</span><br><span class="line">            weakCell.imgView.image = image;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					  <span class="built_in">NSLog</span>(<span class="string">@&quot;ä¸‹è½½å›¾ç‰‡ï¼š%@ï¼Œerror:%@&quot;</span>, urlStr, [error localizedDescription]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    cell.contentLabel.text = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;è¿™æ˜¯ç¬¬%ldä¸ªcell:%p&quot;</span>, indexPath.row, cell];</span><br><span class="line">    <span class="keyword">return</span> cell;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦å¤–åœ¨ä¸‹è½½å›¾ç‰‡ä¹‹å‰å…ˆæŠŠcellçš„imageViewçš„imageç½®ä¸ºnilã€‚<code>cell.imgView.image = nil;</code>å¯ä»¥é˜²æ­¢é‡ç”¨çš„cellä¸‡ä¸€å›¾ç‰‡ä¸‹è½½å¤±è´¥è€Œå¯¼è‡´æ˜¾ç¤ºäº†ä»¥å‰çš„å›¾ç‰‡ï¼Œä¸è¿‡ä¸€èˆ¬éƒ½ä¼šæœ‰å ä½å›¾ç‰‡æ‰€ä»¥è¿™ä¸€æ­¥å¯æœ‰å¯æ— ã€‚</p>
<p>å¦‚æœé‡‡ç”¨æ–¹æ¡ˆäºŒï¼šæ¯æ¬¡ä¸‹è½½å‰éƒ½å…ˆå–æ¶ˆæ‰ä¸Šä¸€æ¬¡çš„ä¸‹è½½ã€‚é‚£ä¹ˆä½ çš„å›¾ç‰‡ä¸‹è½½å™¨å°±éœ€è¦å®ç°å–æ¶ˆä¸‹è½½åŠŸèƒ½ï¼Œå¹¸è¿çš„æ˜¯SDæˆ–YYè¿™æ ·çš„å›¾ç‰‡åŠ è½½å™¨å·²ç»å®ç°äº†è¿™æ ·çš„åŠŸèƒ½ã€‚</p>
<p>æ¯”å¦‚SDï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)sd_setImageWithURL:(<span class="built_in">NSURL</span> *)url placeholderImage:(<span class="built_in">UIImage</span> *)placeholder options:(SDWebImageOptions)options progress:(SDWebImageDownloaderProgressBlock)progressBlock completed:(SDWebImageCompletionBlock)completedBlock &#123;</span><br><span class="line">    [<span class="keyword">self</span> sd_cancelCurrentImageLoad]; <span class="comment">//ä¸‹è½½å‰å…ˆå–æ¶ˆæ‰å½“å‰ImageViewä¸Šä¹‹å‰çš„ä¸‹è½½</span></span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, &amp;imageURLKey, url, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(options &amp; SDWebImageDelayPlaceholder)) &#123;</span><br><span class="line">        dispatch_main_async_safe(^&#123;</span><br><span class="line">            <span class="keyword">self</span>.image = placeholder;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>YYï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)yy_setImageWithURL:(<span class="built_in">NSURL</span> *)imageURL</span><br><span class="line">               placeholder:(<span class="built_in">UIImage</span> *)placeholder</span><br><span class="line">                   options:(YYWebImageOptions)options</span><br><span class="line">                   manager:(YYWebImageManager *)manager</span><br><span class="line">                  progress:(YYWebImageProgressBlock)progress</span><br><span class="line">                 transform:(YYWebImageTransformBlock)transform</span><br><span class="line">                completion:(YYWebImageCompletionBlock)completion &#123;</span><br><span class="line">    <span class="keyword">if</span> ([imageURL isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) imageURL = [<span class="built_in">NSURL</span> URLWithString:(<span class="type">id</span>)imageURL];</span><br><span class="line">    manager = manager ? manager : [YYWebImageManager sharedManager];</span><br><span class="line">    </span><br><span class="line">    _YYWebImageSetter *<span class="keyword">setter</span> = objc_getAssociatedObject(<span class="keyword">self</span>, &amp;_YYWebImageSetterKey);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">setter</span>) &#123;</span><br><span class="line">        <span class="keyword">setter</span> = [_YYWebImageSetter new];</span><br><span class="line">        objc_setAssociatedObject(<span class="keyword">self</span>, &amp;_YYWebImageSetterKey, <span class="keyword">setter</span>, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">    &#125;</span><br><span class="line">    int32_t sentinel = [<span class="keyword">setter</span> cancelWithNewURL:imageURL]; <span class="comment">//ä¸‹è½½å‰å…ˆå–æ¶ˆæ‰å½“å‰ImageViewä¸Šä¹‹å‰çš„ä¸‹è½½</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥ç›´æ¥ä½¿ç”¨è¿™äº›ç¬¬ä¸‰æ–¹åº“å°±å¯ä»¥äº†ã€‚</p>
<p>æ³¨æ„ï¼šå¦‚æœä½ ä½¿ç”¨è¿™äº›ç¬¬ä¸‰æ–¹åº“è¿˜å‡ºç°å›¾ç‰‡é”™ä¹±çš„é—®é¢˜ï¼Œæ ¹æœ¬åŸå› æ˜¯å› ä¸ºé‡ç”¨çš„cellçš„imageViewæ²¡æœ‰æ‰§è¡Œcancelä¸‹è½½æ“ä½œï¼Œè‡³äºä¸ºå•¥ä¼šæ²¡æœ‰æ‰§è¡Œï¼Œè€ä¸­åŒ»ææŒ‡ä¸€ç®—ï¼Œå¤§æ¦‚ç‡æ˜¯å› ä¸ºä»£ç ä¸­å‡ºç°äº†æœ‰ifæ²¡elseçš„é€»è¾‘æˆ–è€…ifé‡Œç”¨äº†SDè€Œelseé‡Œæ²¡ä½¿ç”¨ã€‚</p>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>cellä¸Šå‘ç”Ÿæ•°æ®é”™ä¹±çš„æ§ä»¶ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯å› ä¸ºè¦æ˜¾ç¤ºçš„èµ„æºéœ€è¦å¼‚æ­¥å¤„ç†æ¯”å¦‚å›¾ç‰‡éœ€è¦ä¸‹è½½åæ‰èƒ½è®¾ç½®åˆ°imageViewä¸Šã€‚å°‘éƒ¨åˆ†åŒæ­¥æ˜¾ç¤ºèµ„æºçš„æ§ä»¶ï¼ˆæ¯”å¦‚UILabelï¼‰å‘ç”Ÿæ•°æ®é”™ä¹±åˆ™ä¸€èˆ¬æ˜¯å› ä¸ºä½ çš„æ¡ä»¶åˆ¤æ–­æœ‰é—®é¢˜å¯¼è‡´é‡ç”¨çš„cellä¸Šè¿˜ç•™æœ‰æ—§çš„æ•°æ®ï¼Œå¯ä»¥é‡å†™<code>-prepareForReuse</code>åœ¨é‡ç”¨å‰å…ˆæ¸…é™¤æ‰æ—§æ•°æ®ã€‚</p>
<p>ä¿ºåœ¨å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„å…¶ä»–ä¸€äº›æ•°æ®é”™ä¹±çš„åœºæ™¯ï¼š</p>
<p>cellä¸Šçš„imageViewæ ¹æ®æ¡ä»¶åˆ¤æ–­ä¸€ä¼šåŠ è½½æœ¬åœ°çš„å›¾ç‰‡ï¼Œä¸€ä¼šåŠ è½½ç½‘ç»œå›¾ç‰‡ï¼Œè¿™ä¸ªå°±å¾ˆå…¸å‹ã€‚</p>
<p>cellä¸Šçš„imageViewæ ¹æ®æ¡ä»¶åˆ¤æ–­ä¸€ä¼šç”¨SDWebImageåŠ è½½ï¼Œä¸€ä¼šç”¨YYWebImageåŠ è½½ã€‚åŒä¸€ä¸ªcellé‡Œçš„imageViewåƒä¸‡ä¸è¦ä½¿ç”¨ä¸¤ç§æ¡†æ¶å»åŠ è½½ã€‚</p>
<p>ä»¥ä¸Šï¼ŒMADE BY XQã€‚</p>
]]></content>
      <categories>
        <category>UIKit</category>
      </categories>
      <tags>
        <tag>UITableViewCell</tag>
        <tag>cellé‡ç”¨é—®é¢˜</tag>
      </tags>
  </entry>
  <entry>
    <title>OC propertyã€synthesizeã€dynamicå…³é”®å­—</title>
    <url>/2014/12/13/OC-property%E3%80%81synthesize%E3%80%81dynamic%E5%85%B3%E9%94%AE%E5%AD%97/</url>
    <content><![CDATA[<p>OCçš„å˜é‡ï¼š</p>
<p>OCæœ‰4ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼šcharï¼Œintï¼Œfloatï¼Œdoubleã€‚å®ƒä»¬åˆæœ‰ä¸€äº›é™å®šè¯ï¼šsignedï¼Œunsignedï¼Œshortï¼Œlongï¼Œlong longã€‚</p>
<p>å®ä¾‹å˜é‡å’Œæˆå‘˜å˜é‡æ˜¯ä¸€ä¸ªæ¦‚å¿µã€‚</p>
<p><img src="https://raw.githubusercontent.com/xq-120/cloudImage/master/9acde5b5-688e-4709-8406-b42a5ad1b24e.jpg" alt=""></p>
<h2 id="property"><a href="#property" class="headerlink" title="@property"></a>@property</h2><p>@propertyæŒ‡ä»¤ä½œç”¨ï¼šå£°æ˜äº†ä¸€ä¸ªå±æ€§åŠå±æ€§çš„ä¸¤ä¸ªè®¿é—®å™¨æ–¹æ³•ã€‚</p>
<p>å¦‚æœåœ¨@implementationå—é‡Œ@synthesizeå’Œ@dynamicéƒ½æ²¡å†™ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨ä¼šå¸®ä½ è‡ªåŠ¨æ·»åŠ @syntheszie property = _property;æœ‰ä¸€ç§æƒ…å†µé™¤å¤–:å­ç±»å±æ€§å’Œçˆ¶ç±»å±æ€§åŒå.æ­¤æ—¶ä¼šæŠ¥è­¦å‘Š:</p>
<p>â€œAuto property synthesis will not synthesize property â€˜delegateâ€™; it will be implemented by its superclass, use @dynamic to acknowledge intentionâ€</p>
<p>è¿™ä¸ªæ—¶å€™å°±éœ€è¦è‡ªå·±å®ç°å±æ€§äº†.ä¸¤ç§å¸¸ç”¨è§£å†³åŠæ³•:</p>
<figure class="highlight d"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span><span class="keyword">@dynamic</span> <span class="built_in">delegate</span>; <span class="comment">//è¡¨ç¤ºä½¿ç”¨çˆ¶ç±»çš„å®ç°,æ­¤æ—¶å­ç±»å†…éƒ¨å°†æ— æ³•è®¿é—®_delegate.</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span><span class="keyword">@synthesize</span> <span class="built_in">delegate</span> = _delegate; <span class="comment">//å­ç±»å†…éƒ¨å¯ä»¥è®¿é—®_delegate.</span></span><br></pre></td></tr></table></figure>
<h2 id="synthesizeå’Œ-dynamic"><a href="#synthesizeå’Œ-dynamic" class="headerlink" title="@synthesizeå’Œ@dynamic"></a>@synthesizeå’Œ@dynamic</h2><p>å®ƒä»¬éƒ½æ˜¯ç”¨äºå±æ€§å®ç°çš„.æ³¨æ„æ˜¯å®ç°ä¸æ˜¯å£°æ˜,å£°æ˜æ˜¯@property.</p>
<h3 id="synthesize"><a href="#synthesize" class="headerlink" title="@synthesize"></a>@synthesize</h3><p>1.è®©ç¼–è¯‘å™¨ä¸ºå±æ€§è‡ªåŠ¨åˆæˆsetter/getteræ–¹æ³•ã€‚å¦‚æœæ‰‹åŠ¨å®ç°äº†setter/getteræ–¹æ³•ï¼Œåˆ™ä¼šè¦†ç›–è‡ªåŠ¨åˆæˆçš„ã€‚</p>
<p>2.ä¸ºå±æ€§<strong>æŒ‰éœ€åˆæˆ</strong>ä¸€ä¸ªå®ä¾‹å˜é‡ã€‚</p>
<p>æŒ‰éœ€åˆæˆçš„æ„æ€å°±æ˜¯è¯´å¦‚æœä½ æœ‰å£°æ˜ä¸€ä¸ªä¸‹åˆ’çº¿å±æ€§å<code>_property</code>çš„å®ä¾‹å˜é‡,é‚£ä¹ˆç¼–è¯‘å™¨ä¼šè‡ªåŠ¨æŠŠå®ƒå…³è”ç»™è¿™ä¸ªå±æ€§,å¦åˆ™çš„è¯ä¼šå¸®ä½ è‡ªåŠ¨å£°æ˜è¿™ä¸ªå®ä¾‹å˜é‡å¹¶å…³è”ç»™è¿™ä¸ªå±æ€§.</p>
<p>è¯­æ³•ï¼š@synthesize property = ivar; æˆ– @synthesize property;</p>
<p>eg:</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@synthesize</span> firstName = _firstName; <span class="comment">//å±æ€§firstNameè¢«æŒ‡å®šäº†ä¸€ä¸ªåä¸º_firstNameçš„å®ä¾‹å˜é‡.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@synthesize</span> lastName; <span class="comment">//å±æ€§lastNameè¢«æŒ‡å®šäº†ä¸€ä¸ªåä¸ºlastNameçš„å®ä¾‹å˜é‡.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@synthesize</span> age = yearsOld; <span class="comment">//å±æ€§ageè¢«æŒ‡å®šäº†ä¸€ä¸ªåä¸ºyearsOldçš„å®ä¾‹å˜é‡.</span></span><br></pre></td></tr></table></figure>
<h3 id="dynamic"><a href="#dynamic" class="headerlink" title="@dynamic"></a>@dynamic</h3><p>@dynamicå…³é”®å­—åŠŸèƒ½å’Œ@synthesizeç›¸åï¼Œå®ƒæ˜¯å‘Šè¯‰ç¼–è¯‘å™¨ä¸è¦è‡ªåŠ¨ä¸ºè¿™ä¸ªå±æ€§åˆæˆsetter/getteræ–¹æ³•,ä¹Ÿä¸è¦ä¸ºå±æ€§è‡ªåŠ¨åˆæˆä¸€ä¸ªå®ä¾‹å˜é‡(å› æ­¤åœ¨å…¶ä»–æ–¹æ³•ä¸­æ˜¯æ— æ³•ä½¿ç”¨_propertyå®ä¾‹å˜é‡çš„).å±æ€§çš„è®¿é—®å™¨æ–¹æ³•å°†ç”±ç¨‹åºå‘˜è‡ªå·±æ¥å®ç°,å®ç°çš„æ–¹å¼å¯ä»¥æ˜¯ç›´æ¥æä¾›setter/getteræ–¹æ³•çš„å®ç°,ä¹Ÿå°±æ˜¯è‡ªå·±åœ¨@implementationå—é‡Œé¢å®ç°setter/getteræ–¹æ³•;ä¹Ÿå¯ä»¥æ˜¯åœ¨è¿è¡Œæ—¶é€šè¿‡å…¶ä»–æœºåˆ¶æ¯”å¦‚åŠ¨æ€çš„åŠ è½½ä¸€æ®µä»£ç æˆ–è€…é€šè¿‡åŠ¨æ€æ–¹æ³•è§£ææä¾›.å®ƒå¯ä»¥æ¶ˆé™¤ç¼–è¯‘å™¨å› ä¸ºæ‰¾ä¸åˆ°å±æ€§çš„è®¿é—®å™¨æ–¹æ³•çš„å®ç°è€Œäº§ç”Ÿçš„è­¦å‘Š.ä½¿ç”¨è¿™ä¸ªæŒ‡ä»¤çš„æ—¶å€™ä½ è‡ªå·±å¿…é¡»è¦æ¸…æ¥šçš„çŸ¥é“è¿™äº›æ–¹æ³•åœ¨è¿è¡Œæ—¶ç¡®å®æ˜¯å¯ç”¨çš„,å¦‚æœåœ¨è¿è¡Œæ—¶ä¾ç„¶æ‰¾åˆ°ä¸åˆ°è¿™äº›æ–¹æ³•,æ˜¾ç„¶ä¼šå¯¼è‡´å´©æºƒ.</p>
<p>ä¸ºä»€ä¹ˆä¼šæœ‰dynamicè¿™ä¸ªå…³é”®å­—ï¼Ÿå› ä¸ºç³»ç»Ÿè‡ªåŠ¨åˆæˆçš„setter/getteræ–¹æ³•å¯èƒ½ä¸æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œç”šè‡³setter/getteræ–¹æ³•æ˜¯é€šè¿‡runtimeå®ç°çš„ä¸ºäº†é¿å…é‡å¤å®ç°å¿…é¡»è¦æœ‰ä¸€ç§æœºåˆ¶é˜»æ­¢ç³»ç»Ÿè‡ªåŠ¨åˆæˆsetter/getteræ–¹æ³•ï¼Œæˆ–è€…è¿™æ˜¯ä¸€ä¸ªè®¡ç®—å‹å±æ€§ä¸éœ€è¦åˆæˆç›¸åº”å®ä¾‹å˜é‡ã€‚</p>
<p>æ¯”å¦‚DDLogé‡Œé¢çš„OSSDDLogFileInfoç±»ä¸­ï¼Œå°±æœ‰è®¸å¤šè¿™æ ·çš„å±æ€§ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSDate</span> *creationDate;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSDate</span> *modificationDate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> fileSize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readonly</span>) <span class="built_in">NSTimeInterval</span> age;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">readwrite</span>) <span class="type">BOOL</span> isArchived;</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">OSSDDLogFileInfo</span> () </span>&#123;</span><br><span class="line">    __<span class="keyword">strong</span> <span class="built_in">NSString</span> *_filePath;</span><br><span class="line">    __<span class="keyword">strong</span> <span class="built_in">NSString</span> *_fileName;</span><br><span class="line">    </span><br><span class="line">    __<span class="keyword">strong</span> <span class="built_in">NSDictionary</span> *_fileAttributes;</span><br><span class="line">    </span><br><span class="line">    __<span class="keyword">strong</span> <span class="built_in">NSDate</span> *_creationDate;</span><br><span class="line">    __<span class="keyword">strong</span> <span class="built_in">NSDate</span> *_modificationDate;</span><br><span class="line">    </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> _fileSize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">OSSDDLogFileInfo</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@synthesize</span> filePath;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@dynamic</span> fileName;</span><br><span class="line"><span class="keyword">@dynamic</span> fileAttributes;</span><br><span class="line"><span class="keyword">@dynamic</span> creationDate;</span><br><span class="line"><span class="keyword">@dynamic</span> modificationDate;</span><br><span class="line"><span class="keyword">@dynamic</span> fileSize;</span><br><span class="line"><span class="keyword">@dynamic</span> age;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@dynamic</span> isArchived;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSTimeInterval</span>)age &#123;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> creationDate] timeIntervalSinceNow] * <span class="number">-1.0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSDate</span> *)creationDate &#123;</span><br><span class="line">    <span class="keyword">if</span> (_creationDate == <span class="literal">nil</span>) &#123;</span><br><span class="line">        _creationDate = <span class="keyword">self</span>.fileAttributes[<span class="built_in">NSFileCreationDate</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _creationDate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)fileSize &#123;</span><br><span class="line">    <span class="keyword">if</span> (_fileSize == <span class="number">0</span>) &#123;</span><br><span class="line">        _fileSize = [<span class="keyword">self</span>.fileAttributes[<span class="built_in">NSFileSize</span>] unsignedLongLongValue];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _fileSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ageåªæ˜¯ä¸€ä¸ªè®¡ç®—å‹å±æ€§ï¼Œä¸éœ€è¦å®ä¾‹å˜é‡ï¼Œæ‰€ä»¥ä½¿ç”¨dynamicè¿›è¡Œæ ‡è®°ã€‚</p>
<p>å†æ¯”å¦‚åœ¨CoreDataé‡Œçš„NSManagedObjectç±»é‡Œé¢ä½¿ç”¨ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MyClass</span> : <span class="title">NSManagedObject</span></span>&#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">retain</span>) <span class="built_in">NSString</span> *value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MyClass</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@dynamic</span> value; <span class="comment">//@dynamic å±æ€§å;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>å¦ä¸€ç§ç”¨æ³•ï¼šå­ç±»å£°æ˜çˆ¶ç±»çš„åŒåå±æ€§ï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨dynamicæŒ‡ç¤ºç¼–è¯‘å™¨ä½¿ç”¨çˆ¶ç±»çš„çš„å­˜å–å™¨å’Œå®ä¾‹å˜é‡ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">FDAnimalDelegate</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)run;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">FDAnimal</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> magCount;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="type">id</span>&lt;FDAnimalDelegate&gt; delegate;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)startRun;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">FDDogDelegate</span> &lt;<span class="title">FDAnimalDelegate</span>&gt;</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)fastRun;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">FDDog</span> : <span class="title">FDAnimal</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSInteger</span> magCount;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="type">id</span>&lt;FDDogDelegate&gt; delegate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">FDDog</span></span></span><br><span class="line"><span class="keyword">@dynamic</span> delegate; <span class="comment">//æŒ‡ç¤ºä½¿ç”¨çˆ¶ç±»çš„å­˜å–å™¨æ–¹æ³•ï¼Œå®ä¾‹å˜é‡ä¹Ÿä½¿ç”¨çˆ¶ç±»é‡Œçš„ã€‚</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢å¯ä»¥çœ‹å¾—å‡ºæ¥è¿™ä¸¤ä¸ªæŒ‡ä»¤åŠŸèƒ½æ­£å¥½ç›¸å.</p>
<p>æ³¨æ„:ä¸èƒ½å¯¹ä¸€ä¸ªå±æ€§åŒæ—¶ä½¿ç”¨@synthesizeå’Œ@dynamic.</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="variable">@dynamic</span> age;</span><br><span class="line"></span><br><span class="line"><span class="variable">@synthesize</span> age = _age; <span class="regexp">//</span>æŠ¥é”™<span class="symbol">:Property</span> <span class="string">&#x27;age&#x27;</span> is already implemented</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢å·²ç»è¯´åˆ°@synthesizeå’Œ@dynamicçš„ä½œç”¨å°±æ˜¯å®ç°æŸä¸ªå±æ€§.åŒæ—¶ä½¿ç”¨çš„è¯å°±é‡å¤å®ç°äº†,å½“ç„¶ä¼šæŠ¥é”™.</p>
]]></content>
      <categories>
        <category>OC</category>
      </categories>
      <tags>
        <tag>property</tag>
      </tags>
  </entry>
  <entry>
    <title>tags</title>
    <url>/tags/index.html</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>categories</title>
    <url>/categories/index.html</url>
    <content><![CDATA[]]></content>
  </entry>
</search>
